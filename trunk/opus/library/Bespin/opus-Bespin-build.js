opus.depends({
	paths: {
		"opus-Bespin": "/Ares/foss/opus/opus/library/Bespin/",
		"assets": "$opus-Bespin/assets",
		"bespin": "$assets/bespin"
	}
});
(function(){var b=false;var c=/xyz/.test(function(){xyz})?/\b_super\b/:{test:function(){return true}};this.Class=function(){this.type="Class"};Class.define=function(q){if(!q.superclass){q.superclass=Class}var p=q.superclass.prototype,r=q.members||{};b=true;var j=new q.superclass();b=false;if(q.uses){var n=Trait.define({uses:q.uses,_klass_prototype:j,_klass_properties:r});for(var m in n._exports){if(!n._exports.hasOwnProperty(m)){continue}if(r.hasOwnProperty(m)){if(typeof r[m]!="function"){throw new Trait.TraitError(m+" overrides trait method and must be a function.")}}else{r[m]=n._exports[m]}}}for(var i in r){if(!r.hasOwnProperty(i)){continue}j[i]=typeof r[i]=="function"&&typeof p[i]=="function"&&c.test(r[i])?(function(o,s){return function(){var u=this._super;this._super=p[o];var t=s.apply(this,arguments);this._super=u;return t}})(i,r[i]):r[i]}var h=function(){if(!b&&this.init){this.init.apply(this,arguments)}};h.prototype=j;h.constructor=h;h.superclass=q.superclass;h.prototype.type=q.type;h.does=function(t){if(!n){if(h.superclass.does){return h.superclass.does(t)}if(t){return false}return[]}var s=n.does(t);if(h.superclass.does){if(t){return s||h.superclass.does(t)}var u=h.superclass.does(t).concat([]);for(var o=s.length-1;o>=0;o--){if(u.indexOf(s[o])===-1){u.push(s[o])}}return u}return s};if(!h.prototype.hasOwnProperty("does")){h.prototype.does=h.does}return h};function a(h){return Object.prototype.toString.apply(h)==="[object Array]"}function f(h){if(h){return a(h)?h:[h]}return[]}function d(h){if(!h){return{}}var j={};if(!a(h)){j[h]=true;return j}for(var m=h.length-1;m>=0;m--){j[h[m]]=true}return j}function g(m,j){for(var h in j){if(!j.hasOwnProperty(h)){continue}m[h]=j[h]}return m}this.Trait=Class.define({members:{init:function(p){this._subtraits=f(p.uses);this._requires=d(p.requires);this._exports=p.methods?p.methods:{};var m;for(m in this._requires){if(!this._requires.hasOwnProperty(m)){continue}if(this._exports.hasOwnProperty(m)){throw new Trait.TraitError("Trait cannot require and provide the same method "+m)}}var n,h,j,q={};for(j=this._subtraits.length-1;j>=0;j--){n=this._subtraits[j];h=g({},n._exports);if(n._aliases){g(h,n._aliases)}if(n._excludes){for(m in n._excludes){if(!n._excludes.hasOwnProperty(m)){continue}delete h[m];g(q,n._excludes)}}for(m in h){if(!h.hasOwnProperty(m)){continue}if(p._klass_prototype&&p._klass_properties.hasOwnProperty(m)&&typeof p._klass_properties[m]=="function"){continue}if(this._exports.hasOwnProperty(m)){if((!p.methods||!p.methods.hasOwnProperty(m))&&this._exports[m]!=h[m]){throw new Trait.TraitError("Multiple subtraits provide method "+m+" creating a conflict. Exclude all but one of the methods or override the method in the trait/class to resolve.")}continue}this._exports[m]=h[m]}for(m in n._requires){if(!n._requires.hasOwnProperty(m)){continue}if(!this._exports.hasOwnProperty(m)){this._requires[m]=true}}delete n._aliases;delete n._excludes}for(m in q){if(!q.hasOwnProperty(m)){continue}if(!this._exports.hasOwnProperty(m)&&(!p._klass_prototype||(typeof p._klass_prototype[m]!="function"&&typeof p._klass_properties[m]!="function"))){throw new Trait.TraitError("Excluded method "+m+" must be provided by another class or trait.")}}for(m in this._requires){if(!this._requires.hasOwnProperty(m)){continue}if(this._exports.hasOwnProperty(m)){delete this._requires[m]}else{if(p._klass_prototype&&(typeof p._klass_prototype[m]!="function"&&typeof p._klass_properties[m]!="function")){throw new Trait.TraitError("Trait requirement "+m+" not fullfilled by class.")}}}},aliases:function(i){this._aliases=this._aliases||{};for(var h in i){if(!i.hasOwnProperty(h)){continue}if(!this._exports.hasOwnProperty(i[h])){throw new Trait.TraitError("can't alias "+h+" to "+i[h]+" because trait doesn't have that method")}if(this._exports.hasOwnProperty(h)){throw new Trait.TraitError("can't create an alias with name "+h+" because trait natively exports that method")}if(this._requires.hasOwnProperty(h)){throw new Trait.TraitError("can't create an alias with name "+h+" because trait requires method with same name")}this._aliases[h]=this._exports[i[h]]}return this},excludes:function(h){this._excludes=this._excludes||{};h=f(h);for(var j=h.length-1;j>=0;j--){if(!this._exports.hasOwnProperty(h[j])){throw new Trait.TraitError("can't exclude method "+h[j]+" because no such method exists in trait")}this._excludes[h[j]]=true}return this},does:function(o){if(!this._does){this._does=[this].concat(this._subtraits);var n,m,h;for(n=this._subtraits.length-1;n>=0;n--){h=this._subtraits[n].does();for(m=h.length-1;m>=0;m--){if(this._does.indexOf(h[m])===-1){this._does.push(h[m])}}}}if(o){return this._does.indexOf(o)>=0}return this._does},requires:function(h){if(h){return this._requires.hasOwnProperty(h)&&this._requires[h]}return this._requires},subtraits:function(h){if(h){return this._subtraits.indexOf(h)>=0}return this._subtraits},methods:function(h){if(h){return this._exports.hasOwnProperty(h)&&this._exports[h]}return this._exports}}});Trait.define=function(h){return new Trait(h)};Trait.TraitError=Class.define({superclass:Error,members:{init:function(h){this.name="TraitError";this.message=h}}})})();if(!("console"in window)){window.console={log:function(a){}}}if(location.href.indexOf("file:")==0){try{if(netscape.security.PrivilegeManager.enablePrivilege){netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead")}}catch(ex){console.log("Couldn't elevate priviledges to deal with file URLs")}}if(typeof th=="undefined"){th={}}th.browser={IE:!!(window.attachEvent&&!window.opera),Opera:!!window.opera,WebKit:navigator.userAgent.indexOf("AppleWebKit/")>-1,Gecko:navigator.userAgent.indexOf("Gecko")>-1&&navigator.userAgent.indexOf("KHTML")==-1,MobileSafari:!!navigator.userAgent.match(/Apple.*Mobile.*Safari/)};th.isMac=function(){return navigator.appVersion.indexOf("Macintosh")>=0};th.fixCanvas=function(a){if(!a.fillText&&a.mozDrawText){a.fillText=function(d,b,f,c){a.translate(b,f);a.mozTextStyle=a.font;a.mozDrawText(d);a.translate(-b,-f)}}if(!a.measureText&&a.mozMeasureText){a.measureText=function(c){if(a.font){a.mozTextStyle=a.font}var b=a.mozMeasureText(c);return{width:b}}}if(a.measureText&&!a.html5MeasureText){a.html5MeasureText=a.measureText;a.measureText=function(c){var b=a.html5MeasureText(c);b.ascent=a.html5MeasureText("m").width;return b}}if(!a.fillText){a.fillText=function(){}}if(!a.measureText){a.measureText=function(){return 10}}return a};th.byId=function(a){return document.getElementById(a)};th.isString=function(a){return!!arguments.length&&a!=null&&(typeof a=="string"||a instanceof String)};th.isArray=function(a){return a&&(a instanceof Array||typeof a=="array")};th.forEach=function(b,g,d){if(!b||!b.length){return}var a=th._getParts(b,d,g);b=a[0];for(var f=0,c=b.length;f<c;++f){a[2].call(a[1],b[f],f,b)}};th._getParts=function(b,c,a){return[th.isString(b)?b.split(""):b,c||this,th.isString(a)?new Function("item","index","array",a):a]};th.xhrGet=function(a){var b=new XMLHttpRequest();b.onreadystatechange=function(){if(b.readyState==4){a.load.apply(a.context,[b.responseText])}};b.open("GET",a.url);b.send(null)};th.remove=function(d,b){var c=[];for(var a=0;a<d.length;a++){if(d[a]!=b){c.push(d[a])}}return c};th.observe=function(f,a,d,b){var g=(b)?function(h){d.apply(b,[h])}:d;var c=f["on"+a];if(typeof c=="function"){f["on"+a]=function(h){if(c){c(h)}g(h)}}else{f["on"+a]=g}};th.trim=String.prototype.trim?function(a){if(a==undefined){return a}return a.trim()}:function(a){if(a==undefined){return a}return a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")};th.mixin=function(d,c){if(!d){d={}}for(var b=1,a=arguments.length;b<a;b++){th._mixin(d,arguments[b])}return d};th._mixin_tobj={};th._mixin=function(d,b){for(var a in b){if(th._mixin_tobj[a]===undefined||th._mixin_tobj[a]!=b[a]){d[a]=b[a]}}if(th.browser.IE&&b){var c=b.toString;if(typeof c=="function"&&c!=d.toString&&c!=th._mixin_tobj.toString&&c!="\nfunction toString() {\n    [native code]\n}\n"){d.toString=b.toString}}return d};th.cumulativeOffset=function(b){var a=0,c=0;do{a+=b.offsetTop||0;c+=b.offsetLeft||0;b=b.offsetParent}while(b);return th._returnOffset(c,a)};th._returnOffset=function(b,c){var a=[b,c];a.left=b;a.top=c;return a};th.isPercentage=function(a){return(a.indexOf&&a.indexOf("%")!=-1)};th.isCssPixel=function(a){a=th.trim(a).toLowerCase();return(a.indexOf("px")==a.length-2)};th.isCssLength=function(a){if(a===undefined){return false}if(a==0){return true}return/^[\d\.]+(em|ex|px|\%|in|cm|mm|pt|pc)$/.test(a)};th.isCssBorderStyle=function(a){return/^(none|hidden|dotted|dashed|solid|double|groove|ridge|inset|outset)$/.test(a)};th.getSpaceDelimitedItems=function(a){return th.parenAwareSplit(" ",a)};th.getCommaDelimitedItems=function(a){return th.parenAwareSplit(",",a)};th.lastArrayItem=function(a){return a[a.length-1]};th.removeArrayItem=function(a,b){return a.splice(a.indexOf(b),1)};th.stopEvent=function(a){a.preventDefault();a.stopPropagation()};th.getSceneById=function(b){for(var a=0;a<th.global_scene_array.length;a++){if(th.global_scene_array[a].id==b){return th.global_scene_array[a]}}};th.parenAwareSplit=function(h,c){if(h.length!=1){throw"Invalid delimiter passed to parenAwareSplit: '"+h+"'"}var f=[];var b=0;var g;var d="";for(var a=0;a<c.length;a++){g=c[a];if(g==h){if(!b){f.push(th.trim(d));d="";continue}}else{if(g=="("){b++}else{if(g==")"){b--}}}d+=g}f.push(th.trim(d));return f};th.whitespace=" \t\n\r";th.isWhitespace=function(b){if(!b||b.length==0){return true}for(var a=0;a<b.length;a++){var d=b.charAt(a);if(th.whitespace.indexOf(d)==-1){return false}}return true};th.leadingWhitespace=function(c){var b=[];for(var a=0;a<c.length;a++){if(c[a]==" "||c[a]=="\t"||c[a]==""||c[a]===undefined){b.push(c[a])}else{return b}}return b};th.measureUsingDOM=function(d,c){if(!document){throw"Can't perform measurements outside of browser"}var a=document.getElementsByTagName("body")[0];var b=document.createElement("div");b.setAttribute("style","position: absolute; visibility:hidden");a.appendChild(b);if(c){d.apply(c,[b])}else{d(b)}a.removeChild(b)};th.measure_cache={};th.safeget=function(b,a){return(b==undefined)?a:b};th.unitRegex=/^([\d\.]+)(em|ex|px|\%|in|cm|mm|pt|pc)$/;th.absoluteUnitRegex=/^([\d\.]+)(px|in|cm|mm|pt|pc)$/;th.isBorderLength=function(a){return(a=="thin"||a=="medium"||a=="thick")};th.convertLengthToPixels=function(b,a){if(b==0){return 0}if(th.isBorderLength(b)){return th.convertBorderLengthToPixels(b)}else{if(th.absoluteUnitRegex.test(b)){return th.convertAbsoluteUnitToPixels(b)}}};th.convertBorderLengthToPixels=function(b){if(b===undefined){return 0}var c=b;if(th.measure_cache[c]!==undefined){return th.measure_cache[c]}var a=undefined;th.measureUsingDOM(function(d){d.setAttribute("style","position: relative; border-left: "+b+" solid black");d.innerHTML="some text";a=d.scrollWidth-d.clientWidth});th.measure_cache[c]=a;return a};th.convertAbsoluteUnitToPixels=function(a,d){var c;if(d===undefined){var b=th.absoluteUnitRegex.exec(a);if(b.length!=3){throw"Passed length "+a+" isn't a CSS absolute unit"}c=b[2];d=Number(b[1])}else{c=a}if(c=="px"){return d}else{if(c=="in"||c=="cm"||c=="mm"||c=="pt"||c=="pc"){return th.measureAbsoluteUnit(d+c)}else{throw"Unsupported unit: "+c}}};th.measureAbsoluteUnit=function(b){if(b===undefined){return 0}var c=b;if(th.measure_cache[c]){return th.measure_cache[c]}var a=undefined;th.measureUsingDOM(function(f){var d=f.getAttribute("style");f.setAttribute("style",d+="; width: "+b);a=f.scrollWidth});th.measure_cache[c]=a;return a};th.convertEmToPixels=function(d,b){var c=d+b;if(th.measure_cache[c]){return th.measure_cache[c]}var a=undefined;th.measureUsingDOM(function(g){var f=g.getAttribute("style");g.setAttribute("style",f+="; font: "+d+"; width: "+b+"em");a=g.scrollWidth});th.measure_cache[c]=a;return a};th.getHierarchyString=function(b){var a="";while(b){var c=b.type;if(b.id){c+="#"+b.id}if(b.className){c+="."+b.className}a=c+=" "+a;b=b.parent}return th.trim(a)};th.isObject=function(a){return a!==undefined&&(a===null||typeof a=="object"||th.isArray(a)||th.isFunction(a))};th.isFunction=(function(){var a=function(b){return b&&(typeof b=="function"||b instanceof Function)};return a})();th.hitch=function(b,a){return function(){if(arguments.length==0){a.apply(b)}else{a.apply(b,arguments)}}};th.delay=function(b,a,c){if(c){b=th.hitch(c,b)}return setTimeout(b,a)};th.clone=function(f){var a;var g;if(typeof f=="number"||typeof f=="string"){return f}if(f instanceof Object){a={};for(var d in f){g=this.clone(f[d]);if(g!==undefined){a[d]=g}}return a}if(f instanceof Array){a=[];for(var b;b<f.length;b){g=this.clone(f[b]);if(g!==undefined){a[b]=g}}return a}};if(typeof th=="undefined"){th={}}th.CssParser=Class.define({members:{parse:function(b,a){if(!a){a={}}b=b.replace(/\s+/gi," ");th.forEach(this.munge(b,false).split("`b%"),function(c){c=c.split("%b`");if(c.length<2){return}c[0]=this.restore(c[0]);var d=a[c[0]]||{};a[c[0]]=th.mixin(d,this.parsedeclarations(c[1]))},this);return a},REbraces:/{[^{}]*}/,REfull:/\[[^\[\]]*\]|{[^{}]*}|\([^()]*\)|function(\s+\w+)?(\s*%b`\d+`b%){2}/,REatcomment:/\/\*@((?:[^\*]|\*[^\/])*)\*\//g,REcomment_string:/(?:\/\*(?:[^\*]|\*[^\/])*\*\/)|(\\.|"(?:[^\\\"]|\\.|\\\n)*"|'(?:[^\\\']|\\.|\\\n)*')/g,REmunged:/%\w`(\d+)`\w%/,uid:0,munged:{},munge:function(d,b){var a=this;d=d.replace(this.REatcomment,"$1").replace(this.REcomment_string,function(h,f){if(!f){return""}var g="%s`"+(++a.uid)+"`s%";a.munged[a.uid]=f.replace(/^\\/,"");return g});var c=b?this.REfull:this.REbraces;while(match=c.exec(d)){replacement="%b`"+(++this.uid)+"`b%";this.munged[this.uid]=match[0];d=d.replace(c,replacement)}return d},restore:function(a){if(a===undefined){return a}while(match=this.REmunged.exec(a)){a=a.replace(this.REmunged,this.munged[match[1]])}return th.trim(a)},parsedeclarations:function(b){var c=this.munged[b].replace(/(?:^\s*[{'"]\s*)|(?:\s*([^\\])[}'"]\s*$)/g,"$1");c=this.munge(c);var a={};th.forEach(c.split(";"),function(d){d=d.split(":");if(d.length<2){return}a[this.restore(d[0])]=this.restore(d[1])},this);return a}}});th.CssExpander=Class.define({members:{init:function(){this.expandRules={border:this.expandBorder,"border-top":this.expandBorderSide,"border-left":this.expandBorderSide,"border-right":this.expandBorderSide,"border-bottom":this.expandBorderSide,"border-width":this.expandBorderWidth,"border-image":this.expandBorderImage,margin:this.expandMarginOrPadding,padding:this.expandMarginOrPadding,overflow:this.expandOverflow}},expand:function(c,b,a){if(!a){a={}}if(this.expandRules[c]){this.expandRules[c].apply(this,[c,b,a])}else{a[c]=b}return a},saveProperty:function(c,b,a){if(th.getSpaceDelimitedItems(b).length!=1&&c!="font"&&c!="-th-grid-cols"&&c!="-th-grid-rows"){console.error("th.CssExpander: Can't expand '"+c+"' with value '"+b+"'!")}a[c]=b},expandBorderWidth:function(c,b,a){this.expandSideNumbers("border-","-width",b,a)},expandOverflow:function(c,b,a){this.saveProperty("overflow-x",b,a);this.saveProperty("overflow-y",b,a)},expandMarginOrPadding:function(c,b,a){this.expandSideNumbers(c+"-","",b,a)},expandSideNumbers:function(f,b,d,c){var a=d.split(" ");if(a.length==3){a=[a[0],a[1],a[2],a[1]]}if(a.length==2){a=[a[0],a[1],a[0],a[1]]}if(a.length==1){a=[a[0],a[0],a[0],a[0]]}if(a.length>=4){this.saveProperty(f+"top"+b,a[0],c);this.saveProperty(f+"right"+b,a[1],c);this.saveProperty(f+"bottom"+b,a[2],c);this.saveProperty(f+"left"+b,a[3],c)}},expandBorder:function(c,b,a){this.expandBorderSide("border-top",b,a);this.expandBorderSide("border-right",b,a);this.expandBorderSide("border-bottom",b,a);this.expandBorderSide("border-left",b,a)},expandBorderSide:function(f,d,c){var a=th.getSpaceDelimitedItems(d);for(var b=0;b<a.length;b++){if(th.isCssLength(a[b])){this.saveProperty(f+"-width",a[b],c)}else{if(th.isCssBorderStyle(a[b])){this.saveProperty(f+"-style",a[b],c)}else{this.saveProperty(f+"-color",a[b],c)}}}},expandBorderImage:function(g,f,d){var b=th.getSpaceDelimitedItems(f);var a=["url","top","right","bottom","left","repeat-x","repeat-y"];for(var c=0;c<a.length;c++){this.saveProperty("border-image-"+a[c],b[c],d)}}}});th._cssExpander=new th.CssExpander();th.expandCssProperty=function(c,b,a){return th._cssExpander.expand(c,b,a)};if(typeof th=="undefined"){th={}}th.EventHelpers=new Trait({methods:{wrapEvent:function(d,b){var a=d.pageX-th.cumulativeOffset(this.canvas).left;var f=d.pageY-th.cumulativeOffset(this.canvas).top;var c=b.getComponentForPosition(a,f,true);d.thComponent=c;this.addComponentXY(d,b,c)},addComponentXY:function(g,d,b){if(!b.bounds){console.log("No dest bounds - "+b.type);console.log(b.bounds);console.log(b);return}var a=g.pageX-th.cumulativeOffset(this.canvas).left;var i=g.pageY-th.cumulativeOffset(this.canvas).top;var f={x:a,y:i};var h=b;while(h){f.x-=h.bounds.x;f.y-=h.bounds.y;h=h.parent;if(h==d){g.componentX=f.x;g.componentY=f.y;return}}}}});th.StringHelpers=new Trait({methods:{isPercentage:function(a){return a.indexOf&&a.indexOf("%")!=-1}}});th.ComponentHelpers=new Trait({methods:{d:function(){var a=this.getInsets();return{b:(this.bounds)?{x:this.bounds.x,y:this.bounds.y,w:this.bounds.width,h:this.bounds.height,iw:this.bounds.width-a.left-a.right,ih:this.bounds.height-a.top-a.bottom}:{},i:{l:a.left,r:a.right,t:a.top,b:a.bottom,w:a.left+a.right,h:a.top+a.bottom}}},isVertical:function(){return(this.orientation==th.VERTICAL)},isHorizontal:function(){return(this.orientation==th.HORIZONTAL)},shouldPaint:function(){return(this.shouldLayout()&&this.cssValue("visibility")!="hidden")},shouldLayout:function(){return(this.cssValue("display")!="none")},emptyInsets:function(){return{left:0,right:0,bottom:0,top:0}},resolveCss:function(){var b=th.global_resources;var m;var f=th.getHierarchyString(this);if(b.resolvedCssCache[f]){m=b.resolvedCssCache[f]}else{m={};var d;var j=["userAgentCss","userCss","authorCss"];for(var c=0;c<j.length;c++){var h=j[c];th.forEach(b[h],function(t){for(var p in t){var y=p.split(",");for(var z=0;z<y.length;z++){var q=th.trim(y[z]);var o=this.getSpecificity(q);var w=q.split(":");var x=w[0];w=(w.length>1)?w.slice(1):["(default)"];if(this.matchesSelector(x)){var v=t[p];for(d in v){for(var r=0;r<w.length;r++){var u=w[r];if(m[u]===undefined){m[u]={}}var n={value:v[d],selector:q,specificity:o};if(m[u][d]){n=this.getSpecificityWinner(n,m[u][d])}m[u][d]=n}}}}}},this)}b.resolvedCssCache[f]=m;this.blowCssCaches()}this.styles={};for(var g in m){for(var a in m[g]){if(this.styles[g]===undefined){this.styles[g]={}}this.styles[g][a]=m[g][a].value}}this.refreshCss=false},matchesSelector:function(a){var f=a.toLowerCase();if(f=="*"){return true}if(f.indexOf(">")!=-1){var c=f.split(">");if(c.length!=2){console.log("unsupported child selector syntax; must be SEL1 > SEL2, was '"+a+"'");return false}if(this.matchesSelector(th.trim(c[1]))){if(!this.parent){return false}return(this.parent.matchesSelector(th.trim(c[0])))}return false}if(f.indexOf(" ")!=-1){var c=f.split(" ");if(c.length!=2){console.log("unsupported ancestor selector syntax; must be SEL1 SEL2, was '"+a+"'");return false}if(this.matchesSelector(th.trim(c[1]))){var b=this.parent;while(b){if(b.matchesSelector(th.trim(c[0]))){return true}b=b.parent}return false}}if(f.indexOf(".")==0){if(!this.className){return false}if(this.className.toLowerCase()==f.substring(1)){return true}}if(f.indexOf("#")==0){if(!this.id){return false}return("#"+this.id).toLowerCase()==f}var d=this.type.toLowerCase();if(d==f){return true}if(this.id&&(f==(d+"#"+this.id))){return true}if(this.className&&(f==(d+"."+this.className.toLowerCase()))){return true}return false},getSpecificity:function(a,f){var c={a:0,b:0,c:0,d:0};if(f){c.a=1}var d=th.getSpaceDelimitedItems(a);for(var b=0;b<d.length;b++){var h=d[b];if(h=="*"||h=="+"||h==">"){continue}if(h.indexOf("#")==0){c.b+=1;continue}c.c+=h.split(".").length-1;var g=h.split(":");if(g.length==2){if(g[1]=="first-line"||g[1]=="first-letter"||g[1]=="before"||g[1]=="after"){c.d+=1}else{c.c+=1}}}return c},getSpecificityWinner:function(d,c){var b=d.specificity;var a=c.specificity;if(b.a>a.a){return d}if(a.a>b.a){return c}if(b.b>a.b){return d}if(a.b>b.b){return c}if(b.c>a.c){return d}if(a.c>b.c){return c}if(b.d>a.d){return d}if(a.d>b.d){return c}return d},paintBackground:function(p,g,c,m,t){var u=this.d();if(g===undefined){g=th.convertBorderLengthToPixels(this.cssValue("border-left-width")||"0px")}if(c===undefined){c=th.convertBorderLengthToPixels(this.cssValue("border-top-width")||"0px")}if(m===undefined){m=u.b.w-g-th.convertBorderLengthToPixels(this.cssValue("border-right-width")||"0px")}if(t===undefined){t=u.b.h-c-th.convertBorderLengthToPixels(this.cssValue("border-bottom-width")||"0px")}if(this.cssValue("background-color")){p.fillStyle=this.cssValue("background-color");p.fillRect(g,c,m,t)}if(this.cssValue("background-image")){var A=this.cssValue("background-image");var f=this.cssValue("background-repeat");var z=this.cssValue("background-position");var n=th.getCommaDelimitedItems(A);var a=(f)?f.split(","):[undefined];var b=(z)?z.split(","):[undefined];var s=Math.max(n.length,a.length,b.length);for(var r=0;r<s;r++){var j=r;if(r>=n.length){j=(n.length%r)-1}var q=this.processImage(th.trim(n[j]),m,t);if(q){var o=r;if(r>=a.length){o=(a.length%r)-1}var v=r;if(r>=b.length){v=(b.length%r)-1}this.paintImage(p,q,th.trim(a[o]),th.trim(b[v]),g,c,m,t)}}}},getFirstBackgroundImage:function(){var a=this.cssValue("background-image");if(a){var b=th.getCommaDelimitedItems(a);if(b[0]){a=th.global_resources.images[b[0]];if(a){return a}}}},processImage:function(D,r,y){if(D.indexOf("-webkit-gradient")==0){var z=D.substring(D.indexOf("(")+1,D.length-1);var n=th.getCommaDelimitedItems(z);for(var x=0;x<n.length;x++){n[x]=th.trim(n[x])}if(n[0]!="linear"){console.log('Unsupported gradient: "'+D+'"; only linear gradients supported');return undefined}var m=n[1].split(" ");var j=n[2].split(" ");var u=[];var s=[];u[0]=(m[0]=="top"||m[0]=="bottom")?m[1]:m[0];u[1]=(m[0]=="top"||m[0]=="bottom")?m[0]:m[1];s[0]=(j[0]=="top"||j[0]=="bottom")?j[1]:j[0];s[1]=(j[0]=="top"||j[0]=="bottom")?j[0]:j[1];var q=[u,s];for(var C=0;C<q.length;C++){var d=q[C];for(var B=0;B<d.length;B++){if(d[B]=="top"){d[B]="0%"}if(d[B]=="bottom"){d[B]="100%"}if(d[B]=="left"){d[B]="0%"}if(d[B]=="right"){d[B]="100%"}if(th.isPercentage(d[B])){var p=parseInt(d[B])/100;d[B]=p*((B==0)?r:y)}}}var g=document.createElement("canvas");g.setAttribute("width",r);g.setAttribute("height",y);var v=g.getContext("2d");var f=v.createLinearGradient(u[0],u[1],s[0],s[1]);for(var A=3;A<n.length;A++){var t=n[A].split("(");if(t[1].indexOf(",")!=-1){var o=t[1].split(",");o[1]=th.trim(o[1].substring(0,o[1].length-1));f.addColorStop(o[0],o[1])}else{t[1]=t[1].substring(0,t[1].length-1);f.addColorStop((t[0].toLowerCase()=="from"?0:1),t[1])}}v.fillStyle=f;v.fillRect(0,0,r,y);return g}else{if(!th.global_resources.images[D]){console.log("Warning: image identified by '"+D+"'")}else{return th.global_resources.images[D]}}},paintImage:function(t,C,f,B,g,d,m,z){if(!f){f="repeat"}if(!B){B="0% 0%"}if(!g){g=0}if(!d){d=0}if(!m){m=this.bounds.width}if(!z){z=this.bounds.height}t.save();try{if((g!=0)||(d!=0)){t.translate(g,d)}t.beginPath();t.rect(0,0,m,z);t.clip();var c=B.toLowerCase().split(" ");if(c.length==1){c.push("50%")}if(c.length!=2){console.log('Unsupported position syntax; only "X" or "X Y" supported, you passed in " + position + "');return}var b=[];b[0]=(c[0]=="top"||c[0]=="bottom")?c[1]:c[0];b[1]=(c[0]=="top"||c[0]=="bottom")?c[0]:c[1];th.forEach(b,function(i,h){if(i=="top"){b[h]="0%"}if(i=="right"){b[h]="100%"}if(i=="bottom"){b[h]="100%"}if(i=="left"){b[h]="0%"}if(i=="center"){b[h]="50%"}});var j=[0,0];for(var v=0;v<b.length;v++){var n=th.isPercentage(b[v]);var s=this.convertPositionToPixel(b[v],(v==0)?m:z);if(n){j[v]=this.convertPositionToPixel(b[v],(v==0)?C.width:C.height)}b[v]=s}var r=b[0]-j[0];var q=b[1]-j[1];if(!this.shouldRepeat(f)){t.drawImage(C,b[0]-j[0],b[1]-j[1])}else{var a=(this.shouldRepeatX(f))?parseInt(m/C.width)+1:1;var u=(this.shouldRepeatY(f))?parseInt(z/C.height)+1:1;if(this.shouldRepeatX(f)){while(r>0){r-=C.width}}if(this.shouldRepeatY(f)){while(q>0){q-=C.height}}var p=r;for(var o=0;o<u;o++){r=p;for(var A=0;A<a;A++){t.drawImage(C,r,q);r+=C.width}q+=C.height}}}finally{t.restore()}},shouldRepeatX:function(a){return(a=="repeat"||a=="repeat-x")},shouldRepeatY:function(a){return(a=="repeat"||a=="repeat-y")},shouldRepeat:function(a){return(a!="no-repeat")},convertPositionToPixel:function(c,b){if(th.isPercentage(c)){var a=c.substring(0,c.length-1)/100;return b*a}else{if(th.isCssPixel(c)){return c.substring(0,c.length-2)}}},calculateInsets:function(i,b,a){var d=(this.component)?this.component:this;var h=i+b;if(d.insetCache){}var c={top:0,bottom:0,left:0,right:0};if(a){c.top+=a.top;c.left+=a.left;c.right+=a.right;c.bottom+=a.bottom}for(var f in c){var g=th.safeget(d.cssValue(i+f+b),0);if(g){g=th.convertLengthToPixels(g,d)}c[f]+=g}if(!d.insetCache){d.insetCache={}}d.insetCache[h]=c;return c},getCurrentPseudoClass:function(){if(this.pseudoClass){return this.pseudoClass}return"(default)"},cssValue:function(c,b){if(b===undefined){b=this.getCurrentPseudoClass()}if(this.localStyles[b]===undefined){this.localStyles[b]={}}if(this.localStyles[b][c]!==undefined){return this.localStyles[b][c]}if(typeof this.styles=="undefined"||this.refreshCss){this.resolveCss()}if(this.styles[b]===undefined){this.styles[b]={}}var a=this.styles[b][c];if(a&&a!="inherit"){return this.styles[b][c]}if(a=="inherit"&&this.parent){return this.parent.cssValue(c)}if(b!="(default)"){return this.cssValue(c,"(default)")}if(c=="border-top-color"||c=="border-left-color"||c=="border-right-color"||c=="border-bottom-color"){return this.cssValue("color")}if(c=="border"||c=="border-top"||c=="border-left"||c=="border-right"||c=="border-bottom"){throw"Unsupported: request the individual border properties, please"}if(c=="margin"){throw"Unsupported: request the individual margin-top, margin-bottom, margin-right, and margin-left properties, please"}if(c=="padding"){throw"Unsupported: request the individual padding-top, padding-bottom, padding-right, and padding-left properties, please"}if(["color","letter-spacing","line-height","text-align","text-indent","text-transform","visibility","white-space","word-spacing","font"].indexOf(c)!=-1){if(this.parent){return this.parent.cssValue(c)}}if(c.indexOf("list-style-")!=-1){if(this.parent){return this.parent.cssValue(c)}}return},addCss:function(b,d,a){if(th.isString(b)){var f=b;this.blowCssCaches(f);if(a===undefined){a="(default)"}if(this.localStyles[a]===undefined){this.localStyles[a]={}}th.expandCssProperty(f,d,this.localStyles[a])}else{for(var c in b){this.addCss(c,b[c],a)}}},getSize:function(){var a=this.bounds;return{width:a.width,height:a.height}},setBounds:function(a,d,b,c){this.bounds={x:a,y:d,width:b,height:c}},getPreferredSize:function(){if(this.getPreferredHeight&&this.getPreferredWidth){var a=this.getPreferredHeight();var c=this.getPreferredWidth();return{height:a,width:c}}var b=this.getInsets();return{height:b.top+b.bottom,width:b.left+b.right}},getMinimumSize:function(){if(this.getMinimumHeight&&this.getMinimumWidth){var a=this.getMinimumHeight();var b=this.getMinimumWidth();return{height:a,width:b}}return this.getPreferredSize()},getMaximumSize:function(){if(this.getMaximumHeight&&this.getMaximumWidth){var a=this.getMaximumHeight();var b=this.getMaximumWidth();return{height:a,width:b}}return this.getPreferredSize()},getScene:function(){if(this.scene){return this.scene}if(!this.parent){return}var a=this.parent;while(!a.scene&&a.parent){a=a.parent}return a.scene},blowCssCaches:function(a){if(this.component){console.log("WARNING: BLOW CACHE has a component reference")}if(a===undefined){delete this.insetCache;return}if(a.indexOf("border")!=-1||a.indexOf("margin")!=-1||a.indexOf("padding")!=-1){delete this.insetCache}},isInsideOf:function(a){var b=this.parent;while(b){if(b===a){return true}b=b.parent}return false}}});th.ContainerHelpers=new Trait({methods:{getComponentForPosition:function(a,d,c){for(var b=0;b<this.children.length;b++){if(!this.children[b].bounds){continue}if(this.children[b].bounds.x<=a&&this.children[b].bounds.y<=d&&(this.children[b].bounds.x+this.children[b].bounds.width)>=a&&(this.children[b].bounds.y+this.children[b].bounds.height)>=d){if(!c){return this.children[b]}if(!this.children[b].shouldPaint()){continue}return(this.children[b].getComponentForPosition)?this.children[b].getComponentForPosition(a-this.children[b].bounds.x,d-this.children[b].bounds.y,c):this.children[b]}}return this},removeAll:function(){this.remove(this.children)},getMinimumSize:function(){return(this.layoutManager)?this.layoutManager.getMinimumSize(this):this._super()},getPreferredSize:function(){return(this.layoutManager)?this.layoutManager.getPreferredSize(this):this._super()},getMaximumSize:function(){return(this.layoutManager)?this.layoutManager.getMaximumSize(this):this._super()}}});th.BorderHelpers=new Trait({methods:{inset:function(a,b){if(typeof b=="number"){a.x+=b;a.y+=b;a.w-=2*b;a.h-=2*b}else{if(th.isArray(b)&&b.length==4){a.x+=b[0];a.y+=b[1];a.w-=b[1]+b[3];a.h-=b[0]+b[2]}}},cornerX:function(a,b){switch(b){case 0:case 3:return a.x;case 1:case 2:return a.x+a.w}},cornerY:function(a,b){switch(b){case 0:case 1:return a.y;case 2:case 3:return a.y+a.h}},round:function(a){a.x=Math.round(a.x);a.y=Math.round(a.y);a.w=Math.round(a.w);a.h=Math.round(a.h)},emptyRect:function(a){return(a.w<=0)||(a.h<=0)},isZeroSize:function(a){return(a.w<=0)&&(a.h<=0)},next:function(b){var a=(b+1)%4;if(a<0){return a+4}return a},prev:function(b){var a=(b-1)%4;if(a<0){return a+4}return a},allCornersZeroSize:function(a){var b=this.isZeroSize;return b(a[0])&&b(a[1])&&b(a[2])&&b(a[3])},checkFourFloatsEqual:function(a,b){return(a[0]==b&&a[1]==b&&a[2]==b&&a[3]==b)},computeInnerRadii:function(n,j){var d=[];var i=n[this.TOP_LEFT];var f=n[this.TOP_RIGHT];var h=n[this.BOTTOM_RIGHT];var o=n[this.BOTTOM_LEFT];var m=j[0];var a=j[1];var g=j[2];var c=j[3];d[this.TOP_LEFT]={w:Math.max(0,i.w-c),h:Math.max(0,i.h-m)};d[this.TOP_RIGHT]={w:Math.max(0,f.w-a),h:Math.max(0,f.h-m)};d[this.BOTTOM_RIGHT]={w:Math.max(0,h.w-a),h:Math.max(0,h.h-g)};d[this.BOTTOM_LEFT]={w:Math.max(0,o.w-c),h:Math.max(0,o.h-g)};return d},traceRoundRect:function(a,c,d,b){if(b){a.moveTo(c.x,c.y+d[this.TOP_LEFT].h);a.quadraticCurveTo(c.x,c.y,c.x+d[this.TOP_LEFT].w,c.y);a.lineTo(c.x+c.w-d[this.TOP_RIGHT].w,c.y);a.quadraticCurveTo(c.x+c.w,c.y,c.x+c.w,c.y+d[this.TOP_RIGHT].h);a.lineTo(c.x+c.w,c.y+c.h-d[this.BOTTOM_RIGHT].h);a.quadraticCurveTo(c.x+c.w,c.y+c.h,c.x+c.w-d[this.BOTTOM_RIGHT].w,c.y+c.h);a.lineTo(c.x+d[this.BOTTOM_LEFT].w,c.y+c.h);a.quadraticCurveTo(c.x,c.y+c.h,c.x,c.y+c.h-d[this.BOTTOM_LEFT].h);a.lineTo(c.x,c.y+d[this.TOP_LEFT].h)}else{a.moveTo(c.x,c.y+d[this.TOP_LEFT].h);a.lineTo(c.x,c.y+c.h-d[this.BOTTOM_LEFT].h);a.quadraticCurveTo(c.x,c.y+c.h,c.x+d[this.BOTTOM_LEFT].w,c.y+c.h);a.lineTo(c.x+c.w-d[this.BOTTOM_RIGHT].w,c.y+c.h);a.quadraticCurveTo(c.x+c.w,c.y+c.h,c.x+c.w,c.y+c.h-d[this.BOTTOM_RIGHT].h);a.lineTo(c.x+c.w,c.y+d[this.TOP_RIGHT].h);a.quadraticCurveTo(c.x+c.w,c.y,c.x+c.w-d[this.TOP_RIGHT].w,c.y);a.lineTo(c.x+d[this.TOP_LEFT].w,c.y);a.quadraticCurveTo(c.x,c.y,c.x,c.y+d[this.TOP_LEFT].h)}}}});th.ColorHelpers=new Trait({methods:{colors:{aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},RGBtoHSL:function(n,m,c){var a=Math.max(n,m,c);var f=Math.min(n,m,c);var d=(a+f)/2;var j=0;var i=0;if(a!=f){if(d<0.5){i=(a-f)/(a+f)}else{i=(a-f)/(2-a-f)}if(n==a){j=(m-c)/(6*(a-f))}if(m==a){j=(2+(c-n)/(6*(a-f)))}if(c==a){j=(4+(n-m)/(6*(a-f)))}}if(j<0){j+=1}return[j,i,d]},getColorRGB:function(a){if(typeof a=="undefined"){return[0,0,0]}if(th.isArray(a)&&a.length==3){return[a[0],a[1],a[2]]}if(!th.isString(a)){throw"Error: th.Color.getColorRGB(): Function was passed a non string parameter"}if(a.charAt(0)=="#"){var d=parseInt(a.slice(1),16);return[d%256,(d>>8)%256,(d>>16)%256]}if(a.indexOf("rgb(")==0){var d=a.match(/\d+/g);for(var b=0;b<3;b++){d[b]=parseInt(d[b]);if(d[b]>255){d[b]=255}if(d[b]<0){d[b]=0}}return d}if(a.indexOf("rgb(a")==0){var d=a.match(/\d+/g);for(var b=0;b<3;b++){d[b]=parseInt(d[b]);if(d[b]>255){d[b]=255}if(d[b]<0){d[b]=0}}return d}if(typeof this.colors[a]=="undefined"){return[0,0,0]}return this.colors[a]},getSpecial3DColors:function(a,m,j){var h,d;var b,g;var n,c;b=this.getColorRGB(a);g=this.getColorRGB(m);n=(3691*b[0]+6283*b[1]+2026*b[2])/12000;c=(3691*g[0]+6283*g[1]+2026*g[2])/12000;if(c<51){h=30;d=50;if(n==0){b=[96,96,96]}}else{if(c>204){h=45;d=70;if(n==254){b=[192,192,192]}}else{h=30+(c/17);d=50+(c*20/255)}}if(j=="dark"){for(var f=0;f<3;f++){b[f]-=Math.floor(b[f]*h/100)}}else{if(j=="light"){for(var f=0;f<3;f++){b[f]+=Math.floor((255-b[f])*d/100)}}else{b=[0,0,0]}}return b},getColorString:function(a){return"rgb("+a[0]+","+a[1]+","+a[2]+")"}}});th.KeyHelpers=new Trait({methods:{BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,CAPS_LOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,ARROW_LEFT:37,ARROW_UP:38,ARROW_RIGHT:39,ARROW_DOWN:40,INSERT:45,DELETE:46,A:65,bindKey:function(a,g,f,c){if(c===undefined){c=this}var i=(a.toUpperCase().indexOf("CTRL")!=-1);var d=(a.toUpperCase().indexOf("ALT")!=-1);var h=(a.toUpperCase().indexOf("META")!=-1)||(a.toUpperCase().indexOf("APPLE")!=-1);var b=(a.toUpperCase().indexOf("SHIFT")!=-1);if(a.toUpperCase().indexOf("CMD")!=-1){if(th.isMac()){h=true}else{i=true}}this._keyHelpersMap[[g,h,i,d,b]]=th.hitch(c,f)},_keyHelpersOnKeyDown:function(b){this.isShiftDown=b.shiftKey;var a=this._keyHelpersMap[[b.keyCode,b.metaKey,b.ctrlKey,b.altKey,b.shiftKey]];if(th.isFunction(a)){a(b);th.stopEvent(b);return false}},_keyHelpersOnKeyUp:function(a){this.isShiftDown=false},setupKeyHelpers:function(){this._keyHelpersMap=[];this.bus.bind("keydown",this,this._keyHelpersOnKeyDown,this);this.bus.bind("keyup",this,this._keyHelpersOnKeyUp,this)},getPrintableChar:function(a){if(a.charCode>255){return false}if(a.charCode<32){return false}if((a.altKey||a.metaKey||a.ctrlKey)&&(a.charCode>96&&a.charCode<123)){return false}return String.fromCharCode(a.charCode)},}});if(typeof th=="undefined"){th={}}th.VERTICAL="vertical";th.HORIZONTAL="horizontal";th.Resources=Class.define({members:{init:function(){this.loading=false;this.userAgentCss=[];this.authorCss=[];this.userCss=[];this.resolvedCssCache={};this.blockUntilImagesLoaded=true;this.images={};this.sheetCount=0;this.currentSheet=0;this.imageCount=0;this.currentImage=0;this.loaded=false;this.cssLoaded=false;this.imagesLoaded=false;this.callbacks=[]},load:function(b,a){if(this.loaded){return}this.baseUrl=b;this.stringStyles=a;this.loading=true;this.parseCSS()},processImage:function(){this.currentImage++;if(this.imageCount==this.currentImage){this.imagesLoaded=true;this.onLoaded()}},loadImages:function(f,d){var g,j,b;for(var m in f){var h=f[m];if((g=h.indexOf("url("))!=-1){j=h.indexOf(")",g);if(j==-1){console.log("Warning: malformed url found ('"+h+"')");break}var i=h.substring(g,j);var c=i+")";var a=i.substring(4);if(a.charAt(0)=="'"||a.charAt(0)=='"'){a=a.substring(1,a.length-1)}if(this.images[c]!==undefined){continue}this.imageCount++;b=new Image();if(this.blockUntilImagesLoaded){this.imagesLoaded=false;var n=this;b.onload=function(){n.processImage()};b.onerror=function(){n.processImage()}}if(d==undefined){d=""}b.src=d+a;this.images[c]=b}}},onLoaded:function(){if(this.cssLoaded&&((this.blockUntilImagesLoaded&&this.imagesLoaded)||!this.blockUntilImagesLoaded)){this.loaded=true;this.loading=false;if(this.callbacks){th.forEach(this.callbacks,function(a){if(a.context){a.callback.apply(a.context)}else{a.callback()}})}}},registerOnLoadCallback:function(b,a){this.callbacks.push({callback:b,context:a})},parseCSS:function(){var c=[];var g=false;if(typeof this.baseUrl!=="undefined"){c.push({url:this.baseUrl+"css/default.css",resourceBase:this.baseUrl,array:this.userAgentCss,index:0})}else{if(th.DEFAULT_CSS){this.processCSS(th.DEFAULT_CSS,undefined,this.userAgentCss,0);g=true}}var f,b=document.getElementsByTagName("link");var a=0;for(var d=0;d<b.length;d++){f=b[d];if(f.rel.toLowerCase().indexOf("thstylesheet")>=0&&f.href){c.push({url:f.href,resourceBase:undefined,array:this.authorCss,index:a++})}}if(this.stringStyles){this.processCSS(this.stringStyles,this.authorCss,a++)}if(c.length==0){this.cssLoaded=true;return this.onLoaded()}this.sheetCount=c.length;if(g){this.sheetCount++}if(this.stringStyles){this.sheetCount++}th.forEach(c,function(h){th.xhrGet({url:h.url,load:function(i){this.processCSS(i,h.resourceBase,h.array,h.index)},context:this})},this)},processCSS:function(b,g,h,a){h[a]=new th.CssParser().parse(b);for(var f in h[a]){var d={};for(var c in h[a][f]){th.expandCssProperty(c,h[a][f][c],d)}h[a][f]=d;this.loadImages(d,g)}if(++this.currentSheet==this.sheetCount){this.cssLoaded=true;this.onLoaded()}}}});th.Timer=Class.define({members:{init:function(){this.timer={}},start:function(c,d,b,f){var a=new Date();if(this.timer[c]&&this.timer[c].end>a){clearTimeout(this.timer[c].obj)}this.timer[c]={obj:th.delay(d,b,f),end:(a+b)}},stop:function(a){if(!this.timer[a]){return}if(this.timer[a].end>new Date()){clearTimeout(this.timer[a].obj)}delete this.timer[a]}}});th.Bus=Class.define({members:{init:function(){this.events={}},bind:function(f,b,a,g){var d=this.events[f];if(!d){d=[];this.events[f]=d}b=th.isArray(b)?b:[b];for(var h=0;h<b.length;h++){for(var c=0;c<d.length;c++){if(d[c].selector==b[h]&&d[c].listenerFn==a){return}}d.push({selector:b[h],listenerFn:a,context:g})}},unbind:function(a){for(var d in this.events){var c=this.events[d];for(var b=0;b<c.length;b++){if(c[b].selector===a){this.events[d]=th.remove(c,c[b]);c=this.events[d];b--}}}},fire:function(a,f,b){var d=this.events[a];if(!d||d.length==0){return}for(var c=0;c<d.length;c++){if(d[c].selector.constructor==String){if(d[c].selector.charAt(0)=="#"){if(b.id==d[c].selector.substring(1)){this.dispatchEvent(a,f,b,d[c])}}else{if(d[c].selector==b.declaredClass){this.dispatchEvent(a,f,b,d[c])}}}else{if(d[c].selector==b){this.dispatchEvent(a,f,b,d[c])}}}},dispatchEvent:function(a,c,b,d){c.thComponent=b;if(d.context){d.listenerFn.apply(d.context,[c])}else{d.listenerFn(c)}}}});th.FocusManager=Class.define({members:{bus:null,KEY_TAB:9,C:67,V:86,X:88,init:function(a,d,f){this.bus=a;this.subscribers=[];this.focused=undefined;this.focusedIndex=-1;this.domInputFirst=d;this.domInputLast=f;this.domHasFocus=undefined;this.ignoreDomEvent=false;this.domInputFirst.value="<norealtext>";this.domInputLast.value="<norealtext>";var b=[this.domInputFirst,this.domInputLast];for(var c=0;c<2;c++){th.observe(b[c],"focus",!c?this.enterFirst:this.enterLast,this);th.observe(b[c],"blur",this.domFocusLost,this);th.observe(b[c],"keydown",this.handleKeyDown,this);th.observe(b[c],"keypress",this.handleKeyPress,this);th.observe(b[c],"keyup",this.handleKeyUp,this)}if(th.browser.WebKit){th.observe(document,"cut",this.handleCut,this);th.observe(document,"copy",this.handleCopy,this);th.observe(document,"paste",this.handlePaste,this)}},relateTo:function(b){this.relateTo=b.canvas;var a=th.cumulativeOffset(this.relateTo).left+10;var c=th.cumulativeOffset(this.relateTo).top+10;this.domInputFirst.style.position="absolute";this.domInputLast.style.position="absolute";this.domInputFirst.style.width="10px";this.domInputLast.style.width="10px";this.domInputFirst.style["z-index"]="-100";this.domInputLast.style["z-index"]="-100";if(this.relateTo.style.display=="none"){this.toggleInputs({isVisible:false})}this.moveInputs({x:a,y:c});this.bus.bind("move",b,this.moveInputs,this);this.bus.bind("toggle",b,this.toggleInputs,this)},toggleInputs:function(b){var a=b.isVisible?"block":"none";this.domInputFirst.style.display=a;this.domInputLast.style.display=a},moveInputs:function(a){this.domInputFirst.style.top=(a.y+50)+"px";this.domInputLast.style.top=(a.y+50)+"px";this.domInputFirst.style.left=(a.x+50)+"px";this.domInputLast.style.left=(a.x+65)+"px"},focusWithinManager:function(){return this.focused!==undefined&&this.domHasFocus!==undefined},performCopy:function(a,b){if(a.clipboardData!==undefined){a.clipboardData.setData("text/plain",b);th.stopEvent(a)}else{this.domHasFocus.value=b;this.domHasFocus.select()}},handleCopy:function(b){if(!this.focusWithinManager()){return}if(th.isFunction(this.focused.performCopy)){var a=this.focused.performCopy();if(!a){th.stopEvent(b);return}else{this.performCopy(b,a)}}},handlePaste:function(a){if(!this.focusWithinManager()){return}if(th.isFunction(this.focused.performPaste)){if(a.clipboardData!==undefined){this.focused.performPaste(a.clipboardData.getData("text/plain"));th.stopEvent(a)}else{this.domHasFocus.value="";th.delay(function(){this.focused.performPaste(this.domHasFocus.value)},0,this)}}},handleCut:function(b){if(!this.focusWithinManager()){return}if(th.isFunction(this.focused.performCut)){var a=this.focused.performCut();if(!a){th.stopEvent(b);return}else{this.performCopy(b,a)}}},enterFirst:function(a){this.domHasFocus=this.domInputFirst;this.domInputFirst.select();if(this.ignoreDomEvent){return}if(this.subscribers.length==-1){return}this.focus(this.subscribers[0]);this.ignoreDomScroll=true},enterLast:function(a){this.domHasFocus=this.domInputLast;this.domInputLast.select();if(this.ignoreDomEvent){return}if(this.subscribers.length==-1){return}this.focus(th.lastArrayItem(this.subscribers));this.ignoreDomScroll=true},domFocusLost:function(a){if(this.ignoreDomEvent){return}if(this.focused!==undefined){if(th.isFunction(this.focused.allowLoseFocus)){if(!this.focused.allowLoseFocus(a)){this.focus(this.focused);return}}}this.focusedLostFocus();delete this.focused;delete this.domHasFocus;this.focusedIndex=-1},removeFocus:function(){this.focusedLostFocus();delete this.focused;delete this.domHasFocus;this.focusedIndex=-1},focusedLostFocus:function(){if(!this.focused){return}this.bus.fire("focus:lost",e,this.focused);delete this.focused.pseudoClass;this.focused.repaint()},handleKeyDown:function(b){if(!this.focusWithinManager()){return}if(b.keyCode==this.KEY_TAB&&this.subscribers.length!=0){var a=false;if(b.shiftKey==false){if(this.focused.focusNext===undefined){this.focusedIndex++;if(this.focusedIndex>=this.subscribers.length){a=true}else{this.focus(this.subscribers[this.focusedIndex])}}else{this.focus(this.focused.focusNext)}}else{if(this.focused.focusPrev===undefined){this.focusedIndex--;if(this.focusedIndex<=-1){a=true}else{this.focus(this.subscribers[this.focusedIndex])}}else{this.focus(this.focused.focusPrev)}}if(!a){th.stopEvent(b)}else{delete this.domHasFocus}return}if(!th.browser.WebKit&&(b.ctrlKey||b.metaKey)){if(b.keyCode==this.C){this.handleCopy(b);return}else{if(b.keyCode==this.X){this.handleCut(b);return}else{if(b.keyCode==this.V){this.handlePaste(b);return}}}}b.focusManager=this;this.bus.fire("keydown",b,this.focused)},handleKeyPress:function(a){if(!this.focusWithinManager()){return}a.focusManager=this;this.bus.fire("keypress",a,this.focused)},handleKeyUp:function(a){if(!this.focusWithinManager()){return}a.focusManager=this;this.bus.fire("keyup",a,this.focused)},focus:function(b){var a=this.subscribers.indexOf(b);if(a==-1){console.error("FocusManager:focus: no such subscribed component!");return}e={};e.newFocused=b;e.focusManager=this;if(this.focused!==undefined&&b!==this.focused){if(th.isFunction(this.focused.allowLoseFocus)){if(!this.focused.allowLoseFocus(e)){this.focusedIndex=this.subscribers.indexOf(this.focused);return false}}}if(this.focused!==undefined){this.focusedLostFocus()}this.focusedIndex=a;this.focused=b;this.bus.fire("focus:received",e,this.focused);this.focused.pseudoClass="active";this.focused.repaint();if(this.focusedIndex==this.subscribers.length-1){this.ignoreDomEvent=true;this.domInputLast.focus();this.ignoreDomEvent=false}else{if(this.focusedIndex==0||this.domHasFocus===undefined){this.ignoreDomEvent=true;this.domInputFirst.focus();this.ignoreDomEvent=false}}return true},subscribe:function(b,c){if(!th.isArray(b)){b=[b]}for(var a=0;a<b.length;a++){if(th.isString(b[a])){if(c===undefined){console.error("I have to know a scene, if I should get a component by its id!");return}b[a]=c.byId(b[a]);if(b[a]===undefined){console.error('Could not find component by id "'+b[a].id+'")');return}}if(!this.hasSubscriber(b[a])){this.subscribers.push(b[a]);b[a].focusManager=this}}},hasSubscriber:function(a){return(this.subscribers.indexOf(a)!=-1)},unsubscribe:function(b){var a=this.subscribers.indexOf(components);if(a==-1){console.error("FocusManager:unsubscribe: no such subscribed component!");return}this.subscribers.splice(a,1);if(a==this.focused){this.bus.fire("focus:lost",{},b);delete b.focusManager;this.focused=-1}},hasFocus:function(a){return(a===this.focused)}}});th.global_event_bus=new th.Bus();th.global_resources=new th.Resources();th.global_scene_array=new Array();th.global_timer=new th.Timer();th.Scene=Class.define({uses:[th.EventHelpers],members:{bus:th.global_event_bus,init:function(a,m,d){if(th.isString(a)){a=document.getElementById("canvasOrId")}this.canvas=a;this.id=this.canvas.id;var h=m;var b="";if(m&&!th.isString(m)){h=m.baseUrl;b=m.stringStyles}if(d){var g=[];var j;var c;for(var f=0;f<2;f++){g[f]=document.createElement("input");j=document.createAttribute("style");j.nodeValue="z-index: -100";c=document.createAttribute("rows");c.nodeValue="10";g[f].setAttributeNode(j);g[f].setAttributeNode(c);this.canvas.parentNode.insertBefore(g[f],this.canvas)}this.focusManager=new th.FocusManager(th.global_event_bus,g[0],g[1]);this.focusManager.relateTo(this)}this.smartRedraw=false;this.resources=th.global_resources;this.resourceCallbackRegistered=false;if(!this.resources.loaded&&!this.resources.loading){this.resources.load(h,b)}th.observe(window,"resize",function(){this.render()},this);this.root=new th.Panel({id:this.id});this.root.scene=this;this.testCanvas=document.createElement("canvas");this.scratchContext=this.testCanvas.getContext("2d");th.fixCanvas(this.scratchContext);this.parseTags();th.global_scene_array.push(this);th.observe(this.canvas,"mousedown",function(i){this.wrapEvent(i,this.root);this.mouseDownComponent=i.thComponent;th.global_event_bus.fire("mousedown",i,i.thComponent)},this);th.observe(window,"mouseup",function(i){if(!this.mouseDownComponent){return}this.wrapEvent(i,this.root);i.isOverMe=(i.thComponent===this.mouseDownComponent);th.global_event_bus.fire("mouseup",i,this.mouseDownComponent);delete this.mouseDownComponent},this);th.observe(this.canvas,"dblclick",function(i){this.wrapEvent(i,this.root);th.global_event_bus.fire("dblclick",i,i.thComponent)},this);th.observe(this.canvas,"click",function(i){this.wrapEvent(i,this.root);th.global_event_bus.fire("click",i,i.thComponent)},this);th.observe(window,"mousemove",function(i){this.wrapEvent(i,this.root);if(this.mouseDownComponent){this.addComponentXY(i,this.root,this.mouseDownComponent);th.global_event_bus.fire("mousedrag",i,this.mouseDownComponent)}},this);th.observe(this.canvas,"mousemove",function(i){this.wrapEvent(i,this.root);th.global_event_bus.fire("mousemove",i,i.thComponent);if(i.thComponent!==this.mouseOverComponent){if(this.mouseOverComponent!==undefined){th.global_event_bus.fire("mouseout",{},this.mouseOverComponent)}this.mouseOverComponent=i.thComponent;th.global_event_bus.fire("mouseover",{},this.mouseOverComponent)}},this);th.observe(this.canvas,"mouseout",function(i){if(this.mouseOverComponent){th.global_event_bus.fire("mouseout",{},this.mouseOverComponent);delete this.mouseOverComponent}},this);var n=th.hitch(this,function(p){this.wrapEvent(p,this.root);var i=p.thComponent;var o=i.parent;while(o){if(o.type=="ScrollPane"){p.delta=0;if(p.wheelDelta){p.delta=p.wheelDelta/500;if(window.opera){p.delta=-p.delta}}else{if(p.detail){p.delta=-p.detail/15}}if(p.delta&&th.isFunction(o.performScroll)){o.performScroll(p)}break}o=o.parent}});if(th.browser.Gecko){window.addEventListener("DOMMouseScroll",n,false)}else{th.observe(this.canvas,"mousewheel",n)}},_byId:function(d,c){for(var b=0;b<c.length;b++){if(c[b].id==d){return c[b]}if(c[b].children){var a=this._byId(d,c[b].children);if(a!==undefined){return a}}}},byId:function(a){return this._byId(a,this.root.children)},render:function(a){if(!this.resources.loaded){if(!this.resourceCallbackRegistered){this.resources.registerOnLoadCallback(this.render,this);if(a){this.resources.registerOnLoadCallback(function(){a(this)},this)}this.resourceCallbackRegistered=true}return}this.layout();this.paint();this.paintSelf();if(a){a(this)}},blockUntilRender:function(){if(!this.resources.loaded){}},parseTags:function(){this.parseCanvasAttributes("grid");this.parseCanvasAttributes("flowLayout");var a=this.canvas.childNodes;this.attachChildElementsToParent(a,this.root)},parseCanvasAttributes:function(){th.forEach(arguments,function(a){if(this.canvas.hasAttribute(a)){this.root[a]=this.canvas.getAttribute(a)}},this)},attachChildElementsToParent:function(a,b){th.forEach(a,function(d){if(d.nodeType==Node.ELEMENT_NODE){var c=this.createComponentFromElement(d,b);if(c){b.add(c);this.attachChildElementsToParent(d.childNodes,c)}else{console.log("Couldn't create component from element \""+d.tagName+'"')}}},this)},createComponentFromElement:function(a,d){var i={};for(var m in th){var g=m.toLowerCase();if(i[g]){console.log('componentMap collision with key "'+g+'"')}i[g]=m}var b=a.tagName.toLowerCase();m=i[b];if(!m){return}var c=th[m];if(!c){return}var h=a.attributes;var f={};th.forEach(h,function(o){var n=o.name;var p=o.value;if(n=="cell"){n="constraints"}f[n]=p});var j=new c(f);if(!j.type){return}if(j.type.toLowerCase()!=b){return}return j},layout:function(){if(this.root){this.root.bounds={x:0,y:0,width:this.canvas.width,height:this.canvas.height};this.root.layoutTree()}},paintSelf:function(a){},paint:function(b){if(!this.resources.loaded){if(!this.resourceCallbackRegistered){this.resources.registerOnLoadCallback(this.render,this);this.resourceCallbackRegistered=true}return}if(!b){b=this.root}if(b){if(b===this.root){b.resolveCss()}if(!b.opaque&&b.parent){return this.paint(b.parent)}var a=this.canvas.getContext("2d");th.fixCanvas(a);a.save();var f=0,d=0;var c=b.parent;var g=b;while(c){if(g.bounds===undefined||g.bounds.x===undefined||g.bounds.y===undefined||g.bounds.width===undefined||g.bounds.height===undefined){return}f+=g.bounds.x;d+=g.bounds.y;g=c;c=c.parent}a.translate(f,d);a.beginPath();a.rect(0,0,b.bounds.width,b.bounds.height);a.closePath();a.clip();if(!this.smartRedraw){a.clearRect(0,0,b.bounds.width,b.bounds.height)}b.paint(a);if(b.border){b.border.paint(a)}a.restore()}}}});th.SimpleBorder=Class.define({type:"Border",uses:[th.ComponentHelpers],members:{init:function(a){this.SIDES=["top","right","bottom","left"];this.component=a},getBorderWidth:function(a){var b=this.component.cssValue("border-"+a+"-width");if(b===undefined){return 0}return th.convertLengthToPixels(b,this.component)},getInsets:function(){return this.calculateInsets("border-","-width")},paint:function(a){if(this.component.cssValue("border-image-url")===undefined){this.paintSimpleBorder(a)}else{this.paintImageBorder(a)}},paintSimpleBorder:function(m){for(var c=0;c<this.SIDES.length;c++){var n=this.SIDES[c];var a=this.getBorderWidth(n);if(a>0){var b=this.component.cssValue("border-"+n+"-color");var g,f,d,j;switch(n){case"top":g=0;f=0;d=a;j=this.component.bounds.width;break;case"right":g=this.component.bounds.width-a;f=0;d=this.component.bounds.height;j=a;break;case"bottom":g=0;f=this.component.bounds.height-a;d=a;j=this.component.bounds.width;break;case"left":g=0;f=0;d=this.component.bounds.height;j=a;break}this.paintBorder(m,b,g,f,j,d)}}},paintImageBorder:function(s){var f=th.global_resources.images[this.component.cssValue("border-image-url")];if(f.width==0){return}var q,n,a,c,p,g,j;q=parseInt(this.component.cssValue("border-image-top"));n=parseInt(this.component.cssValue("border-image-bottom"));a=parseInt(this.component.cssValue("border-image-right"));c=parseInt(this.component.cssValue("border-image-left"));p=f.width;g=f.height;j=this.component.d();bT=th.convertLengthToPixels(this.component.cssValue("border-top-width"));bR=th.convertLengthToPixels(this.component.cssValue("border-right-width"));bB=th.convertLengthToPixels(this.component.cssValue("border-bottom-width"));bL=th.convertLengthToPixels(this.component.cssValue("border-left-width"));s.drawImage(f,0,0,c,q,0,0,bL,bT);s.drawImage(f,p-a,0,a,q,j.b.w-bR,0,bR,bT);s.drawImage(f,0,g-n,c,n,0,j.b.h-bB,bL,bB);s.drawImage(f,p-a,g-n,a,n,j.b.w-bR,j.b.h-bB,bR,bB);switch(this.component.cssValue("border-image-repeat-x")){case"stretch":s.drawImage(f,c,0,p-c-a,q,bL,0,j.b.w-bL-bR,bT);s.drawImage(f,c,g-n,p-c-a,n,bL,j.b.h-bB,j.b.w-bL-bR,bB);break;case"repeat":var i;s.save();s.beginPath();s.rect(bL,0,j.b.w-bL-bR,j.b.h);s.clip();i=c*(bT/q);for(var o=bL;o<j.b.w-bR;o+=i){s.drawImage(f,c,0,p-c-a,q,o,0,i,bT)}i=a*(bB/n);for(var o=bL;o<j.b.w-bR;o+=i){s.drawImage(f,c,g-n,p-c-a,n,o,j.b.h-bB,i,bB)}s.restore();break;default:console.error('border-image-repeat-x "'+this.component.cssValue("border-image-repeat-x")+'" not supported!');break}switch(this.component.cssValue("border-image-repeat-y")){case"stretch":s.drawImage(f,0,q,c,g-q-n,0,bT,bL,j.b.h-bT-bB);s.drawImage(f,p-a,q,a,g-q-n,j.b.w-bR,bT,bR,j.b.h-bT-bB);break;case"repeat":var i;s.save();s.beginPath();s.rect(0,bT,j.b.w,j.b.h-bT-bB);s.clip();i=q*(bL/c);for(var m=bT;m<j.b.h-bB;m+=i){s.drawImage(f,0,q,c,g-q-n,0,m,bL,i)}i=q*(bR/a);for(var m=bT;m<j.b.h-bB;m+=i){s.drawImage(f,p-a,q,a,g-q-n,j.b.w-bR,m,bR,i)}s.restore();break;default:console.error('border-image-repeat-y "'+this.component.cssValue("border-image-repeat-x")+'" not supported!');break}},paintBorder:function(c,d,a,g,b,f){c.fillStyle=d;c.fillRect(a,g,b,f)}}});th.Component=Class.define({type:"Component",uses:[th.ComponentHelpers],members:{init:function(a){if(!a){a={}}for(var b in a){this[b]=a[b]}this.scrollTop=0;this.scrollLeft=0;if(!this.bounds){this.bounds={}}this.border=new th.SimpleBorder(this);if(this.opaque==undefined){this.opaque=true}this.bus=th.global_event_bus;this.styles=undefined;this.localStyles={};this.refreshCss=true},getScratchContext:function(){var a=this.getScene();if(a){return a.scratchContext}},getInsets:function(){var a=this.border.getInsets();a=this.calculateInsets("padding-","",a);return a},getMargins:function(){return this.calculateInsets("margin-")},paint:function(a){},repaint:function(){if(!this.getScene()){return}this.getScene().paint(this)}}});th.SimpleLayout=Class.define({members:{init:function(a){if(!a){a={}}this.orientation=a.orientation||th.HORIZONTAL},layout:function(c){var q=c.d();if(c.children.length>0){var p=(this.orientation==th.HORIZONTAL);var g=(p)?q.b.iw:q.b.ih;var f=parseInt(g/c.children.length);var s=g%c.children.length;var m=(p)?q.i.l:q.i.t;var n=m;for(var o=0;o<c.children.length;o++){var b=0;if(s>0){s--;b=1}var a=m;var j=f+b;c.children[o].bounds=(p)?{x:a,y:n,width:j,height:q.b.ih}:{x:n,y:a,width:q.b.iw,height:j};m+=j}}},getMinimumSize:function(a,d){var f=(this.orientation==th.HORIZONTAL)?"width":"height";var c=0;for(var b=0;b<a.children.length;b++){c+=a.children[b].getMinimumSize()[f]}return c},getPreferredSize:function(a){var d=(this.orientation==th.HORIZONTAL)?"width":"height";var c=0;for(var b=0;b<a.children.length;b++){c+=a.children[b].getPreferredSize()[d]}return c},getMaximumSize:function(a){var d=(this.orientation==th.HORIZONTAL)?"width":"height";var c=0;for(var b=0;b<a.children.length;b++){c+=a.children[b].getMaximumSize()[d]}return c}}});th.FlowLayout=Class.define({members:{init:function(a){if(a!="horizontal"&&a!="vertical"){console.error('Not known orientation "'+a+'"')}this.orientation=a=="horizontal"?th.HORIZONTAL:th.VERTICAL},layout:function(q){var y=q.d();if(q.children.length>0){var x=(this.orientation==th.HORIZONTAL);var v=(x)?y.b.iw:y.b.ih;var f=x?"width":"height";var g=x?"left":"top";var c=x?"right":"bottom";var b=x?"top":"left";var a=x?"bottom":"right";var j=0;var s=0;var u=[];th.forEach(q.children,function(B,h){var d=0;var A=B.calculateInsets("margin-","");if(B.layoutdata!==undefined){if(B.layoutdata.indexOf("px")>0){d=th.convertLengthToPixels(B.layoutdata)}else{try{s+=parseFloat(B.layoutdata);j+=A[g]+A[c];return}catch(i){console.error('Cannot interpretate layoutData "'+B.layoutdata+'" of child "'+B.id+'"')}}}else{d+=B.getPreferredSize()[f]}u[h]=d;j+=d+A[g]+A[c]});var z=v-j;var r=(x)?y.i.l:y.i.t;var p=(!x)?y.i.l:y.i.t;for(var w=0;w<q.children.length;w++){var o=q.children[w];var t=o.calculateInsets("margin-","");var n=r+t[g];if(u[w]!==undefined){var m=u[w]}else{var m=(z/s)*parseFloat(o.layoutdata)}o.bounds=(x)?{x:n,y:p+t[b],width:m,height:y.b.iw-(t[b]+t[a])}:{x:p+t[b],y:n,width:y.b.iw-(t[b]+t[a]),height:m};r+=m+t[g]+t[c]}}}},getMinimumSize:function(a,d){var f=(this.orientation==th.HORIZONTAL)?"width":"height";var c=0;for(var b=0;b<a.children.length;b++){c+=a.children[b].getMinimumSize()[f]}return c},getPreferredSize:function(a){var d=(this.orientation==th.HORIZONTAL)?"width":"height";var c=0;for(var b=0;b<a.children.length;b++){c+=a.children[b].getPreferredSize()[d]}return c},getMaximumSize:function(a){var d=(this.orientation==th.HORIZONTAL)?"width":"height";var c=0;for(var b=0;b<a.children.length;b++){c+=a.children[b].getMaximumSize()[d]}return c}});th.Container=Class.define({type:"Container",superclass:th.Component,uses:[th.ContainerHelpers],members:{init:function(a){this._super(a);this.children=[];this.checkedForFormLayout=false;this.layoutManager=new th.SimpleLayout()},add:function(){for(var c=0;c<arguments.length;c++){var a=th.isArray(arguments[c])?arguments[c]:[arguments[c]];this.children=this.children.concat(a);for(var b=0;b<a.length;b++){a[b].parent=this;a[b].refreshCss=true}}},remove:function(){for(var d=0;d<arguments.length;d++){var b=th.isArray(arguments[d])?arguments[d]:[arguments[d]];for(var c=0;c<b.length;c++){var a=this.children.length;this.children=th.remove(this.children,b[c]);if(a!=this.children.length){delete b[c].parent}}}},replace:function(b,a){this.bus.unbind(this.children[a]);b.parent=this;this.children[a]=b},paint:function(a){if(this.shouldPaint()){this.paintSelf(a);this.paintChildren(a)}},paintSelf:function(a){},paintChildren:function(a){for(var d=0;d<this.children.length;d++){if(!this.children[d].shouldPaint()){continue}if(!this.children[d].bounds){continue}a.save();try{a.translate(this.children[d].bounds.x,this.children[d].bounds.y)}catch(b){a.restore();continue}try{a.beginPath();a.rect(0,0,this.children[d].bounds.width,this.children[d].bounds.height);a.closePath();a.clip()}catch(c){}a.save();this.children[d].paint(a);if(this.children[d].border){this.children[d].border.paint(a)}a.restore();a.restore()}},installLayoutManager:function(c){this.layoutManager=c;var f=false;for(var b=0;b<this.children.length;b++){if(this.children[b]["constraints"]!==undefined){if(!this.children[b].cssValue("-th-constraints")){this.children[b].addCss("-th-constraints",this.children[b]["constraints"])}}if(this.children[b].cssValue("-th-constraints")){f=true}}if(c instanceof th.formlayout.FormLayout){if(!f){var d=1;var a=1;th.forEach(this.children,function(g){var j=false;while(d<=c.getRowCount()){while(a<=c.getColumnCount()){var i=c.getColumnSpec(a);if(i.isSpacer()){a++;continue}j=true;break}if(j){var h=c.getRowSpec(d);if(!h.isSpacer()){break}}j=false;d++;a=1}if(!j){return}c.addLayoutComponent(g,new th.formlayout.CellConstraints(a,d));a++})}else{th.forEach(this.children,function(g){var h=g.cssValue("-th-constraints");c.addLayoutComponent(g,new th.formlayout.CellConstraints(h))})}}},layoutTree:function(){if(!this.checkedForFormLayout){this.checkedForFormLayout=true;if(this.grid){var b=this.grid.split(";");if(b.length!=2){console.log("Couldn't parse 'grid' property: "+this.grid)}else{this.addCss("-th-grid-cols",b[0]);this.addCss("-th-grid-rows",b[1])}var d=this.cssValue("-th-grid-cols");var c=this.cssValue("-th-grid-rows");if(d&&c){this.installLayoutManager(new th.formlayout.FormLayout(d,c))}}else{if(this.flowLayout){this.layoutManager=new th.FlowLayout(this.flowLayout)}}}this.layout();for(var a=0;a<this.children.length;a++){if(this.children[a].layoutTree){this.children[a].layoutTree()}}},layout:function(){if(this.layoutManager){this.layoutManager.layout(this)}},render:function(){if(!th.global_resources.loaded){return}this.layoutTree();this.repaint()}}});th.WindowScene=Class.define({type:"Window",superclass:th.Scene,members:{init:function(a){if(!a){a={}}this._super(a.canvasOrId,a.baseUrlOrParams,a.createFocusManager);this.isVisible=(a.isVisible===undefined)?false:a.isVisible;this.canvas.style.position="absolute";if(this.isVisible){this.canvas.style.display="block"}else{this.canvas.style.display="none"}a.x=(a.x===undefined)?100:a.x;a.y=(a.y===undefined)?100:a.x;this.move(a.x,a.y);this.label=new th.Label();this.label.type="WindowLabel";this.label.text=a.title||"";this.label.parent=this.root;this.label.addCss("visibility","hidden");this.isDraggable=(a.isDraggable===undefined)?true:a.isDraggable;if(this.isDraggable){th.observe(this.canvas,"mousedown",this.onmousedown,this);th.observe(window,"mouseup",this.onmouseup,this);th.observe(window,"mousemove",this.onmousemove,this)}},move:function(a,b){this.canvas.style.top=b+"px";this.canvas.style.left=a+"px";this.posX=a;this.posY=b;this.bus.fire("move",{x:a,y:b},this)},centerUp:function(){this.move(Math.round((window.innerWidth-this.canvas.width)*0.5),Math.round((window.innerHeight-this.canvas.height)*0.25))},center:function(){this.move(Math.round((window.innerWidth-this.canvas.width)*0.5),Math.round((window.innerHeight-this.canvas.height)*0.5))},toggle:function(){this.isVisible=!this.isVisible;if(this.isVisible){this.canvas.style.display="block"}else{this.canvas.style.display="none"}this.bus.fire("toggle",{isVisible:this.isVisible},this)},getPosition:function(){return{x:this.posX,y:this.posY}},onmousedown:function(g){var h=this.root.d();var f=th.cumulativeOffset(this.canvas).left+h.i.l;var b=f+this.canvas.width-h.i.r;var c=th.cumulativeOffset(this.canvas).top+h.i.t;var a=c+this.canvas.height-h.i.b;if(g.clientX>f&&g.clientX<b&&g.clientY>c&&g.clientY<a){return}this.startValue={mouse:{x:g.clientX,y:g.clientY},window:this.getPosition()};th.stopEvent(g)},onmousemove:function(c){if(this.startValue){var b=this.startValue;var a=b.window.x-(b.mouse.x-c.clientX);var d=b.window.y-(b.mouse.y-c.clientY);this.move(a,d);th.stopEvent(c)}},onmouseup:function(a){delete this.startValue},paintSelf:function(){if(this.label.text==""){return}var a=this.canvas.getContext("2d");this.label.resolveCss();this.label.bounds={x:th.convertLengthToPixels(this.label.cssValue("left")||"0px"),y:th.convertLengthToPixels(this.label.cssValue("top")||"0px"),width:th.convertLengthToPixels(this.label.cssValue("width"))||this.label.getPreferredSize().width,height:th.convertLengthToPixels(this.label.cssValue("width"))||this.label.getPreferredSize().height};a.save();a.translate(this.label.bounds.x,this.label.bounds.y);this.label.paint(a);a.restore()}}});if(typeof th=="undefined"){th={}}th.Panel=Class.define({type:"Panel",superclass:th.Container,members:{init:function(a){this._super(a)},paintSelf:function(a){this.paintBackground(a)}}});th.Button=Class.define({type:"Button",superclass:th.Component,members:{init:function(a){if(!a){a={}}this._super(a);this.orientation=a.orientation||th.VERTICAL},getPreferredSize:function(){var f=this.getInsets();var d=f.left+f.right;var h=f.top+f.bottom;var a=this.cssValue("height");if(a!==undefined){a=th.convertLengthToPixels(a,this)}var g=this.cssValue("width");if(g!==undefined){g=th.convertLengthToPixels(g,this)}if(a!==undefined&&g!==undefined){return{width:g+d,height:a+h}}var b=this.tmb();if((b)&&(b.top&&b.mid&&b.bot)){if(this.isVertical()){if(a===undefined){a=b.top.height+b.mid.height+b.bot.height}if(g===undefined){g=b.top.width}}else{if(a===undefined){a=b.top.height}if(g===undefined){g=b.top.width+b.mid.width+b.bot.width}}return{width:g+d,height:a+h}}var c=this.getFirstBackgroundImage();if(c){return{width:c.width+d,height:c.height+h}}return{width:d,height:h}},tmb:function(){var b=this.cssValue("-th-top-image");var a=this.cssValue("-th-middle-image");var c=this.cssValue("-th-bottom-image");if(b){b=th.global_resources.images[b]}if(a){a=th.global_resources.images[a]}if(c){c=th.global_resources.images[c]}if(b&&a&&c){return{top:b,mid:a,bot:c}}},paint:function(a){var b=this.d();var c=this.tmb();if(!c){c={}}if(c.top&&c.mid&&c.bot){if(this.isVertical()){if(b.b.h>=c.top.height+c.bot.height){a.drawImage(c.top,0,0);if(b.b.h>c.top.height+c.bot.height){a.drawImage(c.mid,0,c.top.height,c.mid.width,b.b.h-c.top.height-c.bot.height)}a.drawImage(c.bot,0,b.b.h-c.bot.height)}}else{if(b.b.w>=c.top.width+c.bot.width){a.drawImage(c.top,0,0);if(b.b.w>c.top.width+c.bot.width){a.drawImage(c.mid,c.top.width,0,b.b.w-c.top.width-c.bot.width,c.mid.height)}a.drawImage(c.bot,b.b.w-c.bot.width,0)}}}else{this.paintBackground(a)}}}});th.Scrollbar=Class.define({type:"Scrollbar",superclass:th.Container,members:{init:function(a){if(!a){a={}}this._super(a);this.orientation=a.orientation||th.VERTICAL;this.value=a.value||0;this.min=a.min||0;this.max=a.max||100;this.extent=a.extent||0.1;this.increment=a.increment||2;this.up=new th.Button({className:"up"});this.down=new th.Button({className:"down"});this.bar=new th.Button({className:"bar"});this.add([this.up,this.down,this.bar]);this.bus.bind("click",this.up,this.scrollup,this);this.bus.bind("click",this.down,this.scrolldown,this);this.bus.bind("mousedrag",this.bar,this.onmousedrag,this);this.bus.bind("mouseup",this.bar,this.onmouseup,this)},getPixelRange:function(){},setValue:function(a){if(a<this.min){this.value=this.min}else{if(a>this.max){this.value=this.max}else{this.value=a}}this.bus.fire("scroll",{min:this.min,max:this.max,value:this.value},this)},onmousedrag:function(f){var c=(this.isVertical())?f.clientY:f.clientX;if(this.dragstart_value==undefined){this.dragstart_value=this.value;this.dragstart_mouse=c;return}var d=c-this.dragstart_mouse;var a=this.getPixelRange();var b=(this.max-this.min)/a;this.setValue(this.dragstart_value+Math.floor(d*b));this.render()},onmouseup:function(a){delete this.dragstart_value;delete this.dragstart_mouse},scrollup:function(a){if(this.value>this.min){this.setValue(Math.max(0,this.value-this.increment));this.render()}},scrolldown:function(a){if(this.value<this.max){this.setValue(Math.min(this.max,this.value+this.increment));this.render()}},tmb:function(){var b=this.cssValue("-th-top-image");var a=this.cssValue("-th-middle-image");var c=this.cssValue("-th-bottom-image");if(b){b=th.global_resources.images[b]}if(a){a=th.global_resources.images[a]}if(c){c=th.global_resources.images[c]}if(b&&a&&c){return{top:b,mid:a,bot:c}}},getPreferredSize:function(){var d=this.getInsets();var c=d.left+d.right;var g=d.top+d.bottom;var a=this.cssValue("height");if(a!==undefined){a=th.convertLengthToPixels(a,this)}var f=this.cssValue("width");if(f!==undefined){f=th.convertLengthToPixels(f,this)}if(a!==undefined&&f!==undefined){return{width:f+c,height:a+g}}var b=this.tmb();if(b.top&&b.mid&&b.bot){if(this.isVertical()){if(a===undefined){a=b.top.height+b.mid.height+b.bot.height}if(f===undefined){f=b.top.width}}else{if(a===undefined){a=b.top.height}if(f===undefined){f=b.top.width+b.mid.width+b.bot.width}}return{width:f+c,height:a+g}}},layout:function(){var m=this.d();this.bar.orientation=this.orientation;if(this.max<this.min){console.error("scrollbar max is less than min; can't do layout",this);for(var f=0;f<this.children.length;f++){delete this.children[f].bounds}return}if(this.orientation==th.VERTICAL){var n=m.b.iw;var g=this.up.getPreferredSize().height;this.up.setBounds(m.i.l,m.i.t,n,g);this.down.setBounds(m.i.l,m.b.ih-g,n,g);var o=m.b.ih-this.up.bounds.height-this.down.bounds.height;var j=Math.min(Math.floor(o/(1+this.extent),o));var a=Math.floor(this.up.bounds.height+Math.min((this.value*o*this.extent/(this.max*(1+this.extent)))));var b=(a+j)-this.down.bounds.y;if(b>0){a-=b}this.bar.setBounds(m.i.l,a,m.b.iw,j)}else{var n=this.up.getPreferredSize().width;var g=m.b.ih;this.up.setBounds(m.i.l,m.i.t,n,g);this.down.setBounds(m.b.iw-n,m.i.t,n,g);var c=m.b.iw-this.up.bounds.width-this.down.bounds.width;var j=Math.min(Math.floor(c/(1+this.extent),c));var a=Math.floor(this.up.bounds.height+Math.min((this.value*c*this.extent/(this.max*(1+this.extent)))));var b=(a+j)-this.down.bounds.x;if(b>0){a-=b}this.bar.setBounds(a,m.i.t,j,m.b.ih)}},paint:function(a){if(this.max<0){return}this.bar.orientation=this.orientation;this.paintTrack(a);this._super(a)},paintTrack:function(a){}}});th.VerticalScrollbar=Class.define({type:"VerticalScrollbar",superclass:th.Scrollbar,members:{init:function(a){if(!a){a={}}a.orientation=th.VERTICAL;this._super(a)},getPixelRange:function(){var a=this.d();return a.b.ih-this.up.bounds.height-this.down.bounds.height-this.bar.bounds.height},paintTrack:function(a){var b=this.d();var c=this.tmb();if(!c){return}if(c.top){a.drawImage(c.top,b.i.l,this.up.bounds.height)}if(c.mid){a.drawImage(c.mid,b.i.l,this.up.bounds.height+c.top.height,c.mid.width,this.down.bounds.y-this.down.bounds.height-(this.up.bounds.x-this.up.bounds.height))}if(c.bot){a.drawImage(c.bot,b.i.l,this.down.bounds.y-c.bot.height)}}}});th.HorizontalScrollbar=Class.define({type:"HorizontalScrollbar",superclass:th.Scrollbar,members:{init:function(a){if(!a){a={}}a.orientation=th.HORIZONTAL;this._super(a)},getPixelRange:function(){var a=this.d();return a.b.iw-this.up.bounds.width-this.down.bounds.width-this.bar.bounds.width},paintTrack:function(a){var b=this.d();var c=this.tmb();if(!c){return}if(c.top){a.drawImage(c.top,this.up.bounds.width,b.i.t)}if(c.mid){a.drawImage(c.mid,this.up.bounds.width+c.top.width,b.i.t,this.down.bounds.x-(this.up.bounds.x+this.up.bounds.width),c.mid.height)}if(c.bot){a.drawImage(c.bot,this.down.bounds.x-c.bot.width,b.i.t)}}}});th.ResizeNib=Class.define({type:"ResizeNib",superclass:th.Component,members:{init:function(a){this._super(a);this.bus.bind("mousedown",this,this.onmousedown,this);this.bus.bind("mouseup",this,this.onmouseup,this);this.bus.bind("mousedrag",this,this.onmousedrag,this)},onmousedown:function(a){this.startPos={x:a.clientX,y:a.clientY}},onmousedrag:function(a){if(this.startPos){if(!this.firedDragStart){this.bus.fire("dragstart",this.startPos,this);this.firedDragStart=true}this.bus.fire("drag",{startPos:this.startPos,currentPos:{x:a.clientX,y:a.clientY}},this)}},onmouseup:function(a){if(this.startPos&&this.firedDragStart){this.bus.fire("dragstop",{startPos:this.startPos,currentPos:{x:a.clientX,y:a.clientY}},this);delete this.firedDragStart}delete this.startPos},paint:function(o){var g=this.d();if(this.orientation==th.VERTICAL){var j=7;var n=Math.floor((g.b.w/2)-(j/2));var m=7;o.fillStyle=this.cssValue("-th-vertical-bar-shadow-color");for(var f=0;f<3;f++){o.fillRect(n,m,j,1);m+=3}m=8;o.fillStyle=this.cssValue("-th-vertical-bar-color");for(var f=0;f<3;f++){o.fillRect(n,m,j,1);m+=3}}else{var c=7;var a=8;var h=c+2;var n=Math.floor(g.b.w/2-(a/2));var m=Math.floor(g.b.h/2-(h/2));var b=n;if(this.cssValue("-th-horizontal-bar-subtle-shadow-color")){o.fillStyle=this.cssValue("-th-horizontal-bar-subtle-shadow-color");for(var f=0;f<3;f++){o.fillRect(b,m,1,h);b+=3}}b=n+1;o.fillStyle=this.cssValue("-th-horizontal-bar-shadow-color");for(var f=0;f<3;f++){o.fillRect(b,m+h-1,1,1);b+=3}b=n+1;o.fillStyle=this.cssValue("-th-horizontal-bar-color");for(var f=0;f<3;f++){o.fillRect(b,m+1,1,c);b+=3}}}}});th.Splitter=Class.define({type:"Splitter",superclass:th.Panel,members:{init:function(a){this._super(a);this.opaque=false;this.topNib=new th.ResizeNib({orientation:this.orientation});this.bottomNib=new th.ResizeNib({orientation:this.orientation});this.add(this.topNib,this.bottomNib);this.label=a.label;if(this.label){this.add(this.label)}this.scrollbar=a.scrollbar;if(this.scrollbar){this.add(this.scrollbar)}this.bus.bind("drag",[this.topNib,this.bottomNib],this.ondrag,this);this.bus.bind("dragstart",[this.topNib,this.bottomNib],this.ondragstart,this);this.bus.bind("dragstop",[this.topNib,this.bottomNib],this.ondragstop,this)},ondrag:function(a){this.bus.fire("drag",a,this)},ondragstart:function(a){this.bus.fire("dragstart",a,this)},ondragstop:function(a){this.bus.fire("dragstop",a,this)},getPreferredSize:function(){var d=this.getInsets();var c=d.left+d.right;var g=d.top+d.bottom;var b=this.cssValue("height");if(b!==undefined){b=th.convertLengthToPixels(b,this)}var f=this.cssValue("width");if(f!==undefined){f=th.convertLengthToPixels(f,this)}if(b!==undefined&&f!==undefined){return{width:f+c,height:b+g}}if(this.scrollbar&&this.scrollbar.shouldLayout()){var a=this.scrollbar.getPreferredSize();if(a){return{width:a.width+c,height:a.height+g}}}return{width:(f===undefined)?c:f+c,height:(b===undefined)?g:b+g}},layout:function(){var a=this.d();if(!this.orientation){this.orientation=(this.bounds.height>this.bounds.width)?th.HORIZONTAL:th.VERTICAL}if(this.orientation==th.HORIZONTAL){this.topNib.setBounds(a.i.l,a.i.t,a.b.iw,a.b.iw);this.bottomNib.setBounds(a.i.l,a.b.ih-a.b.iw,a.b.iw,a.b.iw);if(this.scrollbar&&this.scrollbar.shouldLayout()){this.scrollbar.setBounds(a.i.l,this.topNib.bounds.height,a.b.iw,a.b.ih-(this.topNib.bounds.height*2))}}else{this.topNib.setBounds(a.i.l,a.i.t,a.b.ih,a.b.ih);this.bottomNib.setBounds(a.b.iw-a.b.ih,a.i.t,a.b.ih,a.b.ih);if(this.label){this.label.setBounds(this.topNib.bounds.x+this.topNib.bounds.width,a.i.t,a.b.iw-(a.b.ih*2),a.b.ih)}}}}});th.VerticalSplitter=Class.define({type:"VerticalSplitter",superclass:th.Splitter,members:{init:function(a){if(!a){a={}}a.orientation=th.HORIZONTAL;this._super(a)}}});th.SplitPanelContainer=Class.define({type:"SplitPanelContainer",superclass:th.Panel,members:{init:function(a){this._super(a);this.splitter=new th.Splitter({orientation:this.orientation,label:a.label})},getContents:function(){var a=th.remove(this.children,this.splitter);if(a.length>0){return a[0]}},layout:function(){var c=th.remove(this.children,this.splitter);if(this.children.length==c.length){this.add(this.splitter)}var b=this.splitter.getPreferredSize();var a=(this.orientation==th.HORIZONTAL)?b.width:b.height;if(this.splitter.shouldLayout()){if(this.orientation==th.HORIZONTAL){this.splitter.setBounds(this.bounds.width-a,0,a,this.bounds.height)}else{this.splitter.setBounds(0,this.bounds.height-a,this.bounds.width,a)}}else{a=0}if(c.length>0){if(this.orientation==th.HORIZONTAL){c[0].setBounds(0,0,this.bounds.width-a,this.bounds.height)}else{c[0].setBounds(0,0,this.bounds.width,this.bounds.height-a)}}}}});th.SplitPanel=Class.define({type:"SplitPanel",superclass:th.Panel,uses:[th.StringHelpers],members:{init:function(a){this._super(a);if(!this.orientation){this.orientation=th.HORIZONTAL}if(!this.regions){this.regions=[{},{}]}},ondragstart:function(b){var a=b.thComponent.parent;a.region.startSize=a.region.size},ondrag:function(b){var a=b.thComponent.parent;var c=(this.orientation==th.HORIZONTAL)?b.currentPos.x-b.startPos.x:b.currentPos.y-b.startPos.y;a.region.size=a.region.startSize+c;this.render()},ondragstop:function(b){var a=b.thComponent.parent;delete a.region.startSize},layout:function(){this.remove(this.children);for(var c=0;c<this.regions.length;c++){var h=this.regions[c];if(!h.container){h.container=new th.SplitPanelContainer({orientation:this.orientation,label:h.label});h.container.region=h;this.bus.bind("dragstart",h.container.splitter,this.ondragstart,this);this.bus.bind("drag",h.container.splitter,this.ondrag,this);this.bus.bind("dragstop",h.container.splitter,this.ondragstop,this)}if(h.contents&&(h.contents!=h.container.getContents())){h.container.removeAll();h.container.add(h.contents)}if(c==this.regions.length-1){h.container.splitter.addCss("display","none")}this.add(h.container)}var j=(this.orientation==th.HORIZONTAL)?this.bounds.width:this.bounds.height;var a=0;for(var c=0;c<this.regions.length;c++){var f=this.regions[c];if(!f.size){f.size=(this.defaultSize||(100/this.regions.length)+"%")}if(this.isPercentage(f.size)){f.size=Math.floor((parseInt(f.size)/100)*j)}if(f.size<30){f.size=30}a+=f.size}if(a>j){var g=a-j;for(var c=this.regions.length-1;c>=0;c--){var f=this.regions[c];var b=f.size;f.size-=g;if(f.size<30){f.size=30}g-=(b-f.size);if(g<=0){break}}}else{if(a<j){var f=this.regions[this.regions.length-1].size+=(j-a)}}var d=0;for(var c=0;c<this.regions.length;c++){var h=this.regions[c];if(this.orientation==th.HORIZONTAL){h.container.setBounds(d,0,h.size,this.bounds.height)}else{h.container.setBounds(0,d,this.bounds.width,h.size)}d+=h.size}}}});th.Label=Class.define({type:"Label",superclass:th.Panel,members:{init:function(a){if(!a){a={}}this._super(a);this.text=a.text||""},styleContext:function(a){if(!a){return}a.font=this.cssValue("font");a.fillStyle=this.cssValue("color");return a},getPreferredSize:function(){var b=this.styleContext(this.parent.getScratchContext());var c=this.getInsets();var a=b.measureText(this.text).width+2;a+=c.left+c.right;var d=Math.floor(b.measureText(this.text).ascent*1.5);d+=c.top+c.bottom;return{height:d,width:a}},paint:function(n){this._super(n);var f=this.d();this.styleContext(n);var g=n.measureText(this.text);var h=f.i.t+g.ascent;if(th.browser.WebKit){h+=1}if(g.width<=(f.b.w-f.i.w)){var i;var a=this.cssValue("text-align")||"left";switch(a){case"start":case"left":i=f.i.l;break;case"center":i=f.i.l+((f.b.iw-g.width)/2);break;case"end":case"right":i=f.i.l+f.b.iw-g.width;break;default:console.error('orientation "'+this.orientation+'"???');break}n.fillText(this.text,i,h)}else{if(this.text===undefined){this.text=""}var c=this.text;var m=c.length-2;while(g.width>(f.b.iw)){if(m<=0){if(this.text.length>1){c="..."}else{c=this.text}break}var b=Math.floor(m/2);var j=b+(m%2);c=this.text.substring(0,b)+"..."+this.text.substring(this.text.length-j);g=n.measureText(c);m-=1}n.fillText(c,f.i.l,h)}}}});th.Input=Class.define({type:"input",superclass:th.Panel,uses:[th.KeyHelpers],members:{init:function(a){if(!a){a={}}this._super(a);this.text=a.text||"";this.xOff=0;this.isMouseDown=false;this.isCursorVisible=false;this.cursorTimer=undefined;this.cursorTogglePeriod=600;this.selStart=this.text.length;this.selEnd=this.selStart;this.selRelStart=this.selStart;this.selRelEnd=this.selEnd;this.bus.bind("keypress",this,this.onKeyPress,this);this.bus.bind("mousedown",this,this.onMouseDown,this);this.bus.bind("mousemove",this,this.onMouseMove,this);this.bus.bind("mouseup",this,this.onMouseUp,this);this.bus.bind("dblclick",this,this.onMouseDoubleClick,this);this.setupKeyHelpers();this.bindKey("",this.ARROW_LEFT,this.actions.moveCursorLeft);this.bindKey("SHIFT",this.ARROW_LEFT,this.actions.moveCursorLeft);this.bindKey("CMD",this.ARROW_LEFT,this.actions.moveCursorBeginning);this.bindKey("CMD SHIFT",this.ARROW_LEFT,this.actions.moveCursorBeginning);this.bindKey("",this.ARROW_RIGHT,this.actions.moveCursorRight);this.bindKey("SHIFT",this.ARROW_RIGHT,this.actions.moveCursorRight);this.bindKey("CMD",this.ARROW_RIGHT,this.actions.moveCursorEnd);this.bindKey("CMD SHIFT",this.ARROW_RIGHT,this.actions.moveCursorEnd);this.bindKey("",this.BACKSPACE,this.actions.backspace);this.bindKey("",this.DELETE,this.actions.deleteKey);this.bindKey("CMD",this.A,this.selectAll);this.bus.bind("focus:received",this,this.receivedFocus,this);this.bus.bind("focus:lost",this,this.lostFocus,this)},receivedFocus:function(){this.isCursorVisible=false;clearTimeout(this.cursorTimer);this.toggleCursor()},lostFocus:function(){this.isCursorVisible=false;clearTimeout(this.cursorTimer);delete this.cursorTimer;setTimeout(th.hitch(this,function(){this.repaint()}),1)},actions:{moveCursorLeft:function(a){if(this.selStart!=this.selEnd&&!a.shiftKey){this.setSelection(this.selRelStart,undefined,false)}else{this.setSelection(Math.max(--this.selStart,0),(a.shiftKey?this.selEnd:undefined),false)}},moveCursorRight:function(a){if(this.selStart!=this.selEnd&&!a.shiftKey){this.setSelection(this.selRelEnd,undefined,false)}else{this.setSelection(Math.max(++this.selStart,0),(a.shiftKey?this.selEnd:undefined),false)}},moveCursorBeginning:function(a){this.setSelection(0,(a.shiftKey?this.selEnd:undefined),true)},moveCursorEnd:function(a){this.setSelection(this.text.length,(a.shiftKey?this.selEnd:undefined),true)},backspace:function(a){if(this.selStart==this.selEnd){this.text=this.text.substring(0,this.selRelStart-1)+this.text.substring(this.selRelEnd);this.setSelection(--this.selRelStart,undefined,true)}else{this.text=this.text.substring(0,this.selRelStart)+this.text.substring(this.selRelEnd);this.setSelection(this.selRelStart,undefined,true)}this.bus.fire("text:changed",{text:this.text},this)},deleteKey:function(a){if(this.selStart==this.selEnd){this.text=this.text.substring(0,this.selRelStart)+this.text.substring(this.selRelEnd+1);this.setSelection(this.selRelStart,undefined,true);this.repaint()}else{this.text=this.text.substring(0,this.selRelStart)+this.text.substring(this.selRelEnd);this.setSelection(this.selRelStart,undefined,true)}this.bus.fire("text:changed",{text:this.text},this)}},performCopy:function(){if(this.selStart==this.selEnd){return false}return this.getSelectedText()},performCut:function(){if(this.selStart==this.selEnd){return false}var a=this.getSelectedText();this.text=this.text.substring(0,this.selRelStart)+this.text.substring(this.selRelEnd);this.selEnd=this.selStart;this.repaint();this.bus.fire("text:changed",{text:this.text},this);return a},performPaste:function(a){this.text=this.text.substring(0,this.selRelStart)+a+this.text.substring(this.selRelEnd);this.setSelection(this.selRelStart+a.length,undefined);this.bus.fire("text:changed",{text:this.text},this)},setSelection:function(c,b,h){if(b===undefined){b=c}if(h===undefined){h=true}this.selStart=Math.max(Math.min(c,this.text.length),0);this.selEnd=Math.max(Math.min(b,this.text.length),0);var g=this.selRelStart;var j=this.selRelEnd;if(this.selStart>this.selEnd){this.selRelStart=this.selEnd;this.selRelEnd=this.selStart}else{this.selRelStart=this.selStart;this.selRelEnd=this.selEnd}if(g!=this.selRelStart||j!=this.selRelEnd){if(this.selStart!=0){var i=this.d();var a=this.styleContext(this.parent.getScratchContext());this.styleContext(a);var f=a.measureText(this.text.substring(0,this.selStart)).width;if((this.xOff+f)>i.b.iw){if(!h){this.xOff=Math.max(this.xOff-Math.round(i.b.iw/2),-a.measureText(this.text).width+i.b.iw)}else{this.xOff=i.b.iw-f}}var f=a.measureText(this.text.substring(0,this.selStart)).width;if((this.xOff+f)<=0){if(!h){this.xOff=Math.min(this.xOff+Math.round(i.b.iw/2),0)}else{this.xOff=i.i.l-f}}}else{this.xOff=0}if(this.cursorTimer){clearTimeout(this.cursorTimer);this.isCursorVisible=false;this.toggleCursor()}else{this.repaint()}}},selectAll:function(){this.setSelection(0,this.text.length)},getSelectedText:function(){return this.text.substring(this.selRelStart,this.selRelEnd)},setText:function(b,a){this.text=b;this.setSelection(b.length);if(!a){this.bus.fire("text:changed",{text:this.text},this)}},getPosForPosition:function(f){var b=this.styleContext(this.parent.getScratchContext());this.styleContext(b);var a;var c=this.xOff+this.d().i.l;var d=c;for(a=1;a<this.text.length+1&&d<f;a++){d=c+b.measureText(this.text.substring(0,a)).width}return a-1},onMouseDown:function(a){if(this.focusManager!==undefined){if(!this.focusManager.focus(this)){th.stopEvent(a);return}}this.isMouseDown=true;this.setSelection(this.getPosForPosition(a.componentX),(this.isShiftDown?this.selRelEnd:undefined));th.stopEvent(a)},onMouseMove:function(a){if(this.isMouseDown){this.setSelection(this.getPosForPosition(a.componentX),this.selEnd)}},onMouseUp:function(a){this.isMouseDown=false},onMouseDoubleClick:function(c){var a=this.getPosForPosition(c.componentX);var d=a;for(d;d!=-1&&this.text[d]!=" ";d--){}var b=this.text.indexOf(" ",a);b=(b==-1?this.text.length:b);this.setSelection(++d,b)},onKeyPress:function(b){var a=this.getPrintableChar(b);if(a){this.text=this.text.substring(0,this.selRelStart)+a+this.text.substring(this.selRelEnd);this.setSelection(++this.selStart);this.bus.fire("text:changed",{text:this.text},this);this.bus.fire("text:changed:newChar",{text:this.text,newChar:a},this)}},toggleCursor:function(){this.isCursorVisible=!this.isCursorVisible;this.repaint();this.cursorTimer=setTimeout(th.hitch(this,this.toggleCursor),this.cursorTogglePeriod)},styleContext:function(a){if(!a){return}a.font=this.cssValue("font");a.fillStyle=this.cssValue("color");return a},getPreferredSize:function(){var b=this.styleContext(this.parent.getScratchContext());var c=this.getInsets();var a=b.measureText(this.text).width+2;a+=c.left+c.right;var d=Math.floor(b.measureText(this.text).ascent*1.5);d+=c.top+c.bottom;return{height:d,width:a}},paint:function(b){this._super(b);var g=this.d();b.save();b.beginPath();b.rect(g.i.l,g.i.t,g.b.iw,g.b.ih);b.clip();b.translate(g.i.l+this.xOff,0);var c=b.measureText(this.text);var h=g.i.t+c.ascent;if(th.browser.WebKit){h+=1}this.styleContext(b);var f=b.fillStyle;if(this.focusManager.hasFocus(this)){var a=b.measureText(this.text.substring(0,this.selRelStart)).width-(this.selRelStart!=0?1:0);if(this.selStart==this.selEnd){if(this.isCursorVisible){b.fillRect(a,g.i.t-2,1,h+3)}}else{b.fillStyle=this.cssValue("selection-color")||"#B5D2F3";b.fillRect(a,g.i.t-2,b.measureText(this.text.substring(this.selRelStart,this.selRelEnd)).width,h+3)}}b.fillStyle=f;b.fillText(this.text,0,h+2);b.restore()}}});th.HtmlLabel=Class.define({type:"Label",superclass:th.Panel,members:{init:function(a){if(!a){a={}}this._super(a);this.text=a.text||"";this.lastText="";this.parsedHtml=[];this.regTag=/#\w+|\w+/g;this.regTags=/<(\w+|\w+\s+|#[a-fA-F0-9]{3}|#[a-fA-F0-9]{6})>|<\/(\w+|\w+\s|#[a-fA-F0-9]{3}|#[a-fA-F0-9]{6})>/g},styleContext:function(a,b){if(!a||!b){return}a.font=[b["font-weight"],b["font-style"],b["font-size"],b["font-family"]].join(" ");a.fillStyle=b.color;return a},parseHtml:function(){if(this.lastText==this.text&&this.parsedHtml.length!=0){return}var d={"font-family":"Tahoma","font-size":"9pt","font-style":"","font-weight":"","text-decoration":"",color:"black"};var j=[d];var m=th.getSpaceDelimitedItems(this.cssValue("font"));var g=[];for(var f=0;f<m.length;f++){if(th.isCssLength(m[f])){d["font-size"]=m[f]}else{switch(m[f]){case"bold":d["font-weight"]="bold";break;case"italic":d["font-style"]="italic";break;default:g.push(m[f]);break}}}d["font-family"]=g.join(", ");d.color=this.cssValue("color");if(this.lastText==this.text&&this.parsedHtml.length==0){this.parsedHtml.push({style:d});return}var c,p,n=this.text;var h=[""];var a=0;this.parsedHtml=[];var o=this.text.match(this.regTags);if(o!=null){for(var f=0;f<o.length;f++){var b=n.indexOf(o[f]);this.parsedHtml.push({style:j[a],text:n.substring(0,b)});n=n.substring(b+o[f].length);p=o[f].match(this.regTag)[0];if(o[f][1]!="/"){c=th.clone(j[a]);switch(p){case"b":case"strong":c["font-weight"]="bold";break;case"i":c["font-style"]="italic";break;case"u":c["text-decoration"]="underline";break;default:if(p[0]=="#"){c.color=p}else{console.error("parseHtml: Can't parse the tag '"+p+"' => !skip! parsing!");return}break}j.push(c);h.push(p);a++}else{if(h[a]!=p){console.error("parseHtml: Close tag '"+p+"' but should close '"+h[a]+"' => !skip! parsing!");return}j.pop();h.pop();a--}}if(a!=0){console.error("parseHtml: not all tag were closed again => !skip! parsing!");return}}this.parsedHtml.push({style:j[0],text:n});this.shouldParse=false;this.lastText=this.text},getPreferredSize:function(){this.parseHtml();var b=this.styleContext(this.parent.getScratchContext(),this.parsedHtml[0].style);var c=this.getInsets();var a=b.measureText(this.text).width+2;a+=c.left+c.right;var d=Math.floor(b.measureText(this.text).ascent*1.5);d+=c.top+c.bottom;return{height:d,width:a}},paint:function(p){this._super(p);var g=this.d();if(this.text!=this.lastText){this.parseHtml()}if(this.text!=this.lastText){return}this.styleContext(p,this.parsedHtml[0].style);h=p.measureText("text");var j=g.i.t+h.ascent;if(th.browser.WebKit){j+=1}var b=0;var m=(g.b.w-g.i.w);var h,c,n;var o,a;p.save();for(var f=0;f<this.parsedHtml.length;f++){o=this.parsedHtml[f].text;a=this.parsedHtml[f].style;if(o==""){continue}this.styleContext(p,a);h=p.measureText(o);if(b+h.width<=m){p.fillText(o,g.i.l+b,j);if(a["text-decoration"]=="underline"){p.lineWidth=1;p.strokeStyle=a.color;p.beginPath();p.moveTo(g.i.l+b,j+2.5);p.lineTo(g.i.l+b+h.width,j+2.5);p.stroke();p.closePath()}b+=h.width}else{n=o.length-2;c=o;while((b+h.width>m)&&n>0){c=o.substring(0,--n)+"...";h=p.measureText(c)}p.fillText(c,g.i.l+b,j);break}}p.restore()}}});th.TextButton=Class.define({type:"TextButton",superclass:th.Label,members:{init:function(a){if(!a){a={}}this._super(a);this.clickFunction=a.onclick;this.bus.bind("mousedown",this,this.onMouseDown,this);this.bus.bind("mouseup",this,this.onMouseUp,this)},onMouseDown:function(a){this.pseudoClass="active";this.repaint()},onMouseUp:function(a){delete this.pseudoClass;this.repaint();if(a.isOverMe){this.onClick()}},onClick:function(e){if(th.isFunction(this.clickFunction)){this.clickFunction(e)}else{if(th.isString(this.clickFunction)){eval(this.clickFunction)}}}},});th.ExpandingInfoPanel=Class.define({type:"ExpandingInfoPanel",superclass:th.Panel,members:{init:function(a){this._super(a)},getMinimumRowHeight:function(){return 40},getMinimumColumnWidth:function(){},layout:function(){if(this.children.length==0){return}var o=this.d();var v=Math.floor(Math.sqrt(this.children.length));var u=Math.floor(o.b.h/v);while(u<this.getMinimumRowHeight()&&v>1){v--;u=Math.floor(o.b.h/v)}var s=Math.floor(this.children.length/v);var t=this.children.length%v;var g=0;var a=o.b.h%v;var c=0;for(var m=0;m<v;m++){var n=(m==v-1)?u+a:u;var q=(t>0)?s+1:s;t--;var b=Math.floor(o.b.w/q);var j=o.b.w%q;var f=0;for(var p=0;p<q;p++){var r=(p==q-1)?b+j:b;this.children[g++].setBounds(f,c,r,n);f+=r}c+=n}}}});th.List=Class.define({type:"List",superclass:th.Container,members:{init:function(a){if(!a){a={}}this._super(a);this.items=a.items||[];this.allowDeselection=a.allowDeselection||false;this.bus.bind("mousedown",this,this.onmousedown,this);this.bus.bind("keydown",this,this.onkeydown,this);this.renderer=new th.Label();this.renderer.addCss("visibility","hidden");this.add(this.renderer);if(a.topLabel){this.addTopLabel(a.topLabel)}},getPreferredSize:function(){return{width:100,height:this.getRowHeight()*this.items.length}},performCopy:function(){if(!this.selected){return false}return this.getItemText(this.selected)},performCut:function(){if(!this.selected){return}var a=this.getItemText(this.selected);th.removeArrayItem(this.items,this.selected);delete this.selected;this.repaint();return a},performPaste:function(a){this.items.push(a);this.repaint()},addTopLabel:function(a){this.label=a;this.label.className="header";this.add(this.label)},onmousedown:function(b){if(this.focusManager!==undefined){if(!this.focusManager.focus(this)){th.stopEvent(b);return}}var a=this.getItemForPosition({x:b.componentX,y:b.componentY});if(a!=this.selected){if(a){this.selected=a;this.bus.fire("itemselected",{container:this,item:this.selected},this);this.getScene().render()}else{if(this.allowDeselection){delete this.selected}}}th.stopEvent(b)},onkeydown:function(a){if(a.keyCode==38){this.moveSelectionUp();th.stopEvent(a)}else{if(a.keyCode==40){this.moveSelectionDown();th.stopEvent(a)}}},selectItemByText:function(c){if(this.items.length==0){return false}var b=null;if(th.isObject(this.items[0])){for(var a=0;a<this.items.length;a++){if(this.getItemText(this.items[a])==c){b=this.items[a];break}}if(b==null){return false}}else{if(this.items.indexOf(c)==-1){return false}b=this.items[this.items.indexOf(c)]}if(this.selected!=b){this.selected=b;this.repaint()}return true},moveSelectionUp:function(){if(!this.selected||this.items.length==0){return}var a=0;while(this.items[a]!=this.selected){a++}if(a!=0){this.selected=this.items[a-1];this.bus.fire("itemselected",{container:this,item:this.selected},this);this.repaint()}},moveSelectionDown:function(){if(!this.selected&&this.items.length==0){return}if(!this.selected&&this.items.length!=0){var a=-1}else{var a=0;while(this.items[a]!=this.selected){a++}}if(a!=this.items.length-1){this.selected=this.items[a+1];this.bus.fire("itemselected",{container:this,item:this.selected},this);this.repaint()}},getItemForPosition:function(d){d.y+=this.scrollTop;var c=this.getInsets().top;if(this.label){c+=this.label.bounds.height}for(var a=0;a<this.items.length;a++){var b=this.heights[a];if(d.y>=c&&d.y<=c+b){return this.items[a]}c+=b}},getItemText:function(a){if(a.text){return a.text}if(th.isString(a)){return a}return a.toString()},getRenderer:function(a){this.renderer.text=this.getItemText(a.item);this.renderer.selected=a.selected;this.renderer.pseudoClass=(this.renderer.selected)?"active":undefined;this.renderer.item=a.item;this.renderer.className=a.even?"even":"odd";if(a.item.contents){this.renderer.className+="more"}this.renderer.resolveCss();return this.renderer},getRenderContext:function(a,b){return{item:a,even:b%2==0,selected:this.selected===a}},getRowHeight:function(){if(!this.rowHeight){var c=this.d();var b=(this.items.length>0)?this.items[0]:undefined;if(b){var a=this.getRenderer(this.getRenderContext(b,0));this.rowHeight=a.getPreferredSize().height}}return this.rowHeight||0},layout:function(){},paint:function(p){var j=this.d();var f=Math.max(this.getPreferredSize().height,j.b.h);var m=j.i.t;if(this.label){this.label.addCss("visibility","visible");var i=this.label.getPreferredSize().height;this.label.setBounds(j.i.l,m,j.b.w,i);this.label.paint(p);this.label.border.paint(p);m+=i;this.label.addCss("visibility","hidden")}p.save();p.translate(-this.scrollLeft,-this.scrollTop);try{this.paintBackground(p,0,m,j.b.w,f);if(this.items.length==0){return}if(!this.renderer){console.log("No renderer for List of type "+this.type+" with id "+this.id+"; cannot paint contents");return}this.heights=[];var b=0;while(m<f&&b<this.items.length){var c=(b<this.items.length);var o=c?this.items[b]:"";var a=this.getRenderer(this.getRenderContext(o,b));if(!a){break}var n=j.b.w-j.i.w;var g=(this.rowHeight)?this.rowHeight:(c)?a.getPreferredSize().height:this.heights[this.heights.length-1];if(c){this.heights.push(g)}if((m+g)>=this.scrollTop){a.setBounds(0,0,n,g);p.save();p.translate(j.i.l,m);p.beginPath();p.rect(0,0,n,g);p.closePath();p.clip();a.addCss("visibility","visible");a.paint(p);a.border.paint(p);a.addCss("visibility","hidden");p.restore()}b++;m+=g}}finally{p.restore()}}}});th.ScrollPane=Class.define({type:"ScrollPane",superclass:th.Panel,members:{init:function(a){if(!a){a={}}this._super(a);this.hscroll=new th.HorizontalScrollbar();this.vscroll=new th.VerticalScrollbar();this.hscroll.increment=10;this.vscroll.increment=10;this.bus.bind("scroll",this.hscroll,this.hscrolled,this);this.bus.bind("scroll",this.vscroll,this.vscrolled,this);this.hscroll_c=this.hscroll;this.vscroll_c=this.vscroll;if(a.splitter){this.vsplitter=new th.VerticalSplitter({scrollbar:this.vscroll});this.vscroll_c=this.vsplitter;this.bus.bind("dragstart",this.vsplitter,this.ondragstart,this);this.bus.bind("drag",this.vsplitter,this.ondrag,this);this.bus.bind("dragstop",this.vsplitter,this.ondragstop,this)}this.viewport=new th.Panel();this.topPanel=new th.Panel();this.viewport.layout=function(){};this.children=[this.topPanel,this.viewport,this.hscroll_c,this.vscroll_c];this.viewport.parent=this;this.topPanel.parent=this;this.hscroll_c.parent=this;this.vscroll_c.parent=this},performScroll:function(a){l=this.vscroll_c.scrollbar;this.vscroll_c.scrollbar.setValue(this.vscroll_c.scrollbar.value-a.delta*100);th.stopEvent(a)},ondragstart:function(a){if(this.preferredWidth==undefined){this.preferredWidth=this.bounds.width}this.startSize=this.preferredWidth},ondrag:function(a){var b=a.currentPos.x-a.startPos.x;this.preferredWidth=this.startSize+b;this.getScene().render()},ondragstop:function(a){delete this.startSize},hscrolled:function(a){this.viewport.scrollLeft=a.value;this.getScene().render()},vscrolled:function(a){this.viewport.scrollTop=a.value;this.getScene().render()},add:function(a){if(th.isArray(a)){a=a[0]}this.view=a;this.viewport.add(this.view)},remove:function(a){if(this.view==a){this.viewport.remove(a);this.view=undefined}},getPreferredSize:function(){if(this.preferredWidth&&this.preferredHeight){return{width:this.preferredWidth,height:this.preferredHeight}}var a;if(this.view){a=this.view.getPreferredSize()}else{a=this._super()}if(this.preferredWidth){a.width=this.preferredWidth}if(this.preferredHeight){a.height=this.preferredHeight}return a},layout:function(){var n=this.view;if(!n){return}var j=this.d();var r=0;if(this.topPanel.children.length!=0){if(this.topPanel.cssValue("height")){r=th.convertAbsoluteUnitToPixels(this.topPanel.cssValue("height"))}else{r=this.topPanel.getPreferredSize().height}}this.topPanel.setBounds(j.i.l,j.i.t,j.b.iw,r);this.viewport.setBounds(j.i.l,j.i.t+r,j.b.iw,j.b.ih-r);var s=n.getPreferredSize();var m=Math.max(s.width,this.viewport.bounds.width);var p=Math.max(s.height,this.viewport.bounds.height);var g=this.cssValue("overflow-x")!="hidden";var f=this.cssValue("overflow-y")!="hidden";if(!g){m=this.viewport.bounds.width}if(!f){p=this.viewport.bounds.height}if(this.topPanel){this.topPanel.setBounds(0,0,m,r)}n.setBounds(-this.viewport.scrollLeft,-this.viewport.scrollTop,m,p);if(!f&&!g){return}var c=n.bounds;var q=this.hscroll_c.getPreferredSize();var a=this.vscroll_c.getPreferredSize();var b=false;var o=false;if((c.width>j.b.iw)&&g){b=true}if((c.height>(j.b.ih-(b?q.height:0)))&&f){o=true}var i=(b||this.hsplitter);var h=(o||this.vsplitter);if(i){this.hscroll_c.addCss("visibility","visible");this.hscroll_c.setBounds(j.i.l,(j.i.t+j.b.ih)-q.height+r,j.b.iw,q.height-r);this.viewport.bounds.height-=this.hscroll_c.bounds.height;if(!h){n.bounds.height-=this.hscroll_c.bounds.height}if(b){this.hscroll.min=0;this.hscroll.max=c.width-this.viewport.bounds.width;this.hscroll.extent=this.hscroll.max/c.width;this.hscroll.addCss("visibility","visible")}else{this.hscroll.max=0;this.hscroll.addCss("visibility","hidden")}}else{this.hscroll_c.addCss("visibility","hidden")}if(h){this.vscroll_c.addCss("visibility","visible");this.vscroll_c.setBounds((j.i.l+j.b.iw)-a.width,j.i.t+r,a.width,j.b.ih-r);this.viewport.bounds.width-=this.vscroll_c.bounds.width;if(!i){n.bounds.width-=this.vscroll_c.bounds.width}if(o){this.vscroll.min=0;this.vscroll.max=c.height-this.viewport.bounds.height;this.vscroll.extent=this.vscroll.max/c.height;this.vscroll.addCss("visibility","visible")}else{this.vscroll.max=0;this.vscroll.addCss("visibility","hidden")}}else{this.vscroll_c.addCss("visibility","hidden")}if(b&&o){this.hscroll_c.bounds.width-=this.vscroll_c.bounds.width}else{if(!b){n.bounds.x=0;this.viewport.scrollLeft=0;this.hscroll.value=0}if(!o){n.bounds.y=0;this.viewport.scrollTop=0;this.vscroll.value=0}}}}});th.HorizontalTree=Class.define({type:"HorizontalTree",superclass:th.Panel,members:{init:function(b){if(!b){b={}}this._super(b);this.scrollPane=new th.ScrollPane();this.add(this.scrollPane);this.contents=new th.Panel();this.scrollPane.add(this.contents);var a=this;this.contents.getPreferredSize=function(){var c=0;var d=0;var g;var f=th.convertLengthToPixels(a.cssValue("-th-list-width"),a);th.forEach(a.scrollPanes,function(i){if(!i.preferredWidth){if(g==undefined){g=f}c+=g}else{c+=i.preferredWidth}var h=i.getPreferredSize().height;if(h>d){d=h}});if(a.details){c+=f}return{height:d,width:c}};this.contents.layout=function(){var h=this.d();var f=h.i.l;for(var g=0;g<a.scrollPanes.length;g++){var c=a.scrollPanes[g];if(!c.preferredWidth){c.preferredWidth=th.convertLengthToPixels(a.cssValue("-th-list-width"),a)}c.setBounds(f,h.i.t,c.preferredWidth,h.b.h-h.i.h);f+=c.bounds.width}if(a.details){a.details.setBounds(f,h.i.t,th.convertLengthToPixels(a.cssValue("-th-list-width"),a),h.b.h-h.i.h)}};this.orientation=th.HORIZONTAL;this.scrollPanes=[]},setData:function(b){for(var a=0;a<this.scrollPanes.length;a++){this.contents.remove(this.scrollPanes[a]);if(this.scrollPanes[a].view){this.bus.unbind(this.scrollPanes[a].view)}}this.scrollPanes=[];this.data=b;this.showChildren(null,b)},updateData:function(a,b){a.contents=b;if(this.getSelectedItem()==a){this.showChildren(a,a.contents)}},replaceList:function(a,b){this.scrollPanes[a].view.items=b;delete this.scrollPanes[a].view.selected;this.render()},removeListsFrom:function(b){for(var a=b;a<this.scrollPanes.length;a++){this.bus.unbind(this.scrollPanes[a].view);this.remove(this.scrollPanes[a])}this.scrollPanes=this.scrollPanes.slice(0,b);this.getScene().render()},showChildren:function(d,c){if(this.details){this.contents.remove(this.details);delete this.details}if(!th.isArray(c)){c(this.getSelectedPath(),this);this.render();return}if(!c||c.length==0){return}var f=this.createList(c);if(this.id){f.id=this.id+"-list-"+(this.scrollPanes.length+1)}this.bus.bind("itemselected",f,this.itemSelected,this);var b=this;this.bus.bind("dblclick",f,function(g){b.bus.fire("dblclick",g,b)});var a=new th.ScrollPane({splitter:true});a.add(f);this.scrollPanes.push(a);this.contents.add(a);if(this.parent){this.render()}if(this.scrollPane.hscroll.max!=0){this.scrollPane.hscroll.setValue(this.scrollPane.hscroll.max)}},showDetails:function(b){if(this.details){this.contents.remove(this.details)}if(!this.getDetailPanel){return}var a=this.getDetailPanel(b);this.details=a;this.contents.add(this.details);if(this.parent){this.render()}if(this.scrollPane.hscroll.max!=0){this.scrollPane.hscroll.setValue(this.scrollPane.hscroll.max)}},createList:function(b){var c=new th.List({items:b});var d=c.getItemText;var a=this;c.getItemText=function(f){if(a.getItemText){return a.getItemText(f)}else{return d(f)}};return c},getSelectedItem:function(){var a=this.getSelectedPath();if(a.length>0){return a[a.length-1]}},getSelectedPath:function(c){c=c||false;var d=[];var b;for(b=0;b<this.scrollPanes.length;b++){if(this.scrollPanes[b].view.selected){d.push(this.scrollPanes[b].view.selected)}else{break}}if(d.length==0){return}if(c){var a="";for(b=0;b<d.length-1;b++){a+=this.getItemText(d[b])+"/"}if(!d[d.length-1].contents){a+=this.getItemText(d[d.length-1])}else{a+=this.getItemText(d[d.length-1])+"/"}return a}else{return d}},itemSelected:function(h){var f=h.thComponent;if(!f.selected){return}var g=[];for(var c=0;c<this.scrollPanes.length;c++){g.push(this.scrollPanes[c].view.selected);if(this.scrollPanes[c].view==f){for(var a=c+1;a<this.scrollPanes.length&&this.scrollPanes[a].view.selected;a++){if(this.scrollPanes[a-1].view.selected){this.scrollPanes[a-1].view.selected.lastSelected=this.scrollPanes[a].view.selected.name}delete this.scrollPanes[a].view.selected}break}}this.bus.fire("itemselected",{e:h},this);if(g.length<this.scrollPanes.length){var d=this.scrollPanes.slice(0,g.length);for(var m=g.length;m<this.scrollPanes.length;m++){this.contents.remove(this.scrollPanes[m]);this.bus.unbind(this.scrollPanes[m].view)}this.scrollPanes=d}var b=g[g.length-1];if(b&&b.contents){this.showChildren(b,b.contents)}else{this.showDetails(b)}},getItem:function(c){var a=this.data;var d;for(var b=0;b<c.length;b++){for(var f=0;f<a.length;f++){if(a[f]==c[b]){d=a[f];a=d.contents;break}}}return d},getList:function(a){var b=this.scrollPanes[a];if(b!=undefined){return b.view}else{return undefined}},getListCount:function(){return this.scrollPanes.length},layout:function(){var a=this.d();this.scrollPane.setBounds(a.i.l,a.i.t,a.b.iw,a.b.ih)},paintSelf:function(a){this._super(a)}}});th.DEFAULT_CSS="* {/* this should probably be the browser's default font */font: 10pt Arial, sans-serif;}VerticalScrollbar {-th-top-image: url(/images/scroll_gutter_top.png);-th-middle-image: url(/images/scroll_gutter_mid.png);-th-bottom-image: url(/images/scroll_gutter_btm.png);}VerticalScrollbar > Button.bar {-th-top-image: url(/images/scroll_thumb_top.png);-th-middle-image: url(/images/scroll_thumb_mid.png);-th-bottom-image: url(/images/scroll_thumb_btm.png);}VerticalScrollbar > Button.up {background-image: url(/images/scroll_cntrl_up.png);}VerticalScrollbar > Button.down {background-image: url(/images/scroll_cntrl_dwn.png);}HorizontalScrollbar {-th-top-image: url(/images/h_scroll_gutter_btm.png);-th-middle-image: url(/images/h_scroll_gutter_mid.png);-th-bottom-image: url(/images/h_scroll_gutter_top.png);}HorizontalScrollbar > Button.bar {-th-top-image: url(/images/h_scroll_thumb_btm.png);-th-middle-image: url(/images/h_scroll_thumb_mid.png);-th-bottom-image: url(/images/h_scroll_thumb_top.png);}HorizontalScrollbar > Button.up {background-image: url(/images/h_scroll_cntrl_up.png);}HorizontalScrollbar > Button.down {background-image: url(/images/h_scroll_cntrl_dwn.png);}ResizeNib {-th-vertical-bar-color: rgb(10, 10, 8);-th-vertical-bar-shadow-color: rgb(185, 180, 158);-th-horizontal-bar-subtle-shadow-color: rgba(0, 0, 0, 0.1);-th-horizontal-bar-shadow-color: black;-th-horizontal-bar-color: rgb(183, 180, 160);}Label {padding: 2px 5px;color: black;}List Label:active {border-top: 1px solid rgb(180, 114, 30);border-bottom: 1px solid rgb(162, 97, 19);background-image: -webkit-gradient(linear, left top, left bottom, from(#AF6814), to(#DE8419));}HorizontalTree {-th-list-width: 160px;-th-details-width: 150px;}Splitter.vertical {height: 20px;}Splitter.horizontal {width: 17px;}Button {background-color: gray;}TextButton {text-align: center;}HorizontalTree List {background-color: inherit;}List {background-color: white;}List Label:active {background-color: blue;}ScrollPane {background-color: #413F37;border: 1px solid black;}HorizontalTree > ScrollPane {overflow-y: hidden;}HorizontalTree ScrollPane {border: 0;}HorizontalTree Panel {background-color: blue;}HorizontalTree {border: 1px solid black;";if(typeof th=="undefined"){th={}}th.Settings=new(Class.define({members:{init:function(){this.settings={tabSize:4,strictlines:true,smartmove:true}},get:function(a){return this.settings[a]},isSettingOn:function(a){var b=this.settings[a];return(b===true)||(b==="on")||(b==="enable")}}}));if(typeof th.Editor=="undefined"){th.Editor={}}th.Editor.Template=Class.define({type:"Editor::Template",superclass:th.Panel,uses:[th.KeyHelpers],members:{init:function(a){this._super(a);this.model=new th.Editor.Model(this);this.cursor=new th.Editor.Cursor(this);this.actions=new th.Editor.Actions(this);this.vscroll=new th.VerticalScrollbar();this.add(this.vscroll);this.leftPadding=0;this.rightPadding=0;this.scrollTop=0;this.bus.bind("scroll",this.vscroll,this.vscrolled,this);this.bus.bind("editor:model:changed",this,this.onModelChange,this);this.bus.bind("editor:cursor:moved",this,this.onCursorMove,this);this.bus.bind("keypress",this,this.onKeyPress,this);this.key.bind("",this.key.ARROW_RIGHT,this.execAction("moveCursorRight"),this.actions);this.key.bind("",this.key.ARROW_LEFT,this.execAction("moveCursorLeft"),this.actions);this.key.bind("",this.key.ARROW_UP,this.execAction("moveCursorUp"),this.actions);this.key.bind("",this.key.ARROW_DOWN,this.execAction("moveCursorDown"),this.actions);this.key.bind("",this.key.PAGE_UP,this.execAction("movePageUp"),this.actions);this.key.bind("",this.key.PAGE_DOWN,this.execAction("movePageDown"),this.actions);this.key.bind("",this.key.HOME,this.execAction("moveToLineStart"),this.actions);this.key.bind("",this.key.END,this.execAction("moveToLineEnd"),this.actions);this.key.bind("CTRL",this.key.ARROW_RIGHT,this.execAction("moveWordRight"),this.actions);this.key.bind("CTRL",this.key.ARROW_LEFT,this.execAction("moveWordLeft"),this.actions);this.key.bind("",this.key.BACKSPACE,this.execAction("backspace"),this.actions);this.key.bind("",this.key.DELETE,this.execAction("deleteKey"),this.actions);this.key.bind("",this.key.ENTER,this.execAction("newline"),this.actions);this.key.setupEvents(this);this.NoWL=[];this.caret={top:0,left:0};this.selection=undefined;this.CpL=undefined;this.LpP=undefined;this.RpP=undefined;this.font=undefined;this.color=undefined;this.charSize={width:0,height:0}},vscrolled:function(a){this.scrollTop=a.value;this.repaint()},onCursorMove:function(f){var d=f.oldPos;var b=f.newPos;var c=this.CpL*this.charSize.width;var a;if(this.options.wrap){if(b.row==d.row){this.caret.top-=Math.floor(d.col/this.CpL)*this.charSize.height;this.caret.top+=Math.floor(b.col/this.CpL)*this.charSize.height;this.caret.left=(b.col%this.CpL)*this.charSize.width}else{if(b.row>d.row){a=0;a+=this.NoWL[d.row]-Math.floor(d.col/this.CpL);for(var g=d.row+1;g<b.row;g++){a+=this.NoWL[g]}a+=Math.floor(b.col/this.CpL);this.caret.top+=a*this.charSize.height;this.caret.left=(b.col%this.CpL)*this.charSize.width}else{a=0;a+=Math.floor(d.col/this.CpL);for(var g=d.row-1;g>b.row;g--){a+=this.NoWL[g]}a+=this.NoWL[b.row]-Math.floor(b.col/this.CpL);this.caret.top-=a*this.charSize.height;this.caret.left=(b.col%this.CpL)*this.charSize.width}}}else{this.caret.top=b.row*this.charSize.height;this.caret.left=b.col*this.charSize.width}},onModelChange:function(b){var a;var c=0;for(var d=0;d<this.model.getRowCount();d++){a=this.model.getMetaRowLength(d);this.NoWL[d]=(a==0)?1:Math.ceil(a/this.CpL);c+=this.NoWL[d]}this.vscroll.min=0;this.vscroll.max=c*this.charSize.height-this.d().b.ih;this.vscroll.extent=this.vscroll.max/this.d().b.ih;this.vscroll.addCss("visibility","visible")},updateScrollbar:function(){this.vscroll.value=this.scrollTop;this.vscroll.layout();this.vscroll.repaint()},execAction:function(a){if(this.actions[a]===undefined){return function(b){}}return th.hitch(this,function(c){var b={event:c,pos:th.clone(this.cursor.getCursorPosition())};this.actions[a](b)})},onKeyPress:function(c){var a=this.key.getPrintableChar(c);if(a){var b={event:c,pos:th.clone(this.cursor.getCursorPosition()),newchar:a};this.actions.insertCharacter(b)}},getSelection:function(){return this.selection},setSelection:function(a){this.selection=a},layout:function(){if(this.font===undefined){this.font=this.cssValue("font");var b=this.getScratchContext();b.font=this.font;this.charSize=b.measureText("M");this.charSize.height=Math.ceil(this.charSize.ascent*2.8)}if(this.color===undefined){this.color=this.cssValue("color")}var c=this.d();this.vscroll.setBounds(c.b.w-14,0,14,c.b.h);var a=c.b.iw-this.leftPadding-this.rightPadding;this.CpL=Math.floor(a/this.charSize.width);this.LpP=Math.ceil((c.b.ih-0.75*this.charSize.height)/this.charSize.height);this.bus.fire("editor:model:changed",{},this)},paintText:function(o){var v=this.d();var a=this.CpL*this.charSize.width;var m=0;var c=this.getFirstVisibleRow(this.scrollTop);var n=this.getFirstVisibleRow(this.scrollTop+this.LpP*this.charSize.height);var f=-1;var p;this.RpP=0;for(var q=c.row;q<=n.row;q++){p=this.getRowLength(q);if(p>f){f=p}m+=this.NoWL[q]*this.charSize.height;this.RpP++}f=a*Math.ceil(f/a);var w=this.getScratchContext();w.canvas.height=m;w.canvas.width=Math.max(f*this.charSize.width,v.b.w);w.translate(0,this.charSize.height*0.75);w.font=this.font;w.fillStyle=this.color;for(var q=c.row;q<=n.row;q++){this.paintRow(w,q);if(this.options.wrap){w.translate(0,this.NoWL[q]*this.charSize.height)}else{w.translate(0,this.charSize.height)}}o.translate(this.leftPadding,0-c.offset);if(this.options.wrap){var h=0,g=0,j=a,u=m;var s=0,r=0,t=a,b=m;while(h<(f*this.charSize.width)){o.drawImage(w.canvas,h,g,j,u,s,r,t,b);h+=a;r+=this.charSize.height}}else{o.drawImage(w.canvas,0,0,a,m,0,0,a,m)}},paintSelf:function(a){if(this.model.isEmpty()){return}a.save();this.paintUnderText(a);a.restore();a.save();this.paintText(a);a.restore();a.save();this.paintOverText(a);a.restore()},adjustScrollTop:function(){if(this.caret.top<this.scrollTop){this.scrollTop=this.caret.top}else{if((this.caret.top+this.charSize.height)>(this.scrollTop+this.LpP*this.charSize.height)){this.scrollTop=this.caret.top+this.charSize.height-this.LpP*this.charSize.height}}},paintRow:function(a,c){var b=this.model.getMetaRowString(c);a.fillText(b,0,0)},paintUnderText:function(a){},paintOverText:function(a){a.translate(this.leftPadding,0);a.fillRect(this.caret.left,this.caret.top-this.scrollTop,1,this.charSize.height)},getFirstVisibleRow:function(c){if(c===undefined){c=this.scrollTop}var b;if(!this.options.wrap){b=Math.floor(c/this.charSize.height);return{row:b,offset:c-b*this.charSize.height}}else{var a=0;b=0;while((a+=this.NoWL[b]*this.charSize.height)<c){b++}return{row:b,offset:c-a+this.NoWL[b]*this.charSize.height}}},getRowLength:function(a){return this.model.getMetaRowLength(a)},getPageRowCount:function(){if(this.RpP===undefined){return 0}return this.RpP}}});th.SimpleEditor=Class.define({type:"SimpleEditor",superclass:th.Editor.Template,members:{init:function(a){this._super(a);this.rightPadding=20;this.leftPadding=30;this.options={};this.options.wrap=(a.wrap===undefined)?false:(a.wrap=="true")},paintRow:function(b,c){var a=this.model.getMetaRowLength(c);if(c==this.cursor.getCursorPosition().row){b.save();b.fillStyle="#F0F0F0";b.fillRect(0,-0.75*this.charSize.height,a*this.charSize.width,this.charSize.height);b.restore()}this._super(b,c)},paintUnderText:function(a){a.fillStyle="#A9F4CF";a.fillRect(0,0,this.leftPadding-5,this.d().b.ih);a.fillStyle="white";a.fillRect(this.leftPadding-5,0,this.d().b.iw-this.leftPadding+5,this.d().b.ih)}}});th.Editor.Model=Class.define({type:"Editor::Model",members:{init:function(a){this.editor=a;this.rows=[];this.cacheRowMetadata=[];this.editor.bus.bind("editor:model:change",this,this.change,this)},change:function(a){this[a.action].apply(this,th.isArray(a.args)?a.args:[a.args]);this.editor.bus.fire("editor:model:changed",{},this.editor)},isEmpty:function(){if(this.rows.length>1){return false}if(this.rows.length==1&&this.rows[0].length>0){return false}return true},getDirtyRows:function(){var a=(this.dirtyRows)?this.dirtyRows:[];this.dirtyRows=null;return a},setRowDirty:function(a){if(!this.dirtyRows){this.dirtyRows=new Array(this.rows.length)}this.dirtyRows[a]=true},isRowDirty:function(a){if(!this.dirtyRows){return true}return this.dirtyRows[a]},setRowArray:function(b,a){if(!th.isArray(a)){a=a.split("")}this.rows[b]=a},getRowArray:function(a){while(this.rows.length<=a){this.rows.push([])}return this.rows[a]},getRowLength:function(a){if(a<0||a>=this.rows.length){return 0}return this.rows[a].length},hasRow:function(a){return(this.rows[a])},insertCharacters:function(a,b){var d=this.getRowArray(a.row);while(d.length<a.col){d.push(" ")}var c=(a.col>0)?d.splice(0,a.col):[];c=c.concat(b.split(""));this.rows[a.row]=c.concat(d);this.setRowDirty(a.row);this.invalidateSyntaxCache(a.row)},getDocument:function(){var b=[];for(var a=0;a<this.getRowCount();a++){b[a]=this.getRowArray(a).join("")}return b.join("\n")},insertDocument:function(b){this.clear();var c=b.split("\n");for(var a=0;a<c.length;a++){this.insertCharacters({row:a,col:0},c[a])}},changeEachRow:function(b){for(var a=0;a<this.getRowCount();a++){var c=this.getRowArray(a);c=b(c);this.setRowArray(a,c)}},replace:function(f,d){var g=new RegExp(f,"g");for(var a=0;a<this.getRowCount();a++){var b=this.getRowArray(a).join("");var c=b.replace(g,d);if(c!=b){this.rows[a]=c.split("")}}},deleteCharacters:function(a,b){var d=this.getRowArray(a.row);var c=(a.col+b-1)-d.length;if(c>0){b-=c}if(b>0){this.setRowDirty(a.row);this.invalidateSyntaxCache(a.row);return d.splice(a.col,b).join("")}return""},clear:function(){this.rows=[];this.cacheRowMetadata=[]},deleteRows:function(c,a){var b=(c+a-1)-this.rows.length;if(b>0){a-=b}if(a>0){this.rows.splice(c,a);this.cacheRowMetadata.splice(c,a)}},splitRow:function(a,d){this.invalidateSyntaxCache(a.row);this.setRowDirty(a.row);var g=this.getRowArray(a.row);var b;if(d&&d.length>0){b=d}else{b=[]}if(a.col<g.length){b=b.concat(g.splice(a.col))}if(a.row==(this.rows.length-1)){this.rows.push(b)}else{var c=this.rows.splice(0,a.row+1);c.push(b);c=c.concat(this.rows);this.rows=c;var f=this.cacheRowMetadata.splice(0,a.row+1);f.push(undefined);this.cacheRowMetadata=f.concat(this.cacheRowMetadata)}},joinRow:function(d,a){this.invalidateSyntaxCache(d);this.setRowDirty(d);if(d>=this.rows.length-1){return}var c=this.getRowArray(d);var b=this.rows[d+1];if(typeof a!="undefined"){b.splice(0,a)}this.rows[d]=c.concat(b);this.rows.splice(d+1,1);this.cacheRowMetadata.splice(d+1,1)},getRowCount:function(){return this.rows.length},getChunk:function(d){var c=d.startPos;var f=d.endPos;var h,j;var a="";h=c.col;var g=this.getRowArray(c.row);j=(f.row==c.row)?f.col:g.length;if(j>g.length){j=g.length}a+=g.join("").substring(h,j);for(var b=c.row+1;b<f.row;b++){a+="\n";a+=this.getRowArray(b).join("")}if(c.row!=f.row){h=0;j=f.col;g=this.getRowArray(f.row);if(j>g.length){j=g.length}a+="\n"+g.join("").substring(h,j)}return a},deleteChunk:function(c){var a=this.getChunk(c);var b=c.startPos;var d=c.endPos;this.invalidateSyntaxCache(b.row);var g,h;g=b.col;var f=this.getRowArray(b.row);h=(d.row==b.row)?d.col:f.length;if(h>f.length){h=f.length}this.deleteCharacters({row:b.row,col:g},h-g);if(b.row!=d.row){g=0;h=d.col;f=this.getRowArray(d.row);if(h>f.length){h=f.length}this.deleteCharacters({row:d.row,col:g},h-g)}if((d.row-b.row)>1){this.deleteRows(b.row+1,d.row-b.row-1)}if(d.row!=b.row){this.joinRow(b.row)}return a},insertChunk:function(b,d){this.invalidateSyntaxCache(b.row);var c=d.split("\n");var a=th.clone(b);for(var f=0;f<c.length;f++){this.insertCharacters(a,c[f]);a.col=a.col+c[f].length;if(f<c.length-1){this.splitRow(a);a.col=0;a.row=a.row+1}}return a},getRowMetadata:function(n){if(!this.isRowDirty(n)&&this.cacheRowMetadata[n]){return this.cacheRowMetadata[n]}var m={tabExpansions:[]};var h=this.editor.model.getRowArray(n);var i=h.join("");var b=th.Settings.get("tabSize");m.lineTextWithoutTabExpansion=i;m.lineLengthWithoutTabExpansion=h.length;for(var a=0;a<i.length;a++){if(i.charCodeAt(a)==9){var f=b-(a%b);var g="";for(var d=1;d<f;d++){g+=" "}var c=(a==0)?"":i.substring(0,a);var j=(a<i.length-1)?i.substring(a+1):"";i=c+" "+g+j;m.tabExpansions.push({start:c.length,end:c.length+g.length+1});a+=f-1}}m.lineText=i;if(this.editor.searchString){m.searchIndices=this.getStringIndicesInRow(n,this.editor.searchString)}else{m.searchIndices=false}this.cacheRowMetadata[n]=m;return m},invalidateSyntaxCache:function(a){if(typeof this.editor.syntaxModel!="undefined"&&th.isFunction(this.editor.syntaxModel.invalidateCache)){this.editor.syntaxModel.invalidateCache(a)}},getMetaRowString:function(a){return this.getRowMetadata(a).lineText},getMetaRowLength:function(a){return this.getRowMetadata(a).lineText.length}}});th.Editor.Cursor=Class.define({type:"Editor::Cursor",members:{init:function(a){this.model=a.model;this.editor=a;this.position={row:0,col:0};this.virtualCol=0;this.editor.bus.bind("editor:cursor:move",this,this.move,this)},move:function(d){var b=th.clone(this.position);var a=this[d.action](d.args);var c=th.clone(this.position);this.editor.bus.fire("editor:cursor:moved",{oldPos:b,newPos:c},this.editor)},getCursorPosition:function(b){if(b!=undefined){var h=th.clone(b);var c=this.model.getRowArray(h.row);var a=th.Settings.get("tabSize");if(c.indexOf("\t")!=-1){var f=0,g=0;for(var d=0;d<b.col;d++){if(c[d]=="\t"){h.col+=a-1-(g%a);f++;g=0}else{g++;f=0}}}return h}else{return this.position}},getModelPosition:function(h){h=(h!=undefined)?h:this.position;var b=th.clone(h);var c=this.model.getRowArray(h.row);var a=th.Settings.get("tabSize");if(c.indexOf("\t")!=-1){var f=0,g=0;for(var d=0;d<b.col;d++){if(c[d]=="\t"){b.col-=a-1-(g%a);f++;g=0}else{g++;f=0}}}return b},getCharacterLength:function(c,b){if(c.length>1){return}if(b==undefined){b=this.position.col}if(c=="\t"){var a=th.Settings.get("tabSize");return(a-(b%a))}else{return 1}},getStringLength:function(c){if(!c||c.length==0){return 0}var b=0;c=c.split("");for(var a=0;a<c.length;a++){b+=this.getCharacterLength(c[a],b)}return b},getLeadingWhitespace:function(c){var b=this.model.getRowArray(c).join("");var a=/^(\s+).*/.exec(b);return(a&&a.length==2?this.getStringLength(a[1]):0)},getContinuousSpaceCount:function(g,h,d){d=d||this.position.row;var b=th.Settings;var j=this.model.getRowArray(d);var i=(g<h?1:-1);var a=j.length;g=g+(i==1?0:-1);h=h+(i==1?0:-1);g=this.getModelPosition({col:g,row:d}).col;h=this.getModelPosition({col:h,row:d}).col;if(b.isSettingOn("strictlines")){g=Math.min(g,a);h=Math.min(h,a)}var c=0;for(var f=g;f!=h;f+=i){if(f<a){if(j[f]!=" "){break}}c++}return c},getNextTablevelLeft:function(b){var a=th.Settings.get("tabSize");b=b||this.position.col;b--;return Math.floor(b/a)*a},getNextTablevelRight:function(b){var a=th.Settings.get("tabSize");b=b||this.position.col;b++;return Math.ceil(b/a)*a},moveToLineStart:function(){var b=th.clone(this.position);var a=this.getLeadingWhitespace(b.row);if(this.position.col==0){this.moveCursor({col:a})}else{if(this.position.col==a){this.moveCursor({col:0})}else{if(a!=this.model.getMetaRowLength(this.getCursorPosition().row)){this.moveCursor({col:a})}else{this.moveCursor({col:0})}}}return{oldPos:b,newPos:th.clone(this.position)}},moveToLineEnd:function(){var a=th.clone(this.position);this.moveCursor({col:this.model.getMetaRowLength(a.row)});return{oldPos:a,newPos:th.clone(this.position)}},moveToTop:function(){var a=th.clone(this.position);this.moveCursor({row:0,col:0});return{oldPos:a,newPos:th.clone(this.position)}},moveToBottom:function(){var a=th.clone(this.position);var b=this.editor.getRowCount()-1;this.moveCursor({row:b,col:this.model.getMetaRowLength(b)});return{oldPos:a,newPos:th.clone(this.position)}},moveUp:function(){var c=th.Settings;var b=this.editor.getSelection();var a=th.clone(this.position);var d=this.virtualCol;this.moveCursor({row:a.row-1,col:Math.max(a.col,this.virtualCol)});if(c.isSettingOn("strictlines")&&this.position.col>this.model.getMetaRowLength(this.position.row)){this.moveToLineEnd();this.virtualCol=Math.max(a.col,d)}return{oldPos:a,newPos:th.clone(this.position)}},moveDown:function(){var c=th.Settings;var b=this.editor.getSelection();var a=th.clone(this.position);var d=this.virtualCol;this.moveCursor({row:Math.max(0,a.row+1),col:Math.max(a.col,this.virtualCol)});if(c.isSettingOn("strictlines")&&this.position.col>this.model.getMetaRowLength(this.position.row)){this.moveToLineEnd();this.virtualCol=Math.max(a.col,d)}return{oldPos:a,newPos:th.clone(this.position)}},moveLeft:function(d){var g=th.Settings;var b=g.get("tabSize");var c=th.clone(this.position);var f=(d.event?d.event.shiftKey:false);if(!this.editor.getSelection()||f){if(g.isSettingOn("smartmove")){var a=this.getContinuousSpaceCount(c.col,this.getNextTablevelLeft());if(a==b){this.moveCursor({col:c.col-a});return{oldPos:c,newPos:th.clone(this.position)}}}if(g.isSettingOn("strictlines")&&(this.position.col==0)){this.moveUp();if(c.row>0){this.moveToLineEnd()}}else{this.moveCursor({row:c.row,col:Math.max(0,c.col-1)})}}else{this.moveCursor(this.editor.getSelection().startPos)}return{oldPos:c,newPos:th.clone(this.position)}},moveRight:function(d){var g=th.Settings;var b=g.get("tabSize");var c=th.clone(this.position);var f=(d.event?d.event.shiftKey:false);if(!this.editor.getSelection()||f){if(g.isSettingOn("smartmove")&&d!=true){var a=this.getContinuousSpaceCount(c.col,this.getNextTablevelRight());if(a==b){this.moveCursor({col:c.col+a});return{oldPos:c,newPos:th.clone(this.position)}}}if(g.isSettingOn("strictlines")&&(this.position.col>=this.model.getMetaRowLength(this.position.row))){this.moveDown();if(c.row<this.model.getRowCount()-1){this.moveCursor({col:0})}}else{this.moveCursor({col:this.position.col+1})}}else{this.moveCursor(this.editor.getSelection().endPos)}return{oldPos:c,newPos:th.clone(this.position)}},movePageUp:function(){var a=th.clone(this.position);this.moveCursor({row:Math.max(a.row-this.editor.getPageRowCount(),0)});return{oldPos:a,newPos:th.clone(this.position)}},movePageDown:function(){var a=th.clone(this.position);this.moveCursor({row:Math.min(a.row+this.editor.getPageRowCount(),this.editor.model.getRowCount()-1)});return{oldPos:a,newPos:th.clone(this.position)}},smartMoveLeft:function(){var d=th.clone(this.position);var f=this.model.getMetaRowString(d.row);var h,b;if(this.position.col==0){this.moveUp();this.moveToLineEnd()}else{if(f.length<this.position.col){this.moveToLineEnd()}var a=this.position.col;var g=false;while(a>0){a--;h=f.charAt(a);b=h.charCodeAt(0);if(b==32){g=true}else{a++;break}}if(!g){while(a>0){a--;h=f.charAt(a);b=h.charCodeAt(0);if((b<65)||(b>122)){if(a!=this.position.col-1){a++}break}}}this.moveCursor({col:a})}return{oldPos:d,newPos:th.clone(this.position)}},smartMoveRight:function(){var d=th.clone(this.position);var f=this.model.getMetaRowString(d.row);if(f.length<=this.position.col){this.moveDown();this.moveToLineStart()}else{var h,b;var a=this.position.col;var g=false;while(a<f.length){h=f[a];b=h.charCodeAt(0);if(b==32){g=true;a++}else{break}}if(!g){while(a<f.length){a++;if(f.length==a){this.moveToLineEnd();a=-1;break}h=f[a];b=h.charCodeAt(0);if((b<65)||(b>122)){break}}}if(a!=-1){this.moveCursor({col:a})}}return{oldPos:d,newPos:th.clone(this.position)}},moveCursor:function(c){if(!c){return}if(c.col===undefined){c.col=this.position.col}if(c.row===undefined){c.row=this.position.row}this.virtualCol=0;var b=this.position;var d=Math.min(c.row,this.model.getRowCount()-1);if(d<0){d=0}var a=this.isInvalidCursorPosition(d,c.col);if(a){if(b.row!=c.row){c.col=a.right}else{if(b.col<c.col){c.col=a.right}else{if(b.col>c.col){c.col=a.left}else{c.col=a.right}}}}this.position={row:d,col:c.col}},isInvalidCursorPosition:function(j,c){var f=th.Settings;var a=f.get("tabSize");var g=this.model.getRowArray(j);var h=0;for(var d=0;d<g.length;d++){if(g[d].charCodeAt(0)==9){var b=a-(h%a);if((c>h)&&(c<(h+b))){return{left:h,right:h+b,half:b/2}}h+=b-1}h++}return undefined}}});th.Editor.Actions=Class.define({members:{init:function(a){this.editor=a;this.model=a.model;this.cursorManager=a.cursor;this.ignoreRepaints=false},moveCursor:function(b,a){this.editor.bus.fire("editor:cursor:move",{action:b,args:a},this.cursorManager);this.repaint()},moveCursorLeft:function(a){return this.moveCursor("moveLeft",a)},moveCursorRight:function(a){return this.moveCursor("moveRight",a)},moveCursorUp:function(a){return this.moveCursor("moveUp",a)},moveCursorDown:function(a){return this.moveCursor("moveDown",a)},moveToLineStart:function(a){return this.moveCursor("moveToLineStart",a)},moveToLineEnd:function(a){return this.moveCursor("moveToLineEnd",a)},moveToFileTop:function(a){return this.moveCursor("moveToTop",a)},moveToFileBottom:function(a){return this.moveCursor("moveToBottom",a)},movePageUp:function(a){return this.moveCursor("movePageUp",a)},movePageDown:function(a){return this.moveCursor("movePageDown",a)},moveWordLeft:function(a){return this.moveCursor("smartMoveLeft",a)},moveWordRight:function(a){return this.moveCursor("smartMoveRight",a)},backspace:function(c){var d=th.Settings;if(this.editor.readonly){return}if(this.editor.selection){this.deleteSelection(c)}else{if(c.pos.col>0){if(d.isSettingOn("smartmove")){var b=d.get("tabSize");var a=this.cursorManager.getContinuousSpaceCount(c.pos.col,this.cursorManager.getNextTablevelLeft(c.pos.col));if(a==b){var f=c.pos;this.editor.selection={startPos:{row:f.row,col:f.col-b},endPos:{row:f.row,col:f.col}};this.deleteSelection(c);return}}this.editor.bus.fire("editor:cursor:move",{action:"moveCursor",args:{col:Math.max(0,c.pos.col-1)}},this.cursorManager);c.pos.col-=1;this.deleteCharacter(c)}else{c.joinDirection="up";this.joinLine(c)}}},deleteCharacter:function(b){if(this.editor.readonly){return}if(b.pos.col<this.model.getMetaRowLength(b.pos.row)){var a=this.cursorManager.getModelPosition(b.pos);this.editor.bus.fire("editor:model:change",{action:"deleteCharacters",args:[a,1]},this.model);this.repaint()}},deleteSelection:function(b){if(this.editor.readonly||!this.editor.selection){return}var c;if(b.selection){c=b.selection}else{c=this.editor.getSelection()}var a=this.model.getChunk(c);this.editor.bus.fire("editor:model:change",{action:"deleteChunk",args:[c]},this.model);this.editor.setSelection(undefined);this.editor.bus.fire("editor:cursor:move",{action:"moveCursor",args:c.startPos},this.cursorManager);this.repaint();return a},joinLine:function(b){if(this.editor.readonly){return}if(b.joinDirection=="up"){if(b.pos.row==0){return}var a=this.model.getMetaRowLength(b.pos.row-1);this.editor.bus.fire("editor:model:change",{action:"joinRow",args:[b.pos.row-1,b.autoindentSize]},this.model);this.editor.bus.fire("editor:cursor:move",{action:"moveCursor",args:{row:b.pos.row-1,col:a}},this.cursorManager)}else{if(b.pos.row>=this.model.getRowCount()-1){return}this.editor.bus.fire("editor:model:change",{action:"joinRow",args:b.pos.row},this.model)}this.repaint()},deleteKey:function(c){var d=th.Settings;if(this.editor.readonly){return}if(this.editor.selection){this.deleteSelection(c)}else{if(c.pos.col<this.model.getMetaRowLength(c.pos.row)){if(d.isSettingOn("smartmove")){var b=d.get("tabSize");var a=this.cursorManager.getContinuousSpaceCount(c.pos.col,this.cursorManager.getNextTablevelRight(c.pos.col));if(a==b){var f=c.pos;this.editor.selection={startPos:{row:f.row,col:f.col},endPos:{row:f.row,col:f.col+b}};this.deleteSelection(c);return}}this.deleteCharacter(c)}else{c.joinDirection="down";this.joinLine(c)}}},deleteCharacter:function(b){if(this.editor.readonly){return}if(b.pos.col<this.model.getMetaRowLength(b.pos.row)){var a=this.cursorManager.getModelPosition(b.pos);this.editor.bus.fire("editor:model:change",{action:"deleteCharacters",args:[a,1]},this.model);this.repaint()}},newline:function(b){if(this.editor.readonly){return}var f=th.Settings;var g=th.leadingWhitespace(this.model.getRowArray(b.pos.row));var d=0,a=f.get("tabSize");for(var c=0;c<g.length;c++){if(g[c]==" "||g[c]==""||g[c]===undefined){d++}else{if(g[c]=="\t"){d+=a}else{break}}}this.editor.bus.fire("editor:model:change",{action:"splitRow",args:[this.cursorManager.getModelPosition(b.pos),g]},this.model);this.editor.bus.fire("editor:cursor:move",{action:"moveCursor",args:{row:this.cursorManager.getCursorPosition().row+1,col:d}},this.cursorManager);this.repaint()},insertCharacter:function(a){if(this.editor.readonly){return}if(this.editor.selection){this.deleteSelectionAndInsertCharacter(a)}else{this.editor.bus.fire("editor:model:change",{action:"insertCharacters",args:[this.cursorManager.getModelPosition(a.pos),a.newchar]},this.model);this.editor.bus.fire("editor:cursor:move",{action:"moveRight",args:true},this.cursorManager);this.repaint()}},repaint:function(){if(!this.ignoreRepaints){this.editor.adjustScrollTop();this.editor.updateScrollbar();this.editor.repaint()}}}});if(typeof th=="undefined"){th={}}th.Hashtable=(function(){function d(C){return(typeof C==="undefined")}function a(C){return(typeof C==="function")}function n(C){return(typeof C==="string")}function p(D,C){return a(D[C])}function y(C){return p(C,"equals")}function u(C){return p(C,"hashCode")}function A(D){if(n(D)){return D}else{if(u(D)){var C=D.hashCode();if(!n(C)){return A(C)}return C}else{if(p(D,"toString")){return D.toString()}else{return String(D)}}}}function x(C,D){return C.equals(D)}function f(C,D){if(y(D)){return D.equals(C)}else{return C===D}}function b(D,C){return D===C}function s(D,I,F,J,E){var H;for(var G=0,C=D.length;G<C;G++){H=D[G];if(E(I,F(H))){return J?[G,H]:true}}return false}function w(F,E){if(p(F,"splice")){F.splice(E,1)}else{if(E===F.length-1){F.length=E}else{var D=F.slice(E+1);F.length=E;for(var G=0,C=D.length;G<C;G++){F[E+G]=D[G]}}}}function B(D,C){if(D===null){throw new Error("null is not a valid "+C)}else{if(d(D)){throw new Error(C+" must not be undefined")}}}var j="key",c="value";function i(C){B(C,j)}function g(C){B(C,c)}function m(D,E,C){this.entries=[];this.addEntry(D,E);if(C!==null){this.getEqualityFunction=function(){return C}}}function z(C){return C[0]}function o(C){return C[1]}m.prototype={getEqualityFunction:function(C){if(y(C)){return x}else{return f}},searchForEntry:function(C){return s(this.entries,C,z,true,this.getEqualityFunction(C))},getEntryForKey:function(C){return this.searchForEntry(C)[1]},getEntryIndexForKey:function(C){return this.searchForEntry(C)[0]},removeEntryForKey:function(D){var C=this.searchForEntry(D);if(C){w(this.entries,C[0]);return true}return false},addEntry:function(C,D){this.entries[this.entries.length]=[C,D]},size:function(){return this.entries.length},keys:function(E){var F=E.length;for(var D=0,C=this.entries.length;D<C;D++){E[F+D]=this.entries[D][0]}},values:function(D){var F=D.length;for(var E=0,C=this.entries.length;E<C;E++){D[F+E]=this.entries[E][1]}},containsKey:function(C){return s(this.entries,C,z,false,this.getEqualityFunction(C))},containsValue:function(C){return s(this.entries,C,o,false,b)}};function v(){}v.prototype=[];function r(C){return C[0]}function h(E,C,D){return s(E,C,r,true,D)}function t(D,C){var E=D[C];if(E&&(E instanceof v)){return E[1]}return null}function q(E,D){var F=[];var C={};E=a(E)?E:A;D=a(D)?D:null;this.put=function(I,K){i(I);g(K);var G=E(I);var L=t(C,G);if(L){var H=L.getEntryForKey(I);if(H){H[1]=K}else{L.addEntry(I,K)}}else{var J=new v();J[0]=G;J[1]=new m(I,K,D);F[F.length]=J;C[G]=J}};this.get=function(I){i(I);var G=E(I);var J=t(C,G);if(J){var H=J.getEntryForKey(I);if(H){return H[1]}}return null};this.containsKey=function(H){i(H);var G=E(H);var I=t(C,G);if(I){return I.containsKey(H)}return false};this.containsValue=function(I){g(I);for(var H=0,G=F.length;H<G;H++){if(F[H][1].containsValue(I)){return true}}return false};this.clear=function(){F.length=0;C={}};this.isEmpty=function(){return F.length===0};this.keys=function(){var I=[];for(var H=0,G=F.length;H<G;H++){F[H][1].keys(I)}return I};this.values=function(){var H=[];for(var I=0,G=F.length;I<G;I++){F[I][1].values(H)}return H};this.remove=function(I){i(I);var H=E(I);var J=t(C,H);if(J){if(J.removeEntryForKey(I)){if(J.size()===0){var G=h(F,H,J.getEqualityFunction(I));w(F,G[0]);delete C[H]}}}};this.size=function(){var I=0;for(var H=0,G=F.length;H<G;H++){I+=F[H][1].size()}return I}}return q})();th.FirefoxBorder=Class.define({type:"Border",uses:[th.ComponentHelpers,th.BorderHelpers,th.ColorHelpers],members:{SIDES:["top","right","bottom","left"],CORNERS:["top-left","top-right","bottom-right","bottom-left"],TOP:0,TOP_LEFT:0,RIGHT:1,TOP_RIGHT:1,BOTTOM:2,BOTTOM_RIGHT:2,LEFT:3,BOTTOM_LEFT:3,BIT_TOP:1,BIT_RIGHT:2,BIT_BOTTOM:4,BIT_LEFT:8,init:function(a){this.component=a;this.outerRect={x:0,y:0,w:0,h:0};this.innerRect={x:0,y:0,w:0,h:0};this.borderStyles=[];this.borderWidths=[];this.borderRadii=[];this.borderColors=[];this.borderColorsDark=[];this.borderColorsLight=[];this.skipSides=0;this.oneUnitBorder=false;this.noBorderRadius=false;this.cornerDimensions=[];for(var b=0;b<4;b++){this.borderStyles[b]="none";this.borderWidths[b]=0;this.borderColors[b]="black";this.borderColorsDark[b]="black";this.borderColorsLight[b]="black";this.borderRadii[b]={w:0,h:0};this.cornerDimensions[b]={w:0,h:0}}this.borderDataCalculated=false},getInsets:function(){return this.calculateInsets("border-","-width")},recalculateBorderData:function(){var h=this.component.d();var c,b,a;this.backgroundColor=this.getColorString(this.getColorRGB(this.component.cssValue("background-color")));for(var g=0;g<4;g++){var f=this.SIDES[g];c=th.convertBorderLengthToPixels(this.component.cssValue("border-"+f+"-width"));b=this.getColorString(this.getColorRGB(this.component.cssValue("border-"+f+"-color")));a=this.component.cssValue("border-"+f+"-style");this.borderWidths[g]=(c===undefined)?0:c;this.borderColors[g]=b;this.borderColorsDark[g]=this.getColorString(this.getSpecial3DColors(b,this.backgroundColor,"dark"));this.borderColorsLight[g]=this.getColorString(this.getSpecial3DColors(b,this.backgroundColor,"light"));this.borderStyles[g]=(a===undefined)?"none":a}this.outerRect={x:0,y:0,w:h.b.w,h:h.b.h};this.innerRect={x:0,y:0,w:h.b.w,h:h.b.h};this.inset(this.innerRect,this.borderWidths);this.cornerDimensions[0].w=this.borderWidths[3];this.cornerDimensions[0].h=this.borderWidths[0];this.cornerDimensions[1].w=this.borderWidths[1];this.cornerDimensions[1].h=this.borderWidths[0];this.cornerDimensions[2].w=this.borderWidths[1];this.cornerDimensions[2].h=this.borderWidths[2];this.cornerDimensions[3].w=this.borderWidths[3];this.cornerDimensions[3].h=this.borderWidths[2];this.oneUnitBorder=this.checkFourFloatsEqual(this.borderWidths,1);this.noBorderRadius=this.allCornersZeroSize(this.borderRadii);this.borderDataCalculated=true},areBorderSideFinalStylesSame:function(b){if(b==0){throw"th.Border:areBorderSideFinalStyleSame - Invalid side bit-field '0'"}firstStyle=0;for(var a=0;a<4;a++){if(firstStyle==a){if(((1<<a)&b)==0){firstStyle++}continue}if(((1<<a)&b)==0){continue}if(this.borderStyles[firstStyle]!=this.borderStyles[a]||this.borderColors[firstStyle]!=this.borderColors[a]){return false}}switch(this.borderStyles[firstStyle]){case"groove":case"ridge":case"inset":case"outset":return((b&(this.BIT_TOP|this.BIT_LEFT))==0||(b&(this.BIT_BOTTOM|this.BIT_RIGHT))==0)}return true},isSolidCornerStyle:function(b,a){switch(b){case"dotted":case"dashed":case"solid":return true;case"inset":case"outset":return a==this.TOP_LEFT||a==this.BOTTOM_RIGHT;case"groove":case"ridge":return this.oneUnitBorder&&(a==this.TOP_LEFT||a==this.BOTTOM_RIGHT);case"double":return this.oneUnitBorder;default:return false}},borderColorStyleForSolidCorner:function(b,a){switch(b){case"dotted":case"dashed":case"solid":case"double":return"solid";case"inset":case"groove":if(a==this.TOP_LEFT){return"dark"}else{if(a==this.BOTTOM_RIGHT){return"light"}}break;case"outset":case"ridge":if(a==this.TOP_LEFT){return"light"}else{if(a==this.BOTTOM_RIGHT){return"dark"}}break}return"none"},doCornerSubPath:function(a,b){var c={x:0,y:0};if(b==this.TOP_RIGHT||b==this.BOTTOM_RIGHT){c.x=this.outerRect.w-this.cornerDimensions[b].w}if(b==this.BOTTOM_RIGHT||b==this.BOTTOM_LEFT){c.y=this.outerRect.h-this.cornerDimensions[b].h}a.rect(this.outerRect.x+c.x,this.outerRect.y+c.y,this.cornerDimensions[b].w,this.cornerDimensions[b].h)},doSideClipWithoutCornersSubPath:function(b,a){var f={x:0,y:0};var d=this.next(a);if(a==this.TOP){f.x=this.cornerDimensions[this.TOP_LEFT].w}else{if(a==this.RIGHT){f.x=this.outerRect.w-this.borderWidths[this.RIGHT];f.y=this.cornerDimensions[this.TOP_RIGHT].h}else{if(a==this.BOTTOM){f.x=this.cornerDimensions[this.BOTTOM_LEFT].w;f.y=this.outerRect.h-this.borderWidths[this.BOTTOM]}else{if(a==this.LEFT){f.y=this.cornerDimensions[this.TOP_LEFT].h}}}}var g={w:0,h:0};g.w=this.cornerDimensions[a].w+this.cornerDimensions[d].w;g.h=this.cornerDimensions[a].h+this.cornerDimensions[d].h;var c={x:this.outerRect.x+f.x,y:this.outerRect.y+f.y,w:this.outerRect.w-g.w,h:this.outerRect.h-g.h};if(a==this.TOP||a==this.BOTTOM){c.h=this.borderWidths[a]}else{c.w=this.borderWidths[a]}b.rect(c.x,c.y,c.w,c.h)},maybeMoveToMidPoint:function(c,a,d){var b={x:a.x-c.x,y:a.y-c.y};if(b.x!=0&&b.y!=0){k=Math.min((d.x-c.x)/b.x,(d.y-a.y)/b.y);a.x=c.x+b.x*k;a.y=c.y+b.y*k}},doSideClipSubPath:function(q,d){var n=this.corner;var a=[{x:0,y:0},{x:0,y:0}];var b=[{x:0,y:0},{x:0,y:0}];var c=this.prev(d);var m=this.next(d);var r=this.borderStyles[d]=="dashed"||this.borderStyles[d]=="dotted";var p=this.borderStyles[c]=="dashed"||this.borderStyles[c]=="dotted";var i=this.borderStyles[m]=="dashed"||this.borderStyles[m]=="dotted";var g=0;var o=0;if(!this.isZeroSize(this.borderRadii[d])){g=1}else{if(p&&r){g=2}}if(!this.isZeroSize(this.borderRadii[m])){o=1}else{if(p&&r){o=2}}var j={x:0,y:0};j.x=this.innerRect.x+this.innerRect.w/2;j.y=this.innerRect.y+this.innerRect.h/2;var h=this.cornerX,f=this.cornerY;a[0].x=h(this.outerRect,d);a[0].y=f(this.outerRect,d);a[1].x=h(this.innerRect,d);a[1].y=f(this.innerRect,d);b[0].x=h(this.outerRect,m);b[0].y=f(this.outerRect,m);b[1].x=h(this.innerRect,m);b[1].y=f(this.innerRect,m);if(g==1){this.maybeMoveToMidPoint(a[0],a[1],j)}else{if(g==2){if(side=="top"||side=="bottom"){a[1].x=h(this.outerRect,d);a[1].y=f(this.innerRect,d)}else{a[1].x=h(this.innerRect,d);a[1].y=f(this.outerRect,d)}}}if(o==1){this.maybeMoveToMidPoint(b[0],b[1],j)}else{if(o==2){if(side=="top"||side=="bottom"){b[0].x=h(this.innerRect,m);b[0].y=f(this.outerRect,m)}else{b[0].x=h(this.outerRect,m);b[0].y=f(this.innerRect,m)}}}q.moveTo(a[0].x,a[0].y);q.lineTo(b[0].x,b[0].y);q.lineTo(b[1].x,b[1].y);q.lineTo(a[1].x,a[1].y);q.closePath()},fillSolidBorder:function(t,w,x,B,j,A,u){t.fillStyle=u;if(B!==undefined&&!this.allCornersZeroSize(B)){var q=this.computeInnerRadii(B,j);t.beginPath();this.traceRoundRect(t,w,B,true);this.traceRoundRect(t,x,q,false);t.fill();return}if(A==15&&this.checkFourFloatsEqual(j,j[0])){var n=w;var o={x:n.x,y:n.y,w:n.w,h:n.h};this.inset(o,j[0]/2);t.strokeStyle=u;t.lineWidth=j[0];t.beginPath();t.rect(o.x,o.y,o.w,o.h);t.stroke();return}var D,C,a,m;var h,g,i,s;var y,v,z,b;var d,c,f,p;if(A&1){D=w.x;C=w.y;a=w.w;m=j[0]}if(A&4){y=w.x;v=w.y+w.h-j[2];z=w.w;b=j[2]}if(A&8){d=w.x;c=w.y;f=j[3];p=w.h}if(A&2){h=w.x+w.w-j[1];g=w.y;i=j[1];s=w.h}if((A&9)==9){c+=j[0];p-=j[0]}if((A&3)==3){a-=j[1]}if((A&6)==6){s-=j[2]}if((A&12)==12){y+=j[3];z-=j[3]}if(A&1){t.fillRect(D,C,a,m)}if(A&2){t.fillRect(h,g,i,s)}if(A&4){t.fillRect(y,v,z,b)}if(A&8){t.fillRect(d,c,f,p)}},makeBorderColor:function(c,d){var a;var b=0;switch(d){case"none":return"black";case"light":return this.borderColorsLight[c];case"dark":return this.borderColorsDark[c];case"solid":default:return this.borderColors[c]}},computeColorForLine:function(a,f,b,c,d){return this.makeBorderColor(a,f[a])},drawBorderSides:function(j,u){if(u==0){return}var s;var o;var v=[];var t=[];var p=0;var h=[];for(var n=0;n<4;n++){if(((1<<n)&u)==0){continue}s=this.borderStyles[n];o=this.borderColors[n];break}if(s=="none"||s=="hidden"){return}if(this.oneUnitBorder&&(s=="ridge"||s=="groove"||s=="double")){s="solid"}switch(s){case"solid":case"dashed":case"dotted":v[0]="solid";t[0]="solid";p=1;break;case"groove":v[0]="dark";v[1]="light";t[0]="light";t[1]="dark";p=2;break;case"ridge":v[0]="light";v[1]="dark";t[0]="dark";t[1]="light";p=2;break;case"double":v[0]="solid";v[1]="none";v[2]="solid";t[0]="solid";t[1]="none";t[2]="solid";p=3;break;case"inset":v[0]="dark";t[0]="light";p=1;break;case"outset":v[0]="light";t[0]="dark";p=1;break;default:throw"Unhandled style '"+s+"'";break}if(u&(this.BIT_RIGHT|this.BIT_BOTTOM)){h=t}else{h=v}var b=[[],[],[]];if(p==1){for(var n=0;n<4;n++){b[0][n]=this.borderWidths[n]}}else{if(p==2){for(var n=0;n<4;n++){var d=this.borderWidths[n];b[0][n]=parseInt(d/2)+d%2;b[1][n]=parseInt(d/2)}}else{if(p==3){for(var n=0;n<4;n++){var d=this.borderWidths[n];if(d==1){b[0][n]=1;b[1][n]=b[2][n]=0}else{var f=d%3;b[0][n]=b[2][n]=b[1][n]=parseInt((d-f)/3);if(f==1){b[1][n]++}else{if(f==2){b[0][n]++;b[2][n]++}}}}}}}var c=this.outerRect;var q={x:c.x,y:c.y,w:c.w,h:c.h};var a={x:c.x,y:c.y,w:c.w,h:c.h};var g;if(!this.noBorderRadius){g=th.clone(this.borderRadii)}var r;for(var n=0;n<p;n++){r=b[n];this.inset(a,r);if(h[n]!="none"){var m=this.computeColorForLine(n,h,p,o,this.backgroundColor);this.fillSolidBorder(j,q,a,g,r,u,m)}if(!this.noBorderRadius){g=this.computeInnerRadii(g,r)}q.x=a.x;q.y=a.y;q.w=a.w;q.h=a.h}},paint:function(a){if(this.component.cssValue("border-image-url")===undefined){this.paintBorder(a)}else{this.paintImageBorder(a)}},paintImageBorder:function(s){var f=th.global_resources.images[this.component.cssValue("border-image-url")];if(f.width==0){return}var q,n,a,c,p,g,j;q=parseInt(this.component.cssValue("border-image-top"));n=parseInt(this.component.cssValue("border-image-bottom"));a=parseInt(this.component.cssValue("border-image-right"));c=parseInt(this.component.cssValue("border-image-left"));p=f.width;g=f.height;j=this.component.d();bT=th.convertLengthToPixels(this.component.cssValue("border-top-width"));bR=th.convertLengthToPixels(this.component.cssValue("border-right-width"));bB=th.convertLengthToPixels(this.component.cssValue("border-bottom-width"));bL=th.convertLengthToPixels(this.component.cssValue("border-left-width"));s.drawImage(f,0,0,c,q,0,0,bL,bT);s.drawImage(f,p-a,0,a,q,j.b.w-bR,0,bR,bT);s.drawImage(f,0,g-n,c,n,0,j.b.h-bB,bL,bB);s.drawImage(f,p-a,g-n,a,n,j.b.w-bR,j.b.h-bB,bR,bB);switch(this.component.cssValue("border-image-repeat-x")){case"stretch":s.drawImage(f,c,0,p-c-a,q,bL,0,j.b.w-bL-bR,bT);s.drawImage(f,c,g-n,p-c-a,n,bL,j.b.h-bB,j.b.w-bL-bR,bB);break;case"repeat":var i;s.save();s.beginPath();s.rect(bL,0,j.b.w-bL-bR,j.b.h);s.clip();i=c*(bT/q);for(var o=bL;o<j.b.w-bR;o+=i){s.drawImage(f,c,0,p-c-a,q,o,0,i,bT)}i=a*(bB/n);for(var o=bL;o<j.b.w-bR;o+=i){s.drawImage(f,c,g-n,p-c-a,n,o,j.b.h-bB,i,bB)}s.restore();break;default:console.error('border-image-repeat-x "'+this.component.cssValue("border-image-repeat-x")+'" not supported!');break}switch(this.component.cssValue("border-image-repeat-y")){case"stretch":s.drawImage(f,0,q,c,g-q-n,0,bT,bL,j.b.h-bT-bB);s.drawImage(f,p-a,q,a,g-q-n,j.b.w-bR,bT,bR,j.b.h-bT-bB);break;case"repeat":var i;s.save();s.beginPath();s.rect(0,bT,j.b.w,j.b.h-bT-bB);s.clip();i=q*(bL/c);for(var m=bT;m<j.b.h-bB;m+=i){s.drawImage(f,0,q,c,g-q-n,0,m,bL,i)}i=q*(bR/a);for(var m=bT;m<j.b.h-bB;m+=i){s.drawImage(f,p-a,q,a,g-q-n,j.b.w-bR,m,bR,i)}s.restore();break;default:console.error('border-image-repeat-y "'+this.component.cssValue("border-image-repeat-x")+'" not supported!');break}},paintBorder:function(s){var n=this.component.d();var d=this.isZeroSize;this.recalculateBorderData();var h=this.areBorderSideFinalStylesSame(1|8);var r=this.areBorderSideFinalStylesSame(2|4);var c=this.areBorderSideFinalStylesSame(15);if(c&&(this.borderStyles[0]=="none"||this.borderStyles[0]=="hidden")){return}this.round(this.outerRect);this.round(this.innerRect);if(this.emptyRect(this.outerRect)){return}if(c){this.drawBorderSides(s,this.BIT_TOP|this.BIT_RIGHT|this.BIT_BOTTOM|this.BIT_LEFT)}else{for(var p=0;p<4;p++){var f=[p,this.prev(p)];if(!d(this.borderRadii[p])){continue}if(this.borderWidths[f[0]]==1&&this.borderWidths[f[1]]==1){if(p==this.TOP_LEFT||p==this.TOP_RIGHT){this.cornerDimensions[p].w=0}else{this.cornerDimensions[p].h=0}}}for(var p=0;p<4;p++){if(d(this.cornerDimensions[p])){continue}var f=[p,this.prev(p)];var i=(1<<f[0])|(1<<f[1]);var g=this.areBorderSideFinalStylesSame(i);if(g&&d(this.borderRadii[p])&&this.isSolidCornerStyle(this.borderStyles[f[0]],p)){s.beginPath();this.doCornerSubPath(s,p);s.fillStyle=this.makeBorderColor(f[0],this.borderColorStyleForSolidCorner(this.borderStyles[f[0]],p));s.fill();continue}s.save();s.beginPath();this.doCornerSubPath(s,p);s.clip();if(g){this.drawBorderSides(s,i)}else{var o=this.component.getScratchContext();o.canvas.height=n.b.h;o.canvas.width=n.b.w;o.clearRect(0,0,n.b.w,n.b.h);o.globalCompositeOperation="lighter";for(var q=0;q<2;q++){var m=f[q];var a=this.borderStyles[m];o.save();o.beginPath();this.doSideClipSubPath(o,m);o.clip();this.drawBorderSides(o,1<<m);o.restore()}s.globalCompositeOpertation="source-over";s.drawImage(o.canvas,0,0,n.b.w,n.b.h,0,0,n.b.w,n.b.h)}s.restore()}var j=0;if(this.oneUnitBorder&&this.noBorderRadius){if(h){this.drawBorderSides(s,1|8);j|=1|8}if(r){this.drawBorderSides(s,4|2);j|=4|2}}for(var m=0;m<4;m++){if(j&(1<<m)){continue}if(this.borderWidths[m]==0||this.borderStyles[m]=="hidden"||this.borderStyles[m]=="none"){continue}s.save();s.beginPath();this.doSideClipWithoutCornersSubPath(s,m);s.clip();this.drawBorderSides(s,1<<m);s.restore()}}}}});if(typeof th=="undefined"){th={}}if(typeof th.formlayout=="undefined"){th.formlayout={}}th.formlayout.Exception=Class.define({members:{init:function(a){this.message=a},toString:function(){return this.message}}});th.formlayout.IllegalArgumentException=Class.define({superclass:th.formlayout.Exception,members:{init:function(a){this._super(a)}}});th.formlayout.IndexOutOfBoundsException=Class.define({superclass:th.formlayout.Exception,members:{init:function(a){this._super(a)}}});th.formlayout.FormLayoutParseException=Class.define({superclass:th.formlayout.Exception,members:{init:function(a){this._super(a)}}});th.formlayout.Unit=Class.define({members:{init:function(a,d,c,b){this.name=a;this.abbreviation=d;this.parseAbbreviation=c;this.requiresIntegers=b},toString:function(){return this.name},encode:function(){return this.parseAbbreviation||this.abbreviation},abbreviation:function(){return this.abbreviation}}});th.formlayout.Unit.valueOf=function(c,b){if(c.length==0){var a=th.formlayout.Sizes.getDefaultUnit();if(a){return a}return b?th.formlayout.ConstantSize.DIALOG_UNITS_X:th.formlayout.ConstantSize.DIALOG_UNITS_Y}else{if(c=="px"){return th.formlayout.ConstantSize.PIXEL}else{if(c=="dlu"){return b?th.formlayout.ConstantSize.DIALOG_UNITS_X:th.formlayout.ConstantSize.DIALOG_UNITS_Y}else{if(c=="em"){return th.formlayout.ConstantSize.EM}else{if(c=="pt"){return th.formlayout.ConstantSize.POINT}else{if(c=="in"){return th.formlayout.ConstantSize.INCH}else{if(c=="mm"){return th.formlayout.ConstantSize.MILLIMETER}else{if(c=="cm"){return th.formlayout.ConstantSize.CENTIMETER}else{throw"Invalid unit name '"+c+"'. Must be one of: px, dlu, pt, mm, cm, in"}}}}}}}}};th.formlayout.FormLayout=Class.define({members:{init:function(c,b){if(th.isString(c)){c=th.formlayout.ColumnSpec.decodeSpecs(c)}if(th.isString(b)){b=th.formlayout.RowSpec.decodeSpecs(b)}this.colSpecs=c;this.rowSpecs=b;this.colGroupIndices=[];this.rowGroupIndices=[];this.constraintMap=new th.Hashtable();this.componentSizeCache=new th.formlayout.ComponentSizeCache();var a=this;this.minimumWidthMeasure=function(d){return a.componentSizeCache.getMinimumSize(d).width};this.minimumHeightMeasure=function(d){return a.componentSizeCache.getMinimumSize(d).height};this.preferredWidthMeasure=function(d){return a.componentSizeCache.getPreferredSize(d).width};this.preferredHeightMeasure=function(d){return a.componentSizeCache.getPreferredSize(d).height}},getColumnCount:function(){return this.colSpecs.length},getColumnSpec:function(a){return this.colSpecs[a-1]},setColumnSpec:function(b,a){this.colSpecs[b-1]=a},appendColumn:function(a){this.colSpecs.push(a)},insertColumn:function(b,a){if(b<1||b>this.getColumnCount()){throw"The column index "+b+"must be in the range [1, "+this.getColumnCount()+"]."}this.colSpecs[b-1]=a;this.shiftComponentsHorizontally(b,false);this.adjustGroupIndices(this.colGroupIndices,b,false)},removeColumn:function(a){if(a<1||a>this.getColumnCount()){throw"The column index "+a+" must be in the range [1, "+this.getColumnCount()+"]."}this.colSpecs.remove(a-1);this.shiftComponentsHorizontally(a,true);this.adjustGroupIndices(this.colGroupIndices,a,true)},getRowCount:function(){return this.rowSpecs.length},getRowSpec:function(a){return this.rowSpecs[a-1]},setRowSpec:function(b,a){this.rowSpecs[b-1]=a},appendRow:function(a){this.rowSpecs.push(a)},insertRow:function(b,a){if(b<1||b>this.getRowCount()){throw"The row index "+b+" must be in the range [1, "+this.getRowCount()+"]."}this.rowSpecs.add(b-1,a);this.shiftComponentsVertically(b,false);this.adjustGroupIndices(this.rowGroupIndices,b,false)},removeRow:function(a){if(a<1||a>this.getRowCount()){throw"The row index "+a+"must be in the range [1, "+this.getRowCount()+"]."}this.rowSpecs.remove(a-1);this.shiftComponentsVertically(a,true);this.adjustGroupIndices(this.rowGroupIndices,a,true)},shiftComponentsHorizontally:function(b,a){var d=a?-1:1;var c=this.constraintMap.keys();th.forEach(c,function(i){var j=this.constraintMap.get(i);var h=j.gridX;var f=j.gridWidth;var g=h+f-1;if(h==b&&a){throw"The removed column "+b+" must not contain component origins.\nIllegal component="+i}else{if(h>=b){j.gridX+=d}else{if(g>=b){j.gridWidth+=d}}}})},shiftComponentsVertically:function(d,a){var c=a?-1:1;var b=this.constraintMap.keys();th.forEach(b,function(g){var m=this.constraintMap.get(g);var j=m.gridY;var i=m.gridHeight;var f=j+i-1;if(j==d&&a){throw"The removed row "+d+" must not contain component origins.\nIllegal component="+g}else{if(j>=d){m.gridY+=c}else{if(f>=d){m.gridHeight+=c}}}})},adjustGroupIndices:function(f,b,a){var j=a?-1:+1;for(var g=0;g<f.length;g++){var h=f[g];for(var d=0;d<h.length;d++){var c=h[d];if(c==b&&a){throw"The removed index "+b+" must not be grouped."}else{if(c>=b){h[d]+=j}}}}},getConstraints:function(a){return this.constraintMap.get(a)},setConstraints:function(a,b){b.ensureValidGridBounds(this.getColumnCount(),this.getRowCount());this.constraintMap.put(a,b)},removeConstraints:function(a){this.constraintMap.remove(a);this.componentSizeCache.removeEntry(a)},getColumnGroups:function(){return this.colGroupIndices},setColumnGroups:function(f){var a=this.getColumnCount();var g=[];for(var d=0;d<this.colGroupIndices.length;d++){for(var c=0;c<this.colGroupIndices[d].length;c++){var b=this.colGroupIndices[d][c];if(b<1||b>a){throw"Invalid column group index "+b+" in group "+(d+1)}if(g[b]){throw"Column index "+b+" must not be used in multiple column groups."}g[b]=true}}this.colGroupIndices=f},addGroupedColumn:function(g){var d=this.getColumnGroups();if(d.length==0){d=[0][g]}else{var c=d.length-1;var f=d[c];var a=f.length;var b=f.slice(0,a);b[a]=g;d[c]=b}this.setColumnGroups(d)},getRowGroups:function(){return this.rowGroupIndices},setRowGroups:function(d){var a=this.getRowCount();var g=[];for(var c=0;c<this.rowGroupIndices.length;c++){for(var b=0;b<this.rowGroupIndices[c].length;b++){var f=this.rowGroupIndices[c][b];if(f<1||f>a){throw"Invalid row group index "+f+" in group "+(c+1)}if(g[f]){throw"Row index "+f+" must not be used in multiple row groups."}g[f]=true}}this.rowGroupIndices=d},addGroupedRow:function(g){var d=this.getRowGroups();if(d.length==0){d=[0][g]}else{var c=d.length-1;var f=d[c];var a=f.length;var b=f.slice(0,a);b[a]=g;d[c]=b}this.setRowGroups(d)},getHonorsVisibility:function(){return this.honorsVisibility},setHonorsVisibility:function(a){var g=this.getHonorsVisibility();if(g==a){return}this.honorsVisibility=a;var f=this.constraintMap.keys();if(f.length==0){return}var d=f[0];var c=d.parent;if(c){c.render()}},setHonorsVisibilityForComponent:function(c,a){var d=this.getConstraints(c);if(a==d.honorsVisibility){return}d.honorsVisibility=a;if(c.parent){c.parent.render()}},addLayoutComponent:function(a,b){if(th.isString(b)){this.setConstraints(a,new th.formlayout.CellConstraints(b))}else{this.setConstraints(a,b)}},removeLayoutComponent:function(a){this.removeConstraints(a)},getMinimumSize:function(a){return this.computeLayoutSize(a,this.minimumWidthMeasure,this.minimumHeightMeasure)},getPreferredSize:function(a){return this.computeLayoutSize(a,this.preferredWidthMeasure,this.preferredHeightMeasure)},getMaximumSize:function(a){return{width:1000000,height:1000000}},invalidateLayout:function(a){this.invalidateCaches()},layout:function(g){this.initializeColAndRowComponentLists();var f=g.getSize();var c=g.getInsets();var b=f.width-c.left-c.right;var d=f.height-c.top-c.bottom;var a=this.computeGridOrigins(g,b,c.left,this.colSpecs,this.colComponents,this.colGroupIndices,this.minimumWidthMeasure,this.preferredWidthMeasure);var h=this.computeGridOrigins(g,d,c.top,this.rowSpecs,this.rowComponents,this.rowGroupIndices,this.minimumHeightMeasure,this.preferredHeightMeasure);this.layoutComponents(a,h)},initializeColAndRowComponentLists:function(){this.colComponents=[];for(var a=0;a<this.getColumnCount();a++){this.colComponents[a]=[]}this.rowComponents=[];for(var a=0;a<this.getRowCount();a++){this.rowComponents[a]=[]}var b=this.constraintMap.keys();th.forEach(b,function(c){var d=this.constraintMap.get(c);if(this.takeIntoAccount(c,d)){if(d.gridWidth==1){this.colComponents[d.gridX-1].push(c)}if(d.gridHeight==1){this.rowComponents[d.gridY-1].push(c)}}},this)},computeLayoutSize:function(g,d,v){this.initializeColAndRowComponentLists();var w=this.maximumSizes(g,this.colSpecs,this.colComponents,this.minimumWidthMeasure,this.preferredWidthMeasure,d);var u=this.maximumSizes(g,this.rowSpecs,this.rowComponents,this.minimumHeightMeasure,this.preferredHeightMeasure,v);var q=this.groupedSizes(this.colGroupIndices,w);var n=this.groupedSizes(this.rowGroupIndices,u);var a=this.computeOrigins(q,0);var h=this.computeOrigins(n,0);var t=this.sum(q);var f=this.sum(n);var s=t;var p=f;var b=this.computeMaximumFixedSpanTable(this.colSpecs);var c=this.computeMaximumFixedSpanTable(this.rowSpecs);var i=this.constraintMap.keys();var m=this;th.forEach(i,function(F){var C=m.constraintMap.get(F);if(!m.takeIntoAccount(F,C)){return}if((C.gridWidth>1)&&(C.gridWidth>b[C.gridX-1])){var D=d(F);var B=C.gridX-1;var A=B+C.gridWidth;var E=a[B];var x=t-a[A];var z=E+D+x;if(z>s){s=z}}if((C.gridHeight>1)&&(C.gridHeight>c[C.gridY-1])){var I=v(F);var H=C.gridY-1;var G=H+C.gridHeight;var E=h[H];var x=f-h[G];var y=E+I+x;if(y>p){p=y}}});var r=g.getInsets();var o=s+r.left+r.right;var j=p+r.top+r.bottom;return{width:o,height:j}},computeGridOrigins:function(j,n,f,m,d,i,q,g){var u=this.maximumSizes(j,m,d,q,g,q);var b=this.maximumSizes(j,m,d,q,g,g);var r=this.groupedSizes(i,u);var t=this.groupedSizes(i,b);var s=this.sum(r);var p=this.sum(t);var h=this.compressedSizes(m,n,s,p,r,b);var o=this.groupedSizes(i,h);var c=this.sum(o);var a=this.distributedSizes(m,n,c,o);return this.computeOrigins(a,f)},computeOrigins:function(c,f){var b=c.length;var d=[];d[0]=f;for(var a=1;a<=b;a++){d[a]=d[a-1]+c[a-1]}return d},layoutComponents:function(a,c){var b=this.constraintMap.keys();th.forEach(b,function(f){var h={};var m=this.constraintMap.get(f);var d=m.gridX-1;var j=m.gridY-1;var i=m.gridWidth;var g=m.gridHeight;h.x=a[d];h.y=c[j];h.width=a[d+i]-h.x;h.height=c[j+g]-h.y;m.setBounds(f,this,h,this.minimumWidthMeasure,this.minimumHeightMeasure,this.preferredWidthMeasure,this.preferredHeightMeasure)},this)},invalidateCaches:function(){this.componentSizeCache.invalidate()},maximumSizes:function(a,f,h,b,g,d){var m=f.length;var n=[];for(var c=0;c<m;c++){var j=f[c];n[c]=j.maximumSize(a,h[c],b,g,d)}return n},compressedSizes:function(d,m,g,j,p,n){if(m<g){return p}if(m>=j){return n}var f=d.length;var q=[];var a=j-m;var o=j-g;var b=a/o;for(var c=0;c<f;c++){var h=d[c];q[c]=n[c];if(h.getSize().compressible()){q[c]-=Math.round((n[c]-p[c])*b)}}return q},groupedSizes:function(a,f){if(!a||a.length==0){return f}var d=[];for(var c=0;c<d.length;c++){d[c]=f[c]}for(var g=0;g<a.length;g++){var h=a[g];var j=0;for(var c=0;c<h.length;c++){var b=h[c]-1;j=Math.max(j,d[b])}for(var c=0;c<h.length;c++){var b=h[c]-1;d[b]=j}}return d},distributedSizes:function(j,s,r,d){var t=s-r;if(t<0){return d}var n=j.length;var c=0;for(var f=0;f<n;f++){var o=j[f];c+=o.getResizeWeight()}if(c==0){return d}var u=[];var b=t;var q=parseInt(t);for(var f=0;f<n;f++){var o=j[f];var h=o.getResizeWeight();if(h==th.formlayout.FormSpec.NO_GROW){u[f]=d[f]}else{var m=b-q;var a=t*h/c;var g=a-m;var p=Math.round(g);u[f]=d[f]+p;b-=a;q-=p}}return u},computeMaximumFixedSpanTable:function(g){var c=g.length;var d=[];var f=1000000;for(var b=c-1;b>=0;b--){var a=g[b];if(a.canGrow()){f=0}d[b]=f;if(f<1000000){f++}}return d},sum:function(c){var b=0;for(var a=c.length-1;a>=0;a--){b+=c[a]}return b},takeIntoAccount:function(a,b){return a.cssValue("visibility")!="hidden"||((!b.honorsVisibility)&&!this.getHonorsVisibility())||!b.honorsVisibility},getLayoutInfo:function(g){this.initializeColAndRowComponentLists();var f=g.getSize();var c=g.getInsets();var b=f.width-c.left-c.right;var d=f.height-c.top-c.bottom;var a=this.computeGridOrigins(g,b,c.left,this.colSpecs,this.colComponents,this.colGroupIndices,this.minimumWidthMeasure,this.preferredWidthMeasure);var h=this.computeGridOrigins(g,d,c.top,this.rowSpecs,this.rowComponents,this.rowGroupIndices,this.minimumHeightMeasure,this.preferredHeightMeasure);return new th.formlayout.LayoutInfo(a,h)}}});th.formlayout.LayoutInfo=Class.define({members:{init:function(b,a){this.columnOrigins=b;this.rowOrigins=a},getX:function(){return this.columnOrigins[0]},getY:function(){return this.rowOrigins[0]},getWidth:function(){return this.columnOrigins[this.columnOrigins.length-1]-this.columnOrigins[0]},getHeight:function(){return this.rowOrigins[this.rowOrigins.length-1]-this.rowOrigins[0]}}});th.formlayout.ComponentSizeCache=Class.define({members:{init:function(){this.minimumSizes=new th.Hashtable();this.preferredSizes=new th.Hashtable()},invalidate:function(){this.minimumSizes.clear();this.preferredSizes.clear()},getSize:function(a,d,c){var b=d.get(a);if(!b){b=a[c]();d.put(a,b)}return b},getMinimumSize:function(a){return this.getSize(a,this.minimumSizes,"getMinimumSize")},getPreferredSize:function(a){return this.getSize(a,this.preferredSizes,"getPreferredSize")},removeEntry:function(a){this.minimumSizes.remove(a);this.preferredSizes.remove(a)}}});th.formlayout.FormSpec=Class.define({members:{NO_GROW:0,DEFAULT_GROW:1,spacer:false,init:function(c,a,b){this.defaultAlignment=c;this.size=a;this.resizeWeight=b||0},isSpacer:function(){return this.spacer},getDefaultAlignment:function(){return this.defaultAlignment},getSize:function(){return this.size},getResizeWeight:function(){return this.resizeWeight},canGrow:function(){return this.resizeWeight!=this.NO_GROW},isHorizontal:function(){throw"This needs to be overridden."},setDefaultAlignment:function(a){this.defaultAlignment=a},setSize:function(a){this.size=a},setResizeWeight:function(a){this.resizeWeight=a},maximumSize:function(b,d,a,f,c){return this.size.maximumSize(b,d,a,f,c)},parseAndInitValues:function(d){if(d.indexOf("spacer(")==0){d=d.substring("spacer(".length,d.length-1);this.spacer=true}var b=d.split(":");if(b.length==0){throw new th.formlayout.IllegalArgumentException("The form spec must not be empty.")}var a=0;var c=b[a++];var f=th.formlayout.DefaultAlignment.valueOf(c,this.isHorizontal());if(f){this.setDefaultAlignment(f);if(b.length==1){throw new th.formlayout.IllegalArgumentException("The form spec must provide a size.")}c=b[a++]}this.setSize(this.parseSize(c));if(a<b.length){this.setResizeWeight(this.parseResizeWeight(b[a]))}},parseSize:function(a){if(a.indexOf("[")==0&&a.indexOf("]")==a.length-1){return this.parseBoundedSize(a)}if(a.indexOf("max(")==0&&a.indexOf(")")==a.length-1){return this.parseOldBoundedSize(a,false)}if(a.indexOf("min(")==0&&a.indexOf(")")==a.length-1){return this.parseOldBoundedSize(a,true)}return this.parseAtomicSize(a)},parseBoundedSize:function(b){var g=b.substring(1,b.length-1);var i=g.split(/\s*,\s*/);var h=undefined;var a=undefined;var d=undefined;if(i.length==2){var f=this.parseAtomicSize(i[0]);var c=this.parseAtomicSize(i[1]);if(this.isConstant(f)){if(this.isConstant(c)){a=f;h=c;d=c}else{a=f;h=c}}else{h=f;d=c}}else{if(i.length==3){a=this.parseAtomicSize(i[0]);h=this.parseAtomicSize(i[1]);d=this.parseAtomicSize(i[2])}}if(((a==null)||(this.isConstant(a)))&&((d==null)||(this.isConstant(d)))){return new th.formlayout.BoundedSize(h,a,d)}throw new th.formlayout.IllegalArgumentException("Illegal bounded size '"+b+"'. Must be one of:\n[<constant size>,<logical size>]                 // lower bound\n[<logical size>,<constant size>]                 // upper bound\n[<constant size>,<logical size>,<constant size>] // lower and upper bound.\nExamples:\n[50dlu,pref]                                     // lower bound\n[pref,200dlu]                                    // upper bound\n[50dlu,pref,200dlu]                              // lower and upper bound.")},parseAtomicSize:function(c){var a=th.trim(c);if(a.indexOf("'")==0&&a.indexOf("'")==a.length-1){var d=a.length;if(d<2){throw new th.formlayout.IllegalArgumentException('Missing closing "\'" for prototype.')}return new th.formlayout.PrototypeSize(a.substring(1,d-1))}var b=th.formlayout.ComponentSize.valueOf(a);if(b!=null){return b}return th.formlayout.ConstantSize.valueOf(a,this.isHorizontal())},parseResizeWeight:function(b){if(b=="g"||b=="grow"){return th.formlayout.FormSpec.DEFAULT_GROW}if(b=="n"||b=="nogrow"||b=="none"){return th.formlayout.FormSpec.NO_GROW}if((b.indexOf("grow(")==0||b.indexOf("g(")==0)&&b.indexOf(")")==b.length-1){var c=b.indexOf("(");var d=b.indexOf(")");var a=b.substring(c+1,d);return parseFloat(a)}throw new th.formlayout.IllegalArgumentException("The resize argument '"+b+"' is invalid.  Must be one of: grow, g, none, n, grow(<double>), g(<double>)")},isConstant:function(a){return(a instanceof th.formlayout.ConstantSize)||(a instanceof th.formlayout.PrototypeSize)},toString:function(){buffer=this.defaultAlignment;buffer+=":";buffer+=this.size.toString();buffer+=":";if(this.resizeWeight==th.formlayout.FormSpec.NO_GROW){buffer+="noGrow"}else{if(this.resizeWeight==th.formlayout.FormSpec.DEFAULT_GROW){buffer+="grow"}else{buffer+="grow(";buffer+=this.resizeWeight;buffer+=")"}}return buffer},toShortString:function(){buffer=this.defaultAlignment.abbreviation();buffer+=":";buffer+=this.size.toString();buffer+=":";if(this.resizeWeight==th.formlayout.FormSpec.NO_GROW){buffer+="n"}else{if(this.resizeWeight==th.formlayout.FormSpec.DEFAULT_GROW){buffer+="g"}else{buffer+="g(";buffer+=this.resizeWeight;buffer+=")"}}return buffer},encode:function(){var a="";var b=this.isHorizontal()?th.formlayout.ColumnSpec.DEFAULT:th.formlayout.RowSpec.DEFAULT;if(!b.equals(this.defaultAlignment)){a+=this.defaultAlignment.abbreviation();a+=":"}a+=this.size.encode();if(this.resizeWeight==th.formlayout.FormSpec.NO_GROW){}else{if(this.resizeWeight==th.formlayout.FormSpec.DEFAULT_GROW){a+=":";a+="g"}else{a+=":";a+="g(";a+=this.resizeWeight;a+=")"}}return a}}});th.formlayout.DefaultAlignment=Class.define({members:{init:function(a){this.name=a},toString:function(){return this.name},abbreviation:function(){return this.name.charAt(0)}}});th.formlayout.DefaultAlignment.valueOf=function(b,a){if(b=="f"||b=="fill"){return th.formlayout.FormSpec.FILL_ALIGN}else{if(b=="c"||b=="center"){return th.formlayout.FormSpec.CENTER_ALIGN}else{if(a){if(b=="r"||b=="right"){return th.formlayout.FormSpec.RIGHT_ALIGN}else{if(b=="l"||b=="left"){return th.formlayout.FormSpec.LEFT_ALIGN}else{return}}}else{if(b=="t"||b=="top"){return th.formlayout.FormSpec.TOP_ALIGN}else{if(b=="b"||b=="bottom"){return th.formlayout.FormSpec.BOTTOM_ALIGN}else{return}}}}}};th.formlayout.FormSpec.LEFT_ALIGN=new th.formlayout.DefaultAlignment("left");th.formlayout.FormSpec.RIGHT_ALIGN=new th.formlayout.DefaultAlignment("right");th.formlayout.FormSpec.TOP_ALIGN=new th.formlayout.DefaultAlignment("top");th.formlayout.FormSpec.BOTTOM_ALIGN=new th.formlayout.DefaultAlignment("bottom");th.formlayout.FormSpec.CENTER_ALIGN=new th.formlayout.DefaultAlignment("center");th.formlayout.FormSpec.FILL_ALIGN=new th.formlayout.DefaultAlignment("fill");th.formlayout.ColumnSpec=Class.define({superclass:th.formlayout.FormSpec,members:{init:function(c,a,b){this._super(c,a,b)},isHorizontal:function(){return true}}});th.formlayout.ColumnSpec.decode=function(a,d){var c=th.trim(a);var b=c.toLowerCase();return th.formlayout.ColumnSpec.decodeExpanded(b)};th.formlayout.ColumnSpec.decodeExpanded=function(b){var a=th.formlayout.ColumnSpec.CACHE.get(b);if(!a){a=new th.formlayout.ColumnSpec(th.formlayout.ColumnSpec.DEFAULT,th.formlayout.Sizes.DEFAULT,th.formlayout.FormSpec.NO_GROW);a.parseAndInitValues(b);th.formlayout.ColumnSpec.CACHE.put(b,a)}return a};th.formlayout.ColumnSpec.decodeSpecs=function(a,b){return th.formlayout.FormSpecParser.parseColumnSpecs(a,b)};th.formlayout.ColumnSpec.createGap=function(a){return new th.formlayout.RowSpec(th.formlayout.ColumnSpec.DEFAULT,a,th.formlayout.ColumnSpec.NO_GROW)};th.formlayout.ColumnSpec.LEFT=th.formlayout.FormSpec.LEFT_ALIGN;th.formlayout.ColumnSpec.CENTER=th.formlayout.FormSpec.CENTER_ALIGN;th.formlayout.ColumnSpec.MIDDLE=th.formlayout.ColumnSpec.CENTER;th.formlayout.ColumnSpec.RIGHT=th.formlayout.FormSpec.RIGHT_ALIGN;th.formlayout.ColumnSpec.FILL=th.formlayout.FormSpec.FILL_ALIGN;th.formlayout.ColumnSpec.DEFAULT=th.formlayout.ColumnSpec.FILL;th.formlayout.ColumnSpec.CACHE=new th.Hashtable();th.formlayout.RowSpec=Class.define({superclass:th.formlayout.FormSpec,members:{init:function(c,a,b){this._super(c,a,b)},isHorizontal:function(){return false}}});th.formlayout.RowSpec.decode=function(b,d){var c=th.trim(b);var a=c.toLowerCase();return th.formlayout.RowSpec.decodeExpanded(a)};th.formlayout.RowSpec.decodeExpanded=function(b){var a=th.formlayout.RowSpec.CACHE.get(b);if(!a){a=new th.formlayout.RowSpec(th.formlayout.RowSpec.DEFAULT,th.formlayout.Sizes.DEFAULT,th.formlayout.FormSpec.NO_GROW);a.parseAndInitValues(b);th.formlayout.RowSpec.CACHE.put(b,a)}return a};th.formlayout.RowSpec.decodeSpecs=function(a,b){return th.formlayout.FormSpecParser.parseRowSpecs(a,b)};th.formlayout.RowSpec.createGap=function(a){return new th.formlayout.RowSpec(th.formlayout.RowSpec.DEFAULT,a,th.formlayout.RowSpec.NO_GROW)};th.formlayout.RowSpec.TOP=th.formlayout.FormSpec.TOP_ALIGN;th.formlayout.RowSpec.CENTER=th.formlayout.FormSpec.CENTER_ALIGN;th.formlayout.RowSpec.BOTTOM=th.formlayout.FormSpec.BOTTOM_ALIGN;th.formlayout.RowSpec.FILL=th.formlayout.FormSpec.FILL_ALIGN;th.formlayout.RowSpec.DEFAULT=th.formlayout.RowSpec.CENTER;th.formlayout.RowSpec.CACHE=new th.Hashtable();th.formlayout.BoundedSize=Class.define({members:{init:function(b,c,a){this.basis=b;this.lowerBound=c;this.upperBound=a},getBasis:function(){return this.basis},getLowerBound:function(){return this.lowerBound},getUpperBound:function(){return this.upperBound},maximumSize:function(b,f,a,g,c){var d=this.basis.maximumSize(b,f,a,g,c);if(this.lowerBound){d=Math.max(d,this.lowerBound.maximumSize(b,f,a,g,c))}if(this.upperBound){d=Math.min(d,this.upperBound.maximumSize(b,f,a,g,c))}return d},compressible:function(){return this.basis.compressible()},equals:function(a){if(this===a){return true}var b=a;return this.basis.equals(b.basis)&&((this.lowerBound==null&&b.lowerBound==null)||(this.lowerBound!=null&&this.lowerBound.equals(b.lowerBound)))&&((this.upperBound==null&&b.upperBound==null)||(this.upperBound!=null&&this.upperBound.equals(b.upperBound)))},hashCode:function(){var a=this.basis.hashCode();if(this.lowerBound){a=a*37+this.lowerBound.hashCode()}if(this.upperBound){a=a*37+this.upperBound.hashCode()}return a}}});th.formlayout.ConstantSize=Class.define({members:{init:function(b,a){this.value=b;this.unit=a},getValue:function(){return this.value},getUnit:function(){return this.unit},getPixelSize:function(a){if(this.unit==th.formlayout.ConstantSize.PIXEL){return this.intValue()}else{if(this.unit==th.formlayout.ConstantSize.EM){return th.formlayout.Sizes.emAsPixel(this.value,a)}else{if(this.unit==th.formlayout.ConstantSize.POINT){return th.formlayout.Sizes.pointAsPixel(this.intValue(),a)}else{if(this.unit==th.formlayout.ConstantSize.INCH){return th.formlayout.Sizes.inchAsPixel(this.value,a)}else{if(this.unit==th.formlayout.ConstantSize.MILLIMETER){return th.formlayout.Sizes.millimeterAsPixel(this.value,a)}else{if(this.unit==th.formlayout.ConstantSize.CENTIMETER){return th.formlayout.Sizes.centimeterAsPixel(this.value,a)}else{if(this.unit==th.formlayout.ConstantSize.DIALOG_UNITS_X){return th.formlayout.Sizes.dialogUnitXAsPixel(this.intValue(),a)}else{if(this.unit==th.formlayout.ConstantSize.DIALOG_UNITS_Y){return th.formlayout.Sizes.dialogUnitYAsPixel(this.intValue(),a)}else{throw"Invalid unit "+this.unit}}}}}}}}},maximumSize:function(b,d,a,f,c){return this.getPixelSize(b)},compressible:function(){return false},equals:function(b){if(this==b){return true}if(!(b instanceof th.formlayout.ConstantSize)){return false}var a=b;return this.value==a.value&&this.unit==a.unit},hashCode:function(){return this.value+37*this.unit.hashCode()},toString:function(){return this.value+unit.abbreviation()},encode:function(){return this.value+unit.encode()},intValue:function(){return Math.round(this.value)}}});th.formlayout.ConstantSize.valueOf=function(h,a){var d=th.formlayout.ConstantSize.splitValueAndUnit(h);var c=d[0];var b=d[1];var f=th.formlayout.Unit.valueOf(b,a);var g=parseFloat(c);if(f.requiresIntegers){if(g!=parseInt(g)){throw f.toString()+" value "+c+" must be an integer."}}return new th.formlayout.ConstantSize(g,f)};th.formlayout.ConstantSize.dluX=function(a){return new th.formlayout.ConstantSize(a,th.formlayout.ConstantSize.DLUX)};th.formlayout.ConstantSize.dluY=function(a){return new th.formlayout.ConstantSize(a,th.formlayout.ConstantSize.DLUY)};th.formlayout.ConstantSize.splitValueAndUnit=function(d){var b=[];var a=d.length;var c=a;while(c>0&&(!/[^a-zA-Z]/.test(d.charAt(c-1)))){c--}b[0]=d.substring(0,c);b[1]=d.substring(c);return b};th.formlayout.ConstantSize.PIXEL=new th.formlayout.Unit("Pixel","px",undefined,true);th.formlayout.ConstantSize.EM=new th.formlayout.Unit("Em","em",undefined,false);th.formlayout.ConstantSize.POINT=new th.formlayout.Unit("Point","pt",undefined,false);th.formlayout.ConstantSize.DIALOG_UNITS_X=new th.formlayout.Unit("Dialog units X","dluX","dlu",true);th.formlayout.ConstantSize.DIALOG_UNITS_Y=new th.formlayout.Unit("Dialog units Y","dluY","dlu",true);th.formlayout.ConstantSize.MILLIMETER=new th.formlayout.Unit("Millimeter","mm",undefined,false);th.formlayout.ConstantSize.CENTIMETER=new th.formlayout.Unit("Centimeter","cm",undefined,false);th.formlayout.ConstantSize.INCH=new th.formlayout.Unit("Inch","in",undefined,false);th.formlayout.ConstantSize.PX=th.formlayout.ConstantSize.PIXEL;th.formlayout.ConstantSize.PT=th.formlayout.ConstantSize.POINT;th.formlayout.ConstantSize.DLUX=th.formlayout.ConstantSize.DIALOG_UNITS_X;th.formlayout.ConstantSize.DLUY=th.formlayout.ConstantSize.DIALOG_UNITS_Y;th.formlayout.ConstantSize.MM=th.formlayout.ConstantSize.MILLIMETER;th.formlayout.ConstantSize.CM=th.formlayout.ConstantSize.CENTIMETER;th.formlayout.ConstantSize.IN=th.formlayout.ConstantSize.INCH;th.formlayout.PrototypeSize=Class.define({members:{init:function(a){this.proto=a},getPrototype:function(){return this.proto},maximumSize:function(b,d,a,f,c){throw"PrototypeSize.maximumSize() not yet implemented"},compressible:function(){return false},encode:function(){return"'"+this.proto+"'"},equals:function(a){if(this==a){return true}if(!(a instanceof th.formlayout.PrototypeSize)){return false}return this.proto==a.proto},toString:function(){return this.encode()}}});th.formlayout.ComponentSize=Class.define({members:{init:function(a){this.name=a},maximumSize:function(b,m,d,j,h){var a=this==th.formlayout.Sizes.MINIMUM?d:(this==th.formlayout.Sizes.PREFERRED?j:h);var f=0;for(var g=0;g<m.length;g++){var n=m[g];f=Math.max(f,a(n))}return f},compressible:function(){return this==th.formlayout.Sizes.DEFAULT},toString:function(){return this.encode()},encode:function(){return name.substring(0,1)}}});th.formlayout.ComponentSize.valueOf=function(a){if(a=="m"||a=="min"){return th.formlayout.Sizes.MINIMUM}if(a=="p"||a=="pref"){return th.formlayout.Sizes.PREFERRED}if(a=="d"||a=="default"){return th.formlayout.Sizes.DEFAULT}return};th.formlayout.DefaultUnitConverter=Class.define({members:{inchAsPixel:function(b,a){return th.convertAbsoluteUnitToPixels("in",b)},millimeterAsPixel:function(b,a){return th.convertAbsoluteUnitToPixels("mm",b)},centimeterAsPixel:function(a,b){return th.convertAbsoluteUnitToPixels("cm",a)},pointAsPixel:function(b,a){return th.convertAbsoluteUnitToPixels("pt",b)},emAsPixel:function(b,a){return th.convertEmToPixels(a.cssValue("font"),b)},dialogUnitXAsPixel:function(b,a){throw"Unsupported"},dialogUnitYAsPixel:function(b,a){throw"Unsupported"}}});th.formlayout.Sizes={};th.formlayout.Sizes.unitConverter=new th.formlayout.DefaultUnitConverter();th.formlayout.Sizes.pixel=function(a){return new th.formlayout.ConstantSize(a,th.formlayout.ConstantSize.PIXEL)};th.formlayout.Sizes.ZERO=th.formlayout.Sizes.pixel(0);th.formlayout.Sizes.DLUX1=th.formlayout.ConstantSize.dluX(1);th.formlayout.Sizes.DLUX2=th.formlayout.ConstantSize.dluX(2);th.formlayout.Sizes.DLUX3=th.formlayout.ConstantSize.dluX(3);th.formlayout.Sizes.DLUX4=th.formlayout.ConstantSize.dluX(4);th.formlayout.Sizes.DLUX5=th.formlayout.ConstantSize.dluX(5);th.formlayout.Sizes.DLUX6=th.formlayout.ConstantSize.dluX(6);th.formlayout.Sizes.DLUX7=th.formlayout.ConstantSize.dluX(7);th.formlayout.Sizes.DLUX8=th.formlayout.ConstantSize.dluX(8);th.formlayout.Sizes.DLUX9=th.formlayout.ConstantSize.dluX(9);th.formlayout.Sizes.DLUX11=th.formlayout.ConstantSize.dluX(11);th.formlayout.Sizes.DLUX14=th.formlayout.ConstantSize.dluX(14);th.formlayout.Sizes.DLUX21=th.formlayout.ConstantSize.dluX(21);th.formlayout.Sizes.DLUY1=th.formlayout.ConstantSize.dluY(1);th.formlayout.Sizes.DLUY2=th.formlayout.ConstantSize.dluY(2);th.formlayout.Sizes.DLUY3=th.formlayout.ConstantSize.dluY(3);th.formlayout.Sizes.DLUY4=th.formlayout.ConstantSize.dluY(4);th.formlayout.Sizes.DLUY5=th.formlayout.ConstantSize.dluY(5);th.formlayout.Sizes.DLUY6=th.formlayout.ConstantSize.dluY(6);th.formlayout.Sizes.DLUY7=th.formlayout.ConstantSize.dluY(7);th.formlayout.Sizes.DLUY8=th.formlayout.ConstantSize.dluY(8);th.formlayout.Sizes.DLUY9=th.formlayout.ConstantSize.dluY(9);th.formlayout.Sizes.DLUY11=th.formlayout.ConstantSize.dluY(11);th.formlayout.Sizes.DLUY14=th.formlayout.ConstantSize.dluY(14);th.formlayout.Sizes.DLUY21=th.formlayout.ConstantSize.dluY(21);th.formlayout.Sizes.MINIMUM=new th.formlayout.ComponentSize("minimum");th.formlayout.Sizes.PREFERRED=new th.formlayout.ComponentSize("preferred");th.formlayout.Sizes.DEFAULT=new th.formlayout.ComponentSize("default");th.formlayout.Sizes.defaultUnit=th.formlayout.ConstantSize.PIXEL;th.formlayout.Sizes.constant=function(d,a){var b=d.toLowerCase();var c=th.trim(b);return th.formlayout.ConstantSize.valueOf(c,a)};th.formlayout.Sizes.bounded=function(b,c,a){return th.formlayout.BoundedSize(b,c,a)};th.formlayout.Sizes.emAsPixel=function(b,a){return b==0?0:th.formlayout.Sizes.unitConverter.emAsPixel(b,a)};th.formlayout.Sizes.inchAsPixel=function(b,a){return b==0?0:th.formlayout.Sizes.unitConverter.inchAsPixel(b,a)};th.formlayout.Sizes.millimeterAsPixel=function(b,a){return b==0?0:th.formlayout.Sizes.unitConverter.millimeterAsPixel(b,a)};th.formlayout.Sizes.centimeterAsPixel=function(a,b){return a==0?0:th.formlayout.Sizes.unitConverter.centimeterAsPixel(a,b)};th.formlayout.Sizes.pointAsPixel=function(b,a){return b==0?0:th.formlayout.Sizes.unitConverter.pointAsPixel(b,a)};th.formlayout.Sizes.dialogUnitXAsPixel=function(b,a){return b==0?0:th.formlayout.Sizes.unitConverter.dialogUnitXAsPixel(b,a)};th.formlayout.Sizes.dialogUnitYAsPixel=function(b,a){return b==0?0:th.formlayout.Sizes.unitConverter.dialogUnitYAsPixel(b,a)};th.formlayout.Sizes.getDefaultUnit=function(){return th.formlayout.Sizes.defaultUnit};th.formlayout.Alignment=Class.define({members:{init:function(b,a){this.name=b;this.orientation=a},toString:function(){return this.name},abbreviation:function(){return this.name.charAt(0)},isHorizontal:function(){return this.orientation!=th.formlayout.Alignment.VERTICAL},isVertical:function(){return this.orientation!=th.formlayout.Alignment.HORIZONTAL}}});th.formlayout.Alignment.HORIZONTAL=0;th.formlayout.Alignment.VERTICAL=1;th.formlayout.Alignment.BOTH=2;th.formlayout.Alignment.valueOf=function(a){var b=a.toLowerCase();if(b=="d"||b=="default"){return th.formlayout.CellConstraints.DEFAULT}else{if(b=="f"||b=="fill"){return th.formlayout.CellConstraints.FILL}else{if(b=="c"||b=="center"){return th.formlayout.CellConstraints.CENTER}else{if(b=="l"||b=="left"){return th.formlayout.CellConstraints.LEFT}else{if(b=="r"||b=="right"){return th.formlayout.CellConstraints.RIGHT}else{if(b=="t"||b=="top"){return th.formlayout.CellConstraints.TOP}else{if(b=="b"||b=="bottom"){return th.formlayout.CellConstraints.BOTTOM}else{throw"Invalid alignment "+a+". Must be one of: left, center, right, top, bottom, fill, default, l, c, r, t, b, f, d."}}}}}}}};th.formlayout.CellConstraints=Class.define({members:{init:function(b,i,g,f,d,h,c){var a=undefined;if(th.isString(b)){a=b;delete b}this.gridX=(b==undefined)?1:b;this.gridY=(i==undefined)?1:i;this.gridWidth=(g==undefined)?1:g;this.gridHeight=(f==undefined)?1:f;this.hAlign=d||th.formlayout.CellConstraints.DEFAULT;this.vAlign=h||th.formlayout.CellConstraints.DEFAULT;this.insets=c||th.formlayout.CellConstraints.EMPTY_INSETS;if(this.gridX<=0){throw new th.formlayout.IndexOutOfBoundsException("The grid x must be a positive number.")}if(this.gridY<=0){throw new th.formlayout.IndexOutOfBoundsException("The grid y must be a positive number.")}if(this.gridWidth<=0){throw new th.formlayout.IndexOutOfBoundsException("The grid width must be a positive number.")}if(this.gridHeight<=0){throw new th.formlayout.IndexOutOfBoundsException("The grid height must be a positive number.")}this.ensureValidOrientations(this.hAlign,this.vAlign);if(a){this.initFromConstraints(a)}},ensureValidOrientations:function(a,b){if(!a.isHorizontal()){throw new th.formlayout.IllegalArgumentException("The horizontal alignment must be one of: left, center, right, fill, default.")}if(!b.isVertical()){throw new th.formlayout.IllegalArgumentException("The vertical alignment must be one of: top, center, botto, fill, default.")}},initFromConstraints:function(a){var d=a.split(",");var g=d.length;if(!(g==2||g==4||g==6)){throw new th.formlayout.IllegalArgumentException("You must provide 2, 4 or 6 arguments.")}var b=0;var f=parseInt(th.trim(d[b++]));if(!f){throw new th.formlayout.IllegalArgumentException("First cell constraint element must be a number.")}this.gridX=f;if(this.gridX<=0){throw new th.formlayout.IndexOutOfBoundsException("The grid x must be a positive number.")}f=parseInt(th.trim(d[b++]));if(!f){throw new th.formlayout.IllegalArgumentException("Second cell constraint element must be a number.")}this.gridY=f;if(this.gridY<=0){throw new th.formlayout.IndexOutOfBoundsException("The grid y must be a positive number.")}if(b>=d.length){return}var c=th.trim(d[b++]);f=parseInt(c);if(f){this.gridWidth=f;if(this.gridWidth<=0){throw new th.formlayout.IndexOutOfBoundsException("The grid width must be a positive number.")}f=parseInt(th.trim(d[b++]));if(f==null){throw new th.formlayout.IllegalArgumentException("Fourth cell constraint element must be like third.")}this.gridHeight=f;if(this.gridHeight<=0){throw new th.formlayout.IndexOutOfBoundsException("The grid height must be a positive number.")}if(b>=d.length){return}c=th.trim(d[b++])}this.hAlign=this.decodeAlignment(c);this.vAlign=this.decodeAlignment(th.trim(d[b++]));this.ensureValidOrientations(this.hAlign,this.vAlign)},ensureValidGridBounds:function(b,a){if(this.gridX<=0){throw new th.formlayout.IndexOutOfBoundsException("The column index "+this.gridX+" must be positive.")}if(this.gridX>b){throw new th.formlayout.IndexOutOfBoundsException("The column index "+this.gridX+" must be less than or equal to "+b+".")}if(this.gridX+this.gridWidth-1>b){throw new th.formlayout.IndexOutOfBoundsException("The grid width "+this.gridWidth+" must be less than or equal to "+(b-this.gridX+1)+".")}if(this.gridY<=0){throw new th.formlayout.IndexOutOfBoundsException("The row index "+this.gridY+" must be positive.")}if(this.gridY>a){throw new th.formlayout.IndexOutOfBoundsException("The row index "+this.gridY+" must be less than or equal to "+a+".")}if(this.gridY+this.gridHeight-1>a){throw new th.formlayout.IndexOutOfBoundsException("The grid height "+this.gridHeight+" must be less than or equal to "+(a-this.gridY+1)+".")}},decodeAlignment:function(a){return th.formlayout.Alignment.valueOf(a)},setBounds:function(C,B,u,d,g,A,f){var D=this.gridWidth==1?B.getColumnSpec(this.gridX):undefined;var v=this.gridHeight==1?B.getRowSpec(this.gridY):undefined;var p=this.concreteAlignment(this.hAlign,D);var m=this.concreteAlignment(this.vAlign,v);var q=this.insets?this.insets:th.formlayout.CellConstraints.EMPTY_INSETS;var s=u.x+q.left;var r=u.y+q.top;var z=u.width-q.left-q.right;var a=u.height-q.top-q.bottom;var b=this.componentSize(C,D,z,d,A);var o=this.componentSize(C,v,a,g,f);var j=this.origin(p,s,z,b);var i=this.origin(m,r,a,o);var n=this.extent(p,z,b);var t=this.extent(m,a,o);C.setBounds(j,i,n,t)},concreteAlignment:function(a,b){return!b?(a==th.formlayout.CellConstraints.DEFAULT?th.formlayout.CellConstraints.FILL:a):this.usedAlignment(a,b)},usedAlignment:function(a,b){if(a!=th.formlayout.CellConstraints.DEFAULT){return a}var c=b.getDefaultAlignment();if(c==th.formlayout.FormSpec.FILL_ALIGN){return th.formlayout.CellConstraints.FILL}if(c==th.formlayout.ColumnSpec.LEFT){return th.formlayout.CellConstraints.LEFT}else{if(c==th.formlayout.FormSpec.CENTER_ALIGN){return th.formlayout.CellConstraints.CENTER}else{if(c==th.formlayout.ColumnSpec.RIGHT){return th.formlayout.CellConstraints.RIGHT}else{if(c==th.formlayout.RowSpec.TOP){return th.formlayout.CellConstraints.TOP}else{return th.formlayout.CellConstraints.BOTTOM}}}}},componentSize:function(c,b,f,a,d){if(!b){return d(c)}else{if(b.getSize()==th.formlayout.Sizes.MINIMUM){return a(c)}else{if(b.getSize()==th.formlayout.Sizes.PREFERRED){return d(c)}else{return Math.min(f,d(c))}}}},origin:function(d,b,c,a){if(d==th.formlayout.CellConstraints.RIGHT||d==th.formlayout.CellConstraints.BOTTOM){return b+c-a}else{if(d==th.formlayout.CellConstraints.CENTER){return b+(c-a)/2}else{return b}}},extent:function(c,b,a){return c==th.formlayout.CellConstraints.FILL?b:a},toString:function(){var a="CellConstraints";a+="[x=";a+=this.gridX;a+="; y=";a+=this.gridY;a+="; w=";a+=this.gridWidth;a+="; h=";a+=this.gridHeight;a+="; hAlign=";a+=this.hAlign;a+="; vAlign=";a+=this.vAlign;a+="; honorsVisibility=";a+=this.honorsVisibility;a+="]";return a},xy:function(){var a=arguments;switch(arguments.length){case 2:return this.xywh(a[0],a[1],1,1);case 3:return this.xywh(a[0],a[1],1,1,a[2]);case 4:return this.xywh(a[0],a[1],1,1,a[2],a[3]);default:throw"wrong number of arguments passed to xy()"}},xyw:function(){var a=arguments;switch(arguments.length){case 3:return this.xywh(a[0],a[1],a[2],1,th.formlayout.CellConstraints.DEFAULT,th.formlayout.CellConstraints.DEFAULT);case 4:return this.xywh(a[0],a[1],a[2],1,a[3]);case 5:return this.xywh(a[0],a[1],a[2],1,a[3],a[4]);default:throw"wrong number of arguments passed to xyw()"}},xywh:function(){var b=arguments;switch(arguments.length){case 4:return this.xywh(b[0],b[1],b[2],b[3],th.formlayout.CellConstraints.DEFAULT,th.formlayout.CellConstraints.DEFAULT);case 5:var a=this.xywh(b[0],b[1],b[2],b[3]);a.setAlignment(b[4],true);return a;case 6:this.gridX=b[0];this.gridY=b[1];this.gridWidth=b[2];this.gridHeight=b[3];this.hAlign=b[4];this.vAlign=b[5];this.ensureValidOrientations(this.hAlign,this.vAlign);return this;default:throw"wrong number of arguments passed to xywh()"}}}});th.formlayout.CellConstraints.DEFAULT=new th.formlayout.Alignment("default",th.formlayout.Alignment.BOTH);th.formlayout.CellConstraints.FILL=new th.formlayout.Alignment("fill",th.formlayout.Alignment.BOTH);th.formlayout.CellConstraints.LEFT=new th.formlayout.Alignment("left",th.formlayout.Alignment.HORIZONTAL);th.formlayout.CellConstraints.RIGHT=new th.formlayout.Alignment("right",th.formlayout.Alignment.HORIZONTAL);th.formlayout.CellConstraints.CENTER=new th.formlayout.Alignment("center",th.formlayout.Alignment.BOTH);th.formlayout.CellConstraints.TOP=new th.formlayout.Alignment("top",th.formlayout.Alignment.VERTICAL);th.formlayout.CellConstraints.BOTTOM=new th.formlayout.Alignment("bottom",th.formlayout.Alignment.VERTICAL);th.formlayout.CellConstraints.EMPTY_INSETS={top:0,left:0,bottom:0,right:0};th.formlayout.FormSpecParser=Class.define({members:{init:function(c,b,d,a){this.layoutMap=d;this.source=c},parseColumnSpecs:function(){var b=this.split(this.source,0);var d=b.length;var a=[];for(var c=0;c<d;c++){var f=b[c];a[c]=th.formlayout.ColumnSpec.decodeExpanded(f)}return a},parseRowSpecs:function(){var d=this.split(this.source,0);var a=d.length;var c=[];for(var b=0;b<a;b++){var f=d[b];c[b]=th.formlayout.RowSpec.decodeExpanded(f)}return c},split:function(h,f){var p=[];var b=0;var j=0;var a=h.length;var o=0;var n;var m=true;for(var g=0;g<a;g++){n=h.charAt(g);if(m&&th.isWhitespace(n)){o++;continue}m=false;if((n==",")&&(b==0)&&(j==0)){var d=h.substring(o,g);this.addSpec(p,d,f+o);o=g+1;m=true}else{if(n=="("){if(j>0){this.fail(f+g,"illegal '(' in [...]")}b++}else{if(n==")"){if(j>0){this.fail(f+g,"illegal ')' in [...]")}b--;if(b<0){this.fail(f+g,"missing '('")}}else{if(n=="["){if(j>0){this.fail(f+g,"too many '['")}j++}else{if(n=="]"){j--;if(j<0){this.fail(f+g,"missing '['")}}}}}}}if(b>0){this.fail(f+a,"missing ')'")}if(j>0){this.fail(f+a,"missing ']")}if(o<a){var d=h.substring(o);this.addSpec(p,d,f+o)}return p},addSpec:function(c,g,f){var b=th.trim(g);var h=this.multiplier(b,f);if(!h){c.push(b);return}var d=this.split(h.expression,f+h.offset);for(var a=0;a<h.multiplier;a++){th.forEach(d,function(i){c.push(i)})}},multiplier:function(h,f){var g=new RegExp(th.formlayout.FormSpecParser.MULTIPLIER_PREFIX_PATTERN);if(!g.test(h)){return}var b=g.exec(h);b.end=b.index+b[0].length;if(b.index>0){this.fail(f+b.index,"illegal multiplier position")}var a=new RegExp(th.formlayout.DIGIT_PATTERN);if(!a.test(h)){return}var j=a.exec(h);j.end=b.index+b[0].length;var i=h.substring(0,j.end);var c=parseInt(i);if(isNaN(c)){this.fail(f,"Invalid multiplier")}if(c<=0){this.fail(f,"illegal 0 multiplier")}var d=h.substring(b.end,h.length()-1);return{multiplier:c,expression:d,offset:b.end}},fail:function(a,b,c){if(!c){c=this.source}throw new th.formlayout.FormLayoutParseException(this.message(c,a,b))},message:function(f,b,d){var a="\n";a+="\n";a+=f;a+="\n";for(var c=0;c<b;c++){a+=" "}a+="^";a+=d;return a}}});th.formlayout.FormSpecParser.parseColumnSpecs=function(a,b){var c=new th.formlayout.FormSpecParser(a,"encoded column specifications",b,true);return c.parseColumnSpecs()};th.formlayout.FormSpecParser.parseRowSpecs=function(a,b){var c=new th.formlayout.FormSpecParser(a,"encoded column specifications",b,false);return c.parseRowSpecs()};th.formlayout.FormSpecParser.MULTIPLIER_PREFIX_PATTERN="\\d+\\s*\\*\\s*\\(";th.formlayout.FormSpecParser.DIGIT_PATTERN="\\d+";
dojo.provide("bespin.bespin");dojo.mixin(bespin,{versionNumber:'tip',versionCodename:'DEVELOPMENT MODE',apiVersion:'dev',defaultTabSize:4,userSettingsProject:"BespinSettings",_eventLog:{},_lazySubscriptionCount:0,_lazySubscriptionTimeout:{},publish:function(topic,args){if(window.globalStorage&&window.globalStorage[location.hostname].debug){console.log("Publish",topic,args);}
bespin._eventLog[topic]=true;dojo.publish("bespin:"+topic,dojo.isArray(args)?args:[args||{}]);},fireAfter:function(topics,callback){if(!dojo.isArray(topics)){throw new Error("fireAfter() takes an array of topics. '"+topics+"' is not an array.");}
var count=topics.length;var done=function(){if(count==0){callback();}};for(var i=0;i<topics.length;++i){var topic=topics[i];if(bespin._eventLog[topic]){--count;}else{bespin.subscribe(topic,function(){--count;done();});}
done();}},subscribe:function(topic,callback,minTimeBetweenPublishMillis){if(minTimeBetweenPublishMillis){var orig=callback;var count=this._lazySubscriptionCount++;var self=this;callback=function(){if(self._lazySubscriptionTimeout[count]){clearTimeout(self._lazySubscriptionTimeout[count]);}
self._lazySubscriptionTimeout[count]=setTimeout(function(){orig.apply(self,arguments);delete self._lazySubscriptionTimeout[count];},minTimeBetweenPublishMillis);};}
return dojo.subscribe("bespin:"+topic,callback);},unsubscribe:dojo.unsubscribe,registeredComponents:{},register:function(id,object){this.registeredComponents[id]=object;bespin.publish("component:register:"+id,{id:id,object:object});return object;},get:function(id){return this.registeredComponents[id];},unregister:function(id){delete this.registeredComponents[id];},withComponent:function(id,func){var component=this.get(id);if(component){return func(component);}},getComponent:function(id,callback,context){context=context||window;var component=bespin.get(id);if(!component){var factory=bespin.factories[id];if(!factory){return undefined;}
factory(callback,context);return false;}else{callback.call(context,component);}
return true;},factories:{popup:function(callback,context){bespin.plugins.loadOne("popup",function(popupmod){var popup=bespin.register("popup",new popupmod.Window());callback.call(context,popup);});},piemenu:function(callback,context){bespin.plugins.loadOne("piemenu",function(piemenumod){bespin.register("piemenu",new piemenumod.Window());setTimeout(function(){var piemenu=bespin.get("piemenu");callback.call(context,piemenu);},25);});},commandLine:function(callback,context){bespin.plugins.loadOne("commandLine",function(commandline){var commandLine=bespin.register("commandLine",new commandline.Interface('command',bespin.command.store));callback.call(context,commandLine);});},debugbar:function(callback,context){bespin.plugins.loadOne("debugbar",function(debug){var commandLine=bespin.register("debugbar",new debug.EvalCommandLineInterface('debugbar_command',null,{idPrefix:"debugbar_",parentElement:dojo.byId("debugbar")}));callback.call(context,commandLine);});},breakpoints:function(callback,context){bespin.plugins.loadOne("breakpoints",function(BreakpointManager){var breakpoints=bespin.register("breakpoints",new BreakpointManager());callback.call(context,breakpoints);});}},displayVersion:function(el){el=dojo.byId(el)||dojo.byId("version");if(!el)return;el.innerHTML='<a href="https://wiki.mozilla.org/Labs/Bespin/ReleaseNotes" title="Read the release notes">Version <span class="versionnumber">'+this.versionNumber+'</span> "'+this.versionCodename+'"</a>';},_subscribeToExtension:function(key){bespin.subscribe("extension:removed:"+key,function(){var item=bespin.get(key);if(item&&item.destroy){item.destroy();}
bespin.unregister(key);});},_initializeReloaders:function(){for(var key in bespin.factories){bespin._subscribeToExtension(key);}}});bespin.subscribe("extension:loaded:bespin.subscribe",function(ext){var subscription=bespin.subscribe(ext.topic,function(e){ext.load(function(func){func(e);});});ext.subscription=subscription;});bespin.subscribe("extension:removed:bespin.subscribe",function(ext){if(ext.subscription){bespin.unsubscribe(ext.subscription);}});bespin._initializeReloaders();
dojo.provide("bespin.command");dojo.declare("bespin.command.Store",null,{constructor:function(parent,command){this.commands={};this.aliases={};if(parent){this.containerCommand=command;this.parent=parent;command.takes=['*'];command.subcommands=this;parent.addCommand(command);}},addCommand:function(command){if(!command){return;}
command.parent=this;this.commands[command.name]=command;if(command.takes&&dojo.isArray(command.takes)){command=this.normalizeTakes(command);}
if(command.withKey){bespin.fireAfter(["component:register:editor"],function(){bespin.get('editor').bindCommand(command.name,command.withKey);});}
if(command.aliases){dojo.forEach(command.aliases,function(alias){this.aliases[alias]=command.name;},this);}
command.getFullCommandName=function(){var name=this.name;if(this.parent){name=this.parent.getFullCommandName()+" "+name;}
return dojo.trim(name);};if(!command.findCompletions){command.findCompletions=function(query,callback){query.hint=this.completeText;callback(query);};}},removeCommand:function(command){if(!command){return;}
delete this.commands[command.name];},getFullCommandName:function(){var name=this.containerCommand?this.containerCommand.name:"";if(this.parent){name=this.parent.getFullCommandName()+" "+name;}
return dojo.trim(name);},filterOptionsByPrefix:function(options,prefix){return options.filter(function(option){return option.substr(0,prefix.length)===prefix;});},findCommand:function(value){var parts=dojo.trim(value).split(/\s+/);var first=parts.shift();var command=this.commands[first]||this.commands[this.aliases[first]];if(!command){if(parts.length>0){return null;}else{return this;}}
if(command.subcommands){return command.subcommands.findCommand(parts.join(" "));}else{return command;}},findCompletions:function(query,callback){if(query.action.length>1){query.error="No matches";callback(query);return;}
var typed=query.action[0];if(typed.length==0&&this.parent==null){callback(query);return;}
var matches=[];for(var command in this.commands){if(command.indexOf(typed)==0){matches.push(command);}}
for(var alias in this.aliases){if(alias.indexOf(typed)==0){matches.push(alias);}}
if(matches.length==1){var newValue=matches[0];var command=this.commands[newValue]||this.commands[this.aliases[newValue]];if(this.commandTakesArgs(command)){newValue=newValue+" ";}
query.autofill=query.prefix+newValue;query.hint=command.preview;}else if(matches.length==0){query.error="No matches";}else{matches.sort(function(a,b){return a.localeCompare(b);});query.options=matches;}
callback(query);return;},commandTakesArgs:function(command){return command.takes!=undefined;},getArgs:function(fromUser,command){if(!command.takes)return undefined;var args;var userString=fromUser.join(' ');if(command.takes['*']){args=new bespin.util.TokenObject(userString);args.rawinput=userString;args.varargs=args.pieces;}else if(command.takes&&command.takes.order.length<2){args=userString;}else{args=new bespin.util.TokenObject(userString,{params:command.takes.order.join(' ')});args.rawinput=userString;}
return args;},normalizeTakes:function(command){var takes=command.takes;command.takes={order:takes};dojo.forEach(takes,function(item){command.takes[item]={"short":item[0]};});return command;},getHelp:function(prefix,options){var commands=[];var command,name;if(this.commands[prefix]){command=this.commands[prefix];commands.push(command['description']?command.description:command.preview);}else{var showHidden=false;var subcmdprefix="";if(this.containerCommand){subcmdprefix=" for "+this.containerCommand.name;}
if(prefix){if(prefix=="hidden"){prefix="";showHidden=true;}
commands.push("<h2>Commands starting with '"+prefix+"':</h2>");}else{commands.push("<h2>Available Commands:</h2>");}
var tobesorted=[];for(name in this.commands){tobesorted.push(name);}
var sorted=tobesorted.sort();commands.push("<table>");for(var i=0;i<sorted.length;i++){name=sorted[i];command=this.commands[name];if(!showHidden&&command.hidden)continue;if(prefix&&name.indexOf(prefix)!=0)continue;var args=(command.takes)?' ['+command.takes.order.join('] [')+']':'';commands.push("<tr>");commands.push('<th>'+name+'</th>');commands.push('<td>'+command.preview+"</td>");commands.push('<td>'+args+'</td>');commands.push("</tr>");}
commands.push("</table>");}
var output=commands.join("");if(options&&options.prefix){output=options.prefix+"<br/>"+output;}
if(options&&options.suffix){output=output+"<br/>"+options.suffix;}
return output;}});dojo.mixin(bespin.command,{store:new bespin.command.Store(),executeExtensionCommand:function(){var args=arguments;var self=this;this.load(function(execute){execute.apply(self,args);});}});bespin.subscribe("extension:loaded:bespin.command",function(ext){ext.execute=bespin.command.executeExtensionCommand;bespin.command.store.addCommand(ext);});bespin.subscribe("extension:removed:bespin.command",function(ext){bespin.command.store.removeCommand(ext);});bespin.command.store.addCommand({name:'help',takes:['search'],preview:'show commands',description:'The <u>help</u> gives you access to the various commands in the Bespin system.<br/><br/>You can narrow the search of a command by adding an optional search params.<br/><br/>If you pass in the magic <em>hidden</em> parameter, you will find subtle hidden commands.<br/><br/>Finally, pass in the full name of a command and you can get the full description, which you just did to see this!',completeText:'optionally, narrow down the search',execute:function(instruction,extra){var output=this.parent.getHelp(extra,{prefix:"<h2>Welcome to Bespin - Code in the Cloud</h2><ul>"+"<li><a href='http://labs.mozilla.com/projects/bespin' target='_blank'>Home Page</a>"+"<li><a href='https://wiki.mozilla.org/Labs/Bespin' target='_blank'>Wiki</a>"+"<li><a href='https://wiki.mozilla.org/Labs/Bespin/UserGuide' target='_blank'>User Guide</a>"+"<li><a href='https://wiki.mozilla.org/Labs/Bespin/Tips' target='_blank'>Tips and Tricks</a>"+"<li><a href='https://wiki.mozilla.org/Labs/Bespin/FAQ' target='_blank'>FAQ</a>"+"<li><a href='https://wiki.mozilla.org/Labs/Bespin/DeveloperGuide' target='_blank'>Developers Guide</a>"+"</ul>",suffix:"For more information, see the <a href='https://wiki.mozilla.org/Labs/Bespin'>Bespin Wiki</a>."});instruction.addOutput(output);}});
dojo.provide("bespin.util.util");bespin.util.queryToObject=function(str,seperator){var ret={};var qp=str.split(seperator);var dec=decodeURIComponent;dojo.forEach(qp,function(item){if(item.length){var parts=item.split("=");var name=dec(parts.shift());var val=dec(parts.join("="));if(dojo.isString(ret[name])){ret[name]=[ret[name]];}
if(dojo.isArray(ret[name])){ret[name].push(val);}else{ret[name]=val;}}});return ret;};bespin.util.endsWith=function(str,end){return str.match(new RegExp(end+"$"));};bespin.util.include=function(array,item){return dojo.indexOf(array,item)>-1;};bespin.util.indexOfProperty=function(array,propertyName,item){for(var i=0;i<array.length;i++){if(array[i][propertyName]==item){return i;}}
return null;}
bespin.util.last=function(array){if(dojo.isArray(array))return array[array.length-1];};bespin.util.shrinkArray=function(array){var newArray=[];var stillAtBeginning=true;dojo.forEach(array.reverse(),function(item){if(stillAtBeginning&&item===undefined){return;}
stillAtBeginning=false;newArray.push(item);});return newArray.reverse();};bespin.util.makeArray=function(number,character){if(number<1)return[];if(!character)character=' ';var newArray=[];for(var i=0;i<number;i++){newArray.push(character);}
return newArray;};bespin.util.leadingSpaces=function(row){var numspaces=0;for(var i=0;i<row.length;i++){if(row[i]==' '||row[i]==''||row[i]===undefined){numspaces++;}else{return numspaces;}}
return numspaces;};bespin.util.leadingTabs=function(row){var numtabs=0;for(var i=0;i<row.length;i++){if(row[i]=='\t'||row[i]==''||row[i]===undefined){numtabs++;}else{return numtabs;}}
return numtabs;};bespin.util.leadingWhitespace=function(row){var leading=[];for(var i=0;i<row.length;i++){if(row[i]==' '||row[i]=='\t'||row[i]==''||row[i]===undefined){leading.push(row[i]);}else{return leading;}}
return leading;};bespin.util.englishFromCamel=function(camel){dojo.trim(camel.replace(/([A-Z])/g,function(str){return" "+str.toLowerCase();}));};bespin.util.OS={LINUX:'LINUX',MAC:'MAC',WINDOWS:'WINDOWS'};bespin.util.isMac=function(){return navigator.appVersion.indexOf("Mac")>=0;};bespin.util.isLinux=function(){return navigator.appVersion.indexOf("Linux")>=0;};bespin.util.isWindows=function(){return navigator.appVersion.indexOf("Win")>=0;};bespin.util.getOS=function(){if(bespin.util.isMac()){return bespin.util.OS['MAC'];}else if(bespin.util.isLinux()){return bespin.util.OS['LINUX'];}else{return bespin.util.OS['WINDOWS'];}};bespin.util.contains=document.compareDocumentPosition?function(a,b){return a.compareDocumentPosition(b)&16;}:function(a,b){return a!==b&&(a.contains?a.contains(b):true);};bespin.util.randomPassword=function(length){length=length||16;var chars="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";var pass="";for(var x=0;x<length;x++){var charIndex=Math.floor(Math.random()*chars.length);pass+=chars.charAt(charIndex);}
return pass;};bespin.util.isEmpty=function(object){for(var x in object){if(object.hasOwnProperty(x))return false;}
return true;};
dojo.provide("bespin.events");dojo.require("bespin.util.util");bespin.events.toFire=function(eventString){var event={};if(eventString.indexOf(';')<0){event.name=eventString;}else{var pieces=eventString.split(';');event.name=pieces[0];event.args=bespin.util.queryToObject(pieces[1],',');}
return event;};bespin.events.defaultScope=function(){if(bespin.events._defaultScope)return bespin.events._defaultScope;var scope={bespin:bespin,include:function(file){bespin.get('files').evalFile(bespin.userSettingsProject,file);},tryTocopyComponent:function(id){bespin.withComponent(id,dojo.hitch(this,function(component){this.id=component;}));},require:dojo.require,publish:bespin.publish,subscribe:bespin.subscribe};bespin.withComponent('commandLine',function(commandLine){scope.commandLine=commandLine;scope.execute=function(cmd){commandLine.executeCommand(cmd);};});scope.tryTocopyComponent('editor');scope.tryTocopyComponent('editSession');scope.tryTocopyComponent('files');scope.tryTocopyComponent('server');scope.tryTocopyComponent('toolbar');bespin.events._defaultScope=scope;return bespin.events._defaultScope;};
dojo.provide("bespin.util.canvas");dojo.mixin(bespin.util.canvas,{fix:function(ctx){if(!ctx.fillText&&ctx.mozDrawText){ctx.fillText=function(textToDraw,x,y,maxWidth){ctx.translate(x,y);ctx.mozTextStyle=ctx.font;ctx.mozDrawText(textToDraw);ctx.translate(-x,-y);};}
if(!ctx.measureText&&ctx.mozMeasureText){ctx.measureText=function(text){if(ctx.font)ctx.mozTextStyle=ctx.font;var width=ctx.mozMeasureText(text);return{width:width};};}
if(ctx.measureText&&!ctx.html5MeasureText){ctx.html5MeasureText=ctx.measureText;ctx.measureText=function(text){var textMetrics=ctx.html5MeasureText(text);textMetrics.ascent=ctx.html5MeasureText("m").width;return textMetrics;};}
if(!ctx.fillText){ctx.fillText=function(){};}
if(!ctx.measureText){ctx.measureText=function(){return 10;};}
return ctx;}});
dojo.provide("bespin.util.keys");(function(){bespin.util.keys.Key={ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,FORWARD_SLASH:191,TILDE:192,BACK_SLASH:220};dojo.mixin(bespin.util.keys.Key,dojo.keys);var keys=bespin.util.keys.Key;bespin.util.keys.KeyCodeToName={};for(var key in keys){var keyCode=keys[key];if(typeof keyCode=="number"){bespin.util.keys.KeyCodeToName[keyCode]=key;}}})();bespin.util.keys.toKeyCode=function(keyAsString){return bespin.util.keys.Key[keyAsString.toUpperCase()];};bespin.util.keys.fillArguments=function(string,args){var keys=string.split(' ');args=args||{};args.key=keys.pop();if(keys.length==0){args.modifiers="none";}else{args.modifiers=keys.join(',');}
return args;};bespin.util.keys.PassThroughCharCodes=dojo.map(["k","l","n","o","t","w","+","-","~","0","1","2","3","4","5","6","7","8","9"],function(item){return item.charCodeAt(0);});bespin.util.keys.PassThroughKeyCodes=(function(){var Key=bespin.util.keys.Key;return[Key.C,Key.X,Key.V,Key.K,Key.L,Key.N,Key.O,Key.T,Key.W,Key.NUMPAD_PLUS,Key.NUMPAD_MINUS,Key.TILDE,Key.ZERO,Key.ONE,Key.TWO,Key.THREE,Key.FOUR,Key.FIVE,Key.SIX,Key.SEVEN,Key.EIGHT,Key.NINE];})();bespin.util.keys.passThroughToBrowser=function(e){var Key=bespin.util.keys.Key;if(!e.ctrlKey){return true;}else if(e.metaKey||e.altKey||e.ctrlKey){if(e.type=="keypress"){var match=dojo.some(bespin.util.keys.PassThroughCharCodes,function(item){return(item==e.charCode);});if(match){return true;}}else{var match=dojo.some(bespin.util.keys.PassThroughKeyCodes,function(item){return(item==e.keyCode);});if(match){return true;}}}
return false;};
dojo.provide("bespin.util.navigate");(function(){var go=function(url,newTab){if(newTab){window.open(url,"_blank");}else{location.href=url;}};dojo.mixin(bespin.util.navigate,{home:function(newTab){go("index.html",newTab);},quickEdit:function(newTab){go("editor.html#new=true",newTab);},editor:function(project,path,opts){var url="editor.html#";var args=[];if(project)args.push("project="+project);if(path)args.push("path="+path);if(!opts)opts={};if(opts.newFile)args.push("new=true");if(opts.content)args.push("content="+escape(opts.content));if(args.length>0)url+=args.join("&");go(url,opts.newTab);}});})();
dojo.provide("bespin.util.path");dojo.mixin(bespin.util.path,{combine:function(){var args=Array.prototype.slice.call(arguments);var path=args.join('/');path=path.replace(/\/\/+/g,'/');path=path.replace(/^\s+|\s+$/g,'');return path;},directory:function(path){var dirs=path.split('/');if(dirs.length==1){return"";}else if((dirs.length==2)&&dirs[dirs.length-1]==""){return path;}else{return dirs.slice(0,dirs.length-1).join('/');}},makeDirectory:function(path){if(!/\/$/.test(path))path+='/';return path;},combineAsDirectory:function(){return this.makeDirectory(this.combine.apply(this,arguments));},escape:function(){return escape(this.combine.apply(this,arguments));},fileType:function(path){if(path.indexOf('.')>=0){var split=path.split('.');if(split.length>1){return split[split.length-1];}}}});
dojo.provide("bespin.util.tokenobject");dojo.declare("bespin.util.TokenObject",null,{constructor:function(input,options){this._input=input;this._options=options||{};this._splitterRegex=new RegExp(this._options.splitBy||'\\s+');this.pieces=this.tokenize(input.split(this._splitterRegex));if(this._options.params){this._nametoindex={};var namedparams=this._options.params.split(' ');for(var x=0;x<namedparams.length;x++){this._nametoindex[namedparams[x]]=x;if(!this._options['noshortcutvalues']){this[namedparams[x]]=this.pieces[x];}}}},tokenize:function(incoming){var tokens=[];var nextToken;while(nextToken=incoming.shift()){if(nextToken[0]=='"'||nextToken[0]=="'"){var eaten=[nextToken.substring(1,nextToken.length)];var eataway;while(eataway=incoming.shift()){if(eataway[eataway.length-1]=='"'||eataway[eataway.length-1]=="'"){eaten.push(eataway.substring(0,eataway.length-1));break;}else{eaten.push(eataway);}}
tokens.push(eaten.join(' '));}else{tokens.push(nextToken);}}
return tokens;},param:function(index){return(typeof index=="number")?this.pieces[index]:this.pieces[this._nametoindex[index]];},length:function(){return this.pieces.length;}});
dojo.provide("bespin.util.mousewheelevent");dojo.mixin(bespin.util.mousewheelevent,{wheel:function(event){var delta=0;if(!event)event=window.event;if(event.wheelDelta){delta=-event.wheelDelta/40;if(window.opera&&window.opera.version()<9.2)delta=-delta;}else if(event.detail){delta=event.detail;}
return delta;},axis:function(event){var returnType="vertical";if(event.axis){if(event.axis==event.HORIZONTAL_AXIS)returnType="horizontal";}else if(event.wheelDeltaY||event.wheelDeltaX){if(event.wheelDeltaX==event.wheelDelta)returnType="horizontal";}else if(event.shiftKey)returnType="horizontal";return returnType;}});
dojo.provide("bespin.util.webpieces");dojo.require("dijit._base.place");dojo.mixin(bespin.util.webpieces,{showCenterPopup:function(el,isModal){if(isModal){this.showOverlay();}
dojo.style(el,'display','block');var elDims=dojo.coords(el);var browserDims=dijit.getViewport();var y=(browserDims.h-elDims.h)/2;var x=(browserDims.w-elDims.w)/2;dojo.style(el,{position:'absolute',top:y+'px',left:x+'px'});},hideCenterPopup:function(el){dojo.style(el,'display','none');this.hideOverlay();},showOverlay:function(){dojo.style('overlay','display','block');},hideOverlay:function(){dojo.style('overlay','display','none');},fillScreenOverlay:function(){var coords=dojo.coords(document.body);if(coords.h){dojo.style(dojo.byId('overlay'),'height',coords.h+"px");}},showStatus:function(msg){dojo.byId("status").innerHTML=msg;dojo.style('status','display','block');},showContentOverlay:function(msg,options){options=options||{};var el=dojo.byId('centerpopup');var addTags="";var endTags="";if(options.pre){addTags=addTags+"<pre>";endTags="</pre>"+endTags;}
el.innerHTML="<div style='background-color: #fff; border: 1px solid #000; height: 100%; overflow: auto'>"+addTags+msg+endTags+"</div>";oldwidth=el.style.width;oldheight=el.style.height;el.style.width="80%";el.style.height="80%";dojo.require("dijit._base.place");dojo.require("bespin.util.webpieces");bespin.util.webpieces.showCenterPopup(el);var connection=dojo.connect(el,"onclick",function(){bespin.util.webpieces.hideCenterPopup(el);el.style.width=oldwidth;el.style.height=oldheight;dojo.disconnect(connection);});}});
dojo.provide("bespin.client.filesystem");dojo.declare("bespin.client.FileSystem",null,{constructor:function(server){this.server=server||bespin.get('server');},newFile:function(project,path,onSuccess,onFailure){var self=this;this.whenFileDoesNotExist(project,path,{execute:function(){if(self.isCollaborationOn()){bespin.get('editSession').startSession(project,path||"new.txt",onSuccess,onFailure);}else{bespin.publish("path:changed",{project:project,path:path});onSuccess({name:path,content:"",timestamp:new Date().getTime()});}},elseFailed:function(){if(dojo.isFunction(onFailure)){onFailure({responseText:'The file '+path+' already exists my friend.'});}
bespin.get("commandLine").addErrorOutput('The file '+path+' already exists my friend.');}});},loadContents:function(project,path,onSuccess,onFailure){this.server.loadFile(project,path,function(content){if(/\n$/.test(content)){content=content.substr(0,content.length-1);}
onSuccess({name:path,content:content,timestamp:new Date().getTime()});},onFailure);},isCollaborationOn:function(){var collab=bespin.get('settings').isSettingOn('collaborate');if(collab&&!window.mobwrite){console.log("Missing bespin.mobwrite: Forcing 'collaborate' to off in filesystem.js:collaborateOnFile");collab=false;}
var capabilities=bespin.get("serverCapabilities");if(collab&&capabilities.indexOf("collab")==-1){console.log("Server doesn't support collab: Forcing 'collaborate' to off in filesystem.js:collaborateOnFile");collab=false;}
return collab;},collaborateOnFile:function(project,path,onSuccess,onFailure){if(this.isCollaborationOn()){bespin.get('editSession').startSession(project,path,onSuccess,onFailure);}else{this.loadContents(project,path,onSuccess,onFailure);}},evalFile:function(project,filename,scope){scope=scope||bespin.events.defaultScope();if(!project||!filename){bespin.get('commandLine').addErrorOutput("Please, I need a project and filename to evaulate");return;}
this.loadContents(project,filename,function(file){with(scope){try{eval(file.content);}catch(e){var html="There is a error trying to run "+filename+" in project "+project+":<br>"+e;bespin.get('commandLine').addErrorOutput(html);}}},true);},projects:function(callback){this.server.projects(callback);},fileNames:function(project,callback){this.server.list(project,'',callback);},saveFile:function(project,file,onSuccess,onFailure){if(/\n$/.test(file.content))file.content+="\n";this.server.saveFile(project,file.name,file.content,file.lastOp,{onSuccess:function(){console.log("File saved: "+project+" "+file.name);bespin.publish("file:saved",{project:project,path:file.name});if(dojo.isFunction(onSuccess)){onSuccess();}},onFailure:onFailure});},makeDirectory:function(project,path,onSuccess,onFailure){var publishOnSuccess=function(result){bespin.publish("directory:created",{project:project,path:path});onSuccess(result);};this.server.makeDirectory(project,path,publishOnSuccess,onFailure);},removeDirectory:function(project,path,onSuccess,onFailure){var publishOnSuccess=function(result){bespin.publish("directory:removed",{project:project,path:path});onSuccess(result);};this.server.removeFile(project,path,publishOnSuccess,onFailure);},removeFile:function(project,path,onSuccess,onFailure){var publishOnSuccess=function(result){bespin.publish("file:removed",{project:project,path:path});onSuccess(result);};this.server.removeFile(project,path,publishOnSuccess,onFailure);},closeFile:function(project,path,callback){this.server.closeFile(project,path,callback);},whenFileExists:function(project,path,callbacks){this.server.list(project,bespin.util.path.directory(path),function(files){if(files&&dojo.some(files,function(file){return(file.name==path);})){callbacks['execute']();}else{if(callbacks['elseFailed'])callbacks['elseFailed']();}},function(xhr){if(callbacks['elseFailed'])callbacks['elseFailed'](xhr);});},whenFileDoesNotExist:function(project,path,callbacks){this.server.list(project,bespin.util.path.directory(path),function(files){if(!files||!dojo.some(files,function(file){return(file.name==path);})){callbacks['execute']();}else{if(callbacks['elseFailed'])callbacks['elseFailed']();}},function(xhr){callbacks['execute']();});}});
dojo.provide("bespin.client.settings");dojo.declare("bespin.client.settings.Core",null,{constructor:function(store){this.browserOverrides={};this.fromURL=new bespin.client.settings.URL();this.customEvents=new bespin.client.settings.Events(this);this.loadStore(store);},loadSession:function(){var editSession=bespin.get('editSession');var path=this.fromURL.get('path')||editSession.path;var project=this.fromURL.get('project')||editSession.project;bespin.publish("settings:init",{path:path,project:project});},defaultSettings:function(){return{'tabsize':'2','tabmode':'off','tabarrow':'on','fontsize':'10','consolefontsize':'11','autocomplete':'off','closepairs':'off','collaborate':'off','language':'auto','strictlines':'on','syntaxcheck':'off','syntaxengine':'simple','syntaxmarkers':'all','preview':'window','smartmove':'on','jslint':{}};},isOn:function(value){return value=='on'||value=='true';},isOff:function(value){return value=='off'||value=='false'||value===undefined;},isSettingOn:function(key){return this.isOn(this.get(key));},isSettingOff:function(key){return this.isOff(this.get(key));},loadStore:function(store){this.store=new(store||bespin.client.settings.ServerFile)(this);},toList:function(){var settings=[];var storeSettings=this.store.settings;for(var prop in storeSettings){if(storeSettings.hasOwnProperty(prop)){settings.push({'key':prop,'value':storeSettings[prop]});}}
return settings;},set:function(key,value){this.store.set(key,value);bespin.publish("settings:set:"+key,{value:value});},setObject:function(key,value){this.set(key,dojo.toJson(value));},get:function(key){var fromURL=this.fromURL.get(key);if(fromURL)return fromURL;return this.store.get(key);},getObject:function(key){try{return dojo.fromJson(this.get(key));}catch(e){console.log("Error in getObject: "+e);return{};}},unset:function(key){this.store.unset(key);},list:function(){if(typeof this.store['list']=="function"){return this.store.list();}else{return this.toList();}},publishValues:function(){for(var topic in dojo._topics){var settingsTopicBase="bespin:settings:set:";if(topic.indexOf(settingsTopicBase)==0){var settingKey=topic.substring(settingsTopicBase.length);bespin.publish("settings:set:"+settingKey,{value:this.get(settingKey)});}}}});dojo.declare("bespin.client.settings.InMemory",null,{constructor:function(parent){this.parent=parent;this.settings=this.parent.defaultSettings();bespin.publish("settings:loaded");},set:function(key,value){this.settings[key]=value;},get:function(key){return this.settings[key];},unset:function(key){delete this.settings[key];}});dojo.declare("bespin.client.settings.Cookie",null,{constructor:function(parent){var expirationInHours=1;this.cookieSettings={expires:expirationInHours/24,path:'/'};var settings=dojo.fromJson(dojo.cookie("settings"));if(settings){this.settings=settings;}else{this.settings={'tabsize':'2','fontsize':'10','autocomplete':'off','collaborate':'off'};dojo.cookie("settings",dojo.toJson(this.settings),this.cookieSettings);}
bespin.publish("settings:loaded");},set:function(key,value){this.settings[key]=value;dojo.cookie("settings",dojo.toJson(this.settings),this.cookieSettings);},get:function(key){return this.settings[key];},unset:function(key){delete this.settings[key];dojo.cookie("settings",dojo.toJson(this.settings),this.cookieSettings);}});dojo.declare("bespin.client.settings.ServerAPI",null,{constructor:function(parent){this.parent=parent;this.server=bespin.get('server');this.settings=this.parent.defaultSettings();this.server.listSettings(dojo.hitch(this,function(settings){this.settings=settings;if(settings['tabsize']===undefined){this.settings=this.parent.defaultSettings();this.server.setSettings(this.settings);}
bespin.publish("settings:loaded");}));},set:function(key,value){this.settings[key]=value;this.server.setSetting(key,value);},get:function(key){return this.settings[key];},unset:function(key){delete this.settings[key];this.server.unsetSetting(key);}});dojo.declare("bespin.client.settings.ServerFile",null,{constructor:function(parent){this.parent=parent;this.server=bespin.get('server');this.settings=this.parent.defaultSettings();this.loaded=false;this._load();},set:function(key,value){this.settings[key]=value;if(key[0]!='_')this._save();},get:function(key){return this.settings[key];},unset:function(key){delete this.settings[key];this._save();},_save:function(){if(!this.loaded)return;var settings="";for(var key in this.settings){if(this.settings.hasOwnProperty(key)){settings+=key+" "+this.settings[key]+"\n";}}
bespin.get('files').saveFile(bespin.userSettingsProject,{name:"settings",content:settings,timestamp:new Date().getTime()});},_load:function(){var self=this;var postLoad=function(){if(!self.loaded){self.loaded=true;bespin.publish("settings:loaded");}};var onLoad=function(file){dojo.forEach(file.content.split(/\n/),function(setting){if(setting.match(/^\s*#/))return;if(setting.match(/\S+\s+\S+/)){var pieces=setting.split(/\s+/);self.settings[dojo.trim(pieces[0])]=dojo.trim(pieces[1]);}});self.parent.publishValues();postLoad();};bespin.fireAfter(["authenticated"],function(){bespin.get('files').loadContents(bespin.userSettingsProject,"settings",onLoad,postLoad);});}});dojo.declare("bespin.client.settings.URL",null,{constructor:function(queryString){this.results=dojo.queryToObject(this.stripHash(queryString||window.location.hash));},get:function(key){return this.results[key];},set:function(key,value){this.results[key]=value;},stripHash:function(url){var tobe=url.split('');tobe.shift();return tobe.join('');}});dojo.declare("bespin.client.settings.Events",null,{constructor:function(settings){var editSession=bespin.get('editSession');var editor=bespin.get('editor');bespin.subscribe("settings:set",function(event){var key=event.key;var value=event.value;settings.set(key,value);});bespin.subscribe("editor:openfile:opensuccess",function(event){if(event.file.name==null)throw new Error("event.file.name falsy");editSession.path=event.file.name;var fileType=bespin.util.path.fileType(event.file.name);if(fileType){bespin.publish("settings:language",{language:fileType});}});(function(){var specialFileMap={'BespinSettings/config':'js'};bespin.subscribe("editor:openfile:opensuccess",function(event){var project=event.project||bespin.get('editSession').project;var filename=event.file.name;var mapName=project+"/"+filename;if(specialFileMap[mapName]){bespin.publish("settings:language",{language:specialFileMap[mapName]});}});}());bespin.subscribe("settings:set:language",function(event){bespin.publish("settings:language",{language:event.value,fromCommand:true});});bespin.subscribe("settings:language",function(event){var language=event.language;var fromCommand=event.fromCommand;var languageSetting=settings.get('language')||"auto";if(language==editor.language)return;if(bespin.util.include(['auto','on'],language)){var path=settings.fromURL.get('path');if(path){var fileType=bespin.util.path.fileType(path);if(fileType){editor.language=fileType;}}}else if(bespin.util.include(['auto','on'],languageSetting)||fromCommand){editor.language=language;}else if(languageSetting=='off'){editor.language='off';}});bespin.subscribe("settings:set:fontsize",function(event){var fontsize=parseInt(event.value);editor.theme.editorTextFont=editor.theme.editorTextFont.replace(/[0-9]{1,}pt/,fontsize+'pt');editor.theme.lineNumberFont=editor.theme.lineNumberFont.replace(/[0-9]{1,}pt/,fontsize+'pt');});bespin.subscribe("settings:set:theme",function(event){var theme=event.value;var checkSetAndExit=function(){var themeSettings=bespin.themes[theme];if(themeSettings){if(themeSettings!=editor.theme){editor.theme=themeSettings;bespin.publish("settings:set:fontsize",{value:settings.get('fontsize')});}
return true;}
return false;};if(theme){if(checkSetAndExit())return true;try{var dr=dojo.require;dr.call(dojo,"bespin.themes."+theme);if(checkSetAndExit())return true;}catch(e){console.log("Unable to load theme: "+theme,e);}
bespin.get('files').loadContents(bespin.userSettingsProject,"/themes/"+theme+".js",dojo.hitch(this,function(file){try{eval(file.content);}catch(e){console.log("Error with theme loading: ",e);}
if(!checkSetAndExit()){bespin.get("commandLine").addErrorOutput("Sorry old chap. No theme called '"+theme+"'. Fancy making it?");}}),function(){bespin.get("commandLine").addErrorOutput("Sorry old chap. No theme called '"+theme+"'. Fancy making it?");});}});bespin.subscribe("settings:set:keybindings",function(event){if(event.value=="emacs"){editor.bindKey("moveCursorLeft","ctrl b");editor.bindKey("moveCursorRight","ctrl f");editor.bindKey("moveCursorUp","ctrl p");editor.bindKey("moveCursorDown","ctrl n");editor.bindKey("moveToLineStart","ctrl a");editor.bindKey("moveToLineEnd","ctrl e");}});bespin.subscribe("settings:set:debugmode",function(event){editor.debugMode=settings.isOn(event.value);if(editor.debugMode){bespin.plugins.loadOne("bespin.debugger",function(debug){debug.loadBreakpoints(function(){editor.paint(true);});});}else{editor.paint(true);}});bespin.subscribe("settings:set:cursorblink",function(event){var ms=parseInt(event.value);if(ms){editor.ui.toggleCursorFrequency=ms;}});var _trimOnSave;bespin.subscribe("settings:set:trimonsave",function(event){if(settings.isOn(event.value)){_trimOnSave=bespin.subscribe("editor:savefile:before",function(event){bespin.get("commandLine").executeCommand('trim',true);});}else{bespin.unsubscribe(_trimOnSave);}});bespin.subscribe("settings:set:syntaxcheck",function(data){if(settings.isOff(data.value)){bespin.publish("parser:stop");}else{bespin.publish("parser:start");}});bespin.subscribe("settings:init",function(event){if(!settings.isSettingOn("hidewelcomescreen")&&bespin.wizard){bespin.wizard.show(null,"newuser",false);}
if(event.path){editor.openFile(event.project,event.path);}else{var lastUsed=settings.getObject("_lastused");if(!lastUsed){editor.openFile("SampleProject","readme.txt");}
else{editor.openFile(lastUsed[0].project,lastUsed[0].filename,lastUsed[0]);}}});bespin.subscribe("settings:init",function(){if(settings.isOff(settings.get('autoconfig'))){return;}
try{bespin.get('files').evalFile(bespin.userSettingsProject,"config");}catch(e){console.log("Error in user config: ",e);}});}});
dojo.provide("bespin.client.status");dojo.declare("bespin.client.settings.StatusChecker",null,{constructor:function(){this.interval=0;this.statusMessages=["Bob is editing the file brick.html","Emily is creating a new tag called 'v3.4'","Jessica is saving the file kidly.html","John is idle. Lazy git!","Mickey has checked in a set of 4 files to project 'Bank'","Don has created the function 'doCalculation' in class 'Bank'","Benji is deleting the function 'doCalculation' in class 'Bank'"];},start:function(){this.interval=setInterval(dojo.hitch(this,"updateStatus"),12000);},stop:function(){clearInterval(this.interval);},updateStatus:function(){var randomMessage=this.randomStatus();this.setStatus(randomMessage);},randomStatus:function(){var random=Math.floor(Math.random()*this.statusMessages.length);return this.statusMessages[random];},setStatus:function(message){dojo.byId('message').innerHTML=message;}});
dojo.provide("bespin.client.server");dojo.require("bespin.util.util");dojo.declare("bespin.client.Server",null,{constructor:function(base){this.SERVER_BASE_URL=base||'.';this._jobs={};this._jobsCount=0;},_callCallback:function(options,functionName,args){if(dojo.isFunction(options[functionName])){try{options[functionName].apply(null,args);return true;}catch(ex){console.group("Error calling options."+functionName+" from server.request");console.log(options);console.log(options[functionName].toString());console.error(ex);console.trace();console.groupEnd();if(functionName=="onSuccess"&&dojo.isFunction(options['onFailure'])){try{options.onFailure({responseText:ex.toString()});}catch(ex){console.group("Error calling options.onFailure from server.request");console.error(ex);console.trace();console.groupEnd();}}}}
return false;},request:function(method,url,payload,options){var server=this;var xhr=new XMLHttpRequest();if(location.href.indexOf("file:")==0){try{if(netscape.security.PrivilegeManager.enablePrivilege){netscape.security.PrivilegeManager.enablePrivilege('UniversalBrowserRead');}}catch(ex){}}
if(options){var onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status&&xhr.status!=0&&(xhr.status>=200&&xhr.status<300)){var response=xhr.responseText;if(options['evalJSON']&&response){try{response=dojo.fromJson(response);}catch(syntaxException){console.log("Couldn't eval the JSON: "+response+" (SyntaxError: "+syntaxException+")");}}
var handled=server._callCallback(options,"onSuccess",[response,xhr]);if(!handled&&options['log']){console.log(options.log);}}else{handled=server._callCallback(options,'on'+xhr.status,[xhr]);if(!handled){server._callCallback(options,'onFailure',[xhr]);}}}};var cl=bespin.get("commandLine");if(cl)onreadystatechange=cl.link(onreadystatechange);xhr.onreadystatechange=onreadystatechange;xhr.open(method,this.SERVER_BASE_URL+url,true);this.protectXhrAgainstCsrf(xhr);xhr.setRequestHeader("Content-Type",'application/x-www-form-urlencoded');if(options.headers){for(var key in options.headers){if(options.headers.hasOwnProperty(key)){xhr.setRequestHeader(key,options.headers[key]);}}}
xhr.send(payload);}else{var fullUrl=this.SERVER_BASE_URL+url;console.log("Are you sure you want to do a synchronous Ajax call? Really? "+fullUrl);xhr.open(method,fullUrl,false);xhr.send(payload);return xhr.responseText;}},protectXhrAgainstCsrf:function(xhr){xhr.setRequestHeader("X-Domain-Token",this.getAntiCsrfToken());},getAntiCsrfToken:function(){var token=dojo.cookie("Domain-Token");if(!token){token=bespin.util.randomPassword();dojo.cookie("Domain-Token",token);}
return token;},requestDisconnected:function(method,url,payload,instruction,options){options.evalJSON=true;options.originalOnSuccess=options.onSuccess;var self=this;options.onSuccess=function(response,xhr){if(response.jobid==null){console.error("Missing jobid",response);options.onFailure(xhr);return;}
if(response.taskname){console.log("Server is running : "+response.taskname);}
self._jobs[response.jobid]={jobid:response.jobid,options:options};self._jobsCount++;self._checkPolling();};this.request(method,url,payload,options);},_checkPolling:function(){if(this._jobsCount==0)return;if(this._timeout!=null)return;this._poll();},_processResponse:function(message){if(message.jobid===undefined){console.warning("Missing jobid in message",message);return;}
var job=this._jobs[message.jobid];if(!job){console.debug("job unknown. page reload?",message,this);return;}
if(message.asyncDone){if(dojo.isArray(job.partials)){job.partials.push(message.output);job.options.originalOnSuccess(job.partials.join("<br/>"));}else{job.options.originalOnSuccess(message.output);}}
else{if(dojo.isFunction(job.options.onPartial)){job.options.onPartial(message.output);}else{job.partials.push(message.output);}}
if(message.asyncDone){if(this._jobsCount>0){this._jobsCount--;}
delete this._jobs[message.jobid];}},_poll:function(){var self=this;this.request('POST','/messages/',null,{evalJSON:true,onSuccess:function(messages){for(var i=0;i<messages.length;i++){self._processResponse(messages[i]);}
setTimeout(function(){self._checkPolling();},1000);},onFailure:function(message){self._processResponse(message);setTimeout(function(){self._checkPolling();},1000);}});},fetchResource:function(name,onSuccess,onFailure){this.request('GET',name,null,{onSuccess:onSuccess,onFailure:onFailure});},login:function(user,pass,onSuccess,onFailure){var url="/register/login/"+user;this.request('POST',url,"password="+escape(pass),{onSuccess:onSuccess,on401:onFailure,log:'Login complete.'});},signup:function(user,pass,email,opts){opts=opts||{};var url="/register/new/"+user;var data="password="+escape(pass)+"&email="+escape(email);this.request('POST',url,data,opts);},logout:function(onSuccess){var url="/register/logout/";this.request('POST',url,null,{log:'Logout complete.',onSuccess:onSuccess});},currentuser:function(whenLoggedIn,whenNotloggedin,otherFailure){var url="/register/userinfo/";return this.request('GET',url,null,{onSuccess:whenLoggedIn,on401:whenNotloggedin,evalJSON:true,onFailure:otherFailure});},list:function(project,path,onSuccess,onFailure){project=project||'';var url=bespin.util.path.combine('/file/list/',project,path||'/');var opts={onSuccess:onSuccess,evalJSON:true,log:"Listing files in: "+url};if(dojo.isFunction(onFailure))opts.onFailure=onFailure;this.request('GET',url,null,opts);},listAllFiles:function(project,onSuccess,onFailure){project=project||'';var url=bespin.util.path.combine('/file/list_all/',project,'/');var opts={onSuccess:onSuccess,evalJSON:true,log:"Listing all files in: "+url};if(dojo.isFunction(onFailure))opts.onFailure=onFailure;this.request('GET',url,null,opts);},projects:function(onSuccess){this.request('GET','/file/list/',null,{onSuccess:onSuccess,evalJSON:true});},saveFile:function(project,path,contents,lastOp,opts){if(!project||!path)return;opts=opts||{};opts.log='Saved file "'+project+'/'+path+'"';var url=bespin.util.path.combine('/file/at',project,(path||''));if(lastOp)url+="?lastEdit="+lastOp;this.request('PUT',url,contents,opts);},loadFile:function(project,path,onSuccess,onFailure){project=project||'';path=path||'';var url=bespin.util.path.combine('/file/at',project,path);var opts={onSuccess:onSuccess};if(dojo.isFunction(onFailure))opts.onFailure=onFailure;this.request('GET',url,null,opts);},removeFile:function(project,path,onSuccess,onFailure){project=project||'';path=path||'';var url=bespin.util.path.combine('/file/at',project,path);var opts={onSuccess:onSuccess};if(dojo.isFunction(onFailure))opts.onFailure=onFailure;this.request('DELETE',url,null,opts);},makeDirectory:function(project,path,onSuccess,onFailure){if(!project)return;var url=bespin.util.path.combineAsDirectory('/file/at',project,(path||''));var opts={};if(dojo.isFunction(onSuccess)){opts.onSuccess=onSuccess;}else{opts['log']="Made a directory: [project="+project+", path="+path+"]";}
if(dojo.isFunction(onFailure))opts.onFailure=onFailure;this.request('PUT',url,null,opts);},removeDirectory:function(project,path,onSuccess,onFailure){if(!project)return;if(!path)path='';var url=bespin.util.path.combineAsDirectory('/file/at',project,path);var opts={};if(dojo.isFunction(onSuccess)){opts.onSuccess=onSuccess;}else{opts['log']="Removed directory: [project="+project+", path="+path+"]";}
if(dojo.isFunction(onFailure))opts.onFailure=onFailure;this.request('DELETE',url,null,opts);},listOpen:function(onSuccess){this.request('GET','/file/listopen/',null,{onSuccess:onSuccess,evalJSON:true,log:'List open files.'});},closeFile:function(project,path,onSuccess){path=path||'';var url=bespin.util.path.combine('/file/close',project,path);this.request('POST',url,null,{onSuccess:onSuccess});},searchFiles:function(project,searchkey,includeFolders,onSuccess){var url=bespin.util.path.combine('/file/search',project+'?q='+escape(searchkey));if(includeFolders.length>0){url+='&i='+escape(includeFolders.join(';'));}
var opts={onSuccess:onSuccess,evalJSON:true,log:"Listing searchfiles for: "+project+", searchkey: "+searchkey};this.request('GET',url,null,opts);},editActions:function(project,path,onSuccess){path=path||'';var url=bespin.util.path.combine('/edit/list',project,path);this.request('GET',url,null,{onSuccess:onSuccess,log:"Edit Actions Complete."});},editAfterActions:function(project,path,index,onSuccess){path=path||'';var url=bespin.util.path.combine('/edit/recent',index,project,path);this.request('GET',url,null,{onSuccess:onSuccess,log:"Edit After Actions Complete."});},doAction:function(project,path,actions){path=path||'';var url=bespin.util.path.combine('/edit',project,path);var sp="["+actions.join(",")+"]";this.request('PUT',url,sp,{onSuccess:function(){}});},exportProject:function(project,archivetype){if(bespin.util.include(['zip','tgz','tar.gz'],archivetype)){var iframe=document.createElement("iframe");iframe.src=bespin.util.path.combine('/project/export',project+"."+archivetype);iframe.style.display='none';iframe.style.height=iframe.style.width="0";document.getElementsByTagName("body")[0].appendChild(iframe);}},importProject:function(project,url,opts){if(opts){var userCall=opts.onSuccess;opts.onSuccess=function(text,xhr){userCall(text,xhr);bespin.publish("project:imported",{project:project,url:url});};}
this.request('POST','/project/fromurl/'+project,url,opts||{});},renameProject:function(currentProject,newProject,opts){if(!opts)opts={log:"Renaming project from "+currentProject+" to "+newProject};if(currentProject&&newProject){this.request('POST','/project/rename/'+currentProject+"/",newProject,opts);}},listSettings:function(onSuccess){if(typeof onSuccess=="function"){this.request('GET','/settings/',null,{onSuccess:onSuccess,evalJSON:true});}},getSetting:function(name,onSuccess){if(typeof onSuccess=="function"){this.request('GET','/settings/'+name,null,{onSuccess:onSuccess});}},setSetting:function(name,value,onSuccess){var settings={};settings[name]=value;this.setSettings(settings,(onSuccess||function(){}));},setSettings:function(settings,onSuccess){this.request('POST','/settings/',dojo.objectToQuery(settings),{onSuccess:(onSuccess||function(){})});},unsetSetting:function(name,onSuccess){this.request('DELETE','/settings/'+name,null,{onSuccess:(onSuccess||function(){})});},fileTemplate:function(project,path,templateOptions,opts){var url=bespin.util.path.combine('/file/template',project,path);this.request('PUT',url,dojo.toJson(templateOptions),opts||{});},projectTemplate:function(project,templateOptions,opts){var url=bespin.util.path.combine('/project/template/',project,"");this.request('POST',url,dojo.toJson(templateOptions),opts||{});},lost:function(values,opts){opts=opts||{};var url='/register/lost/';this.request('POST',url,dojo.objectToQuery(values),opts);},changePassword:function(username,newPassword,verifyCode,opts){var url="/register/password/"+username;opts=opts||{};var query={newPassword:newPassword,code:verifyCode};this.request('POST',url,dojo.objectToQuery(query),opts);},rescan:function(project,instruction,opts){this.requestDisconnected('POST','/project/rescan/'+escape(project),{},instruction,opts);}});
dojo.provide("bespin.client.session");dojo.declare("bespin.client.session.EditSession",null,{constructor:function(editor){this.editor=editor;this.currentState=this.mobwriteState.stopped;this.bailingOutOfCollaboration=false;var self=this;this.fileHistory=[];this.fileHistoryIndex=-1;this.reportCollaborators([]);bespin.fireAfter(["settings:loaded"],function(){bespin.subscribe("settings:set:collaborate",function(ev){if(!window.mobwrite){return;}
if(bespin.get("settings").isOn(ev.value)){if(self.bailingOutOfCollaboration){return;}
if(editor.dirty){var msg="Collaboration enabled on edited file.\n"+"To avoid losing changes, save before collaborating.\n"+"Save now?";var reply=confirm(msg);if(reply){var onSuccess=function(){self.startSession(self.project,self.path);};editor.saveFile(self.project,self.path,onSuccess);}else{self.bailingOutOfCollaboration=true;bespin.get("settings").set("collaborate","off");self.bailingOutOfCollaboration=false;var commandLine=bespin.get("commandLine");commandLine.addOutput("Reverting the following collaboration setting:");setTimeout(function(){commandLine.showHint("Collaborate is off");},10);}}else{self.startSession(self.project,self.path);}}else{self.stopSession();}});});},goToPreviousFile:function(){if(this.fileHistoryIndex!=0){this.fileHistoryIndex--;this.openFromHistory();}},goToNextFile:function(){if(this.fileHistoryIndex!=this.fileHistory.length-1){this.fileHistoryIndex++;this.openFromHistory();}},openFromHistory:function(){var historyItem=this.fileHistory[this.fileHistoryIndex];bespin.get("editor").saveFile();this.editor.openFile(historyItem.project,historyItem.filename,{fromFileHistory:true});},addFileToHistory:function(newItem){this.fileHistoryIndex++;var end=this.fileHistory.length-this.fileHistoryIndex;this.fileHistory.splice(this.fileHistoryIndex,end,newItem);},mobwriteState:{stopped:0,starting:1,running:2},setUserinfo:function(userinfo){this.username=userinfo.username;this.amountUsed=userinfo.amountUsed;this.quota=userinfo.quota;},checkSameFile:function(project,path){return((this.project==project)&&(this.path==path));},setProject:function(project){this.project=project;},setProjectPath:function(project,path){this.project=project;this.path=path;},startSession:function(project,path,onSuccess,onFailure){if(this.currentState==this.mobwriteState.starting){console.warn("Asked to start in the middle of starting. this.shareNode=",this.shareNode);return;}
if(this.shareNode){this.stopSession();}
this.editor.model.insertDocument("");this.editor.moveCursor({row:0,col:0});this.editor.setSelection(null);this.editor.setReadOnly(true);if(project!==undefined)this.project=project;if(path!==undefined)this.path=path;this.currentState=this.mobwriteState.starting;var self=this;var onFirstSync=function(){this.editor.setReadOnly(false);if(dojo.isFunction(onSuccess)){onSuccess({name:self.path,timestamp:new Date().getTime()});}
self.currentState=self.mobwriteState.running;};this.shareNode=new bespin.client.session.ShareNode(this,onFirstSync);mobwrite.share(this.shareNode);},stopSession:function(){if(this.currentState==this.mobwriteState.starting){console.error("Asked to stop in the middle of starting. I can't let you do that Dave.");return;}
if(this.currentState==this.mobwriteState.running){mobwrite.unshare(this.shareNode);this.currentState=this.mobwriteState.stopped;this.shareNode=null;this.reportCollaborators([]);}},reportCollaborators:function(userEntries){var collabList=dojo.byId("collab_list");if(!collabList){return;}
var self=this;var users={};var userCount=0;userEntries.forEach(function(userEntry){var parts=userEntry.split(":");var username=parts[0];var user=users[username];if(!user){user={username:username,windows:[],status:""};users[username]=user;userCount++;}
user.windows.push({address:parts[1],id:parts[2]});});var maxInLargeMode=10;dojo.empty(collabList);for(var username in users){if(users.hasOwnProperty(username)){var user=users[username];var extra="";if(user.windows.length>1){extra+=" <small>("+user.windows.length+")</small>";}
var compact=userCount>maxInLargeMode;var title=user.windows.length+" window"+
(user.windows.length>1?"s":"");user.windows.forEach(function(window){title+=", "+window.address;});if(compact){title+=". Status: "+user.status;}
var parent=dojo.create("div",{style:{marginLeft:"10px",height:(compact?"24px":"48px")},title:title},collabList);var icon=dojo.create("img",{src:"../images/collab_icn_user.png",style:{"float":"left",margin:"4px 8px 0px 8px",height:(compact?"20px":"32px"),width:(compact?"20px":"32px")}},parent);dojo.create("div",{className:'collab_name',innerHTML:username+extra},parent);if(!compact){dojo.create("div",{className:'collab_description',innerHTML:user.status},parent);}}}
var stopped=(this.currentState===this.mobwriteState.stopped);dojo.style("collab_off","display",stopped?"block":"none");dojo.style("collab_on","display",stopped?"none":"block");if(stopped){dojo.attr("toolbar_collaboration","src","images/icn_collab_off.png");}else{if(userEntries.length>1){dojo.attr("toolbar_collaboration","src","images/icn_collab_on.png");}else{dojo.attr("toolbar_collaboration","src","images/icn_collab_watching.png");}}},getStatus:function(){var file=this.path||'a new scratch file';return'Hey '+this.username+', you are editing '+file+' in project '+this.project;}});dojo.declare("bespin.client.session.ShareNode",null,{constructor:function(session,onFirstSync){this.session=session;this.editor=session.editor;this.onFirstSync=onFirstSync;this.username=session.username||"[none]";var project=session.project;var path=session.path;if(path.indexOf("/")!=0){path="/"+path;}
parts=project.split("+");if(parts.length==1){this.id=this.username+"/"+project+path;}
else{this.id=parts[0]+"/"+parts[1]+path;}},setShareObj:function(shareObj){this.shareObj=shareObj;},isShareNode:true,reportCollaborators:function(userEntries){this.session.reportCollaborators(userEntries);},raiseError:function(text,recoverable){if(!text){text="(No server error message)";}
var prefix="<strong>"+(recoverable?"":"Fatal ")+"Collaboration Error</strong>: ";var suffix="<br/><strong>Warning</strong>: Changes to this file could be lost";var commandLine=bespin.get("commandLine");if(commandLine){commandLine.showHint(prefix+text+suffix);}else{console.error("Missing commandLine to report: "+text);}
if(!recoverable){this.editor.setReadOnly(true);}},getClientText:function(allowUnsynced){if(!allowUnsynced&&this.onFirstSync){console.trace();throw new Error("Attempt to getClientText() before onFirstSync() called.");}
return this.editor.model.getDocument();},syncWithoutChange:function(){this.checkFirstSyncDone();},setClientText:function(text){var cursor=this.captureCursor();this.editor.model.insertDocument(text);this.restoreCursor(cursor);this.checkFirstSyncDone();},setReadOnly:function(readonly){console.log("setReadOnly",readonly);this.editor.setReadOnly(readonly);},patchClientText:function(patches){this.shareObj.dmp.Match_Distance=1000;this.shareObj.dmp.Match_Threshold=0.6;var oldClientText=this.getClientText(true);var cursor=this.captureCursor();var offsets=[];if(cursor){offsets[0]=cursor.startOffset;if('endOffset'in cursor){offsets[1]=cursor.endOffset;}}
var newClientText=this.patchApply(patches,oldClientText,offsets);if(oldClientText!=newClientText){this.editor.model.insertDocument(newClientText);if(cursor){cursor.startOffset=offsets[0];if(offsets.length>1){cursor.endOffset=offsets[1];if(cursor.startOffset>=cursor.endOffset){cursor.collapsed=true;}}
this.restoreCursor(cursor);}}
this.checkFirstSyncDone();},patchApply:function(patches,text,offsets){if(patches.length==0){return text;}
patches=this.shareObj.dmp.patch_deepCopy(patches);var nullPadding=this.shareObj.dmp.patch_addPadding(patches);text=nullPadding+text+nullPadding;this.shareObj.dmp.patch_splitMax(patches);var delta=0;for(var x=0;x<patches.length;x++){var expected_loc=patches[x].start2+delta;var text1=this.shareObj.dmp.diff_text1(patches[x].diffs);var start_loc=this.shareObj.dmp.match_main(text,text1,expected_loc);if(start_loc==-1){if(mobwrite.debug){window.console.warn('Patch failed: '+patches[x]);}}else{delta=start_loc-expected_loc;var text2=text.substring(start_loc,start_loc+text1.length);var diffs=this.shareObj.dmp.diff_main(text1,text2,false);var index1=0;var index2;for(var y=0;y<patches[x].diffs.length;y++){var mod=patches[x].diffs[y];if(mod[0]!==DIFF_EQUAL){index2=this.shareObj.dmp.diff_xIndex(diffs,index1);}
if(mod[0]===DIFF_INSERT){text=text.substring(0,start_loc+index2)+mod[1]+
text.substring(start_loc+index2);for(var i=0;i<offsets.length;i++){if(offsets[i]+nullPadding.length>start_loc+index2){offsets[i]+=mod[1].length;}}}else if(mod[0]===DIFF_DELETE){var del_start=start_loc+index2;var del_end=start_loc+this.shareObj.dmp.diff_xIndex(diffs,index1+mod[1].length);text=text.substring(0,del_start)+text.substring(del_end);for(var i=0;i<offsets.length;i++){if(offsets[i]+nullPadding.length>del_start){if(offsets[i]+nullPadding.length<del_end){offsets[i]=del_start-nullPadding.length;}else{offsets[i]-=del_end-del_start;}}}}
if(mod[0]!==DIFF_DELETE){index1+=mod[1].length;}}}}
text=text.substring(nullPadding.length,text.length-nullPadding.length);return text;},checkFirstSyncDone:function(){if(this.onFirstSync){this.onFirstSync();delete this.onFirstSync;}},getMetaData:function(){var data={cursor:this.captureSimpleCursor()};return dojo.toJson(data);},captureSimpleCursor:function(){var selection=this.editor.getSelection();var cursor=this.editor.getCursorPos();var start=selection?selection.startPos:cursor;var end=selection?selection.endPos:cursor;return{startOffset:this.convertRowColToOffset(start),endOffset:this.convertRowColToOffset(end)};},captureCursor:function(){var padLength=this.shareObj.dmp.Match_MaxBits/2;var text=this.editor.model.getDocument();var cursor=this.captureSimpleCursor();cursor.startPrefix=text.substring(cursor.startOffset-padLength,cursor.startOffset);cursor.startSuffix=text.substring(cursor.startOffset,cursor.startOffset+padLength);cursor.collapsed=(cursor.startOffset==cursor.endOffset);if(!cursor.collapsed){cursor.endPrefix=text.substring(cursor.endOffset-padLength,cursor.endOffset);cursor.endSuffix=text.substring(cursor.endOffset,cursor.endOffset+padLength);}
var ui=this.editor.ui;cursor.scrollTop=ui.yoffset/ui.yscrollbar.extent;cursor.scrollLeft=ui.xoffset/ui.xscrollbar.extent;return cursor;},restoreCursor:function(cursor){var dmp=this.shareObj.dmp;dmp.Match_Distance=1000;dmp.Match_Threshold=0.9;var padLength=dmp.Match_MaxBits/2;var newText=this.editor.model.getDocument();var pattern1=cursor.startPrefix+cursor.startSuffix;var pattern2,diff;var cursorStartPoint=dmp.match_main(newText,pattern1,cursor.startOffset-padLength);if(cursorStartPoint!==null){pattern2=newText.substring(cursorStartPoint,cursorStartPoint+pattern1.length);diff=dmp.diff_main(pattern1,pattern2,false);cursorStartPoint+=dmp.diff_xIndex(diff,cursor.startPrefix.length);}
var cursorEndPoint=null;if(!cursor.collapsed){pattern1=cursor.endPrefix+cursor.endSuffix;var cursorEndPoint=dmp.match_main(newText,pattern1,cursor.endOffset-padLength);if(cursorEndPoint!==null){pattern2=newText.substring(cursorEndPoint,cursorEndPoint+pattern1.length);diff=dmp.diff_main(pattern1,pattern2,false);cursorEndPoint+=dmp.diff_xIndex(diff,cursor.endPrefix.length);}}
if(cursorStartPoint===null&&cursorEndPoint!==null){cursorStartPoint=cursorEndPoint;}else if(cursorStartPoint===null&&cursorEndPoint===null){cursorStartPoint=cursor.startOffset;}
if(cursorEndPoint===null){cursorEndPoint=cursorStartPoint;}
var startPos=this.convertOffsetToRowCol(cursorStartPoint);this.editor.moveCursor(startPos);var selectionPos=null;if(cursorEndPoint!=cursorStartPoint){selectionPos={startPos:startPos,endPos:this.convertOffsetToRowCol(cursorEndPoint)};}
this.editor.setSelection(selectionPos);var ui=this.editor.ui;ui.yscrollbar.setValue(-(cursor.scrollTop*ui.yscrollbar.extent));ui.xscrollbar.setValue(-(cursor.scrollLeft*ui.xscrollbar.extent));},convertRowColToOffset:function(pos){var offset=0;var rows=this.editor.model.rows;for(var i=0;i<pos.row;i++){if(i>=rows.length){console.warn("Cursor positioned outside the editor document. Assuming end. pos=",pos,"rows.length=",rows.length);break;}
offset+=rows[i].length+1;}
offset+=pos.col;return offset;},convertOffsetToRowCol:function(offset){var pos={row:0,col:0};var rows=this.editor.model.rows;while(true){var len=rows[pos.row].length;if(offset<=len){pos.col=offset;break;}
offset-=len+1;pos.row+=1;if(pos.row>=rows.length){console.warn("convertOffsetToRowCol(",offset,") has run out of editor characters.");pos.row-=1;pos.col=rows[pos.row].length;break;}}
return pos;}});
dojo.provide("bespin.worker.worker");(function(){var WORKER_COUNT=1;var WORKER_INDEX=0;var CALL_INDEX=0;var USE_GEARS=false;var JS_WORKER_SOURCE="js/bespin/bootstrap_worker.js";var uriEncodeSource=function(source){return JS_WORKER_SOURCE+"#"+escape(source);};var uriDecodeSource=function(uri){return unescape(uri.substr((JS_WORKER_SOURCE+"#").length));};Worker=undefined;dojo.declare("bespin.worker.WorkerFacade",null,{constructor:function(obj,workerCount,libs){this.__obj__=obj;var callbacks={};this.__callbacks__=callbacks;this.__workerCount__=workerCount||WORKER_COUNT;this.__hasWorkers__=false;if(typeof Worker!="undefined"){this.__hasWorkers__=true;var source=this.createWorkerSource(obj,libs);var workers=this.createWorkers(source);this.__workers__=workers;}
this.createFacade(obj);},__getWorker__:function(){var index=WORKER_INDEX++%this.__workerCount__;return this.__workers__[index];},createWorkers:function(source){var self=this;var workers=[];var cb=function(event){var data=event.data;if(typeof data=="string"){data=dojo.fromJson(data);}
var index=data.callIndex;var callback=self.__callbacks__[index];delete self.__callbacks__[index];if(callback){callback(data.returnValue);}};var loadScript=function(index,url){var worker=this;bespin.get("server").request('GET',url,null,{onSuccess:function(src){worker.postMessage("__IMPORT_SCRIPT__//"+index+"\n"+src);}});};for(var i=0;i<this.__workerCount__;i++){var worker=new Worker("/js/bespin/bootstrap_worker.js",source);var onmessage=function(event){var message=event.data;if(typeof message=="string"){if(message.indexOf("log=")==0){console.log("From Worker: "+message.substr(4));return}
else
if(message.indexOf("__IMPORT_SCRIPT__")==0){var json=message.substr("__IMPORT_SCRIPT__".length);var paras=dojo.fromJson(json);loadScript.apply(this,paras);return;}
else{message=dojo.fromJson(message);}}
if(message.type=="subscribe"){(function(){var index=message.index;var name=message.name;bespin.subscribe(name,function(event){var ret={index:index,name:name,event:event};worker.postMessage(USE_GEARS?ret:dojo.toJson(ret));});})();}
else if(message.type=="publish"){bespin.publish(message.name,message.event);}
else{throw message;cb.call(this,event);}};worker.onmessage=onmessage;source="// YOUcannotGuessMe\n"+source;window.setTimeout(function(){worker.postMessage(source);},0);workers.push(worker);}
return workers;},createFacade:function(obj){var facade=this;for(var prop in obj){if(prop.charAt(0)!="_"){(function(){var val=obj[prop];var method=prop;if(typeof val=="function"){facade[prop]=function(){var self=this;var index=CALL_INDEX++;var paras=Array.prototype.slice.call(arguments);if(this.__hasWorkers__){var data={callIndex:index,method:method,paras:paras};if(!USE_GEARS){data=dojo.toJson(data);}
this.__getWorker__().postMessage(data);}else{var self=this;window.setTimeout(function(){var retVal=self.__obj__[method].apply(self.__obj__,paras);var callback=self.__callbacks__[index];delete self.__callbacks__[index];if(callback){callback(retVal);}},0);}
return{and:function(context,mutex,paras,callback){var func=arguments[arguments.length-1];if(mutex instanceof bespin.worker.Mutex){mutex.start();func=function(){callback.apply(this,arguments);mutex.stop();};}
self.__callbacks__[index]=function(){paras=Array.prototype.slice.call(arguments).concat(paras);func.apply(context,paras);};}};};}
else{}})();}}},hasFunctions:function(obj){for(var i in obj){var val=obj[i];if(typeof val=="function"){return true;}
if(val&&typeof val=="object"){if(this.hasFunctions(val)){return true;}}}
return false;},serializeToPortableSource:function(obj){var self=this;var isArray=dojo.isArray(obj);var source=isArray?"[\n":"{\n";for(var prop in obj){(function(){if(prop=="_constructor"){return;}
var val=obj[prop];var method=prop;var src="";if(typeof val=="function"){src=val.toString();}
else if(val&&typeof val=="object"&&self.hasFunctions(val)){src=self.serializeToPortableSource(val);}
else{src=dojo.toJson(val);}
prop='"'+prop.replace(/"/g,'\\"','g')+'"';source+=isArray?"":prop+": ";source+=src+",\n";})();}
source+=isArray?"]\n":"}\n";return source;},createWorkerSource:function(obj,libs){var con=function(msg){postMessage("log="+msg);};var source="";if(libs){var quoted=[];dojo.forEach(libs,function(lib){quoted.push("'"+lib+"'");});source+="importScripts("+quoted.join(", ")+");\n";}
source+="var theObject = "+this.serializeToPortableSource(obj);return source;}});dojo.declare("bespin.worker.Mutex",null,{constructor:function(name,options){this.name=name;this.count=0;this.afterJobs=[];this.options=options||{};},start:function(){this.count=this.count+1;},stop:function(){this.count=this.count-1;if(this.count==0){if(this.options.onlyLast){var last=this.afterJobs[this.afterJobs.length-1];if(last){last();}}else{for(var i=0;i<this.afterJobs.length;++i){var job=this.afterJobs[i];job();}}
this.afterJobs=[];}},after:function(context,func){this.afterJobs.push(function(){func.call(context);});}});function BespinGearsInitializeGears(){if(window.google&&google.gears){return;}
var factory=null;if(typeof GearsFactory!='undefined'){factory=new GearsFactory();}else{try{factory=new ActiveXObject('Gears.Factory');if(factory.getBuildInfo().indexOf('ie_mobile')!=-1){factory.privateSetGlobalObject(this);}}catch(e){if(navigator.mimeTypes["application/x-googlegears"]){factory=document.createElement("object");factory.style.display="none";factory.width=0;factory.height=0;factory.type="application/x-googlegears";document.documentElement.appendChild(factory);}}}
if(!factory){return;}
if(!window.google){google={};}
if(!google.gears){google.gears={factory:factory};}}})();
dojo.provide("bespin.editor.actions");dojo.declare("bespin.editor.Actions",null,{constructor:function(editor){this.editor=editor;this.model=this.editor.model;this.cursorManager=this.editor.cursorManager;this.ignoreRepaints=false;this.currentEditItem=undefined;this.editDepth=0;},beginEdit:function(name){if(this.editDepth==0){this.currentEditItem=new bespin.editor.ActionHistoryItem(name,this.editor);this.currentEditItem.begin();}
this.editDepth++;},endEdit:function(){if(this.editDepth<=0)
return;this.editDepth--;if(this.editDepth==0){this.currentEditItem.end();this.editor.historyManager.add(this.currentEditItem);this.currentEditItem=undefined;bespin.publish("editor:document:changed");}},handleCursorSelection:function(args){if(args.event.shiftKey){if(!this.editor.selection)this.editor.setSelection({startPos:bespin.editor.utils.copyPos(args.pos)});this.editor.setSelection({startPos:this.editor.selection.startPos,endPos:bespin.editor.utils.copyPos(this.cursorManager.getCursorPosition())});}else{this.editor.setSelection(undefined);}},moveCursor:function(moveType,args){var posData=this.cursorManager[moveType](args);this.handleCursorSelection(args);this.repaint();args.pos=posData.newPos;return args;},moveCursorLeft:function(args){return this.moveCursor("moveLeft",args);},moveCursorRight:function(args){return this.moveCursor("moveRight",args);},moveCursorUp:function(args){return this.moveCursor("moveUp",args);},moveCursorDown:function(args){return this.moveCursor("moveDown",args);},moveToLineStart:function(args){return this.moveCursor("moveToLineStart",args);},moveToLineEnd:function(args){return this.moveCursor("moveToLineEnd",args);},moveToFileTop:function(args){return this.moveCursor("moveToTop",args);},moveToFileBottom:function(args){return this.moveCursor("moveToBottom",args);},movePageUp:function(args){return this.moveCursor("movePageUp",args);},movePageDown:function(args){return this.moveCursor("movePageDown",args);},moveWordLeft:function(args){return this.moveCursor("smartMoveLeft",args);},moveWordRight:function(args){return this.moveCursor("smartMoveRight",args);},deleteWordLeft:function(args){this.beginEdit("deleteWordLeft");this.deleteChunk({endPos:args.pos,pos:this.moveCursor("smartMoveLeft",args).pos});this.endEdit();return args;},deleteWordRight:function(args){this.beginEdit("deleteWordRight");this.deleteChunk({pos:args.pos,endPos:this.moveCursor("smartMoveRight",args).pos});this.endEdit();return args;},applyState:function(state)
{if(this.testHistory.length==0){return;}else if(state<0){state=-1;}else if(state>=this.testHistory.length){return;}
this.testHistoryPosition=state;var item=this.testHistory[Math.max(0,this.testHistoryPosition)];var modelState=item.after;var editorState=item.uiAfter;if(state<0)
{modelState=item.before;editorState=item.uiBefore;}
this.model.applyState(modelState);this.editor.setState(editorState);},undo:function(){this.editor.historyManager.undo();},redo:function(){this.editor.historyManager.redo();},selectAll:function(args){if(this.model.isEmpty())return;args.startPos={row:0,col:0};args.endPos={row:this.model.getRowCount()-1,col:this.editor.ui.getRowScreenLength(this.model.getRowCount()-1)};this.select(args);},select:function(args){if(args.startPos){this.editor.setSelection({startPos:args.startPos,endPos:args.endPos});this.cursorManager.moveCursor(args.endPos);}else{this.editor.setSelection(undefined);}},insertTab:function(args){if(this.editor.readonly)return;var settings=bespin.get("settings");if(this.editor.getSelection()&&!args.undoInsertTab){this.indent(args);return;}
var tab=args.tab;var tablength=this.cursorManager.getCharacterLength("\t");if(!tab||!tablength){if(settings&&settings.isSettingOn('tabmode')){tab="\t";}else{tab="";var tabSizeCount=tablength;while(tabSizeCount-->0){tab+=" ";}
tablength=tab.length;}}
this.beginEdit("insertTab");delete this.editor.selection;this.model.insertCharacters(this.cursorManager.getModelPosition({row:args.pos.row,col:args.pos.col}),tab);this.cursorManager.moveCursor({row:args.pos.row,col:args.pos.col+tablength});this.repaint();this.endEdit();},indent:function(args){var settings=bespin.get('settings');var selection=this.editor.getSelection();var startRow=selection.startPos.row;var endRow=selection.endPos.row;var endRowLength=this.cursorManager.getStringLength(this.model.getRowArray(endRow).join(""));var cursorRowLength=this.cursorManager.getStringLength(this.model.getRowArray(args.pos.row).join(""));var charsToInsert;var tab='';if(settings&&settings.isSettingOn('tabmode')){tab="\t";}else{var tabsize=this.editor.getTabSize();while(tabsize-->0){tab+=" ";}}
this.beginEdit("indent");for(var y=startRow;y<=endRow;y++){if(tab!='\t'){charsToInsert=this.cursorManager.getLeadingWhitespace(y);charsToInsert=this.cursorManager.getNextTablevelRight(charsToInsert)-charsToInsert;charsToInsert=tab.substring(0,charsToInsert);}else{charsToInsert='\t';}
this.model.insertCharacters(this.cursorManager.getModelPosition({row:y,col:0}),charsToInsert);}
var delta=this.cursorManager.getStringLength(this.model.getRowArray(args.pos.row).join(""))-cursorRowLength;selection.endPos.col+=this.cursorManager.getStringLength(this.model.getRowArray(endRow).join(""))-endRowLength;this.editor.setSelection(selection);this.cursorManager.moveCursor({col:args.pos.col+delta});this.repaint();this.endEdit();},unindent:function(args){var selection=this.editor.getSelection();var startRow=selection.startPos.row;var endRow=selection.endPos.row;var endRowLength=this.cursorManager.getStringLength(this.model.getRowArray(endRow).join(""));var row=false;var charsToDelete;var charsWidth;this.beginEdit("unindent");for(var y=startRow;y<=endRow;y++){row=this.model.getRowArray(y);if(row.length>0&&row[0]=='\t'){charsToDelete=1;charsWidth=this.editor.getTabSize();}else{var leadingWhitespaceLength=this.cursorManager.getLeadingWhitespace(y);charsToDelete=this.cursorManager.getContinuousSpaceCount(0,this.editor.getTabSize(),y);charsWidth=charsToDelete;}
if(charsToDelete){this.model.deleteCharacters(this.cursorManager.getModelPosition({row:y,col:0}),charsToDelete);}
if(y==startRow){selection.startPos.col=Math.max(0,selection.startPos.col-charsWidth);}
if(y==endRow){if(!row)row=this.model.getRowArray(y);var delta=endRowLength-this.cursorManager.getStringLength(row.join(""));selection.endPos.col=Math.max(0,selection.endPos.col-delta);args.pos.col=Math.max(0,args.pos.col-delta);}}
this.editor.setSelection(selection);this.cursorManager.moveCursor({col:args.pos.col});this.repaint();this.endEdit();},cutSelection:function(args){if(this.editor.readonly)return;this.beginEdit('cut');this.copySelection(args);this.deleteSelection(args);this.endEdit();},copySelection:function(args){var selectionObject=this.editor.getSelection();if(selectionObject){var selectionText=this.model.getChunk(selectionObject);if(selectionText){bespin.editor.clipboard.Manual.copy(selectionText);}}},pasteFromClipboard:function(args){if(this.editor.readonly)return;var clipboard=(args.clipboard)?args.clipboard:bespin.editor.clipboard.Manual.data();if(clipboard===undefined)return;args.chunk=clipboard;this.beginEdit('paste');this.insertChunk(args);this.endEdit();},insertChunk:function(args){if(this.editor.readonly)return;this.beginEdit("insertChunk");if(this.editor.selection){this.deleteSelection();}
var pos=bespin.editor.utils.copyPos(this.cursorManager.getCursorPosition());pos=this.model.insertChunk(this.cursorManager.getModelPosition(pos),args.chunk);pos=this.cursorManager.getCursorPosition(pos);this.cursorManager.moveCursor(pos);this.repaint();this.endEdit();return pos;},deleteChunk:function(args){if(this.editor.readonly)return;this.beginEdit("deleteChunk");var startPos=(args.startPos!=undefined)?args.startPos:bespin.editor.utils.copyPos(args.pos);var selection=this.editor.getSelection({startPos:startPos,endPos:args.endPos});var chunk=this.model.deleteChunk(selection);this.cursorManager.moveCursor(selection.startPos);this.editor.setSelection(undefined);this.repaint();this.endEdit();return selection.startPos;},joinLine:function(args){if(this.editor.readonly)return;this.beginEdit("joinLine");if(args.joinDirection=="up"){if(args.pos.row==0)return;var newcol=this.editor.ui.getRowScreenLength(args.pos.row-1);this.model.joinRow(args.pos.row-1);this.cursorManager.moveCursor({row:args.pos.row-1,col:newcol});}else{if(args.pos.row>=this.model.getRowCount()-1)return;this.model.joinRow(args.pos.row);}
this.endEdit();this.repaint();},killLine:function(args){if(this.editor.readonly)return;this.beginEdit("killLine");this.editor.setSelection({startPos:{row:args.pos.row,col:0},endPos:{row:args.pos.row+1,col:0}});this.cutSelection(args);this.endEdit();},deleteSelection:function(args){if(this.editor.readonly)
return;var selection=this.editor.getSelection();return this.deleteChunk({startPos:selection.startPos,endPos:selection.endPos,clearSelection:true});},backspace:function(args){if(this.editor.readonly)return;this.beginEdit("backspace");if(this.editor.selection){this.deleteSelection(args);}else{if(args.pos.col>0){var settings=bespin.get('settings');if(settings&&settings.isSettingOn('smartmove')){var tabsize=this.editor.getTabSize();var freeSpaces=this.cursorManager.getContinuousSpaceCount(args.pos.col,this.cursorManager.getNextTablevelLeft(args.pos.col));if(freeSpaces==tabsize){var pos=args.pos;this.editor.selection={startPos:{row:pos.row,col:pos.col-tabsize},endPos:{row:pos.row,col:pos.col}};this.deleteSelection(args);this.endEdit();return;}}
this.cursorManager.moveCursor({col:Math.max(0,args.pos.col-1)});args.pos.col-=1;this.deleteCharacter(args);}else{args.joinDirection="up";this.joinLine(args);}}
this.endEdit();},deleteKey:function(args){if(this.editor.readonly)return;this.beginEdit("deleteKey");if(this.editor.selection){this.deleteSelection(args);}else{if(args.pos.col<this.editor.ui.getRowScreenLength(args.pos.row)){var settings=bespin.get('settings');if(settings&&settings.isSettingOn('smartmove')){var tabsize=this.editor.getTabSize();var freeSpaces=this.cursorManager.getContinuousSpaceCount(args.pos.col,this.cursorManager.getNextTablevelRight(args.pos.col));if(freeSpaces==tabsize){var pos=args.pos;this.editor.selection={startPos:{row:pos.row,col:pos.col},endPos:{row:pos.row,col:pos.col+tabsize}};this.deleteSelection(args);this.endEdit();return;}}
this.deleteCharacter(args);}else{args.joinDirection="down";this.joinLine(args);}}
this.endEdit();},deleteCharacter:function(args){if(this.editor.readonly)return;if(args.pos.col<this.editor.ui.getRowScreenLength(args.pos.row)){this.beginEdit("deleteCharacter");var modelPos=this.cursorManager.getModelPosition(args.pos);var length=1;var deleted=this.model.deleteCharacters(modelPos,length);this.repaint();this.endEdit();}},newline:function(args){if(this.editor.readonly)return;var settings=bespin.get("settings");if(settings&&settings.isSettingOn('autoindent')){var autoindent=bespin.util.leadingWhitespace(this.model.getRowArray(args.pos.row));}else{var autoindent=[];}
args.chunk="\n"+autoindent.join("");this.insertChunk(args);},newlineBelow:function(args){this.newline(this.moveToLineEnd(args));},insertCharacter:function(args){if(this.editor.readonly)return;this.beginEdit("insertCharacter");var pos=args.pos;if(this.editor.selection){pos=this.deleteSelection(args);}
this.model.insertCharacters(this.cursorManager.getModelPosition(pos),args.newchar);this.cursorManager.moveRight(true);var settings=bespin.get('settings');if(settings&&settings.isSettingOn('closepairs')){switch(args.newchar){case'(':this.model.insertCharacters(this.cursorManager.getModelPosition(),')');break;case'[':this.model.insertCharacters(this.cursorManager.getModelPosition(),']');break;case'{':this.model.insertCharacters(this.cursorManager.getModelPosition(),'}');break;case'<':break;case'"':break;case"'":break;}}
this.repaint();this.endEdit();},moveCursorRowToCenter:function(args){var saveCursorRow=this.editor.getCursorPos().row;var halfRows=Math.floor(this.editor.ui.visibleRows/2);if(saveCursorRow>(this.editor.ui.firstVisibleRow+halfRows)){this.cursorManager.moveCursor({row:this.editor.getCursorPos().row+halfRows});}else{this.cursorManager.moveCursor({row:this.editor.getCursorPos().row-halfRows});}
this.editor.ui.ensureCursorVisible();this.cursorManager.moveCursor({row:saveCursorRow});},getOppositeCase:function(stringCase){if(!stringCase)return undefined;switch(stringCase){case'u':return'l';break;case'l':return'u';break;}},selectionChangeCase:function(args){if(this.editor.readonly)return;if(this.editor.selection){this.beginEdit("selectionChangeCase");if(!args.selectionObject){args.selectionObject=this.editor.getSelection();}
var selection=this.model.getChunk(args.selectionObject);var stringArray=selection.split("\n");for(i in stringArray){switch(args.stringCase){case'l':stringArray[i]=stringArray[i].toLowerCase();break;case'u':stringArray[i]=stringArray[i].toUpperCase();break;}}
var outText=stringArray.join("\n");this.model.deleteChunk(args.selectionObject);this.model.insertChunk(args.selectionObject.startModelPos,outText);this.select(args.selectionObject);this.endEdit();}},startSearch:function(str,displayType,shiftKey){if(str==''){this.editor.ui.setSearchString(false);this.editor.paint(true);dojo.byId('searchresult').style.display='none';return false;}
if(str==this.editor.ui.searchString&&displayType=='toolbar'){if(!shiftKey){this.findNext();}else{this.findPrev();}
dojo.byId('searchresult').style.display='block';return;}
this.editor.ui.setSearchString(str);var count=this.editor.model.getCountOfString(str);if(count!=0){var pos=bespin.editor.utils.copyPos(this.editor.cursorManager.getCursorPosition());if(!this.editor.ui.actions.findNext(null,true)){this.editor.cursorManager.moveCursor({col:0,row:0});this.editor.ui.actions.findNext();}}
switch(displayType){case'commandLine':var msg="Found "+count+" match";if(count>1){msg+='es';}
msg+=" for your search for <em>"+str+"</em>";bespin.get('commandLine').showHint(msg);break;case'searchwindow':var filesearch=bespin.get('filesearch');if(filesearch){filesearch.setMatchesCount(count);}
break;case'toolbar':var msg=+count+" Match";if(count>1){msg+='es';}
dojo.byId('searchfeedback').innerHTML=msg;dojo.byId('searchresult').style.display='block';break;}
this.editor.paint(true);},findNext:function(event,canBeSamePosition){if(!this.editor.ui.searchString)return;var pos=bespin.editor.utils.copyPos(this.cursorManager.getModelPosition());var sel=this.editor.getSelection();if(canBeSamePosition&&sel!==undefined){pos.col-=sel.endModelPos.col-sel.startModelPos.col+1;}
var found=this.model.findNext(pos.row,pos.col,this.editor.ui.searchString);if(!found)found=this.model.findNext(0,0,this.editor.ui.searchString);if(found){this.editor.setSelection({startPos:this.cursorManager.getCursorPosition(found.startPos),endPos:this.cursorManager.getCursorPosition(found.endPos)});this.cursorManager.moveCursor(this.cursorManager.getCursorPosition(found.endPos));this.editor.ui.ensureCursorVisible(true);this.repaint();return true;}else{return false;}},findPrev:function(){if(!this.editor.ui.searchString)return;var pos=this.cursorManager.getModelPosition();var found=this.model.findPrev(pos.row,pos.col,this.editor.ui.searchString);if(!found){var lastRow=this.model.getRowCount()-1;found=this.model.findPrev(lastRow,this.model.getRowArray(lastRow).length-1,this.editor.ui.searchString);}
if(found){this.editor.setSelection({startPos:this.cursorManager.getCursorPosition(found.startPos),endPos:this.cursorManager.getCursorPosition(found.endPos)});this.cursorManager.moveCursor(this.cursorManager.getCursorPosition(found.endPos));this.editor.ui.ensureCursorVisible(true);this.repaint();return true;}else{return false;}},escape:function(){bespin.publish("ui:escape");if(this.editor.ui.searchString){this.editor.ui.setSearchString(false);}},toggleQuickopen:function(){var quickopen=bespin.get('quickopen');if(quickopen){quickopen.toggle();}},togglePieMenu:function(){bespin.getComponent('piemenu',function(piemenu){piemenu.toggle();});},focusCommandline:function(){bespin.getComponent("popup",function(popup){popup.show("output");});},focusFileBrowser:function(){bespin.getComponent("popup",function(popup){popup.show("files");});},repaint:function(){if(!this.ignoreRepaints){this.editor.ui.ensureCursorVisible();this.editor.paint();}},replace:function(args){this.beginEdit("replace");this.editor.model.replace(args.search,args.replace);this.repaint();this.endEdit();},gotoLine:function(){bespin.getComponent("commandLine",function(cli){cli.setCommandText("goto ");bespin.getComponent("popup",function(popup){popup.show("output");});});},cmdFilesearch:function(){bespin.getComponent("commandLine",function(cli){cli.setCommandText("search ");bespin.getComponent("popup",function(popup){popup.show("output");});});},previousFile:function(){bespin.get('editSession').goToPreviousFile();},nextFile:function(){bespin.get('editSession').goToNextFile();},nop:function(){}});dojo.declare("bespin.editor.ActionHistoryItem",null,{constructor:function(name,editor){this.editor=editor;},begin:function(editor,model)
{this.startIndex=this.editor.historyManager.getCurrent();if(editor)
this.editorBefore=editor;else
this.editorBefore=this.editor.getState();if(model)
this.modelBefore=model;else
this.modelBefore=this.editor.model.getState();},end:function(editor,model)
{this.editor.historyManager.truncate(this.startIndex);if(editor)
this.editorAfter=editor;else
this.editorAfter=this.editor.getState();if(model)
this.modelAfter=model;else
this.modelAfter=this.editor.model.getState();},undo:function()
{this.editor.model.applyState(this.modelBefore);this.editor.setState(this.editorBefore);this.editor.ui.ensureCursorVisible();this.editor.paint();},redo:function()
{this.editor.model.applyState(this.modelAfter);this.editor.setState(this.editorAfter);this.editor.ui.ensureCursorVisible();this.editor.paint();}});
dojo.provide("bespin.editor.clipboard");dojo.mixin(bespin.editor.clipboard,{install:function(editor,newImpl){this.uninstall();this.uses=newImpl;this.uses.install(editor);},uninstall:function(){if(this.uses&&typeof this.uses['uninstall']=="function")this.uses.uninstall();this.uses=undefined;},createHiddenTextarea:function(){return dojo.create("textarea",{id:'copynpaster',tabIndex:'-1',style:"position:absolute; z-index:999; top:-10000px; width:0; height:0; border:none;"},dojo.body());},setup:function(editor){this.install(editor,new bespin.editor.clipboard.HiddenWorld());}});dojo.declare("bespin.editor.clipboard.DOMEvents",null,{install:function(editor){var copynpaster=this.copynpaster=bespin.editor.clipboard.createHiddenTextarea();var stopAction=function(e){return e.target.id=="command";};var editorHasFocus=function(){return bespin.get('editor').focus;};var allowAction=false;this.beforecopyHandle=dojo.connect(document,"beforecopy",function(e){if(!editorHasFocus()&&!this.allowAction)return;if(stopAction(e))return;e.preventDefault();copynpaster.focus();this.allowAction=true;});this.copyHandle=dojo.connect(document,"copy",function(e){if(!editorHasFocus()&&!this.allowAction)return;if(stopAction(e))return;var selectionText=editor.getSelectionAsText();if(selectionText&&selectionText!=''){e.preventDefault();e.clipboardData.setData('text/plain',selectionText);}
dojo.byId('canvas').focus();this.allowAction=false;});this.beforecutHandle=dojo.connect(document,"beforecut",function(e){if(!editorHasFocus()&&!this.allowAction)return;if(stopAction(e))return;e.preventDefault();copynpaster.focus();this.allowAction=true;});this.cutHandle=dojo.connect(document,"cut",function(e){if(!editorHasFocus()&&!this.allowAction)return;if(stopAction(e))return;var selectionObject=editor.getSelection();if(selectionObject){var selectionText=editor.model.getChunk(selectionObject);if(selectionText&&selectionText!=''){e.preventDefault();e.clipboardData.setData('text/plain',selectionText);editor.ui.actions.beginEdit('cut');editor.ui.actions.deleteSelection(selectionObject);editor.ui.actions.endEdit();}}
dojo.byId('canvas').focus();this.allowAction=false;});this.beforepasteHandle=dojo.connect(document,"beforepaste",function(e){if(!editorHasFocus()&&!this.allowAction)return;if(stopAction(e))return;e.preventDefault();copynpaster.focus();this.allowAction=true;});this.pasteHandle=dojo.connect(document,"paste",function(e){if(!editorHasFocus()&&!this.allowAction)return;if(stopAction(e))return;e.preventDefault();var args=bespin.editor.utils.buildArgs();args.chunk=e.clipboardData.getData('text/plain');if(args.chunk){editor.ui.actions.beginEdit('paste');editor.ui.actions.insertChunk(args);editor.ui.actions.endEdit();}
dojo.byId('canvas').focus();copynpaster.value='';this.allowAction=false;});dojo.connect(document,"dom:loaded",dojo.hitch(this,function(){this.keydownHandle=dojo.connect(copynpaster,"keydown",function(e){e.stopPropagation();});this.keypressHandle=dojo.connect(copynpaster,"keypress",function(e){e.stopPropagation();});}));},uninstall:function(){dojo.disconnect(this.keypressHandle);dojo.disconnect(this.keydownHandle);dojo.disconnect(this.beforepasteHandle);dojo.disconnect(this.pasteHandle);dojo.disconnect(this.beforecutHandle);dojo.disconnect(this.cutHandle);dojo.disconnect(this.beforecopyHandle);dojo.disconnect(this.copyHandle);if(this.copynpaster)
document.body.removeChild(copynpaster);this.copynpaster=undefined;}});dojo.declare("bespin.editor.clipboard.HiddenWorld",null,{install:function(editor){var copynpaster=this.copynpaster=bespin.editor.clipboard.createHiddenTextarea();var copyToClipboard=function(text){copynpaster.value=text;copynpaster.select();setTimeout(function(){editor.setFocus(true);},0);};this.keyDown=dojo.connect(editor.opts.actsAsComponent?editor.canvas:document,"keydown",function(e){if(!bespin.get('editor').focus)return;if((bespin.util.isMac()&&e.metaKey)||e.ctrlKey){if(e.keyCode==67){var selectionText=editor.getSelectionAsText();if(selectionText&&selectionText!=''){copyToClipboard(selectionText);}}else if(e.keyCode==88){var selectionObject=editor.getSelection();if(selectionObject){var selectionText=editor.model.getChunk(selectionObject);if(selectionText&&selectionText!=''){copyToClipboard(selectionText);editor.ui.actions.beginEdit('cut');editor.ui.actions.deleteSelection(selectionObject);editor.ui.actions.endEdit();}}}else if(e.keyCode==86){if(e.target==dojo.byId("command"))return;copynpaster.select();setTimeout(function(){var args=bespin.editor.utils.buildArgs();args.chunk=copynpaster.value;if(args.chunk){editor.ui.actions.beginEdit('paste');editor.ui.actions.insertChunk(args);editor.ui.actions.endEdit();}
editor.setFocus(true);},0);}}});},uninstall:function(){dojo.disconnect(this.keyDown);if(this.copynpaster)
document.body.removeChild(copynpaster);this.copynpaster=undefined;}});dojo.declare("bespin.editor.clipboard.EditorOnly",null,{install:function(){var editor=bespin.get('editor');editor.bindKey("copySelection","CMD C");editor.bindKey("pasteFromClipboard","CMD V");editor.bindKey("cutSelection","CMD X");}});bespin.editor.clipboard.Manual=function(){var clipdata;return{copy:function(copytext){try{if(netscape.security.PrivilegeManager.enablePrivilege){netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");}else{clipdata=copytext;return;}}catch(ex){clipdata=copytext;return;}
var str=Components.classes["@mozilla.org/supports-string;1"].createInstance(Components.interfaces.nsISupportsString);str.data=copytext;var trans=Components.classes["@mozilla.org/widget/transferable;1"].createInstance(Components.interfaces.nsITransferable);if(!trans)return false;trans.addDataFlavor("text/unicode");trans.setTransferData("text/unicode",str,copytext.length*2);var clipid=Components.interfaces.nsIClipboard;var clip=Components.classes["@mozilla.org/widget/clipboard;1"].getService(clipid);if(!clip)return false;clip.setData(trans,null,clipid.kGlobalClipboard);},data:function(){try{if(netscape.security.PrivilegeManager.enablePrivilege){netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");}else{return clipdata;}}catch(ex){return clipdata;}
var clip=Components.classes["@mozilla.org/widget/clipboard;1"].getService(Components.interfaces.nsIClipboard);if(!clip)return false;var trans=Components.classes["@mozilla.org/widget/transferable;1"].createInstance(Components.interfaces.nsITransferable);if(!trans)return false;trans.addDataFlavor("text/unicode");clip.getData(trans,clip.kGlobalClipboard);var str={};var strLength={};var pastetext="";trans.getTransferData("text/unicode",str,strLength);if(str)str=str.value.QueryInterface(Components.interfaces.nsISupportsString);if(str)pastetext=str.data.substring(0,strLength.value/2);return pastetext;}};}();
dojo.provide("bespin.editor.cursor");dojo.declare("bespin.editor.CursorManager",null,{constructor:function(editor){this.editor=editor;this.position={row:0,col:0};this.virtualCol=0;},getCursorPosition:function(modelPos){if(modelPos==undefined)
{return this.position;}
var pos=bespin.editor.utils.copyPos(modelPos);var line=[];if(this.editor.model.hasRow(pos.row))
line=this.editor.model.getRowArray(pos.row);var tabsize=this.editor.getTabSize();if(line.indexOf("\t")!=-1){var tabs=0,nottabs=0;for(var i=0;i<modelPos.col;i++){if(line[i]=="\t"){pos.col+=tabsize-1-(nottabs%tabsize);tabs++;nottabs=0;}else{nottabs++;tabs=0;}}}
return pos;},getModelPosition:function(pos){pos=(pos!=undefined)?pos:this.position;var modelPos=bespin.editor.utils.copyPos(pos);var line=[];if(this.editor.model.hasRow(pos.row))
line=this.editor.model.getRowArray(pos.row);var tabsize=this.editor.getTabSize();if(line.indexOf("\t")!=-1){var current_pos=0;for(var i=0;i<modelPos.col;i++){var new_pos=current_pos;if(line[i]=='\t'){new_pos=Math.floor((current_pos+tabsize)/tabsize)*tabsize;}else{new_pos+=1;}
if(new_pos>modelPos.col){break;}
current_pos=new_pos;}
modelPos.col=i;}
return modelPos;},getCharacterLength:function(character,column){if(character.length>1)return;if(column==undefined)column=this.position.col;if(character=="\t"){var tabsize=this.editor.getTabSize();return(tabsize-(column%tabsize));}else{return 1;}},getStringLength:function(str){if(!str||str.length==0)return 0;var count=0;str=str.split("");for(var x=0;x<str.length;x++){count+=this.getCharacterLength(str[x],count);}
return count;},getLeadingWhitespace:function(rowIndex){var row=this.editor.model.getRowArray(rowIndex).join("");var match=/^(\s+).*/.exec(row);return(match&&match.length==2?this.getStringLength(match[1]):0);},getContinuousSpaceCount:function(from,to,rowIndex){rowIndex=rowIndex||this.position.row;var settings=bespin.get('settings');var row=this.editor.model.getRowArray(rowIndex);var delta=(from<to?1:-1);var length=row.length;from=from+(delta==1?0:-1);to=to+(delta==1?0:-1);from=this.getModelPosition({col:from,row:rowIndex}).col;to=this.getModelPosition({col:to,row:rowIndex}).col;if(settings&&settings.isSettingOn('strictlines')){from=Math.min(from,length);to=Math.min(to,length);}
var count=0;for(var x=from;x!=to;x+=delta){if(x<length){if(row[x]!=' '){break;}}
count++;}
return count;},getNextTablevelLeft:function(col){var tabsize=this.editor.getTabSize();col=col||this.position.col;col--;return Math.floor(col/tabsize)*tabsize;},getNextTablevelRight:function(col){var tabsize=this.editor.getTabSize();col=col||this.position.col;col++;return Math.ceil(col/tabsize)*tabsize;},moveToLineStart:function(){var oldPos=bespin.editor.utils.copyPos(this.position);var leadingWhitespaceLength=this.getLeadingWhitespace(oldPos.row);if(this.position.col==0){this.moveCursor({col:leadingWhitespaceLength});}else if(this.position.col==leadingWhitespaceLength){this.moveCursor({col:0});}else if(leadingWhitespaceLength!=this.editor.ui.getRowScreenLength(this.editor.cursorManager.getCursorPosition().row)){this.moveCursor({col:leadingWhitespaceLength});}else{this.moveCursor({col:0});}
return{oldPos:oldPos,newPos:bespin.editor.utils.copyPos(this.position)};},moveToLineEnd:function(){var oldPos=bespin.editor.utils.copyPos(this.position);this.moveCursor({col:this.editor.ui.getRowScreenLength(oldPos.row)});return{oldPos:oldPos,newPos:bespin.editor.utils.copyPos(this.position)};},moveToTop:function(){var oldPos=bespin.editor.utils.copyPos(this.position);this.editor.cursorManager.moveCursor({row:0,col:0});return{oldPos:oldPos,newPos:bespin.editor.utils.copyPos(this.position)};},moveToBottom:function(){var oldPos=bespin.editor.utils.copyPos(this.position);var row=this.editor.model.getRowCount()-1;this.editor.cursorManager.moveCursor({row:row,col:this.editor.ui.getRowScreenLength(row)});return{oldPos:oldPos,newPos:bespin.editor.utils.copyPos(this.position)};},moveUp:function(){var settings=bespin.get("settings");var selection=this.editor.getSelection();var oldPos=bespin.editor.utils.copyPos(this.position);var oldVirualCol=this.virtualCol;this.moveCursor({row:oldPos.row-1,col:Math.max(oldPos.col,this.virtualCol)});if((settings&&settings.isSettingOn('strictlines'))&&this.position.col>this.editor.ui.getRowScreenLength(this.position.row)){this.moveToLineEnd();this.virtualCol=Math.max(oldPos.col,oldVirualCol);}
return{oldPos:oldPos,newPos:bespin.editor.utils.copyPos(this.position)};},moveDown:function(){var settings=bespin.get("settings");var selection=this.editor.getSelection();var oldPos=bespin.editor.utils.copyPos(this.position);var oldVirualCol=this.virtualCol;this.moveCursor({row:Math.max(0,oldPos.row+1),col:Math.max(oldPos.col,this.virtualCol)});if((settings&&settings.isSettingOn('strictlines'))&&this.position.col>this.editor.ui.getRowScreenLength(this.position.row)){this.moveToLineEnd();this.virtualCol=Math.max(oldPos.col,oldVirualCol);}
return{oldPos:oldPos,newPos:bespin.editor.utils.copyPos(this.position)};},moveLeft:function(args){var settings=bespin.get("settings");var oldPos=bespin.editor.utils.copyPos(this.position);var shiftKey=(args.event?args.event.shiftKey:false);if(!this.editor.getSelection()||shiftKey){if(settings&&settings.isSettingOn('smartmove')){var freeSpaces=this.getContinuousSpaceCount(oldPos.col,this.getNextTablevelLeft());if(freeSpaces==this.editor.getTabSize()){this.moveCursor({col:oldPos.col-freeSpaces});return{oldPos:oldPos,newPos:bespin.editor.utils.copyPos(this.position)};}}
if((settings&&settings.isSettingOn('strictlines'))&&(this.position.col==0)){this.moveUp();if(oldPos.row>0)this.moveToLineEnd();}else{this.moveCursor({row:oldPos.row,col:Math.max(0,oldPos.col-1)});}}else{this.moveCursor(this.editor.getSelection().startPos);}
return{oldPos:oldPos,newPos:bespin.editor.utils.copyPos(this.position)};},moveRight:function(args){var settings=bespin.get("settings");var oldPos=bespin.editor.utils.copyPos(this.position);var shiftKey=(args.event?args.event.shiftKey:false);if(!this.editor.getSelection()||shiftKey){if((settings&&settings.isSettingOn('smartmove'))&&args!=true){var freeSpaces=this.getContinuousSpaceCount(oldPos.col,this.getNextTablevelRight());if(freeSpaces==this.editor.getTabSize()){this.moveCursor({col:oldPos.col+freeSpaces});return{oldPos:oldPos,newPos:bespin.editor.utils.copyPos(this.position)};}}
if((settings&&settings.isSettingOn('strictlines'))&&(this.position.col>=this.editor.ui.getRowScreenLength(this.position.row))){this.moveDown();if(oldPos.row<this.editor.model.getRowCount()-1)this.moveCursor({col:0});}else{this.moveCursor({col:this.position.col+1});}}else{this.moveCursor(this.editor.getSelection().endPos);}
return{oldPos:oldPos,newPos:bespin.editor.utils.copyPos(this.position)};},movePageUp:function(){var settings=bespin.get("settings");var selection=this.editor.getSelection();var oldPos=bespin.editor.utils.copyPos(this.position);var oldVirualCol=this.virtualCol;this.moveCursor({row:Math.max(this.editor.ui.firstVisibleRow-this.editor.ui.visibleRows,0)});if((settings&&settings.isSettingOn('strictlines'))&&this.position.col>this.editor.ui.getRowScreenLength(this.position.row)){this.moveToLineEnd();this.virtualCol=Math.max(oldPos.col,oldVirualCol);}
return{oldPos:oldPos,newPos:bespin.editor.utils.copyPos(this.position)};},movePageDown:function(){var settings=bespin.get("settings");var selection=this.editor.getSelection();var oldPos=bespin.editor.utils.copyPos(this.position);var oldVirualCol=this.virtualCol;this.moveCursor({row:Math.min(this.position.row+this.editor.ui.visibleRows,this.editor.model.getRowCount()-1)});if((settings&&settings.isSettingOn('strictlines'))&&this.position.col>this.editor.ui.getRowScreenLength(this.position.row)){this.moveToLineEnd();this.virtualCol=Math.max(oldPos.col,oldVirualCol);}
return{oldPos:oldPos,newPos:bespin.editor.utils.copyPos(this.position)};},smartMoveLeft:function(){var oldPos=bespin.editor.utils.copyPos(this.position);var row=this.editor.ui.getRowString(oldPos.row);var c,charCode;if(this.position.col==0){this.moveUp();this.moveToLineEnd();}else{if(row.length<this.position.col)this.moveToLineEnd();var newcol=this.position.col;var wasSpaces=false;while(newcol>0){newcol--;c=row.charAt(newcol);charCode=c.charCodeAt(0);if(charCode==32){wasSpaces=true;}else{newcol++;break;}}
if(!wasSpaces){while(newcol>0){newcol--;c=row.charAt(newcol);charCode=c.charCodeAt(0);if((charCode<65)||(charCode>122)){if(newcol!=this.position.col-1)newcol++;break;}}}
this.moveCursor({col:newcol});}
return{oldPos:oldPos,newPos:bespin.editor.utils.copyPos(this.position)};},smartMoveRight:function(){var oldPos=bespin.editor.utils.copyPos(this.position);var row=this.editor.ui.getRowString(oldPos.row);if(row.length<=this.position.col){this.moveDown();this.moveToLineStart();}else{var c,charCode;var newcol=this.position.col;var wasSpaces=false;while(newcol<row.length){c=row[newcol];charCode=c.charCodeAt(0);if(charCode==32){wasSpaces=true;newcol++;}else{break;}}
if(!wasSpaces){while(newcol<row.length){newcol++;if(row.length==newcol){this.moveToLineEnd();newcol=-1;break;}
c=row[newcol];charCode=c.charCodeAt(0);if((charCode<65)||(charCode>122)){break;}}}
if(newcol!=-1)this.moveCursor({col:newcol});}
return{oldPos:oldPos,newPos:bespin.editor.utils.copyPos(this.position)};},moveCursor:function(newpos){if(!newpos)return;if(newpos.col===undefined)newpos.col=this.position.col;if(newpos.row===undefined)newpos.row=this.position.row;this.virtualCol=0;var oldpos=this.position;var row=Math.min(newpos.row,this.editor.model.getRowCount()-1);if(row<0)row=0;var invalid=this.isInvalidCursorPosition(row,newpos.col);if(invalid){if(oldpos.row!=newpos.row){newpos.col=invalid.right;}else if(oldpos.col<newpos.col){newpos.col=invalid.right;}else if(oldpos.col>newpos.col){newpos.col=invalid.left;}else{newpos.col=invalid.right;}}
this.position={row:row,col:newpos.col};var editorUI=bespin.get('editor').ui;editorUI.showCursor=true;editorUI.toggleCursorAllowed=false;},isInvalidCursorPosition:function(row,col){var rowArray=this.editor.model.getRowArray(row);var curCol=0;for(var i=0;i<rowArray.length;i++){if(rowArray[i].charCodeAt(0)==9){var toInsert=this.editor.getTabSize()-(curCol%this.editor.getTabSize());if((col>curCol)&&(col<(curCol+toInsert))){return{left:curCol,right:curCol+toInsert,half:toInsert/2};}
curCol+=toInsert-1;}
curCol++;}
return undefined;}});
dojo.provide("bespin.editor.editor");dojo.require("bespin.editor.clipboard");dojo.declare("bespin.editor.Scrollbar",null,{HORIZONTAL:"horizontal",VERTICAL:"vertical",MINIMUM_HANDLE_SIZE:20,constructor:function(ui,orientation,rect,value,min,max,extent){this.ui=ui;this.orientation=orientation;this.rect=rect;this.value=value;this.min=min;this.max=max;this.extent=extent;this.mousedownScreenPoint;this.mousedownValue;},getHandleBounds:function(){var sx=(this.isH())?this.rect.x:this.rect.y;var sw=(this.isH())?this.rect.w:this.rect.h;var smultiple=this.extent/(this.max+this.extent);var asw=smultiple*sw;if(asw<this.MINIMUM_HANDLE_SIZE)asw=this.MINIMUM_HANDLE_SIZE;sx+=(sw-asw)*(this.value/(this.max-this.min));return(this.isH())?new bespin.editor.Rect(Math.floor(sx),this.rect.y,asw,this.rect.h):new bespin.editor.Rect(this.rect.x,sx,this.rect.w,asw);},isH:function(){return(!(this.orientation==this.VERTICAL));},fixValue:function(value){if(value<this.min)value=this.min;if(value>this.max)value=this.max;return value;},onmousewheel:function(e){var command_output=dojo.byId("command_output");var target=e.target||e.originalTarget;if(command_output&&(target.id=="command_output"||bespin.util.contains(command_output,target)))return;if(!this.ui.editor.focus)return;var wheel=bespin.util.mousewheelevent.wheel(e);var axis=bespin.util.mousewheelevent.axis(e);if(this.orientation==this.VERTICAL&&axis==this.VERTICAL){this.setValue(this.value+(wheel*this.ui.lineHeight));}else if(this.orientation==this.HORIZONTAL&&axis==this.HORIZONTAL){this.setValue(this.value+(wheel*this.ui.charWidth));}},onmousedown:function(e){var clientY=e.clientY-this.ui.getTopOffset();var clientX=e.clientX-this.ui.getLeftOffset();var bar=this.getHandleBounds();if(bar.contains({x:clientX,y:clientY})){this.mousedownScreenPoint=(this.isH())?e.screenX:e.screenY;this.mousedownValue=this.value;}else{var p=(this.isH())?clientX:clientY;var b1=(this.isH())?bar.x:bar.y;var b2=(this.isH())?bar.x2:bar.y2;if(p<b1){this.setValue(this.value-=this.extent);}else if(p>b2){this.setValue(this.value+=this.extent);}}},onmouseup:function(e){this.mousedownScreenPoint=null;this.mousedownValue=null;if(this.valueChanged)this.valueChanged();},onmousemove:function(e){if(this.mousedownScreenPoint){var diff=((this.isH())?e.screenX:e.screenY)-this.mousedownScreenPoint;var multiplier=diff/(this.isH()?this.rect.w:this.rect.h);this.setValue(this.mousedownValue+Math.floor(((this.max+this.extent)-this.min)*multiplier));}},setValue:function(value){this.value=this.fixValue(value);if(this.valueChanged)this.valueChanged();}});dojo.declare("bespin.editor.Rect",null,{constructor:function(x,y,w,h){this.x=x;this.y=y;this.w=w;this.h=h;this.x2=x+w;this.y2=y+h;},contains:function(point){if(!this.x)return false;return((this.x<=point.x)&&((this.x+this.w)>=point.x)&&(this.y<=point.y)&&((this.y+this.h)>=point.y));}});dojo.declare("bespin.editor.SelectionHelper",null,{constructor:function(editor){this.editor=editor;},getRowSelectionPositions:function(rowIndex){var startCol;var endCol;var selection=this.editor.getSelection();if(!selection)return undefined;if((selection.endPos.row<rowIndex)||(selection.startPos.row>rowIndex))return undefined;startCol=(selection.startPos.row<rowIndex)?0:selection.startPos.col;endCol=(selection.endPos.row>rowIndex)?-1:selection.endPos.col;return{startCol:startCol,endCol:endCol};}});dojo.mixin(bespin.editor,{utils:{buildArgs:function(oldPos){return{pos:bespin.editor.utils.copyPos(oldPos||bespin.get('editor').getCursorPos())};},changePos:function(args,pos){return{pos:bespin.editor.utils.copyPos(oldPos||bespin.get('editor').getCursorPos())};},copyPos:function(oldPos){return{row:oldPos.row,col:oldPos.col};},posEquals:function(pos1,pos2){if(pos1==pos2)return true;if(!pos1||!pos2)return false;return(pos1.col==pos2.col)&&(pos1.row==pos2.row);},diffObjects:function(o1,o2){var diffs={};if(!o1||!o2)return undefined;for(var key in o1){if(o2[key]){if(o1[key]!=o2[key]){diffs[key]=o1[key]+" => "+o2[key];}}else{diffs[key]="o1: "+key+" = "+o1[key];}}
for(var key2 in o2){if(!o1[key2]){diffs[key2]="o2: "+key2+" = "+o2[key2];}}
return diffs;}}});dojo.declare("bespin.editor.DefaultEditorKeyListener",null,{constructor:function(editor){this.editor=editor;this.actions=editor.ui.actions;this.skipKeypress=false;this.defaultKeyMap={};this.keyMap=this.defaultKeyMap;this.keyMapDescriptions={};},bindKey:function(keyCode,metaKey,ctrlKey,altKey,shiftKey,action,name){this.defaultKeyMap[[keyCode,metaKey,ctrlKey,altKey,shiftKey]]=(typeof action=="string")?function(){var toFire=bespin.events.toFire(action);bespin.publish(toFire.name,toFire.args);}:dojo.hitch(this.actions,action);if(name)this.keyMapDescriptions[[keyCode,metaKey,ctrlKey,altKey,shiftKey]]=name;},bindKeyForPlatform:function(keysForPlatforms,action,name,isSelectable){var platform=bespin.util.getOS();var platformKeys=keysForPlatforms[platform]||keysForPlatforms['WINDOWS'];if(!platformKeys)return;var args=bespin.util.keys.fillArguments(platformKeys);var bindFunction=(isSelectable)?"bindKeyStringSelectable":"bindKeyString";this[bindFunction](args.modifiers,bespin.util.keys.toKeyCode(args.key),action,name);},bindKeyString:function(modifiers,keyCode,action,name){var ctrlKey=(modifiers.toUpperCase().indexOf("CTRL")!=-1);var altKey=(modifiers.toUpperCase().indexOf("ALT")!=-1);var metaKey=(modifiers.toUpperCase().indexOf("META")!=-1)||(modifiers.toUpperCase().indexOf("APPLE")!=-1);var shiftKey=(modifiers.toUpperCase().indexOf("SHIFT")!=-1);if(modifiers.toUpperCase().indexOf("CMD")!=-1){if(bespin.util.isMac()){metaKey=true;}else{ctrlKey=true;}}
return this.bindKey(keyCode,metaKey,ctrlKey,altKey,shiftKey,action,name);},bindKeyStringSelectable:function(modifiers,keyCode,action,name){this.bindKeyString(modifiers,keyCode,action,name);this.bindKeyString("SHIFT "+modifiers,keyCode,action);},getPrintableChar:function(e){if(e.charCode>255)return false;if(e.charCode<32)return false;return String.fromCharCode(e.charCode);},callAction:function(inAction,e){dojo.stopEvent(e);try{var args={event:e,pos:bespin.editor.utils.copyPos(this.editor.cursorManager.getCursorPosition())};inAction(args);}catch(e){console.log("Action caused an error! ",e);}},processEventAction:function(e){var action=this.keyMap[[e.keyCode,e.metaKey,e.ctrlKey,e.altKey,e.shiftKey]];var hasAction=dojo.isFunction(action);if(hasAction){this.callAction(action,e);}
return hasAction?action:null;},onkeydown:function(e){if(!this.editor.focus){return;}
this.currentAction=this.processEventAction(e);this.keyRepeatCount=0;},onkeypress:function(e){if(!this.editor.focus){return;}
if(this.currentAction){if(this.keyRepeatCount){this.callAction(this.currentAction,e);}
this.keyRepeatCount++;return;}
if((e.metaKey&&!(e.ctrlKey||e.altKey||e.shiftKey))||(e.ctrlKey&&!(e.metaKey||e.altKey||e.shiftKey))){if(e.charCode>=48&&e.charCode<=57){return;}
if(e.charCode=="c".charCodeAt(0)||e.charCode=="x".charCodeAt(0)||e.charCode=="v".charCodeAt(0)){return;}}
var charToPrint=this.getPrintableChar(e);if(charToPrint){var args={event:e,pos:bespin.editor.utils.copyPos(this.editor.cursorManager.getCursorPosition()),newchar:String.fromCharCode(e.charCode)};this.editor.ui.actions.insertCharacter(args);}
dojo.stopEvent(e);}});dojo.declare("bespin.editor.UI",null,{constructor:function(editor){this.editor=editor;this.model=this.editor.model;var settings=bespin.get("settings");this.syntaxModel=bespin.syntax.Resolver.setEngine("simple").getModel();this.selectionHelper=new bespin.editor.SelectionHelper(editor);this.actions=new bespin.editor.Actions(editor);this.rowLengthCache=[];this.searchString=null;this.toggleCursorFullRepaintCounter=0;this.toggleCursorFrequency=250;this.toggleCursorAllowed=true;this.horizontalScrollCanvas=dojo.create("canvas");this.verticalScrollCanvas=dojo.create("canvas");this.gutterWidth=54;this.LINE_HEIGHT=23;this.BOTTOM_SCROLL_AFFORDANCE=30;this.GUTTER_INSETS={top:0,left:6,right:10,bottom:6};this.LINE_INSETS={top:0,left:5,right:0,bottom:6};this.FALLBACK_CHARACTER_WIDTH=10;this.NIB_WIDTH=15;this.NIB_INSETS={top:Math.floor(this.NIB_WIDTH/2),left:Math.floor(this.NIB_WIDTH/2),right:Math.floor(this.NIB_WIDTH/2),bottom:Math.floor(this.NIB_WIDTH/2)};this.NIB_ARROW_INSETS={top:3,left:3,right:3,bottom:5};this.DEBUG_GUTTER_WIDTH=18;this.DEBUG_GUTTER_INSETS={top:2,left:2,right:2,bottom:2};this.xoffset=0;this.yoffset=0;this.showCursor=true;this.overXScrollBar=false;this.overYScrollBar=false;this.hasFocus=false;var source=this.editor.container;this.globalHandles=[];dojo.connect(source,"mousemove",this,"handleMouse");dojo.connect(source,"mouseout",this,"handleMouse");dojo.connect(source,"click",this,"handleMouse");dojo.connect(source,"mousedown",this,"handleMouse");dojo.connect(source,"oncontextmenu",dojo.stopEvent);dojo.connect(source,"mousedown",this,"mouseDownSelect");this.globalHandles.push(dojo.connect(window,"mousemove",this,"mouseMoveSelect"));this.globalHandles.push(dojo.connect(window,"mouseup",this,"mouseUpSelect"));this.lastLineCount=0;this.lastCursorPos=null;this.lastxoffset=0;this.lastyoffset=0;var scope=editor.opts.actsAsComponent?editor.canvas:window;this.xscrollbar=new bespin.editor.Scrollbar(this,"horizontal");this.xscrollbar.valueChanged=dojo.hitch(this,function(){this.xoffset=-this.xscrollbar.value;this.editor.paint();});this.globalHandles.push(dojo.connect(window,"mousemove",this.xscrollbar,"onmousemove"));this.globalHandles.push(dojo.connect(window,"mouseup",this.xscrollbar,"onmouseup"));this.globalHandles.push(dojo.connect(scope,(!dojo.isMozilla?"onmousewheel":"DOMMouseScroll"),this.xscrollbar,"onmousewheel"));this.yscrollbar=new bespin.editor.Scrollbar(this,"vertical");this.yscrollbar.valueChanged=dojo.hitch(this,function(){this.yoffset=-this.yscrollbar.value;this.editor.paint();});this.globalHandles.push(dojo.connect(window,"mousemove",this.yscrollbar,"onmousemove"));this.globalHandles.push(dojo.connect(window,"mouseup",this.yscrollbar,"onmouseup"));this.globalHandles.push(dojo.connect(scope,(!dojo.isMozilla?"onmousewheel":"DOMMouseScroll"),this.yscrollbar,"onmousewheel"));setTimeout(dojo.hitch(this,function(){this.toggleCursor(this);}),this.toggleCursorFrequency);},convertClientPointToCursorPoint:function(pos){var settings=bespin.get("settings");var x,y;if(pos.y<0){y=0;}else if(pos.y>=(this.lineHeight*this.editor.model.getRowCount())){y=this.editor.model.getRowCount()-1;}else{var ty=pos.y;y=Math.floor(ty/this.lineHeight);}
if(pos.x<=(this.gutterWidth+this.LINE_INSETS.left)){x=-1;}else{var tx=pos.x-this.gutterWidth-this.LINE_INSETS.left;x=Math.round(tx/this.charWidth);if((settings&&settings.isSettingOn('strictlines'))){var maxcol=this.getRowScreenLength(y);if(x>=maxcol){x=this.getRowScreenLength(y);}}}
return{row:y,col:x};},mouseDownSelect:function(e){if(!this.editor.focus)return;if(e.button==2){dojo.stopEvent(e);return false;}
var clientY=e.clientY-this.getTopOffset();var clientX=e.clientX-this.getLeftOffset();if(this.overXScrollBar||this.overYScrollBar)return;if(this.editor.debugMode){if(clientX<this.DEBUG_GUTTER_WIDTH){console.log("Clicked in debug gutter");var point={x:clientX,y:clientY};point.y+=Math.abs(this.yoffset);var p=this.convertClientPointToCursorPoint(point);var editSession=bespin.get("editSession");if(p&&editSession){bespin.getComponent("breakpoints",function(breakpoints){breakpoints.toggleBreakpoint({project:editSession.project,path:editSession.path,lineNumber:p.row});this.editor.paint(true);},this);}
return;}}
this.selectMouseDetail=e.detail;if(e.shiftKey){this.selectMouseDownPos=(this.editor.selection)?this.editor.selection.startPos:this.editor.getCursorPos();this.setSelection(e);}else{var point={x:clientX,y:clientY};point.x+=Math.abs(this.xoffset);point.y+=Math.abs(this.yoffset);if((this.xscrollbar.rect.contains(point))||(this.yscrollbar.rect.contains(point)))return;this.selectMouseDownPos=this.convertClientPointToCursorPoint(point);}},mouseMoveSelect:function(e){if(!this.editor.focus)return;this.setSelection(e);},mouseUpSelect:function(e){if(!this.editor.focus)return;this.setSelection(e);this.selectMouseDownPos=undefined;this.selectMouseDetail=undefined;},setSelection:function(e){var clientY=e.clientY-this.getTopOffset();var clientX=e.clientX-this.getLeftOffset();if(!this.selectMouseDownPos)return;var down=bespin.editor.utils.copyPos(this.selectMouseDownPos);var point={x:clientX,y:clientY};point.x+=Math.abs(this.xoffset);point.y+=Math.abs(this.yoffset);var up=this.convertClientPointToCursorPoint(point);if(down.col==-1){down.col=0;var lineMarker=bespin.get("parser").getLineMarkers()[down.row+1];if(lineMarker){bespin.get("commandLine").showHint(lineMarker.msg);}}
if(up.col==-1)up.col=0;var modelstart=this.editor.getModelPos(down);var modelend=this.editor.getModelPos(up);var backwards=false;if(modelend.row<modelstart.row||(modelend.row==modelstart.row&&modelend.col<modelstart.col)){backwards=true;var temp=modelstart;modelstart=modelend;modelend=temp;}
if(!this.editor.model.hasRow(modelstart.row)){modelstart.row=this.editor.model.getRowCount()-1;}
if(!this.editor.model.hasRow(modelend.row)){modelend.row=this.editor.model.getRowCount()-1;}
var detail=this.selectMouseDetail;if(detail==1){if(bespin.editor.utils.posEquals(modelstart,modelend)){this.editor.setSelection(undefined);}else{this.editor.setSelection({startPos:this.editor.getCursorPos(backwards?modelend:modelstart),endPos:this.editor.getCursorPos(backwards?modelstart:modelend)});}
this.editor.moveCursor(this.editor.getCursorPos(backwards?modelstart:modelend));}else if(detail==2){var row=this.editor.model.rows[modelstart.row];var cursorAt=row[modelstart.col];var isDelimiter=function(item){var delimiters=["="," ","\t",">","<",".","(",")","{","}",":",'"',"'",";"];if(delimiters.indexOf(item)>-1)
return true;return false;};if(!cursorAt){this.editor.setSelection({startPos:this.editor.getCursorPos({row:modelstart.row,col:0}),endPos:this.editor.getCursorPos({row:modelstart.row,col:row.length})});}else if(isDelimiter(cursorAt.charAt(0))){var comparator=function(letter){if(isDelimiter(letter))
return false;return true;};var startPos=this.editor.model.findBefore(modelstart.row,modelstart.col,comparator);var endPos=this.editor.model.findAfter(modelend.row,modelend.col,comparator);this.editor.setSelection({startPos:this.editor.getCursorPos(backwards?endPos:startPos),endPos:this.editor.getCursorPos(backwards?startPos:endPos)});this.editor.moveCursor(this.editor.getCursorPos(backwards?startPos:endPos));}else{var comparator=function(letter){if(isDelimiter(letter))
return true;return false;};var startPos=this.editor.model.findBefore(modelstart.row,modelstart.col,comparator);var endPos=this.editor.model.findAfter(modelend.row,modelend.col,comparator);this.editor.setSelection({startPos:this.editor.getCursorPos(backwards?endPos:startPos),endPos:this.editor.getCursorPos(backwards?startPos:endPos)});this.editor.moveCursor(this.editor.getCursorPos(backwards?startPos:endPos));}}else if(detail>2){var startPos={row:modelstart.row,col:0};var endPos={row:modelend.row,col:0};if(this.editor.model.hasRow(endPos.row+1)){endPos.row=endPos.row+1;}else{endPos.col=this.editor.model.getRowArray(endPos.row).length;}
startPos=this.editor.getCursorPos(startPos);endPos=this.editor.getCursorPos(endPos);this.editor.setSelection({startPos:backwards?endPos:startPos,endPos:backwards?startPos:endPos});this.editor.moveCursor(backwards?startPos:endPos);}
if(clientY<0){this.yoffset=Math.min(1,this.yoffset+(-clientY));}else if(clientY>=this.getHeight()){var virtualHeight=this.lineHeight*this.editor.model.getRowCount();this.yoffset=Math.max(-(virtualHeight-this.getHeight()-this.BOTTOM_SCROLL_AFFORDANCE),this.yoffset-clientY-this.getHeight());}
this.editor.paint();},toggleCursor:function(ui){if(ui.toggleCursorAllowed){ui.showCursor=!ui.showCursor;}else{ui.toggleCursorAllowed=true;}
if(++this.toggleCursorFullRepaintCounter>0){this.toggleCursorFullRepaintCounter=0;ui.editor.paint(true);}else{ui.editor.paint();}
setTimeout(function(){ui.toggleCursor(ui);},ui.toggleCursorFrequency);},ensureCursorVisible:function(softEnsure){if((!this.lineHeight)||(!this.charWidth))return;if(bespin.get('settings')){var pageScroll=parseFloat(bespin.get('settings').get('pagescroll'))||0;}else{var pageScroll=0;}
pageScroll=(!softEnsure?Math.max(0,Math.min(1,pageScroll)):0.25);var y=this.lineHeight*this.editor.cursorManager.getCursorPosition().row;var x=this.charWidth*this.editor.cursorManager.getCursorPosition().col;var cheight=this.getHeight();var cwidth=this.getWidth()-this.gutterWidth;if(Math.abs(this.yoffset)>y){this.yoffset=Math.min(-y+cheight*pageScroll,0);}else if((Math.abs(this.yoffset)+cheight)<(y+this.lineHeight)){this.yoffset=-((y+this.lineHeight)-cheight*(1-pageScroll));this.yoffset=Math.max(this.yoffset,cheight-this.lineHeight*this.model.getRowCount());}
if(Math.abs(this.xoffset)>x){this.xoffset=-x;}else if((Math.abs(this.xoffset)+cwidth)<(x+(this.charWidth*2))){this.xoffset=-((x+(this.charWidth*2))-cwidth);}},handleFocus:function(e){this.editor.model.clear();this.editor.model.insertCharacters({row:0,col:0},e.type);},handleMouse:function(e){if(e.button==2){bespin.getComponent("piemenu",function(piemenu){piemenu.show(null,false,e.clientX,e.clientY);});dojo.stopEvent(e);return false;}
var clientY=e.clientY-this.getTopOffset();var clientX=e.clientX-this.getLeftOffset();var oldX=this.overXScrollBar;var oldY=this.overYScrollBar;var scrolled=false;var w=this.editor.container.clientWidth;var h=this.editor.container.clientHeight;var sx=w-this.NIB_WIDTH-this.NIB_INSETS.right;var sy=h-this.NIB_WIDTH-this.NIB_INSETS.bottom;var p={x:clientX,y:clientY};if(e.type=="mousedown"){if((this.xscrollbar)&&(this.xscrollbar.rect.contains(p))){this.xscrollbar.onmousedown(e);}else if((this.yscrollbar)&&(this.yscrollbar.rect.contains(p))){this.yscrollbar.onmousedown(e);}}
if(e.type=="mouseout"){this.overXScrollBar=false;this.overYScrollBar=false;}
if((e.type=="mousemove")||(e.type=="click")){this.overYScrollBar=(p.x>sx)&&this.yscrollbarVisible;this.overXScrollBar=(p.y>sy)&&this.xscrollbarVisible;}
if(e.type=="click"){if((typeof e.button!="undefined")&&(e.button==0)){var button;if(this.nibup.contains(p)){button="up";}else if(this.nibdown.contains(p)){button="down";}else if(this.nibleft.contains(p)){button="left";}else if(this.nibright.contains(p)){button="right";}
if(button=="up"){this.yoffset+=this.lineHeight;scrolled=true;}else if(button=="down"){this.yoffset-=this.lineHeight;scrolled=true;}else if(button=="left"){this.xoffset+=this.charWidth*2;scrolled=true;}else if(button=="right"){this.xoffset-=this.charWidth*2;scrolled=true;}}}
if((oldX!=this.overXScrollBar)||(oldY!=this.overYScrollBar)||scrolled)
this.editor.paint(true);},installKeyListener:function(listener){var Key=bespin.util.keys.Key;if(this.oldkeydown)dojo.disconnect(this.oldkeydown);if(this.oldkeypress)dojo.disconnect(this.oldkeypress);this.oldkeydown=dojo.hitch(listener,"onkeydown");this.oldkeypress=dojo.hitch(listener,"onkeypress");var scope=this.editor.opts.actsAsComponent?this.editor.canvas:window;dojo.connect(scope,"keydown",this,"oldkeydown");dojo.connect(scope,"keypress",this,"oldkeypress");listener.bindKeyStringSelectable("",Key.LEFT_ARROW,this.actions.moveCursorLeft,"Move Cursor Left");listener.bindKeyStringSelectable("",Key.RIGHT_ARROW,this.actions.moveCursorRight,"Move Cursor Right");listener.bindKeyStringSelectable("",Key.UP_ARROW,this.actions.moveCursorUp,"Move Cursor Up");listener.bindKeyStringSelectable("",Key.DOWN_ARROW,this.actions.moveCursorDown,"Move Cursor Down");listener.bindKeyForPlatform({MAC:"ALT LEFT_ARROW",WINDOWS:"CTRL LEFT_ARROW"},this.actions.moveWordLeft,"Move Word Left",true);listener.bindKeyForPlatform({MAC:"ALT RIGHT_ARROW",WINDOWS:"CTRL RIGHT_ARROW"},this.actions.moveWordRight,"Move Word Right",true);listener.bindKeyStringSelectable("",Key.HOME,this.actions.moveToLineStart,"Move to start of line");listener.bindKeyForPlatform({MAC:"APPLE LEFT_ARROW",WINDOWS:"ALT LEFT_ARROW"},this.actions.moveToLineStart,"Move to start of line",true);listener.bindKeyStringSelectable("",Key.END,this.actions.moveToLineEnd,"Move to end of line");listener.bindKeyForPlatform({MAC:"APPLE RIGHT_ARROW",WINDOWS:"ALT RIGHT_ARROW"},this.actions.moveToLineEnd,"Move to end of line",true);listener.bindKeyString("CTRL",Key.K,this.actions.killLine,"Kill entire line");listener.bindKeyString("CMD",Key.L,this.actions.gotoLine,"Goto Line");listener.bindKeyString("CTRL",Key.L,this.actions.moveCursorRowToCenter,"Move cursor to center of page");listener.bindKeyStringSelectable("",Key.BACKSPACE,this.actions.backspace,"Backspace");listener.bindKeyStringSelectable("CTRL",Key.BACKSPACE,this.actions.deleteWordLeft,"Delete a word to the left");listener.bindKeyString("",Key.DELETE,this.actions.deleteKey,"Delete");listener.bindKeyString("CTRL",Key.DELETE,this.actions.deleteWordRight,"Delete a word to the right");listener.bindKeyString("",Key.ENTER,this.actions.newline,"Insert newline");listener.bindKeyString("CMD",Key.ENTER,this.actions.newlineBelow,"Insert newline at end of current line");listener.bindKeyString("",Key.TAB,this.actions.insertTab,"Indent / insert tab");listener.bindKeyString("SHIFT",Key.TAB,this.actions.unindent,"Unindent");listener.bindKeyString("",Key.ESCAPE,this.actions.escape,"Clear fields and dialogs");listener.bindKeyString("CMD",Key.A,this.actions.selectAll,"Select All");listener.bindKeyString("CMD",Key.I,this.actions.toggleQuickopen,"Toggle Quickopen");listener.bindKeyString("CMD",Key.J,this.actions.focusCommandline,"Open Command line");listener.bindKeyString("CMD",Key.O,this.actions.focusFileBrowser,"Open File Browser");listener.bindKeyString("CMD",Key.F,this.actions.cmdFilesearch,"Search in this file");listener.bindKeyString("CMD",Key.G,this.actions.findNext,"Find Next");listener.bindKeyString("SHIFT CMD",Key.G,this.actions.findPrev,"Find Previous");listener.bindKeyString("CTRL",Key.M,this.actions.togglePieMenu,"Open Pie Menu");listener.bindKeyString("CMD",Key.B,bespin.preview.show,"Preview in Browser");listener.bindKeyString("CMD",Key.Z,this.actions.undo,"Undo");listener.bindKeyString("SHIFT CMD",Key.Z,this.actions.redo,"Redo");listener.bindKeyString("CMD",Key.Y,this.actions.redo,"Redo");listener.bindKeyStringSelectable("CMD",Key.UP_ARROW,this.actions.moveToFileTop,"Move to top of file");listener.bindKeyStringSelectable("CMD",Key.DOWN_ARROW,this.actions.moveToFileBottom,"Move to bottom of file");listener.bindKeyStringSelectable("CMD",Key.HOME,this.actions.moveToFileTop,"Move to top of file");listener.bindKeyStringSelectable("CMD",Key.END,this.actions.moveToFileBottom,"Move to bottom of file");listener.bindKeyStringSelectable("",Key.PAGE_UP,this.actions.movePageUp,"Move a page up");listener.bindKeyStringSelectable("",Key.PAGE_DOWN,this.actions.movePageDown,"Move a page down");listener.bindKeyStringSelectable("ALT",Key.UP_ARROW,this.actions.movePageUp,"Move up a block");listener.bindKeyStringSelectable("ALT",Key.DOWN_ARROW,this.actions.movePageDown,"Move down a block");listener.bindKeyString("CMD ALT",Key.LEFT_ARROW,this.actions.previousFile);listener.bindKeyString("CMD ALT",Key.RIGHT_ARROW,this.actions.nextFile);},getWidth:function(){return parseInt(dojo.style(this.editor.canvas.parentNode,"width"));},getHeight:function(){return parseInt(dojo.style(this.editor.canvas.parentNode,"height"));},getTopOffset:function(){return dojo.coords(this.editor.canvas.parentNode).y||this.editor.canvas.parentNode.offsetTop;},getLeftOffset:function(){return dojo.coords(this.editor.canvas.parentNode).x||this.editor.canvas.parentNode.offsetLeft;},getCharWidth:function(ctx){if(ctx.measureText){return ctx.measureText("M").width;}else{return this.FALLBACK_CHARACTER_WIDTH;}},getLineHeight:function(ctx){var lh=-1;if(ctx.measureText){var t=ctx.measureText("M");if(t.ascent)lh=Math.floor(t.ascent*2.8);}
if(lh==-1)lh=this.LINE_HEIGHT;return lh;},resetCanvas:function(){dojo.attr(dojo.byId(this.editor.canvas),{width:this.getWidth(),height:this.getHeight()});},fillText:function(ctx,text,x,y){ctx.fillText(text,x,y);},fillTextWithTransparency:function(ctx,text,x,y){ctx.globalAlpha=0.3;ctx.fillText(text,x,y);ctx.globalAlpha=1.0;},paint:function(ctx,fullRefresh){var ed=this.editor;var c=dojo.byId(ed.canvas);var theme=ed.theme;var x,y;var cy;var currentLine;var lastLineToRender;var Rect=bespin.editor.Rect;var refreshCanvas=fullRefresh;if(!refreshCanvas)refreshCanvas=(this.selectMouseDownPos);if(!refreshCanvas)refreshCanvas=(this.lastLineCount!=ed.model.getRowCount());this.lastLineCount=ed.model.getRowCount();ctx.font=theme.editorTextFont;this.charWidth=this.getCharWidth(ctx);this.lineHeight=this.getLineHeight(ctx);var cwidth=this.getWidth();var cheight=this.getHeight();if(this.xoffset>0)this.xoffset=0;if(this.yoffset>0)this.yoffset=0;this.visibleRows=Math.ceil(cheight/this.lineHeight);this.firstVisibleRow=Math.floor(Math.abs(this.yoffset/this.lineHeight));lastLineToRender=this.firstVisibleRow+this.visibleRows;if(lastLineToRender>(ed.model.getRowCount()-1))lastLineToRender=ed.model.getRowCount()-1;var virtualheight=this.lineHeight*ed.model.getRowCount();var virtualwidth=this.charWidth*(Math.max(this.getMaxCols(this.firstVisibleRow,lastLineToRender),ed.cursorManager.getCursorPosition().col)+2);this.gutterWidth=this.GUTTER_INSETS.left+this.GUTTER_INSETS.right;this.gutterWidth+=(""+lastLineToRender).length*this.charWidth;if(this.editor.debugMode)this.gutterWidth+=this.DEBUG_GUTTER_WIDTH;if(this.xoffset<0){if((Math.abs(this.xoffset))>(virtualwidth-(cwidth-this.gutterWidth)))this.xoffset=(cwidth-this.gutterWidth)-virtualwidth;}
if(this.yoffset<0){if((Math.abs(this.yoffset))>(virtualheight-(cheight-this.BOTTOM_SCROLL_AFFORDANCE)))this.yoffset=cheight-(virtualheight-this.BOTTOM_SCROLL_AFFORDANCE);}
if((this.xoffset!=this.lastxoffset)||(this.yoffset!=this.lastyoffset)){refreshCanvas=true;this.lastxoffset=this.xoffset;this.lastyoffset=this.yoffset;}
var xscroll=((cwidth-this.gutterWidth)<virtualwidth);var yscroll=(cheight<virtualheight);var verticalx=cwidth-this.NIB_WIDTH-this.NIB_INSETS.right-2;var horizontaly=cheight-this.NIB_WIDTH-this.NIB_INSETS.bottom-2;var showLeftScrollNib=(xscroll&&(this.xoffset!=0));var showRightScrollNib=(xscroll&&(this.xoffset>((cwidth-this.gutterWidth)-virtualwidth)));var showUpScrollNib=(yscroll&&(this.yoffset!=0));var showDownScrollNib=(yscroll&&(this.yoffset>(cheight-virtualheight)));if(((dojo.attr(c,"width"))!=cwidth)||(dojo.attr(c,"height")!=cheight)){refreshCanvas=true;dojo.attr(c,{width:cwidth,height:cheight});}
var breakpoints={};var lineMarkers=bespin.get("parser").getLineMarkers();if(this.editor.debugMode&&bespin.get("editSession")){bespin.getComponent("breakpoints",function(bpmanager){var points=bpmanager.getBreakpoints(bespin.get('editSession').project,bespin.get('editSession').path);dojo.forEach(points,function(point){breakpoints[point.lineNumber]=point;});delete points;});}
if(!refreshCanvas){var dirty=ed.model.getDirtyRows();if((this.lastCursorPos)&&(this.lastCursorPos.row!=ed.cursorManager.getCursorPosition().row))dirty[this.lastCursorPos.row]=true;dirty[ed.cursorManager.getCursorPosition().row]=true;}
this.lastCursorPos=bespin.editor.utils.copyPos(ed.cursorManager.getCursorPosition());if(refreshCanvas){ctx.fillStyle=theme.backgroundStyle;ctx.fillRect(0,0,c.width,c.height);ctx.fillStyle=theme.gutterStyle;ctx.fillRect(0,0,this.gutterWidth,c.height);}
ctx.save();ctx.translate(0,Math.round(this.yoffset));if(refreshCanvas){if(bespin.get("parser")){for(currentLine=this.firstVisibleRow;currentLine<=lastLineToRender;currentLine++){if(lineMarkers[currentLine]){y=this.lineHeight*(currentLine-1);cy=y+(this.lineHeight-this.LINE_INSETS.bottom);ctx.fillStyle=this.editor.theme["lineMarker"+lineMarkers[currentLine].type+"Color"];ctx.fillRect(0,y,this.gutterWidth,this.lineHeight);}}}
y=(this.lineHeight*this.firstVisibleRow);for(currentLine=this.firstVisibleRow;currentLine<=lastLineToRender;currentLine++){x=0;if(this.editor.debugMode){if(breakpoints[currentLine]){var bpx=x+this.DEBUG_GUTTER_INSETS.left;var bpy=y+this.DEBUG_GUTTER_INSETS.top;var bpw=this.DEBUG_GUTTER_WIDTH-this.DEBUG_GUTTER_INSETS.left-this.DEBUG_GUTTER_INSETS.right;var bph=this.lineHeight-this.DEBUG_GUTTER_INSETS.top-this.DEBUG_GUTTER_INSETS.bottom;var bpmidpointx=bpx+parseInt(bpw/2);var bpmidpointy=bpy+parseInt(bph/2);ctx.strokeStyle="rgb(128, 0, 0)";ctx.fillStyle="rgb(255, 102, 102)";ctx.beginPath();ctx.arc(bpmidpointx,bpmidpointy,bpw/2,0,Math.PI*2,true);ctx.closePath();ctx.fill();ctx.stroke();}
x+=this.DEBUG_GUTTER_WIDTH;}
x+=this.GUTTER_INSETS.left;cy=y+(this.lineHeight-this.LINE_INSETS.bottom);ctx.fillStyle=theme.lineNumberColor;ctx.font=this.editor.theme.lineNumberFont;ctx.fillText(currentLine+1,x,cy);y+=this.lineHeight;}}
ctx.save();ctx.beginPath();ctx.rect(this.gutterWidth,-this.yoffset,cwidth-this.gutterWidth,cheight);ctx.closePath();ctx.translate(this.xoffset,0);ctx.clip();var firstColumn=Math.floor(Math.abs(this.xoffset/this.charWidth));var lastColumn=firstColumn+(Math.ceil((cwidth-this.gutterWidth)/this.charWidth));y=(this.lineHeight*this.firstVisibleRow);var cc;var ce;var ri;var regionlen;var tx,tw,tsel;var settings=bespin.get("settings");var searchStringLength=(this.searchString?this.searchString.length:-1);for(currentLine=this.firstVisibleRow;currentLine<=lastLineToRender;currentLine++){x=this.gutterWidth;if(!refreshCanvas){if(!dirty[currentLine]){y+=this.lineHeight;continue;}
ctx.save();ctx.beginPath();ctx.rect(x+(Math.abs(this.xoffset)),y,cwidth,this.lineHeight);ctx.closePath();ctx.clip();if((currentLine%2)==1){ctx.fillStyle=theme.backgroundStyle;ctx.fillRect(x+(Math.abs(this.xoffset)),y,cwidth,this.lineHeight);}}
if((settings&&settings.isSettingOn('highlightline'))&&(currentLine==ed.cursorManager.getCursorPosition().row)){ctx.fillStyle=theme.highlightCurrentLineColor;ctx.fillRect(x+(Math.abs(this.xoffset)),y,cwidth,this.lineHeight);}else if((currentLine%2)==0){ctx.fillStyle=theme.zebraStripeColor;ctx.fillRect(x+(Math.abs(this.xoffset)),y,cwidth,this.lineHeight);}
x+=this.LINE_INSETS.left;cy=y+(this.lineHeight-this.LINE_INSETS.bottom);var selections=this.selectionHelper.getRowSelectionPositions(currentLine);if(selections){tx=x+(selections.startCol*this.charWidth);tw=(selections.endCol==-1)?(lastColumn-firstColumn)*this.charWidth:(selections.endCol-selections.startCol)*this.charWidth;ctx.fillStyle=theme.editorSelectedTextBackground;ctx.fillRect(tx,y,tw,this.lineHeight);}
var lineMetadata=this.model.getRowMetadata(currentLine);var lineText=lineMetadata.lineText;var searchIndices=lineMetadata.searchIndices;var lineInfo=this.syntaxModel.getSyntaxStylesPerLine(lineText,currentLine,this.editor.language);var readOnlyAwareFill=ed.readonly?this.fillTextWithTransparency:this.fillText;for(ri=0;ri<lineInfo.regions.length;ri++){var styleInfo=lineInfo.regions[ri];for(var style in styleInfo){if(!styleInfo.hasOwnProperty(style))continue;var thisLine="";var styleArray=styleInfo[style];var currentColumn=0;for(var si=0;si<styleArray.length;si++){var range=styleArray[si];for(;currentColumn<range.start;currentColumn++)thisLine+=" ";thisLine+=lineInfo.text.substring(range.start,range.stop);currentColumn=range.stop;}
ctx.fillStyle=this.editor.theme[style]||"white";ctx.font=this.editor.theme.editorTextFont;readOnlyAwareFill(ctx,thisLine,x,cy);}}
if(searchIndices){if(selections){tsel={startCol:0,endCol:lineText.length};if(selections.startCol!=-1)tsel.startCol=selections.startCol;if(selections.endCol!=-1)tsel.endCol=selections.endCol;}else{tsel=false;}
for(var i=0;i<searchIndices.length;i++){var index=ed.cursorManager.getCursorPosition({col:searchIndices[i],row:currentLine}).col;tx=x+index*this.charWidth;ctx.fillStyle=this.editor.theme.searchHighlight;ctx.fillRect(tx,y,searchStringLength*this.charWidth,this.lineHeight);if(tsel){var indexStart=index;var indexEnd=index+searchStringLength;if(tsel.startCol<indexEnd&&tsel.endCol>indexStart){indexStart=Math.max(indexStart,tsel.startCol);indexEnd=Math.min(indexEnd,tsel.endCol);ctx.fillStyle=this.editor.theme.searchHighlightSelected;ctx.fillRect(x+indexStart*this.charWidth,y,(indexEnd-indexStart)*this.charWidth,this.lineHeight);}}
ctx.fillStyle=this.editor.theme.editorTextColor||"white";ctx.fillText(lineText.substring(index,index+searchStringLength),tx,cy);}}
if(settings&&(settings.isSettingOn("tabarrow")||settings.isSettingOn("tabshowspace"))){if(lineMetadata.tabExpansions.length>0){for(var i=0;i<lineMetadata.tabExpansions.length;i++){var expansion=lineMetadata.tabExpansions[i];var lx=x+(expansion.start*this.charWidth);var showTabSpace=settings&&settings.isSettingOn("tabshowspace");if(showTabSpace){var sw=(expansion.end-expansion.start)*this.charWidth;ctx.fillStyle=this.editor.theme["tabSpace"]||"white";ctx.fillRect(lx,y,sw,this.lineHeight);}
var showTabNib=settings&&settings.isSettingOn("tabarrow");if(showTabNib){var cy=y+(this.lineHeight/2);var cx=lx+(this.charWidth/2);var tw=4;var th=6;var tx=parseInt(cx-(tw/2));var ty=parseInt(cy-(th/2));ctx.globalAlpha=0.3;ctx.beginPath();ctx.fillStyle=this.editor.theme["plain"]||"white";ctx.moveTo(tx,ty);ctx.lineTo(tx,ty+th);ctx.lineTo(tx+tw,ty+parseInt(th/2));ctx.closePath();ctx.fill();ctx.globalAlpha=1.0;}}}}
if(!refreshCanvas){ctx.drawImage(this.verticalScrollCanvas,verticalx+Math.abs(this.xoffset),Math.abs(this.yoffset));ctx.restore();}
y+=this.lineHeight;}
if(this.editor.focus){if(this.showCursor){if(ed.theme.cursorType=="underline"){x=this.gutterWidth+this.LINE_INSETS.left+ed.cursorManager.getCursorPosition().col*this.charWidth;y=(ed.getCursorPos().row*this.lineHeight)+(this.lineHeight-5);ctx.fillStyle=ed.theme.cursorStyle;ctx.fillRect(x,y,this.charWidth,3);}else{x=this.gutterWidth+this.LINE_INSETS.left+ed.cursorManager.getCursorPosition().col*this.charWidth;y=(ed.cursorManager.getCursorPosition().row*this.lineHeight);ctx.fillStyle=ed.theme.cursorStyle;ctx.fillRect(x,y,1,this.lineHeight);}}}else{x=this.gutterWidth+this.LINE_INSETS.left+ed.cursorManager.getCursorPosition().col*this.charWidth;y=(ed.cursorManager.getCursorPosition().row*this.lineHeight);ctx.fillStyle=ed.theme.unfocusedCursorFillStyle;ctx.strokeStyle=ed.theme.unfocusedCursorStrokeStyle;ctx.fillRect(x,y,this.charWidth,this.lineHeight);ctx.strokeRect(x,y,this.charWidth,this.lineHeight);}
ctx.restore();ctx.restore();if(!refreshCanvas)return;if(this.horizontalScrollCanvas.width!=cwidth)this.horizontalScrollCanvas.width=cwidth;if(this.horizontalScrollCanvas.height!=this.NIB_WIDTH+4)this.horizontalScrollCanvas.height=this.NIB_WIDTH+4;if(this.verticalScrollCanvas.height!=cheight)this.verticalScrollCanvas.height=cheight;if(this.verticalScrollCanvas.width!=this.NIB_WIDTH+4)this.verticalScrollCanvas.width=this.NIB_WIDTH+4;var hctx=this.horizontalScrollCanvas.getContext("2d");hctx.clearRect(0,0,this.horizontalScrollCanvas.width,this.horizontalScrollCanvas.height);hctx.save();var vctx=this.verticalScrollCanvas.getContext("2d");vctx.clearRect(0,0,this.verticalScrollCanvas.width,this.verticalScrollCanvas.height);vctx.save();var ythemes=(this.overYScrollBar)||(this.yscrollbar.mousedownValue!=null)?{n:ed.theme.fullNibStyle,a:ed.theme.fullNibArrowStyle,s:ed.theme.fullNibStrokeStyle}:{n:ed.theme.partialNibStyle,a:ed.theme.partialNibArrowStyle,s:ed.theme.partialNibStrokeStyle};var xthemes=(this.overXScrollBar)||(this.xscrollbar.mousedownValue!=null)?{n:ed.theme.fullNibStyle,a:ed.theme.fullNibArrowStyle,s:ed.theme.fullNibStrokeStyle}:{n:ed.theme.partialNibStyle,a:ed.theme.partialNibArrowStyle,s:ed.theme.partialNibStrokeStyle};var midpoint=Math.floor(this.NIB_WIDTH/2);this.nibup=new Rect(cwidth-this.NIB_INSETS.right-this.NIB_WIDTH,this.NIB_INSETS.top,this.NIB_WIDTH,this.NIB_WIDTH);this.nibdown=new Rect(cwidth-this.NIB_INSETS.right-this.NIB_WIDTH,cheight-(this.NIB_WIDTH*2)-(this.NIB_INSETS.bottom*2),this.NIB_INSETS.top,this.NIB_WIDTH,this.NIB_WIDTH);this.nibleft=new Rect(this.gutterWidth+this.NIB_INSETS.left,cheight-this.NIB_INSETS.bottom-this.NIB_WIDTH,this.NIB_WIDTH,this.NIB_WIDTH);this.nibright=new Rect(cwidth-(this.NIB_INSETS.right*2)-(this.NIB_WIDTH*2),cheight-this.NIB_INSETS.bottom-this.NIB_WIDTH,this.NIB_WIDTH,this.NIB_WIDTH);vctx.translate(-verticalx,0);hctx.translate(0,-horizontaly);if(xscroll&&((this.overXScrollBar)||(this.xscrollbar.mousedownValue!=null))){hctx.save();hctx.beginPath();hctx.rect(this.nibleft.x+midpoint+2,0,this.nibright.x-this.nibleft.x-1,cheight);hctx.closePath();hctx.clip();hctx.fillStyle=ed.theme.scrollTrackFillStyle;hctx.fillRect(this.nibleft.x,this.nibleft.y-1,this.nibright.x2-this.nibleft.x,this.nibleft.h+1);hctx.strokeStyle=ed.theme.scrollTrackStrokeStyle;hctx.strokeRect(this.nibleft.x,this.nibleft.y-1,this.nibright.x2-this.nibleft.x,this.nibleft.h+1);hctx.restore();}
if(yscroll&&((this.overYScrollBar)||(this.yscrollbar.mousedownValue!=null))){vctx.save();vctx.beginPath();vctx.rect(0,this.nibup.y+midpoint+2,cwidth,this.nibdown.y-this.nibup.y-1);vctx.closePath();vctx.clip();vctx.fillStyle=ed.theme.scrollTrackFillStyle;vctx.fillRect(this.nibup.x-1,this.nibup.y,this.nibup.w+1,this.nibdown.y2-this.nibup.y);vctx.strokeStyle=ed.theme.scrollTrackStrokeStyle;vctx.strokeRect(this.nibup.x-1,this.nibup.y,this.nibup.w+1,this.nibdown.y2-this.nibup.y);vctx.restore();}
if(yscroll){if((showUpScrollNib)||(this.overYScrollBar)||(this.yscrollbar.mousedownValue!=null)){vctx.save();vctx.translate(this.nibup.x+midpoint,this.nibup.y+midpoint);this.paintNib(vctx,ythemes.n,ythemes.a,ythemes.s);vctx.restore();}
if((showDownScrollNib)||(this.overYScrollBar)||(this.yscrollbar.mousedownValue!=null)){vctx.save();vctx.translate(this.nibdown.x+midpoint,this.nibdown.y+midpoint);vctx.rotate(Math.PI);this.paintNib(vctx,ythemes.n,ythemes.a,ythemes.s);vctx.restore();}}
if(xscroll){if((showLeftScrollNib)||(this.overXScrollBar)||(this.xscrollbar.mousedownValue!=null)){hctx.save();hctx.translate(this.nibleft.x+midpoint,this.nibleft.y+midpoint);hctx.rotate(Math.PI*1.5);this.paintNib(hctx,xthemes.n,xthemes.a,xthemes.s);hctx.restore();}
if((showRightScrollNib)||(this.overXScrollBar)||(this.xscrollbar.mousedownValue!=null)){hctx.save();hctx.translate(this.nibright.x+midpoint,this.nibright.y+midpoint);hctx.rotate(Math.PI*0.5);this.paintNib(hctx,xthemes.n,xthemes.a,xthemes.s);hctx.restore();}}
var sx=this.nibleft.x2+4;var sw=this.nibright.x-this.nibleft.x2-9;this.xscrollbar.rect=new Rect(sx,this.nibleft.y-1,sw,this.nibleft.h+1);this.xscrollbar.value=-this.xoffset;this.xscrollbar.min=0;this.xscrollbar.max=virtualwidth-(cwidth-this.gutterWidth);this.xscrollbar.extent=cwidth-this.gutterWidth;if(xscroll){var fullonxbar=(((this.overXScrollBar)&&(virtualwidth>cwidth))||((this.xscrollbar)&&(this.xscrollbar.mousedownValue!=null)));if(!fullonxbar)hctx.globalAlpha=0.3;this.paintScrollbar(hctx,this.xscrollbar);hctx.globalAlpha=1.0;}
var sy=this.nibup.y2+4;var sh=this.nibdown.y-this.nibup.y2-9;this.yscrollbar.rect=new Rect(this.nibup.x-1,sy,this.nibup.w+1,sh);this.yscrollbar.value=-this.yoffset;this.yscrollbar.min=0;this.yscrollbar.max=virtualheight-(cheight-this.BOTTOM_SCROLL_AFFORDANCE);this.yscrollbar.extent=cheight;if(yscroll){var fullonybar=((this.overYScrollBar)&&(virtualheight>cheight))||((this.yscrollbar)&&(this.yscrollbar.mousedownValue!=null));if(!fullonybar)vctx.globalAlpha=0.3;this.paintScrollbar(vctx,this.yscrollbar);vctx.globalAlpha=1;}
ctx.drawImage(this.verticalScrollCanvas,verticalx,0);ctx.drawImage(this.horizontalScrollCanvas,0,horizontaly);hctx.restore();vctx.restore();if(!showUpScrollNib)this.nibup=new Rect();if(!showDownScrollNib)this.nibdown=new Rect();if(!showLeftScrollNib)this.nibleft=new Rect();if(!showRightScrollNib)this.nibright=new Rect();this.xscrollbarVisible=xscroll;this.yscrollbarVisible=yscroll;},paintScrollbar:function(ctx,scrollbar){var bar=scrollbar.getHandleBounds();var alpha=(ctx.globalAlpha)?ctx.globalAlpha:1;if(!scrollbar.isH()){ctx.save();ctx.translate(bar.x+Math.floor(bar.w/2),bar.y+Math.floor(bar.h/2));ctx.rotate(Math.PI*1.5);ctx.translate(-(bar.x+Math.floor(bar.w/2)),-(bar.y+Math.floor(bar.h/2)));bar=new bespin.editor.Rect(bar.x-Math.floor(bar.h/2)+Math.floor(bar.w/2),bar.y+Math.floor(bar.h/2)-Math.floor(bar.w/2),bar.h,bar.w);}
var halfheight=bar.h/2;ctx.beginPath();ctx.arc(bar.x+halfheight,bar.y+halfheight,halfheight,Math.PI/2,3*(Math.PI/2),false);ctx.arc(bar.x2-halfheight,bar.y+halfheight,halfheight,3*(Math.PI/2),Math.PI/2,false);ctx.lineTo(bar.x+halfheight,bar.y+bar.h);ctx.closePath();var gradient=ctx.createLinearGradient(bar.x,bar.y,bar.x,bar.y+bar.h);gradient.addColorStop(0,this.editor.theme.scrollBarFillGradientTopStart.replace(/%a/,alpha));gradient.addColorStop(0.4,this.editor.theme.scrollBarFillGradientTopStop.replace(/%a/,alpha));gradient.addColorStop(0.41,this.editor.theme.scrollBarFillStyle.replace(/%a/,alpha));gradient.addColorStop(0.8,this.editor.theme.scrollBarFillGradientBottomStart.replace(/%a/,alpha));gradient.addColorStop(1,this.editor.theme.scrollBarFillGradientBottomStop.replace(/%a/,alpha));ctx.fillStyle=gradient;ctx.fill();ctx.save();ctx.clip();ctx.fillStyle=this.editor.theme.scrollBarFillStyle.replace(/%a/,alpha);ctx.beginPath();ctx.moveTo(bar.x+(halfheight*0.4),bar.y+(halfheight*0.6));ctx.lineTo(bar.x+(halfheight*0.9),bar.y+(bar.h*0.4));ctx.lineTo(bar.x,bar.y+(bar.h*0.4));ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(bar.x+bar.w-(halfheight*0.4),bar.y+(halfheight*0.6));ctx.lineTo(bar.x+bar.w-(halfheight*0.9),bar.y+(bar.h*0.4));ctx.lineTo(bar.x+bar.w,bar.y+(bar.h*0.4));ctx.closePath();ctx.fill();ctx.restore();ctx.beginPath();ctx.arc(bar.x+halfheight,bar.y+halfheight,halfheight,Math.PI/2,3*(Math.PI/2),false);ctx.arc(bar.x2-halfheight,bar.y+halfheight,halfheight,3*(Math.PI/2),Math.PI/2,false);ctx.lineTo(bar.x+halfheight,bar.y+bar.h);ctx.closePath();ctx.strokeStyle=this.editor.theme.scrollTrackStrokeStyle;ctx.stroke();if(!scrollbar.isH()){ctx.restore();}},paintNib:function(ctx,nibStyle,arrowStyle,strokeStyle){var midpoint=Math.floor(this.NIB_WIDTH/2);ctx.fillStyle=nibStyle;ctx.beginPath();ctx.arc(0,0,Math.floor(this.NIB_WIDTH/2),0,Math.PI*2,true);ctx.closePath();ctx.fill();ctx.strokeStyle=strokeStyle;ctx.stroke();ctx.fillStyle=arrowStyle;ctx.beginPath();ctx.moveTo(0,-midpoint+this.NIB_ARROW_INSETS.top);ctx.lineTo(-midpoint+this.NIB_ARROW_INSETS.left,midpoint-this.NIB_ARROW_INSETS.bottom);ctx.lineTo(midpoint-this.NIB_ARROW_INSETS.right,midpoint-this.NIB_ARROW_INSETS.bottom);ctx.closePath();ctx.fill();},getRowString:function(row){return this.model.getRowMetadata(row).lineText;},getRowScreenLength:function(row){return this.getRowString(row).length;},getMaxCols:function(firstRow,lastRow){var cols=0;for(var i=firstRow;i<=lastRow;i++){cols=Math.max(cols,this.getRowScreenLength(i));}
return cols;},setSearchString:function(str){if(str&&str!=''){this.searchString=str;}else{delete this.searchString;}
this.model.searchStringChanged(this.searchString);this.editor.paint(true);},dispose:function(){for(var i=0;i<this.globalHandles.length;i++){dojo.disconnect(this.globalHandles[i]);}}});dojo.declare("bespin.editor.API",null,{constructor:function(container,opts){this.opts=opts||{};this.debugMode=false;this.container=dojo.byId(container);this.model=new bespin.editor.DocumentModel(this);this.container.innerHTML='<canvas id="canvas" moz-opaque="true" tabindex="-1"></canvas>';this.canvas=this.container.firstChild;while(this.canvas&&this.canvas.nodeType!=1)this.canvas=this.canvas.nextSibling;this.cursorManager=new bespin.editor.CursorManager(this);this.ui=new bespin.editor.UI(this);this.theme=bespin.themes['default'];this.editorKeyListener=new bespin.editor.DefaultEditorKeyListener(this);this.historyManager=new bespin.editor.HistoryManager(this);this.customEvents=new bespin.editor.Events(this);this.ui.installKeyListener(this.editorKeyListener);this.model.insertCharacters({row:0,col:0}," ");dojo.connect(this.canvas,"blur",dojo.hitch(this,function(e){this.setFocus(false);}));dojo.connect(this.canvas,"focus",dojo.hitch(this,function(e){this.setFocus(true);}));bespin.editor.clipboard.setup(this);this.paint();if(!this.opts.dontfocus){this.setFocus(true);}},getSelection:function(selection){selection=(selection!=undefined)?selection:this.selection;if(!selection)return undefined;var startPos=selection.startPos;var endPos=selection.endPos;if((endPos.row<startPos.row)||((endPos.row==startPos.row)&&(endPos.col<startPos.col))){var foo=startPos;startPos=endPos;endPos=foo;}
return{startPos:bespin.editor.utils.copyPos(startPos),endPos:bespin.editor.utils.copyPos(endPos),startModelPos:this.getModelPos(startPos),endModelPos:this.getModelPos(endPos)};},getCursorPos:function(modelPos){return this.cursorManager.getCursorPosition(modelPos);},getModelPos:function(pos){return this.cursorManager.getModelPosition(pos);},moveCursor:function(pos){this.cursorManager.moveCursor(pos);},resetView:function(data){this.cursorManager.moveCursor(data.cursor);this.setSelection(data.selection);this.ui.yoffset=data.offset.y;this.ui.xoffset=data.offset.x;},basicView:function(){this.cursorManager.moveCursor({row:0,col:0});this.setSelection(undefined);this.ui.yoffset=0;this.ui.xoffset=0;},getCurrentView:function(){return{cursor:this.getCursorPos(),offset:{x:this.ui.xoffset,y:this.ui.yoffset},selection:this.selection};},getState:function(){return{cursor:this.getCursorPos(),selection:this.getSelection()};},setState:function(data){this.cursorManager.moveCursor(data.cursor);this.setSelection(data.selection);this.ui.ensureCursorVisible();this.paint(false);},getTabSize:function(){var settings=bespin.get("settings");var size=bespin.defaultTabSize;if(settings){var tabsize=parseInt(settings.get("tabsize"));if(tabsize>0)size=tabsize;}
return size;},getSelectionAsText:function(){var selectionText='';var selectionObject=this.getSelection();if(selectionObject){selectionText=this.model.getChunk(selectionObject);}
return selectionText;},setSelection:function(selection){this.selection=selection;},paint:function(fullRefresh){var ctx=bespin.util.canvas.fix(this.canvas.getContext("2d"));this.ui.paint(ctx,fullRefresh);},changeKeyListener:function(newKeyListener){this.ui.installKeyListener(newKeyListener);this.editorKeyListener=newKeyListener;},setFocus:function(focus){this.focus=focus;if(focus){this.canvas.focus();}},setReadOnly:function(readonly){this.readonly=readonly;},dispose:function(){bespin.editor.clipboard.uninstall();this.ui.dispose();},bindKey:function(action,keySpec,selectable){console.warn("Use of editor.bindKey(",action,keySpec,selectable,") seems doomed to fail");var keyObj=bespin.util.keys.fillArguments(keySpec);var key=keyObj.key;var modifiers=keyObj.modifiers;if(!key){return;}
var keyCode=bespin.util.keys.toKeyCode(key);var actionDescription="Execute command: '"+action+"'";var action=this.ui.actions[action]||function(){bespin.get('commandLine').executeCommand(command,true);};if(keyCode&&action){if(selectable){this.editorKeyListener.bindKeyStringSelectable(modifiers,keyCode,action,actionDescription);}else{this.editorKeyListener.bindKeyString(modifiers,keyCode,action,actionDescription);}}},bindCommand:function(command,keySpec){var keyObj=bespin.util.keys.fillArguments(keySpec);var keyCode=bespin.util.keys.toKeyCode(keyObj.key);var action=function(){bespin.getComponent("commandLine",function(cli){cli.executeCommand(command,true);});};var actionDescription="Execute command: '"+command+"'";this.editorKeyListener.bindKeyString(keyObj.modifiers,keyCode,action,actionDescription);},moveAndCenter:function(row){if(!row)return;var linenum=row-1;this.cursorManager.moveCursor({row:linenum,col:0});if((linenum<this.ui.firstVisibleRow)||(linenum>=this.ui.firstVisibleRow+this.ui.visibleRows)){this.ui.actions.moveCursorRowToCenter();}},newFile:function(project,path,content){project=project||bespin.get('editSession').project;path=path||"new.txt";var self=this;var onSuccess=function(){if(bespin.get("settings").isSettingOff("collaborate")){self.model.insertDocument(content||"");self.cursorManager.moveCursor({row:0,col:0});self.setFocus(true);}
bespin.publish("editor:openfile:opensuccess",{file:{name:path,content:content||"",timestamp:new Date().getTime()}});bespin.publish("editor:dirty");};bespin.get('files').newFile(project,path,onSuccess);},saveFile:function(project,filename,onSuccess,onFailure){project=project||bespin.get('editSession').project;filename=filename||bespin.get('editSession').path;dojo.cookie('viewData_'+project+'_'+filename.split('/').join('_'),dojo.toJson(bespin.get('editor').getCurrentView()),{expires:7});var file={name:filename,content:this.model.getDocument(),timestamp:new Date().getTime()};var newOnSuccess=function(){document.title=filename+' - editing with Bespin';var commandLine=bespin.get("commandLine");if(commandLine)commandLine.showHint('Saved file: '+file.name);bespin.publish("editor:clean");if(dojo.isFunction(onSuccess)){onSuccess();}};var newOnFailure=function(xhr){var commandLine=bespin.get("commandLine");if(commandLine)commandLine.showHint('Save failed: '+xhr.responseText);if(dojo.isFunction(onFailure)){onFailure();}};bespin.publish("editor:savefile:before",{filename:filename});bespin.get('files').saveFile(project,file,newOnSuccess,newOnFailure);},openFile:function(project,filename,options){var session=bespin.get('editSession');var commandLine=bespin.get('commandLine');var self=this;var project=project||session.project;var filename=filename||session.path;var options=options||{};var fromFileHistory=options.fromFileHistory||false;if(session.checkSameFile(project,filename)&&!options.reload){if(options.line){commandLine.executeCommand('goto '+options.line,true);}
return;}
if(this.dirty){var onFailure=function(xhr){commandLine.showHint("Trying to save current file. Failed: "+xhr.responseText);};var onSuccess=function(){self.openFile(project,filename,options);};this.saveFile(project,filename,onSuccess,onFailure);return;}
if(options.force){bespin.get('files').whenFileDoesNotExist(project,filename,{execute:function(){self.newFile(project,filename,options.content||"");},elseFailed:function(){options.force=false;self.openFile(project,filename,options);}});return;}
var onFailure=function(){bespin.publish("editor:openfile:openfail",{project:project,filename:filename});};var onSuccess=function(file){if(!file){onFailure();return;}
if(file.content!==undefined){self.model.insertDocument(file.content);self.cursorManager.moveCursor({row:0,col:0});self.setFocus(true);}
session.setProjectPath(project,filename);if(options.line){commandLine.executeCommand('goto '+options.line,true);}
self._addHistoryItem(project,filename,fromFileHistory);bespin.publish("editor:openfile:opensuccess",{project:project,file:file});};bespin.publish("editor:openfile:openbefore",{project:project,filename:filename});bespin.get('files').collaborateOnFile(project,filename,onSuccess,onFailure);},_addHistoryItem:function(project,filename,fromFileHistory){var settings=bespin.get("settings");var lastUsed=settings.getObject("_lastused");if(!lastUsed){lastUsed=[];}
var newItem={project:project,filename:filename};if(!fromFileHistory){bespin.get('editSession').addFileToHistory(newItem);}
var cleanLastUsed=[];dojo.forEach(lastUsed,function(item){if(item.project!=newItem.project||item.filename!=newItem.filename){cleanLastUsed.unshift(item);}});cleanLastUsed.unshift(newItem);lastUsed=cleanLastUsed;if(lastUsed.length>10){lastUsed=lastUsed.slice(0,10);}
settings.setObject("_lastused",lastUsed);}});bespin.subscribe("extension:loaded:bespin.debugger",function(ext){var settings=bespin.get("settings");if(settings&&settings.get("debugmode")){ext.load();}});
dojo.require("bespin.util.util");dojo.provide("bespin.editor.events");dojo.declare("bespin.editor.Events",null,{constructor:function(editor){bespin.subscribe("editor:openfile:opensuccess",function(event){var project=event.project||bespin.get('editSession').project;var filename=event.file.name;try{var data=dojo.cookie('viewData_'+project+'_'+filename.split('/').join('_'));if(data){bespin.get('editor').resetView(dojo.fromJson(data));}else{bespin.get('editor').basicView();}}catch(e){console.log("Error setting in the view: ",e);}
document.title=filename+' - editing with Bespin';bespin.publish("url:change",{project:project,path:filename});});bespin.subscribe("url:change",function(event){var hashArguments=dojo.queryToObject(location.hash.substring(1));hashArguments.project=event.project;hashArguments.path=event.path;var pairs=[];for(var name in hashArguments){var value=hashArguments[name];pairs.push(name+'='+value);}
window.location.hash=pairs.join("&");});bespin.subscribe("url:changed",function(event){editor.openFile(null,event.now.get('path'));});bespin.subscribe("cmdline:focus",function(event){editor.setFocus(false);});bespin.subscribe("cmdline:blur",function(event){editor.setFocus(true);});bespin.subscribe("editor:document:changed",function(event){bespin.publish("editor:dirty");});bespin.subscribe("editor:dirty",function(event){editor.dirty=true;});bespin.subscribe("editor:clean",function(event){editor.dirty=false;});}});
dojo.provide("bespin.editor.model");dojo.declare("bespin.editor.DocumentModel",null,{constructor:function(editor){this.editor=editor;this.clear();},addHistoryItem:function(func,data){this.history.length=this.historyIndex+1;this.history.push({func:func,data:data});this.historyIndex++;},performHistoryItem:function(item){var func=item.func;var data=item.data;switch(func){case'deleteCharacters':this.deleteCharacters(data.pos,data.characters.length,true);break;case'insertCharacters':this.insertCharacters(data.pos,data.characters,true);break;case'deleteChunk':this.deleteChunk(data.selection,data.chunk,true);break;case'insertChunk':this.insertChunk(data.selection.startModelPos,data.chunk,true);break;case'joinRow':this.joinRow(data.selection.startModelPos.row,true);break;case'replaceRow':console.debug(['Call replaceRow',item]);this.replaceRow(data.row,item.undo?data.oldline:data.newline,true);break;}},unperformHistoryItem:function(item){var func=item.func;var data=item.data;switch(func){case'deleteCharacters':func='insertCharacters';break;case'insertCharacters':func='deleteCharacters';break;case'deleteChunk':func='insertChunk';break;case'insertChunk':func='deleteChunk';break;case'joinRow':func='insertChunk';break;}
this.performHistoryItem({func:func,data:data,undo:true});},applyState:function(state){if(state>=this.history.length||state<-1){return;}else if(state==this.historyIndex){return;}
if(state>this.historyIndex){for(var i=this.historyIndex+1;i<=state;i++){var historyItem=this.history[i];this.performHistoryItem(historyItem);}}else{for(var i=this.historyIndex;i>state;i--){var historyItem=this.history[i];this.unperformHistoryItem(historyItem);}}
this.historyIndex=state;},getState:function(){return this.historyIndex;},isEmpty:function(){if(this.rows.length>1)return false;if(this.rows.length==1&&this.rows[0].length>0)return false;return true;},getDirtyRows:function(){var dr=(this.dirtyRows)?this.dirtyRows:[];this.dirtyRows=null;return dr;},setRowDirty:function(row){if(!this.dirtyRows)this.dirtyRows=new Array(this.rows.length);this.dirtyRows[row]=true;},isRowDirty:function(row){if(!this.dirtyRows)return true;return this.dirtyRows[row];},setRowArray:function(rowIndex,row){if(!dojo.isArray(row)){row=row.split('');}
this.rows[rowIndex]=row;},getRowArray:function(rowIndex){while(this.rows.length<=rowIndex)this.rows.push([]);return this.rows[rowIndex];},hasRow:function(rowIndex){return(this.rows[rowIndex]);},insertCharacters:function(modelPos,string,noHistory){var row=this.getRowArray(modelPos.row);while(row.length<modelPos.col)row.push(" ");var newrow=(modelPos.col>0)?row.splice(0,modelPos.col):[];newrow=newrow.concat(string.split(""));this.rows[modelPos.row]=newrow.concat(row);this.setRowDirty(modelPos.row);this.editor.ui.syntaxModel.invalidateCache(modelPos.row);if(!noHistory){this.addHistoryItem('insertCharacters',{pos:bespin.editor.utils.copyPos(modelPos),characters:string});}},getDocument:function(){var file=[];for(var x=0;x<this.getRowCount();x++){file[x]=this.getRowArray(x).join('');}
return file.join("\n");},insertDocument:function(content){this.clear();var rows=content.split("\n");for(var x=0;x<rows.length;x++){this.insertCharacters({row:x,col:0},rows[x],true);}},changeEachRow:function(changeFunction){for(var x=0;x<this.getRowCount();x++){var row=this.getRowArray(x);row=changeFunction(row);this.setRowArray(x,row);}},replace:function(search,replace){var regex=new RegExp(search,"g");for(var x=0;x<this.getRowCount();x++){var line=this.getRowArray(x).join('');var newline=line.replace(regex,replace);if(newline!=line){this.replaceRow(x,newline);}}},replaceRow:function(row,newline,noHistory){var oldline=this.getRowArray(row).join('');this.rows[row]=newline.split('');if(!noHistory){this.addHistoryItem('replaceRow',{row:row,oldline:oldline,newline:newline});}},deleteCharacters:function(modelPos,length,noHistory){var row=this.getRowArray(modelPos.row);var diff=(modelPos.col+length-1)-row.length;if(diff>0)length-=diff;if(length>0){this.setRowDirty(modelPos.row);this.editor.ui.syntaxModel.invalidateCache(modelPos.row);var deleted=row.splice(modelPos.col,length).join("");if(!noHistory){this.addHistoryItem('deleteCharacters',{pos:bespin.editor.utils.copyPos(modelPos),characters:deleted});}
return deleted;}
return"";},clear:function(){this.rows=[];this.cacheRowMetadata=[];this.history=[];this.historyIndex=-1;},deleteRows:function(row,count){var diff=(row+count-1)-this.rows.length;if(diff>0)count-=diff;if(count>0){this.rows.splice(row,count);this.cacheRowMetadata.splice(row,count);}},splitRow:function(modelPos){this.editor.ui.syntaxModel.invalidateCache(modelPos.row);this.setRowDirty(modelPos.row);var row=this.getRowArray(modelPos.row);var newRow=[];if(modelPos.col<row.length){newRow=newRow.concat(row.splice(modelPos.col));}
if(modelPos.row==(this.rows.length-1)){this.rows.push(newRow);}else{var newRows=this.rows.splice(0,modelPos.row+1);newRows.push(newRow);newRows=newRows.concat(this.rows);this.rows=newRows;var newCacheRowMetadata=this.cacheRowMetadata.splice(0,modelPos.row+1);newCacheRowMetadata.push(undefined);this.cacheRowMetadata=newCacheRowMetadata.concat(this.cacheRowMetadata);}},joinRow:function(rowIndex,noHistory){this.editor.ui.syntaxModel.invalidateCache(rowIndex);this.setRowDirty(rowIndex);if(rowIndex>=this.rows.length-1)return;var row=this.getRowArray(rowIndex);var nextrow=this.rows[rowIndex+1];var rowLength=row.length;this.rows[rowIndex]=row.concat(nextrow);this.rows.splice(rowIndex+1,1);this.cacheRowMetadata.splice(rowIndex+1,1);if(!noHistory){var pos={row:rowIndex,col:rowLength};this.addHistoryItem('joinRow',{selection:{startModelPos:pos,endModelPos:pos},chunk:'\n'});}},getRowCount:function(){return this.rows.length;},getChunk:function(selection){var startModelPos=selection.startModelPos;var endModelPos=selection.endModelPos;var startModelCol,endModelCol;var chunk="";startModelCol=startModelPos.col;var row=this.getRowArray(startModelPos.row);endModelCol=(endModelPos.row==startModelPos.row)?endModelPos.col:row.length;if(endModelCol>row.length)endModelCol=row.length;chunk+=row.join("").substring(startModelCol,endModelCol);for(var i=startModelPos.row+1;i<endModelPos.row;i++){chunk+="\n";chunk+=this.getRowArray(i).join("");}
if(startModelPos.row!=endModelPos.row){startModelCol=0;endModelCol=endModelPos.col;row=this.getRowArray(endModelPos.row);if(endModelCol>row.length)endModelCol=row.length;chunk+="\n"+row.join("").substring(startModelCol,endModelCol);}
return chunk;},deleteChunk:function(selection,noHistory){var chunk=this.getChunk(selection);var startModelPos=selection.startModelPos;var endModelPos=selection.endModelPos;this.editor.ui.syntaxModel.invalidateCache(startModelPos.row);var startModelCol,endModelCol;startModelCol=startModelPos.col;var row=this.getRowArray(startModelPos.row);endModelCol=(endModelPos.row==startModelPos.row)?endModelPos.col:row.length;if(endModelCol>row.length)endModelCol=row.length;this.deleteCharacters({row:startModelPos.row,col:startModelCol},endModelCol-startModelCol,true);if(startModelPos.row!=endModelPos.row){startModelCol=0;endModelCol=endModelPos.col;row=this.getRowArray(endModelPos.row);if(endModelCol>row.length)endModelCol=row.length;this.deleteCharacters({row:endModelPos.row,col:startModelCol},endModelCol-startModelCol,true);}
if((endModelPos.row-startModelPos.row)>1)this.deleteRows(startModelPos.row+1,endModelPos.row-startModelPos.row-1);if(endModelPos.row!=startModelPos.row)this.joinRow(startModelPos.row,true);if(!noHistory)
this.addHistoryItem('deleteChunk',{selection:{startModelPos:bespin.editor.utils.copyPos(selection.startModelPos),endModelPos:bespin.editor.utils.copyPos(selection.endModelPos)},chunk:chunk});return chunk;},insertChunk:function(modelPos,chunk,noHistory){this.editor.ui.syntaxModel.invalidateCache(modelPos.row);var lines=chunk.split("\n");var cModelPos=bespin.editor.utils.copyPos(modelPos);for(var i=0;i<lines.length;i++){this.insertCharacters(cModelPos,lines[i],true);cModelPos.col=cModelPos.col+lines[i].length;if(i<lines.length-1){this.splitRow(cModelPos);cModelPos.col=0;cModelPos.row=cModelPos.row+1;}}
if(!noHistory)
this.addHistoryItem('insertChunk',{selection:{startModelPos:bespin.editor.utils.copyPos(modelPos),endModelPos:bespin.editor.utils.copyPos(cModelPos)},chunk:chunk});return cModelPos;},getStringIndicesInRow:function(row,str){str=str.toLowerCase();var row=this.getRowArray(row).join('').toLowerCase();if(row.indexOf(str)==-1)return false;var result=new Array();var start=0;var index=row.indexOf(str);do{result.push(index);index=row.indexOf(str,index+1);}while(index!=-1);return result;},getCountOfString:function(str){var count=0;var line;var match;for(var x=0;x<this.getRowCount();x++){match=this.getStringIndicesInRow(x,str);if(match){count+=match.length;}}
return count;},searchStringChanged:function(str){for(var row=0;row<this.cacheRowMetadata.length;row++){if(this.cacheRowMetadata[row]){if(str){this.cacheRowMetadata[row].searchIndices=this.getStringIndicesInRow(row,str);}else{this.cacheRowMetadata[row].searchIndices=false;}}}},findPrev:function(row,col,str){var indices;var strLen=str.length;for(var x=row;x>-1;x--){indices=this.getStringIndicesInRow(x,str);if(!indices)continue;for(var y=indices.length-1;y>-1;y--){if(indices[y]<(col-strLen)||row!=x){return{startPos:{col:indices[y],row:x},endPos:{col:indices[y]+strLen,row:x}};}}}
return false;},findNext:function(row,col,str){var indices;for(var x=row;x<this.getRowCount();x++){indices=this.getStringIndicesInRow(x,str);if(!indices)continue;for(var y=0;y<indices.length;y++){if(indices[y]>=col||row!=x){return{startPos:{col:indices[y],row:x},endPos:{col:indices[y]+str.length,row:x}};}}}
return false;},findBefore:function(row,col,comparator){var line=this.getRowArray(row);if(!dojo.isFunction(comparator))comparator=function(letter){if(letter.charAt(0)==' ')return true;var letterCode=letter.charCodeAt(0);return(letterCode<48)||(letterCode>122);};if(col>=line.length)
col=Math.max(line.length-1,0);while(col>0){var letter=line[col];if(!letter)continue;if(comparator(letter)){col++;break;}
col--;}
return{row:row,col:col};},findAfter:function(row,col,comparator){var line=this.getRowArray(row);if(!dojo.isFunction(comparator))comparator=function(letter){if(letter.charAt(0)==' ')return true;var letterCode=letter.charCodeAt(0);return(letterCode<48)||(letterCode>122);};while(col<line.length){col++;var letter=line[col];if(!letter)continue;if(comparator(letter))break;}
return{row:row,col:col};},getRowMetadata:function(row){if(!this.isRowDirty(row)&&this.cacheRowMetadata[row]){return this.cacheRowMetadata[row];}
var meta={tabExpansions:[]};var rowArray=this.editor.model.getRowArray(row);var lineText=rowArray.join("");var tabsize=this.editor.getTabSize();meta.lineTextWithoutTabExpansion=lineText;meta.lineLengthWithoutTabExpansion=rowArray.length;for(var ti=0;ti<lineText.length;ti++){if(lineText.charCodeAt(ti)==9){var toInsert=tabsize-(ti%tabsize);var spacer="";for(var si=1;si<toInsert;si++)spacer+=" ";var left=(ti==0)?"":lineText.substring(0,ti);var right=(ti<lineText.length-1)?lineText.substring(ti+1):"";lineText=left+" "+spacer+right;meta.tabExpansions.push({start:left.length,end:left.length+spacer.length+1});ti+=toInsert-1;}}
meta.lineText=lineText;if(this.editor.ui.searchString){meta.searchIndices=this.getStringIndicesInRow(row,this.editor.ui.searchString);}else{meta.searchIndices=false;}
this.cacheRowMetadata[row]=meta;return meta;}});
dojo.provide("bespin.editor.toolbar");dojo.declare("bespin.editor.Toolbar",null,{DEFAULT_TOOLBAR:["collaboration","filepopup","commandline","target_browsers","save","close","preview","fontsize"],showCollab:false,showFiles:false,showTarget:false,showCollabHotCounter:0,constructor:function(editor,opts){this.editor=editor||bespin.get('editor');if(opts.setupDefault)this.setupDefault();bespin.publish("toolbar:init",{toolbar:this});},setup:function(type,el,callback){if(dojo.isFunction(callback))this.addComponent(type,callback);if(dojo.isFunction(this.components[type]))this.components[type](this,el);},setupDefault:function(){dojo.forEach(this.DEFAULT_TOOLBAR,dojo.hitch(this,function(item){var item_el=dojo.byId("toolbar_"+item);if(item_el){this.setup(item,item_el);}}));},addComponent:function(type,callback){this.components[type]=callback;},components:{collaboration:function(toolbar,el){var collab=dojo.byId(el)||dojo.byId("toolbar_collaboration");dojo.connect(collab,'click',function(){toolbar.showCollab=!toolbar.showCollab;bespin.page.editor.recalcLayout();});},filepopup:function(toolbar,el){var filepopup=dojo.byId(el)||dojo.byId("toolbar_popup");dojo.connect(filepopup,'click',function(){toolbar.editor.ui.actions.focusFileBrowser();});dojo.connect(filepopup,'mouseover',function(){filepopup.style.cursor="pointer";filepopup.src="images/icn_filepopup_on.png";});dojo.connect(filepopup,'mouseout',function(){filepopup.style.cursor="default";filepopup.src="images/icn_filepopup.png";});},commandline:function(toolbar,el){var commandline=dojo.byId(el)||dojo.byId("toolbar_commandline");dojo.connect(commandline,'click',function(){toolbar.editor.ui.actions.focusCommandline();});dojo.connect(commandline,'mouseover',function(){commandline.style.cursor="pointer";commandline.src="images/icn_command_on.png";});dojo.connect(commandline,'mouseout',function(){commandline.style.cursor="default";commandline.src="images/icn_command.png";});},target_browsers:function(toolbar,el){var target=dojo.byId(el)||dojo.byId("toolbar_target_browsers");dojo.connect(target,'click',function(){toolbar._showTarget=!toolbar._showTarget;target.src="images/"+((toolbar._showTarget)?"icn_target_on.png":"icn_target_off.png");bespin.page.editor.recalcLayout();});dojo.connect(target,'mouseover',function(){target.style.cursor="pointer";target.src="images/icn_target_on.png";});dojo.connect(target,'mouseout',function(){target.style.cursor="default";target.src="images/icn_target_off.png";});},save:function(toolbar,el){var save=dojo.byId(el)||dojo.byId("toolbar_save");dojo.connect(save,'mouseover',function(){save.src="images/icn_save_on.png";});dojo.connect(save,'mouseout',function(){save.src="images/icn_save.png";});dojo.connect(save,'click',function(){bespin.get("editor").saveFile();});},close:function(toolbar,el){var close=dojo.byId(el)||dojo.byId("toolbar_close");dojo.connect(close,'mouseover',function(){close.src="images/icn_close_on.png";});dojo.connect(close,'mouseout',function(){close.src="images/icn_close.png";});dojo.connect(close,'click',function(){bespin.get("commandLine").executeCommand("closefile",true);});},undo:function(toolbar,el){var undo=dojo.byId(el)||dojo.byId("toolbar_undo");dojo.connect(undo,'mouseover',function(){undo.src="images/icn_undo_on.png";});dojo.connect(undo,'mouseout',function(){undo.src="images/icn_undo.png";});dojo.connect(undo,'click',function(){toolbar.editor.ui.actions.undo();});},redo:function(toolbar,el){var redo=dojo.byId(el)||dojo.byId("toolbar_undo");dojo.connect(redo,'mouseover',function(){redo.src="images/icn_redo_on.png";});dojo.connect(redo,'mouseout',function(){redo.src="images/icn_redo.png";});dojo.connect(redo,'click',function(){toolbar.editor.ui.actions.redo();});},preview:function(toolbar,el){var preview=dojo.byId(el)||dojo.byId("toolbar_preview");dojo.connect(preview,'mouseover',function(){preview.src="images/icn_preview_on.png";});dojo.connect(preview,'mouseout',function(){preview.src="images/icn_preview.png";});dojo.connect(preview,'click',function(){bespin.preview.show();});},fontsize:function(toolbar,el){var fontsize=dojo.byId(el)||dojo.byId("toolbar_fontsize");dojo.connect(fontsize,'mouseover',function(){fontsize.src="images/icn_fontsize_on.png";});dojo.connect(fontsize,'mouseout',function(){fontsize.src="images/icn_fontsize.png";});(function(){var currentFontSize=2;var fontSizes={1:8,2:10,3:14};dojo.connect(fontsize,'click',function(){currentFontSize=(currentFontSize>2)?1:currentFontSize+1;bespin.publish("settings:set:fontsize",[{value:fontSizes[currentFontSize]}]);});})();}}});
dojo.provide("bespin.editor.history");dojo.declare("bespin.editor.HistoryManager",null,{constructor:function(editor){this.history=[];this.historyPosition=-1;this.editor=editor;this.disableAdding=false;},getRange:function(start,end)
{},replaceRange:function(start,end,withWhat)
{this.history.splice(start,end-start+1,withWhat);},truncate:function(keepUntil)
{this.history.length=keepUntil+1;this.historyPosition=Math.min(this.historyPosition,this.history.length-1);},getCurrent:function()
{return this.historyPosition;},undo:function()
{if(this.historyPosition<0)
return;var current=this.history[this.historyPosition];this.disableAdding=true;try{current.undo();}catch(e){console.error("There was an error in an undo action: ");console.error(e);}
this.disableAdding=false;this.historyPosition--;},redo:function()
{if(this.historyPosition>=this.history.length-1){return;}
var next=this.history[this.historyPosition+1];this.disableAdding=true;try{next.redo();}catch(e){console.error("There was an error in an undo action: ");console.error(e);}
this.disableAdding=false;this.historyPosition++;},add:function(item){if(this.disableAdding)
return;this.history.length=this.historyPosition+1;this.history.push(item);this.historyPosition++;},canUndo:function(){return this.historyPosition>-1;},canRedo:function(){return this.historyPosition<this.history.length-1;}});dojo.declare("bespin.editor.HistoryItem",null,{constructor:function(){},undo:function(){},redo:function(){}});
dojo.provide("bespin.editor.quickopen");dojo.declare("bespin.editor.quickopen.API",null,{constructor:function(){this.requestFinished=true;this.preformNewRequest=false;this.projects;this.currentProject;this.currentProjectInclude;var scene=this.scene=new th.WindowScene({canvasOrId:document.getElementById("quickopen"),createFocusManager:true,isVisible:false,isDraggable:true,title:"Find Files"});var bus=scene.bus;var focusManager=this.focusManager=scene.focusManager;var input=this.input=scene.byId('input');input.selectAll();var inputProject=this.inputProject=scene.byId('project');var list=this.list=scene.byId('list');list.items=['Loading...'];list.remove(list.renderer);list.renderer=new th.HtmlLabel();list.add(list.renderer);list.renderer.addCss('padding','2px 5px');this.label=scene.byId('label');focusManager.subscribe(inputProject);focusManager.subscribe(input);scene.render();scene.center();input.bindKey("",input.ARROW_UP,list.moveSelectionUp,list);input.bindKey("",input.ARROW_DOWN,list.moveSelectionDown,list);input.bindKey("",input.ESCAPE,function(){bespin.publish("ui:escape");},this);input.bindKey("",input.ENTER,this.openFile,this);inputProject.bindKey("",inputProject.ENTER,function(){input.focusManager.focus(input);});inputProject.bindKey("",input.ESCAPE,function(){bespin.publish("ui:escape");},this);bus.bind("dblclick",list,this.openFile,this);bus.bind("itemselected",list,function(e){this.label.text=e.item.filename;this.label.repaint();},this);bus.bind("text:changed",input,function(){if(!this.currentProject)return;if(this.input.text==''){this.showFiles([]);}else{if(this.requestFinished){this.requestFinished=false;bespin.get('server').searchFiles(this.currentProject,this.input.text,this.currentProjectInclude,this.displayResult);}else{this.preformNewRequest=true;}}},this);bus.bind("text:changed:newChar",inputProject,function(){if(!this.inputProject.text==''){var newText=this.inputProject.text.toLowerCase();for(var i=0;i<this.projects.length;i++){if(this.projects[i].toLowerCase().indexOf(newText)==0){this.inputProject.setText(this.inputProject.text+this.projects[i].substring(newText.length),true);this.inputProject.setSelection(newText.length,this.inputProject.text.length);}}}},this);bus.bind("focus:lost",inputProject,function(){var newText=this.inputProject.text.toLowerCase();for(var i=0;i<this.projects.length;i++){if(this.projects[i].toLowerCase()==newText){this.setProject(this.projects[i]);if(this.input.text=='no such project'){this.input.setText('',true);}
this.showFiles([]);return;}}
this.input.setText('no such project',true);this.list.items=[];this.label.text='';this.scene.render();},this);bus.bind("focus:received",inputProject,function(){this.selectAll();},inputProject);bus.bind("focus:received",input,function(){this.selectAll();},input);bespin.subscribe('ui:escape',dojo.hitch(this,function(){if(this.scene.isVisible){this.toggle();bespin.get('editor').setFocus(true);}}));},toggle:function(){if(!this.scene.isVisible){dojo.style("quickopenContainer","display","block");}
this.scene.toggle();if(!this.scene.isVisible){this.focusManager.removeFocus();}else{this.focusManager.focus(this.input);this.setProject(bespin.get('editSession').project);this.input.setText('');this.loadProjects();}},openFile:function(){var item=this.list.selected;if(!item)return;var editor=bespin.get('editor');editor.saveFile();editor.openFile(this.currentProject,item.filename);this.toggle();editor.setFocus(true);},highlightText:function(text,highlight){if(highlight=='')return text;var lastIndex=0,startIndex=-1;var lowerText=text.toLowerCase();highlight=highlight.toLowerCase();var result='';for(var i=0;i<highlight.length;i++){lastIndex=startIndex;startIndex=lowerText.indexOf(highlight[i],startIndex);if(startIndex==-1)break;result+=text.substring(lastIndex+1,startIndex)+'<#000000>'+text[startIndex]+'</#000000>';}
result+=text.substring(startIndex+1);return result.replace(/<\/#000000><#000000>/g,'');},showFiles:function(files,sortFiles){sortFiles=sortFiles||false;var items=new Array();var sortedItems=new Array();var quickopen=bespin.get('quickopen');var settings=bespin.get('settings');var lastFolder;var name;var path;var lastSlash;var file;if(files===undefined){quickopen.list.items=[];quickopen.scene.render();return;}
for(var x=0;x<files.length;x++){file=files[x];lastSlash=file.lastIndexOf("/");path=(lastSlash==-1)?"":file.substring(0,lastSlash);name=(lastSlash==-1)?file:file.substring(lastSlash+1);if(settings&&settings.isSettingOff('dotmode')&&name[0]=='.'){continue;}
lastFolder=false;for(var y=items.length-1;y!=-1;y--){if(items[y].name==name){if(!items[y].lastFolder){lastFolder=items[y].filename.split('/');items[y].lastFolder=(lastFolder.length>1?lastFolder[lastFolder.length-2]:'');}
lastFolder=file.split('/');lastFolder=(lastFolder.length>1?lastFolder[lastFolder.length-2]:'');break;}}
items.push({filename:file,lastFolder:lastFolder,name:name});}
items=items.slice(0,13);if(sortFiles){items.sort(function(a,b){try{var x=a.text.toLowerCase();var y=b.text.toLowerCase();return((x<y)?-1:((x>y)?1:0));}catch(e){return 0;}});}
for(var i=0;i<items.length;i++){items[i].text=quickopen.highlightText(items[i].name,quickopen.input.text)+(items[i].lastFolder==false?'':' - '+items[i].lastFolder);}
quickopen.list.items=items;if(items.length!=0){quickopen.list.selected=items[0];quickopen.label.text=items[0].filename;}
quickopen.scene.render();},displayResult:function(files){var quickopen=bespin.get('quickopen');quickopen.showFiles(files);quickopen.requestFinished=true;if(quickopen.preformNewRequest){quickopen.requestFinished=false;quickopen.preformNewRequest=false;quickopen.requestText=quickopen.input.text;bespin.get('server').searchFiles(quickopen.currentProject,quickopen.input.text,quickopen.currentProjectInclude,quickopen.displayResult);}},loadProjects:function(){bespin.get("server").list(null,null,dojo.hitch(this,function(projectItems){this.projects=[];for(var i=0;i<projectItems.length;i++){this.projects.push(projectItems[i].name.substring(0,projectItems[i].name.length-1));}
this.projects.sort(function(a,b){var x=a.toLowerCase();var y=b.toLowerCase();return((x<y)?-1:((x>y)?1:0));});}));},setProject:function(name){this.inputProject.setText(name,true);this.currentProject=name;this.currentProjectInclude=[];var settings=bespin.get('settings');if(settings){var includeFolders=settings.getObject('quickopenInclude');if(includeFolders){if(includeFolders[name]){this.currentProjectInclude=includeFolders[name];}}}}});bespin.command.store.addCommand({name:'quickopen',takes:['task','project','path'],preview:'list, add or remove a folder from the list quickopen uses to search in for files',usage:'[add|remove] [project] [path to be added or removed]',execute:function(instruction,args){var settings=bespin.get('settings');if(!args.task){instruction.addOutput(this.preview);instruction.addUsageOutput(this);instruction.error=false;var includes=settings.getObject('quickopenInclude');if(includes===undefined)return;output='<br/>';for(projects in includes){if(includes[projects].length==0)continue;output+="<u><b>Project: "+projects+"</b></u>";output+="<ul>";for(var i=0;i<includes[projects].length;i++){output+='<li>'+includes[projects][i]+"</li>";}
output+="</ul><br/>";}
instruction.addOutput(output);return;}
if(!args.path||!args.project){instruction.addUsageOutput(this);return;}
if(args.task=='add'){var includes=settings.getObject('quickopenInclude');if(includes===undefined)includes={};if(includes[args.project]===undefined)includes[args.project]=[];includes[args.project].push(args.path);settings.setObject('quickopenInclude',includes);}else if(args.task=='remove'){var includes=settings.getObject('quickopenInclude');if(includes===undefined)return;if(includes[args.project]===undefined)return;if(includes[args.project].indexOf(args.path)==-1)return;includes[args.project].splice(includes[args.project].indexOf(args.path),1);settings.setObject('quickopenInclude',includes);}}});
dojo.provide("bespin.editor.formatter");bespin.subscribe("component:register:actions",function(e){var actions=bespin.get('actions');actions['formatCode']=dojo.hitch(actions,function(args){var sel=this.editor.getSelection();var formatted;var section=null;var cursorPos=this.editor.cursorManager.getCursorPosition();var code=this.editor.model.getDocument();if(sel){sel.startPos.col=0;if(sel.endPos.col>0){sel.endPos.row+=1;sel.endPos.col=0;}
this.editor.setSelection(sel);section={start:sel.startPos.row,end:sel.endPos.row};}
var formatter=bespin.get('formatter')||(function(){return bespin.register('formatter',new bespin.editor.formatter.API());})();formatter.setLanguage(this.editor.language);var padding=(function(tabSize){var result="";for(x=0;x<tabSize;x++){result+=" ";}
return result;})(this.editor.getTabSize());formatted=formatter.indent(code,padding,section);if(!sel){this.selectAll({});}
this.deleteSelectionAndInsertChunk({chunk:formatted});if(!sel){this.editor.setSelection(undefined);this.editor.cursorManager.moveCursor(cursorPos);this.repaint();}});});bespin.command.store.addCommand({name:'format',withKey:"CMD SHIFT F",preview:'format source code or selection',description:'Use this to indent the selected fragment of your code.  The entire source is indented if nothing is selected.',execute:function(self){bespin.get("editor").ui.actions.formatCode();}});dojo.declare("bespin.editor.formatter.API",null,{setLanguage:function(language){if(dojo.isString(language)){language=language.toLowerCase();}
switch(language){case'css':case'javascript':case'js':case'java':case'ecmascript':this.implementation=new bespin.editor.formatter.C();break;case'html':case'xhtml':case'shtml':case'xml':case'fbml':this.implementation=new bespin.editor.formatter.ML();break;default:console.log("Error!!! unknown language type: "+language);this.implementation=new bespin.editor.formatter.Unknown();break;}},constructor:function(){},indent:function(source,pad,opt_section){return this.implementation.indent(source,pad,opt_section);}});dojo.declare("bespin.editor.formatter.Base",null,{calculateOffset:function(lines,currentLine){if(!currentLine)currentLine=lines.length-1;var result={row:0,offset:''};var offsetPattern=/(^\s*)(\S+)\s*/;for(var i=currentLine-1;i>0;i--){var m=offsetPattern.exec(lines[i]);if(m){result.offset=m[1];result.row=i;break;}}
return result;},indent:function(source,pad,section){var lines=source.split('\n');var saveStart=0;var baseOffset='';if(!section){section={start:0,end:lines.length-1};}else{saveStart=section.start;var r=this.calculateOffset(lines,section.start);baseOffset=r.offset;section.start=r.row;}
var scope={level:0,nextLevel:0,comment:false};var currentOffset=baseOffset;for(var i=section.start;i<section.end;i++){lines[i]=lines[i].replace(/^\s+/,'').replace(/\s+$/,'');if(this.processLine(lines[i],scope)!=0){var pads=[baseOffset];for(var j=0;j<scope.level;j++){pads.push(pad);}
currentOffset=pads.join('');}
lines[i]=currentOffset+lines[i];}
if(section.end<(lines.length-1))lines.splice(section.end,lines.length-1);if(saveStart>0)lines.splice(0,saveStart);return lines.join('\n')+'\n';}});dojo.declare("bespin.editor.formatter.C",bespin.editor.formatter.Base,{constructor:function(){this.scopeChanges={'{':1,'(':1,'[':1,']':-1,'}':-1,')':-1};this.COND_START='$';this.ML_COMMENT_START='%';this.ML_COMMENT_END='@';this.COMMENT='#';this.CASE_START='<';this.CASE_END='>';},calculateOffset:function(lines,currentLine){var l=lines.slice(0,currentLine);var inComment=false;var i=0;while(i<currentLine){var pos;if(inComment){pos=l[i].indexOf('*/');if(pos>=0){l[i]=l[i].substr(pos1+2);inComment=false;i--;}}else{pos=l[i].indexOf('/*');if(pos>=0){var s=l[i].substr(0,pos);var pos1=l[i].indexOf('*/',pos+2);if(pos1>=0){s+=l[i].substr(pos1+2);inComment=false;l[i]=s;i--;}else{inComment=true;l[i]=s;}}}
i++;}
var copyArgs=[l,currentLine];copyArgs.callee=arguments.callee;return this.inherited(copyArgs);},processLine:function(line,scope){var change=0;var previousLevel=scope.level;var lowWaterMark=0;line=this.normalize(line,0,scope.comment);scope.condLevel=scope.condLevel||0;scope.condState=scope.condState||0;for(var i=0;i<line.length;i++){switch(line[i]){case'{':change+=1;if(scope.condState==3){scope.condState=0;}
if(scope.inCase){scope.caseLevel++;}
break;case this.CASE_START:if(!scope.inCase){change+=1;}else{lowWaterMark-=1;}
scope.inCase=true;scope.caseLevel=0;break;case'}':change-=1;if(scope.inCase){if(scope.caseLevel>0){scope.caseLevel-=1;}else{change-=1;scope.inCase=false;}}
lowWaterMark=(lowWaterMark<change)?lowWaterMark:change;break;case this.CASE_END:change-=1;lowWaterMark=(lowWaterMark<change)?lowWaterMark:change;scope.inCase=false;break;case'[':change+=1;break;case']':change-=1;lowWaterMark=(lowWaterMark<change)?lowWaterMark:change;break;case'(':switch(scope.condState){case 1:scope.condState=2;break;case 2:scope.parentInCondition++;break;default:break;}
change+=1;break;case')':change-=1;if(scope.condState==2){if(scope.parenInCondition>0){scope.parentInCondition--;}else{scope.condState=3;}}
lowWaterMark=(lowWaterMark<change)?lowWaterMark:change;break;case this.ML_COMMENT_START:scope.comment=true;break;case this.ML_COMMENT_END:scope.comment=false;break;case this.COND_START:scope.condState=1;scope.parenInCondition=0;break;case';':if(scope.condState==3){scope.condState=0;}
break;default:break;}}
scope.level=scope.nextLevel+lowWaterMark;var condLevelChange=0;if(scope.condState==3){scope.condLevel++;scope.condState=4;condLevelChange=1;}else if(scope.condState==4){condLevelChange=-scope.condLevel;scope.condLevel=0;scope.condState=0;}
scope.nextLevel+=change+condLevelChange;if(scope.nextLevel<0)scope.nextLevel=0;return(previousLevel!=scope.level)||lowWaterMark;},normalize:function(s,offset,inMultilineComment){if(!s)return{escaped:s,comment:inMultilineComment};s=s.replace(/\\"/g,'').replace(/\\'/g,'').replace(/[@#$%<>]/g,'').replace(/\bif\b/g,this.COND_START).replace(/\belse\b/g,this.COND_START).replace(/\bfor\b/g,this.COND_START).replace(/\bwhile\b/g,this.COND_START).replace(/\bcase\b/g,this.CASE_START).replace(/\bdefault\b/g,this.CASE_START).replace(/\bbreak\b/g,this.CASE_END).replace(/\/\*/g,this.ML_COMMENT_START).replace(/\*\//g,this.ML_COMMENT_END).replace(/\/\//g,this.COMMENT).replace(/[\w\s]/g,'');var out=[];var quoteChar=null;var inQuotes=false,inlineComment=false;for(var i=offset;i<s.length;i++){var c=s[i];if(inlineComment){continue;}else if(inMultilineComment){if(s[i]==this.ML_COMMENT_END){inMultilineComment=false;}else{continue;}}else if(inQuotes){if(s[i]==quoteChar){inQuotes=false;quoteChar=null;}else{continue;}}else{if(s[i]==this.COMMENT){inlineComment=true;}else if(s[i]=="'"||s[i]=='"'){inQuotes=true;quoteChar=s[i];}else if(s[i]==this.ML_COMMENT_START){inMultilineComment=true;}}
out.push(c);}
s=out.join('');return s;}});dojo.declare("bespin.editor.formatter.ML",bespin.editor.formatter.Base,{constructor:function(){this.emptyElements=['area','base','basefont','br','col','frame','hr','img','input','isindex','link','meta','param'];},indent:function(source,pad,section){source=source.replace(/<BR>/,'<BR/>').replace(/<br>/,'<br/>');var copyArgs=[source,pad,section];copyArgs.callee=arguments.callee;return this.inherited(copyArgs);},processLine:function(line,scope){var s=line;var change=0;var lowWaterMark=0;var offset=0;var previousLevel=scope.level;scope.lonelyCloser=false;var inScriptlet=scope.scriptlet;var inQuotes=false;var inOpenTag=scope.inTag;var inEmptyTag=scope.inEmptyTag;var inEndTag=false;var inComment=scope.comment;var quoteChar;for(var i=0;i<line.length;i++){if(inQuotes){if(s[i]==quoteChar&&(i==offset||s[i-1]!='\\')){inQuotes=false;}}else if(inScriptlet){if(i>offset&&s[i]==">"&&s[i-1]=='%'){inScriptlet=false;change-=1;lowWaterMark=(lowWaterMark<change)?lowWaterMark:change;}}else if(inComment){if(i>offset+1&&s[i]==">"&&s[i-1]=='-'&&s[i-2]=='-'){inComment=false;change-=1;lowWaterMark=(lowWaterMark<change)?lowWaterMark:change;}}else if(inOpenTag){if(s[i]==">"){if(!inEmptyTag&&i>offset&&s[i-1]=='/'){change-=1;}
inOpenTag=false;}}else if(inEndTag){if(s[i]==">"){inEndTag=false;if(!inEmptyTag){change-=1;lowWaterMark=(lowWaterMark<change)?lowWaterMark:change;}}}else{if(i<line.length-3&&s[i]=="<"&&s[i+1]=='!'&&s[i+2]=='-'&&s[i+3]=='-'){inComment=true;change+=1;}else if(s[i]=="'"||s[i]=='"'){quoteChar=s[i];inQuotes=true;}else if(s[i]=='<'){if(i<line.length-1&&s[i+1]=='/'){inEmptyTag=this.isEmptyTag(line,i+2);inEndTag=true;}else if(i<line.length-1&&s[i+1]=='%'){inScriptlet=true;change+=1;}else{inEmptyTag=this.isEmptyTag(line,i+1);if(!inEmptyTag){change+=1;}
inOpenTag=true;}}}}
scope.level=scope.nextLevel+lowWaterMark;scope.nextLevel+=change;scope.inTag=inOpenTag;scope.inEmptyTag=inEmptyTag;scope.comment=inComment;scope.scriptlet=inScriptlet;return(previousLevel!=scope.level)||lowWaterMark;},isEmptyTag:function(line,offset){var tagName='';for(var j=offset;j<line.length;j++){if(/[\s>]/.test(line[j])){break;}else{tagName+=line[j];}}
tagName=tagName.toLowerCase();for(var i=0;i<this.emptyElements.length;i++){if(tagName==this.emptyElements[i])return true;}
return false;}});dojo.declare("bespin.editor.formatter.Unknown",null,{constructor:function(){},indent:function(source,pad,section){return source;}});
dojo.provide("bespin.editor.codecompletion");dojo.declare("bespin.editor.codecompletion.Suggester",null,{constructor:function(){},complete:function(cursorPos,row){var self=this;var startIndex=cursorPos.col-1;var substr="";var find=function(){if(substr.length>=1){self.findCompletion(substr);}};for(var i=startIndex;i>=0;--i){var ch=row[i];if(this.charMarksStartOfIdentifier(ch)){find();return}else{substr=ch+substr;}}
find();},findInArray:function(candidates,substr,array){for(var i=0,len=array.length;i<len;++i){var name=array[i].name;if(name){if(name.indexOf(substr)===0&&substr!==name&&name!=="constructor"){candidates.push(name);}}}},findCompletion:function(substr){var self=this;var candidates=[];if(self.currentMetaInfo){if(self.currentMetaInfo.outline){this.findInArray(candidates,substr,self.currentMetaInfo.outline);}
if(self.currentMetaInfo.idents){var idents=[];for(var i in self.currentMetaInfo.idents){idents.push({name:i});}
this.findInArray(candidates,substr,idents);}}
if(candidates.length>0){bespin.publish("codecomplete:showsuggestion",{candidates:candidates});}},charMarksStartOfIdentifier:function(ch){return ch===" "||ch==="\t"||ch=="\""||ch=="'";},initialize:function(){var self=this;bespin.subscribe("parser:metainfo",function(evt){self.currentMetaInfo=evt.info;});bespin.subscribe("codecomplete:suggest",function(evt){self.complete(evt.cursorPos,evt.row);});}});(function(){var facade=new bespin.worker.WorkerFacade(new bespin.editor.codecompletion.Suggester());if(!facade.__hasWorkers__){facade.initialize();}
var subscription;bespin.subscribe("codecomplete:showsuggestion",function(e){bespin.get("commandLine").showHint("Code Completions<br><br>"+e.candidates.join("<br>"));});bespin.subscribe("settings:set:codecomplete",function(data){if(bespin.get("settings").isOn(data.value)){subscription=bespin.subscribe("editor:document:changed",function(){var editor=bespin.get("editor");var pos=editor.getCursorPos();var row=editor.model.getRowArray(pos.row);bespin.publish("codecomplete:suggest",{cursorPos:pos,row:row});},400);}else{bespin.unsubscribe(subscription);}});})();
dojo.provide("bespin.themes.default");bespin.themes.coffee={backgroundStyle:"#2A211C",gutterStyle:"#4c4a41",lineNumberColor:"#e5c138",lineNumberFont:"10pt Monaco, Lucida Console, monospace",lineMarkerErrorColor:"#CC4444",lineMarkerWarningColor:"#B8860B",lineMarkerMessageColor:"green",zebraStripeColor:"#2A211C",highlightCurrentLineColor:"#3a312b",editorTextFont:"10pt Monaco, Lucida Console, monospace",editorTextColor:"rgb(230, 230, 230)",editorSelectedTextColor:"rgb(240, 240, 240)",editorSelectedTextBackground:"#526DA5",cursorStyle:"#879aff",cursorType:"ibeam",unfocusedCursorStrokeStyle:"#FF0033",unfocusedCursorFillStyle:"#73171E",partialNibStyle:"rgba(100, 100, 100, 0.3)",partialNibArrowStyle:"rgba(255, 255, 255, 0.3)",partialNibStrokeStyle:"rgba(150, 150, 150, 0.3)",fullNibStyle:"rgb(100, 100, 100)",fullNibArrowStyle:"rgb(255, 255, 255)",fullNibStrokeStyle:"rgb(150, 150, 150)",scrollTrackFillStyle:"rgba(50, 50, 50, 0.8)",scrollTrackStrokeStyle:"rgb(150, 150, 150)",scrollBarFillStyle:"rgba(0, 0, 0, %a)",scrollBarFillGradientTopStart:"rgba(90, 90, 90, %a)",scrollBarFillGradientTopStop:"rgba(40, 40, 40, %a)",scrollBarFillGradientBottomStart:"rgba(22, 22, 22, %a)",scrollBarFillGradientBottomStop:"rgba(44, 44, 44, %a)",tabSpace:"#392A25",searchHighlight:"#B55C00",searchHighlightSelected:"#FF9A00",plain:"#bdae9d",keyword:"#42a8ed",string:"#039a0a",comment:"#666666",'c-comment':"#666666",punctuation:"#888888",attribute:"#BF9464",test:"rgb(255,0,0)",cdata:"#bdae9d","attribute-value":"#039a0a",tag:"#46a8ed",color:"#c4646b","tag-name":"#46a8ed",value:"#039a0a",important:"#990000",sizes:"#990000",cssclass:"#BF9464",cssid:"#46a8ed",atom:"#aa4444",variable:"#00cccc",variabledef:"#4422cc",localvariable:"#cc2277",property:"#66bb33",operator:"#88bbff",error:"#FF0000",processing:"#999999",entity:"#AA2222",text:"#00BB00","compile-time-constant":"#776088","predefined-constant":"#33CC33","reserved-language-construct":"#00FF00","predefined-function":"#22FF22","predefined-class":"#22FF22",literal:"#DD4411",identifier:"#22FF22",func:"#2200FF",type:"#8822FF",decorator:"#2222FF"};bespin.themes.coffeezebra={};dojo.mixin(bespin.themes.coffeezebra,bespin.themes.coffee);bespin.themes.coffeezebra.zebraStripeColor='#FFFFFF';bespin.themes['default']=bespin.themes.coffee;
dojo.provide("bespin.syntax.base");dojo.declare("bespin.syntax.Model",null,{language:"",lineCache:[],invalidateCache:function(lineNumber){delete this.lineCache[lineNumber];},invalidateEntireCache:function(){this.lineCache=[];},addToCache:function(lineNumber,line){this.lineCache[lineNumber]=line;},getFromCache:function(lineNumber){return this.lineCache[lineNumber];},mergeSyntaxResults:function(regions){var base=0;for(var i=0;i<regions.length;i++){var region=region[i];}},getSyntaxStylesPerLine:function(lineText,lineNumber,language){return{regions:{plain:[{start:0,stop:lineText.length}]}};},getSyntaxStyles:function(rows,firstLineToRender,lastLineToRender,language){var syntaxResults={};for(var i=firstLineToRender;i<=lastLineToRender;i++){syntaxResults[i]=this.getSyntaxStylesPerLine(rows[i],i,language);}
return syntaxResults;}});bespin.syntax.Resolver=(function(){var current,model;return{setEngine:function(name){var engine=bespin.syntax[name];if(name==current){return this;}
if(engine){current=name;if(model){delete model;}
if(engine.worker){model=new bespin.worker.WorkerFacade(bespin.syntax[name].Model());model.workerEnabled=true;}else{model=new bespin.syntax[name].Model();model.workerEnabled=false;}}else{console.log("no such engine: ",name);}
return this;},getModel:function(){return model;}};})();
dojo.provide("bespin.syntax.simple._base");dojo.declare("bespin.syntax.simple.Model",bespin.syntax.Model,{lineMetaInfo:[],setLineMetaInfo:function(lineNumber,meta){this.lineMetaInfo[lineNumber]=meta;},getLineMetaInfo:function(lineNumber){return this.lineMetaInfo[lineNumber];},getSyntaxStylesPerLine:function(lineText,lineNumber,language){if(!this.language||(this.language!=language)){this.engine=bespin.syntax.simple.Resolver.resolve(language);this.language=language;}
var syntaxResult={text:lineText,regions:[]};var meta;if(typeof this.engine['innertypes']=="function"){var languages=this.engine.innertypes(lineText);for(var i=0;i<languages.length;i++){var type=languages[i];meta={inMultiLineComment:this.inMultiLineComment(),offset:type.start};var pieceRegions=[];var fromResolver=bespin.syntax.simple.Resolver.highlight(type.type,lineText.substring(type.start,type.stop),meta);if(fromResolver.meta&&(i==languages.length-1)){this.setLineMetaInfo(lineNumber,fromResolver.meta);}
pieceRegions.push(fromResolver);}
syntaxResult.regions.push(this.mergeSyntaxResults(pieceRegions));}else{meta=(lineNumber>0)?this.getLineMetaInfo(lineNumber-1):{};var result=this.engine.highlight(lineText,meta);this.setLineMetaInfo(lineNumber,result.meta);syntaxResult.regions.push(result.regions);}
return syntaxResult;}});bespin.syntax.simple.Resolver=new function(){var engines={};var extension2type={};var NoopSyntaxEngine={highlight:function(line,meta){return{regions:{plain:[{start:0,stop:line.length}]}};}};return{highlight:function(type,line,meta,lineNumber){this.resolve(type).highlight(line,meta,lineNumber);},register:function(type,extensions,syntaxEngine){if(syntaxEngine){engines[type]=syntaxEngine;}
for(var i=0;i<extensions.length;i++){extension2type[extensions[i]]=type;}},resolve:function(extension){if(!extension||extension=="off"||!extension2type[extension]){return NoopSyntaxEngine;}
var type=extension2type[extension];if(!engines[type]||(typeof engines[type]==="string"&&engines[type]!="LOADING")){engines[type]="LOADING";var dr=dojo.require;dr.call(dojo,"bespin.syntax.simple."+type.toLowerCase());if(bespin.syntax.simple[type]){engines[type]=new bespin.syntax.simple[type]();}}
return engines[type]||NoopSyntaxEngine;}};}();bespin.syntax.simple.Resolver.register("JavaScript",['js','javascript','ecmascript','jsm','java']);bespin.syntax.simple.Resolver.register("Arduino",['pde']);bespin.syntax.simple.Resolver.register("C",['c','h']);bespin.syntax.simple.Resolver.register("CSharp",['cs']);bespin.syntax.simple.Resolver.register("CSS",['css']);bespin.syntax.simple.Resolver.register("HTML",['html','htm','xml','xhtml','shtml']);bespin.syntax.simple.Resolver.register("PHP",['php','php3','php4','php5']);bespin.syntax.simple.Resolver.register("Python",['py','python']);bespin.syntax.simple.Resolver.register("Ruby",['rb','ruby']);
dojo.provide("bespin.parser.parser");dojo.declare("bespin.parser.CodeInfo",null,{constructor:function(source){var self=this;this._started=false;this._running=false;this.currentMetaInfo;this.messages=[];this.foldPoints=[];bespin.subscribe("parser:showoutline",function(){var html=self.currentMetaInfo?self.currentMetaInfo.html:"Outline not yet available";bespin.get("commandLine").addOutput(html);});bespin.subscribe("parser:gotofunction",function(event){var functionName=event.functionName;if(!functionName){bespin.get("commandLine").addErrorOutput("Please pass me a valid function name.");return;}
var matches=dojo.filter(self.foldPoints,function(func){return func['(name)']==functionName;});if(matches.length===0){bespin.get("commandLine").addErrorOutput("Unable to find the function "+functionName+" in this file.");}else{bespin.get("editor").moveAndCenter(matches[0].row);}});bespin.subscribe("parser:engine:parseDone",function(event){var data=event.info;self.foldPoints=data.foldPoints;var syntaxmarkers=bespin.get("settings")&&bespin.get("settings").get("syntaxmarkers");self.messages=dojo.filter(data.messages,function(message){if(syntaxmarkers==="all"){return true;}
return((message.type+"s").toLowerCase()===syntaxmarkers);});if(data.metaInfo){self.currentMetaInfo=data.metaInfo;bespin.publish("parser:metainfo",{info:data.metaInfo});}
self._running=false;});bespin.subscribe("parser:stop",function(){self.messages=[];self.foldPoints=[];});},start:function(){var self=this;var editor=bespin.get("editor");if(!self._started){self._started=true;self.run_timeout;var delay=400;var rerun=function(){if(self.run_timeout){clearTimeout(self.run_timeout);}
self.run_timeout=setTimeout(function(){self.fetch();},delay);};var onChange=bespin.subscribe("editor:document:changed",rerun);bespin.subscribe("settings:set:syntaxmarkers",rerun);bespin.subscribe("settings:set:jslint",rerun);bespin.subscribe("parser:stop",function(){bespin.unsubscribe(onChange);self._started=false;});rerun();}},fetch:function(){var self=this;if(bespin.parser.AsyncEngineResolver.__hasWorkers__){var editor=bespin.get("editor");var type=editor.language;var parseOptions=bespin.get("settings")&&bespin.get("settings").getObject("jslint");if(type){var source=editor.model.getDocument();self._running=true;bespin.publish("parser:engine:parse",{type:type,source:source,parseOptions:parseOptions});}}},getLineMarkers:function(){var lineMarkers={};dojo.forEach(this.messages,function(message){if(!lineMarkers[message.line]){lineMarkers[message.line]={type:message.type,msg:""};}
lineMarkers[message.line].msg+='<p>Syntax '+message.type+
(isFinite(message.line)?' at line '+message.line+' character '+(message.character+1):' ')+': '+message.reason+'<p>'+
(message.evidence&&(message.evidence.length>80?message.evidence.slice(0,77)+'...':message.evidence).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'));if(message.type==="Error"||(message.type==="Warning"&&lineMarkers[message.line].type==="Message")){lineMarkers[message.line].type=message.type;}});return lineMarkers;},getFunctions:function(){return this.foldPoints||[];}});dojo.declare("bespin.parser.JavaScript",null,{constructor:function(){},name:"Narcissus",walk:function(tree,callback){var parentStack=[];var indexStack=[];var top=function(){if(this.length==0)return null;return this[this.length-1];};parentStack.top=top;indexStack.top=top;this._walk(callback,tree,parentStack,indexStack);},_visitNode:function(callback,node,parentStack,indexStack){callback.call(this,node,parentStack,indexStack);if(node.length){this._walk(callback,node,parentStack,indexStack);}
if(node.expression){this._walk(callback,node.expression,parentStack,indexStack);}
if(node.body){this._walk(callback,node.body,parentStack,indexStack);}
if(node.value){this._walk(callback,node.value,parentStack,indexStack);}},_walk:function(callback,tree,parentStack,indexStack){if(typeof tree=="string")return;if(tree.length){parentStack.push(tree);for(var i=0;i<tree.length;++i){var node=tree[i];indexStack.push(i);this._visitNode(callback,node,parentStack,indexStack);indexStack.pop();}
parentStack.pop();}else{this._visitNode(callback,tree,parentStack,indexStack);}},getMetaInfo:function(tree){var funcs=[];var idents={};var info=[];var codePatterns=this.getCodePatterns();for(var type in codePatterns){if(codePatterns.hasOwnProperty(type)){try{var ns=codePatterns[type].declaration.split(".");var indicator=ns.pop();codePatterns[type]._indicator=indicator;codePatterns[type]._ns=ns;}catch(e){console.log("Weird FF3b3 error "+e);}}}
var FUNCTION=74;var OBJECT_LITERAL_KEY=56;var IDENTIFIER=56;this.walk(tree,function(node,parentStack,indexStack){var depth=parentStack.length;var tree=parentStack.top();var index=indexStack.top();var row=node.lineno-1;var identifiers=[];if(node.type==IDENTIFIER&&index>0){identifiers.push(node.value);for(var i=index-1;i>=0;--i){var n=tree[i];if(n&&n.type==IDENTIFIER){identifiers.unshift(n.value);}}}
idents[identifiers.join(".")]=true;if(node.type==FUNCTION){var name=node.name;if(name==null&&tree&&index>0){var pred=tree[index-1];if(pred.type==OBJECT_LITERAL_KEY){name=pred.value;}}
var fn={type:"function",name:name,row:row,depth:depth};funcs.push(fn);info.push(fn);}else{var parent=parentStack[parentStack.length-1];var parentIndex=indexStack[indexStack.length-1];var analyze=function(type,ns,indicator){if(parentIndex>=0){if(node.value==indicator){for(var i=0;i<ns.length;++i){var ele=ns[i];if(parent[parentIndex-1]&&parent[parentIndex-1].value==ns){parent=parentStack[parentStack.length-(1+i+1)];parentIndex=indexStack[indexStack.length-(1+i+1)];}else{return;}}
if(parent[parentIndex+1]&&parent[parentIndex+1][0]){var name=parent[parentIndex+1][0].value;info.push({type:type,name:name,row:row,depth:depth});return true;}}}};for(var type in codePatterns){var pattern=codePatterns[type];if(analyze(type,pattern._ns,pattern._indicator)){break;}}}});var html='<u>Outline</u><br/><br/>';html+='<div id="outlineInfo">';for(var i=0;i<info.length;i++){var type=info[i].type;var kind=type;var name=info[i].name;var pattern=codePatterns[type];if(pattern){if("declaration"in pattern)kind=pattern.declaration;if("description"in pattern)kind=pattern.description;}
if(typeof name=="undefined"){continue;}
var indent="";for(var j=0;j<info[i].depth;j++)indent+="&nbsp;";html+=indent+kind+': <a href="javascript:bespin.get(\'editor\').cursorManager.moveCursor({ row: '+info[i].row+', col: 0 });bespin.get(\'editor\').ui.actions.moveCursorRowToCenter();">'+name+'</a><br/>';}
html+='</div>';return{functions:funcs,idents:idents,outline:info,html:html};},codePatterns:{dojoClass:{declaration:"dojo.declare",description:"Class"},bespinEventPublish:{declaration:"bespin.publish",description:"Publish"},bespinEventSubscription:{declaration:"bespin.subscribe",description:"Subscribe to"},jooseClass:{declaration:"Class"},jooseModule:{declaration:"Module"},jooseType:{declaration:"Type"},jooseRole:{declaration:"Role"}},getCodePatterns:function(){return this.codePatterns;},initialize:function(){var self=this;bespin.subscribe("parser:js:codePatterns",function(patterns){for(pattern in patterns){self.codePatterns[pattern]=patterns[pattern];}
bespin.publish("parser:engine:updatedCodePatterns");});},parse:function(source){var tree;var messages=[];try{tree=parse(source);}catch(e){;};return{messages:messages,metaInfo:tree?this.getMetaInfo(tree):undefined};}});dojo.declare("bespin.parser.JSLint",null,{constructor:function(source){},name:"JSLint",parse:function(source,type,parseOptions){if(type==="css"){source='@charset "UTF-8";\n'+source;}
var result=JSLINT(source,parseOptions);var messages=[];var funcs=JSLINT.getFunctions();var fatal=JSLINT.errors.length>0&&JSLINT.errors[JSLINT.errors.length-1]===null;for(var i=0;i<JSLINT.errors.length;i++){if(JSLINT.errors[i]){messages.push({reason:JSLINT.errors[i].reason,line:JSLINT.errors[i].line+(type==="css"?0:1),type:(i===JSLINT.errors.length-2&&fatal)?"Error":"Warning",character:JSLINT.errors[i].character,evidence:JSLINT.errors[i].evidence});}}
for(var i=0;i<funcs.length;i++){messages.push({line:funcs[i].line,type:"Message",character:0,reason:"<br>Function name: "+funcs[i].name+"<br>Unused: "+funcs[i].unused.join(", ")+"<br>Closure: "+funcs[i].closure.join(", ")+"<br>Exception: "+funcs[i].exception.join(", ")+"<br>Vars: "+funcs[i].vars.join(", ")+"<br>Label: "+funcs[i].label.join(", ")+"<br>Outer: "+funcs[i].outer.join(", ")+"<br>Global: "+funcs[i].global.join(", "),evidence:""});}
return{result:result,messages:messages,foldPoints:(type==='css'?[]:funcs)};}});bespin.parser.EngineResolver=function(){return{engines:{},parse:function(source,type,parseOptions){var result={};var engineResult;var selectedEngines=this.resolve(type);for(var i=0;i<selectedEngines.length;i++){engineResult=selectedEngines[i].parse(source,type,parseOptions);engineResult.messages=engineResult.messages.concat(result.messages||[]);for(var member in engineResult){if(engineResult.hasOwnProperty(member)){if(engineResult[member]){result[member]=engineResult[member];result.isSet=true;}}}}
return result.isSet?result:{noEngine:true};},register:function(parserEngine,types){for(var i=0;i<types.length;i++){if(this.engines[types[i]]==null)this.engines[types[i]]=[];this.engines[types[i]].push(parserEngine);}},resolve:function(type){return this.engines[type]||[];},initialize:function(){var engine=this;bespin.subscribe("parser:engine:parse",function(event){var ret=engine.parse(event.source,event.type,event.parseOptions);bespin.publish("parser:engine:parseDone",{type:event.type,info:ret});});for(var type in this.engines){var list=this.engines[type];for(var i=0;i<list.length;i++){var eng=list[i];if(!eng._init){if(eng.initialize){eng.initialize();}
eng._init=true;}}}
bespin.publish("parser:engine:initialized",{});}};}();bespin.parser.EngineResolver.register(new bespin.parser.JSLint(),['js','css']);bespin.parser.EngineResolver.register(new bespin.parser.JavaScript(),['js']);bespin.parser.AsyncEngineResolver=new bespin.worker.WorkerFacade(bespin.parser.EngineResolver,1,["/js/jsparse/jsdefs.js","/js/jsparse/jsparse.js","/js/jsparse/fulljslint.js"]);bespin.subscribe("parser:start",function(){bespin.get("parser").start();});bespin.register("parser",new bespin.parser.CodeInfo());bespin.fireAfter(["settings:language","settings:set:syntaxcheck","parser:engine:initialized"],function(){var settings=bespin.get("settings");if(settings&&settings.isOn(settings.get("syntaxcheck"))){var editor=bespin.get("editor");if(editor.language){bespin.publish("parser:start");}else{bespin.subscribe("settings:language",function(){bespin.publish("parser:start");});}}});bespin.subscribe("settings:language",function(){var settings=bespin.get("settings");if(settings&&settings.isOn(settings.get("syntaxcheck"))){bespin.publish("parser:start");}});
dojo.provide("bespin.cmd.cmd");bespin.cmd.cmd.commands=new bespin.command.Store(bespin.command.store,{name:'cmd',preview:'Various commands to manage commands'});bespin.cmd.cmd.commands.addCommand({name:'help',takes:['search'],preview:'show subcommands for project command',description:'The <strong>help</strong> gives you access to the various subcommands in the cmd command space.<br/><br/>You can narrow the search of a command by adding an optional search params.<br/><br/>Finally, pass in the full name of a command and you can get the full description, which you just did to see this!',completeText:'optionally, narrow down the search',execute:function(instruction,extra){var output=this.parent.getHelp(extra);instruction.addOutput(output);}});bespin.cmd.cmd.commands.addCommand({name:'load',takes:['commandname'],preview:'load up a new command',completeText:'command name to load (required)',usage:'[commandname]: Command name required.',execute:function(instruction,commandname){if(!commandname){instruction.addUsageOutput(this);return;}
if(!commandname){instruction.addErrorOutput("Please pass me a command name to load.");return;}
var path="commands/"+commandname+".js";var project=bespin.userSettingsProject;var onSuccess=function(file){try{var command=eval(file.content);bespin.command.store.addCommand(command);}catch(e){instruction.addErrorOutput("Something is wrong about the command:<br><br>"+e);}};bespin.get('files').loadContents(project,path,onSuccess,true);}});bespin.cmd.cmd.commands.addCommand({name:'edit',takes:['commandname'],aliases:['add'],preview:'edit the given command (force if doesn\'t exist',completeText:'command name to edit (required)',usage:'[commandname]: Command name required.',execute:function(instruction,commandname){if(!commandname){instruction.addUsageOutput(this);return;}
if(!bespin.userSettingsProject){instruction.addErrorOutput("You don't seem to have a user project. Sorry.");return;}
if(!commandname){instruction.addErrorOutput("Please pass me a command name to edit.");return;}
var project=bespin.userSettingsProject;var filename="commands/"+commandname+".js";var content=""+"{\n"+"    name: '"+commandname+"',\n"+"    takes: [YOUR_ARGUMENTS_HERE],\n"+"    preview: 'execute any editor action',\n"+"    execute: function(self, args) {\n"+"\n"+"    }\n"+"}";bespin.get("editor").openFile(project,filename,{content:content,force:true});}});bespin.cmd.cmd.commands.addCommand({name:'list',preview:'list my custom commands',execute:function(instruction){if(!bespin.userSettingsProject){instruction.addOutput("You don't seem to have a user project. Sorry.");return;}
bespin.get('server').list(bespin.userSettingsProject,'commands/',function(commands){var output;if(!commands||commands.length<1){output="You haven't installed any custom commands.<br>Want to <a href='https://wiki.mozilla.org/Labs/Bespin/Roadmap/Commands'>learn how?</a>";}else{output="<u>Your Custom Commands</u><br/><br/>";var jsCommands=dojo.filter(commands,function(file){return bespin.util.endsWith(file.name,'\\.js');});output+=dojo.map(jsCommands,function(jsCommand){return jsCommand.name.replace(/\.js$/,'');}).join("<br>");}
instruction.addOutput(output);});}});bespin.cmd.cmd.commands.addCommand({name:'rm',aliases:['del','delete'],takes:['commandname'],preview:'delete a custom command',completeText:'command name to delete (required)',usage:'[commandname]: Command name required.',execute:function(instruction,commandname){if(!commandname){instruction.addUsageOutput(this);return;}
var editSession=bespin.get('editSession');var files=bespin.get('files');if(!bespin.userSettingsProject){instruction.addErrorOutput("You don't seem to have a user project. Sorry.");return;}
if(!commandname){instruction.addErrorOutput("Please pass me a command name to delete.");return;}
var commandpath="commands/"+commandname+".js";var onSuccess=instruction.link(function(){if(editSession.checkSameFile(bespin.userSettingsProject,commandpath))bespin.get('editor').model.clear();instruction.addOutput('Removed command: '+commandname);});var onFailure=instruction.link(function(xhr){instruction.addOutput("Wasn't able to remove the command <b>"+commandname+"</b><br/><em>Error</em> (probably doesn't exist): "+xhr.responseText);});files.removeFile(bespin.userSettingsProject,commandpath,onSuccess,onFailure);}});
dojo.provide("bespin.cmd.config");bespin.command.store.addCommand({name:'editconfig',aliases:['config'],preview:'load up the config file',execute:function(instruction){if(!bespin.userSettingsProject){instruction.addErrorOutput("You don't seem to have a user project. Sorry.");return;}
bespin.get("editor").openFile(bespin.userSettingsProject,"config");}});bespin.command.store.addCommand({name:'runconfig',preview:'run your config file',execute:function(instruction){bespin.get('files').evalFile(bespin.userSettingsProject,"config");}});bespin.command.store.addCommand({name:'bindkey',takes:['modifiers','key','action'],preview:'Bind a key to an action, or show bindings',completeText:'With no arguments show bindings, else give modifier(s), key, and action name to set',execute:function(instruction,args){var editor=bespin.get('editor');if(args.key&&args.action){if(args.modifiers=="none")args.modifiers='';editor.bindKey(args.action,args.modifiers+' '+args.key,args.selectable);}else{var descriptions=editor.editorKeyListener.keyMapDescriptions;var output="<table>";for(var keys in descriptions){var keyData=keys.split(',');var keyCode=parseInt(keyData[0]);var modifiers=[];if(keyData[1]==="true")modifiers.push("CMD");if(keyData[2]==="true")modifiers.push("CTRL");if(keyData[3]==="true")modifiers.push("ALT");if(keyData[4]==="true")modifiers.push("SHIFT");var modifierInfo=modifiers.length>0?modifiers.join(', ')+" ":"";var keyInfo=modifierInfo+bespin.util.keys.KeyCodeToName[keyCode]||keyCode;output+="<tr><td style='text-align:right;'>"+keyInfo+"</td><td>&#x2192;</td><td>"+descriptions[keys]+"</td></tr>";}
output+="</table>";instruction.addOutput(output);}}});bespin.command.store.addCommand({name:'alias',takes:['alias','command'],preview:'define and show aliases for commands',completeText:'optionally, add your alias name, and then the command name',execute:function(instruction,args){var aliases=instruction.commandLine.store.aliases;if(!args.alias){var output="<table>";for(var x in aliases){output+="<tr><td style='text-align:right;'>"+x+"</td><td>&#x2192;</td><td>"+aliases[x]+"</td></tr>";}
output+="</table>";instruction.addOutput(output);}else{if(args.command===undefined){var alias=aliases[args.alias];if(alias){instruction.addOutput(args.alias+" &#x2192; "+aliases[args.alias]);}else{instruction.addErrorOutput("No alias set for '"+args.alias+"'");}}else{var key=args.alias;var value=args.command;var aliascmd=value.split(' ')[0];if(instruction.commandLine.store.commands[key]){instruction.addErrorOutput("Sorry, there is already a command with the name: "+key);}else if(instruction.commandLine.store.commands[aliascmd]){aliases[key]=value;instruction.addOutput("Saving alias: "+key+" &#x2192; "+value);}else if(aliases[aliascmd]){aliases[key]=value;instruction.addOutput("Saving alias: "+key+" &#x2192; "+aliases[value]+" ("+value+" was an alias itself)");}else{instruction.addErrorOutput("Sorry, no command or alias with that name.");}}}}});bespin.command.store.addCommand({name:'history',preview:'Show history of the commands',execute:function(instruction){var instructions=instruction.commandLine.history.getInstructions();var output=[];output.push("<table>");var count=1;dojo.forEach(instructions,function(instruction){output.push("<tr>");output.push('<th>'+count+'</th>');output.push('<td>'+instruction.typed+"</td>");output.push("</tr>");count++;});output.push("</table>");instruction.addOutput(output.join(''));}});bespin.command.store.addCommand({name:'set',takes:['key','value'],preview:'define and show settings',execute:function(instruction,setting){var output;if(!setting.key){var settings=bespin.get("settings").list();output="";dojo.forEach(settings.sort(function(a,b){if(a.key<b.key){return-1;}else if(a.key==b.key){return 0;}else{return 1;}}),function(setting){if(setting.key[0]!='_'){output+="<a class='setting' href='https://wiki.mozilla.org/Labs/Bespin/Settings#"+setting.key+"' title='View external documentation on setting: "+setting.key+"' target='_blank'>"+setting.key+"</a> = "+setting.value+"<br/>";}});}else{var key=setting.key;if(setting.value===undefined){var value=bespin.get("settings").get(key);if(value){output="<strong>"+key+"</strong> = "+value;}else{output="You do not have a setting for '"+key+"'";}}else{output="Saving setting: <strong>"+key+"</strong> = "+setting.value;bespin.get("settings").set(key,setting.value);}}
instruction.addOutput(output);},findCompletions:function(query,callback){var settings=bespin.get("settings");var key=query.action[0];var val=settings.get(key);if(query.action.length==1){if(val){query.hint="Current value of "+key+" is '"+val+"'. Enter a new value, or press enter to display in the console.";callback(query);return;}
var list=settings.list().map(function(entry){return entry.key;});var matches=this.parent.filterOptionsByPrefix(list,key);if(matches.length==1){query.autofill="set "+matches[0];val=settings.get(matches[0]);query.hint="Current value of "+matches[0]+" is '"+val+"'. Enter a new value, or press enter to display in the console.";}else if(matches.length==0){query.error="No matching settings";}else{matches.sort(function(a,b){return a.localeCompare(b);});query.options=matches;}
callback(query);return;}
if(val){query.hint="Current value of "+key+" is '"+val+"'. Enter a new value, or press enter to display in the console.";callback(query);return;}
query.error="No setting for '"+key+"'";callback(query);return;}});bespin.command.store.addCommand({name:'unset',takes:['key'],preview:'unset a setting entirely',completeText:'add a key for the setting to delete entirely',execute:function(instruction,key){var settings=bespin.get("settings");if(!settings.get(key)){instruction.addErrorOutput("No setting for "+key+".");}else{settings.unset(key);instruction.addOutput("Unset the setting for "+key+".");}},findCompletions:function(query,callback){var settings=bespin.get("settings");var key=query.action[0];var val=settings.get(key);if(query.action.length>1){query.error="Can only unset one setting at a time";callback(query);return;}
if(val){query.hint="Current value of "+key+" is '"+val+"'. Press enter to remove the setting.";callback(query);return;}
var list=settings.list().map(function(entry){return entry.key;});var matches=this.parent.filterOptionsByPrefix(list,key);if(matches.length==1){query.autofill="set "+matches[0];val=settings.get(matches[0]);query.hint="Current value of "+matches[0]+" is '"+val+"'. Press enter to remove the setting.";}else if(matches.length==0){query.error="No matching settings";}else{matches.sort(function(a,b){return a.localeCompare(b);});query.options=matches;}
callback(query);return;}});
dojo.provide("bespin.cmd.editor");bespin.command.store.addCommand({name:'search',takes:['searchString'],preview:'searches the current file for the given searchString',completeText:'type in a string to search',execute:function(instruction,str){bespin.get('actions').startSearch(str,'commandLine');bespin.getComponent("popup",function(popup){popup.hide();});}});(function(){var previewFull='move it! make the editor head to a line number or a function name.';var preview='move it! make the editor head to a line number.';var completeTextFull='add the line number to move to, or the name of a function in the file';var completeText='add the line number to move to in the file';var gotoCmd={name:'goto',takes:['value'],preview:previewFull,completeText:completeTextFull,execute:function(instruction,value){var settings=bespin.get("settings");if(value){var linenum=parseInt(value,10);if(isNaN(linenum)){if(settings.isOn(settings.get("syntaxcheck"))){bespin.publish("parser:gotofunction",{functionName:value});}else{instruction.addErrorOutput("Please enter a valid line number.");}}else{bespin.get("editor").moveAndCenter(linenum);bespin.publish("ui:escape",{});}}}};bespin.command.store.addCommand(gotoCmd);bespin.subscribe("settings:set:syntaxcheck",function(){var settings=bespin.get("settings");if(settings.isOn(settings.get("syntaxcheck"))){gotoCmd.preview=previewFull;gotoCmd.completeText=completeTextFull;}else{gotoCmd.preview=preview;gotoCmd.completeText=completeText;}});})();bespin.command.store.addCommand({name:'replace',takes:['search','replace'],preview:'s/foo/bar/g',completeText:'add the search regex, and then the replacement text',execute:function(instruction,args){bespin.get("editor").ui.actions.replace(args);}});bespin.command.store.addCommand({name:'sort',takes:['direction'],preview:'sort the current buffer',completeText:'optionally, sort descending',execute:function(instruction,direction){var buffer=bespin.get("editor").model.getDocument().split(/\n/);buffer.sort();if(direction&&/^desc/.test(direction.toLowerCase())){buffer.reverse();}
bespin.get("editor").model.insertDocument(buffer.join("\n"));}});bespin.command.store.addCommand({name:'trim',takes:['side'],preview:'trim trailing or leading whitespace',completeText:'optionally, give a side of left, right, or both (defaults to right)',execute:function(instruction,side){if(!side)side="right";var replaceArgs={replace:''};if(bespin.util.include(["left","both"],side)){replaceArgs.search="^\\s+";bespin.get("editor").ui.actions.replace(replaceArgs);}
if(bespin.util.include(["right","both"],side)){replaceArgs.search="\\s+$";bespin.get("editor").ui.actions.replace(replaceArgs);}}});bespin.command.store.addCommand({name:'uc',preview:'Change all selected text to uppercase',withKey:"CMD SHIFT U",execute:function(instruction){var args={stringCase:'u'};bespin.get("editor").ui.actions.selectionChangeCase(args);}});bespin.command.store.addCommand({name:'lc',preview:'Change all selected text to lowercase',withKey:"CMD SHIFT L",execute:function(instruction){var args={stringCase:'l'};bespin.get("editor").ui.actions.selectionChangeCase(args);}});bespin.command.store.addCommand({name:'outline',preview:'show outline of source code',withKey:"ALT SHIFT O",execute:function(instruction){bespin.publish("parser:showoutline");}});
dojo.provide("bespin.cmd.file");bespin.command.store.addCommand({name:'files',aliases:['ls','list'],takes:['path'],preview:'show files',completeText:'list files relative to current file, or start with /projectname',execute:function(instruction,givenPath){var list=bespin.cmd.file._parseArguments(givenPath,{filter:true});bespin.get('server').list(list.project,list.path,function(filenames){var files="";for(var x=0;x<filenames.length;x++){files+=filenames[x].name+"<br/>";}
instruction.addOutput(files);});},findCompletions:function(query,callback){bespin.cmd.file._findCompletionsHelper(query,callback,{matchFiles:false,matchDirectories:true});}});bespin.command.store.addCommand({name:'mkdir',takes:['path'],preview:'create a new directory, use a leading / to create a directory in a different project',usage:'[path]',execute:function(instruction,givenPath){if(!givenPath){instruction.addUsageOutput(this);return;}
var editSession=bespin.get('editSession');var info=bespin.cmd.file._parseArguments(givenPath);var path=info.path;var project=info.project||editSession.project;var onSuccess=instruction.link(function(){if(path=='')editSession.setProject(project);instruction.addOutput('Successfully created directory \'/'+project+'/'+path+'\'');instruction.unlink();});var onFailure=instruction.link(function(xhr){instruction.addErrorOutput('Unable to create directory \'/'+project+'/'+path+'\': '+xhr.responseText);instruction.unlink();});bespin.get('files').makeDirectory(project,path,onSuccess,onFailure);}});bespin.command.store.addCommand({name:'save',takes:['filename'],preview:'save the current contents',completeText:'add the filename to save as, or use the current file',withKey:"CMD S",execute:function(instruction,filename){bespin.get("editor").saveFile(null,filename);}});bespin.command.store.addCommand({name:'open',aliases:['load'],takes:['path','line'],preview:'load up the contents of the file',completeText:'add the filename to open',execute:function(instruction,opts){bespin.publish("editor:openfile",opts);var info=bespin.cmd.file._parseArguments(opts.path);bespin.get("editor").openFile(info.project,info.path,{line:opts.line});bespin.publish("ui:escape",{});},findCompletions:function(query,callback){bespin.cmd.file._findCompletionsHelper(query,callback,{matchFiles:true,matchDirectories:true});}});bespin.command.store.addCommand({name:'status',preview:'get info on the current project and file',execute:function(instruction){instruction.addOutput(bespin.get('editSession').getStatus());}});bespin.command.store.addCommand({name:'newfile',takes:['filename'],preview:'create a new buffer for file',completeText:'optionally, you can specify a full path including project by starting the filename with "/"',withKey:"CTRL SHIFT N",execute:function(instruction,filename){var info=bespin.cmd.file._parseArguments(filename);bespin.get("editor").newFile(info.project,info.path);bespin.publish("ui:escape",{});}});bespin.command.store.addCommand({name:'rm',aliases:['remove','del'],takes:['filename'],preview:'remove the file',completeText:'add the filename to remove, give a full path starting with '/' to delete from a different project. To delete a directory end the path in a '/'',execute:function(instruction,filename){var info=bespin.cmd.file._parseArguments(filename);var path=info.path;var project=info.project;var onSuccess=instruction.link(function(){if(bespin.get('editSession').checkSameFile(project,path)){bespin.get("editor").model.clear();}
instruction.addOutput('Removed file: '+filename,true);instruction.unlink();});var onFailure=instruction.link(function(xhr){instruction.addErrorOutput("Wasn't able to remove the file <b>"+filename+"</b><br/><em>Error</em> (probably doesn't exist): "+xhr.responseText);instruction.unlink();});bespin.get('files').removeFile(project,path,onSuccess,onFailure);},findCompletions:function(query,callback){bespin.cmd.file._findCompletionsHelper(query,callback,{matchFiles:true,matchDirectories:true});}});bespin.command.store.addCommand({name:'clear',aliases:['cls'],preview:'clear the file',execute:function(instruction){bespin.get("editor").model.clear();}});bespin.command.store.addCommand({name:'quota',preview:'show your quota info',megabytes:function(bytes){return(bytes/1024/1024).toFixed(2);},execute:function(instruction){var es=bespin.get('editSession');var output="You have "+this.megabytes(es.quota-es.amountUsed)+" MB free space to put some great code!<br>"+"Used "+this.megabytes(es.amountUsed)+" MB "+"out of your "+this.megabytes(es.quota)+" MB quota.";instruction.addOutput(output);}});bespin.command.store.addCommand({name:'rescan',takes:['project'],preview:'update the project catalog of files used by quick open',execute:function(instruction,project){if(!project){bespin.withComponent('editSession',function(editSession){project=editSession.project;});}
bespin.get("server").rescan(project,instruction,{onSuccess:instruction.link(function(response){instruction.addOutput(response);instruction.unlink();}),onFailure:instruction.link(function(xhr){instruction.addErrorOutput(xhr.response);instruction.unlink();})});}});bespin.cmd.file._parseArguments=function(givenPath,opts){opts=opts||{};var session=bespin.get("editSession");var project=session.project;var path=session.path||"";var parts=path.split(/\//);parts.pop();path=parts.join("/");var filter="";var projectPath="";if(givenPath){if(givenPath.charAt(0)==="/"){var parts=givenPath.substr(1).split(/\//);filter=parts.pop();project=parts.shift()||"";if(parts.length){path=parts.join("/")+"/";}else{path="";}
projectPath="/"+project+"/"+path;projectPath=projectPath.replace(/\/+/g,"/");}else{var parts=givenPath.split(/\//);filter=parts.pop();var trimmedPath=parts.join("/");path=path+"/"+trimmedPath;projectPath="";}}
if(!opts.filter){path=path+filter;filter=undefined;}
return{project:project,path:path,filter:filter,projectPath:projectPath};};bespin.cmd.file._findCompletionsHelper=function(query,callback,options){var givenPath=query.action.join(" ");var list=bespin.cmd.file._parseArguments(givenPath,{filter:true});var self=this;bespin.get('server').list(list.project,list.path,function(files){var matches=files.filter(function(file){var isFile=(file.size!==undefined);if((options.matchDirectories&&isFile)&&(options.matchFiles&&!isFile)){return false;}
return file.name.substr(0,list.filter.length)===list.filter;});if(matches.length==1){query.autofill=query.prefix+list.projectPath+matches[0].name;query.hint="Press return to "+query.autofill;}else if(matches.length==0){query.error="No matches";}else{query.options=matches.map(function(match){return match.name;});}
callback(query);});};
dojo.provide("bespin.cmd.other");bespin.command.store.addCommand({name:'eval',takes:['js-code'],preview:'evals given js code and show the result',completeText:'evals given js code and show the result',execute:function(instruction,jscode){try{var result=eval(jscode);}catch(e){var result='<b>Error: '+e.message+'</b>';}
var msg='';var type='';if(dojo.isFunction(result)){msg=(result+'').replace(/\n/g,'<br>').replace(/ /g,'&#160');type='function';}else if(dojo.isObject(result)){if(dojo.isArray(result)){type='array';}else{type='object';}
var items=[];var value;for(x in result){if(dojo.isFunction(result[x])){value="[function]";}else if(dojo.isObject(result[x])){value="[object]";}else{value=result[x];}
items.push({name:x,value:value});}
items.sort(function(a,b){return(a.name.toLowerCase()<b.name.toLowerCase())?-1:1;});for(var x=0;x<items.length;x++){msg+='<b>'+items[x].name+'</b>: '+items[x].value+'<br>';}}else{msg=result;type=typeof result;}
instruction.addOutput("Result for eval <b>\""+jscode+"\"</b> (type: "+type+"): <br><br>"+msg);}});bespin.command.store.addCommand({name:'version',takes:['command'],preview:'show the version for Bespin or a command',completeText:'optionally, a command name',execute:function(instruction,command){var bespinVersion='Your Bespin is at version '+bespin.versionNumber+', Code name: "'+bespin.versionCodename+'"';var version;if(command){var theCommand=instruction.commandLine.store.commands[command];if(!theCommand){version="It appears that there is no command named '"+command+"', but "+bespinVersion;}else{version=(theCommand.version)?"The command named '"+command+"' is at version "+theCommand.version:"The command named '"+command+"' is a core command in Bespin version "+bespin.versionNumber;}}
else{version=bespinVersion;}
instruction.addOutput(version);}});bespin.command.store.addCommand({name:'bespin',preview:'has',hidden:true,messages:["really wants you to trick it out in some way.","is your Web editor.","would love to be like Emacs on the Web.","is written on the Web platform, so you can tweak it."],execute:function(instruction){var index=Math.floor(Math.random()*this.messages.length);instruction.addOutput("Bespin "+this.messages[index]);}});
dojo.provide("bespin.cmd.project");bespin.cmd.project.commands=new bespin.command.Store(bespin.command.store,{name:'project',preview:'Various commands to manage projects'});bespin.cmd.project.commands.addCommand({name:'help',takes:['search'],preview:'show subcommands for project command',description:'The <strong>help</strong> gives you access to the various subcommands in the project command space.<br/><br/>You can narrow the search of a command by adding an optional search params.<br/><br/>Finally, pass in the full name of a command and you can get the full description, which you just did to see this!',completeText:'optionally, narrow down the search',execute:function(instruction,extra){var output=this.parent.getHelp(extra);instruction.addOutput(output);}});bespin.cmd.project.commands.addCommand({name:'show',preview:'show the current project',execute:function(instruction,projectname){instruction.addOutput(bespin.get('editSession').getStatus());}});bespin.cmd.project.commands.addCommand({name:'list',preview:'show projects',execute:function(instruction,extra){bespin.get('files').projects(function(projectNames){var projects="";for(var x=0;x<projectNames.length;x++){projects+=projectNames[x].name+"<br/>";}
instruction.addOutput(projects);});}});bespin.cmd.project.commands.addCommand({name:'create',takes:['projectname'],preview:'create a new project',usage:'[newprojectname]',execute:function(instruction,project){if(!project){instruction.addUsageOutput(this);return;}
var onSuccess=instruction.link(function(){bespin.get('editSession').setProject(project);instruction.addOutput('Successfully created project \''+project+'\'.');bespin.publish("project:created",{project:project});});var onFailure=instruction.link(function(xhr){instruction.addErrorOutput('Unable to create project \''+project+'\: '+xhr.responseText);});bespin.get('files').makeDirectory(project,'',onSuccess,onFailure);}});bespin.cmd.project.commands.addCommand({name:'delete',takes:['projectname'],preview:'delete a project',usage:'[projectname]',execute:function(instruction,project){if(!project){instruction.addUsageOutput(this);return;}
if(!project||project==bespin.userSettingsProject){instruction.addErrorOutput('Sorry, you can\'t delete the settings project.');return;}
var onSuccess=instruction.link(function(){instruction.addOutput('Deleted project '+project);instruction.unlink();bespin.publish("project:deleted",{project:project});});var onFailure=instruction.link(function(xhr){instruction.addErrorOutput('Failed to delete project '+project+': '+xhr.responseText);instruction.unlink();});bespin.get('files').removeDirectory(project,'',onSuccess,onFailure);}});bespin.cmd.project.commands.addCommand({name:'rename',takes:['currentProject','newProject'],preview:'rename a project',usage:'[currentProject], [newProject]',execute:function(instruction,args){if(!args.currentProject||!args.newProject){instruction.addUsageOutput(this);return;}
var currentProject=args.currentProject;var newProject=args.newProject;if((!currentProject||!newProject)||(currentProject==newProject)){return;}
bespin.get('server').renameProject(currentProject,newProject,{onSuccess:instruction.link(function(){bespin.get('editSession').setProject(newProject);instruction.unlink();bespin.publish("project:renamed",{oldName:currentProject,newName:newProject});}),onFailure:instruction.link(function(xhr){instruction.addErrorOutput('Unable to rename project from '+currentProject+" to "+newProject+"<br><br><em>Are you sure that the "+currentProject+" project exists?</em>");instruction.unlink();})});}});bespin.cmd.project.commands.addCommand({name:'export',takes:['project','archivetype'],preview:'export the given project with an archivetype of zip or tgz<br><code>project export myproject</code>',completeText:'project name, archivetype (zip | tgz, defaults to zip)',execute:function(instruction,args){var project=args.project||bespin.get('editSession').project;var type=args.archivetype;if(!bespin.util.include(['zip','tgz','tar.gz'],type)){type='zip';}
bespin.get('files').projects(function(projects){var projectDir=project+"/";if(bespin.util.indexOfProperty(projects,"name",projectDir)!=null){bespin.get('server').exportProject(project,type);}else{instruction.addErrorOutput("Unabled to export project "+project+" because it doesn't seem to exist.");instruction.unlink();}});}});bespin.cmd.project.commands.addCommand({name:'import',takes:['url','project'],preview:'If a URL is given, import that URL (e.g. <code>project import http://foo.com/bar.zip MyProject</code>).<br><br>If only a project is given, then a file upload dialog will ask to upload a local file (e.g. <code>project import MyProject</code>).',completeText:"import from a URL: <code>project import http://foo.com/yourarchive.zip [projectname]</code><br><br>upload from your machine: <code>project import YourProjectName</code><br><br><em>If only a URL is given, the projectname will be implied<br><br>If only a project name is given, a file upload window will be shown to upload.</em>",usage:"import from a URL: <code>project import http://foo.com/yourarchive.zip [projectname]</code><br><br>upload from your machine: <code>project import YourProjectName</code><br><br><em>If only a URL is given, the projectname will be implied<br><br>If only a project name is given, a file upload window will be shown to upload.</em>",calculateProjectName:function(url){var split=url.split('/');var projectMaker=split[split.length-1].split(".");projectMaker.pop();return projectMaker.join("_");},isURL:function(url){return(url&&(/^http(:|s:)/.test(url)));},upload:function(project){var el=dojo.byId('centerpopup');el.innerHTML="<div id='upload-container'><form method='POST' name='upload' id='upload' enctype='multipart/form-data'><div id='upload-header'>Import project via upload <img id='upload-close' src='images/icn_close_x.png' align='right'></div><div id='upload-content'><div id='upload-status'></div><p>Browse to find the project archive that you wish to archive<br>and then click on the <code>Upload</code> button.</p><center><input type='file' id='filedata' name='filedata' accept='application/zip,application/x-gzip'> <input type='submit' value='Upload'></center></div></form></div>";dojo.require("dijit._base.place");dojo.require("bespin.util.webpieces");dojo.require("dojo.io.iframe");dojo.connect(dojo.byId('upload'),"submit",function(){dojo.byId('upload-status').innerHTML='Importing file into new project '+project;dojo.io.iframe.send({url:'/project/import/'+project,form:dojo.byId('upload'),method:'POST',handleAs:'text',preventCache:true,contentType:"multipart/form-data",load:function(data,ioArg){dojo.byId('upload-status').innerHTML='Thanks for uploading the file!';},error:function(error,ioArg){setTimeout(function(){bespin.get('files').projects(function(projectNames){if(dojo.some(projectNames,function(testProject){return project+'/'==testProject.name;})){bespin.publish("project:created",{project:project});dojo.byId('upload-status').innerHTML='Archive imported and project '+project+' has been created!';}else{dojo.byId('upload-status').innerHTML='Error uploading the file. Sorry, try again!';}});},100);}});});bespin.util.webpieces.showCenterPopup(el,true);var uploadClose,overlay;var hideCenterPopup=function(){el.removeChild(el.firstChild);bespin.util.webpieces.hideCenterPopup(el);dojo.disconnect(uploadClose);dojo.disconnect(overlay);};uploadClose=dojo.connect(dojo.byId("upload-close"),"onclick",hideCenterPopup);overlay=dojo.connect(dojo.byId("overlay"),"onclick",hideCenterPopup);},execute:function(instruction,args){var project,url;if(!args.url){instruction.addUsageOutput(this);return;}else if(!args.project&&this.isURL(args.url)){args.project=this.calculateProjectName(args.url);}else if(this.isURL(args.project)){project=args.project;url=args.url;args.project=url;args.url=project;}else if(!this.isURL(args.url)){var project=args.url;this.upload(project);}else{project=args.project;url=args.url;instruction.addOutput("About to import "+project+" from:<br><br>"+url+"<br><br><em>It can take awhile to download the project, so be patient!</em>");bespin.get('server').importProject(project,url,{onSuccess:function(){instruction.addOutput("Project "+project+" imported from:<br><br>"+url);bespin.publish("project:created",{project:project});},onFailure:function(xhr){instruction.addErrorOutput("Unable to import "+project+" from:<br><br>"+url+".<br><br>Maybe due to: "+xhr.responseText);}});}}});
dojo.provide("bespin.test");dojo.require("bespin.util.util");bespin.command.store.addCommand({name:'test',takes:['suite'],preview:'run a test suite or suites',completeText:'suite name, or \'all\' to run all tests, or press return to list tests.',execute:function(instruction,suite){if(!suite){if(bespin.util.isEmpty(bespin.test._knownTests)){instruction.addOutput("No test suites registered. See bespin.test.addTests() to add them.");}else{var msg="Available test targets: all";for(var name in bespin.test._knownTests){msg+=", "+name;}
instruction.addOutput(msg);}}else if(suite=="all"){var tests=[];for(var name in bespin.test._knownTests){tests.push(name);}
bespin.test.run(instruction,tests);}else{if(bespin.test._knownTests[suite]){bespin.test.run(instruction,[suite]);}else{instruction.addErrorOutput("No test suite called: "+suite);}}}});dojo.mixin(bespin.test,{addTests:function(name,container){if(name=="all")throw new Error("Test suites can't be called 'all'");this._knownTests[name]=container;},run:function(instruction,suiteNames){console.log("bespin.test.run",suiteNames);var table=dojo.create("table");instruction.setElement(table);var tbody=dojo.create("tbody",{},table);var row=dojo.create("tr",{},tbody);dojo.create("th",{innerHTML:"Test Name"},row);dojo.create("th",{innerHTML:"Results"},row);dojo.create("th",{innerHTML:"Action"},row);dojo.create("th",{innerHTML:"Notes"},row);var self=this;suiteNames.forEach(function(suiteName){row=dojo.create("tr",{},tbody);dojo.create("th",{innerHTML:suiteName},row);dojo.create("td",{},row);var suiteResultsTd=dojo.create("td",{},row);var suiteNotesTd=dojo.create("td",{},row);var suite=self._knownTests[suiteName];var setupOk=true;if(suite.setup){try{suite.setup();}
catch(e){console.error(suiteName+".setup(): ",e);var message=suiteName+".setup() failed: "+e.toString();suiteNotesTd.innerHTML=message;setupOk=false;}}
if(setupOk){for(var testName in suite){var test=suite[testName];if(testName.match(/test/)&&typeof test=="function"){row=dojo.create("tr",{},tbody);dojo.create("td",{innerHTML:self._addSpaces(testName),style:"padding-left:30px;"},row);var actionTd=dojo.create("td",{},row);var resultsTd=dojo.create("td",{style:"padding:0 3px;"},row);var notesTd=dojo.create("td",{},row);var assert=new bespin.test.Assert(suiteName,suite,testName,test,resultsTd,notesTd);dojo.create("button",{innerHTML:"Run",onclick:(function(assert){return function(){assert._reset();assert._runTest();};})(assert)},actionTd);assert._runTest();}}
if(suite.tearDown){try{suite.tearDown();}catch(e){console.error(suiteName+".tearDown(): ",e);var message="tearDown() failed: "+e.toString();suiteNotesTd.innerHTML=message;}}}});},_addSpaces:function(testName){testName=testName.replace(/^test/g,"");testName=testName.replace(/([a-z0-9])([A-Z])/g,"$1 $2");testName=testName.replace(/([a-zA-Z])([0-9])/g,"$1 $2");return testName;},_knownTests:{}});bespin.test.Status={none:{ord:0,attr:{style:{color:"#000",backgroundColor:"#eee"},innerHTML:"-"}},exec:{ord:1,attr:{style:{color:"#fff",backgroundColor:"#888"},innerHTML:"Exec"}},async:{ord:2,attr:{style:{color:"#000",backgroundColor:"#ffa"},innerHTML:"Wait"}},pass:{ord:3,attr:{style:{color:"#000",backgroundColor:"#8f8"},innerHTML:"Pass"}},fail:{ord:4,attr:{style:{color:"#fff",backgroundColor:"#f00"},innerHTML:"Fail"}}};dojo.declare("bespin.test.Assert",null,{constructor:function(suiteName,suite,testName,test,resultsTd,notesTd){this._suiteName=suiteName;this._suite=suite;this._test=test;this._testName=testName;this._resultsTd=resultsTd;this._notesTd=notesTd;this._outstanding=0;this._start=new Date().getTime();this.failFast=false;this.status=bespin.test.Status.none;},isTrue:function(value,message){if(!value)this._fail("isTrue",arguments);},isFalse:function(value,message){if(value)this._fail("isFalse",arguments);},isNull:function(value,message){if(value!==null)this._fail("isNull",arguments);},isNotNull:function(value,message){if(value===null)this._fail("isNotNull",arguments);},isUndefined:function(value,message){if(value!==undefined)this._fail("isUndefined",arguments);},isNotUndefined:function(value,message){if(value===undefined)this._fail("isNotUndefined",arguments);},isNaN:function(value,message){if(!isNaN(value))this._fail("isNaN",arguments);},isNotNaN:function(value,message){if(isNaN(value))this._fail("isNotNaN",arguments);},isEqual:function(expected,actual,message){if(!this._isEqual(expected,actual))this._fail("isEqual",arguments);},isNotEqual:function(expected,actual,message){if(this._isEqual(expected,actual))this._fail("isNotEqual",arguments);},fail:function(message){this._fail("fail",arguments);},message:function(message){this._addMessage("<strong>"+message+"</strong>");},command:function(type,expect){var commandLine=bespin.get("commandLine");var instruction=commandLine.executeCommand(type,true);var self=this;var check=function(output){if(dojo.isArray(expect)){expect.forEach(function(expected){if(output.indexOf(expected)==-1){self._fail("command",[type,expected],output);}});}else{if(output!=expect){self._fail("command",[type,expect],output);}}};if(instruction.element){check(instruction.element.textContent);}else if(instruction.outstanding!=0){instruction.onOutput(function(){if(instruction.complete){check(instruction.output);}});}else{check(instruction.output);}},link:function(func,scope){this._updateStatus(bespin.test.Status.async);this._outstanding++;var self=this;return function(){try{if(typeof func=="function"){return func.apply(scope,arguments);}}catch(e){if(e.toString()!="failFast"){console.error(this._suiteName+"."+this._testName+":link(): ",e);self._addFunctionMessage("link",[e.toString()]);self._updateStatus(bespin.test.Status.fail);}}finally{self._outstanding--;if(self._outstanding==0){self._updateStatus(bespin.test.Status.pass);}}};},createOnError:function(func,scope){var self=this;return function(){self._updateStatus(bespin.test.Status.fail);if(typeof func=="function"){self._addMessage("onError handler called");try{return func.apply(scope,arguments);}catch(e){if(e.toString()!="failFast"){console.error(this._suiteName+"."+this._testName+":createOnError(): ",e);self._addFunctionMessage("createOnError",[e.toString()]);}}}
else if(typeof func=="string"){self._addFunctionMessage("createOnError",[func]);}
else{self._addFunctionMessage("createOnError");}};},_reset:function(){this.status=bespin.test.Status.none;this._outstanding=0;this._start=new Date().getTime();this._notesTd.innerHTML="";dojo.attr(this._resultsTd,this.status.attr);},_runTest:function(){if(this._suite.setupTest){try{this._suite.setupTest.call(this._suite);}
catch(e){console.error("setupTest failure when running: "+this._suiteName+"."+this._testName+"(): ",e);this._addFunctionMessage(this._testName,[e.toString()]);this._updateStatus(bespin.test.Status.fail);return;}}
console.log("Running test",this._testName);this._updateStatus(bespin.test.Status.exec);try{this._test.call(this._suite,this);if(this._outstanding==0){this._updateStatus(bespin.test.Status.pass);}}
catch(e){if(e!="failFast"){console.error(this._suiteName+"."+this._testName+"(): ",e);this._addFunctionMessage(this._testName,[e.toString()]);this._updateStatus(bespin.test.Status.fail);}}
if(this._suite.tearDownTest){try{this._suite.tearDownTest.call(this._suite);}
catch(e){console.error("tearDownTest failure when running: "+this._suiteName+"."+this._testName+"(): ",e);this._addFunctionMessage(this._testName,[e.toString()]);this._updateStatus(bespin.test.Status.fail);}}},_fail:function(type,args,reply){this._addFunctionMessage(type,args,reply);this._updateStatus(bespin.test.Status.fail);if(this.failFast){throw"failFast";}},_addFunctionMessage:function(type,args,reply){var message=type+this._argsToString(args);if(reply){message+=" = "+dojo.toJson(reply);}
this._addMessage(message);},_addMessage:function(message){this._notesTd.innerHTML+=message+"<br/>";},_updateStatus:function(status){if(this.status.ord<status.ord){this.status=status;}
dojo.attr(this._resultsTd,this.status.attr);var delay=(new Date().getTime()-this._start)/1000;this._resultsTd.innerHTML+=" (in "+delay+" ms)";},_argsToString:function(args){var reply="(";if(args!=null){for(var i=0;i<args.length;i++){if(i!=0)reply+=", ";reply+=dojo.toJson(args[i]);}}
reply+=")";return reply;},_isEqual:function(expected,actual,depth){if(!depth)depth=0;if(depth>10)return true;if(expected==null){if(actual!=null){console.log("expected: null, actual non-null: "+dojo.toJson(actual));return false;}
return true;}
if(typeof(expected)=="number"&&isNaN(expected)){if(!(typeof(actual)=="number"&&isNaN(actual))){console.log("expected: NaN, actual non-NaN: "+dojo.toJson(actual));return false;}
return true;}
if(actual==null){if(expected!=null){console.log("actual: null, expected non-null: "+dojo.toJson(expected));return false;}
return true;}
if(typeof expected=="object"){if(!(typeof actual=="object")){console.log("expected object, actual not an object");return false;}
var actualLength=0;for(var prop in actual){if(typeof actual[prop]!="function"||typeof expected[prop]!="function"){var nest=this._isEqual(actual[prop],expected[prop],depth+1);if(typeof nest!="boolean"||!nest){console.log("element '"+prop+"' does not match: "+nest);return false;}}
actualLength++;}
var expectedLength=0;for(prop in expected)expectedLength++;if(actualLength!=expectedLength){console.log("expected object size = "+expectedLength+", actual object size = "+actualLength);return false;}
return true;}
if(actual!=expected){console.log("expected = "+expected+" (type="+typeof expected+"), actual = "+actual+" (type="+typeof actual+")");return false;}
if(expected instanceof Array){if(!(actual instanceof Array)){console.log("expected array, actual not an array");return false;}
if(actual.length!=expected.length){console.log("expected array length = "+expected.length+", actual array length = "+actual.length);return false;}
for(var i=0;i<actual.length;i++){var inner=this._isEqual(actual[i],expected[i],depth+1);if(typeof inner!="boolean"||!inner){console.log("element "+i+" does not match: "+inner);return false;}}
return true;}
return true;}});
dojo.provide("bespin.testTest");dojo.require("bespin.test");bespin.test.addTests("test",{setup:function(){this.setupRun=true;},testSetup:function(test){test.isTrue(this.setupRun);},testSimple:function(test){test.isTrue(true);test.isFalse(false);test.isNull(null);test.isUndefined(undefined);test.isNaN(NaN);test.isEqual(42,42);test.isNotNull(undefined);test.isNotNull(0);test.isNotNull("null");test.isNotNull(false);test.isNotUndefined(null);test.isNotUndefined(0);test.isNotUndefined("undefined");test.isNotUndefined(false);test.isNotNaN(null);test.isNotNaN(0);test.isNotNaN("NaN");test.isNotNaN(false);test.isNotEqual(42,43);test.isNotEqual(0,"0");},testAsync:function(test){setTimeout(test.link(function(){test.isTrue(true);test.isEqual(["a"],["a"]);}),10);},testFailures:function(test){test.message("It is important that this test fails in exactly 11 places");setTimeout(test.link(function(){test.isNull(100,"#7");test.isNotNull(null,"#8");}),10);setTimeout(test.link(function(){test.isNull(100,"#9");}),20);setTimeout(test.createOnError(function(){test.fail("#10");}),30);setTimeout(test.createOnError(function(){test.fail("#11");}),40);test.isTrue(false,"#1");test.isFalse(true,"#2");test.isEqual(42,43,"#3");test.isEqual("a","aa","#4");test.isEqual(["a"],["aa"],"#5");test.fail("Die Die Die","#6");},testFailFast:function(test){test.failFast=true;test.fail("This should fail only once");test.fail("If this happens we are broken");},testSlowDeath:function(test){test.message("This only works if we get a 'Delayed failure' message");setTimeout(test.createOnError(function(){test.message("Delayed failure");}),1000);},testSlowPass:function(test){setTimeout(test.link(function(){test.message("Delayed success");}),1000);},testCommand:function(test){test.command("testoutput wibble","wibble");}});bespin.command.store.addCommand({name:'testoutput',takes:['message ...'],preview:'A test echo command',execute:function(instruction,args){instruction.addOutput(args);}});
dojo.provide("bespin.plugins");dojo.declare("bespin.plugins.Extension",null,{constructor:function(collection,pluginName,resolver,meta){this._pluginName=pluginName;this._pluginCollection=collection;this._resolver=resolver;dojo.mixin(this,meta);},load:function(callback){var self=this;var parts=this.pointer.split(":");var modname=this._resolver(parts[0]);var module=bespin.plugins.loader.modules[modname];if(!module){bespin.plugins.loader.loadScript(modname,{callback:function(module){if(!module._used_by_plugins){module._used_by_plugins={};}
module._used_by_plugins[self._pluginName]=self._pluginCollection;module._resolver=self._resolver;if(module.activate){module.activate();}
if(callback){if(parts[1]){callback(module[parts[1]]);}else{callback(module);}}},resolver:this._resolver});return;}
if(callback){if(parts[1]){callback(module[parts[1]]);}else{callback(module);}}},getIfLoaded:function(){var parts=this.pointer.split(":");var modname=this._resolver(parts[0]);var module=bespin.plugins.loader.modules[modname];if(parts[1]){return module[parts[1]];}else{return module;}}});dojo.mixin(bespin.plugins,{metadata:{},builtins:{},extensionPoints:{},unregisterExtensionPoints:function(pluginName,collection){if(!collection){collection=bespin.plugins.metadata;}
var extensionPoints=bespin.plugins.extensionPoints;var info=collection[pluginName];if(!info){return;}
var provides=info.provides;if(!provides){return;}
for(var i=0;i<provides.length;i++){var ep=provides[i];var name=ep[0];var meta=ep[1];var extList=extensionPoints[name];if(!extList){continue;}
for(var j=0;j<extList.length;j++){var ext=extList[j];if(ext._pluginName==pluginName){extList.splice(j,1);bespin.publish("extension:removed:"+name,ext);j--;}}}},sameFileResolver:function(name){return this.location;},multiFileResolver:function(name){if(name.charAt(0)!="/"){if(this.location.charAt(this.location.length-1)=='/'){name=this.location+name+".js";}else{name=this.location+'/'+name+'.js';}}
return name;},registerExtensionPoints:function(pluginName,collection,resolver){var extensionPoints=bespin.plugins.extensionPoints;var Extension=bespin.plugins.Extension;if(!collection){collection=bespin.plugins.metadata;}
var info=collection[pluginName];var provides=info.provides;if(!provides){return;}
if(!resolver){resolver=bespin.plugins.multiFileResolver;}
resolver=dojo.hitch(info,resolver);for(var i=0;i<provides.length;i++){var ep=provides[i];var name=ep[0];var meta=ep[1];var extList=extensionPoints[name];if(!extList){extList=extensionPoints[name]=[];}
var ext=new Extension(collection,pluginName,resolver,meta);extList.push(ext);bespin.publish("extension:loaded:"+name,ext);}},get:function(epName){return bespin.plugins.extensionPoints[epName]||[];},loadOne:function(epName,callback){var points=bespin.plugins.extensionPoints[epName];if(!points||!points[0]){return false;}
points[0].load(callback);return true;},getLoadedOne:function(epName){var points=bespin.plugins.extensionPoints[epName];if(!points||!points[0]){return undefined;}
return points[0].getIfLoaded();},remove:function(pluginName,collection){if(!collection){collection=bespin.plugins.metadata;}
var info=collection[pluginName];if(info){var oldmodule=bespin.plugins.loader.modules[info.location];}else{var oldmodule=undefined;}
bespin.plugins.unregisterExtensionPoints(pluginName);if(oldmodule&&oldmodule.deactivate){oldmodule.deactivate();}
delete collection[pluginName];if(collection==bespin.plugins.metadata){bespin.get("files").saveFile("BespinSettings",{name:"plugins.json",content:dojo.toJson(bespin.plugins.metadata)});}},_removeLink:function(node){bespin.get("commandLine").executeCommand('plugin remove "'+node.getAttribute("name")+'"');},installSingleFilePlugin:function(url){var oldmodule=bespin.plugins.loader.modules[url];bespin.plugins.loader.loadScript(url,{callback:function(module){if(!module.info){instruction.addError("Plugin module does not have info!");}
var name=module.info.name;if(!name){name=filename;}
bespin.plugins.unregisterExtensionPoints(name);if(oldmodule&&oldmodule.deactivate){oldmodule.deactivate();}
module.info.location=url;bespin.plugins.metadata[name]=module.info;bespin.plugins.registerExtensionPoints(name,bespin.plugins.metadata,bespin.plugins.sameFileResolver);if(module.activate){module.activate();}
bespin.get("files").saveFile("BespinSettings",{name:"plugins.json",content:dojo.toJson(bespin.plugins.metadata)});},force:true});},reloadByName:function(pluginName){var info=bespin.plugins.metadata[pluginName];if(!info||!info.location){return;}
bespin.plugins.installSingleFilePlugin(info.location);},_reloadLink:function(node){bespin.get("commandLine").executeCommand('plugin reload "'+node.getAttribute("name")+'"');},_computeModulesToReload:function(fullname,mod,toReload,pluginsToInit){toReload[fullname]=true;var used_by_plugins=mod._used_by_plugins;for(var plugin in used_by_plugins){pluginsToInit[plugin]=used_by_plugins[plugin];}
for(var modname in mod._depended_on_by){var othermod=bespin.plugins.loader.modules[modname];this._computeModulesToReload(modname,othermod,toReload,pluginsToInit);}}});bespin.plugins.commands=new bespin.command.Store(bespin.command.store,{name:"plugin",preview:"manage Bespin plugins",subcommanddefault:"help"});bespin.plugins.commands.addCommand({name:"install",takes:["name"],execute:function(instruction,name){var editSession=bespin.get('editSession');var filename=editSession.path;var project=editSession.project;var url="/getscript/file/at/"+project+"/"+filename;bespin.plugins.installSingleFilePlugin(url);instruction.addOutput("Plugin installed.");}});bespin.plugins.commands.addCommand({name:"list",execute:function(instruction){var output='<h2>Installed plugins:</h2>';output+='<table>';for(var name in bespin.plugins.metadata){output+='<tr><td>'+name+'</td><td><a onclick="bespin.plugins._removeLink(this)" name="'+name+'">Remove</a></td><td><a onclick="bespin.plugins._reloadLink(this)" name="'+name+'">Reload</a></td></tr>';}
output+="</table>";instruction.addOutput(output);}});bespin.plugins.commands.addCommand({name:"remove",takes:['name'],execute:function(instruction,name){name=name.substring(1,name.length-1);bespin.plugins.remove(name);instruction.addOutput("Plugin removed");}});bespin.plugins.commands.addCommand({name:"reload",takes:['name'],execute:function(instruction,name){name=name.substring(1,name.length-1);bespin.plugins.reloadByName(name);instruction.addOutput("Plugin reloaded");}});bespin.subscribe("bespin:editor:initialized",function(){bespin.get("files").loadContents("BespinSettings","plugins.json",function(info){var data=dojo.fromJson(info.content);bespin.plugins.metadata=data;for(var name in data){bespin.plugins.registerExtensionPoints(name);}});bespin.get("server").request("GET","/js/bespin/builtins.json",null,{evalJSON:true,onSuccess:function(data){bespin.plugins.builtins=data;for(var name in data){bespin.plugins.registerExtensionPoints(name,bespin.plugins.builtins,bespin.plugins.multiFileResolver);}
bespin.getComponent("commandLine",function(){});bespin.getComponent("popup",function(){});}});});bespin.subscribe("file:saved",function(e){var settings=bespin.get("settings");var fullname="/getscript/file/at/"+e.project+"/"+e.path;if(settings){var editbespin=settings.get("editbespin");if(editbespin==e.project){fullname="/getscript/"+e.path.substring(9);}}
var mod=bespin.plugins.loader.modules[fullname];if(!mod){return;}
var toReload={};var pluginsToInit={};bespin.plugins._computeModulesToReload(fullname,mod,toReload,pluginsToInit);for(var plugin in pluginsToInit){bespin.plugins.unregisterExtensionPoints(plugin,pluginsToInit[plugin]);}
for(var modname in toReload){delete bespin.plugins.loader.modules[modname];}
for(var plugin in pluginsToInit){bespin.plugins.registerExtensionPoints(plugin,pluginsToInit[plugin]);}});
dojo.provide("bespin.plugins.loader");dojo.mixin(bespin.plugins.loader,{modules:{},loadQueue:{},moduleLoaded:function(scriptName,moduleFactory){console.log(scriptName+" module has arrived");var isEmpty=bespin.util.isEmpty;var contents=moduleFactory.toString();var modules=bespin.plugins.loader.modules;var loadQueue=bespin.plugins.loader.loadQueue;var queueitem=loadQueue[scriptName];var resolver=queueitem.resolver;var force=queueitem.force;queueitem.moduleFactory=moduleFactory;var depRegExp=/require\s*\(('|")([\w\W]*?)('|")\)/mg;var deps=queueitem.deps={};var allDependencies=queueitem.dependsOn={};var match;while((match=depRegExp.exec(contents))!=null){var depScriptName=match[2];var adjustedName=resolver?resolver(depScriptName):depScriptName;allDependencies[adjustedName]=true;if(modules[adjustedName]!==undefined&&!force){continue;}
deps[adjustedName]=true;if(!loadQueue[adjustedName]){bespin.plugins.loader.loadScript(depScriptName,{resolver:resolver,force:force});}}
console.log("Module: ",scriptName," depends on ",deps);if(isEmpty(deps)){bespin.plugins.loader._loaded(scriptName,loadQueue,queueitem);}},_loaded:function(scriptName){var isEmpty=bespin.util.isEmpty;var modules=bespin.plugins.loader.modules;var loadQueue=bespin.plugins.loader.loadQueue;var queueitem=loadQueue[scriptName];var resolver=queueitem.resolver;delete loadQueue[scriptName];var module=queueitem.moduleFactory(function(modname){if(resolver){modname=resolver(modname);}
return bespin.plugins.loader.modules[modname];},{});module._name=scriptName;module._depends_on=queueitem.dependsOn;module._depended_on_by={};for(var modName in module._depends_on){modules[modName]._depended_on_by[scriptName]=true;}
modules[scriptName]=module;if(queueitem.callback){queueitem.callback(module);}
for(var otherScript in loadQueue){console.log("Checking ",otherScript," in loadQueue");var qi=loadQueue[otherScript];console.log("qi deps: ",qi.deps);if(qi.deps&&qi.deps[scriptName]){delete qi.deps[scriptName];if(isEmpty(qi.deps)){bespin.plugins.loader._loaded(otherScript);}}}},loadScript:function(scriptName,opts){opts=opts||{};var loadQueue=bespin.plugins.loader.loadQueue;if(opts.resolver){scriptName=opts.resolver(scriptName);}
if(loadQueue[scriptName]&&!opts.force&&!opts.reload){return;}
console.log("Queued "+scriptName+" for load");setTimeout(function(){if(loadQueue[scriptName]){console.error("Unable to load before timeout: "+scriptName);}},2000);loadQueue[scriptName]={factory:null,name:scriptName,callback:opts.callback,resolver:opts.resolver,force:opts.force};bespin.plugins.loader._addScriptTag(scriptName);},_addScriptTag:function(fullName){var s=document.createElement("script");var cachebreaker=new Date().getTime();s.setAttribute("src",fullName+"?"+cachebreaker);document.getElementsByTagName("head")[0].appendChild(s);}});
dojo.provide("bespin.plugins.loaderTest");dojo.require("bespin.test");bespin.test.addTests("loader",{setup:function(){this.oldAddScriptTag=bespin.plugins.loader._addScriptTag;bespin.plugins.loader._addScriptTag=this._addScriptTag;},tearDown:function(){console.log("teardown was called");bespin.plugins.loader._addScriptTag=this._addScriptTag;},setupTest:function(){this.scriptsLoaded=[];this.reset();},_addScriptTag:function(){console.log("Script tag WOULD HAVE been added if this were not a test");},reset:function(){console.log("reset called");bespin.plugins.loader.modules=[];bespin.plugins.loader.loadQueue=[];},resolver:function(name){if(name.charAt(0)!="/"){name="/js/"+name;}
if(!bespin.util.endsWith(name,"\\.js")){name=name+".js";}
name="/getscript"+name;return name;},testQueueUpAModule:function(test){bespin.plugins.loader.loadScript("bespin/nonModule",{resolver:this.resolver});var lq=bespin.plugins.loader.loadQueue;test.isNotUndefined(lq["/getscript/js/bespin/nonModule.js"],"Expected to find module in load queue");},testModuleWithNoDeps:function(test){var lq=bespin.plugins.loader.loadQueue;loadCheck={didLoad:false};var modName="/getscript/js/bespin/nonModule.js";lq[modName]={resolver:this.resolver};bespin.plugins.loader.moduleLoaded(modName,function(require,exports){loadCheck.didLoad=true;exports.secretValue=27;return exports;});test.isTrue(loadCheck.didLoad);test.isUndefined(lq[modName],"Module should be gone from the queue");test.isNotUndefined(bespin.plugins.loader.modules[modName],"Was module object saved?");var nonModule=bespin.plugins.loader.modules[modName];test.isEqual(27,nonModule.secretValue);},testModuleWithSingleDep:function(test){var lq=bespin.plugins.loader.loadQueue;loadCheck={didLoad:false,otherDidLoad:false};var modName="/getscript/js/bespin/nonModule.js";var depModName="/getscript/js/bespin/depModule.js";bespin.plugins.loader.loadScript("bespin/nonModule",{resolver:this.resolver});bespin.plugins.loader.moduleLoaded(modName,function(require,exports){var othermod=require("bespin/depModule");loadCheck.didLoad=true;exports.secretValue=othermod.secretValue;return exports;});test.isFalse(loadCheck.didLoad);test.isNotUndefined(lq[modName],"main module should be in the queue");test.isNotUndefined(lq[depModName],"dependent module should be in queue");test.isNotUndefined(lq[depModName].resolver);bespin.plugins.loader.moduleLoaded(depModName,function(require,exports){loadCheck.otherDidLoad=true;exports.secretValue=192;return exports;});test.isTrue(loadCheck.didLoad,"Main module should load");test.isTrue(loadCheck.otherDidLoad,"Module it depended on should load");console.dir(bespin.plugins.loader.modules);var mod=bespin.plugins.loader.modules[modName];test.isNotUndefined(mod,"The main module should be requireable");test.isEqual(192,mod.secretValue,"secret value should have been set");test.isEqual(modName,mod._name);var expectedDependencies={};expectedDependencies[depModName]=true;test.isEqual(mod._depends_on,expectedDependencies);var depMod=bespin.plugins.loader.modules[depModName];test.isEqual(depModName,depMod._name);var expectedDependedOnBy={};expectedDependedOnBy[modName]=true;test.isEqual(depMod._depended_on_by,expectedDependedOnBy);},testModuleLoadOrderShouldNotMatter:function(test){var loader=bespin.plugins.loader;var lq=loader.loadQueue;var loadCheck={};loader.loadScript("A",{resolver:this.resolver});loader.moduleLoaded("/getscript/js/A.js",function(require,exports){loadCheck.A=true;var B=require("B");var C=require("C");return exports;});test.isUndefined(loadCheck.A,"A should not have been loaded yet");test.isNotUndefined(lq["/getscript/js/B.js"],"B should be queued up");test.isNotUndefined(lq["/getscript/js/C.js"],"C should be queued up");loader.moduleLoaded("/getscript/js/B.js",function(require,exports){loadCheck.B=true;var D=require("D");return exports;});test.isUndefined(loadCheck.A,"A should not have been loaded");test.isUndefined(loadCheck.B,"B should not have been loaded");loader.moduleLoaded("/getscript/js/D.js",function(require,exports){loadCheck.D=true;return exports;});test.isTrue(loadCheck.D,"D should *now* have been loaded");test.isTrue(loadCheck.B,"B should *now* have been loaded");test.isUndefined(loadCheck.A,"A should not have been loaded");loader.moduleLoaded("/getscript/js/C.js",function(require,exports){loadCheck.C=true;var D=require("D");return exports;});test.isTrue(loadCheck.C,"C should *now* have been loaded");test.isTrue(loadCheck.A,"A should *now* have been loaded");},testDependenciesAreForceReloadedToo:function(test){var loader=bespin.plugins.loader;var lq=loader.loadQueue;var loadCheck={};loader.loadScript("A",{resolver:this.resolver});var Afactory=function(require,exports){loadCheck.A=true;var B=require("B");return exports;};loader.moduleLoaded("/getscript/js/A.js",Afactory);test.isUndefined(loadCheck.A,"A should not have been loaded yet");test.isNotUndefined(lq["/getscript/js/B.js"],"B should be queued up");var Bfactory=function(require,exports){loadCheck.B=true;return exports;};loader.moduleLoaded("/getscript/js/B.js",Bfactory);test.isNotUndefined(loadCheck.A,"A should be loaded");test.isNotUndefined(loadCheck.B,"B should be loaded");delete loadCheck.A;delete loadCheck.B;loader.loadScript("A",{resolver:this.resolver,force:true});loader.moduleLoaded("/getscript/js/A.js",Afactory);test.isUndefined(loadCheck.A,"A should not have been reloaded yet");test.isNotUndefined(lq["/getscript/js/B.js"],"B should be queued up");}});
dojo.provide("bespin.preview");bespin.command.store.addCommand({name:'preview',takes:['filename'],preview:'view the file in a new browser window',completeText:'add the filename to view or use the current file',execute:function(instruction,filename){bespin.preview.show(filename);}});bespin.preview.show=function(filename,project,type){var editSession=bespin.get('editSession');var settings=bespin.get("settings");var filename=filename||editSession.path;var project=project||editSession.project;var type=type||settings.get("preview");var url=bespin.util.path.combine("preview/at",project,filename);if(!settings||!filename){return;}
bespin.get("editor").saveFile(null,filename);if(type=="inline"){var preview=dojo.byId("preview");var subheader=dojo.byId("subheader");var editor=dojo.byId("editor");if(dojo.style(preview,"display")=="none"){dojo.style(editor,"display","none");dojo.style(subheader,"display","none");dojo.style(preview,"display","block");var inlineIframe=dojo.create("iframe",{frameBorder:0,src:url,style:"border:0; width:100%; height:100%; background-color: white; display:block"},preview);var esc=dojo.connect(document,"onkeypress",function(e){var key=e.keyCode||e.charCode;if(key==bespin.util.keys.Key.ESCAPE){preview.removeChild(inlineIframe);dojo.style(preview,"display","none");dojo.style(subheader,"display","block");dojo.style(editor,"display","block");dojo.disconnect(esc);}});}
return;}
if(type=="iphone"){var centerpopup=dojo.byId("centerpopup");if(dojo.byId("iphoneIframe")==null){var iphoneIframe=dojo.create("iframe",{id:"iphoneIframe",frameBorder:0,src:url,style:"border:0; width:320px; height:460px; background-color: white; display:block"},centerpopup);bespin.util.webpieces.showCenterPopup(centerpopup);var esc=dojo.connect(document,"onkeypress",function(e){var key=e.keyCode||e.charCode;if(key==bespin.util.keys.Key.ESCAPE){centerpopup.removeChild(iphoneIframe);bespin.util.webpieces.hideCenterPopup(centerpopup);dojo.disconnect(esc);}});}
return;}
window.open(url);};
dojo.provide("bespin.wizard");dojo.mixin(bespin.wizard,{_wizards:{newuser:{url:"/overlays/newuser.html"},overview:{url:"/overlays/overview.html"}},show:function(instruction,type,warnOnFail){var wizard=this._wizards[type];if(!wizard&&instruction){instruction.addErrorOutput("Unknown wizard: "+type);return;}
var warn=function(xhr){if(instruction){instruction.addErrorOutput("Failed to display wizard: "+xhr.responseText);}};var localOnFailure=warnOnFail?warn:null;var localOnSuccess=function(data){bespin.wizard._onSuccess(data,wizard);};bespin.get('server').fetchResource(wizard.url,localOnSuccess,localOnFailure);},onClose:function(){bespin.util.webpieces.hideCenterPopup(this.element);},onJump:function(url,close){window.open(url);if(close)this.onClose();},onWizard:function(type){this.show(type);this.onClose();},_onSuccess:function(data,wizard){this.element=dojo.byId('centerpopup');this.element.innerHTML=data;dojo.query("#centerpopup script").forEach(function(node){dojo.eval(node.innerHTML);});bespin.util.webpieces.showCenterPopup(this.element,true);if(typeof wizard.onLoad=="function"){wizard.onLoad();}}});bespin.command.store.addCommand({name:'wizard',takes:['type'],hidden:true,preview:'display a named wizard to step through some process',completeText:'The name of the wizard to run. Leave blank to list known wizards',usage:"[type] ...<br><br><em>[type] The name of the user to run (or blank to list wizards)</em>",execute:function(instruction,type){if(!type){var list="";for(var name in bespin.wizard._wizards){if(bespin.wizard._wizards.hasOwnProperty(name)){list+=", "+name;}}
instruction.addOutput("Known wizards: "+list.substring(2));return;}
bespin.wizard.show(instruction,type,true);}});bespin.command.store.addCommand({name:'welcome',preview:'display welcome + help',execute:function(){bespin.get('commandLine').executeCommand("wizard newuser");}});
dojo.provide("bespin.wizardTest");dojo.require("bespin.wizard");dojo.require("bespin.test");bespin.test.addTests("wizard",{testWizard:function(test){test.command("wizard","Known wizards: newuser, overview");}});
dojo.provide("bespin.social");bespin.social.displayArray=function(instruction,titleNone,titleSome,array){if(!array||array.length===0){instruction.addOutput(titleNone);return;}
var message=titleSome;message+="<ul><li>"+array.join("</li><li>")+"</li></ul>";instruction.addOutput(message);};bespin.social.toArgArray=function(args){if(args==null){return[];}
else{var spliten=args.split(" ");if(spliten.length==1&&spliten[0]==""){return[];}
else{return spliten;}}};bespin.command.store.addCommand({name:'follow',takes:['username ...'],preview:'add to the list of users we are following, or (with no args) list the current set',completeText:'username(s) of person(s) to follow',usage:"[username] ...<br><br><em>(username optional. Will list current followed users if not provided)</em>",execute:function(instruction,args){var usernames=bespin.social.toArgArray(args);if(usernames.length===0){bespin.get('server').follow([],{evalJSON:true,onSuccess:function(followers){if(!followers||followers.length===0){instruction.addOutput("You are not following anyone");return;}
var parent=bespin.social.displayFollowers(followers);instruction.setElement(parent);},onFailure:function(xhr){instruction.addErrorOutput("Failed to retrieve followers: "+xhr.responseText);}});}
else{bespin.get('server').follow(usernames,{evalJSON:true,onSuccess:function(followers){if(!followers||followers.length===0){instruction.addOutput("You are not following anyone");return;}
bespin.publish("project:created");var parent=bespin.social.displayFollowers(followers);instruction.setElement(parent);},onFailure:function(xhr){instruction.addErrorOutput("Failed to add follower: "+xhr.responseText);}});}}});dojo.extend(bespin.client.Server,{follow:function(usernames,opts){this.request('POST','/network/follow/',dojo.toJson(usernames),opts);},followers:function(opts){this.request('GET','/network/followers/',null,opts);}});bespin.social.displayFollowers=function(followers){var parent=dojo.create("div",{});dojo.create("div",{innerHTML:"You are following these users:"},parent);var table=dojo.create("table",{},parent);followers.forEach(function(follower){var row=dojo.create("tr",{},table);var cell=dojo.create("td",{},row);dojo.create("img",{src:"/images/collab_icn_user.png",width:16,height:16},cell);dojo.create("td",{innerHTML:follower},row);cell=dojo.create("td",{},row);dojo.create("a",{innerHTML:"<small>(unfollow)</small>",onclick:function(){bespin.get("commandLine").executeCommand("unfollow "+follower);}},cell);});return parent;};bespin.command.store.addCommand({name:'unfollow',takes:['username ...'],preview:'remove from the list of users we are following',completeText:'username(s) of person(s) to stop following',usage:"[username] ...<br><br><em>The username(s) to stop following</em>",execute:function(instruction,args){var usernames=bespin.social.toArgArray(args);if(usernames.length===0){instruction.addErrorOutput('Please specify the users to cease following');}
else{bespin.get('server').unfollow(usernames,{evalJSON:true,onSuccess:function(followers){if(!followers||followers.length===0){instruction.addOutput("You are not following anyone");return;}
bespin.publish("project:created");var parent=bespin.social.displayFollowers(followers);instruction.setElement(parent);},onFailure:function(xhr){instruction.addErrorOutput("Failed to remove follower: "+xhr.responseText);}});}}});dojo.extend(bespin.client.Server,{unfollow:function(users,opts){this.request('POST','/network/unfollow/',dojo.toJson(users),opts);}});if(!bespin.social.group){bespin.social.group={};}
bespin.social.group.commands=new bespin.command.Store(bespin.command.store,{name:'group',preview:'Collect the people you follow into groups, and display the existing groups',completeText:'subcommands: add, remove, list, help',subcommanddefault:'help'});bespin.social.group.commands.addCommand({name:'help',takes:['search'],preview:'show subcommands for group command',description:'The <u>help</u> gives you access to the various subcommands in the group command space.<br/><br/>You can narrow the search of a command by adding an optional search params.<br/><br/>Finally, pass in the full name of a command and you can get the full description, which you just did to see this!',completeText:'optionally, narrow down the search',execute:function(instruction,extra){var output=this.parent.getHelp(extra);instruction.addOutput(output);}});bespin.social.group.commands.addCommand({name:'list',preview:'List the current group and group members',takes:['group'],completeText:'An optional group name or leave blank to list groups',description:'List the current group and group members.',execute:function(instruction,group){if(!group){bespin.get('server').groupListAll({evalJSON:true,onSuccess:function(groups){if(!groups||groups.length===0){instruction.addOutput("You have no groups");return;}
var parent=dojo.create("div",{});dojo.create("div",{innerHTML:"You have the following groups:"},parent);var table=dojo.create("table",{},parent);groups.forEach(function(group){var row=dojo.create("tr",{},table);var cell=dojo.create("td",{},row);dojo.create("img",{src:"/images/collab_icn_group.png",width:16,height:16},cell);dojo.create("td",{innerHTML:group},row);cell=dojo.create("td",{},row);dojo.create("a",{innerHTML:"<small>(remove)</small>",onclick:function(){instruction.commandLine.executeCommand("group remove "+group);}},cell);dojo.create("span",{innerHTML:" "},cell);dojo.create("a",{innerHTML:"<small>(list)</small>",onclick:function(){instruction.commandLine.executeCommand("group list "+group);}},cell);});instruction.setElement(parent);},onFailure:function(xhr){instruction.addErrorOutput("Failed to retrieve groups: "+xhr.responseText);}});}else{bespin.get('server').groupList(group,{evalJSON:true,onSuccess:function(members){if(!members||members.length===0){instruction.addOutput(group+" has no members.");return;}
var parent=dojo.create("div",{});dojo.create("div",{innerHTML:"Members of "+group+":"},parent);var table=dojo.create("table",{},parent);members.forEach(function(member){var row=dojo.create("tr",{},table);var cell=dojo.create("td",{},row);dojo.create("img",{src:"/images/collab_icn_user.png",width:16,height:16},cell);dojo.create("td",{innerHTML:member},row);cell=dojo.create("td",{},row);dojo.create("a",{innerHTML:"<small>(ungroup)</small>",onclick:function(){instruction.commandLine.executeCommand("group remove "+group+" "+member);}},cell);});instruction.setElement(parent);},onFailure:function(xhr){instruction.addErrorOutput("Failed to retrieve group members: "+xhr.responseText);}});}}});bespin.social.group.commands.addCommand({name:'add',preview:'Add members to a new or existing group',takes:['group','member ...'],completeText:'A group name followed by a list of members to add',description:'Add members to a new or existing group',execute:function(instruction,args){var group=args.pieces.shift();var members=args.pieces;bespin.get('server').groupAdd(group,members,{onSuccess:function(data){instruction.addOutput("Added to group '"+group+"': "+members.join(", "));},onFailure:function(xhr){instruction.addErrorOutput("Failed to add to group members. Maybe due to: "+xhr.responseText);}});}});bespin.social.group.commands.addCommand({name:'remove',preview:'Remove members from an existing group (and remove group if empty)',takes:['group','member ...'],completeText:'A group name followed by a list of members to remove',description:'Remove members from an existing group (and remove group if empty)',execute:function(instruction,args){var group=args.pieces.shift();var members=args.pieces;if(members.length===1&&members[0]==="all"){bespin.get('server').groupRemoveAll(group,{onSuccess:function(data){instruction.addOutput("Removed group "+group);},onFailure:function(xhr){instruction.addErrorOutput("Failed to retrieve group members. Maybe due to: "+xhr.responseText);}});}else{bespin.get('server').groupRemove(group,members,{onSuccess:function(data){instruction.addOutput("Removed from group '"+group+"': "+members.join(", "));},onFailure:function(xhr){instruction.addErrorOutput("Failed to remove to group members. Maybe due to: "+xhr.responseText);}});}}});dojo.extend(bespin.client.Server,{groupListAll:function(opts){this.request('GET','/group/list/all/',null,opts);},groupList:function(group,opts){this.request('GET','/group/list/'+group+'/',null,opts);},groupRemove:function(group,users,opts){this.request('POST','/group/remove/'+group+'/',dojo.toJson(users),opts);},groupRemoveAll:function(group,opts){this.request('POST','/group/remove/all/'+group+'/',null,opts);},groupAdd:function(group,users,opts){this.request('POST','/group/add/'+group+'/',dojo.toJson(users),opts);}});bespin.social.share={commands:new bespin.command.Store(bespin.command.store,{name:'share',preview:'Manage the projects that you share to other users',completeText:'subcommands: add, remove, list, help',subcommanddefault:'help'})};bespin.social.share.commands.addCommand({name:'help',takes:['search'],preview:'show subcommands for share command',description:'The <u>help</u> gives you access to the various subcommands in the share command space.<br/><br/>You can narrow the search of a command by adding an optional search params.<br/><br/>Finally, pass in the full name of a command and you can get the full description, which you just did to see this!',completeText:'optionally, narrow down the search',execute:function(instruction,extra){var output=this.parent.getHelp(extra);instruction.addOutput(output);}});bespin.social.share.commands.addCommand({name:'list',preview:'List the current shared projects',description:'List the current shared projects.',takes:['project'],completeText:'An optional project name or leave blank to list shared projects',execute:function(instruction,args){var self=this;bespin.get('server').shareListAll({evalJSON:true,onSuccess:function(shares){if(args.project&&args.project!=""){shares=shares.filter(function(share){return share.project==project;});}
instruction.setElement(self.createShareDisplayElement(shares));},onFailure:function(xhr){instruction.addErrorOutput("Failed to list project shares: "+xhr.responseText);}});},createShareDisplayElement:function(shares){if(shares.length===0){return dojo.create("div",{innerHTML:"You are not sharing any projects"});}
var parent=dojo.create("div",{});dojo.create("div",{innerHTML:"You have the following shared projects:"},parent);var table=dojo.create("table",{},parent);var lastProject="";shares.forEach(function(share){var row=dojo.create("tr",{},table);if(share.project!==lastProject){var cell=dojo.create("th",{},row);dojo.create("img",{src:"/images/collab_icn_project.png",width:16,height:16},cell);dojo.create("th",{innerHTML:share.project},row);}else{dojo.create("th",{},row);dojo.create("th",{},row);}
var withWhom;if(share.type=="everyone"){withWhom="with everyone";}
else if(share.type=="group"){withWhom="with the group "+share.recipient;}
else{withWhom="with "+share.recipient;}
cell=dojo.create("td",{innerHTML:withWhom},row);var edit=share.edit?"Editable":"Read-only";cell=dojo.create("td",{innerHTML:edit},row);cell=dojo.create("td",{},row);dojo.create("a",{innerHTML:"<small>(unshare)</small>",onclick:function(){bespin.get("commandLine").executeCommand("share remove "+share.project);}},cell);});return parent;}});bespin.social.share.commands.addCommand({name:'remove',preview:'Remove a share from the current shared projects',description:'Remove a share from the current shared projects.',takes:['project','member'],completeText:'A project name and a optional user or group (or leave blank for all users and groups)',execute:function(instruction,args){if(!args.project||args.project==""){instruction.addErrorOutput('Missing project.<br/>Syntax: share remove project [{user}|{group}|everyone]');}
if(!args.member||args.member==""){bespin.get('server').shareRemoveAll(args.project,{onSuccess:function(data){instruction.addOutput("All sharing removed from "+args.project);},onFailure:function(xhr){instruction.addErrorOutput("Failed to remove sharing permissions. Maybe due to: "+xhr.responseText);}});}else{bespin.get('server').shareRemove(args.project,args.member,{onSuccess:function(data){instruction.addOutput("Removed sharing permission from "+args.member+" to "+args.project);},onFailure:function(xhr){instruction.addErrorOutput("Failed to remove sharing permission. Maybe due to: "+xhr.responseText);}});}}});bespin.social.share.commands.addCommand({name:'add',preview:'Add a share to the current shared projects',description:'Add a share to the current shared projects.',takes:['project','member','permission'],completeText:'A project name or leave blank to list shared projects',execute:function(instruction,args){if(!args.project||args.project==""){instruction.addErrorOutput('Missing project.<br/>Syntax: share add project {user}|{group}|everyone [edit]');}
if(!args.member||args.member==""){instruction.addErrorOutput('Missing user/group.<br/>Syntax: share add project {user}|{group}|everyone [edit]');}
bespin.get('server').shareAdd(args.project,args.member,args.permission||"",{onSuccess:function(data){instruction.addOutput("Adding sharing permission for "+args.member+" to "+args.project);},onFailure:function(xhr){instruction.addErrorOutput("Failed to add sharing permission. Maybe due to: "+xhr.responseText);}});}});dojo.extend(bespin.client.Server,{shareListAll:function(opts){this.request('GET','/share/list/all/',null,opts);},shareListProject:function(project,opts){this.request('GET','/share/list/'+project+'/',null,opts);},shareListProjectMember:function(project,member,opts){this.request('GET','/share/list/'+project+'/'+member+'/',null,opts);},shareRemoveAll:function(project,opts){this.request('POST','/share/remove/'+project+'/all/',null,opts);},shareRemove:function(project,member,opts){this.request('POST','/share/remove/'+project+'/'+member+'/',null,opts);},shareAdd:function(project,member,options,opts){this.request('POST','/share/add/'+project+'/'+member+'/',dojo.toJson(options),opts);}});
dojo.provide("bespin.socialTest");dojo.require("bespin.social");dojo.require("bespin.test");bespin.test.addTests("social",{setup:function(){this.server=bespin.get("server");this.originalServerFollowers=this.server.followers;this.originalServerUnfollow=this.server.unfollow;this.originalServerGroupListAll=this.server.groupListAll;},testFollow:function(test){this.server.followers=function(opts){opts.onSuccess("[ ]");};test.command("follow","You are not following anyone");this.server.followers=function(opts){opts.onSuccess("[ 'joe', 'fred' ]");};test.command("follow",["You are following these users","joe","fred","unfollow"]);this.server.followers=function(opts){opts.onFailure({responseText:"ERR"});};test.command("follow","Failed to retrieve followers: ERR");},testGroupHelp:function(test){test.command("group help",["Available Commands","add","help","list","remove"]);},testGroupList:function(test){this.server.groupListAll=function(opts){opts.onSuccess(['homies']);};test.command("group list",["You have the following groups","homies","remove"]);this.server.groupListAll=function(opts){opts.onFailure({responseText:"ERR"});};test.command("follow","Failed to retrieve groups: ERR");},testUnfollow:function(test){this.server.unfollow=function(usernames,opts){opts.onSuccess("[ ]");};test.command("unfollow fred","You are not following anyone");},tearDown:function(){this.server.followers=this.originalServerFollowers;this.server.unfollow=this.originalServerUnfollow;this.server.groupListAll=this.originalServerGroupListAll;}});
dojo.provide("bespin.mobwrite.core");var mobwrite={};mobwrite.syncGateway='/mobwrite/';mobwrite.get_maxchars=1000;mobwrite.debug=false;if(!('console'in window)||!('info'in window.console)||!('warn'in window.console)||!('error'in window.console)){mobwrite.debug=false;}
mobwrite.sniffUserAgent=function(){if(window.opera){mobwrite.UA_opera=true;}else{var UA=navigator.userAgent.toLowerCase();mobwrite.UA_webkit=UA.indexOf('webkit')!=-1;if(!mobwrite.UA_webkit){mobwrite.UA_gecko=UA.indexOf('gecko')!=-1;if(!mobwrite.UA_gecko){mobwrite.UA_msie=UA.indexOf('msie')!=-1;}}}};mobwrite.UA_gecko=false;mobwrite.UA_opera=false;mobwrite.UA_msie=false;mobwrite.UA_webkit=false;mobwrite.sniffUserAgent();mobwrite.syncRunPid_=null;mobwrite.syncKillPid_=null;mobwrite.timeoutInterval=30000;mobwrite.minSyncInterval=500;mobwrite.maxSyncInterval=10000;mobwrite.syncInterval=2000;mobwrite.idPrefix='';mobwrite.nullifyAll=false;mobwrite.clientChange_=false;mobwrite.serverChange_=false;mobwrite.syncAjaxObj_=null;mobwrite.uniqueId=function(){var soup='abcdefghijklmnopqrstuvwxyz';var id=soup.charAt(Math.random()*soup.length);soup+='0123456789-_.';for(var x=1;x<12;x++){id+=soup.charAt(Math.random()*soup.length);}
if(id.indexOf('--')!=-1){id=mobwrite.uniqueId();}
return id;};mobwrite.syncUsername=mobwrite.uniqueId();mobwrite.shared={};mobwrite.shareHandlers=[];mobwrite.shareObj=function(id){if(id){this.file=id;this.dmp=new diff_match_patch();this.dmp.Diff_Timeout=0.5;this.editStack=[];if(mobwrite.debug){window.console.info('Creating shareObj: "'+id+'"');}}};mobwrite.shareObj.prototype.shadowText='';mobwrite.shareObj.prototype.clientVersion=0;mobwrite.shareObj.prototype.serverVersion=0;mobwrite.shareObj.prototype.deltaOk=false;mobwrite.shareObj.prototype.mergeChanges=true;mobwrite.shareObj.prototype.getClientText=function(){window.alert('Defined by subclass');return'';};mobwrite.shareObj.prototype.setClientText=function(text){window.alert('Defined by subclass');};mobwrite.shareObj.prototype.patchClientText=function(patches){var oldClientText=this.getClientText();var result=this.dmp.patch_apply(patches,oldClientText);if(oldClientText!=result[0]){this.setClientText(result[0]);}};mobwrite.shareObj.prototype.onSentDiff=function(diffs){};mobwrite.shareObj.prototype.fireChange=function(target){if('createEvent'in document){var e=document.createEvent('HTMLEvents');e.initEvent('change',false,false);target.dispatchEvent(e);}else if('fireEvent'in target){target.fireEvent('onchange');}};mobwrite.shareObj.prototype.nullify=function(){mobwrite.unshare(this.file);return'N:'+encodeURI(mobwrite.idPrefix+this.file)+'\n';};mobwrite.shareObj.prototype.syncText=function(){var clientText=this.getClientText(!this.deltaOk);if(this.deltaOk){var diffs=this.dmp.diff_main(this.shadowText,clientText,true);if(diffs.length>2){this.dmp.diff_cleanupSemantic(diffs);this.dmp.diff_cleanupEfficiency(diffs);}
var changed=diffs.length!=1||diffs[0][0]!=DIFF_EQUAL;if(changed){mobwrite.clientChange_=true;this.shadowText=clientText;}
if(changed||!this.editStack.length){var action=(this.mergeChanges?'d:':'D:')+this.clientVersion+':'+this.dmp.diff_toDelta(diffs);this.editStack.push([this.clientVersion,action]);this.clientVersion++;this.onSentDiff(diffs);}}else{if(this.shadowText!=clientText){this.shadowText=clientText;}
this.clientVersion++;var action='r:'+this.clientVersion+':'+
encodeURI(clientText).replace(/%20/g,' ');this.editStack.push([this.clientVersion,action]);}
var data='F:'+this.serverVersion+':'+
encodeURI(mobwrite.idPrefix+this.file)+'\n';for(var x=0;x<this.editStack.length;x++){data+=this.editStack[x][1]+'\n';}
return data.replace(/\x00/g,'%00');};mobwrite.syncRun1_=function(unloading){mobwrite.clientChange_=false;var data=[];data[0]='u:'+mobwrite.syncUsername+'\n';var empty=true;for(var x in mobwrite.shared){if(mobwrite.shared.hasOwnProperty(x)){if(mobwrite.nullifyAll){data.push(mobwrite.shared[x].nullify());}else{data.push(mobwrite.shared[x].syncText());}
if(mobwrite.shared[x].getMetaData){data.push('m:'+mobwrite.shared[x].getMetaData()+'\n');}
empty=false;}}
if(unloading===true){data.push('x:all\n');}
if(empty){if(mobwrite.debug){window.console.info('MobWrite task stopped.');}
return;}
if(data.length==1){if(mobwrite.debug){window.console.info('All objects silent; null sync.');}
mobwrite.syncRun2_('\n\n');return;}
var remote=(mobwrite.syncGateway.indexOf('://')!=-1);if(mobwrite.debug){window.console.info('TO server:\n'+data.join(''));}
data.push('\n');data=data.join('');mobwrite.syncKillPid_=window.setTimeout(mobwrite.syncKill_,mobwrite.timeoutInterval);if(remote){var blocks=mobwrite.splitBlocks_(data);var head=document.getElementsByTagName('head')[0];for(var x=0;x<blocks.length;x++){var script=document.getElementById('mobwrite_sync'+x);if(script){script.parentNode.removeChild(script);if(!mobwrite.UA_msie){for(var prop in script){delete script[prop];}
script=null;}}
if(!script){script=document.createElement('script');script.type='text/javascript';script.charset='utf-8';script.id='mobwrite_sync'+x;}
script.src=blocks[x];head.appendChild(script);}}else{data='q='+encodeURIComponent(data);mobwrite.syncAjaxObj_=mobwrite.syncLoadAjax_(mobwrite.syncGateway,data,mobwrite.syncCheckAjax_);}};mobwrite.splitBlocks_=function(data,opt_minBlocks){var encData=encodeURIComponent(data);var prefix=mobwrite.syncGateway+'?p=';var maxchars=mobwrite.get_maxchars-prefix.length;var encPlusData=encData.replace(/%20/g,'+');if(encPlusData.length<=maxchars){return[prefix+encPlusData];}
var digits=1;if(typeof opt_minBlocks!='undefined'){digits=String(opt_minBlocks).length;}
var blocks=[];var encEncData=encodeURIComponent(encData);var id=mobwrite.uniqueId();var paddingSize=(prefix+'b%3A'+id+'+++'+'%0A%0A').length+
2*digits;var blockLength=mobwrite.get_maxchars-paddingSize;if(blockLength<3){if(mobwrite.debug){window.console.error('mobwrite.get_maxchars too small to send data.');}
blockLength=3;}
var bufferBlocks=Math.ceil(encEncData.length/blockLength);if(typeof opt_minBlocks!='undefined'){bufferBlocks=Math.max(bufferBlocks,opt_minBlocks);}
var bufferHeader='b%3A'+id+'+'+
encodeURIComponent(bufferBlocks)+'+';var startPointer=0;for(var x=1;x<=bufferBlocks;x++){var endPointer=startPointer+blockLength;if(encEncData.charAt(endPointer-1)=='%'){endPointer-=1;}else if(encEncData.charAt(endPointer-2)=='%'){endPointer-=2;}
var bufferData=encEncData.substring(startPointer,endPointer);blocks.push(prefix+bufferHeader+x+'+'+bufferData+'%0A%0A');startPointer=endPointer;}
if(startPointer<encEncData.length){if(mobwrite.debug){window.console.debug('Recursing splitBlocks_ at n='+(bufferBlocks+1));}
return this.splitBlocks_(data,bufferBlocks+1);}
return blocks;};mobwrite.callback=function(text){if(text){mobwrite.syncRun2_(text+'\n');}else{window.clearTimeout(mobwrite.syncKillPid_);mobwrite.syncKillPid_=window.setTimeout(mobwrite.syncKill_,mobwrite.timeoutInterval);}};mobwrite.syncRun2_=function(text){mobwrite.serverChange_=false;if(mobwrite.debug){window.console.info('FROM server:\n'+text);}
text=text.replace(/%00/g,'\0');if(text.length<2||text.substring(text.length-2)!='\n\n'){text='';if(mobwrite.error){window.console.info('Truncated data.  Abort.');}}
var lines=text.split('\n');var file=null;var clientVersion=null;var readonly=[];for(var i=0;i<lines.length;i++){var line=lines[i];if(!line){break;}
if(line.charAt(1)!=':'){if(mobwrite.debug){window.console.error('Unparsable line: '+line);}
continue;}
var name=line.charAt(0);var value=line.substring(2);var version;if('FfDdRr'.indexOf(name)!=-1){var div=value.indexOf(':');if(div<1){if(mobwrite.debug){window.console.error('No version number: '+line);}
continue;}
version=parseInt(value.substring(0,div),10);if(isNaN(version)){if(mobwrite.debug){window.console.error('NaN version number: '+line);}
continue;}
value=value.substring(div+1);}
if(name=='E'){var colonpos=value.indexOf(':');if(colonpos){var filename=value.substring(0,colonpos);var message=value.substring(colonpos+1);console.error("Collab fail for ",filename,message);var handle=function(filename,message){if(mobwrite.shared.hasOwnProperty(filename)){readonly.push(filename);if(mobwrite.shared[filename].raiseError){mobwrite.shared[filename].raiseError(message,false);}}};if(filename=="all"){for(filename in mobwrite.shared){handle(filename,message);}}else{handle(filename,message);}}}
if(name=='O'){console.error("Read only for ",value);readonly.push(value);}
if(name=='F'||name=='f'){if(value.substring(0,mobwrite.idPrefix.length)==mobwrite.idPrefix){value=value.substring(mobwrite.idPrefix.length);}else{file=null;if(mobwrite.debug){window.console.error('File does not have "'+mobwrite.idPrefix+'" prefix: '+value);}
continue;}
if(mobwrite.shared.hasOwnProperty(value)){file=mobwrite.shared[value];file.deltaOk=true;clientVersion=version;for(var x=0;x<file.editStack.length;x++){if(file.editStack[x][0]<=clientVersion){file.editStack.splice(x,1);x--;}}}else{file=null;if(mobwrite.debug){window.console.error('Unknown file: '+value);}}}else if(name=='R'||name=='r'){if(file){file.shadowText=decodeURI(value);file.clientVersion=clientVersion;file.serverVersion=version;file.editStack=[];if(name=='R'){file.setClientText(file.shadowText);}
mobwrite.serverChange_=true;}}else if(name=='D'||name=='d'){if(file){if(clientVersion!=file.clientVersion){file.deltaOk=false;if(mobwrite.debug){window.console.error('Client version number mismatch.\n'+'Expected: '+file.clientVersion+' Got: '+clientVersion);}}else if(version>file.serverVersion){file.deltaOk=false;if(mobwrite.debug){window.console.error('Server version in future.\n'+'Expected: '+file.serverVersion+' Got: '+version);}}else if(version<file.serverVersion){if(mobwrite.debug){window.console.warn('Server version in past.\n'+'Expected: '+file.serverVersion+' Got: '+version);}}else{var diffs;try{diffs=file.dmp.diff_fromDelta(file.shadowText,value);file.serverVersion++;}catch(ex){diffs=null;file.deltaOk=false;mobwrite.syncInterval=0;if(mobwrite.debug){window.console.error('Delta mismatch.\n'+encodeURI(file.shadowText));}}
if(diffs&&(diffs.length!=1||diffs[0][0]!=DIFF_EQUAL)){if(name=='D'){file.shadowText=file.dmp.diff_text2(diffs);file.setClientText(file.shadowText);}else{var patches=file.dmp.patch_make(file.shadowText,diffs);var serverResult=file.dmp.patch_apply(patches,file.shadowText);file.shadowText=serverResult[0];file.patchClientText(patches);}
mobwrite.serverChange_=true;}else{if(file.syncWithoutChange){file.syncWithoutChange();}}}}}else if(name=='C'||name=='c'){if(file){if(file.reportCollaborators){file.reportCollaborators(value.split(","));}}}}
for(var x in mobwrite.shared){if(mobwrite.shared.hasOwnProperty(x)){var shareHandler=mobwrite.shared[x];var marked=readonly.indexOf(x)!=-1;if(marked&&!shareHandler.markedReadOnly){if(shareHandler.setReadOnly){shareHandler.setReadOnly(true);shareHandler.markedReadOnly=true;}}
if(!marked&&shareHandler.markedReadOnly){if(shareHandler.setReadOnly){shareHandler.setReadOnly(false);shareHandler.markedReadOnly=false;}}}}
mobwrite.computeSyncInterval_();window.clearTimeout(mobwrite.syncRunPid_);mobwrite.syncRunPid_=window.setTimeout(mobwrite.syncRun1_,mobwrite.syncInterval);if(mobwrite.debug){window.console.log("Next mobwrite sync in ",mobwrite.syncInterval);}
window.clearTimeout(mobwrite.syncKillPid_);mobwrite.syncKillPid_=null;};mobwrite.syncNow=function(){window.clearTimeout(mobwrite.syncRunPid_);mobwrite.syncRunPid_=window.setTimeout(mobwrite.syncRun1_,10);if(mobwrite.debug){window.console.log("Forced early mobwrite sync in ",10);}};mobwrite.computeSyncInterval_=function(){var range=mobwrite.maxSyncInterval-mobwrite.minSyncInterval;if(mobwrite.clientChange_){mobwrite.syncInterval=mobwrite.minSyncInterval;}
if(mobwrite.serverChange_){mobwrite.syncInterval=mobwrite.minSyncInterval;}
if(!mobwrite.clientChange_&&!mobwrite.serverChange_){mobwrite.syncInterval+=range*0.05;}
mobwrite.syncInterval=Math.max(mobwrite.minSyncInterval,mobwrite.syncInterval);mobwrite.syncInterval=Math.min(mobwrite.maxSyncInterval,mobwrite.syncInterval);};mobwrite.syncKill_=function(){mobwrite.syncKillPid_=null;if(mobwrite.syncAjaxObj_){mobwrite.syncAjaxObj_.abort();mobwrite.syncAjaxObj_=null;}
if(mobwrite.debug){window.console.warn('Connection timeout.');}
window.clearTimeout(mobwrite.syncRunPid_);mobwrite.syncRunPid_=window.setTimeout(mobwrite.syncRun1_,1);};mobwrite.syncLoadAjax_=function(url,post,callback){var req=null;if(window.XMLHttpRequest){try{req=new XMLHttpRequest();}catch(e1){req=null;}}else if(window.ActiveXObject){try{req=new ActiveXObject('Msxml2.XMLHTTP');}catch(e2){try{req=new ActiveXObject('Microsoft.XMLHTTP');}catch(e3){req=null;}}}
if(req){req.onreadystatechange=callback;req.open('POST',url,true);req.setRequestHeader('Content-Type','application/x-www-form-urlencoded');bespin.get("server").protectXhrAgainstCsrf(req);req.send(post);}
return req;};mobwrite.syncCheckAjax_=function(){if(typeof mobwrite=='undefined'||!mobwrite.syncAjaxObj_){return;}
if(mobwrite.syncAjaxObj_.readyState==4){var text=mobwrite.syncAjaxObj_.responseText;if(mobwrite.syncAjaxObj_.status==200){try{mobwrite.syncAjaxObj_=null;mobwrite.syncRun2_(text);}
catch(ex){console.group("Error calling mobwrite.syncRun2_(..."+text.length+" chars')");console.log(mobwrite);console.error(ex);console.trace();console.groupEnd();window.clearTimeout(mobwrite.syncRunPid_);window.clearTimeout(mobwrite.syncKillPid_);for(var x in mobwrite.shared){if(mobwrite.shared.hasOwnProperty(x)){if(mobwrite.shared[x].raiseError){mobwrite.shared[x].raiseError(text,false);}}}}}else{for(var x in mobwrite.shared){if(mobwrite.shared.hasOwnProperty(x)){if(mobwrite.shared[x].raiseError){mobwrite.shared[x].raiseError(text,true);}}}
if(mobwrite.debug){window.console.warn('Connection error code: '+mobwrite.syncAjaxObj_.status+": "+text);}
mobwrite.syncAjaxObj_=null;}}};mobwrite.unload_=function(){if(!mobwrite.syncKillPid_){mobwrite.debug=false;mobwrite.syncRun1_(true);}};if(window.addEventListener){window.addEventListener('unload',mobwrite.unload_,false);}else if(window.attachEvent){window.attachEvent('onunload',mobwrite.unload_);}
mobwrite.share=function(var_args){for(var i=0;i<arguments.length;i++){var el=arguments[i];var result=null;for(var x=0;x<mobwrite.shareHandlers.length&&!result;x++){result=mobwrite.shareHandlers[x].call(mobwrite,el);}
if(result&&result.file){if(result.file in mobwrite.shared){if(mobwrite.debug){window.console.warn('Ignoring duplicate share on "'+el+'".');}
continue;}
mobwrite.shared[result.file]=result;if(mobwrite.syncRunPid_===null){mobwrite.syncRunPid_=window.setTimeout(mobwrite.syncRun1_,10);if(mobwrite.debug){window.console.info('MobWrite task started.');}}else{window.clearTimeout(mobwrite.syncRunPid_);}
mobwrite.syncRunPid_=window.setTimeout(mobwrite.syncRun1_,10);}else{if(mobwrite.debug){window.console.warn('Share: Unknown widget type: '+el+'.');}}}};mobwrite.unshare=function(var_args){for(var i=0;i<arguments.length;i++){var el=arguments[i];if(typeof el=='object'&&'id'in el){el=el.id;}
if(typeof el=='string'&&mobwrite.shared.hasOwnProperty(el)){var shareHandler=mobwrite.shared[el];mobwrite.syncUnload_(shareHandler);delete mobwrite.shared[el];if(mobwrite.debug){window.console.info('Unshared: '+el);}}else{var result=null;for(var x=0;x<mobwrite.shareHandlers.length&&!result;x++){result=mobwrite.shareHandlers[x].call(mobwrite,el);}
if(result&&result.file){if(mobwrite.shared.hasOwnProperty(result.file)){mobwrite.syncUnload_(result);delete mobwrite.shared[result.file];if(mobwrite.debug){window.console.info('Unshared: '+el);}}else{if(mobwrite.debug){window.console.warn('Ignoring '+el+'. Not currently shared.');}}}else{if(mobwrite.debug){window.console.warn('Unshare: Unknown widget type: '+el+'.');}}}}};mobwrite.syncUnload_=function(shareHandler){var data='u:'+mobwrite.syncUsername+'\n'+'x:'+shareHandler.file+'\n\n';if(mobwrite.debug){window.console.info('TO server (unshare):\n'+data);}
data='q='+encodeURIComponent(data);mobwrite.syncLoadAjax_(mobwrite.syncGateway,data,null);};
dojo.provide("bespin.mobwrite.diff");function diff_match_patch(){this.Diff_Timeout=1.0;this.Diff_EditCost=4;this.Diff_DualThreshold=32;this.Match_Threshold=0.5;this.Match_Distance=1000;this.Patch_Margin=4;function getMaxBits(){var maxbits=0;var oldi=1;var newi=2;while(oldi!=newi){maxbits++;oldi=newi;newi=newi<<1;}
return maxbits;}
this.Match_MaxBits=getMaxBits();}
var DIFF_DELETE=-1;var DIFF_INSERT=1;var DIFF_EQUAL=0;diff_match_patch.prototype.diff_main=function(text1,text2,opt_checklines){if(text1==text2){return[[DIFF_EQUAL,text1]];}
if(typeof opt_checklines=='undefined'){opt_checklines=true;}
var checklines=opt_checklines;var commonlength=this.diff_commonPrefix(text1,text2);var commonprefix=text1.substring(0,commonlength);text1=text1.substring(commonlength);text2=text2.substring(commonlength);commonlength=this.diff_commonSuffix(text1,text2);var commonsuffix=text1.substring(text1.length-commonlength);text1=text1.substring(0,text1.length-commonlength);text2=text2.substring(0,text2.length-commonlength);var diffs=this.diff_compute(text1,text2,checklines);if(commonprefix){diffs.unshift([DIFF_EQUAL,commonprefix]);}
if(commonsuffix){diffs.push([DIFF_EQUAL,commonsuffix]);}
this.diff_cleanupMerge(diffs);return diffs;};diff_match_patch.prototype.diff_compute=function(text1,text2,checklines){var diffs;if(!text1){return[[DIFF_INSERT,text2]];}
if(!text2){return[[DIFF_DELETE,text1]];}
var longtext=text1.length>text2.length?text1:text2;var shorttext=text1.length>text2.length?text2:text1;var i=longtext.indexOf(shorttext);if(i!=-1){diffs=[[DIFF_INSERT,longtext.substring(0,i)],[DIFF_EQUAL,shorttext],[DIFF_INSERT,longtext.substring(i+shorttext.length)]];if(text1.length>text2.length){diffs[0][0]=diffs[2][0]=DIFF_DELETE;}
return diffs;}
longtext=shorttext=null;var hm=this.diff_halfMatch(text1,text2);if(hm){var text1_a=hm[0];var text1_b=hm[1];var text2_a=hm[2];var text2_b=hm[3];var mid_common=hm[4];var diffs_a=this.diff_main(text1_a,text2_a,checklines);var diffs_b=this.diff_main(text1_b,text2_b,checklines);return diffs_a.concat([[DIFF_EQUAL,mid_common]],diffs_b);}
if(checklines&&(text1.length<100||text2.length<100)){checklines=false;}
var linearray;if(checklines){var a=this.diff_linesToChars(text1,text2);text1=a[0];text2=a[1];linearray=a[2];}
diffs=this.diff_map(text1,text2);if(!diffs){diffs=[[DIFF_DELETE,text1],[DIFF_INSERT,text2]];}
if(checklines){this.diff_charsToLines(diffs,linearray);this.diff_cleanupSemantic(diffs);diffs.push([DIFF_EQUAL,'']);var pointer=0;var count_delete=0;var count_insert=0;var text_delete='';var text_insert='';while(pointer<diffs.length){switch(diffs[pointer][0]){case DIFF_INSERT:count_insert++;text_insert+=diffs[pointer][1];break;case DIFF_DELETE:count_delete++;text_delete+=diffs[pointer][1];break;case DIFF_EQUAL:if(count_delete>=1&&count_insert>=1){var a=this.diff_main(text_delete,text_insert,false);diffs.splice(pointer-count_delete-count_insert,count_delete+count_insert);pointer=pointer-count_delete-count_insert;for(var j=a.length-1;j>=0;j--){diffs.splice(pointer,0,a[j]);}
pointer=pointer+a.length;}
count_insert=0;count_delete=0;text_delete='';text_insert='';break;}
pointer++;}
diffs.pop();}
return diffs;};diff_match_patch.prototype.diff_linesToChars=function(text1,text2){var lineArray=[];var lineHash={};lineArray[0]='';function diff_linesToCharsMunge(text){var chars='';var lineStart=0;var lineEnd=-1;var lineArrayLength=lineArray.length;while(lineEnd<text.length-1){lineEnd=text.indexOf('\n',lineStart);if(lineEnd==-1){lineEnd=text.length-1;}
var line=text.substring(lineStart,lineEnd+1);lineStart=lineEnd+1;if(lineHash.hasOwnProperty?lineHash.hasOwnProperty(line):(lineHash[line]!==undefined)){chars+=String.fromCharCode(lineHash[line]);}else{chars+=String.fromCharCode(lineArrayLength);lineHash[line]=lineArrayLength;lineArray[lineArrayLength++]=line;}}
return chars;}
var chars1=diff_linesToCharsMunge(text1);var chars2=diff_linesToCharsMunge(text2);return[chars1,chars2,lineArray];};diff_match_patch.prototype.diff_charsToLines=function(diffs,lineArray){for(var x=0;x<diffs.length;x++){var chars=diffs[x][1];var text=[];for(var y=0;y<chars.length;y++){text[y]=lineArray[chars.charCodeAt(y)];}
diffs[x][1]=text.join('');}};diff_match_patch.prototype.diff_map=function(text1,text2){var ms_end=(new Date()).getTime()+this.Diff_Timeout*1000;var max_d=text1.length+text2.length-1;var doubleEnd=this.Diff_DualThreshold*2<max_d;var v_map1=[];var v_map2=[];var v1={};var v2={};v1[1]=0;v2[1]=0;var x,y;var footstep;var footsteps={};var done=false;var hasOwnProperty=!!(footsteps.hasOwnProperty);var front=(text1.length+text2.length)%2;for(var d=0;d<max_d;d++){if(this.Diff_Timeout>0&&(new Date()).getTime()>ms_end){return null;}
v_map1[d]={};for(var k=-d;k<=d;k+=2){if(k==-d||k!=d&&v1[k-1]<v1[k+1]){x=v1[k+1];}else{x=v1[k-1]+1;}
y=x-k;if(doubleEnd){footstep=x+','+y;if(front&&(hasOwnProperty?footsteps.hasOwnProperty(footstep):(footsteps[footstep]!==undefined))){done=true;}
if(!front){footsteps[footstep]=d;}}
while(!done&&x<text1.length&&y<text2.length&&text1.charAt(x)==text2.charAt(y)){x++;y++;if(doubleEnd){footstep=x+','+y;if(front&&(hasOwnProperty?footsteps.hasOwnProperty(footstep):(footsteps[footstep]!==undefined))){done=true;}
if(!front){footsteps[footstep]=d;}}}
v1[k]=x;v_map1[d][x+','+y]=true;if(x==text1.length&&y==text2.length){return this.diff_path1(v_map1,text1,text2);}else if(done){v_map2=v_map2.slice(0,footsteps[footstep]+1);var a=this.diff_path1(v_map1,text1.substring(0,x),text2.substring(0,y));return a.concat(this.diff_path2(v_map2,text1.substring(x),text2.substring(y)));}}
if(doubleEnd){v_map2[d]={};for(var k=-d;k<=d;k+=2){if(k==-d||k!=d&&v2[k-1]<v2[k+1]){x=v2[k+1];}else{x=v2[k-1]+1;}
y=x-k;footstep=(text1.length-x)+','+(text2.length-y);if(!front&&(hasOwnProperty?footsteps.hasOwnProperty(footstep):(footsteps[footstep]!==undefined))){done=true;}
if(front){footsteps[footstep]=d;}
while(!done&&x<text1.length&&y<text2.length&&text1.charAt(text1.length-x-1)==text2.charAt(text2.length-y-1)){x++;y++;footstep=(text1.length-x)+','+(text2.length-y);if(!front&&(hasOwnProperty?footsteps.hasOwnProperty(footstep):(footsteps[footstep]!==undefined))){done=true;}
if(front){footsteps[footstep]=d;}}
v2[k]=x;v_map2[d][x+','+y]=true;if(done){v_map1=v_map1.slice(0,footsteps[footstep]+1);var a=this.diff_path1(v_map1,text1.substring(0,text1.length-x),text2.substring(0,text2.length-y));return a.concat(this.diff_path2(v_map2,text1.substring(text1.length-x),text2.substring(text2.length-y)));}}}}
return null;};diff_match_patch.prototype.diff_path1=function(v_map,text1,text2){var path=[];var x=text1.length;var y=text2.length;var last_op=null;for(var d=v_map.length-2;d>=0;d--){while(1){if(v_map[d].hasOwnProperty?v_map[d].hasOwnProperty((x-1)+','+y):(v_map[d][(x-1)+','+y]!==undefined)){x--;if(last_op===DIFF_DELETE){path[0][1]=text1.charAt(x)+path[0][1];}else{path.unshift([DIFF_DELETE,text1.charAt(x)]);}
last_op=DIFF_DELETE;break;}else if(v_map[d].hasOwnProperty?v_map[d].hasOwnProperty(x+','+(y-1)):(v_map[d][x+','+(y-1)]!==undefined)){y--;if(last_op===DIFF_INSERT){path[0][1]=text2.charAt(y)+path[0][1];}else{path.unshift([DIFF_INSERT,text2.charAt(y)]);}
last_op=DIFF_INSERT;break;}else{x--;y--;if(last_op===DIFF_EQUAL){path[0][1]=text1.charAt(x)+path[0][1];}else{path.unshift([DIFF_EQUAL,text1.charAt(x)]);}
last_op=DIFF_EQUAL;}}}
return path;};diff_match_patch.prototype.diff_path2=function(v_map,text1,text2){var path=[];var pathLength=0;var x=text1.length;var y=text2.length;var last_op=null;for(var d=v_map.length-2;d>=0;d--){while(1){if(v_map[d].hasOwnProperty?v_map[d].hasOwnProperty((x-1)+','+y):(v_map[d][(x-1)+','+y]!==undefined)){x--;if(last_op===DIFF_DELETE){path[pathLength-1][1]+=text1.charAt(text1.length-x-1);}else{path[pathLength++]=[DIFF_DELETE,text1.charAt(text1.length-x-1)];}
last_op=DIFF_DELETE;break;}else if(v_map[d].hasOwnProperty?v_map[d].hasOwnProperty(x+','+(y-1)):(v_map[d][x+','+(y-1)]!==undefined)){y--;if(last_op===DIFF_INSERT){path[pathLength-1][1]+=text2.charAt(text2.length-y-1);}else{path[pathLength++]=[DIFF_INSERT,text2.charAt(text2.length-y-1)];}
last_op=DIFF_INSERT;break;}else{x--;y--;if(last_op===DIFF_EQUAL){path[pathLength-1][1]+=text1.charAt(text1.length-x-1);}else{path[pathLength++]=[DIFF_EQUAL,text1.charAt(text1.length-x-1)];}
last_op=DIFF_EQUAL;}}}
return path;};diff_match_patch.prototype.diff_commonPrefix=function(text1,text2){if(!text1||!text2||text1.charCodeAt(0)!==text2.charCodeAt(0)){return 0;}
var pointermin=0;var pointermax=Math.min(text1.length,text2.length);var pointermid=pointermax;var pointerstart=0;while(pointermin<pointermid){if(text1.substring(pointerstart,pointermid)==text2.substring(pointerstart,pointermid)){pointermin=pointermid;pointerstart=pointermin;}else{pointermax=pointermid;}
pointermid=Math.floor((pointermax-pointermin)/2+pointermin);}
return pointermid;};diff_match_patch.prototype.diff_commonSuffix=function(text1,text2){if(!text1||!text2||text1.charCodeAt(text1.length-1)!==text2.charCodeAt(text2.length-1)){return 0;}
var pointermin=0;var pointermax=Math.min(text1.length,text2.length);var pointermid=pointermax;var pointerend=0;while(pointermin<pointermid){if(text1.substring(text1.length-pointermid,text1.length-pointerend)==text2.substring(text2.length-pointermid,text2.length-pointerend)){pointermin=pointermid;pointerend=pointermin;}else{pointermax=pointermid;}
pointermid=Math.floor((pointermax-pointermin)/2+pointermin);}
return pointermid;};diff_match_patch.prototype.diff_halfMatch=function(text1,text2){var longtext=text1.length>text2.length?text1:text2;var shorttext=text1.length>text2.length?text2:text1;if(longtext.length<10||shorttext.length<1){return null;}
var dmp=this;function diff_halfMatchI(longtext,shorttext,i){var seed=longtext.substring(i,i+Math.floor(longtext.length/4));var j=-1;var best_common='';var best_longtext_a,best_longtext_b,best_shorttext_a,best_shorttext_b;while((j=shorttext.indexOf(seed,j+1))!=-1){var prefixLength=dmp.diff_commonPrefix(longtext.substring(i),shorttext.substring(j));var suffixLength=dmp.diff_commonSuffix(longtext.substring(0,i),shorttext.substring(0,j));if(best_common.length<suffixLength+prefixLength){best_common=shorttext.substring(j-suffixLength,j)+
shorttext.substring(j,j+prefixLength);best_longtext_a=longtext.substring(0,i-suffixLength);best_longtext_b=longtext.substring(i+prefixLength);best_shorttext_a=shorttext.substring(0,j-suffixLength);best_shorttext_b=shorttext.substring(j+prefixLength);}}
if(best_common.length>=longtext.length/2){return[best_longtext_a,best_longtext_b,best_shorttext_a,best_shorttext_b,best_common];}else{return null;}}
var hm1=diff_halfMatchI(longtext,shorttext,Math.ceil(longtext.length/4));var hm2=diff_halfMatchI(longtext,shorttext,Math.ceil(longtext.length/2));var hm;if(!hm1&&!hm2){return null;}else if(!hm2){hm=hm1;}else if(!hm1){hm=hm2;}else{hm=hm1[4].length>hm2[4].length?hm1:hm2;}
var text1_a,text1_b,text2_a,text2_b;if(text1.length>text2.length){text1_a=hm[0];text1_b=hm[1];text2_a=hm[2];text2_b=hm[3];}else{text2_a=hm[0];text2_b=hm[1];text1_a=hm[2];text1_b=hm[3];}
var mid_common=hm[4];return[text1_a,text1_b,text2_a,text2_b,mid_common];};diff_match_patch.prototype.diff_cleanupSemantic=function(diffs){var changes=false;var equalities=[];var equalitiesLength=0;var lastequality=null;var pointer=0;var length_changes1=0;var length_changes2=0;while(pointer<diffs.length){if(diffs[pointer][0]==DIFF_EQUAL){equalities[equalitiesLength++]=pointer;length_changes1=length_changes2;length_changes2=0;lastequality=diffs[pointer][1];}else{length_changes2+=diffs[pointer][1].length;if(lastequality!==null&&(lastequality.length<=length_changes1)&&(lastequality.length<=length_changes2)){diffs.splice(equalities[equalitiesLength-1],0,[DIFF_DELETE,lastequality]);diffs[equalities[equalitiesLength-1]+1][0]=DIFF_INSERT;equalitiesLength--;equalitiesLength--;pointer=equalitiesLength>0?equalities[equalitiesLength-1]:-1;length_changes1=0;length_changes2=0;lastequality=null;changes=true;}}
pointer++;}
if(changes){this.diff_cleanupMerge(diffs);}
this.diff_cleanupSemanticLossless(diffs);};diff_match_patch.prototype.diff_cleanupSemanticLossless=function(diffs){var punctuation=/[^a-zA-Z0-9]/;var whitespace=/\s/;var linebreak=/[\r\n]/;var blanklineEnd=/\n\r?\n$/;var blanklineStart=/^\r?\n\r?\n/;function diff_cleanupSemanticScore(one,two){if(!one||!two){return 5;}
var score=0;if(one.charAt(one.length-1).match(punctuation)||two.charAt(0).match(punctuation)){score++;if(one.charAt(one.length-1).match(whitespace)||two.charAt(0).match(whitespace)){score++;if(one.charAt(one.length-1).match(linebreak)||two.charAt(0).match(linebreak)){score++;if(one.match(blanklineEnd)||two.match(blanklineStart)){score++;}}}}
return score;}
var pointer=1;while(pointer<diffs.length-1){if(diffs[pointer-1][0]==DIFF_EQUAL&&diffs[pointer+1][0]==DIFF_EQUAL){var equality1=diffs[pointer-1][1];var edit=diffs[pointer][1];var equality2=diffs[pointer+1][1];var commonOffset=this.diff_commonSuffix(equality1,edit);if(commonOffset){var commonString=edit.substring(edit.length-commonOffset);equality1=equality1.substring(0,equality1.length-commonOffset);edit=commonString+edit.substring(0,edit.length-commonOffset);equality2=commonString+equality2;}
var bestEquality1=equality1;var bestEdit=edit;var bestEquality2=equality2;var bestScore=diff_cleanupSemanticScore(equality1,edit)+
diff_cleanupSemanticScore(edit,equality2);while(edit.charAt(0)===equality2.charAt(0)){equality1+=edit.charAt(0);edit=edit.substring(1)+equality2.charAt(0);equality2=equality2.substring(1);var score=diff_cleanupSemanticScore(equality1,edit)+
diff_cleanupSemanticScore(edit,equality2);if(score>=bestScore){bestScore=score;bestEquality1=equality1;bestEdit=edit;bestEquality2=equality2;}}
if(diffs[pointer-1][1]!=bestEquality1){if(bestEquality1){diffs[pointer-1][1]=bestEquality1;}else{diffs.splice(pointer-1,1);pointer--;}
diffs[pointer][1]=bestEdit;if(bestEquality2){diffs[pointer+1][1]=bestEquality2;}else{diffs.splice(pointer+1,1);pointer--;}}}
pointer++;}};diff_match_patch.prototype.diff_cleanupEfficiency=function(diffs){var changes=false;var equalities=[];var equalitiesLength=0;var lastequality='';var pointer=0;var pre_ins=false;var pre_del=false;var post_ins=false;var post_del=false;while(pointer<diffs.length){if(diffs[pointer][0]==DIFF_EQUAL){if(diffs[pointer][1].length<this.Diff_EditCost&&(post_ins||post_del)){equalities[equalitiesLength++]=pointer;pre_ins=post_ins;pre_del=post_del;lastequality=diffs[pointer][1];}else{equalitiesLength=0;lastequality='';}
post_ins=post_del=false;}else{if(diffs[pointer][0]==DIFF_DELETE){post_del=true;}else{post_ins=true;}
if(lastequality&&((pre_ins&&pre_del&&post_ins&&post_del)||((lastequality.length<this.Diff_EditCost/2)&&(pre_ins+pre_del+post_ins+post_del)==3))){diffs.splice(equalities[equalitiesLength-1],0,[DIFF_DELETE,lastequality]);diffs[equalities[equalitiesLength-1]+1][0]=DIFF_INSERT;equalitiesLength--;lastequality='';if(pre_ins&&pre_del){post_ins=post_del=true;equalitiesLength=0;}else{equalitiesLength--;pointer=equalitiesLength>0?equalities[equalitiesLength-1]:-1;post_ins=post_del=false;}
changes=true;}}
pointer++;}
if(changes){this.diff_cleanupMerge(diffs);}};diff_match_patch.prototype.diff_cleanupMerge=function(diffs){diffs.push([DIFF_EQUAL,'']);var pointer=0;var count_delete=0;var count_insert=0;var text_delete='';var text_insert='';var commonlength;while(pointer<diffs.length){switch(diffs[pointer][0]){case DIFF_INSERT:count_insert++;text_insert+=diffs[pointer][1];pointer++;break;case DIFF_DELETE:count_delete++;text_delete+=diffs[pointer][1];pointer++;break;case DIFF_EQUAL:if(count_delete!==0||count_insert!==0){if(count_delete!==0&&count_insert!==0){commonlength=this.diff_commonPrefix(text_insert,text_delete);if(commonlength!==0){if((pointer-count_delete-count_insert)>0&&diffs[pointer-count_delete-count_insert-1][0]==DIFF_EQUAL){diffs[pointer-count_delete-count_insert-1][1]+=text_insert.substring(0,commonlength);}else{diffs.splice(0,0,[DIFF_EQUAL,text_insert.substring(0,commonlength)]);pointer++;}
text_insert=text_insert.substring(commonlength);text_delete=text_delete.substring(commonlength);}
commonlength=this.diff_commonSuffix(text_insert,text_delete);if(commonlength!==0){diffs[pointer][1]=text_insert.substring(text_insert.length-
commonlength)+diffs[pointer][1];text_insert=text_insert.substring(0,text_insert.length-
commonlength);text_delete=text_delete.substring(0,text_delete.length-
commonlength);}}
if(count_delete===0){diffs.splice(pointer-count_delete-count_insert,count_delete+count_insert,[DIFF_INSERT,text_insert]);}else if(count_insert===0){diffs.splice(pointer-count_delete-count_insert,count_delete+count_insert,[DIFF_DELETE,text_delete]);}else{diffs.splice(pointer-count_delete-count_insert,count_delete+count_insert,[DIFF_DELETE,text_delete],[DIFF_INSERT,text_insert]);}
pointer=pointer-count_delete-count_insert+
(count_delete?1:0)+(count_insert?1:0)+1;}else if(pointer!==0&&diffs[pointer-1][0]==DIFF_EQUAL){diffs[pointer-1][1]+=diffs[pointer][1];diffs.splice(pointer,1);}else{pointer++;}
count_insert=0;count_delete=0;text_delete='';text_insert='';break;}}
if(diffs[diffs.length-1][1]===''){diffs.pop();}
var changes=false;pointer=1;while(pointer<diffs.length-1){if(diffs[pointer-1][0]==DIFF_EQUAL&&diffs[pointer+1][0]==DIFF_EQUAL){if(diffs[pointer][1].substring(diffs[pointer][1].length-
diffs[pointer-1][1].length)==diffs[pointer-1][1]){diffs[pointer][1]=diffs[pointer-1][1]+
diffs[pointer][1].substring(0,diffs[pointer][1].length-
diffs[pointer-1][1].length);diffs[pointer+1][1]=diffs[pointer-1][1]+diffs[pointer+1][1];diffs.splice(pointer-1,1);changes=true;}else if(diffs[pointer][1].substring(0,diffs[pointer+1][1].length)==diffs[pointer+1][1]){diffs[pointer-1][1]+=diffs[pointer+1][1];diffs[pointer][1]=diffs[pointer][1].substring(diffs[pointer+1][1].length)+
diffs[pointer+1][1];diffs.splice(pointer+1,1);changes=true;}}
pointer++;}
if(changes){this.diff_cleanupMerge(diffs);}};diff_match_patch.prototype.diff_xIndex=function(diffs,loc){var chars1=0;var chars2=0;var last_chars1=0;var last_chars2=0;var x;for(x=0;x<diffs.length;x++){if(diffs[x][0]!==DIFF_INSERT){chars1+=diffs[x][1].length;}
if(diffs[x][0]!==DIFF_DELETE){chars2+=diffs[x][1].length;}
if(chars1>loc){break;}
last_chars1=chars1;last_chars2=chars2;}
if(diffs.length!=x&&diffs[x][0]===DIFF_DELETE){return last_chars2;}
return last_chars2+(loc-last_chars1);};diff_match_patch.prototype.diff_prettyHtml=function(diffs){var html=[];var i=0;for(var x=0;x<diffs.length;x++){var op=diffs[x][0];var data=diffs[x][1];var text=data.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'&para;<BR>');switch(op){case DIFF_INSERT:html[x]='<INS STYLE="background:#E6FFE6;" TITLE="i='+i+'">'+
text+'</INS>';break;case DIFF_DELETE:html[x]='<DEL STYLE="background:#FFE6E6;" TITLE="i='+i+'">'+
text+'</DEL>';break;case DIFF_EQUAL:html[x]='<SPAN TITLE="i='+i+'">'+text+'</SPAN>';break;}
if(op!==DIFF_DELETE){i+=data.length;}}
return html.join('');};diff_match_patch.prototype.diff_text1=function(diffs){var text=[];for(var x=0;x<diffs.length;x++){if(diffs[x][0]!==DIFF_INSERT){text[x]=diffs[x][1];}}
return text.join('');};diff_match_patch.prototype.diff_text2=function(diffs){var text=[];for(var x=0;x<diffs.length;x++){if(diffs[x][0]!==DIFF_DELETE){text[x]=diffs[x][1];}}
return text.join('');};diff_match_patch.prototype.diff_levenshtein=function(diffs){var levenshtein=0;var insertions=0;var deletions=0;for(var x=0;x<diffs.length;x++){var op=diffs[x][0];var data=diffs[x][1];switch(op){case DIFF_INSERT:insertions+=data.length;break;case DIFF_DELETE:deletions+=data.length;break;case DIFF_EQUAL:levenshtein+=Math.max(insertions,deletions);insertions=0;deletions=0;break;}}
levenshtein+=Math.max(insertions,deletions);return levenshtein;};diff_match_patch.prototype.diff_toDelta=function(diffs){var text=[];for(var x=0;x<diffs.length;x++){switch(diffs[x][0]){case DIFF_INSERT:text[x]='+'+encodeURI(diffs[x][1]);break;case DIFF_DELETE:text[x]='-'+diffs[x][1].length;break;case DIFF_EQUAL:text[x]='='+diffs[x][1].length;break;}}
return text.join('\t').replace(/\x00/g,'%00').replace(/%20/g,' ');};diff_match_patch.prototype.diff_fromDelta=function(text1,delta){var diffs=[];var diffsLength=0;var pointer=0;delta=delta.replace(/%00/g,'\0');var tokens=delta.split(/\t/g);for(var x=0;x<tokens.length;x++){var param=tokens[x].substring(1);switch(tokens[x].charAt(0)){case'+':try{diffs[diffsLength++]=[DIFF_INSERT,decodeURI(param)];}catch(ex){throw new Error('Illegal escape in diff_fromDelta: '+param);}
break;case'-':case'=':var n=parseInt(param,10);if(isNaN(n)||n<0){throw new Error('Invalid number in diff_fromDelta: '+param);}
var text=text1.substring(pointer,pointer+=n);if(tokens[x].charAt(0)=='='){diffs[diffsLength++]=[DIFF_EQUAL,text];}else{diffs[diffsLength++]=[DIFF_DELETE,text];}
break;default:if(tokens[x]){throw new Error('Invalid diff operation in diff_fromDelta: '+
tokens[x]);}}}
if(pointer!=text1.length){throw new Error('Delta length ('+pointer+') does not equal source text length ('+text1.length+').');}
return diffs;};diff_match_patch.prototype.match_main=function(text,pattern,loc){loc=Math.max(0,Math.min(loc,text.length));if(text==pattern){return 0;}else if(!text.length){return-1;}else if(text.substring(loc,loc+pattern.length)==pattern){return loc;}else{return this.match_bitap(text,pattern,loc);}};diff_match_patch.prototype.match_bitap=function(text,pattern,loc){if(pattern.length>this.Match_MaxBits){throw new Error('Pattern too long for this browser.');}
var s=this.match_alphabet(pattern);var dmp=this;function match_bitapScore(e,x){var accuracy=e/pattern.length;var proximity=Math.abs(loc-x);if(!dmp.Match_Distance){return proximity?1.0:accuracy;}
return accuracy+proximity/dmp.Match_Distance;}
var score_threshold=this.Match_Threshold;var best_loc=text.indexOf(pattern,loc);if(best_loc!=-1){score_threshold=Math.min(match_bitapScore(0,best_loc),score_threshold);}
best_loc=text.lastIndexOf(pattern,loc+pattern.length);if(best_loc!=-1){score_threshold=Math.min(match_bitapScore(0,best_loc),score_threshold);}
var matchmask=1<<(pattern.length-1);best_loc=-1;var bin_min,bin_mid;var bin_max=pattern.length+text.length;var last_rd;for(var d=0;d<pattern.length;d++){bin_min=0;bin_mid=bin_max;while(bin_min<bin_mid){if(match_bitapScore(d,loc+bin_mid)<=score_threshold){bin_min=bin_mid;}else{bin_max=bin_mid;}
bin_mid=Math.floor((bin_max-bin_min)/2+bin_min);}
bin_max=bin_mid;var start=Math.max(1,loc-bin_mid+1);var finish=Math.min(loc+bin_mid,text.length)+pattern.length;var rd=Array(finish+2);rd[finish+1]=(1<<d)-1;for(var j=finish;j>=start;j--){var charMatch=s[text.charAt(j-1)];if(d===0){rd[j]=((rd[j+1]<<1)|1)&charMatch;}else{rd[j]=((rd[j+1]<<1)|1)&charMatch|(((last_rd[j+1]|last_rd[j])<<1)|1)|last_rd[j+1];}
if(rd[j]&matchmask){var score=match_bitapScore(d,j-1);if(score<=score_threshold){score_threshold=score;best_loc=j-1;if(best_loc>loc){start=Math.max(1,2*loc-best_loc);}else{break;}}}}
if(match_bitapScore(d+1,loc)>score_threshold){break;}
last_rd=rd;}
return best_loc;};diff_match_patch.prototype.match_alphabet=function(pattern){var s={};for(var i=0;i<pattern.length;i++){s[pattern.charAt(i)]=0;}
for(var i=0;i<pattern.length;i++){s[pattern.charAt(i)]|=1<<(pattern.length-i-1);}
return s;};diff_match_patch.prototype.patch_addContext=function(patch,text){var pattern=text.substring(patch.start2,patch.start2+patch.length1);var padding=0;while(text.indexOf(pattern)!=text.lastIndexOf(pattern)&&pattern.length<this.Match_MaxBits-this.Patch_Margin
-this.Patch_Margin){padding+=this.Patch_Margin;pattern=text.substring(patch.start2-padding,patch.start2+patch.length1+padding);}
padding+=this.Patch_Margin;var prefix=text.substring(patch.start2-padding,patch.start2);if(prefix!==''){patch.diffs.unshift([DIFF_EQUAL,prefix]);}
var suffix=text.substring(patch.start2+patch.length1,patch.start2+patch.length1+padding);if(suffix!==''){patch.diffs.push([DIFF_EQUAL,suffix]);}
patch.start1-=prefix.length;patch.start2-=prefix.length;patch.length1+=prefix.length+suffix.length;patch.length2+=prefix.length+suffix.length;};diff_match_patch.prototype.patch_make=function(a,opt_b,opt_c){var text1,diffs;if(typeof a=='string'&&typeof opt_b=='string'&&typeof opt_c=='undefined'){text1=a;diffs=this.diff_main(text1,opt_b,true);if(diffs.length>2){this.diff_cleanupSemantic(diffs);this.diff_cleanupEfficiency(diffs);}}else if(typeof a=='object'&&typeof opt_b=='undefined'&&typeof opt_c=='undefined'){diffs=a;text1=this.diff_text1(diffs);}else if(typeof a=='string'&&typeof opt_b=='object'&&typeof opt_c=='undefined'){text1=a;diffs=opt_b;}else if(typeof a=='string'&&typeof opt_b=='string'&&typeof opt_c=='object'){text1=a;diffs=opt_c;}else{throw new Error('Unknown call format to patch_make.');}
if(diffs.length===0){return[];}
var patches=[];var patch=new patch_obj();var patchDiffLength=0;var char_count1=0;var char_count2=0;var prepatch_text=text1;var postpatch_text=text1;for(var x=0;x<diffs.length;x++){var diff_type=diffs[x][0];var diff_text=diffs[x][1];if(!patchDiffLength&&diff_type!==DIFF_EQUAL){patch.start1=char_count1;patch.start2=char_count2;}
switch(diff_type){case DIFF_INSERT:patch.diffs[patchDiffLength++]=diffs[x];patch.length2+=diff_text.length;postpatch_text=postpatch_text.substring(0,char_count2)+diff_text+
postpatch_text.substring(char_count2);break;case DIFF_DELETE:patch.length1+=diff_text.length;patch.diffs[patchDiffLength++]=diffs[x];postpatch_text=postpatch_text.substring(0,char_count2)+
postpatch_text.substring(char_count2+diff_text.length);break;case DIFF_EQUAL:if(diff_text.length<=2*this.Patch_Margin&&patchDiffLength&&diffs.length!=x+1){patch.diffs[patchDiffLength++]=diffs[x];patch.length1+=diff_text.length;patch.length2+=diff_text.length;}else if(diff_text.length>=2*this.Patch_Margin){if(patchDiffLength){this.patch_addContext(patch,prepatch_text);patches.push(patch);patch=new patch_obj();patchDiffLength=0;prepatch_text=postpatch_text;char_count1=char_count2;}}
break;}
if(diff_type!==DIFF_INSERT){char_count1+=diff_text.length;}
if(diff_type!==DIFF_DELETE){char_count2+=diff_text.length;}}
if(patchDiffLength){this.patch_addContext(patch,prepatch_text);patches.push(patch);}
return patches;};diff_match_patch.prototype.patch_deepCopy=function(patches){var patchesCopy=[];for(var x=0;x<patches.length;x++){var patch=patches[x];var patchCopy=new patch_obj();patchCopy.diffs=[];for(var y=0;y<patch.diffs.length;y++){patchCopy.diffs[y]=patch.diffs[y].slice();}
patchCopy.start1=patch.start1;patchCopy.start2=patch.start2;patchCopy.length1=patch.length1;patchCopy.length2=patch.length2;patchesCopy[x]=patchCopy;}
return patchesCopy;};diff_match_patch.prototype.patch_apply=function(patches,text){if(patches.length==0){return[text,[]];}
patches=this.patch_deepCopy(patches);var nullPadding=this.patch_addPadding(patches);text=nullPadding+text+nullPadding;this.patch_splitMax(patches);var delta=0;var results=[];for(var x=0;x<patches.length;x++){var expected_loc=patches[x].start2+delta;var text1=this.diff_text1(patches[x].diffs);var start_loc=this.match_main(text,text1,expected_loc);if(start_loc==-1){results[x]=false;}else{results[x]=true;delta=start_loc-expected_loc;var text2=text.substring(start_loc,start_loc+text1.length);if(text1==text2){text=text.substring(0,start_loc)+
this.diff_text2(patches[x].diffs)+
text.substring(start_loc+text1.length);}else{var diffs=this.diff_main(text1,text2,false);this.diff_cleanupSemanticLossless(diffs);var index1=0;var index2;for(var y=0;y<patches[x].diffs.length;y++){var mod=patches[x].diffs[y];if(mod[0]!==DIFF_EQUAL){index2=this.diff_xIndex(diffs,index1);}
if(mod[0]===DIFF_INSERT){text=text.substring(0,start_loc+index2)+mod[1]+
text.substring(start_loc+index2);}else if(mod[0]===DIFF_DELETE){text=text.substring(0,start_loc+index2)+
text.substring(start_loc+this.diff_xIndex(diffs,index1+mod[1].length));}
if(mod[0]!==DIFF_DELETE){index1+=mod[1].length;}}}}}
text=text.substring(nullPadding.length,text.length-nullPadding.length);return[text,results];};diff_match_patch.prototype.patch_addPadding=function(patches){var nullPadding='';for(var x=0;x<this.Patch_Margin;x++){nullPadding+=String.fromCharCode(x);}
for(var x=0;x<patches.length;x++){patches[x].start1+=nullPadding.length;patches[x].start2+=nullPadding.length;}
var patch=patches[0];var diffs=patch.diffs;if(diffs.length==0||diffs[0][0]!=DIFF_EQUAL){diffs.unshift([DIFF_EQUAL,nullPadding]);patch.start1-=nullPadding.length;patch.start2-=nullPadding.length;patch.length1+=nullPadding.length;patch.length2+=nullPadding.length;}else if(nullPadding.length>diffs[0][1].length){var extraLength=nullPadding.length-diffs[0][1].length;diffs[0][1]=nullPadding.substring(diffs[0][1].length)+diffs[0][1];patch.start1-=extraLength;patch.start2-=extraLength;patch.length1+=extraLength;patch.length2+=extraLength;}
patch=patches[patches.length-1];diffs=patch.diffs;if(diffs.length==0||diffs[diffs.length-1][0]!=DIFF_EQUAL){diffs.push([DIFF_EQUAL,nullPadding]);patch.length1+=nullPadding.length;patch.length2+=nullPadding.length;}else if(nullPadding.length>diffs[diffs.length-1][1].length){var extraLength=nullPadding.length-diffs[diffs.length-1][1].length;diffs[diffs.length-1][1]+=nullPadding.substring(0,extraLength);patch.length1+=extraLength;patch.length2+=extraLength;}
return nullPadding;};diff_match_patch.prototype.patch_splitMax=function(patches){for(var x=0;x<patches.length;x++){if(patches[x].length1>this.Match_MaxBits){var bigpatch=patches[x];patches.splice(x--,1);var patch_size=this.Match_MaxBits;var start1=bigpatch.start1;var start2=bigpatch.start2;var precontext='';while(bigpatch.diffs.length!==0){var patch=new patch_obj();var empty=true;patch.start1=start1-precontext.length;patch.start2=start2-precontext.length;if(precontext!==''){patch.length1=patch.length2=precontext.length;patch.diffs.push([DIFF_EQUAL,precontext]);}
while(bigpatch.diffs.length!==0&&patch.length1<patch_size-this.Patch_Margin){var diff_type=bigpatch.diffs[0][0];var diff_text=bigpatch.diffs[0][1];if(diff_type===DIFF_INSERT){patch.length2+=diff_text.length;start2+=diff_text.length;patch.diffs.push(bigpatch.diffs.shift());empty=false;}else{diff_text=diff_text.substring(0,patch_size-patch.length1-
this.Patch_Margin);patch.length1+=diff_text.length;start1+=diff_text.length;if(diff_type===DIFF_EQUAL){patch.length2+=diff_text.length;start2+=diff_text.length;}else{empty=false;}
patch.diffs.push([diff_type,diff_text]);if(diff_text==bigpatch.diffs[0][1]){bigpatch.diffs.shift();}else{bigpatch.diffs[0][1]=bigpatch.diffs[0][1].substring(diff_text.length);}}}
precontext=this.diff_text2(patch.diffs);precontext=precontext.substring(precontext.length-this.Patch_Margin);var postcontext=this.diff_text1(bigpatch.diffs).substring(0,this.Patch_Margin);if(postcontext!==''){patch.length1+=postcontext.length;patch.length2+=postcontext.length;if(patch.diffs.length!==0&&patch.diffs[patch.diffs.length-1][0]===DIFF_EQUAL){patch.diffs[patch.diffs.length-1][1]+=postcontext;}else{patch.diffs.push([DIFF_EQUAL,postcontext]);}}
if(!empty){patches.splice(++x,0,patch);}}}}};diff_match_patch.prototype.patch_toText=function(patches){var text=[];for(var x=0;x<patches.length;x++){text[x]=patches[x];}
return text.join('');};diff_match_patch.prototype.patch_fromText=function(textline){var patches=[];if(!textline){return patches;}
textline=textline.replace(/%00/g,'\0');var text=textline.split('\n');var textPointer=0;while(textPointer<text.length){var m=text[textPointer].match(/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/);if(!m){throw new Error('Invalid patch string: '+text[textPointer]);}
var patch=new patch_obj();patches.push(patch);patch.start1=parseInt(m[1],10);if(m[2]===''){patch.start1--;patch.length1=1;}else if(m[2]=='0'){patch.length1=0;}else{patch.start1--;patch.length1=parseInt(m[2],10);}
patch.start2=parseInt(m[3],10);if(m[4]===''){patch.start2--;patch.length2=1;}else if(m[4]=='0'){patch.length2=0;}else{patch.start2--;patch.length2=parseInt(m[4],10);}
textPointer++;while(textPointer<text.length){var sign=text[textPointer].charAt(0);try{var line=decodeURI(text[textPointer].substring(1));}catch(ex){throw new Error('Illegal escape in patch_fromText: '+line);}
if(sign=='-'){patch.diffs.push([DIFF_DELETE,line]);}else if(sign=='+'){patch.diffs.push([DIFF_INSERT,line]);}else if(sign==' '){patch.diffs.push([DIFF_EQUAL,line]);}else if(sign=='@'){break;}else if(sign===''){}else{throw new Error('Invalid patch mode "'+sign+'" in: '+line);}
textPointer++;}}
return patches;};function patch_obj(){this.diffs=[];this.start1=null;this.start2=null;this.length1=0;this.length2=0;}
patch_obj.prototype.toString=function(){var coords1,coords2;if(this.length1===0){coords1=this.start1+',0';}else if(this.length1==1){coords1=this.start1+1;}else{coords1=(this.start1+1)+','+this.length1;}
if(this.length2===0){coords2=this.start2+',0';}else if(this.length2==1){coords2=this.start2+1;}else{coords2=(this.start2+1)+','+this.length2;}
var text=['@@ -'+coords1+' +'+coords2+' @@\n'];var op;for(var x=0;x<this.diffs.length;x++){switch(this.diffs[x][0]){case DIFF_INSERT:op='+';break;case DIFF_DELETE:op='-';break;case DIFF_EQUAL:op=' ';break;}
text[x+1]=op+encodeURI(this.diffs[x][1])+'\n';}
return text.join('').replace(/\x00/g,'%00').replace(/%20/g,' ');};
dojo.provide("bespin.mobwrite.integrate");mobwrite.shareBespinObj=function(shareNode){this.shareNode=shareNode;this.shareNode.setShareObj(this);mobwrite.shareObj.apply(this,[shareNode.id]);};mobwrite.shareBespinObj.prototype=new mobwrite.shareObj('');mobwrite.shareBespinObj.prototype.getClientText=function(allowUnsynced){return this.shareNode.getClientText(allowUnsynced);};mobwrite.shareBespinObj.prototype.setClientText=function(text){this.shareNode.setClientText(text);};mobwrite.shareBespinObj.prototype.patchClientText=function(patches){this.shareNode.patchClientText(patches);};mobwrite.shareBespinObj.prototype.syncWithoutChange=function(){this.shareNode.syncWithoutChange();};mobwrite.shareBespinObj.prototype.reportCollaborators=function(userEntries){this.shareNode.reportCollaborators(userEntries);};mobwrite.shareBespinObj.prototype.raiseError=function(text,recoverable){this.shareNode.raiseError(text,recoverable);};mobwrite.shareBespinObj.prototype.setReadOnly=function(readonly){this.shareNode.setReadOnly(readonly);};mobwrite.shareBespinObj.prototype.getMetaData=function(){return this.shareNode.getMetaData();};mobwrite.shareBespinObj.shareHandler=function(node){if(node.isShareNode===true){node.shareHandler=new mobwrite.shareBespinObj(node);return node.shareHandler;}else{return null;}};mobwrite.shareHandlers.push(mobwrite.shareBespinObj.shareHandler);
dojo.provide("bespin.client.pubsub");dojo.declare("bespin.client.pubsub.Proxy",null,{constructor:function(){this.server=bespin.get("server");},listen:function(){var self=this;var onSuccess=function(pub){bespin.publish(pub.topic,pub.event);self.listen();};var url="/event/listen/?queue="+self.queue;this.server.request('GET',url,null,{log:'Message arrived',onSuccess:onSuccess,evalJSON:true});},forward:function(topic,event){var self=this;var url="/event/forward/?queue="+self.queue+"&topic="+encodeURIComponent(topic)+"&event="+encodeURIComponent(dojo.toJson(event));this.server.request('GET',url,null,{log:'Event '+topic+" forwarded."});},bind:function(){var self=this;var url="/event/bind/";this.server.request('GET',url,null,{evalJSON:true,onSuccess:function(info){self.queue=info.queue;var topics=info.topics;dojo.forEach(topics,function(topic){bespin.subscribe(topic,function(event){self.forward(topic,event);});});self.listen();}});}});bespin.subscribe("bind",function(){var proxy=new bespin.client.pubsub.Proxy();proxy.bind();});
dojo.provide("bespin.editor.dependencies");dojo.require("dojo.cookie");dojo.require("dojo.fx.easing");dojo.require("bespin.bespin");dojo.require("bespin.command");dojo.require("bespin.events");dojo.require("bespin.util.canvas");dojo.require("bespin.util.keys");dojo.require("bespin.util.navigate");dojo.require("bespin.util.path");dojo.require("bespin.util.tokenobject");dojo.require("bespin.util.util");dojo.require("bespin.util.mousewheelevent");dojo.require("bespin.util.webpieces");dojo.require("bespin.client.filesystem");dojo.require("bespin.client.settings");dojo.require("bespin.client.status");dojo.require("bespin.client.server");dojo.require("bespin.client.session");dojo.require("bespin.worker.worker");dojo.require("bespin.editor.actions");dojo.require("bespin.editor.clipboard");dojo.require("bespin.editor.cursor");dojo.require("bespin.editor.editor");dojo.require("bespin.editor.events");dojo.require("bespin.editor.model");dojo.require("bespin.editor.toolbar");dojo.require("bespin.editor.history");dojo.require("bespin.editor.quickopen");dojo.require("bespin.editor.formatter");dojo.require("bespin.editor.codecompletion");dojo.require("bespin.themes.default");dojo.require("bespin.syntax.base");dojo.require("bespin.syntax.simple._base");dojo.require("bespin.parser.parser");dojo.require("bespin.cmd.cmd");dojo.require("bespin.cmd.config");dojo.require("bespin.cmd.editor");dojo.require("bespin.cmd.file");dojo.require("bespin.cmd.other");dojo.require("bespin.cmd.project");dojo.require("bespin.test");dojo.require("bespin.testTest");dojo.require("bespin.plugins");dojo.require("bespin.plugins.loader");dojo.require("bespin.plugins.loaderTest");dojo.require("bespin.preview");dojo.require("bespin.test");dojo.require("bespin.testTest");dojo.require("bespin.wizard");dojo.require("bespin.wizardTest");dojo.require("bespin.social");dojo.require("bespin.socialTest");dojo.require("bespin.mobwrite.core");dojo.require("bespin.mobwrite.diff");dojo.require("bespin.mobwrite.integrate");dojo.require("bespin.client.pubsub");
dojo.provide("bespin.editor.component");dojo.require("bespin.editor.dependencies");dojo.declare("bespin.editor.Component",null,{constructor:function(container,opts){opts.actsAsComponent=true;var initialcontent;if(opts.loadfromdiv){if(dojo.byId('BESPIN_EDITOR_CODE')){var code=dojo.byId('BESPIN_EDITOR_CODE');initialcontent=code.value;}else{initialcontent=dojo.byId(container).innerHTML;}}else if(opts.content){initialcontent=opts.content;}
this.editor=bespin.register('editor',opts.editor||new bespin.editor.API(container,opts));this.editSession=bespin.register('editSession',opts.editSession||new bespin.client.session.EditSession(this.editor));this.server=bespin.register('server',opts.server||new bespin.client.Server());this.files=bespin.register('files',opts.files||new bespin.client.FileSystem());if(opts.commandline){dojo["require"]("bespin.cmd.commandline");var commandlineElement;if(typeof opts.commandline=="boolean"){commandlineElement=dojo.create("div",{id:"commandlinewrapper",hidden:true},dojo.body());commandlineElement.innerHTML='<table style="display: none;" cellpadding="0"><tr><td id="prompt"><img id="promptimg" src="https://bespin.mozilla.com/images/icn_command.png" alt=">" ></td><td id="commandline"><input id="command" spellcheck="false"></td></tr></table>';}else{commandlineElement=dojo.byId(opts.commandline);}
this.commandLine=bespin.register('commandLine',new bespin.cmd.commandline.Interface(commandlineElement,bespin.command.Store));}
bespin.register('settings',opts.settings||new bespin.client.settings.Core(bespin.client.settings.InMemory));if(opts.jetpack){var jetpacktoolbar=dojo.create("div",{id:"jetpacktoolbar"},dojo.byId(container));jetpacktoolbar.innerHTML='<div class="button"><button id="install" onclick="_editorComponent.executeCommand(\'jetpack install yourfirstjetpack\')">&uarr; Install This JetPack Feature</button></div>\
            <div>Hey, <a href="https://jetpack.mozillalabs.com/">install JetPack first</a>.</div>\
            <style type="text/css">\
                #jetpacktoolbar {\
                    position: relative;\
                    top: -15px;\
                    left: 0;\
                    height: 40px;\
                    background-image: url(https://bespin.mozilla.com/images/footer_bg.png);\
                    background-repeat: repeat-x;\
                    color: white;\
                    font-family: Helvetica, Arial, sans-serif;\
                    font-size: 11px;\
                }\
                #jetpacktoolbar div {\
                    padding: 17px 12px;\
                    float: left;\
                }\
                #jetpacktoolbar div.button {\
                    float: right;\
                    padding: 13px 0;\
                }\
                #jetpacktoolbar button {\
                    margin:0 7px 0 0;\
                }\
                #jetpacktoolbar a {\
                    color: #eee;\
                }\
            </style>';}
dojo.connect(window,'resize',opts.resize||dojo.hitch(this,function(){this.editor.paint();}));if(initialcontent){this.setContent(initialcontent);}
if(opts.language){bespin.publish("settings:language",{language:opts.language});}
if(!opts.dontstealfocus){this.editor.canvas.focus();}
if(opts.set){for(var key in opts.set){if(opts.set.hasOwnProperty(key)){this.set(key,opts.set[key]);}}}},getContent:function(){return this.editor.model.getDocument();},setContent:function(content){return this.editor.model.insertDocument(content);},setFocus:function(bool){return this.editor.setFocus(bool);},setLineNumber:function(linenum){bespin.get("editor").moveAndCenter(linenum);},set:function(key,value){bespin.publish("settings:set",{key:key,value:value});},onchange:function(callback){bespin.subscribe("editor:document:changed",callback);},bindKey:function(opts){bespin.get('editor').bindKey(opts.action,opts.modifiers+' '+opts.key);},executeCommand:function(command){try{this.commandLine.executeCommand(command);}catch(e){}},dispose:function(){this.editor.dispose();}});
dojo.provide("bespin.syntax.simple.javascript");bespin.syntax.JavaScriptConstants={C_STYLE_COMMENT:"c-comment",LINE_COMMENT:"comment",STRING:"string",KEYWORD:"keyword",PUNCTUATION:"punctuation",OTHER:"plain"};dojo.declare("bespin.syntax.simple.JavaScript",null,{keywords:' abstract boolean break byte case catch char class const continue debugger '+'default delete do double else enum export extends false final finally float '+'for function goto if implements import in instanceof int interface let long native '+'new null package private protected public return short static super switch '+'synchronized this throw throws transient true try typeof var void volatile while with ',punctuation:'{ } > < / + - % * . , ; ( ) ? : = " \''.split(" "),highlight:function(line,meta){if(!meta)meta={};var K=bespin.syntax.JavaScriptConstants;var regions={};var currentStyle=(meta.inMultilineComment)?K.C_STYLE_COMMENT:undefined;var currentRegion={};var buffer="";var stringChar="";var multiline=meta.inMultilineComment;for(var i=0;i<line.length;i++){var c=line.charAt(i);if(currentStyle==K.C_STYLE_COMMENT){if(c=="/"&&/\*$/.test(buffer)){currentRegion.stop=i+1;this.addRegion(regions,currentStyle,currentRegion);currentRegion={};currentStyle=undefined;multiline=false;buffer="";}else{if(buffer=="")currentRegion={start:i};buffer+=c;}
continue;}
if(this.isWhiteSpaceOrPunctuation(c)){if(currentStyle==K.STRING){if(!(c==stringChar&&!/\\$/.test(buffer))){if(buffer=="")currentRegion={start:i};buffer+=c;continue;}}
if(buffer!=""){currentRegion.stop=i;if(currentStyle!=K.STRING){if(this.keywords.indexOf(" "+buffer+" ")>-1){currentStyle=K.KEYWORD;}else{currentStyle=K.OTHER;}}
this.addRegion(regions,currentStyle,currentRegion);currentRegion={};stringChar="";buffer="";}
if(this.isPunctuation(c)){if(c=="*"&&i>0&&(line.charAt(i-1)=="/")){regions[K.PUNCTUATION].pop();multiline=true;currentStyle=K.C_STYLE_COMMENT;currentRegion={start:i-1};buffer="/*";continue;}
if(c=='/'&&i>0&&(line.charAt(i-1)=='/')){currentRegion={start:i-1,stop:line.length};currentStyle=K.LINE_COMMENT;this.addRegion(regions,currentStyle,currentRegion);buffer="";currentStyle=undefined;currentRegion={};break;}
this.addRegion(regions,K.PUNCTUATION,{start:i,stop:i+1});}
if((c=="'"||c=='"')&&(currentStyle!=K.STRING)){currentStyle=K.STRING;stringChar=c;}else{currentStyle=undefined;}
continue;}
if(buffer=="")currentRegion={start:i};buffer+=c;}
if(buffer!=""){if(!currentStyle)currentStyle=K.OTHER;currentRegion.stop=line.length;this.addRegion(regions,currentStyle,currentRegion);}
var newMeta={inMultilineComment:multiline};if(meta.inJavaScript)newMeta.inJavaScript=meta.inJavaScript;return{regions:regions,meta:newMeta};},addRegion:function(regions,type,data){if(!regions[type])regions[type]=[];regions[type].push(data);},isWhiteSpaceOrPunctuation:function(ch){return this.isPunctuation(ch)||this.isWhiteSpace(ch);},isPunctuation:function(ch){return this.punctuation.indexOf(ch)!=-1;},isWhiteSpace:function(ch){return ch==" ";}});
dojo.provide("bespin.syntax.simple.html");bespin.syntax.HTMLConstants={HTML_STYLE_COMMENT:"comment",STRING:"string",KEYWORD:"keyword",PUNCTUATION:"punctuation",OTHER:"plain",ATTR_NAME:"attname"};dojo.declare("bespin.syntax.simple.HTML",null,{punctuation:'< > = " \'',highlight:function(line,meta){if(!meta)meta={};var K=bespin.syntax.HTMLConstants;var regions={};var currentStyle=(meta.inMultilineComment)?K.HTML_STYLE_COMMENT:undefined;var currentRegion={};var buffer="";var stringChar="";var multiline=meta.inMultilineComment;if(meta.inJavaScript){if(line.indexOf('</script>')>0){meta.inJavaScript=false;}else{return bespin.syntax.simple.Resolver.resolve("js").highlight(line,meta);}}else{meta.inJavaScript=false;}
if(line.indexOf('<script')>0){meta.inJavaScript=true;}
for(var i=0;i<line.length;i++){var c=line.charAt(i);if(currentStyle==K.HTML_STYLE_COMMENT){if(c==">"&&bespin.util.endsWith(buffer,"--")&&!(/<!--/.test(buffer)&&!meta.inMultiLineComment&&currentRegion.start==i-4)&&!(/<!---/.test(buffer)&&!meta.inMultiLineComment&&currentRegion.start==i-5)){currentRegion.stop=i+1;this.addRegion(regions,currentStyle,currentRegion);currentRegion={};currentStyle=undefined;multiline=false;buffer="";}else{if(buffer=="")currentRegion={start:i};buffer+=c;}
continue;}
if(this.isWhiteSpaceOrPunctuation(c)){if(currentStyle==K.STRING){if(!(c==stringChar&&!/\\$/.test(buffer))){if(buffer=="")currentRegion={start:i};buffer+=c;continue;}}
if(buffer!=""){currentRegion.stop=i;if(currentStyle!=K.STRING){if(line.charAt(currentRegion.start-1)=='<'){currentStyle=K.KEYWORD;}else if(line.charAt(currentRegion.stop)=='='){currentStyle=K.ATTR_NAME;}else{currentStyle=K.OTHER;}}
this.addRegion(regions,currentStyle,currentRegion);currentRegion={};stringChar="";buffer="";}
if(this.isPunctuation(c)){if(c=="<"&&(line.length>i+3)&&(line.substring(i,i+4)=="<!--")){multiline=true;currentStyle=K.HTML_STYLE_COMMENT;currentRegion={start:i};buffer="<!--";i+=3;continue;}
this.addRegion(regions,K.PUNCTUATION,{start:i,stop:i+1});}
if((c=="'"||c=='"')&&(currentStyle!=K.STRING)){currentStyle=K.STRING;stringChar=c;}else{currentStyle=undefined;}
continue;}
if(buffer=="")currentRegion={start:i};buffer+=c;}
if(buffer!=""){if(!currentStyle)currentStyle=K.OTHER;currentRegion.stop=line.length;this.addRegion(regions,currentStyle,currentRegion);}
return{regions:regions,meta:{inMultilineComment:multiline,inJavaScript:meta.inJavaScript}};},addRegion:function(regions,type,data){if(!regions[type])regions[type]=[];regions[type].push(data);},isWhiteSpaceOrPunctuation:function(ch){return this.isPunctuation(ch)||this.isWhiteSpace(ch);},isPunctuation:function(ch){return this.punctuation.indexOf(ch)!=-1;},isWhiteSpace:function(ch){return ch==" ";}});
bespin.editor.Actions.prototype.find=function(args){this.editor.ui.setSearchString(args.string);var a={event:""};var w=args.which;if(w=="first"){this.moveToFileTop(a);}else if(w=="last"){this.moveToFileBottom(a);}
var up=w=="last"||w=="previous";var once=w=="first"||w=="last";var m=up?"findPrev":"findNext";var r=this[m]();if(!args.highlight){this.editor.ui.setSearchString("");}
if(!args.select){this.editor.setSelection(undefined);}
return args.result=r;};bespin.editor.Actions.prototype.getRowText=function(args){if(args.row==undefined){args.row=this.cursorManager.getCursorPosition().row;}
args.result=this.editor.model.getRowArray(args.row).join('');return args.result;};bespin.editor.Actions.prototype.getCursorRow=function(args){args=args||{};args.result=this.cursorManager.getCursorPosition().row;return args.result;};bespin.editor.Actions.prototype.rowHasNonWhiteSpace=function(args){var t=this.getRowText(args);args=args||{};args.result=Boolean(t.match(/\S/));return args.result;};bespin.editor.Actions.prototype.moveCursorPrevTextRow=function(args){var row=this.cursorManager.getCursorPosition().row-1;while(row>=0&&!this.rowHasNonWhiteSpace({row:row})){row--;}
this.editor.moveAndCenter(row+1);args.result=row;return args.result;};bespin.editor.Actions.prototype.moveCursorLastTextRow=function(args){this.moveToFileBottom(args);if(!this.rowHasNonWhiteSpace({row:this.getCursorRow()})){this.moveCursorPrevTextRow(args);}};bespin.editor.Actions.prototype.getCursorPosition=function(args){args.result=this.cursorManager.getCursorPosition();return args.result;};bespin.editor.Actions.prototype.getSelection=function(args){args.result=this.editor.getSelectionAsText();return args.result;}
bespin.editor.Actions.prototype.moveCursorPosition=function(args){this.cursorManager.moveCursor(args);this.handleCursorSelection(args);this.repaint();};
opus.Class("opus.bespin.Editor",{isa:opus.Control,published:{script:{value:""},theme:{value:"default"},language:{value:"js"},onkeydown:{event:"dokeydown"}},destroy:function(){this.destroyEditor();this.inherited(arguments);},destroyEditor:function(){opus.apply(this.editor,"destroy");},nodeRendered:function(){this.inherited(arguments);this.renderEditor();},hasEditor:function(){return this.editor;},renderEditor:function(){if(!this.hasEditor()){try{if(window["bespin"]){bespin.themes['default']=bespin.themes[this.theme];this.editor=new bespin.editor.Component(this.node,{language:this.language,content:this.script});var settings=bespin.get("settings");if(settings){settings.set("tabmode","on");settings.set("autoindent","on");}
this.captureKeys();}}catch(e){this.editor=null;}}else if(this.editor.editor.container.parentNode!=this.node){this.node.appendChild(this.editor.editor.container);}},renderBounds:function(){this.inherited(arguments);if(this.hasEditor()){this.editor.editor.paint();}},languageChanged:function(){bespin.publish("settings:language",{language:this.language});},scriptChanged:function(){if(this.hasEditor()){this.editor.setContent(this.script);}},getState:function(){if(this.hasEditor()){var e=this.editor.editor;return{historyManager:e.historyManager,modelState:{history:[].concat(e.model.history),historyIndex:e.model.historyIndex},editorState:e.getState()}}},clearState:function(){if(this.hasEditor()){var state={historyManager:new bespin.editor.HistoryManager(this.editor.editor),modelState:{history:[],historyIndex:-1},editorState:{cursor:{row:0,col:0}}}
this.restoreState(state);}},restoreState:function(inState){if(this.hasEditor()&&inState){var e=this.editor.editor;e.historyManager=inState.historyManager;var sm=inState.modelState;e.model.history=sm.history;e.model.historyIndex=sm.historyIndex;e.setState(inState.editorState);}},getScript:function(){return this.script=this.hasEditor()?this.editor.getContent():this.script;},showingChanged:function(){this.inherited(arguments);if(this.showing){this.focus();}else{this.closeFind();this.blur();}},doAction:function(inAction,inArgs){if(this.hasEditor()){inArgs=inArgs||{};if(!inArgs.event){inArgs.event="";}
var a=this.editor.editor.ui.actions;a[inAction].apply(a,dojo.isArray(inArgs)?inArgs:[inArgs]);return inArgs.result;}},setLineNumber:function(inLine){if(this.hasEditor()){this.focus();this.editor.setLineNumber(inLine);}},getRowCount:function(){return this.hasEditor()?this.editor.editor.model.getRowCount():0;},getCursorRow:function(){return this.doAction("getCursorRow");},getSelection:function(){return this.doAction("getSelection");},getCursorPosition:function(){return this.doAction("getCursorPosition");},fetchRowText:function(inRow){return this.doAction("getRowText",{row:inRow});},_find:function(inArgs){inArgs=kit.isString(inArgs)?{which:"first",string:inArgs}:inArgs;this.doAction("find",inArgs);return inArgs.result;},find:function(inFind){return this._find({string:inFind,which:"next",select:true,xhighlight:true});},replace:function(inFind,inReplace){if(this.getSelection().toLowerCase()!=inFind.toLowerCase()){this.find(inFind);}
if(this.getSelection().toLowerCase()==inFind.toLowerCase()){console.log("replacing");this.insertAtCursor(inReplace);}},replaceAll:function(inFind,inReplace){this.doAction("replace",{search:inFind,replace:inReplace});},movePrevTextRow:function(){this.doAction("moveCursorPrevTextRow");},moveToLineStart:function(){this.doAction("moveToLineStart");},moveToLineEnd:function(){this.doAction("moveToLineEnd");},moveCursorDown:function(){this.doAction("moveCursorDown");},moveCursorUp:function(){this.doAction("moveCursorUp");},moveToLineStartText:function(){this.moveToLineEnd();if(this.doAction("rowHasNonWhiteSpace")){this.moveToLineStart();}},moveCursorPosition:function(inPosition){this.doAction("moveCursorPosition",inPosition);},insertAtCursor:function(inText){this.doAction("insertChunk",{chunk:inText,pos:0,queued:0});},clickHandler:function(e){this.focus();},focus:function(){if(this.hasEditor()){this.blur();this.editor.setFocus(true);}},deferFocus:function(){opus.job(this.globalId+"-focus",kit.hitch(this,this.focus),1);},blur:function(){if(this.hasEditor()){this.editor.editor.canvas.blur();}},captureKeys:function(){this.node.addEventListener("keydown",kit.hitch(this,"doCaptureKeydown"),true);this.node.addEventListener("keypress",kit.hitch(this,"doCaptureKeypress"),true);},handleKeydown:function(e){if(e.ctrlKey||e.metaKey){var key=String.fromCharCode(e.keyCode);switch(key){case"F":case"R":this.doFind();return true;}}},doCaptureKeydown:function(e){this.shouldFilterKey=this.handleKeydown(e)||this.dokeydown(e);return this.filterKey(e);},doCaptureKeypress:function(e){return this.filterKey(e);},filterKey:function(e){if(this.shouldFilterKey){kit.stopEvent(e);return false;}},doFind:function(){var fp=this.$.findPopup;if(!fp){fp=this.makeFindPopup();fp.render();}
if(!fp.showing){fp.open();}},makeFindPopup:function(){return this.createComponent({name:"findPopup",type:"opus.bespin.Editor.findPopup",onfind:"findClick",onreplace:"replaceClick",onreplaceall:"replaceAllClick",onclose:"findCloseClick"},{owner:this,parent:this.owner});},findClick:function(inSender,inFind){this.find(inFind);},replaceClick:function(inSender,inFind,inReplace){this.replace(inFind,inReplace);},replaceAllClick:function(inSender,inFind,inReplace){this.replaceAll(inFind,inReplace);},findCloseClick:function(){this.editor.editor.ui.setSearchString("");this.deferFocus();},closeFind:function(){if(this.$.findPopup){this.$.findPopup.close();}}});opus.Class("opus.bespin.Editor.findPopup",{isa:opus.Popup,modal:false,styles:{border:0},width:360,height:150,published:{onfind:{event:"doFind"},onreplace:{event:"doReplace"},onreplaceall:{event:"doReplaceAll"},onclose:{event:"doClose"}},chrome:[{type:"opus.Aristo.Window",w:"100%",h:"100%",clientLayoutKind:"vbox",caption:"Find and Replace",controls:[{h:"100%",w:"100%",layoutKind:"vbox",styles:{padding:4},controls:[{name:"findField",type:"Field",caption:"Find:",width:"100%",labelWidth:60,h:30,styles:{marginBottom:6}},{name:"replaceField",type:"Field",caption:"Replace:",width:"100%",labelWidth:60},{h:"100%",w:"100%"},{height:36,width:"290",horizontalAlign:"right",layoutKind:"hbox",controls:[{type:"opus.Aristo.Button",width:"100%",caption:"Find",onclick:"findClick"},{type:"opus.Aristo.Button",width:"100%",caption:"Replace",onclick:"replaceClick"},{type:"opus.Aristo.Button",width:"100%",caption:"Replace All",onclick:"replaceAllClick"}]}]}]}],findClick:function(inSender){this.doFind(this.$.findField.getValue());},replaceClick:function(inSender){this.doReplace(this.$.findField.getValue(),this.$.replaceField.getValue());},replaceAllClick:function(inSender){this.doReplaceAll(this.$.findField.getValue(),this.$.replaceField.getValue());},_open:function(){this.inherited(arguments);this.$.findField.focus();},close:function(){this.inherited(arguments);this.doClose();},keydownHandler:function(e,inTarget){switch(e.keyCode){case dojo.keys.ENTER:var n=inTarget.owner.name;if(n=="findField"){this.findClick();}
return true;case dojo.keys.ESCAPE:this.close();return true;}},mousedownHandler:function(){}});