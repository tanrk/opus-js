/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

/*
	This is a compiled version of Dojo, built for deployment and not for
	development. To get an editable version, please visit:

		http://dojotoolkit.org

	for documentation and information on getting the source.
*/

if(!dojo._hasResource["bespin.bespin"]){dojo._hasResource["bespin.bespin"]=true;dojo.provide("bespin.bespin");dojo.mixin(bespin,{versionNumber:"tip",versionCodename:"DEVELOPMENT MODE",apiVersion:"dev",defaultTabSize:4,userSettingsProject:"BespinSettings",_eventLog:{},_lazySubscriptionCount:0,_lazySubscriptionTimeout:{},publish:function(_1,_2){if(window.globalStorage&&window.globalStorage[location.hostname].debug){console.log("Publish",_1,_2);}bespin._eventLog[_1]=true;dojo.publish("bespin:"+_1,dojo.isArray(_2)?_2:[_2||{}]);},fireAfter:function(_3,_4){if(!dojo.isArray(_3)){throw new Error("fireAfter() takes an array of topics. '"+_3+"' is not an array.");}var _5=_3.length;var _6=function(){if(_5==0){_4();}};for(var i=0;i<_3.length;++i){var _7=_3[i];if(bespin._eventLog[_7]){--_5;}else{bespin.subscribe(_7,function(){--_5;_6();});}_6();}},subscribe:function(_8,_9,_a){if(_a){var _b=_9;var _c=this._lazySubscriptionCount++;var _d=this;_9=function(){if(_d._lazySubscriptionTimeout[_c]){clearTimeout(_d._lazySubscriptionTimeout[_c]);}_d._lazySubscriptionTimeout[_c]=setTimeout(function(){_b.apply(_d,arguments);delete _d._lazySubscriptionTimeout[_c];},_a);};}return dojo.subscribe("bespin:"+_8,_9);},unsubscribe:dojo.unsubscribe,registeredComponents:{},register:function(id,_e){this.registeredComponents[id]=_e;bespin.publish("component:register:"+id,{id:id,object:_e});return _e;},get:function(id){return this.registeredComponents[id];},unregister:function(id){delete this.registeredComponents[id];},withComponent:function(id,_f){var _10=this.get(id);if(_10){return _f(_10);}},getComponent:function(id,_11,_12){_12=_12||window;var _13=bespin.get(id);if(!_13){var _14=bespin.factories[id];if(!_14){return undefined;}_14(_11,_12);return false;}else{_11.call(_12,_13);}return true;},factories:{popup:function(_15,_16){bespin.plugins.loadOne("popup",function(_17){var _18=bespin.register("popup",new _17.Window());_15.call(_16,_18);});},piemenu:function(_19,_1a){bespin.plugins.loadOne("piemenu",function(_1b){bespin.register("piemenu",new _1b.Window());setTimeout(function(){var _1c=bespin.get("piemenu");_19.call(_1a,_1c);},25);});},commandLine:function(_1d,_1e){bespin.plugins.loadOne("commandLine",function(_1f){var _20=bespin.register("commandLine",new _1f.Interface("command",bespin.command.store));_1d.call(_1e,_20);});},debugbar:function(_21,_22){bespin.plugins.loadOne("debugbar",function(_23){var _24=bespin.register("debugbar",new _23.EvalCommandLineInterface("debugbar_command",null,{idPrefix:"debugbar_",parentElement:dojo.byId("debugbar")}));_21.call(_22,_24);});},breakpoints:function(_25,_26){bespin.plugins.loadOne("breakpoints",function(_27){var _28=bespin.register("breakpoints",new _27());_25.call(_26,_28);});}},displayVersion:function(el){el=dojo.byId(el)||dojo.byId("version");if(!el){return;}el.innerHTML="<a href=\"https://wiki.mozilla.org/Labs/Bespin/ReleaseNotes\" title=\"Read the release notes\">Version <span class=\"versionnumber\">"+this.versionNumber+"</span> \""+this.versionCodename+"\"</a>";},_subscribeToExtension:function(key){bespin.subscribe("extension:removed:"+key,function(){var _29=bespin.get(key);if(_29&&_29.destroy){_29.destroy();}bespin.unregister(key);});},_initializeReloaders:function(){for(var key in bespin.factories){bespin._subscribeToExtension(key);}}});bespin.subscribe("extension:loaded:bespin.subscribe",function(ext){var _2a=bespin.subscribe(ext.topic,function(e){ext.load(function(_2b){_2b(e);});});ext.subscription=_2a;});bespin.subscribe("extension:removed:bespin.subscribe",function(ext){if(ext.subscription){bespin.unsubscribe(ext.subscription);}});bespin._initializeReloaders();}if(!dojo._hasResource["bespin.command"]){dojo._hasResource["bespin.command"]=true;dojo.provide("bespin.command");dojo.declare("bespin.command.Store",null,{constructor:function(_2c,_2d){this.commands={};this.aliases={};if(_2c){this.containerCommand=_2d;this.parent=_2c;_2d.takes=["*"];_2d.subcommands=this;_2c.addCommand(_2d);}},addCommand:function(_2e){if(!_2e){return;}_2e.parent=this;this.commands[_2e.name]=_2e;if(_2e.takes&&dojo.isArray(_2e.takes)){_2e=this.normalizeTakes(_2e);}if(_2e.withKey){bespin.fireAfter(["component:register:editor"],function(){bespin.get("editor").bindCommand(_2e.name,_2e.withKey);});}if(_2e.aliases){dojo.forEach(_2e.aliases,function(_2f){this.aliases[_2f]=_2e.name;},this);}_2e.getFullCommandName=function(){var _30=this.name;if(this.parent){_30=this.parent.getFullCommandName()+" "+_30;}return dojo.trim(_30);};if(!_2e.findCompletions){_2e.findCompletions=function(_31,_32){_31.hint=this.completeText;_32(_31);};}},removeCommand:function(_33){if(!_33){return;}delete this.commands[_33.name];},getFullCommandName:function(){var _34=this.containerCommand?this.containerCommand.name:"";if(this.parent){_34=this.parent.getFullCommandName()+" "+_34;}return dojo.trim(_34);},filterOptionsByPrefix:function(_35,_36){return _35.filter(function(_37){return _37.substr(0,_36.length)===_36;});},findCommand:function(_38){var _39=dojo.trim(_38).split(/\s+/);var _3a=_39.shift();var _3b=this.commands[_3a]||this.commands[this.aliases[_3a]];if(!_3b){if(_39.length>0){return null;}else{return this;}}if(_3b.subcommands){return _3b.subcommands.findCommand(_39.join(" "));}else{return _3b;}},findCompletions:function(_3c,_3d){if(_3c.action.length>1){_3c.error="No matches";_3d(_3c);return;}var _3e=_3c.action[0];if(_3e.length==0&&this.parent==null){_3d(_3c);return;}var _3f=[];for(var _40 in this.commands){if(_40.indexOf(_3e)==0){_3f.push(_40);}}for(var _41 in this.aliases){if(_41.indexOf(_3e)==0){_3f.push(_41);}}if(_3f.length==1){var _42=_3f[0];var _40=this.commands[_42]||this.commands[this.aliases[_42]];if(this.commandTakesArgs(_40)){_42=_42+" ";}_3c.autofill=_3c.prefix+_42;_3c.hint=_40.preview;}else{if(_3f.length==0){_3c.error="No matches";}else{_3f.sort(function(a,b){return a.localeCompare(b);});_3c.options=_3f;}}_3d(_3c);return;},commandTakesArgs:function(_43){return _43.takes!=undefined;},getArgs:function(_44,_45){if(!_45.takes){return undefined;}var _46;var _47=_44.join(" ");if(_45.takes["*"]){_46=new bespin.util.TokenObject(_47);_46.rawinput=_47;_46.varargs=_46.pieces;}else{if(_45.takes&&_45.takes.order.length<2){_46=_47;}else{_46=new bespin.util.TokenObject(_47,{params:_45.takes.order.join(" ")});_46.rawinput=_47;}}return _46;},normalizeTakes:function(_48){var _49=_48.takes;_48.takes={order:_49};dojo.forEach(_49,function(_4a){_48.takes[_4a]={"short":_4a[0]};});return _48;},getHelp:function(_4b,_4c){var _4d=[];var _4e,_4f;if(this.commands[_4b]){_4e=this.commands[_4b];_4d.push(_4e["description"]?_4e.description:_4e.preview);}else{var _50=false;var _51="";if(this.containerCommand){_51=" for "+this.containerCommand.name;}if(_4b){if(_4b=="hidden"){_4b="";_50=true;}_4d.push("<h2>Commands starting with '"+_4b+"':</h2>");}else{_4d.push("<h2>Available Commands:</h2>");}var _52=[];for(_4f in this.commands){_52.push(_4f);}var _53=_52.sort();_4d.push("<table>");for(var i=0;i<_53.length;i++){_4f=_53[i];_4e=this.commands[_4f];if(!_50&&_4e.hidden){continue;}if(_4b&&_4f.indexOf(_4b)!=0){continue;}var _54=(_4e.takes)?" ["+_4e.takes.order.join("] [")+"]":"";_4d.push("<tr>");_4d.push("<th>"+_4f+"</th>");_4d.push("<td>"+_4e.preview+"</td>");_4d.push("<td>"+_54+"</td>");_4d.push("</tr>");}_4d.push("</table>");}var _55=_4d.join("");if(_4c&&_4c.prefix){_55=_4c.prefix+"<br/>"+_55;}if(_4c&&_4c.suffix){_55=_55+"<br/>"+_4c.suffix;}return _55;}});dojo.mixin(bespin.command,{store:new bespin.command.Store(),executeExtensionCommand:function(){var _56=arguments;var _57=this;this.load(function(_58){_58.apply(_57,_56);});}});bespin.subscribe("extension:loaded:bespin.command",function(ext){ext.execute=bespin.command.executeExtensionCommand;bespin.command.store.addCommand(ext);});bespin.subscribe("extension:removed:bespin.command",function(ext){bespin.command.store.removeCommand(ext);});bespin.command.store.addCommand({name:"help",takes:["search"],preview:"show commands",description:"The <u>help</u> gives you access to the various commands in the Bespin system.<br/><br/>You can narrow the search of a command by adding an optional search params.<br/><br/>If you pass in the magic <em>hidden</em> parameter, you will find subtle hidden commands.<br/><br/>Finally, pass in the full name of a command and you can get the full description, which you just did to see this!",completeText:"optionally, narrow down the search",execute:function(_59,_5a){var _5b=this.parent.getHelp(_5a,{prefix:"<h2>Welcome to Bespin - Code in the Cloud</h2><ul>"+"<li><a href='http://labs.mozilla.com/projects/bespin' target='_blank'>Home Page</a>"+"<li><a href='https://wiki.mozilla.org/Labs/Bespin' target='_blank'>Wiki</a>"+"<li><a href='https://wiki.mozilla.org/Labs/Bespin/UserGuide' target='_blank'>User Guide</a>"+"<li><a href='https://wiki.mozilla.org/Labs/Bespin/Tips' target='_blank'>Tips and Tricks</a>"+"<li><a href='https://wiki.mozilla.org/Labs/Bespin/FAQ' target='_blank'>FAQ</a>"+"<li><a href='https://wiki.mozilla.org/Labs/Bespin/DeveloperGuide' target='_blank'>Developers Guide</a>"+"</ul>",suffix:"For more information, see the <a href='https://wiki.mozilla.org/Labs/Bespin'>Bespin Wiki</a>."});_59.addOutput(_5b);}});}if(!dojo._hasResource["bespin.util.util"]){dojo._hasResource["bespin.util.util"]=true;dojo.provide("bespin.util.util");bespin.util.queryToObject=function(str,_5c){var ret={};var qp=str.split(_5c);var dec=decodeURIComponent;dojo.forEach(qp,function(_5d){if(_5d.length){var _5e=_5d.split("=");var _5f=dec(_5e.shift());var val=dec(_5e.join("="));if(dojo.isString(ret[_5f])){ret[_5f]=[ret[_5f]];}if(dojo.isArray(ret[_5f])){ret[_5f].push(val);}else{ret[_5f]=val;}}});return ret;};bespin.util.endsWith=function(str,end){return str.match(new RegExp(end+"$"));};bespin.util.include=function(_60,_61){return dojo.indexOf(_60,_61)>-1;};bespin.util.indexOfProperty=function(_62,_63,_64){for(var i=0;i<_62.length;i++){if(_62[i][_63]==_64){return i;}}return null;};bespin.util.last=function(_65){if(dojo.isArray(_65)){return _65[_65.length-1];}};bespin.util.shrinkArray=function(_66){var _67=[];var _68=true;dojo.forEach(_66.reverse(),function(_69){if(_68&&_69===undefined){return;}_68=false;_67.push(_69);});return _67.reverse();};bespin.util.makeArray=function(_6a,_6b){if(_6a<1){return [];}if(!_6b){_6b=" ";}var _6c=[];for(var i=0;i<_6a;i++){_6c.push(_6b);}return _6c;};bespin.util.leadingSpaces=function(row){var _6d=0;for(var i=0;i<row.length;i++){if(row[i]==" "||row[i]==""||row[i]===undefined){_6d++;}else{return _6d;}}return _6d;};bespin.util.leadingTabs=function(row){var _6e=0;for(var i=0;i<row.length;i++){if(row[i]=="\t"||row[i]==""||row[i]===undefined){_6e++;}else{return _6e;}}return _6e;};bespin.util.leadingWhitespace=function(row){var _6f=[];for(var i=0;i<row.length;i++){if(row[i]==" "||row[i]=="\t"||row[i]==""||row[i]===undefined){_6f.push(row[i]);}else{return _6f;}}return _6f;};bespin.util.englishFromCamel=function(_70){dojo.trim(_70.replace(/([A-Z])/g,function(str){return " "+str.toLowerCase();}));};bespin.util.OS={LINUX:"LINUX",MAC:"MAC",WINDOWS:"WINDOWS"};bespin.util.isMac=function(){return navigator.appVersion.indexOf("Mac")>=0;};bespin.util.isLinux=function(){return navigator.appVersion.indexOf("Linux")>=0;};bespin.util.isWindows=function(){return navigator.appVersion.indexOf("Win")>=0;};bespin.util.getOS=function(){if(bespin.util.isMac()){return bespin.util.OS["MAC"];}else{if(bespin.util.isLinux()){return bespin.util.OS["LINUX"];}else{return bespin.util.OS["WINDOWS"];}}};bespin.util.contains=document.compareDocumentPosition?function(a,b){return a.compareDocumentPosition(b)&16;}:function(a,b){return a!==b&&(a.contains?a.contains(b):true);};bespin.util.randomPassword=function(_71){_71=_71||16;var _72="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";var _73="";for(var x=0;x<_71;x++){var _74=Math.floor(Math.random()*_72.length);_73+=_72.charAt(_74);}return _73;};bespin.util.isEmpty=function(_75){for(var x in _75){if(_75.hasOwnProperty(x)){return false;}}return true;};}if(!dojo._hasResource["bespin.events"]){dojo._hasResource["bespin.events"]=true;dojo.provide("bespin.events");bespin.events.toFire=function(_76){var _77={};if(_76.indexOf(";")<0){_77.name=_76;}else{var _78=_76.split(";");_77.name=_78[0];_77.args=bespin.util.queryToObject(_78[1],",");}return _77;};bespin.events.defaultScope=function(){if(bespin.events._defaultScope){return bespin.events._defaultScope;}var _79={bespin:bespin,include:function(_7a){bespin.get("files").evalFile(bespin.userSettingsProject,_7a);},tryTocopyComponent:function(id){bespin.withComponent(id,dojo.hitch(this,function(_7b){this.id=_7b;}));},require:dojo.require,publish:bespin.publish,subscribe:bespin.subscribe};bespin.withComponent("commandLine",function(_7c){_79.commandLine=_7c;_79.execute=function(cmd){_7c.executeCommand(cmd);};});_79.tryTocopyComponent("editor");_79.tryTocopyComponent("editSession");_79.tryTocopyComponent("files");_79.tryTocopyComponent("server");_79.tryTocopyComponent("toolbar");bespin.events._defaultScope=_79;return bespin.events._defaultScope;};}if(!dojo._hasResource["bespin.util.canvas"]){dojo._hasResource["bespin.util.canvas"]=true;dojo.provide("bespin.util.canvas");dojo.mixin(bespin.util.canvas,{fix:function(ctx){if(!ctx.fillText&&ctx.mozDrawText){ctx.fillText=function(_7d,x,y,_7e){ctx.translate(x,y);ctx.mozTextStyle=ctx.font;ctx.mozDrawText(_7d);ctx.translate(-x,-y);};}if(!ctx.measureText&&ctx.mozMeasureText){ctx.measureText=function(_7f){if(ctx.font){ctx.mozTextStyle=ctx.font;}var _80=ctx.mozMeasureText(_7f);return {width:_80};};}if(ctx.measureText&&!ctx.html5MeasureText){ctx.html5MeasureText=ctx.measureText;ctx.measureText=function(_81){var _82=ctx.html5MeasureText(_81);_82.ascent=ctx.html5MeasureText("m").width;return _82;};}if(!ctx.fillText){ctx.fillText=function(){};}if(!ctx.measureText){ctx.measureText=function(){return 10;};}return ctx;}});}if(!dojo._hasResource["bespin.util.keys"]){dojo._hasResource["bespin.util.keys"]=true;dojo.provide("bespin.util.keys");(function(){bespin.util.keys.Key={ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,FORWARD_SLASH:191,TILDE:192,BACK_SLASH:220};dojo.mixin(bespin.util.keys.Key,dojo.keys);var _83=bespin.util.keys.Key;bespin.util.keys.KeyCodeToName={};for(var key in _83){var _84=_83[key];if(typeof _84=="number"){bespin.util.keys.KeyCodeToName[_84]=key;}}})();bespin.util.keys.toKeyCode=function(_85){return bespin.util.keys.Key[_85.toUpperCase()];};bespin.util.keys.fillArguments=function(_86,_87){var _88=_86.split(" ");_87=_87||{};_87.key=_88.pop();if(_88.length==0){_87.modifiers="none";}else{_87.modifiers=_88.join(",");}return _87;};bespin.util.keys.PassThroughCharCodes=dojo.map(["k","l","n","o","t","w","+","-","~","0","1","2","3","4","5","6","7","8","9"],function(_89){return _89.charCodeAt(0);});bespin.util.keys.PassThroughKeyCodes=(function(){var Key=bespin.util.keys.Key;return [Key.C,Key.X,Key.V,Key.K,Key.L,Key.N,Key.O,Key.T,Key.W,Key.NUMPAD_PLUS,Key.NUMPAD_MINUS,Key.TILDE,Key.ZERO,Key.ONE,Key.TWO,Key.THREE,Key.FOUR,Key.FIVE,Key.SIX,Key.SEVEN,Key.EIGHT,Key.NINE];})();bespin.util.keys.passThroughToBrowser=function(e){var Key=bespin.util.keys.Key;if(!e.ctrlKey){return true;}else{if(e.metaKey||e.altKey||e.ctrlKey){if(e.type=="keypress"){var _8a=dojo.some(bespin.util.keys.PassThroughCharCodes,function(_8b){return (_8b==e.charCode);});if(_8a){return true;}}else{var _8a=dojo.some(bespin.util.keys.PassThroughKeyCodes,function(_8c){return (_8c==e.keyCode);});if(_8a){return true;}}}}return false;};}if(!dojo._hasResource["bespin.util.navigate"]){dojo._hasResource["bespin.util.navigate"]=true;dojo.provide("bespin.util.navigate");(function(){var go=function(url,_8d){if(_8d){window.open(url,"_blank");}else{location.href=url;}};dojo.mixin(bespin.util.navigate,{home:function(_8e){go("index.html",_8e);},quickEdit:function(_8f){go("editor.html#new=true",_8f);},editor:function(_90,_91,_92){var url="editor.html#";var _93=[];if(_90){_93.push("project="+_90);}if(_91){_93.push("path="+_91);}if(!_92){_92={};}if(_92.newFile){_93.push("new=true");}if(_92.content){_93.push("content="+escape(_92.content));}if(_93.length>0){url+=_93.join("&");}go(url,_92.newTab);}});})();}if(!dojo._hasResource["bespin.util.path"]){dojo._hasResource["bespin.util.path"]=true;dojo.provide("bespin.util.path");dojo.mixin(bespin.util.path,{combine:function(){var _94=Array.prototype.slice.call(arguments);var _95=_94.join("/");_95=_95.replace(/\/\/+/g,"/");_95=_95.replace(/^\s+|\s+$/g,"");return _95;},directory:function(_96){var _97=_96.split("/");if(_97.length==1){return "";}else{if((_97.length==2)&&_97[_97.length-1]==""){return _96;}else{return _97.slice(0,_97.length-1).join("/");}}},makeDirectory:function(_98){if(!/\/$/.test(_98)){_98+="/";}return _98;},combineAsDirectory:function(){return this.makeDirectory(this.combine.apply(this,arguments));},escape:function(){return escape(this.combine.apply(this,arguments));},fileType:function(_99){if(_99.indexOf(".")>=0){var _9a=_99.split(".");if(_9a.length>1){return _9a[_9a.length-1];}}}});}if(!dojo._hasResource["bespin.util.tokenobject"]){dojo._hasResource["bespin.util.tokenobject"]=true;dojo.provide("bespin.util.tokenobject");dojo.declare("bespin.util.TokenObject",null,{constructor:function(_9b,_9c){this._input=_9b;this._options=_9c||{};this._splitterRegex=new RegExp(this._options.splitBy||"\\s+");this.pieces=this.tokenize(_9b.split(this._splitterRegex));if(this._options.params){this._nametoindex={};var _9d=this._options.params.split(" ");for(var x=0;x<_9d.length;x++){this._nametoindex[_9d[x]]=x;if(!this._options["noshortcutvalues"]){this[_9d[x]]=this.pieces[x];}}}},tokenize:function(_9e){var _9f=[];var _a0;while(_a0=_9e.shift()){if(_a0[0]=="\""||_a0[0]=="'"){var _a1=[_a0.substring(1,_a0.length)];var _a2;while(_a2=_9e.shift()){if(_a2[_a2.length-1]=="\""||_a2[_a2.length-1]=="'"){_a1.push(_a2.substring(0,_a2.length-1));break;}else{_a1.push(_a2);}}_9f.push(_a1.join(" "));}else{_9f.push(_a0);}}return _9f;},param:function(_a3){return (typeof _a3=="number")?this.pieces[_a3]:this.pieces[this._nametoindex[_a3]];},length:function(){return this.pieces.length;}});}if(!dojo._hasResource["bespin.util.mousewheelevent"]){dojo._hasResource["bespin.util.mousewheelevent"]=true;dojo.provide("bespin.util.mousewheelevent");dojo.mixin(bespin.util.mousewheelevent,{wheel:function(_a4){var _a5=0;if(!_a4){_a4=window.event;}if(_a4.wheelDelta){_a5=-_a4.wheelDelta/40;if(window.opera&&window.opera.version()<9.2){_a5=-_a5;}}else{if(_a4.detail){_a5=_a4.detail;}}return _a5;},axis:function(_a6){var _a7="vertical";if(_a6.axis){if(_a6.axis==_a6.HORIZONTAL_AXIS){_a7="horizontal";}}else{if(_a6.wheelDeltaY||_a6.wheelDeltaX){if(_a6.wheelDeltaX==_a6.wheelDelta){_a7="horizontal";}}else{if(_a6.shiftKey){_a7="horizontal";}}}return _a7;}});}if(!dojo._hasResource["bespin.util.urlbar"]){dojo._hasResource["bespin.util.urlbar"]=true;dojo.provide("bespin.util.urlbar");bespin.util.urlbar={last:document.location.hash,check:function(){var _a8=document.location.hash;if(this.last!=_a8){var _a9=new bespin.client.settings.URL(_a8);bespin.publish("url:changed",{was:this.last,now:_a9});this.last=_a8;}}};dojo.addOnLoad(function(){setInterval(function(){bespin.util.urlbar.check();},200);});}if(!dojo._hasResource["dojo.AdapterRegistry"]){dojo._hasResource["dojo.AdapterRegistry"]=true;dojo.provide("dojo.AdapterRegistry");dojo.AdapterRegistry=function(_aa){this.pairs=[];this.returnWrappers=_aa||false;};dojo.extend(dojo.AdapterRegistry,{register:function(_ab,_ac,_ad,_ae,_af){this.pairs[((_af)?"unshift":"push")]([_ab,_ac,_ad,_ae]);},match:function(){for(var i=0;i<this.pairs.length;i++){var _b0=this.pairs[i];if(_b0[1].apply(this,arguments)){if((_b0[3])||(this.returnWrappers)){return _b0[2];}else{return _b0[2].apply(this,arguments);}}}throw new Error("No match found");},unregister:function(_b1){for(var i=0;i<this.pairs.length;i++){var _b2=this.pairs[i];if(_b2[0]==_b1){this.pairs.splice(i,1);return true;}}return false;}});}if(!dojo._hasResource["dijit._base.place"]){dojo._hasResource["dijit._base.place"]=true;dojo.provide("dijit._base.place");dijit.getViewport=function(){var _b3=(dojo.doc.compatMode=="BackCompat")?dojo.body():dojo.doc.documentElement;var _b4=dojo._docScroll();return {w:_b3.clientWidth,h:_b3.clientHeight,l:_b4.x,t:_b4.y};};dijit.placeOnScreen=function(_b5,pos,_b6,_b7){var _b8=dojo.map(_b6,function(_b9){var c={corner:_b9,pos:{x:pos.x,y:pos.y}};if(_b7){c.pos.x+=_b9.charAt(1)=="L"?_b7.x:-_b7.x;c.pos.y+=_b9.charAt(0)=="T"?_b7.y:-_b7.y;}return c;});return dijit._place(_b5,_b8);};dijit._place=function(_ba,_bb,_bc){var _bd=dijit.getViewport();if(!_ba.parentNode||String(_ba.parentNode.tagName).toLowerCase()!="body"){dojo.body().appendChild(_ba);}var _be=null;dojo.some(_bb,function(_bf){var _c0=_bf.corner;var pos=_bf.pos;if(_bc){_bc(_ba,_bf.aroundCorner,_c0);}var _c1=_ba.style;var _c2=_c1.display;var _c3=_c1.visibility;_c1.visibility="hidden";_c1.display="";var mb=dojo.marginBox(_ba);_c1.display=_c2;_c1.visibility=_c3;var _c4=(_c0.charAt(1)=="L"?pos.x:Math.max(_bd.l,pos.x-mb.w)),_c5=(_c0.charAt(0)=="T"?pos.y:Math.max(_bd.t,pos.y-mb.h)),_c6=(_c0.charAt(1)=="L"?Math.min(_bd.l+_bd.w,_c4+mb.w):pos.x),_c7=(_c0.charAt(0)=="T"?Math.min(_bd.t+_bd.h,_c5+mb.h):pos.y),_c8=_c6-_c4,_c9=_c7-_c5,_ca=(mb.w-_c8)+(mb.h-_c9);if(_be==null||_ca<_be.overflow){_be={corner:_c0,aroundCorner:_bf.aroundCorner,x:_c4,y:_c5,w:_c8,h:_c9,overflow:_ca};}return !_ca;});_ba.style.left=_be.x+"px";_ba.style.top=_be.y+"px";if(_be.overflow&&_bc){_bc(_ba,_be.aroundCorner,_be.corner);}return _be;};dijit.placeOnScreenAroundNode=function(_cb,_cc,_cd,_ce){_cc=dojo.byId(_cc);var _cf=_cc.style.display;_cc.style.display="";var _d0=dojo.position(_cc,true);_cc.style.display=_cf;return dijit._placeOnScreenAroundRect(_cb,_d0.x,_d0.y,_d0.w,_d0.h,_cd,_ce);};dijit.placeOnScreenAroundRectangle=function(_d1,_d2,_d3,_d4){return dijit._placeOnScreenAroundRect(_d1,_d2.x,_d2.y,_d2.width,_d2.height,_d3,_d4);};dijit._placeOnScreenAroundRect=function(_d5,x,y,_d6,_d7,_d8,_d9){var _da=[];for(var _db in _d8){_da.push({aroundCorner:_db,corner:_d8[_db],pos:{x:x+(_db.charAt(1)=="L"?0:_d6),y:y+(_db.charAt(0)=="T"?0:_d7)}});}return dijit._place(_d5,_da,_d9);};dijit.placementRegistry=new dojo.AdapterRegistry();dijit.placementRegistry.register("node",function(n,x){return typeof x=="object"&&typeof x.offsetWidth!="undefined"&&typeof x.offsetHeight!="undefined";},dijit.placeOnScreenAroundNode);dijit.placementRegistry.register("rect",function(n,x){return typeof x=="object"&&"x" in x&&"y" in x&&"width" in x&&"height" in x;},dijit.placeOnScreenAroundRectangle);dijit.placeOnScreenAroundElement=function(_dc,_dd,_de,_df){return dijit.placementRegistry.match.apply(dijit.placementRegistry,arguments);};dijit.getPopupAlignment=function(_e0,_e1){var _e2={};dojo.forEach(_e0,function(pos){switch(pos){case "after":_e2[_e1?"BR":"BL"]=_e1?"BL":"BR";break;case "before":_e2[_e1?"BL":"BR"]=_e1?"BR":"BL";break;case "below":_e2[_e1?"BL":"BR"]=_e1?"TL":"TR";_e2[_e1?"BR":"BL"]=_e1?"TR":"TL";break;case "above":default:_e2[_e1?"TL":"TR"]=_e1?"BL":"BR";_e2[_e1?"TR":"TL"]=_e1?"BR":"BL";break;}});return _e2;};dijit.getPopupAroundAlignment=function(_e3,_e4){var _e5={};dojo.forEach(_e3,function(pos){switch(pos){case "after":_e5[_e4?"BR":"BL"]=_e4?"BL":"BR";break;case "before":_e5[_e4?"BL":"BR"]=_e4?"BR":"BL";break;case "below":_e5[_e4?"BL":"BR"]=_e4?"TL":"TR";_e5[_e4?"BR":"BL"]=_e4?"TR":"TL";break;case "above":default:_e5[_e4?"TL":"TR"]=_e4?"BL":"BR";_e5[_e4?"TR":"TL"]=_e4?"BR":"BL";break;}});return _e5;};}if(!dojo._hasResource["bespin.util.webpieces"]){dojo._hasResource["bespin.util.webpieces"]=true;dojo.provide("bespin.util.webpieces");dojo.mixin(bespin.util.webpieces,{showCenterPopup:function(el,_e6){if(_e6){this.showOverlay();}dojo.style(el,"display","block");var _e7=dojo.coords(el);var _e8=dijit.getViewport();var y=(_e8.h-_e7.h)/2;var x=(_e8.w-_e7.w)/2;dojo.style(el,{position:"absolute",top:y+"px",left:x+"px"});},hideCenterPopup:function(el){dojo.style(el,"display","none");this.hideOverlay();},showOverlay:function(){dojo.style("overlay","display","block");},hideOverlay:function(){dojo.style("overlay","display","none");},fillScreenOverlay:function(){var _e9=dojo.coords(document.body);if(_e9.h){dojo.style(dojo.byId("overlay"),"height",_e9.h+"px");}},showStatus:function(msg){dojo.byId("status").innerHTML=msg;dojo.style("status","display","block");},showContentOverlay:function(msg,_ea){_ea=_ea||{};var el=dojo.byId("centerpopup");var _eb="";var _ec="";if(_ea.pre){_eb=_eb+"<pre>";_ec="</pre>"+_ec;}el.innerHTML="<div style='background-color: #fff; border: 1px solid #000; height: 100%; overflow: auto'>"+_eb+msg+_ec+"</div>";oldwidth=el.style.width;oldheight=el.style.height;el.style.width="80%";el.style.height="80%";bespin.util.webpieces.showCenterPopup(el);var _ed=dojo.connect(el,"onclick",function(){bespin.util.webpieces.hideCenterPopup(el);el.style.width=oldwidth;el.style.height=oldheight;dojo.disconnect(_ed);});}});}if(!dojo._hasResource["bespin.client.filesystem"]){dojo._hasResource["bespin.client.filesystem"]=true;dojo.provide("bespin.client.filesystem");dojo.declare("bespin.client.FileSystem",null,{constructor:function(_ee){this.server=_ee||bespin.get("server");},newFile:function(_ef,_f0,_f1,_f2){var _f3=this;this.whenFileDoesNotExist(_ef,_f0,{execute:function(){if(_f3.isCollaborationOn()){bespin.get("editSession").startSession(_ef,_f0||"new.txt",_f1,_f2);}else{bespin.publish("path:changed",{project:_ef,path:_f0});_f1({name:_f0,content:"",timestamp:new Date().getTime()});}},elseFailed:function(){if(dojo.isFunction(_f2)){_f2({responseText:"The file "+_f0+" already exists my friend."});}bespin.get("commandLine").addErrorOutput("The file "+_f0+" already exists my friend.");}});},loadContents:function(_f4,_f5,_f6,_f7){this.server.loadFile(_f4,_f5,function(_f8){if(/\n$/.test(_f8)){_f8=_f8.substr(0,_f8.length-1);}_f6({name:_f5,content:_f8,timestamp:new Date().getTime()});},_f7);},isCollaborationOn:function(){var _f9=bespin.get("settings").isSettingOn("collaborate");if(_f9&&!window.mobwrite){console.log("Missing bespin.mobwrite: Forcing 'collaborate' to off in filesystem.js:collaborateOnFile");_f9=false;}var _fa=bespin.get("serverCapabilities");if(_f9&&_fa.indexOf("collab")==-1){console.log("Server doesn't support collab: Forcing 'collaborate' to off in filesystem.js:collaborateOnFile");_f9=false;}return _f9;},collaborateOnFile:function(_fb,_fc,_fd,_fe){if(this.isCollaborationOn()){bespin.get("editSession").startSession(_fb,_fc,_fd,_fe);}else{this.loadContents(_fb,_fc,_fd,_fe);}},evalFile:function(_ff,_100,_101){_101=_101||bespin.events.defaultScope();if(!_ff||!_100){bespin.get("commandLine").addErrorOutput("Please, I need a project and filename to evaulate");return;}this.loadContents(_ff,_100,function(file){with(_101){try{eval(file.content);}catch(e){var html="There is a error trying to run "+_100+" in project "+_ff+":<br>"+e;bespin.get("commandLine").addErrorOutput(html);}}},true);},projects:function(_102){this.server.projects(_102);},fileNames:function(_103,_104){this.server.list(_103,"",_104);},saveFile:function(_105,file,_106,_107){if(/\n$/.test(file.content)){file.content+="\n";}this.server.saveFile(_105,file.name,file.content,file.lastOp,{onSuccess:function(){console.log("File saved: "+_105+" "+file.name);bespin.publish("file:saved",{project:_105,path:file.name});if(dojo.isFunction(_106)){_106();}},onFailure:_107});},makeDirectory:function(_108,path,_109,_10a){var _10b=function(_10c){bespin.publish("directory:created",{project:_108,path:path});_109(_10c);};this.server.makeDirectory(_108,path,_10b,_10a);},removeDirectory:function(_10d,path,_10e,_10f){var _110=function(_111){bespin.publish("directory:removed",{project:_10d,path:path});_10e(_111);};this.server.removeFile(_10d,path,_110,_10f);},removeFile:function(_112,path,_113,_114){var _115=function(_116){bespin.publish("file:removed",{project:_112,path:path});_113(_116);};this.server.removeFile(_112,path,_115,_114);},closeFile:function(_117,path,_118){this.server.closeFile(_117,path,_118);},whenFileExists:function(_119,path,_11a){this.server.list(_119,bespin.util.path.directory(path),function(_11b){if(_11b&&dojo.some(_11b,function(file){return (file.name==path);})){_11a["execute"]();}else{if(_11a["elseFailed"]){_11a["elseFailed"]();}}},function(xhr){if(_11a["elseFailed"]){_11a["elseFailed"](xhr);}});},whenFileDoesNotExist:function(_11c,path,_11d){this.server.list(_11c,bespin.util.path.directory(path),function(_11e){if(!_11e||!dojo.some(_11e,function(file){return (file.name==path);})){_11d["execute"]();}else{if(_11d["elseFailed"]){_11d["elseFailed"]();}}},function(xhr){_11d["execute"]();});}});}if(!dojo._hasResource["bespin.client.settings"]){dojo._hasResource["bespin.client.settings"]=true;dojo.provide("bespin.client.settings");dojo.declare("bespin.client.settings.Core",null,{constructor:function(_11f){this.browserOverrides={};this.fromURL=new bespin.client.settings.URL();this.customEvents=new bespin.client.settings.Events(this);this.loadStore(_11f);},loadSession:function(){var _120=bespin.get("editSession");var path=this.fromURL.get("path")||_120.path;var _121=this.fromURL.get("project")||_120.project;bespin.publish("settings:init",{path:path,project:_121});},defaultSettings:function(){return {"tabsize":"2","tabmode":"off","tabarrow":"on","fontsize":"10","consolefontsize":"11","autocomplete":"off","closepairs":"off","collaborate":"off","language":"auto","strictlines":"on","syntaxcheck":"off","syntaxengine":"simple","syntaxmarkers":"all","preview":"window","smartmove":"on","jslint":{}};},isOn:function(_122){return _122=="on"||_122=="true";},isOff:function(_123){return _123=="off"||_123=="false"||_123===undefined;},isSettingOn:function(key){return this.isOn(this.get(key));},isSettingOff:function(key){return this.isOff(this.get(key));},loadStore:function(_124){this.store=new (_124||bespin.client.settings.ServerFile)(this);},toList:function(){var _125=[];var _126=this.store.settings;for(var prop in _126){if(_126.hasOwnProperty(prop)){_125.push({"key":prop,"value":_126[prop]});}}return _125;},set:function(key,_127){this.store.set(key,_127);bespin.publish("settings:set:"+key,{value:_127});},setObject:function(key,_128){this.set(key,dojo.toJson(_128));},get:function(key){var _129=this.fromURL.get(key);if(_129){return _129;}return this.store.get(key);},getObject:function(key){try{return dojo.fromJson(this.get(key));}catch(e){console.log("Error in getObject: "+e);return {};}},unset:function(key){this.store.unset(key);},list:function(){if(typeof this.store["list"]=="function"){return this.store.list();}else{return this.toList();}},publishValues:function(){for(var _12a in dojo._topics){var _12b="bespin:settings:set:";if(_12a.indexOf(_12b)==0){var _12c=_12a.substring(_12b.length);bespin.publish("settings:set:"+_12c,{value:this.get(_12c)});}}}});dojo.declare("bespin.client.settings.InMemory",null,{constructor:function(_12d){this.parent=_12d;this.settings=this.parent.defaultSettings();bespin.publish("settings:loaded");},set:function(key,_12e){this.settings[key]=_12e;},get:function(key){return this.settings[key];},unset:function(key){delete this.settings[key];}});dojo.declare("bespin.client.settings.Cookie",null,{constructor:function(_12f){var _130=1;this.cookieSettings={expires:_130/24,path:"/"};var _131=dojo.fromJson(dojo.cookie("settings"));if(_131){this.settings=_131;}else{this.settings={"tabsize":"2","fontsize":"10","autocomplete":"off","collaborate":"off"};dojo.cookie("settings",dojo.toJson(this.settings),this.cookieSettings);}bespin.publish("settings:loaded");},set:function(key,_132){this.settings[key]=_132;dojo.cookie("settings",dojo.toJson(this.settings),this.cookieSettings);},get:function(key){return this.settings[key];},unset:function(key){delete this.settings[key];dojo.cookie("settings",dojo.toJson(this.settings),this.cookieSettings);}});dojo.declare("bespin.client.settings.ServerAPI",null,{constructor:function(_133){this.parent=_133;this.server=bespin.get("server");this.settings=this.parent.defaultSettings();this.server.listSettings(dojo.hitch(this,function(_134){this.settings=_134;if(_134["tabsize"]===undefined){this.settings=this.parent.defaultSettings();this.server.setSettings(this.settings);}bespin.publish("settings:loaded");}));},set:function(key,_135){this.settings[key]=_135;this.server.setSetting(key,_135);},get:function(key){return this.settings[key];},unset:function(key){delete this.settings[key];this.server.unsetSetting(key);}});dojo.declare("bespin.client.settings.ServerFile",null,{constructor:function(_136){this.parent=_136;this.server=bespin.get("server");this.settings=this.parent.defaultSettings();this.loaded=false;this._load();},set:function(key,_137){this.settings[key]=_137;if(key[0]!="_"){this._save();}},get:function(key){return this.settings[key];},unset:function(key){delete this.settings[key];this._save();},_save:function(){if(!this.loaded){return;}var _138="";for(var key in this.settings){if(this.settings.hasOwnProperty(key)){_138+=key+" "+this.settings[key]+"\n";}}bespin.get("files").saveFile(bespin.userSettingsProject,{name:"settings",content:_138,timestamp:new Date().getTime()});},_load:function(){var self=this;var _139=function(){if(!self.loaded){self.loaded=true;bespin.publish("settings:loaded");}};var _13a=function(file){dojo.forEach(file.content.split(/\n/),function(_13b){if(_13b.match(/^\s*#/)){return;}if(_13b.match(/\S+\s+\S+/)){var _13c=_13b.split(/\s+/);self.settings[dojo.trim(_13c[0])]=dojo.trim(_13c[1]);}});self.parent.publishValues();_139();};bespin.fireAfter(["authenticated"],function(){bespin.get("files").loadContents(bespin.userSettingsProject,"settings",_13a,_139);});}});dojo.declare("bespin.client.settings.URL",null,{constructor:function(_13d){this.results=dojo.queryToObject(this.stripHash(_13d||window.location.hash));},get:function(key){return this.results[key];},set:function(key,_13e){this.results[key]=_13e;},stripHash:function(url){var tobe=url.split("");tobe.shift();return tobe.join("");}});dojo.declare("bespin.client.settings.Events",null,{constructor:function(_13f){var _140=bespin.get("editSession");var _141=bespin.get("editor");bespin.subscribe("settings:set",function(_142){var key=_142.key;var _143=_142.value;_13f.set(key,_143);});bespin.subscribe("editor:openfile:opensuccess",function(_144){if(_144.file.name==null){throw new Error("event.file.name falsy");}_140.path=_144.file.name;var _145=bespin.util.path.fileType(_144.file.name);if(_145){bespin.publish("settings:language",{language:_145});}});(function(){var _146={"BespinSettings/config":"js"};bespin.subscribe("editor:openfile:opensuccess",function(_147){var _148=_147.project||bespin.get("editSession").project;var _149=_147.file.name;var _14a=_148+"/"+_149;if(_146[_14a]){bespin.publish("settings:language",{language:_146[_14a]});}});}());bespin.subscribe("settings:set:language",function(_14b){bespin.publish("settings:language",{language:_14b.value,fromCommand:true});});bespin.subscribe("settings:language",function(_14c){var _14d=_14c.language;var _14e=_14c.fromCommand;var _14f=_13f.get("language")||"auto";if(_14d==_141.language){return;}if(bespin.util.include(["auto","on"],_14d)){var path=_13f.fromURL.get("path");if(path){var _150=bespin.util.path.fileType(path);if(_150){_141.language=_150;}}}else{if(bespin.util.include(["auto","on"],_14f)||_14e){_141.language=_14d;}else{if(_14f=="off"){_141.language="off";}}}});bespin.subscribe("settings:set:fontsize",function(_151){var _152=parseInt(_151.value);_141.theme.editorTextFont=_141.theme.editorTextFont.replace(/[0-9]{1,}pt/,_152+"pt");_141.theme.lineNumberFont=_141.theme.lineNumberFont.replace(/[0-9]{1,}pt/,_152+"pt");});bespin.subscribe("settings:set:theme",function(_153){var _154=_153.value;var _155=function(){var _156=bespin.themes[_154];if(_156){if(_156!=_141.theme){_141.theme=_156;bespin.publish("settings:set:fontsize",{value:_13f.get("fontsize")});}return true;}return false;};if(_154){if(_155()){return true;}try{var dr=dojo.require;dr.call(dojo,"bespin.themes."+_154);if(_155()){return true;}}catch(e){console.log("Unable to load theme: "+_154,e);}bespin.get("files").loadContents(bespin.userSettingsProject,"/themes/"+_154+".js",dojo.hitch(this,function(file){try{eval(file.content);}catch(e){console.log("Error with theme loading: ",e);}if(!_155()){bespin.get("commandLine").addErrorOutput("Sorry old chap. No theme called '"+_154+"'. Fancy making it?");}}),function(){bespin.get("commandLine").addErrorOutput("Sorry old chap. No theme called '"+_154+"'. Fancy making it?");});}});bespin.subscribe("settings:set:keybindings",function(_157){if(_157.value=="emacs"){_141.bindKey("moveCursorLeft","ctrl b");_141.bindKey("moveCursorRight","ctrl f");_141.bindKey("moveCursorUp","ctrl p");_141.bindKey("moveCursorDown","ctrl n");_141.bindKey("moveToLineStart","ctrl a");_141.bindKey("moveToLineEnd","ctrl e");}});bespin.subscribe("settings:set:debugmode",function(_158){_141.debugMode=_13f.isOn(_158.value);if(_141.debugMode){bespin.plugins.loadOne("bespin.debugger",function(_159){_159.loadBreakpoints(function(){_141.paint(true);});});}else{_141.paint(true);}});bespin.subscribe("settings:set:cursorblink",function(_15a){var ms=parseInt(_15a.value);if(ms){_141.ui.toggleCursorFrequency=ms;}});var _15b;bespin.subscribe("settings:set:trimonsave",function(_15c){if(_13f.isOn(_15c.value)){_15b=bespin.subscribe("editor:savefile:before",function(_15d){bespin.get("commandLine").executeCommand("trim",true);});}else{bespin.unsubscribe(_15b);}});bespin.subscribe("settings:set:syntaxcheck",function(data){if(_13f.isOff(data.value)){bespin.publish("parser:stop");}else{bespin.publish("parser:start");}});bespin.subscribe("settings:init",function(_15e){if(!_13f.isSettingOn("hidewelcomescreen")&&bespin.wizard){bespin.wizard.show(null,"newuser",false);}if(_15e.path){_141.openFile(_15e.project,_15e.path);}else{var _15f=_13f.getObject("_lastused");if(!_15f){_141.openFile("SampleProject","readme.txt");}else{_141.openFile(_15f[0].project,_15f[0].filename,_15f[0]);}}});bespin.subscribe("settings:init",function(){if(_13f.isOff(_13f.get("autoconfig"))){return;}try{bespin.get("files").evalFile(bespin.userSettingsProject,"config");}catch(e){console.log("Error in user config: ",e);}});}});}if(!dojo._hasResource["bespin.client.status"]){dojo._hasResource["bespin.client.status"]=true;dojo.provide("bespin.client.status");dojo.declare("bespin.client.settings.StatusChecker",null,{constructor:function(){this.interval=0;this.statusMessages=["Bob is editing the file brick.html","Emily is creating a new tag called 'v3.4'","Jessica is saving the file kidly.html","John is idle. Lazy git!","Mickey has checked in a set of 4 files to project 'Bank'","Don has created the function 'doCalculation' in class 'Bank'","Benji is deleting the function 'doCalculation' in class 'Bank'"];},start:function(){this.interval=setInterval(dojo.hitch(this,"updateStatus"),12000);},stop:function(){clearInterval(this.interval);},updateStatus:function(){var _160=this.randomStatus();this.setStatus(_160);},randomStatus:function(){var _161=Math.floor(Math.random()*this.statusMessages.length);return this.statusMessages[_161];},setStatus:function(_162){dojo.byId("message").innerHTML=_162;}});}if(!dojo._hasResource["bespin.client.server"]){dojo._hasResource["bespin.client.server"]=true;dojo.provide("bespin.client.server");dojo.declare("bespin.client.Server",null,{constructor:function(base){this.SERVER_BASE_URL=base||".";this._jobs={};this._jobsCount=0;},_callCallback:function(_163,_164,args){if(dojo.isFunction(_163[_164])){try{_163[_164].apply(null,args);return true;}catch(ex){console.group("Error calling options."+_164+" from server.request");console.log(_163);console.log(_163[_164].toString());console.error(ex);console.trace();console.groupEnd();if(_164=="onSuccess"&&dojo.isFunction(_163["onFailure"])){try{_163.onFailure({responseText:ex.toString()});}catch(ex){console.group("Error calling options.onFailure from server.request");console.error(ex);console.trace();console.groupEnd();}}}}return false;},request:function(_165,url,_166,_167){var _168=this;var xhr=new XMLHttpRequest();if(location.href.indexOf("file:")==0){try{if(netscape.security.PrivilegeManager.enablePrivilege){netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");}}catch(ex){}}if(_167){var _169=function(){if(xhr.readyState==4){if(xhr.status&&xhr.status!=0&&(xhr.status>=200&&xhr.status<300)){var _16a=xhr.responseText;if(_167["evalJSON"]&&_16a){try{_16a=dojo.fromJson(_16a);}catch(syntaxException){console.log("Couldn't eval the JSON: "+_16a+" (SyntaxError: "+syntaxException+")");}}var _16b=_168._callCallback(_167,"onSuccess",[_16a,xhr]);if(!_16b&&_167["log"]){console.log(_167.log);}}else{_16b=_168._callCallback(_167,"on"+xhr.status,[xhr]);if(!_16b){_168._callCallback(_167,"onFailure",[xhr]);}}}};var cl=bespin.get("commandLine");if(cl){_169=cl.link(_169);}xhr.onreadystatechange=_169;xhr.open(_165,this.SERVER_BASE_URL+url,true);this.protectXhrAgainstCsrf(xhr);xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");if(_167.headers){for(var key in _167.headers){if(_167.headers.hasOwnProperty(key)){xhr.setRequestHeader(key,_167.headers[key]);}}}xhr.send(_166);}else{var _16c=this.SERVER_BASE_URL+url;console.log("Are you sure you want to do a synchronous Ajax call? Really? "+_16c);xhr.open(_165,_16c,false);xhr.send(_166);return xhr.responseText;}},protectXhrAgainstCsrf:function(xhr){xhr.setRequestHeader("X-Domain-Token",this.getAntiCsrfToken());},getAntiCsrfToken:function(){var _16d=dojo.cookie("Domain-Token");if(!_16d){_16d=bespin.util.randomPassword();dojo.cookie("Domain-Token",_16d);}return _16d;},requestDisconnected:function(_16e,url,_16f,_170,_171){_171.evalJSON=true;_171.originalOnSuccess=_171.onSuccess;var self=this;_171.onSuccess=function(_172,xhr){if(_172.jobid==null){console.error("Missing jobid",_172);_171.onFailure(xhr);return;}if(_172.taskname){console.log("Server is running : "+_172.taskname);}self._jobs[_172.jobid]={jobid:_172.jobid,options:_171};self._jobsCount++;self._checkPolling();};this.request(_16e,url,_16f,_171);},_checkPolling:function(){if(this._jobsCount==0){return;}if(this._timeout!=null){return;}this._poll();},_processResponse:function(_173){if(_173.jobid===undefined){console.warning("Missing jobid in message",_173);return;}var job=this._jobs[_173.jobid];if(!job){console.debug("job unknown. page reload?",_173,this);return;}if(_173.asyncDone){if(dojo.isArray(job.partials)){job.partials.push(_173.output);job.options.originalOnSuccess(job.partials.join("<br/>"));}else{job.options.originalOnSuccess(_173.output);}}else{if(dojo.isFunction(job.options.onPartial)){job.options.onPartial(_173.output);}else{job.partials.push(_173.output);}}if(_173.asyncDone){if(this._jobsCount>0){this._jobsCount--;}delete this._jobs[_173.jobid];}},_poll:function(){var self=this;this.request("POST","/messages/",null,{evalJSON:true,onSuccess:function(_174){for(var i=0;i<_174.length;i++){self._processResponse(_174[i]);}setTimeout(function(){self._checkPolling();},1000);},onFailure:function(_175){self._processResponse(_175);setTimeout(function(){self._checkPolling();},1000);}});},fetchResource:function(name,_176,_177){this.request("GET",name,null,{onSuccess:_176,onFailure:_177});},login:function(user,pass,_178,_179){var url="/register/login/"+user;this.request("POST",url,"password="+escape(pass),{onSuccess:_178,on401:_179,log:"Login complete."});},signup:function(user,pass,_17a,opts){opts=opts||{};var url="/register/new/"+user;var data="password="+escape(pass)+"&email="+escape(_17a);this.request("POST",url,data,opts);},logout:function(_17b){var url="/register/logout/";this.request("POST",url,null,{log:"Logout complete.",onSuccess:_17b});},currentuser:function(_17c,_17d,_17e){var url="/register/userinfo/";return this.request("GET",url,null,{onSuccess:_17c,on401:_17d,evalJSON:true,onFailure:_17e});},list:function(_17f,path,_180,_181){_17f=_17f||"";var url=bespin.util.path.combine("/file/list/",_17f,path||"/");var opts={onSuccess:_180,evalJSON:true,log:"Listing files in: "+url};if(dojo.isFunction(_181)){opts.onFailure=_181;}this.request("GET",url,null,opts);},listAllFiles:function(_182,_183,_184){_182=_182||"";var url=bespin.util.path.combine("/file/list_all/",_182,"/");var opts={onSuccess:_183,evalJSON:true,log:"Listing all files in: "+url};if(dojo.isFunction(_184)){opts.onFailure=_184;}this.request("GET",url,null,opts);},projects:function(_185){this.request("GET","/file/list/",null,{onSuccess:_185,evalJSON:true});},saveFile:function(_186,path,_187,_188,opts){if(!_186||!path){return;}opts=opts||{};opts.log="Saved file \""+_186+"/"+path+"\"";var url=bespin.util.path.combine("/file/at",_186,(path||""));if(_188){url+="?lastEdit="+_188;}this.request("PUT",url,_187,opts);},loadFile:function(_189,path,_18a,_18b){_189=_189||"";path=path||"";var url=bespin.util.path.combine("/file/at",_189,path);var opts={onSuccess:_18a};if(dojo.isFunction(_18b)){opts.onFailure=_18b;}this.request("GET",url,null,opts);},removeFile:function(_18c,path,_18d,_18e){_18c=_18c||"";path=path||"";var url=bespin.util.path.combine("/file/at",_18c,path);var opts={onSuccess:_18d};if(dojo.isFunction(_18e)){opts.onFailure=_18e;}this.request("DELETE",url,null,opts);},makeDirectory:function(_18f,path,_190,_191){if(!_18f){return;}var url=bespin.util.path.combineAsDirectory("/file/at",_18f,(path||""));var opts={};if(dojo.isFunction(_190)){opts.onSuccess=_190;}else{opts["log"]="Made a directory: [project="+_18f+", path="+path+"]";}if(dojo.isFunction(_191)){opts.onFailure=_191;}this.request("PUT",url,null,opts);},removeDirectory:function(_192,path,_193,_194){if(!_192){return;}if(!path){path="";}var url=bespin.util.path.combineAsDirectory("/file/at",_192,path);var opts={};if(dojo.isFunction(_193)){opts.onSuccess=_193;}else{opts["log"]="Removed directory: [project="+_192+", path="+path+"]";}if(dojo.isFunction(_194)){opts.onFailure=_194;}this.request("DELETE",url,null,opts);},listOpen:function(_195){this.request("GET","/file/listopen/",null,{onSuccess:_195,evalJSON:true,log:"List open files."});},closeFile:function(_196,path,_197){path=path||"";var url=bespin.util.path.combine("/file/close",_196,path);this.request("POST",url,null,{onSuccess:_197});},searchFiles:function(_198,_199,_19a,_19b){var url=bespin.util.path.combine("/file/search",_198+"?q="+escape(_199));if(_19a.length>0){url+="&i="+escape(_19a.join(";"));}var opts={onSuccess:_19b,evalJSON:true,log:"Listing searchfiles for: "+_198+", searchkey: "+_199};this.request("GET",url,null,opts);},editActions:function(_19c,path,_19d){path=path||"";var url=bespin.util.path.combine("/edit/list",_19c,path);this.request("GET",url,null,{onSuccess:_19d,log:"Edit Actions Complete."});},editAfterActions:function(_19e,path,_19f,_1a0){path=path||"";var url=bespin.util.path.combine("/edit/recent",_19f,_19e,path);this.request("GET",url,null,{onSuccess:_1a0,log:"Edit After Actions Complete."});},doAction:function(_1a1,path,_1a2){path=path||"";var url=bespin.util.path.combine("/edit",_1a1,path);var sp="["+_1a2.join(",")+"]";this.request("PUT",url,sp,{onSuccess:function(){}});},exportProject:function(_1a3,_1a4){if(bespin.util.include(["zip","tgz","tar.gz"],_1a4)){var _1a5=document.createElement("iframe");_1a5.src=bespin.util.path.combine("/project/export",_1a3+"."+_1a4);_1a5.style.display="none";_1a5.style.height=_1a5.style.width="0";document.getElementsByTagName("body")[0].appendChild(_1a5);}},importProject:function(_1a6,url,opts){if(opts){var _1a7=opts.onSuccess;opts.onSuccess=function(text,xhr){_1a7(text,xhr);bespin.publish("project:imported",{project:_1a6,url:url});};}this.request("POST","/project/fromurl/"+_1a6,url,opts||{});},renameProject:function(_1a8,_1a9,opts){if(!opts){opts={log:"Renaming project from "+_1a8+" to "+_1a9};}if(_1a8&&_1a9){this.request("POST","/project/rename/"+_1a8+"/",_1a9,opts);}},listSettings:function(_1aa){if(typeof _1aa=="function"){this.request("GET","/settings/",null,{onSuccess:_1aa,evalJSON:true});}},getSetting:function(name,_1ab){if(typeof _1ab=="function"){this.request("GET","/settings/"+name,null,{onSuccess:_1ab});}},setSetting:function(name,_1ac,_1ad){var _1ae={};_1ae[name]=_1ac;this.setSettings(_1ae,(_1ad||function(){}));},setSettings:function(_1af,_1b0){this.request("POST","/settings/",dojo.objectToQuery(_1af),{onSuccess:(_1b0||function(){})});},unsetSetting:function(name,_1b1){this.request("DELETE","/settings/"+name,null,{onSuccess:(_1b1||function(){})});},fileTemplate:function(_1b2,path,_1b3,opts){var url=bespin.util.path.combine("/file/template",_1b2,path);this.request("PUT",url,dojo.toJson(_1b3),opts||{});},projectTemplate:function(_1b4,_1b5,opts){var url=bespin.util.path.combine("/project/template/",_1b4,"");this.request("POST",url,dojo.toJson(_1b5),opts||{});},lost:function(_1b6,opts){opts=opts||{};var url="/register/lost/";this.request("POST",url,dojo.objectToQuery(_1b6),opts);},changePassword:function(_1b7,_1b8,_1b9,opts){var url="/register/password/"+_1b7;opts=opts||{};var _1ba={newPassword:_1b8,code:_1b9};this.request("POST",url,dojo.objectToQuery(_1ba),opts);},rescan:function(_1bb,_1bc,opts){this.requestDisconnected("POST","/project/rescan/"+escape(_1bb),{},_1bc,opts);}});}if(!dojo._hasResource["bespin.client.session"]){dojo._hasResource["bespin.client.session"]=true;dojo.provide("bespin.client.session");dojo.declare("bespin.client.session.EditSession",null,{constructor:function(_1bd){this.editor=_1bd;this.currentState=this.mobwriteState.stopped;this.bailingOutOfCollaboration=false;var self=this;this.fileHistory=[];this.fileHistoryIndex=-1;this.reportCollaborators([]);bespin.fireAfter(["settings:loaded"],function(){bespin.subscribe("settings:set:collaborate",function(ev){if(!window.mobwrite){return;}if(bespin.get("settings").isOn(ev.value)){if(self.bailingOutOfCollaboration){return;}if(_1bd.dirty){var msg="Collaboration enabled on edited file.\n"+"To avoid losing changes, save before collaborating.\n"+"Save now?";var _1be=confirm(msg);if(_1be){var _1bf=function(){self.startSession(self.project,self.path);};_1bd.saveFile(self.project,self.path,_1bf);}else{self.bailingOutOfCollaboration=true;bespin.get("settings").set("collaborate","off");self.bailingOutOfCollaboration=false;var _1c0=bespin.get("commandLine");_1c0.addOutput("Reverting the following collaboration setting:");setTimeout(function(){_1c0.showHint("Collaborate is off");},10);}}else{self.startSession(self.project,self.path);}}else{self.stopSession();}});});},goToPreviousFile:function(){if(this.fileHistoryIndex!=0){this.fileHistoryIndex--;this.openFromHistory();}},goToNextFile:function(){if(this.fileHistoryIndex!=this.fileHistory.length-1){this.fileHistoryIndex++;this.openFromHistory();}},openFromHistory:function(){var _1c1=this.fileHistory[this.fileHistoryIndex];bespin.get("editor").saveFile();this.editor.openFile(_1c1.project,_1c1.filename,{fromFileHistory:true});},addFileToHistory:function(_1c2){this.fileHistoryIndex++;var end=this.fileHistory.length-this.fileHistoryIndex;this.fileHistory.splice(this.fileHistoryIndex,end,_1c2);},mobwriteState:{stopped:0,starting:1,running:2},setUserinfo:function(_1c3){this.username=_1c3.username;this.amountUsed=_1c3.amountUsed;this.quota=_1c3.quota;},checkSameFile:function(_1c4,path){return ((this.project==_1c4)&&(this.path==path));},setProject:function(_1c5){this.project=_1c5;},setProjectPath:function(_1c6,path){this.project=_1c6;this.path=path;},startSession:function(_1c7,path,_1c8,_1c9){if(this.currentState==this.mobwriteState.starting){console.warn("Asked to start in the middle of starting. this.shareNode=",this.shareNode);return;}if(this.shareNode){this.stopSession();}this.editor.model.insertDocument("");this.editor.moveCursor({row:0,col:0});this.editor.setSelection(null);this.editor.setReadOnly(true);if(_1c7!==undefined){this.project=_1c7;}if(path!==undefined){this.path=path;}this.currentState=this.mobwriteState.starting;var self=this;var _1ca=function(){this.editor.setReadOnly(false);if(dojo.isFunction(_1c8)){_1c8({name:self.path,timestamp:new Date().getTime()});}self.currentState=self.mobwriteState.running;};this.shareNode=new bespin.client.session.ShareNode(this,_1ca);mobwrite.share(this.shareNode);},stopSession:function(){if(this.currentState==this.mobwriteState.starting){console.error("Asked to stop in the middle of starting. I can't let you do that Dave.");return;}if(this.currentState==this.mobwriteState.running){mobwrite.unshare(this.shareNode);this.currentState=this.mobwriteState.stopped;this.shareNode=null;this.reportCollaborators([]);}},reportCollaborators:function(_1cb){var _1cc=dojo.byId("collab_list");if(!_1cc){return;}var self=this;var _1cd={};var _1ce=0;_1cb.forEach(function(_1cf){var _1d0=_1cf.split(":");var _1d1=_1d0[0];var user=_1cd[_1d1];if(!user){user={username:_1d1,windows:[],status:""};_1cd[_1d1]=user;_1ce++;}user.windows.push({address:_1d0[1],id:_1d0[2]});});var _1d2=10;dojo.empty(_1cc);for(var _1d3 in _1cd){if(_1cd.hasOwnProperty(_1d3)){var user=_1cd[_1d3];var _1d4="";if(user.windows.length>1){_1d4+=" <small>("+user.windows.length+")</small>";}var _1d5=_1ce>_1d2;var _1d6=user.windows.length+" window"+(user.windows.length>1?"s":"");user.windows.forEach(function(_1d7){_1d6+=", "+_1d7.address;});if(_1d5){_1d6+=". Status: "+user.status;}var _1d8=dojo.create("div",{style:{marginLeft:"10px",height:(_1d5?"24px":"48px")},title:_1d6},_1cc);var icon=dojo.create("img",{src:"../images/collab_icn_user.png",style:{"float":"left",margin:"4px 8px 0px 8px",height:(_1d5?"20px":"32px"),width:(_1d5?"20px":"32px")}},_1d8);dojo.create("div",{className:"collab_name",innerHTML:_1d3+_1d4},_1d8);if(!_1d5){dojo.create("div",{className:"collab_description",innerHTML:user.status},_1d8);}}}var _1d9=(this.currentState===this.mobwriteState.stopped);dojo.style("collab_off","display",_1d9?"block":"none");dojo.style("collab_on","display",_1d9?"none":"block");if(_1d9){dojo.attr("toolbar_collaboration","src","images/icn_collab_off.png");}else{if(_1cb.length>1){dojo.attr("toolbar_collaboration","src","images/icn_collab_on.png");}else{dojo.attr("toolbar_collaboration","src","images/icn_collab_watching.png");}}},getStatus:function(){var file=this.path||"a new scratch file";return "Hey "+this.username+", you are editing "+file+" in project "+this.project;}});dojo.declare("bespin.client.session.ShareNode",null,{constructor:function(_1da,_1db){this.session=_1da;this.editor=_1da.editor;this.onFirstSync=_1db;this.username=_1da.username||"[none]";var _1dc=_1da.project;var path=_1da.path;if(path.indexOf("/")!=0){path="/"+path;}parts=_1dc.split("+");if(parts.length==1){this.id=this.username+"/"+_1dc+path;}else{this.id=parts[0]+"/"+parts[1]+path;}},setShareObj:function(_1dd){this.shareObj=_1dd;},isShareNode:true,reportCollaborators:function(_1de){this.session.reportCollaborators(_1de);},raiseError:function(text,_1df){if(!text){text="(No server error message)";}var _1e0="<strong>"+(_1df?"":"Fatal ")+"Collaboration Error</strong>: ";var _1e1="<br/><strong>Warning</strong>: Changes to this file could be lost";var _1e2=bespin.get("commandLine");if(_1e2){_1e2.showHint(_1e0+text+_1e1);}else{console.error("Missing commandLine to report: "+text);}if(!_1df){this.editor.setReadOnly(true);}},getClientText:function(_1e3){if(!_1e3&&this.onFirstSync){console.trace();throw new Error("Attempt to getClientText() before onFirstSync() called.");}return this.editor.model.getDocument();},syncWithoutChange:function(){this.checkFirstSyncDone();},setClientText:function(text){var _1e4=this.captureCursor();this.editor.model.insertDocument(text);this.restoreCursor(_1e4);this.checkFirstSyncDone();},setReadOnly:function(_1e5){console.log("setReadOnly",_1e5);this.editor.setReadOnly(_1e5);},patchClientText:function(_1e6){this.shareObj.dmp.Match_Distance=1000;this.shareObj.dmp.Match_Threshold=0.6;var _1e7=this.getClientText(true);var _1e8=this.captureCursor();var _1e9=[];if(_1e8){_1e9[0]=_1e8.startOffset;if("endOffset" in _1e8){_1e9[1]=_1e8.endOffset;}}var _1ea=this.patchApply(_1e6,_1e7,_1e9);if(_1e7!=_1ea){this.editor.model.insertDocument(_1ea);if(_1e8){_1e8.startOffset=_1e9[0];if(_1e9.length>1){_1e8.endOffset=_1e9[1];if(_1e8.startOffset>=_1e8.endOffset){_1e8.collapsed=true;}}this.restoreCursor(_1e8);}}this.checkFirstSyncDone();},patchApply:function(_1eb,text,_1ec){if(_1eb.length==0){return text;}_1eb=this.shareObj.dmp.patch_deepCopy(_1eb);var _1ed=this.shareObj.dmp.patch_addPadding(_1eb);text=_1ed+text+_1ed;this.shareObj.dmp.patch_splitMax(_1eb);var _1ee=0;for(var x=0;x<_1eb.length;x++){var _1ef=_1eb[x].start2+_1ee;var _1f0=this.shareObj.dmp.diff_text1(_1eb[x].diffs);var _1f1=this.shareObj.dmp.match_main(text,_1f0,_1ef);if(_1f1==-1){if(mobwrite.debug){window.console.warn("Patch failed: "+_1eb[x]);}}else{_1ee=_1f1-_1ef;var _1f2=text.substring(_1f1,_1f1+_1f0.length);var _1f3=this.shareObj.dmp.diff_main(_1f0,_1f2,false);var _1f4=0;var _1f5;for(var y=0;y<_1eb[x].diffs.length;y++){var mod=_1eb[x].diffs[y];if(mod[0]!==DIFF_EQUAL){_1f5=this.shareObj.dmp.diff_xIndex(_1f3,_1f4);}if(mod[0]===DIFF_INSERT){text=text.substring(0,_1f1+_1f5)+mod[1]+text.substring(_1f1+_1f5);for(var i=0;i<_1ec.length;i++){if(_1ec[i]+_1ed.length>_1f1+_1f5){_1ec[i]+=mod[1].length;}}}else{if(mod[0]===DIFF_DELETE){var _1f6=_1f1+_1f5;var _1f7=_1f1+this.shareObj.dmp.diff_xIndex(_1f3,_1f4+mod[1].length);text=text.substring(0,_1f6)+text.substring(_1f7);for(var i=0;i<_1ec.length;i++){if(_1ec[i]+_1ed.length>_1f6){if(_1ec[i]+_1ed.length<_1f7){_1ec[i]=_1f6-_1ed.length;}else{_1ec[i]-=_1f7-_1f6;}}}}}if(mod[0]!==DIFF_DELETE){_1f4+=mod[1].length;}}}}text=text.substring(_1ed.length,text.length-_1ed.length);return text;},checkFirstSyncDone:function(){if(this.onFirstSync){this.onFirstSync();delete this.onFirstSync;}},getMetaData:function(){var data={cursor:this.captureSimpleCursor()};return dojo.toJson(data);},captureSimpleCursor:function(){var _1f8=this.editor.getSelection();var _1f9=this.editor.getCursorPos();var _1fa=_1f8?_1f8.startPos:_1f9;var end=_1f8?_1f8.endPos:_1f9;return {startOffset:this.convertRowColToOffset(_1fa),endOffset:this.convertRowColToOffset(end)};},captureCursor:function(){var _1fb=this.shareObj.dmp.Match_MaxBits/2;var text=this.editor.model.getDocument();var _1fc=this.captureSimpleCursor();_1fc.startPrefix=text.substring(_1fc.startOffset-_1fb,_1fc.startOffset);_1fc.startSuffix=text.substring(_1fc.startOffset,_1fc.startOffset+_1fb);_1fc.collapsed=(_1fc.startOffset==_1fc.endOffset);if(!_1fc.collapsed){_1fc.endPrefix=text.substring(_1fc.endOffset-_1fb,_1fc.endOffset);_1fc.endSuffix=text.substring(_1fc.endOffset,_1fc.endOffset+_1fb);}var ui=this.editor.ui;_1fc.scrollTop=ui.yoffset/ui.yscrollbar.extent;_1fc.scrollLeft=ui.xoffset/ui.xscrollbar.extent;return _1fc;},restoreCursor:function(_1fd){var dmp=this.shareObj.dmp;dmp.Match_Distance=1000;dmp.Match_Threshold=0.9;var _1fe=dmp.Match_MaxBits/2;var _1ff=this.editor.model.getDocument();var _200=_1fd.startPrefix+_1fd.startSuffix;var _201,diff;var _202=dmp.match_main(_1ff,_200,_1fd.startOffset-_1fe);if(_202!==null){_201=_1ff.substring(_202,_202+_200.length);diff=dmp.diff_main(_200,_201,false);_202+=dmp.diff_xIndex(diff,_1fd.startPrefix.length);}var _203=null;if(!_1fd.collapsed){_200=_1fd.endPrefix+_1fd.endSuffix;var _203=dmp.match_main(_1ff,_200,_1fd.endOffset-_1fe);if(_203!==null){_201=_1ff.substring(_203,_203+_200.length);diff=dmp.diff_main(_200,_201,false);_203+=dmp.diff_xIndex(diff,_1fd.endPrefix.length);}}if(_202===null&&_203!==null){_202=_203;}else{if(_202===null&&_203===null){_202=_1fd.startOffset;}}if(_203===null){_203=_202;}var _204=this.convertOffsetToRowCol(_202);this.editor.moveCursor(_204);var _205=null;if(_203!=_202){_205={startPos:_204,endPos:this.convertOffsetToRowCol(_203)};}this.editor.setSelection(_205);var ui=this.editor.ui;ui.yscrollbar.setValue(-(_1fd.scrollTop*ui.yscrollbar.extent));ui.xscrollbar.setValue(-(_1fd.scrollLeft*ui.xscrollbar.extent));},convertRowColToOffset:function(pos){var _206=0;var rows=this.editor.model.rows;for(var i=0;i<pos.row;i++){if(i>=rows.length){console.warn("Cursor positioned outside the editor document. Assuming end. pos=",pos,"rows.length=",rows.length);break;}_206+=rows[i].length+1;}_206+=pos.col;return _206;},convertOffsetToRowCol:function(_207){var pos={row:0,col:0};var rows=this.editor.model.rows;while(true){var len=rows[pos.row].length;if(_207<=len){pos.col=_207;break;}_207-=len+1;pos.row+=1;if(pos.row>=rows.length){console.warn("convertOffsetToRowCol(",_207,") has run out of editor characters.");pos.row-=1;pos.col=rows[pos.row].length;break;}}return pos;}});}if(!dojo._hasResource["bespin.worker.worker"]){dojo._hasResource["bespin.worker.worker"]=true;dojo.provide("bespin.worker.worker");(function(){var _208=1;var _209=0;var _20a=0;var _20b=false;var _20c="js/bespin/bootstrap_worker.js";var _20d=function(_20e){return _20c+"#"+escape(_20e);};var _20f=function(uri){return unescape(uri.substr((_20c+"#").length));};Worker=undefined;dojo.declare("bespin.worker.WorkerFacade",null,{constructor:function(obj,_210,libs){this.__obj__=obj;var _211={};this.__callbacks__=_211;this.__workerCount__=_210||_208;this.__hasWorkers__=false;if(typeof Worker!="undefined"){this.__hasWorkers__=true;var _212=this.createWorkerSource(obj,libs);var _213=this.createWorkers(_212);this.__workers__=_213;}this.createFacade(obj);},__getWorker__:function(){var _214=_209++%this.__workerCount__;return this.__workers__[_214];},createWorkers:function(_215){var self=this;var _216=[];var cb=function(_217){var data=_217.data;if(typeof data=="string"){data=dojo.fromJson(data);}var _218=data.callIndex;var _219=self.__callbacks__[_218];delete self.__callbacks__[_218];if(_219){_219(data.returnValue);}};var _21a=function(_21b,url){var _21c=this;bespin.get("server").request("GET",url,null,{onSuccess:function(src){_21c.postMessage("__IMPORT_SCRIPT__//"+_21b+"\n"+src);}});};for(var i=0;i<this.__workerCount__;i++){var _21d=new Worker("/js/bespin/bootstrap_worker.js",_215);var _21e=function(_21f){var _220=_21f.data;if(typeof _220=="string"){if(_220.indexOf("log=")==0){console.log("From Worker: "+_220.substr(4));return;}else{if(_220.indexOf("__IMPORT_SCRIPT__")==0){var json=_220.substr("__IMPORT_SCRIPT__".length);var _221=dojo.fromJson(json);_21a.apply(this,_221);return;}else{_220=dojo.fromJson(_220);}}}if(_220.type=="subscribe"){(function(){var _222=_220.index;var name=_220.name;bespin.subscribe(name,function(_223){var ret={index:_222,name:name,event:_223};_21d.postMessage(_20b?ret:dojo.toJson(ret));});})();}else{if(_220.type=="publish"){bespin.publish(_220.name,_220.event);}else{throw _220;cb.call(this,_21f);}}};_21d.onmessage=_21e;_215="// YOUcannotGuessMe\n"+_215;window.setTimeout(function(){_21d.postMessage(_215);},0);_216.push(_21d);}return _216;},createFacade:function(obj){var _224=this;for(var prop in obj){if(prop.charAt(0)!="_"){(function(){var val=obj[prop];var _225=prop;if(typeof val=="function"){_224[prop]=function(){var self=this;var _226=_20a++;var _227=Array.prototype.slice.call(arguments);if(this.__hasWorkers__){var data={callIndex:_226,method:_225,paras:_227};if(!_20b){data=dojo.toJson(data);}this.__getWorker__().postMessage(data);}else{var self=this;window.setTimeout(function(){var _228=self.__obj__[_225].apply(self.__obj__,_227);var _229=self.__callbacks__[_226];delete self.__callbacks__[_226];if(_229){_229(_228);}},0);}return {and:function(_22a,_22b,_22c,_22d){var func=arguments[arguments.length-1];if(_22b instanceof bespin.worker.Mutex){_22b.start();func=function(){_22d.apply(this,arguments);_22b.stop();};}self.__callbacks__[_226]=function(){_22c=Array.prototype.slice.call(arguments).concat(_22c);func.apply(_22a,_22c);};}};};}else{}})();}}},hasFunctions:function(obj){for(var i in obj){var val=obj[i];if(typeof val=="function"){return true;}if(val&&typeof val=="object"){if(this.hasFunctions(val)){return true;}}}return false;},serializeToPortableSource:function(obj){var self=this;var _22e=dojo.isArray(obj);var _22f=_22e?"[\n":"{\n";for(var prop in obj){(function(){if(prop=="_constructor"){return;}var val=obj[prop];var _230=prop;var src="";if(typeof val=="function"){src=val.toString();}else{if(val&&typeof val=="object"&&self.hasFunctions(val)){src=self.serializeToPortableSource(val);}else{src=dojo.toJson(val);}}prop="\""+prop.replace(/"/g,"\\\"","g")+"\"";_22f+=_22e?"":prop+": ";_22f+=src+",\n";})();}_22f+=_22e?"]\n":"}\n";return _22f;},createWorkerSource:function(obj,libs){var con=function(msg){postMessage("log="+msg);};var _231="";if(libs){var _232=[];dojo.forEach(libs,function(lib){_232.push("'"+lib+"'");});_231+="importScripts("+_232.join(", ")+");\n";}_231+="var theObject = "+this.serializeToPortableSource(obj);return _231;}});dojo.declare("bespin.worker.Mutex",null,{constructor:function(name,_233){this.name=name;this.count=0;this.afterJobs=[];this.options=_233||{};},start:function(){this.count=this.count+1;},stop:function(){this.count=this.count-1;if(this.count==0){if(this.options.onlyLast){var last=this.afterJobs[this.afterJobs.length-1];if(last){last();}}else{for(var i=0;i<this.afterJobs.length;++i){var job=this.afterJobs[i];job();}}this.afterJobs=[];}},after:function(_234,func){this.afterJobs.push(function(){func.call(_234);});}});function _235(){if(window.google&&google.gears){return;}var _236=null;if(typeof GearsFactory!="undefined"){_236=new GearsFactory();}else{try{_236=new ActiveXObject("Gears.Factory");if(_236.getBuildInfo().indexOf("ie_mobile")!=-1){_236.privateSetGlobalObject(this);}}catch(e){if(navigator.mimeTypes["application/x-googlegears"]){_236=document.createElement("object");_236.style.display="none";_236.width=0;_236.height=0;_236.type="application/x-googlegears";document.documentElement.appendChild(_236);}}}if(!_236){return;}if(!window.google){google={};}if(!google.gears){google.gears={factory:_236};}};})();}if(!dojo._hasResource["bespin.editor.actions"]){dojo._hasResource["bespin.editor.actions"]=true;dojo.provide("bespin.editor.actions");dojo.declare("bespin.editor.Actions",null,{constructor:function(_237){this.editor=_237;this.model=this.editor.model;this.cursorManager=this.editor.cursorManager;this.ignoreRepaints=false;this.currentEditItem=undefined;this.editDepth=0;},beginEdit:function(name){if(this.editDepth==0){this.currentEditItem=new bespin.editor.ActionHistoryItem(name,this.editor);this.currentEditItem.begin();}this.editDepth++;},endEdit:function(){if(this.editDepth<=0){return;}this.editDepth--;if(this.editDepth==0){this.currentEditItem.end();this.editor.historyManager.add(this.currentEditItem);this.currentEditItem=undefined;bespin.publish("editor:document:changed");}},handleCursorSelection:function(args){if(args.event.shiftKey){if(!this.editor.selection){this.editor.setSelection({startPos:bespin.editor.utils.copyPos(args.pos)});}this.editor.setSelection({startPos:this.editor.selection.startPos,endPos:bespin.editor.utils.copyPos(this.cursorManager.getCursorPosition())});}else{this.editor.setSelection(undefined);}},moveCursor:function(_238,args){var _239=this.cursorManager[_238](args);this.handleCursorSelection(args);this.repaint();args.pos=_239.newPos;return args;},moveCursorLeft:function(args){return this.moveCursor("moveLeft",args);},moveCursorRight:function(args){return this.moveCursor("moveRight",args);},moveCursorUp:function(args){return this.moveCursor("moveUp",args);},moveCursorDown:function(args){return this.moveCursor("moveDown",args);},moveToLineStart:function(args){return this.moveCursor("moveToLineStart",args);},moveToLineEnd:function(args){return this.moveCursor("moveToLineEnd",args);},moveToFileTop:function(args){return this.moveCursor("moveToTop",args);},moveToFileBottom:function(args){return this.moveCursor("moveToBottom",args);},movePageUp:function(args){return this.moveCursor("movePageUp",args);},movePageDown:function(args){return this.moveCursor("movePageDown",args);},moveWordLeft:function(args){return this.moveCursor("smartMoveLeft",args);},moveWordRight:function(args){return this.moveCursor("smartMoveRight",args);},deleteWordLeft:function(args){this.beginEdit("deleteWordLeft");this.deleteChunk({endPos:args.pos,pos:this.moveCursor("smartMoveLeft",args).pos});this.endEdit();return args;},deleteWordRight:function(args){this.beginEdit("deleteWordRight");this.deleteChunk({pos:args.pos,endPos:this.moveCursor("smartMoveRight",args).pos});this.endEdit();return args;},applyState:function(_23a){if(this.testHistory.length==0){return;}else{if(_23a<0){_23a=-1;}else{if(_23a>=this.testHistory.length){return;}}}this.testHistoryPosition=_23a;var item=this.testHistory[Math.max(0,this.testHistoryPosition)];var _23b=item.after;var _23c=item.uiAfter;if(_23a<0){_23b=item.before;_23c=item.uiBefore;}this.model.applyState(_23b);this.editor.setState(_23c);},undo:function(){this.editor.historyManager.undo();},redo:function(){this.editor.historyManager.redo();},selectAll:function(args){if(this.model.isEmpty()){return;}args.startPos={row:0,col:0};args.endPos={row:this.model.getRowCount()-1,col:this.editor.ui.getRowScreenLength(this.model.getRowCount()-1)};this.select(args);},select:function(args){if(args.startPos){this.editor.setSelection({startPos:args.startPos,endPos:args.endPos});this.cursorManager.moveCursor(args.endPos);}else{this.editor.setSelection(undefined);}},insertTab:function(args){if(this.editor.readonly){return;}var _23d=bespin.get("settings");if(this.editor.getSelection()&&!args.undoInsertTab){this.indent(args);return;}var tab=args.tab;var _23e=this.cursorManager.getCharacterLength("\t");if(!tab||!_23e){if(_23d&&_23d.isSettingOn("tabmode")){tab="\t";}else{tab="";var _23f=_23e;while(_23f-->0){tab+=" ";}_23e=tab.length;}}this.beginEdit("insertTab");delete this.editor.selection;this.model.insertCharacters(this.cursorManager.getModelPosition({row:args.pos.row,col:args.pos.col}),tab);this.cursorManager.moveCursor({row:args.pos.row,col:args.pos.col+_23e});this.repaint();this.endEdit();},indent:function(args){var _240=bespin.get("settings");var _241=this.editor.getSelection();var _242=_241.startPos.row;var _243=_241.endPos.row;var _244=this.cursorManager.getStringLength(this.model.getRowArray(_243).join(""));var _245=this.cursorManager.getStringLength(this.model.getRowArray(args.pos.row).join(""));var _246;var tab="";if(_240&&_240.isSettingOn("tabmode")){tab="\t";}else{var _247=this.editor.getTabSize();while(_247-->0){tab+=" ";}}this.beginEdit("indent");for(var y=_242;y<=_243;y++){if(tab!="\t"){_246=this.cursorManager.getLeadingWhitespace(y);_246=this.cursorManager.getNextTablevelRight(_246)-_246;_246=tab.substring(0,_246);}else{_246="\t";}this.model.insertCharacters(this.cursorManager.getModelPosition({row:y,col:0}),_246);}var _248=this.cursorManager.getStringLength(this.model.getRowArray(args.pos.row).join(""))-_245;_241.endPos.col+=this.cursorManager.getStringLength(this.model.getRowArray(_243).join(""))-_244;this.editor.setSelection(_241);this.cursorManager.moveCursor({col:args.pos.col+_248});this.repaint();this.endEdit();},unindent:function(args){var _249=this.editor.getSelection();var _24a=_249.startPos.row;var _24b=_249.endPos.row;var _24c=this.cursorManager.getStringLength(this.model.getRowArray(_24b).join(""));var row=false;var _24d;var _24e;this.beginEdit("unindent");for(var y=_24a;y<=_24b;y++){row=this.model.getRowArray(y);if(row.length>0&&row[0]=="\t"){_24d=1;_24e=this.editor.getTabSize();}else{var _24f=this.cursorManager.getLeadingWhitespace(y);_24d=this.cursorManager.getContinuousSpaceCount(0,this.editor.getTabSize(),y);_24e=_24d;}if(_24d){this.model.deleteCharacters(this.cursorManager.getModelPosition({row:y,col:0}),_24d);}if(y==_24a){_249.startPos.col=Math.max(0,_249.startPos.col-_24e);}if(y==_24b){if(!row){row=this.model.getRowArray(y);}var _250=_24c-this.cursorManager.getStringLength(row.join(""));_249.endPos.col=Math.max(0,_249.endPos.col-_250);args.pos.col=Math.max(0,args.pos.col-_250);}}this.editor.setSelection(_249);this.cursorManager.moveCursor({col:args.pos.col});this.repaint();this.endEdit();},cutSelection:function(args){if(this.editor.readonly){return;}this.beginEdit("cut");this.copySelection(args);this.deleteSelection(args);this.endEdit();},copySelection:function(args){var _251=this.editor.getSelection();if(_251){var _252=this.model.getChunk(_251);if(_252){bespin.editor.clipboard.Manual.copy(_252);}}},pasteFromClipboard:function(args){if(this.editor.readonly){return;}var _253=(args.clipboard)?args.clipboard:bespin.editor.clipboard.Manual.data();if(_253===undefined){return;}args.chunk=_253;this.beginEdit("paste");this.insertChunk(args);this.endEdit();},insertChunk:function(args){if(this.editor.readonly){return;}this.beginEdit("insertChunk");if(this.editor.selection){this.deleteSelection();}var pos=bespin.editor.utils.copyPos(this.cursorManager.getCursorPosition());pos=this.model.insertChunk(this.cursorManager.getModelPosition(pos),args.chunk);pos=this.cursorManager.getCursorPosition(pos);this.cursorManager.moveCursor(pos);this.repaint();this.endEdit();return pos;},deleteChunk:function(args){if(this.editor.readonly){return;}this.beginEdit("deleteChunk");var _254=(args.startPos!=undefined)?args.startPos:bespin.editor.utils.copyPos(args.pos);var _255=this.editor.getSelection({startPos:_254,endPos:args.endPos});var _256=this.model.deleteChunk(_255);this.cursorManager.moveCursor(_255.startPos);this.editor.setSelection(undefined);this.repaint();this.endEdit();return _255.startPos;},joinLine:function(args){if(this.editor.readonly){return;}this.beginEdit("joinLine");if(args.joinDirection=="up"){if(args.pos.row==0){return;}var _257=this.editor.ui.getRowScreenLength(args.pos.row-1);this.model.joinRow(args.pos.row-1);this.cursorManager.moveCursor({row:args.pos.row-1,col:_257});}else{if(args.pos.row>=this.model.getRowCount()-1){return;}this.model.joinRow(args.pos.row);}this.endEdit();this.repaint();},killLine:function(args){if(this.editor.readonly){return;}this.beginEdit("killLine");this.editor.setSelection({startPos:{row:args.pos.row,col:0},endPos:{row:args.pos.row+1,col:0}});this.cutSelection(args);this.endEdit();},deleteSelection:function(args){if(this.editor.readonly){return;}var _258=this.editor.getSelection();return this.deleteChunk({startPos:_258.startPos,endPos:_258.endPos,clearSelection:true});},backspace:function(args){if(this.editor.readonly){return;}this.beginEdit("backspace");if(this.editor.selection){this.deleteSelection(args);}else{if(args.pos.col>0){var _259=bespin.get("settings");if(_259&&_259.isSettingOn("smartmove")){var _25a=this.editor.getTabSize();var _25b=this.cursorManager.getContinuousSpaceCount(args.pos.col,this.cursorManager.getNextTablevelLeft(args.pos.col));if(_25b==_25a){var pos=args.pos;this.editor.selection={startPos:{row:pos.row,col:pos.col-_25a},endPos:{row:pos.row,col:pos.col}};this.deleteSelection(args);this.endEdit();return;}}this.cursorManager.moveCursor({col:Math.max(0,args.pos.col-1)});args.pos.col-=1;this.deleteCharacter(args);}else{args.joinDirection="up";this.joinLine(args);}}this.endEdit();},deleteKey:function(args){if(this.editor.readonly){return;}this.beginEdit("deleteKey");if(this.editor.selection){this.deleteSelection(args);}else{if(args.pos.col<this.editor.ui.getRowScreenLength(args.pos.row)){var _25c=bespin.get("settings");if(_25c&&_25c.isSettingOn("smartmove")){var _25d=this.editor.getTabSize();var _25e=this.cursorManager.getContinuousSpaceCount(args.pos.col,this.cursorManager.getNextTablevelRight(args.pos.col));if(_25e==_25d){var pos=args.pos;this.editor.selection={startPos:{row:pos.row,col:pos.col},endPos:{row:pos.row,col:pos.col+_25d}};this.deleteSelection(args);this.endEdit();return;}}this.deleteCharacter(args);}else{args.joinDirection="down";this.joinLine(args);}}this.endEdit();},deleteCharacter:function(args){if(this.editor.readonly){return;}if(args.pos.col<this.editor.ui.getRowScreenLength(args.pos.row)){this.beginEdit("deleteCharacter");var _25f=this.cursorManager.getModelPosition(args.pos);var _260=1;var _261=this.model.deleteCharacters(_25f,_260);this.repaint();this.endEdit();}},newline:function(args){if(this.editor.readonly){return;}var _262=bespin.get("settings");if(_262&&_262.isSettingOn("autoindent")){var _263=bespin.util.leadingWhitespace(this.model.getRowArray(args.pos.row));}else{var _263=[];}args.chunk="\n"+_263.join("");this.insertChunk(args);},newlineBelow:function(args){this.newline(this.moveToLineEnd(args));},insertCharacter:function(args){if(this.editor.readonly){return;}this.beginEdit("insertCharacter");var pos=args.pos;if(this.editor.selection){pos=this.deleteSelection(args);}this.model.insertCharacters(this.cursorManager.getModelPosition(pos),args.newchar);this.cursorManager.moveRight(true);var _264=bespin.get("settings");if(_264&&_264.isSettingOn("closepairs")){switch(args.newchar){case "(":this.model.insertCharacters(this.cursorManager.getModelPosition(),")");break;case "[":this.model.insertCharacters(this.cursorManager.getModelPosition(),"]");break;case "{":this.model.insertCharacters(this.cursorManager.getModelPosition(),"}");break;case "<":break;case "\"":break;case "'":break;}}this.repaint();this.endEdit();},moveCursorRowToCenter:function(args){var _265=this.editor.getCursorPos().row;var _266=Math.floor(this.editor.ui.visibleRows/2);if(_265>(this.editor.ui.firstVisibleRow+_266)){this.cursorManager.moveCursor({row:this.editor.getCursorPos().row+_266});}else{this.cursorManager.moveCursor({row:this.editor.getCursorPos().row-_266});}this.editor.ui.ensureCursorVisible();this.cursorManager.moveCursor({row:_265});},getOppositeCase:function(_267){if(!_267){return undefined;}switch(_267){case "u":return "l";break;case "l":return "u";break;}},selectionChangeCase:function(args){if(this.editor.readonly){return;}if(this.editor.selection){this.beginEdit("selectionChangeCase");if(!args.selectionObject){args.selectionObject=this.editor.getSelection();}var _268=this.model.getChunk(args.selectionObject);var _269=_268.split("\n");for(i in _269){switch(args.stringCase){case "l":_269[i]=_269[i].toLowerCase();break;case "u":_269[i]=_269[i].toUpperCase();break;}}var _26a=_269.join("\n");this.model.deleteChunk(args.selectionObject);this.model.insertChunk(args.selectionObject.startModelPos,_26a);this.select(args.selectionObject);this.endEdit();}},startSearch:function(str,_26b,_26c){if(str==""){this.editor.ui.setSearchString(false);this.editor.paint(true);dojo.byId("searchresult").style.display="none";return false;}if(str==this.editor.ui.searchString&&_26b=="toolbar"){if(!_26c){this.findNext();}else{this.findPrev();}dojo.byId("searchresult").style.display="block";return;}this.editor.ui.setSearchString(str);var _26d=this.editor.model.getCountOfString(str);if(_26d!=0){var pos=bespin.editor.utils.copyPos(this.editor.cursorManager.getCursorPosition());if(!this.editor.ui.actions.findNext(null,true)){this.editor.cursorManager.moveCursor({col:0,row:0});this.editor.ui.actions.findNext();}}switch(_26b){case "commandLine":var msg="Found "+_26d+" match";if(_26d>1){msg+="es";}msg+=" for your search for <em>"+str+"</em>";bespin.get("commandLine").showHint(msg);break;case "searchwindow":var _26e=bespin.get("filesearch");if(_26e){_26e.setMatchesCount(_26d);}break;case "toolbar":var msg=+_26d+" Match";if(_26d>1){msg+="es";}dojo.byId("searchfeedback").innerHTML=msg;dojo.byId("searchresult").style.display="block";break;}this.editor.paint(true);},findNext:function(_26f,_270){if(!this.editor.ui.searchString){return;}var pos=bespin.editor.utils.copyPos(this.cursorManager.getModelPosition());var sel=this.editor.getSelection();if(_270&&sel!==undefined){pos.col-=sel.endModelPos.col-sel.startModelPos.col+1;}var _271=this.model.findNext(pos.row,pos.col,this.editor.ui.searchString);if(!_271){_271=this.model.findNext(0,0,this.editor.ui.searchString);}if(_271){this.editor.setSelection({startPos:this.cursorManager.getCursorPosition(_271.startPos),endPos:this.cursorManager.getCursorPosition(_271.endPos)});this.cursorManager.moveCursor(this.cursorManager.getCursorPosition(_271.endPos));this.editor.ui.ensureCursorVisible(true);this.repaint();return true;}else{return false;}},findPrev:function(){if(!this.editor.ui.searchString){return;}var pos=this.cursorManager.getModelPosition();var _272=this.model.findPrev(pos.row,pos.col,this.editor.ui.searchString);if(!_272){var _273=this.model.getRowCount()-1;_272=this.model.findPrev(_273,this.model.getRowArray(_273).length-1,this.editor.ui.searchString);}if(_272){this.editor.setSelection({startPos:this.cursorManager.getCursorPosition(_272.startPos),endPos:this.cursorManager.getCursorPosition(_272.endPos)});this.cursorManager.moveCursor(this.cursorManager.getCursorPosition(_272.endPos));this.editor.ui.ensureCursorVisible(true);this.repaint();return true;}else{return false;}},escape:function(){bespin.publish("ui:escape");if(this.editor.ui.searchString){this.editor.ui.setSearchString(false);}},toggleQuickopen:function(){var _274=bespin.get("quickopen");if(_274){_274.toggle();}},togglePieMenu:function(){bespin.getComponent("piemenu",function(_275){_275.toggle();});},focusCommandline:function(){bespin.getComponent("popup",function(_276){_276.show("output");});},focusFileBrowser:function(){bespin.getComponent("popup",function(_277){_277.show("files");});},repaint:function(){if(!this.ignoreRepaints){this.editor.ui.ensureCursorVisible();this.editor.paint();}},replace:function(args){this.beginEdit("replace");this.editor.model.replace(args.search,args.replace);this.repaint();this.endEdit();},gotoLine:function(){bespin.getComponent("commandLine",function(cli){cli.setCommandText("goto ");bespin.getComponent("popup",function(_278){_278.show("output");});});},cmdFilesearch:function(){bespin.getComponent("commandLine",function(cli){cli.setCommandText("search ");bespin.getComponent("popup",function(_279){_279.show("output");});});},previousFile:function(){bespin.get("editSession").goToPreviousFile();},nextFile:function(){bespin.get("editSession").goToNextFile();}});dojo.declare("bespin.editor.ActionHistoryItem",null,{constructor:function(name,_27a){this.editor=_27a;},begin:function(_27b,_27c){this.startIndex=this.editor.historyManager.getCurrent();if(_27b){this.editorBefore=_27b;}else{this.editorBefore=this.editor.getState();}if(_27c){this.modelBefore=_27c;}else{this.modelBefore=this.editor.model.getState();}},end:function(_27d,_27e){this.editor.historyManager.truncate(this.startIndex);if(_27d){this.editorAfter=_27d;}else{this.editorAfter=this.editor.getState();}if(_27e){this.modelAfter=_27e;}else{this.modelAfter=this.editor.model.getState();}},undo:function(){this.editor.model.applyState(this.modelBefore);this.editor.setState(this.editorBefore);this.editor.ui.ensureCursorVisible();this.editor.paint();},redo:function(){this.editor.model.applyState(this.modelAfter);this.editor.setState(this.editorAfter);this.editor.ui.ensureCursorVisible();this.editor.paint();}});}if(!dojo._hasResource["bespin.editor.clipboard"]){dojo._hasResource["bespin.editor.clipboard"]=true;dojo.provide("bespin.editor.clipboard");dojo.mixin(bespin.editor.clipboard,{install:function(_27f,_280){this.uninstall();this.uses=_280;this.uses.install(_27f);},uninstall:function(){if(this.uses&&typeof this.uses["uninstall"]=="function"){this.uses.uninstall();}this.uses=undefined;},createHiddenTextarea:function(){return dojo.create("textarea",{id:"copynpaster",tabIndex:"-1",style:"position:absolute; z-index:999; top:-10000px; width:0; height:0; border:none;"},dojo.body());},setup:function(_281){this.install(_281,new bespin.editor.clipboard.HiddenWorld());}});dojo.declare("bespin.editor.clipboard.DOMEvents",null,{install:function(_282){var _283=this.copynpaster=bespin.editor.clipboard.createHiddenTextarea();var _284=function(e){return e.target.id=="command";};var _285=function(){return bespin.get("editor").focus;};var _286=false;this.beforecopyHandle=dojo.connect(document,"beforecopy",function(e){if(!_285()&&!this.allowAction){return;}if(_284(e)){return;}e.preventDefault();_283.focus();this.allowAction=true;});this.copyHandle=dojo.connect(document,"copy",function(e){if(!_285()&&!this.allowAction){return;}if(_284(e)){return;}var _287=_282.getSelectionAsText();if(_287&&_287!=""){e.preventDefault();e.clipboardData.setData("text/plain",_287);}dojo.byId("canvas").focus();this.allowAction=false;});this.beforecutHandle=dojo.connect(document,"beforecut",function(e){if(!_285()&&!this.allowAction){return;}if(_284(e)){return;}e.preventDefault();_283.focus();this.allowAction=true;});this.cutHandle=dojo.connect(document,"cut",function(e){if(!_285()&&!this.allowAction){return;}if(_284(e)){return;}var _288=_282.getSelection();if(_288){var _289=_282.model.getChunk(_288);if(_289&&_289!=""){e.preventDefault();e.clipboardData.setData("text/plain",_289);_282.ui.actions.beginEdit("cut");_282.ui.actions.deleteSelection(_288);_282.ui.actions.endEdit();}}dojo.byId("canvas").focus();this.allowAction=false;});this.beforepasteHandle=dojo.connect(document,"beforepaste",function(e){if(!_285()&&!this.allowAction){return;}if(_284(e)){return;}e.preventDefault();_283.focus();this.allowAction=true;});this.pasteHandle=dojo.connect(document,"paste",function(e){if(!_285()&&!this.allowAction){return;}if(_284(e)){return;}e.preventDefault();var args=bespin.editor.utils.buildArgs();args.chunk=e.clipboardData.getData("text/plain");if(args.chunk){_282.ui.actions.beginEdit("paste");_282.ui.actions.insertChunk(args);_282.ui.actions.endEdit();}dojo.byId("canvas").focus();_283.value="";this.allowAction=false;});dojo.connect(document,"dom:loaded",dojo.hitch(this,function(){this.keydownHandle=dojo.connect(_283,"keydown",function(e){e.stopPropagation();});this.keypressHandle=dojo.connect(_283,"keypress",function(e){e.stopPropagation();});}));},uninstall:function(){dojo.disconnect(this.keypressHandle);dojo.disconnect(this.keydownHandle);dojo.disconnect(this.beforepasteHandle);dojo.disconnect(this.pasteHandle);dojo.disconnect(this.beforecutHandle);dojo.disconnect(this.cutHandle);dojo.disconnect(this.beforecopyHandle);dojo.disconnect(this.copyHandle);if(this.copynpaster){document.body.removeChild(copynpaster);}this.copynpaster=undefined;}});dojo.declare("bespin.editor.clipboard.HiddenWorld",null,{install:function(_28a){var _28b=this.copynpaster=bespin.editor.clipboard.createHiddenTextarea();var _28c=function(text){_28b.value=text;_28b.select();setTimeout(function(){_28a.setFocus(true);},0);};this.keyDown=dojo.connect(_28a.opts.actsAsComponent?_28a.canvas:document,"keydown",function(e){if(!bespin.get("editor").focus){return;}if((bespin.util.isMac()&&e.metaKey)||e.ctrlKey){if(e.keyCode==67){var _28d=_28a.getSelectionAsText();if(_28d&&_28d!=""){_28c(_28d);}}else{if(e.keyCode==88){var _28e=_28a.getSelection();if(_28e){var _28d=_28a.model.getChunk(_28e);if(_28d&&_28d!=""){_28c(_28d);_28a.ui.actions.beginEdit("cut");_28a.ui.actions.deleteSelection(_28e);_28a.ui.actions.endEdit();}}}else{if(e.keyCode==86){if(e.target==dojo.byId("command")){return;}_28b.select();setTimeout(function(){var args=bespin.editor.utils.buildArgs();args.chunk=_28b.value;if(args.chunk){_28a.ui.actions.beginEdit("paste");_28a.ui.actions.insertChunk(args);_28a.ui.actions.endEdit();}_28a.setFocus(true);},0);}}}}});},uninstall:function(){dojo.disconnect(this.keyDown);if(this.copynpaster){document.body.removeChild(copynpaster);}this.copynpaster=undefined;}});dojo.declare("bespin.editor.clipboard.EditorOnly",null,{install:function(){var _28f=bespin.get("editor");_28f.bindKey("copySelection","CMD C");_28f.bindKey("pasteFromClipboard","CMD V");_28f.bindKey("cutSelection","CMD X");}});bespin.editor.clipboard.Manual=function(){var _290;return {copy:function(_291){try{if(netscape.security.PrivilegeManager.enablePrivilege){netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");}else{_290=_291;return;}}catch(ex){_290=_291;return;}var str=Components.classes["@mozilla.org/supports-string;1"].createInstance(Components.interfaces.nsISupportsString);str.data=_291;var _292=Components.classes["@mozilla.org/widget/transferable;1"].createInstance(Components.interfaces.nsITransferable);if(!_292){return false;}_292.addDataFlavor("text/unicode");_292.setTransferData("text/unicode",str,_291.length*2);var _293=Components.interfaces.nsIClipboard;var clip=Components.classes["@mozilla.org/widget/clipboard;1"].getService(_293);if(!clip){return false;}clip.setData(_292,null,_293.kGlobalClipboard);},data:function(){try{if(netscape.security.PrivilegeManager.enablePrivilege){netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");}else{return _290;}}catch(ex){return _290;}var clip=Components.classes["@mozilla.org/widget/clipboard;1"].getService(Components.interfaces.nsIClipboard);if(!clip){return false;}var _294=Components.classes["@mozilla.org/widget/transferable;1"].createInstance(Components.interfaces.nsITransferable);if(!_294){return false;}_294.addDataFlavor("text/unicode");clip.getData(_294,clip.kGlobalClipboard);var str={};var _295={};var _296="";_294.getTransferData("text/unicode",str,_295);if(str){str=str.value.QueryInterface(Components.interfaces.nsISupportsString);}if(str){_296=str.data.substring(0,_295.value/2);}return _296;}};}();}if(!dojo._hasResource["bespin.editor.cursor"]){dojo._hasResource["bespin.editor.cursor"]=true;dojo.provide("bespin.editor.cursor");dojo.declare("bespin.editor.CursorManager",null,{constructor:function(_297){this.editor=_297;this.position={row:0,col:0};this.virtualCol=0;},getCursorPosition:function(_298){if(_298==undefined){return this.position;}var pos=bespin.editor.utils.copyPos(_298);var line=[];if(this.editor.model.hasRow(pos.row)){line=this.editor.model.getRowArray(pos.row);}var _299=this.editor.getTabSize();if(line.indexOf("\t")!=-1){var tabs=0,_29a=0;for(var i=0;i<_298.col;i++){if(line[i]=="\t"){pos.col+=_299-1-(_29a%_299);tabs++;_29a=0;}else{_29a++;tabs=0;}}}return pos;},getModelPosition:function(pos){pos=(pos!=undefined)?pos:this.position;var _29b=bespin.editor.utils.copyPos(pos);var line=[];if(this.editor.model.hasRow(pos.row)){line=this.editor.model.getRowArray(pos.row);}var _29c=this.editor.getTabSize();if(line.indexOf("\t")!=-1){var _29d=0;for(var i=0;i<_29b.col;i++){var _29e=_29d;if(line[i]=="\t"){_29e=Math.floor((_29d+_29c)/_29c)*_29c;}else{_29e+=1;}if(_29e>_29b.col){break;}_29d=_29e;}_29b.col=i;}return _29b;},getCharacterLength:function(_29f,_2a0){if(_29f.length>1){return;}if(_2a0==undefined){_2a0=this.position.col;}if(_29f=="\t"){var _2a1=this.editor.getTabSize();return (_2a1-(_2a0%_2a1));}else{return 1;}},getStringLength:function(str){if(!str||str.length==0){return 0;}var _2a2=0;str=str.split("");for(var x=0;x<str.length;x++){_2a2+=this.getCharacterLength(str[x],_2a2);}return _2a2;},getLeadingWhitespace:function(_2a3){var row=this.editor.model.getRowArray(_2a3).join("");var _2a4=/^(\s+).*/.exec(row);return (_2a4&&_2a4.length==2?this.getStringLength(_2a4[1]):0);},getContinuousSpaceCount:function(from,to,_2a5){_2a5=_2a5||this.position.row;var _2a6=bespin.get("settings");var row=this.editor.model.getRowArray(_2a5);var _2a7=(from<to?1:-1);var _2a8=row.length;from=from+(_2a7==1?0:-1);to=to+(_2a7==1?0:-1);from=this.getModelPosition({col:from,row:_2a5}).col;to=this.getModelPosition({col:to,row:_2a5}).col;if(_2a6&&_2a6.isSettingOn("strictlines")){from=Math.min(from,_2a8);to=Math.min(to,_2a8);}var _2a9=0;for(var x=from;x!=to;x+=_2a7){if(x<_2a8){if(row[x]!=" "){break;}}_2a9++;}return _2a9;},getNextTablevelLeft:function(col){var _2aa=this.editor.getTabSize();col=col||this.position.col;col--;return Math.floor(col/_2aa)*_2aa;},getNextTablevelRight:function(col){var _2ab=this.editor.getTabSize();col=col||this.position.col;col++;return Math.ceil(col/_2ab)*_2ab;},moveToLineStart:function(){var _2ac=bespin.editor.utils.copyPos(this.position);var _2ad=this.getLeadingWhitespace(_2ac.row);if(this.position.col==0){this.moveCursor({col:_2ad});}else{if(this.position.col==_2ad){this.moveCursor({col:0});}else{if(_2ad!=this.editor.ui.getRowScreenLength(this.editor.cursorManager.getCursorPosition().row)){this.moveCursor({col:_2ad});}else{this.moveCursor({col:0});}}}return {oldPos:_2ac,newPos:bespin.editor.utils.copyPos(this.position)};},moveToLineEnd:function(){var _2ae=bespin.editor.utils.copyPos(this.position);this.moveCursor({col:this.editor.ui.getRowScreenLength(_2ae.row)});return {oldPos:_2ae,newPos:bespin.editor.utils.copyPos(this.position)};},moveToTop:function(){var _2af=bespin.editor.utils.copyPos(this.position);this.editor.cursorManager.moveCursor({row:0,col:0});return {oldPos:_2af,newPos:bespin.editor.utils.copyPos(this.position)};},moveToBottom:function(){var _2b0=bespin.editor.utils.copyPos(this.position);var row=this.editor.model.getRowCount()-1;this.editor.cursorManager.moveCursor({row:row,col:this.editor.ui.getRowScreenLength(row)});return {oldPos:_2b0,newPos:bespin.editor.utils.copyPos(this.position)};},moveUp:function(){var _2b1=bespin.get("settings");var _2b2=this.editor.getSelection();var _2b3=bespin.editor.utils.copyPos(this.position);var _2b4=this.virtualCol;this.moveCursor({row:_2b3.row-1,col:Math.max(_2b3.col,this.virtualCol)});if((_2b1&&_2b1.isSettingOn("strictlines"))&&this.position.col>this.editor.ui.getRowScreenLength(this.position.row)){this.moveToLineEnd();this.virtualCol=Math.max(_2b3.col,_2b4);}return {oldPos:_2b3,newPos:bespin.editor.utils.copyPos(this.position)};},moveDown:function(){var _2b5=bespin.get("settings");var _2b6=this.editor.getSelection();var _2b7=bespin.editor.utils.copyPos(this.position);var _2b8=this.virtualCol;this.moveCursor({row:Math.max(0,_2b7.row+1),col:Math.max(_2b7.col,this.virtualCol)});if((_2b5&&_2b5.isSettingOn("strictlines"))&&this.position.col>this.editor.ui.getRowScreenLength(this.position.row)){this.moveToLineEnd();this.virtualCol=Math.max(_2b7.col,_2b8);}return {oldPos:_2b7,newPos:bespin.editor.utils.copyPos(this.position)};},moveLeft:function(args){var _2b9=bespin.get("settings");var _2ba=bespin.editor.utils.copyPos(this.position);var _2bb=(args.event?args.event.shiftKey:false);if(!this.editor.getSelection()||_2bb){if(_2b9&&_2b9.isSettingOn("smartmove")){var _2bc=this.getContinuousSpaceCount(_2ba.col,this.getNextTablevelLeft());if(_2bc==this.editor.getTabSize()){this.moveCursor({col:_2ba.col-_2bc});return {oldPos:_2ba,newPos:bespin.editor.utils.copyPos(this.position)};}}if((_2b9&&_2b9.isSettingOn("strictlines"))&&(this.position.col==0)){this.moveUp();if(_2ba.row>0){this.moveToLineEnd();}}else{this.moveCursor({row:_2ba.row,col:Math.max(0,_2ba.col-1)});}}else{this.moveCursor(this.editor.getSelection().startPos);}return {oldPos:_2ba,newPos:bespin.editor.utils.copyPos(this.position)};},moveRight:function(args){var _2bd=bespin.get("settings");var _2be=bespin.editor.utils.copyPos(this.position);var _2bf=(args.event?args.event.shiftKey:false);if(!this.editor.getSelection()||_2bf){if((_2bd&&_2bd.isSettingOn("smartmove"))&&args!=true){var _2c0=this.getContinuousSpaceCount(_2be.col,this.getNextTablevelRight());if(_2c0==this.editor.getTabSize()){this.moveCursor({col:_2be.col+_2c0});return {oldPos:_2be,newPos:bespin.editor.utils.copyPos(this.position)};}}if((_2bd&&_2bd.isSettingOn("strictlines"))&&(this.position.col>=this.editor.ui.getRowScreenLength(this.position.row))){this.moveDown();if(_2be.row<this.editor.model.getRowCount()-1){this.moveCursor({col:0});}}else{this.moveCursor({col:this.position.col+1});}}else{this.moveCursor(this.editor.getSelection().endPos);}return {oldPos:_2be,newPos:bespin.editor.utils.copyPos(this.position)};},movePageUp:function(){var _2c1=bespin.get("settings");var _2c2=this.editor.getSelection();var _2c3=bespin.editor.utils.copyPos(this.position);var _2c4=this.virtualCol;this.moveCursor({row:Math.max(this.editor.ui.firstVisibleRow-this.editor.ui.visibleRows,0)});if((_2c1&&_2c1.isSettingOn("strictlines"))&&this.position.col>this.editor.ui.getRowScreenLength(this.position.row)){this.moveToLineEnd();this.virtualCol=Math.max(_2c3.col,_2c4);}return {oldPos:_2c3,newPos:bespin.editor.utils.copyPos(this.position)};},movePageDown:function(){var _2c5=bespin.get("settings");var _2c6=this.editor.getSelection();var _2c7=bespin.editor.utils.copyPos(this.position);var _2c8=this.virtualCol;this.moveCursor({row:Math.min(this.position.row+this.editor.ui.visibleRows,this.editor.model.getRowCount()-1)});if((_2c5&&_2c5.isSettingOn("strictlines"))&&this.position.col>this.editor.ui.getRowScreenLength(this.position.row)){this.moveToLineEnd();this.virtualCol=Math.max(_2c7.col,_2c8);}return {oldPos:_2c7,newPos:bespin.editor.utils.copyPos(this.position)};},smartMoveLeft:function(){var _2c9=bespin.editor.utils.copyPos(this.position);var row=this.editor.ui.getRowString(_2c9.row);var c,_2ca;if(this.position.col==0){this.moveUp();this.moveToLineEnd();}else{if(row.length<this.position.col){this.moveToLineEnd();}var _2cb=this.position.col;var _2cc=false;while(_2cb>0){_2cb--;c=row.charAt(_2cb);_2ca=c.charCodeAt(0);if(_2ca==32){_2cc=true;}else{_2cb++;break;}}if(!_2cc){while(_2cb>0){_2cb--;c=row.charAt(_2cb);_2ca=c.charCodeAt(0);if((_2ca<65)||(_2ca>122)){if(_2cb!=this.position.col-1){_2cb++;}break;}}}this.moveCursor({col:_2cb});}return {oldPos:_2c9,newPos:bespin.editor.utils.copyPos(this.position)};},smartMoveRight:function(){var _2cd=bespin.editor.utils.copyPos(this.position);var row=this.editor.ui.getRowString(_2cd.row);if(row.length<=this.position.col){this.moveDown();this.moveToLineStart();}else{var c,_2ce;var _2cf=this.position.col;var _2d0=false;while(_2cf<row.length){c=row[_2cf];_2ce=c.charCodeAt(0);if(_2ce==32){_2d0=true;_2cf++;}else{break;}}if(!_2d0){while(_2cf<row.length){_2cf++;if(row.length==_2cf){this.moveToLineEnd();_2cf=-1;break;}c=row[_2cf];_2ce=c.charCodeAt(0);if((_2ce<65)||(_2ce>122)){break;}}}if(_2cf!=-1){this.moveCursor({col:_2cf});}}return {oldPos:_2cd,newPos:bespin.editor.utils.copyPos(this.position)};},moveCursor:function(_2d1){if(!_2d1){return;}if(_2d1.col===undefined){_2d1.col=this.position.col;}if(_2d1.row===undefined){_2d1.row=this.position.row;}this.virtualCol=0;var _2d2=this.position;var row=Math.min(_2d1.row,this.editor.model.getRowCount()-1);if(row<0){row=0;}var _2d3=this.isInvalidCursorPosition(row,_2d1.col);if(_2d3){if(_2d2.row!=_2d1.row){_2d1.col=_2d3.right;}else{if(_2d2.col<_2d1.col){_2d1.col=_2d3.right;}else{if(_2d2.col>_2d1.col){_2d1.col=_2d3.left;}else{_2d1.col=_2d3.right;}}}}this.position={row:row,col:_2d1.col};var _2d4=bespin.get("editor").ui;_2d4.showCursor=true;_2d4.toggleCursorAllowed=false;},isInvalidCursorPosition:function(row,col){var _2d5=this.editor.model.getRowArray(row);var _2d6=0;for(var i=0;i<_2d5.length;i++){if(_2d5[i].charCodeAt(0)==9){var _2d7=this.editor.getTabSize()-(_2d6%this.editor.getTabSize());if((col>_2d6)&&(col<(_2d6+_2d7))){return {left:_2d6,right:_2d6+_2d7,half:_2d7/2};}_2d6+=_2d7-1;}_2d6++;}return undefined;}});}if(!dojo._hasResource["bespin.editor.editor"]){dojo._hasResource["bespin.editor.editor"]=true;dojo.provide("bespin.editor.editor");dojo.declare("bespin.editor.Scrollbar",null,{HORIZONTAL:"horizontal",VERTICAL:"vertical",MINIMUM_HANDLE_SIZE:20,constructor:function(ui,_2d8,rect,_2d9,min,max,_2da){this.ui=ui;this.orientation=_2d8;this.rect=rect;this.value=_2d9;this.min=min;this.max=max;this.extent=_2da;this.mousedownScreenPoint;this.mousedownValue;},getHandleBounds:function(){var sx=(this.isH())?this.rect.x:this.rect.y;var sw=(this.isH())?this.rect.w:this.rect.h;var _2db=this.extent/(this.max+this.extent);var asw=_2db*sw;if(asw<this.MINIMUM_HANDLE_SIZE){asw=this.MINIMUM_HANDLE_SIZE;}sx+=(sw-asw)*(this.value/(this.max-this.min));return (this.isH())?new bespin.editor.Rect(Math.floor(sx),this.rect.y,asw,this.rect.h):new bespin.editor.Rect(this.rect.x,sx,this.rect.w,asw);},isH:function(){return (!(this.orientation==this.VERTICAL));},fixValue:function(_2dc){if(_2dc<this.min){_2dc=this.min;}if(_2dc>this.max){_2dc=this.max;}return _2dc;},onmousewheel:function(e){var _2dd=dojo.byId("command_output");var _2de=e.target||e.originalTarget;if(_2dd&&(_2de.id=="command_output"||bespin.util.contains(_2dd,_2de))){return;}if(!this.ui.editor.focus){return;}var _2df=bespin.util.mousewheelevent.wheel(e);var axis=bespin.util.mousewheelevent.axis(e);if(this.orientation==this.VERTICAL&&axis==this.VERTICAL){this.setValue(this.value+(_2df*this.ui.lineHeight));}else{if(this.orientation==this.HORIZONTAL&&axis==this.HORIZONTAL){this.setValue(this.value+(_2df*this.ui.charWidth));}}},onmousedown:function(e){var _2e0=e.clientY-this.ui.getTopOffset();var _2e1=e.clientX-this.ui.getLeftOffset();var bar=this.getHandleBounds();if(bar.contains({x:_2e1,y:_2e0})){this.mousedownScreenPoint=(this.isH())?e.screenX:e.screenY;this.mousedownValue=this.value;}else{var p=(this.isH())?_2e1:_2e0;var b1=(this.isH())?bar.x:bar.y;var b2=(this.isH())?bar.x2:bar.y2;if(p<b1){this.setValue(this.value-=this.extent);}else{if(p>b2){this.setValue(this.value+=this.extent);}}}},onmouseup:function(e){this.mousedownScreenPoint=null;this.mousedownValue=null;if(this.valueChanged){this.valueChanged();}},onmousemove:function(e){if(this.mousedownScreenPoint){var diff=((this.isH())?e.screenX:e.screenY)-this.mousedownScreenPoint;var _2e2=diff/(this.isH()?this.rect.w:this.rect.h);this.setValue(this.mousedownValue+Math.floor(((this.max+this.extent)-this.min)*_2e2));}},setValue:function(_2e3){this.value=this.fixValue(_2e3);if(this.valueChanged){this.valueChanged();}}});dojo.declare("bespin.editor.Rect",null,{constructor:function(x,y,w,h){this.x=x;this.y=y;this.w=w;this.h=h;this.x2=x+w;this.y2=y+h;},contains:function(_2e4){if(!this.x){return false;}return ((this.x<=_2e4.x)&&((this.x+this.w)>=_2e4.x)&&(this.y<=_2e4.y)&&((this.y+this.h)>=_2e4.y));}});dojo.declare("bespin.editor.SelectionHelper",null,{constructor:function(_2e5){this.editor=_2e5;},getRowSelectionPositions:function(_2e6){var _2e7;var _2e8;var _2e9=this.editor.getSelection();if(!_2e9){return undefined;}if((_2e9.endPos.row<_2e6)||(_2e9.startPos.row>_2e6)){return undefined;}_2e7=(_2e9.startPos.row<_2e6)?0:_2e9.startPos.col;_2e8=(_2e9.endPos.row>_2e6)?-1:_2e9.endPos.col;return {startCol:_2e7,endCol:_2e8};}});dojo.mixin(bespin.editor,{utils:{buildArgs:function(_2ea){return {pos:bespin.editor.utils.copyPos(_2ea||bespin.get("editor").getCursorPos())};},changePos:function(args,pos){return {pos:bespin.editor.utils.copyPos(oldPos||bespin.get("editor").getCursorPos())};},copyPos:function(_2eb){return {row:_2eb.row,col:_2eb.col};},posEquals:function(pos1,pos2){if(pos1==pos2){return true;}if(!pos1||!pos2){return false;}return (pos1.col==pos2.col)&&(pos1.row==pos2.row);},diffObjects:function(o1,o2){var _2ec={};if(!o1||!o2){return undefined;}for(var key in o1){if(o2[key]){if(o1[key]!=o2[key]){_2ec[key]=o1[key]+" => "+o2[key];}}else{_2ec[key]="o1: "+key+" = "+o1[key];}}for(var key2 in o2){if(!o1[key2]){_2ec[key2]="o2: "+key2+" = "+o2[key2];}}return _2ec;}}});dojo.declare("bespin.editor.DefaultEditorKeyListener",null,{constructor:function(_2ed){this.editor=_2ed;this.actions=_2ed.ui.actions;this.skipKeypress=false;this.defaultKeyMap={};this.keyMap=this.defaultKeyMap;this.keyMapDescriptions={};},bindKey:function(_2ee,_2ef,_2f0,_2f1,_2f2,_2f3,name){this.defaultKeyMap[[_2ee,_2ef,_2f0,_2f1,_2f2]]=(typeof _2f3=="string")?function(){var _2f4=bespin.events.toFire(_2f3);bespin.publish(_2f4.name,_2f4.args);}:dojo.hitch(this.actions,_2f3);if(name){this.keyMapDescriptions[[_2ee,_2ef,_2f0,_2f1,_2f2]]=name;}},bindKeyForPlatform:function(_2f5,_2f6,name,_2f7){var _2f8=bespin.util.getOS();var _2f9=_2f5[_2f8]||_2f5["WINDOWS"];if(!_2f9){return;}var args=bespin.util.keys.fillArguments(_2f9);var _2fa=(_2f7)?"bindKeyStringSelectable":"bindKeyString";this[_2fa](args.modifiers,bespin.util.keys.toKeyCode(args.key),_2f6,name);},bindKeyString:function(_2fb,_2fc,_2fd,name){var _2fe=(_2fb.toUpperCase().indexOf("CTRL")!=-1);var _2ff=(_2fb.toUpperCase().indexOf("ALT")!=-1);var _300=(_2fb.toUpperCase().indexOf("META")!=-1)||(_2fb.toUpperCase().indexOf("APPLE")!=-1);var _301=(_2fb.toUpperCase().indexOf("SHIFT")!=-1);if(_2fb.toUpperCase().indexOf("CMD")!=-1){if(bespin.util.isMac()){_300=true;}else{_2fe=true;}}return this.bindKey(_2fc,_300,_2fe,_2ff,_301,_2fd,name);},bindKeyStringSelectable:function(_302,_303,_304,name){this.bindKeyString(_302,_303,_304,name);this.bindKeyString("SHIFT "+_302,_303,_304);},getPrintableChar:function(e){if(e.charCode>255){return false;}if(e.charCode<32){return false;}if((e.altKey||e.metaKey||e.ctrlKey)&&(e.charCode>65&&e.charCode<123)){return false;}return String.fromCharCode(e.charCode);},onkeydown:function(e){if(!this.editor.focus){return;}var args={event:e,pos:bespin.editor.utils.copyPos(this.editor.cursorManager.getCursorPosition())};this.skipKeypress=false;this.returnValue=false;var _305=this.keyMap[[e.keyCode,e.metaKey,e.ctrlKey,e.altKey,e.shiftKey]];var _306=false;if(dojo.isFunction(_305)){_306=true;try{_305(args);}catch(e){console.log("Action caused an error! ",e);}this.lastAction=_305;}if(e.metaKey||e.ctrlKey||e.altKey){this.skipKeypress=true;this.returnValue=true;}if(_306||!bespin.util.keys.passThroughToBrowser(e)){dojo.stopEvent(e);}},onkeypress:function(e){if(!this.editor.focus){return;}if((e.metaKey||e.ctrlKey)&&e.charCode>=48&&e.charCode<=57){return;}var _307=this.getPrintableChar(e);if(_307){this.skipKeypress=false;}else{if(this.skipKeypress){if(!bespin.util.keys.passThroughToBrowser(e)){dojo.stopEvent(e);}return this.returnValue;}}var args={event:e,pos:bespin.editor.utils.copyPos(this.editor.cursorManager.getCursorPosition())};var _308=this.editor.ui.actions;if(_307){args.newchar=String.fromCharCode(e.charCode);_308.insertCharacter(args);}else{var _309=this.keyMap[[e.keyCode,e.metaKey,e.ctrlKey,e.altKey,e.shiftKey]];if(this.lastAction==_309){delete this.lastAction;}else{if(typeof _309=="function"){_309(args);}}}dojo.stopEvent(e);}});dojo.declare("bespin.editor.UI",null,{constructor:function(_30a){this.editor=_30a;this.model=this.editor.model;var _30b=bespin.get("settings");this.syntaxModel=bespin.syntax.Resolver.setEngine("simple").getModel();this.selectionHelper=new bespin.editor.SelectionHelper(_30a);this.actions=new bespin.editor.Actions(_30a);this.rowLengthCache=[];this.searchString=null;this.toggleCursorFullRepaintCounter=0;this.toggleCursorFrequency=250;this.toggleCursorAllowed=true;this.horizontalScrollCanvas=dojo.create("canvas");this.verticalScrollCanvas=dojo.create("canvas");this.gutterWidth=54;this.LINE_HEIGHT=23;this.BOTTOM_SCROLL_AFFORDANCE=30;this.GUTTER_INSETS={top:0,left:6,right:10,bottom:6};this.LINE_INSETS={top:0,left:5,right:0,bottom:6};this.FALLBACK_CHARACTER_WIDTH=10;this.NIB_WIDTH=15;this.NIB_INSETS={top:Math.floor(this.NIB_WIDTH/2),left:Math.floor(this.NIB_WIDTH/2),right:Math.floor(this.NIB_WIDTH/2),bottom:Math.floor(this.NIB_WIDTH/2)};this.NIB_ARROW_INSETS={top:3,left:3,right:3,bottom:5};this.DEBUG_GUTTER_WIDTH=18;this.DEBUG_GUTTER_INSETS={top:2,left:2,right:2,bottom:2};this.xoffset=0;this.yoffset=0;this.showCursor=true;this.overXScrollBar=false;this.overYScrollBar=false;this.hasFocus=false;var _30c=this.editor.container;this.globalHandles=[];dojo.connect(_30c,"mousemove",this,"handleMouse");dojo.connect(_30c,"mouseout",this,"handleMouse");dojo.connect(_30c,"click",this,"handleMouse");dojo.connect(_30c,"mousedown",this,"handleMouse");dojo.connect(_30c,"oncontextmenu",dojo.stopEvent);dojo.connect(_30c,"mousedown",this,"mouseDownSelect");this.globalHandles.push(dojo.connect(window,"mousemove",this,"mouseMoveSelect"));this.globalHandles.push(dojo.connect(window,"mouseup",this,"mouseUpSelect"));this.lastLineCount=0;this.lastCursorPos=null;this.lastxoffset=0;this.lastyoffset=0;var _30d=_30a.opts.actsAsComponent?_30a.canvas:window;this.xscrollbar=new bespin.editor.Scrollbar(this,"horizontal");this.xscrollbar.valueChanged=dojo.hitch(this,function(){this.xoffset=-this.xscrollbar.value;this.editor.paint();});this.globalHandles.push(dojo.connect(window,"mousemove",this.xscrollbar,"onmousemove"));this.globalHandles.push(dojo.connect(window,"mouseup",this.xscrollbar,"onmouseup"));this.globalHandles.push(dojo.connect(_30d,(!dojo.isMozilla?"onmousewheel":"DOMMouseScroll"),this.xscrollbar,"onmousewheel"));this.yscrollbar=new bespin.editor.Scrollbar(this,"vertical");this.yscrollbar.valueChanged=dojo.hitch(this,function(){this.yoffset=-this.yscrollbar.value;this.editor.paint();});this.globalHandles.push(dojo.connect(window,"mousemove",this.yscrollbar,"onmousemove"));this.globalHandles.push(dojo.connect(window,"mouseup",this.yscrollbar,"onmouseup"));this.globalHandles.push(dojo.connect(_30d,(!dojo.isMozilla?"onmousewheel":"DOMMouseScroll"),this.yscrollbar,"onmousewheel"));setTimeout(dojo.hitch(this,function(){this.toggleCursor(this);}),this.toggleCursorFrequency);},convertClientPointToCursorPoint:function(pos){var _30e=bespin.get("settings");var x,y;if(pos.y<0){y=0;}else{if(pos.y>=(this.lineHeight*this.editor.model.getRowCount())){y=this.editor.model.getRowCount()-1;}else{var ty=pos.y;y=Math.floor(ty/this.lineHeight);}}if(pos.x<=(this.gutterWidth+this.LINE_INSETS.left)){x=-1;}else{var tx=pos.x-this.gutterWidth-this.LINE_INSETS.left;x=Math.round(tx/this.charWidth);if((_30e&&_30e.isSettingOn("strictlines"))){var _30f=this.getRowScreenLength(y);if(x>=_30f){x=this.getRowScreenLength(y);}}}return {row:y,col:x};},mouseDownSelect:function(e){if(!this.editor.focus){return;}if(e.button==2){dojo.stopEvent(e);return false;}var _310=e.clientY-this.getTopOffset();var _311=e.clientX-this.getLeftOffset();if(this.overXScrollBar||this.overYScrollBar){return;}if(this.editor.debugMode){if(_311<this.DEBUG_GUTTER_WIDTH){console.log("Clicked in debug gutter");var _312={x:_311,y:_310};_312.y+=Math.abs(this.yoffset);var p=this.convertClientPointToCursorPoint(_312);var _313=bespin.get("editSession");if(p&&_313){bespin.getComponent("breakpoints",function(_314){_314.toggleBreakpoint({project:_313.project,path:_313.path,lineNumber:p.row});this.editor.paint(true);},this);}return;}}this.selectMouseDetail=e.detail;if(e.shiftKey){this.selectMouseDownPos=(this.editor.selection)?this.editor.selection.startPos:this.editor.getCursorPos();this.setSelection(e);}else{var _312={x:_311,y:_310};_312.x+=Math.abs(this.xoffset);_312.y+=Math.abs(this.yoffset);if((this.xscrollbar.rect.contains(_312))||(this.yscrollbar.rect.contains(_312))){return;}this.selectMouseDownPos=this.convertClientPointToCursorPoint(_312);}},mouseMoveSelect:function(e){if(!this.editor.focus){return;}this.setSelection(e);},mouseUpSelect:function(e){if(!this.editor.focus){return;}this.setSelection(e);this.selectMouseDownPos=undefined;this.selectMouseDetail=undefined;},setSelection:function(e){var _315=e.clientY-this.getTopOffset();var _316=e.clientX-this.getLeftOffset();if(!this.selectMouseDownPos){return;}var down=bespin.editor.utils.copyPos(this.selectMouseDownPos);var _317={x:_316,y:_315};_317.x+=Math.abs(this.xoffset);_317.y+=Math.abs(this.yoffset);var up=this.convertClientPointToCursorPoint(_317);if(down.col==-1){down.col=0;var _318=bespin.get("parser").getLineMarkers()[down.row+1];if(_318){bespin.get("commandLine").showHint(_318.msg);}}if(up.col==-1){up.col=0;}var _319=this.editor.getModelPos(down);var _31a=this.editor.getModelPos(up);var _31b=false;if(_31a.row<_319.row||(_31a.row==_319.row&&_31a.col<_319.col)){_31b=true;var temp=_319;_319=_31a;_31a=temp;}if(!this.editor.model.hasRow(_319.row)){_319.row=this.editor.model.getRowCount()-1;}if(!this.editor.model.hasRow(_31a.row)){_31a.row=this.editor.model.getRowCount()-1;}var _31c=this.selectMouseDetail;if(_31c==1){if(bespin.editor.utils.posEquals(_319,_31a)){this.editor.setSelection(undefined);}else{this.editor.setSelection({startPos:this.editor.getCursorPos(_31b?_31a:_319),endPos:this.editor.getCursorPos(_31b?_319:_31a)});}this.editor.moveCursor(this.editor.getCursorPos(_31b?_319:_31a));}else{if(_31c==2){var row=this.editor.model.rows[_319.row];var _31d=row[_319.col];var _31e=function(item){var _31f=["="," ","\t",">","<",".","(",")","{","}",":","\"","'",";"];if(_31f.indexOf(item)>-1){return true;}return false;};if(!_31d){this.editor.setSelection({startPos:this.editor.getCursorPos({row:_319.row,col:0}),endPos:this.editor.getCursorPos({row:_319.row,col:row.length})});}else{if(_31e(_31d.charAt(0))){var _320=function(_321){if(_31e(_321)){return false;}return true;};var _322=this.editor.model.findBefore(_319.row,_319.col,_320);var _323=this.editor.model.findAfter(_31a.row,_31a.col,_320);this.editor.setSelection({startPos:this.editor.getCursorPos(_31b?_323:_322),endPos:this.editor.getCursorPos(_31b?_322:_323)});this.editor.moveCursor(this.editor.getCursorPos(_31b?_322:_323));}else{var _320=function(_324){if(_31e(_324)){return true;}return false;};var _322=this.editor.model.findBefore(_319.row,_319.col,_320);var _323=this.editor.model.findAfter(_31a.row,_31a.col,_320);this.editor.setSelection({startPos:this.editor.getCursorPos(_31b?_323:_322),endPos:this.editor.getCursorPos(_31b?_322:_323)});this.editor.moveCursor(this.editor.getCursorPos(_31b?_322:_323));}}}else{if(_31c>2){var _322={row:_319.row,col:0};var _323={row:_31a.row,col:0};if(this.editor.model.hasRow(_323.row+1)){_323.row=_323.row+1;}else{_323.col=this.editor.model.getRowArray(_323.row).length;}_322=this.editor.getCursorPos(_322);_323=this.editor.getCursorPos(_323);this.editor.setSelection({startPos:_31b?_323:_322,endPos:_31b?_322:_323});this.editor.moveCursor(_31b?_322:_323);}}}if(_315<0){this.yoffset=Math.min(1,this.yoffset+(-_315));}else{if(_315>=this.getHeight()){var _325=this.lineHeight*this.editor.model.getRowCount();this.yoffset=Math.max(-(_325-this.getHeight()-this.BOTTOM_SCROLL_AFFORDANCE),this.yoffset-_315-this.getHeight());}}this.editor.paint();},toggleCursor:function(ui){if(ui.toggleCursorAllowed){ui.showCursor=!ui.showCursor;}else{ui.toggleCursorAllowed=true;}if(++this.toggleCursorFullRepaintCounter>0){this.toggleCursorFullRepaintCounter=0;ui.editor.paint(true);}else{ui.editor.paint();}setTimeout(function(){ui.toggleCursor(ui);},ui.toggleCursorFrequency);},ensureCursorVisible:function(_326){if((!this.lineHeight)||(!this.charWidth)){return;}if(bespin.get("settings")){var _327=parseFloat(bespin.get("settings").get("pagescroll"))||0;}else{var _327=0;}_327=(!_326?Math.max(0,Math.min(1,_327)):0.25);var y=this.lineHeight*this.editor.cursorManager.getCursorPosition().row;var x=this.charWidth*this.editor.cursorManager.getCursorPosition().col;var _328=this.getHeight();var _329=this.getWidth()-this.gutterWidth;if(Math.abs(this.yoffset)>y){this.yoffset=Math.min(-y+_328*_327,0);}else{if((Math.abs(this.yoffset)+_328)<(y+this.lineHeight)){this.yoffset=-((y+this.lineHeight)-_328*(1-_327));this.yoffset=Math.max(this.yoffset,_328-this.lineHeight*this.model.getRowCount());}}if(Math.abs(this.xoffset)>x){this.xoffset=-x;}else{if((Math.abs(this.xoffset)+_329)<(x+(this.charWidth*2))){this.xoffset=-((x+(this.charWidth*2))-_329);}}},handleFocus:function(e){this.editor.model.clear();this.editor.model.insertCharacters({row:0,col:0},e.type);},handleMouse:function(e){if(e.button==2){bespin.getComponent("piemenu",function(_32a){_32a.show(null,false,e.clientX,e.clientY);});dojo.stopEvent(e);return false;}var _32b=e.clientY-this.getTopOffset();var _32c=e.clientX-this.getLeftOffset();var oldX=this.overXScrollBar;var oldY=this.overYScrollBar;var _32d=false;var w=this.editor.container.clientWidth;var h=this.editor.container.clientHeight;var sx=w-this.NIB_WIDTH-this.NIB_INSETS.right;var sy=h-this.NIB_WIDTH-this.NIB_INSETS.bottom;var p={x:_32c,y:_32b};if(e.type=="mousedown"){if((this.xscrollbar)&&(this.xscrollbar.rect.contains(p))){this.xscrollbar.onmousedown(e);}else{if((this.yscrollbar)&&(this.yscrollbar.rect.contains(p))){this.yscrollbar.onmousedown(e);}}}if(e.type=="mouseout"){this.overXScrollBar=false;this.overYScrollBar=false;}if((e.type=="mousemove")||(e.type=="click")){this.overYScrollBar=(p.x>sx)&&this.yscrollbarVisible;this.overXScrollBar=(p.y>sy)&&this.xscrollbarVisible;}if(e.type=="click"){if((typeof e.button!="undefined")&&(e.button==0)){var _32e;if(this.nibup.contains(p)){_32e="up";}else{if(this.nibdown.contains(p)){_32e="down";}else{if(this.nibleft.contains(p)){_32e="left";}else{if(this.nibright.contains(p)){_32e="right";}}}}if(_32e=="up"){this.yoffset+=this.lineHeight;_32d=true;}else{if(_32e=="down"){this.yoffset-=this.lineHeight;_32d=true;}else{if(_32e=="left"){this.xoffset+=this.charWidth*2;_32d=true;}else{if(_32e=="right"){this.xoffset-=this.charWidth*2;_32d=true;}}}}}}if((oldX!=this.overXScrollBar)||(oldY!=this.overYScrollBar)||_32d){this.editor.paint(true);}},installKeyListener:function(_32f){var Key=bespin.util.keys.Key;if(this.oldkeydown){dojo.disconnect(this.oldkeydown);}if(this.oldkeypress){dojo.disconnect(this.oldkeypress);}this.oldkeydown=dojo.hitch(_32f,"onkeydown");this.oldkeypress=dojo.hitch(_32f,"onkeypress");var _330=this.editor.opts.actsAsComponent?this.editor.canvas:window;dojo.connect(_330,"keydown",this,"oldkeydown");dojo.connect(_330,"keypress",this,"oldkeypress");_32f.bindKeyStringSelectable("",Key.LEFT_ARROW,this.actions.moveCursorLeft,"Move Cursor Left");_32f.bindKeyStringSelectable("",Key.RIGHT_ARROW,this.actions.moveCursorRight,"Move Cursor Right");_32f.bindKeyStringSelectable("",Key.UP_ARROW,this.actions.moveCursorUp,"Move Cursor Up");_32f.bindKeyStringSelectable("",Key.DOWN_ARROW,this.actions.moveCursorDown,"Move Cursor Down");_32f.bindKeyForPlatform({MAC:"ALT LEFT_ARROW",WINDOWS:"CTRL LEFT_ARROW"},this.actions.moveWordLeft,"Move Word Left",true);_32f.bindKeyForPlatform({MAC:"ALT RIGHT_ARROW",WINDOWS:"CTRL RIGHT_ARROW"},this.actions.moveWordRight,"Move Word Right",true);_32f.bindKeyStringSelectable("",Key.HOME,this.actions.moveToLineStart,"Move to start of line");_32f.bindKeyForPlatform({MAC:"APPLE LEFT_ARROW",WINDOWS:"ALT LEFT_ARROW"},this.actions.moveToLineStart,"Move to start of line",true);_32f.bindKeyStringSelectable("",Key.END,this.actions.moveToLineEnd,"Move to end of line");_32f.bindKeyForPlatform({MAC:"APPLE RIGHT_ARROW",WINDOWS:"ALT RIGHT_ARROW"},this.actions.moveToLineEnd,"Move to end of line",true);_32f.bindKeyString("CTRL",Key.K,this.actions.killLine,"Kill entire line");_32f.bindKeyString("CMD",Key.L,this.actions.gotoLine,"Goto Line");_32f.bindKeyString("CTRL",Key.L,this.actions.moveCursorRowToCenter,"Move cursor to center of page");_32f.bindKeyStringSelectable("",Key.BACKSPACE,this.actions.backspace,"Backspace");_32f.bindKeyStringSelectable("CTRL",Key.BACKSPACE,this.actions.deleteWordLeft,"Delete a word to the left");_32f.bindKeyString("",Key.DELETE,this.actions.deleteKey,"Delete");_32f.bindKeyString("CTRL",Key.DELETE,this.actions.deleteWordRight,"Delete a word to the right");_32f.bindKeyString("",Key.ENTER,this.actions.newline,"Insert newline");_32f.bindKeyString("CMD",Key.ENTER,this.actions.newlineBelow,"Insert newline at end of current line");_32f.bindKeyString("",Key.TAB,this.actions.insertTab,"Indent / insert tab");_32f.bindKeyString("SHIFT",Key.TAB,this.actions.unindent,"Unindent");_32f.bindKeyString("",Key.ESCAPE,this.actions.escape,"Clear fields and dialogs");_32f.bindKeyString("CMD",Key.A,this.actions.selectAll,"Select All");_32f.bindKeyString("CMD",Key.I,this.actions.toggleQuickopen,"Toggle Quickopen");_32f.bindKeyString("CMD",Key.J,this.actions.focusCommandline,"Open Command line");_32f.bindKeyString("CMD",Key.O,this.actions.focusFileBrowser,"Open File Browser");_32f.bindKeyString("CMD",Key.F,this.actions.cmdFilesearch,"Search in this file");_32f.bindKeyString("CMD",Key.G,this.actions.findNext,"Find Next");_32f.bindKeyString("SHIFT CMD",Key.G,this.actions.findPrev,"Find Previous");_32f.bindKeyString("CTRL",Key.M,this.actions.togglePieMenu,"Open Pie Menu");_32f.bindKeyString("CMD",Key.B,bespin.preview.show,"Preview in Browser");_32f.bindKeyString("CMD",Key.Z,this.actions.undo,"Undo");_32f.bindKeyString("SHIFT CMD",Key.Z,this.actions.redo,"Redo");_32f.bindKeyString("CMD",Key.Y,this.actions.redo,"Redo");_32f.bindKeyStringSelectable("CMD",Key.UP_ARROW,this.actions.moveToFileTop,"Move to top of file");_32f.bindKeyStringSelectable("CMD",Key.DOWN_ARROW,this.actions.moveToFileBottom,"Move to bottom of file");_32f.bindKeyStringSelectable("CMD",Key.HOME,this.actions.moveToFileTop,"Move to top of file");_32f.bindKeyStringSelectable("CMD",Key.END,this.actions.moveToFileBottom,"Move to bottom of file");_32f.bindKeyStringSelectable("",Key.PAGE_UP,this.actions.movePageUp,"Move a page up");_32f.bindKeyStringSelectable("",Key.PAGE_DOWN,this.actions.movePageDown,"Move a page down");_32f.bindKeyStringSelectable("ALT",Key.UP_ARROW,this.actions.movePageUp,"Move up a block");_32f.bindKeyStringSelectable("ALT",Key.DOWN_ARROW,this.actions.movePageDown,"Move down a block");_32f.bindKeyString("CMD ALT",Key.LEFT_ARROW,this.actions.previousFile);_32f.bindKeyString("CMD ALT",Key.RIGHT_ARROW,this.actions.nextFile);},getWidth:function(){return parseInt(dojo.style(this.editor.canvas.parentNode,"width"));},getHeight:function(){return parseInt(dojo.style(this.editor.canvas.parentNode,"height"));},getTopOffset:function(){return dojo.coords(this.editor.canvas.parentNode).y||this.editor.canvas.parentNode.offsetTop;},getLeftOffset:function(){return dojo.coords(this.editor.canvas.parentNode).x||this.editor.canvas.parentNode.offsetLeft;},getCharWidth:function(ctx){if(ctx.measureText){return ctx.measureText("M").width;}else{return this.FALLBACK_CHARACTER_WIDTH;}},getLineHeight:function(ctx){var lh=-1;if(ctx.measureText){var t=ctx.measureText("M");if(t.ascent){lh=Math.floor(t.ascent*2.8);}}if(lh==-1){lh=this.LINE_HEIGHT;}return lh;},resetCanvas:function(){dojo.attr(dojo.byId(this.editor.canvas),{width:this.getWidth(),height:this.getHeight()});},fillText:function(ctx,text,x,y){ctx.fillText(text,x,y);},fillTextWithTransparency:function(ctx,text,x,y){ctx.globalAlpha=0.3;ctx.fillText(text,x,y);ctx.globalAlpha=1;},paint:function(ctx,_331){var ed=this.editor;var c=dojo.byId(ed.canvas);var _332=ed.theme;var x,y;var cy;var _333;var _334;var Rect=bespin.editor.Rect;var _335=_331;if(!_335){_335=(this.selectMouseDownPos);}if(!_335){_335=(this.lastLineCount!=ed.model.getRowCount());}this.lastLineCount=ed.model.getRowCount();ctx.font=_332.editorTextFont;this.charWidth=this.getCharWidth(ctx);this.lineHeight=this.getLineHeight(ctx);var _336=this.getWidth();var _337=this.getHeight();if(this.xoffset>0){this.xoffset=0;}if(this.yoffset>0){this.yoffset=0;}this.visibleRows=Math.ceil(_337/this.lineHeight);this.firstVisibleRow=Math.floor(Math.abs(this.yoffset/this.lineHeight));_334=this.firstVisibleRow+this.visibleRows;if(_334>(ed.model.getRowCount()-1)){_334=ed.model.getRowCount()-1;}var _338=this.lineHeight*ed.model.getRowCount();var _339=this.charWidth*(Math.max(this.getMaxCols(this.firstVisibleRow,_334),ed.cursorManager.getCursorPosition().col)+2);this.gutterWidth=this.GUTTER_INSETS.left+this.GUTTER_INSETS.right;this.gutterWidth+=(""+_334).length*this.charWidth;if(this.editor.debugMode){this.gutterWidth+=this.DEBUG_GUTTER_WIDTH;}if(this.xoffset<0){if((Math.abs(this.xoffset))>(_339-(_336-this.gutterWidth))){this.xoffset=(_336-this.gutterWidth)-_339;}}if(this.yoffset<0){if((Math.abs(this.yoffset))>(_338-(_337-this.BOTTOM_SCROLL_AFFORDANCE))){this.yoffset=_337-(_338-this.BOTTOM_SCROLL_AFFORDANCE);}}if((this.xoffset!=this.lastxoffset)||(this.yoffset!=this.lastyoffset)){_335=true;this.lastxoffset=this.xoffset;this.lastyoffset=this.yoffset;}var _33a=((_336-this.gutterWidth)<_339);var _33b=(_337<_338);var _33c=_336-this.NIB_WIDTH-this.NIB_INSETS.right-2;var _33d=_337-this.NIB_WIDTH-this.NIB_INSETS.bottom-2;var _33e=(_33a&&(this.xoffset!=0));var _33f=(_33a&&(this.xoffset>((_336-this.gutterWidth)-_339)));var _340=(_33b&&(this.yoffset!=0));var _341=(_33b&&(this.yoffset>(_337-_338)));if(((dojo.attr(c,"width"))!=_336)||(dojo.attr(c,"height")!=_337)){_335=true;dojo.attr(c,{width:_336,height:_337});}var _342={};var _343=bespin.get("parser").getLineMarkers();if(this.editor.debugMode&&bespin.get("editSession")){bespin.getComponent("breakpoints",function(_344){var _345=_344.getBreakpoints(bespin.get("editSession").project,bespin.get("editSession").path);dojo.forEach(_345,function(_346){_342[_346.lineNumber]=_346;});delete _345;});}if(!_335){var _347=ed.model.getDirtyRows();if((this.lastCursorPos)&&(this.lastCursorPos.row!=ed.cursorManager.getCursorPosition().row)){_347[this.lastCursorPos.row]=true;}_347[ed.cursorManager.getCursorPosition().row]=true;}this.lastCursorPos=bespin.editor.utils.copyPos(ed.cursorManager.getCursorPosition());if(_335){ctx.fillStyle=_332.backgroundStyle;ctx.fillRect(0,0,c.width,c.height);ctx.fillStyle=_332.gutterStyle;ctx.fillRect(0,0,this.gutterWidth,c.height);}ctx.save();ctx.translate(0,Math.round(this.yoffset));if(_335){if(bespin.get("parser")){for(_333=this.firstVisibleRow;_333<=_334;_333++){if(_343[_333]){y=this.lineHeight*(_333-1);cy=y+(this.lineHeight-this.LINE_INSETS.bottom);ctx.fillStyle=this.editor.theme["lineMarker"+_343[_333].type+"Color"];ctx.fillRect(0,y,this.gutterWidth,this.lineHeight);}}}y=(this.lineHeight*this.firstVisibleRow);for(_333=this.firstVisibleRow;_333<=_334;_333++){x=0;if(this.editor.debugMode){if(_342[_333]){var bpx=x+this.DEBUG_GUTTER_INSETS.left;var bpy=y+this.DEBUG_GUTTER_INSETS.top;var bpw=this.DEBUG_GUTTER_WIDTH-this.DEBUG_GUTTER_INSETS.left-this.DEBUG_GUTTER_INSETS.right;var bph=this.lineHeight-this.DEBUG_GUTTER_INSETS.top-this.DEBUG_GUTTER_INSETS.bottom;var _348=bpx+parseInt(bpw/2);var _349=bpy+parseInt(bph/2);ctx.strokeStyle="rgb(128, 0, 0)";ctx.fillStyle="rgb(255, 102, 102)";ctx.beginPath();ctx.arc(_348,_349,bpw/2,0,Math.PI*2,true);ctx.closePath();ctx.fill();ctx.stroke();}x+=this.DEBUG_GUTTER_WIDTH;}x+=this.GUTTER_INSETS.left;cy=y+(this.lineHeight-this.LINE_INSETS.bottom);ctx.fillStyle=_332.lineNumberColor;ctx.font=this.editor.theme.lineNumberFont;ctx.fillText(_333+1,x,cy);y+=this.lineHeight;}}ctx.save();ctx.beginPath();ctx.rect(this.gutterWidth,-this.yoffset,_336-this.gutterWidth,_337);ctx.closePath();ctx.translate(this.xoffset,0);ctx.clip();var _34a=Math.floor(Math.abs(this.xoffset/this.charWidth));var _34b=_34a+(Math.ceil((_336-this.gutterWidth)/this.charWidth));y=(this.lineHeight*this.firstVisibleRow);var cc;var ce;var ri;var _34c;var tx,tw,tsel;var _34d=bespin.get("settings");var _34e=(this.searchString?this.searchString.length:-1);for(_333=this.firstVisibleRow;_333<=_334;_333++){x=this.gutterWidth;if(!_335){if(!_347[_333]){y+=this.lineHeight;continue;}ctx.save();ctx.beginPath();ctx.rect(x+(Math.abs(this.xoffset)),y,_336,this.lineHeight);ctx.closePath();ctx.clip();if((_333%2)==1){ctx.fillStyle=_332.backgroundStyle;ctx.fillRect(x+(Math.abs(this.xoffset)),y,_336,this.lineHeight);}}if((_34d&&_34d.isSettingOn("highlightline"))&&(_333==ed.cursorManager.getCursorPosition().row)){ctx.fillStyle=_332.highlightCurrentLineColor;ctx.fillRect(x+(Math.abs(this.xoffset)),y,_336,this.lineHeight);}else{if((_333%2)==0){ctx.fillStyle=_332.zebraStripeColor;ctx.fillRect(x+(Math.abs(this.xoffset)),y,_336,this.lineHeight);}}x+=this.LINE_INSETS.left;cy=y+(this.lineHeight-this.LINE_INSETS.bottom);var _34f=this.selectionHelper.getRowSelectionPositions(_333);if(_34f){tx=x+(_34f.startCol*this.charWidth);tw=(_34f.endCol==-1)?(_34b-_34a)*this.charWidth:(_34f.endCol-_34f.startCol)*this.charWidth;ctx.fillStyle=_332.editorSelectedTextBackground;ctx.fillRect(tx,y,tw,this.lineHeight);}var _350=this.model.getRowMetadata(_333);var _351=_350.lineText;var _352=_350.searchIndices;var _353=this.syntaxModel.getSyntaxStylesPerLine(_351,_333,this.editor.language);var _354=ed.readonly?this.fillTextWithTransparency:this.fillText;for(ri=0;ri<_353.regions.length;ri++){var _355=_353.regions[ri];for(var _356 in _355){if(!_355.hasOwnProperty(_356)){continue;}var _357="";var _358=_355[_356];var _359=0;for(var si=0;si<_358.length;si++){var _35a=_358[si];for(;_359<_35a.start;_359++){_357+=" ";}_357+=_353.text.substring(_35a.start,_35a.stop);_359=_35a.stop;}ctx.fillStyle=this.editor.theme[_356]||"white";ctx.font=this.editor.theme.editorTextFont;_354(ctx,_357,x,cy);}}if(_352){if(_34f){tsel={startCol:0,endCol:_351.length};if(_34f.startCol!=-1){tsel.startCol=_34f.startCol;}if(_34f.endCol!=-1){tsel.endCol=_34f.endCol;}}else{tsel=false;}for(var i=0;i<_352.length;i++){var _35b=ed.cursorManager.getCursorPosition({col:_352[i],row:_333}).col;tx=x+_35b*this.charWidth;ctx.fillStyle=this.editor.theme.searchHighlight;ctx.fillRect(tx,y,_34e*this.charWidth,this.lineHeight);if(tsel){var _35c=_35b;var _35d=_35b+_34e;if(tsel.startCol<_35d&&tsel.endCol>_35c){_35c=Math.max(_35c,tsel.startCol);_35d=Math.min(_35d,tsel.endCol);ctx.fillStyle=this.editor.theme.searchHighlightSelected;ctx.fillRect(x+_35c*this.charWidth,y,(_35d-_35c)*this.charWidth,this.lineHeight);}}ctx.fillStyle=this.editor.theme.editorTextColor||"white";ctx.fillText(_351.substring(_35b,_35b+_34e),tx,cy);}}if(_34d&&(_34d.isSettingOn("tabarrow")||_34d.isSettingOn("tabshowspace"))){if(_350.tabExpansions.length>0){for(var i=0;i<_350.tabExpansions.length;i++){var _35e=_350.tabExpansions[i];var lx=x+(_35e.start*this.charWidth);var _35f=_34d&&_34d.isSettingOn("tabshowspace");if(_35f){var sw=(_35e.end-_35e.start)*this.charWidth;ctx.fillStyle=this.editor.theme["tabSpace"]||"white";ctx.fillRect(lx,y,sw,this.lineHeight);}var _360=_34d&&_34d.isSettingOn("tabarrow");if(_360){var cy=y+(this.lineHeight/2);var cx=lx+(this.charWidth/2);var tw=4;var th=6;var tx=parseInt(cx-(tw/2));var ty=parseInt(cy-(th/2));ctx.globalAlpha=0.3;ctx.beginPath();ctx.fillStyle=this.editor.theme["plain"]||"white";ctx.moveTo(tx,ty);ctx.lineTo(tx,ty+th);ctx.lineTo(tx+tw,ty+parseInt(th/2));ctx.closePath();ctx.fill();ctx.globalAlpha=1;}}}}if(!_335){ctx.drawImage(this.verticalScrollCanvas,_33c+Math.abs(this.xoffset),Math.abs(this.yoffset));ctx.restore();}y+=this.lineHeight;}if(this.editor.focus){if(this.showCursor){if(ed.theme.cursorType=="underline"){x=this.gutterWidth+this.LINE_INSETS.left+ed.cursorManager.getCursorPosition().col*this.charWidth;y=(ed.getCursorPos().row*this.lineHeight)+(this.lineHeight-5);ctx.fillStyle=ed.theme.cursorStyle;ctx.fillRect(x,y,this.charWidth,3);}else{x=this.gutterWidth+this.LINE_INSETS.left+ed.cursorManager.getCursorPosition().col*this.charWidth;y=(ed.cursorManager.getCursorPosition().row*this.lineHeight);ctx.fillStyle=ed.theme.cursorStyle;ctx.fillRect(x,y,1,this.lineHeight);}}}else{x=this.gutterWidth+this.LINE_INSETS.left+ed.cursorManager.getCursorPosition().col*this.charWidth;y=(ed.cursorManager.getCursorPosition().row*this.lineHeight);ctx.fillStyle=ed.theme.unfocusedCursorFillStyle;ctx.strokeStyle=ed.theme.unfocusedCursorStrokeStyle;ctx.fillRect(x,y,this.charWidth,this.lineHeight);ctx.strokeRect(x,y,this.charWidth,this.lineHeight);}ctx.restore();ctx.restore();if(!_335){return;}if(this.horizontalScrollCanvas.width!=_336){this.horizontalScrollCanvas.width=_336;}if(this.horizontalScrollCanvas.height!=this.NIB_WIDTH+4){this.horizontalScrollCanvas.height=this.NIB_WIDTH+4;}if(this.verticalScrollCanvas.height!=_337){this.verticalScrollCanvas.height=_337;}if(this.verticalScrollCanvas.width!=this.NIB_WIDTH+4){this.verticalScrollCanvas.width=this.NIB_WIDTH+4;}var hctx=this.horizontalScrollCanvas.getContext("2d");hctx.clearRect(0,0,this.horizontalScrollCanvas.width,this.horizontalScrollCanvas.height);hctx.save();var vctx=this.verticalScrollCanvas.getContext("2d");vctx.clearRect(0,0,this.verticalScrollCanvas.width,this.verticalScrollCanvas.height);vctx.save();var _361=(this.overYScrollBar)||(this.yscrollbar.mousedownValue!=null)?{n:ed.theme.fullNibStyle,a:ed.theme.fullNibArrowStyle,s:ed.theme.fullNibStrokeStyle}:{n:ed.theme.partialNibStyle,a:ed.theme.partialNibArrowStyle,s:ed.theme.partialNibStrokeStyle};var _362=(this.overXScrollBar)||(this.xscrollbar.mousedownValue!=null)?{n:ed.theme.fullNibStyle,a:ed.theme.fullNibArrowStyle,s:ed.theme.fullNibStrokeStyle}:{n:ed.theme.partialNibStyle,a:ed.theme.partialNibArrowStyle,s:ed.theme.partialNibStrokeStyle};var _363=Math.floor(this.NIB_WIDTH/2);this.nibup=new Rect(_336-this.NIB_INSETS.right-this.NIB_WIDTH,this.NIB_INSETS.top,this.NIB_WIDTH,this.NIB_WIDTH);this.nibdown=new Rect(_336-this.NIB_INSETS.right-this.NIB_WIDTH,_337-(this.NIB_WIDTH*2)-(this.NIB_INSETS.bottom*2),this.NIB_INSETS.top,this.NIB_WIDTH,this.NIB_WIDTH);this.nibleft=new Rect(this.gutterWidth+this.NIB_INSETS.left,_337-this.NIB_INSETS.bottom-this.NIB_WIDTH,this.NIB_WIDTH,this.NIB_WIDTH);this.nibright=new Rect(_336-(this.NIB_INSETS.right*2)-(this.NIB_WIDTH*2),_337-this.NIB_INSETS.bottom-this.NIB_WIDTH,this.NIB_WIDTH,this.NIB_WIDTH);vctx.translate(-_33c,0);hctx.translate(0,-_33d);if(_33a&&((this.overXScrollBar)||(this.xscrollbar.mousedownValue!=null))){hctx.save();hctx.beginPath();hctx.rect(this.nibleft.x+_363+2,0,this.nibright.x-this.nibleft.x-1,_337);hctx.closePath();hctx.clip();hctx.fillStyle=ed.theme.scrollTrackFillStyle;hctx.fillRect(this.nibleft.x,this.nibleft.y-1,this.nibright.x2-this.nibleft.x,this.nibleft.h+1);hctx.strokeStyle=ed.theme.scrollTrackStrokeStyle;hctx.strokeRect(this.nibleft.x,this.nibleft.y-1,this.nibright.x2-this.nibleft.x,this.nibleft.h+1);hctx.restore();}if(_33b&&((this.overYScrollBar)||(this.yscrollbar.mousedownValue!=null))){vctx.save();vctx.beginPath();vctx.rect(0,this.nibup.y+_363+2,_336,this.nibdown.y-this.nibup.y-1);vctx.closePath();vctx.clip();vctx.fillStyle=ed.theme.scrollTrackFillStyle;vctx.fillRect(this.nibup.x-1,this.nibup.y,this.nibup.w+1,this.nibdown.y2-this.nibup.y);vctx.strokeStyle=ed.theme.scrollTrackStrokeStyle;vctx.strokeRect(this.nibup.x-1,this.nibup.y,this.nibup.w+1,this.nibdown.y2-this.nibup.y);vctx.restore();}if(_33b){if((_340)||(this.overYScrollBar)||(this.yscrollbar.mousedownValue!=null)){vctx.save();vctx.translate(this.nibup.x+_363,this.nibup.y+_363);this.paintNib(vctx,_361.n,_361.a,_361.s);vctx.restore();}if((_341)||(this.overYScrollBar)||(this.yscrollbar.mousedownValue!=null)){vctx.save();vctx.translate(this.nibdown.x+_363,this.nibdown.y+_363);vctx.rotate(Math.PI);this.paintNib(vctx,_361.n,_361.a,_361.s);vctx.restore();}}if(_33a){if((_33e)||(this.overXScrollBar)||(this.xscrollbar.mousedownValue!=null)){hctx.save();hctx.translate(this.nibleft.x+_363,this.nibleft.y+_363);hctx.rotate(Math.PI*1.5);this.paintNib(hctx,_362.n,_362.a,_362.s);hctx.restore();}if((_33f)||(this.overXScrollBar)||(this.xscrollbar.mousedownValue!=null)){hctx.save();hctx.translate(this.nibright.x+_363,this.nibright.y+_363);hctx.rotate(Math.PI*0.5);this.paintNib(hctx,_362.n,_362.a,_362.s);hctx.restore();}}var sx=this.nibleft.x2+4;var sw=this.nibright.x-this.nibleft.x2-9;this.xscrollbar.rect=new Rect(sx,this.nibleft.y-1,sw,this.nibleft.h+1);this.xscrollbar.value=-this.xoffset;this.xscrollbar.min=0;this.xscrollbar.max=_339-(_336-this.gutterWidth);this.xscrollbar.extent=_336-this.gutterWidth;if(_33a){var _364=(((this.overXScrollBar)&&(_339>_336))||((this.xscrollbar)&&(this.xscrollbar.mousedownValue!=null)));if(!_364){hctx.globalAlpha=0.3;}this.paintScrollbar(hctx,this.xscrollbar);hctx.globalAlpha=1;}var sy=this.nibup.y2+4;var sh=this.nibdown.y-this.nibup.y2-9;this.yscrollbar.rect=new Rect(this.nibup.x-1,sy,this.nibup.w+1,sh);this.yscrollbar.value=-this.yoffset;this.yscrollbar.min=0;this.yscrollbar.max=_338-(_337-this.BOTTOM_SCROLL_AFFORDANCE);this.yscrollbar.extent=_337;if(_33b){var _365=((this.overYScrollBar)&&(_338>_337))||((this.yscrollbar)&&(this.yscrollbar.mousedownValue!=null));if(!_365){vctx.globalAlpha=0.3;}this.paintScrollbar(vctx,this.yscrollbar);vctx.globalAlpha=1;}ctx.drawImage(this.verticalScrollCanvas,_33c,0);ctx.drawImage(this.horizontalScrollCanvas,0,_33d);hctx.restore();vctx.restore();if(!_340){this.nibup=new Rect();}if(!_341){this.nibdown=new Rect();}if(!_33e){this.nibleft=new Rect();}if(!_33f){this.nibright=new Rect();}this.xscrollbarVisible=_33a;this.yscrollbarVisible=_33b;},paintScrollbar:function(ctx,_366){var bar=_366.getHandleBounds();var _367=(ctx.globalAlpha)?ctx.globalAlpha:1;if(!_366.isH()){ctx.save();ctx.translate(bar.x+Math.floor(bar.w/2),bar.y+Math.floor(bar.h/2));ctx.rotate(Math.PI*1.5);ctx.translate(-(bar.x+Math.floor(bar.w/2)),-(bar.y+Math.floor(bar.h/2)));bar=new bespin.editor.Rect(bar.x-Math.floor(bar.h/2)+Math.floor(bar.w/2),bar.y+Math.floor(bar.h/2)-Math.floor(bar.w/2),bar.h,bar.w);}var _368=bar.h/2;ctx.beginPath();ctx.arc(bar.x+_368,bar.y+_368,_368,Math.PI/2,3*(Math.PI/2),false);ctx.arc(bar.x2-_368,bar.y+_368,_368,3*(Math.PI/2),Math.PI/2,false);ctx.lineTo(bar.x+_368,bar.y+bar.h);ctx.closePath();var _369=ctx.createLinearGradient(bar.x,bar.y,bar.x,bar.y+bar.h);_369.addColorStop(0,this.editor.theme.scrollBarFillGradientTopStart.replace(/%a/,_367));_369.addColorStop(0.4,this.editor.theme.scrollBarFillGradientTopStop.replace(/%a/,_367));_369.addColorStop(0.41,this.editor.theme.scrollBarFillStyle.replace(/%a/,_367));_369.addColorStop(0.8,this.editor.theme.scrollBarFillGradientBottomStart.replace(/%a/,_367));_369.addColorStop(1,this.editor.theme.scrollBarFillGradientBottomStop.replace(/%a/,_367));ctx.fillStyle=_369;ctx.fill();ctx.save();ctx.clip();ctx.fillStyle=this.editor.theme.scrollBarFillStyle.replace(/%a/,_367);ctx.beginPath();ctx.moveTo(bar.x+(_368*0.4),bar.y+(_368*0.6));ctx.lineTo(bar.x+(_368*0.9),bar.y+(bar.h*0.4));ctx.lineTo(bar.x,bar.y+(bar.h*0.4));ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(bar.x+bar.w-(_368*0.4),bar.y+(_368*0.6));ctx.lineTo(bar.x+bar.w-(_368*0.9),bar.y+(bar.h*0.4));ctx.lineTo(bar.x+bar.w,bar.y+(bar.h*0.4));ctx.closePath();ctx.fill();ctx.restore();ctx.beginPath();ctx.arc(bar.x+_368,bar.y+_368,_368,Math.PI/2,3*(Math.PI/2),false);ctx.arc(bar.x2-_368,bar.y+_368,_368,3*(Math.PI/2),Math.PI/2,false);ctx.lineTo(bar.x+_368,bar.y+bar.h);ctx.closePath();ctx.strokeStyle=this.editor.theme.scrollTrackStrokeStyle;ctx.stroke();if(!_366.isH()){ctx.restore();}},paintNib:function(ctx,_36a,_36b,_36c){var _36d=Math.floor(this.NIB_WIDTH/2);ctx.fillStyle=_36a;ctx.beginPath();ctx.arc(0,0,Math.floor(this.NIB_WIDTH/2),0,Math.PI*2,true);ctx.closePath();ctx.fill();ctx.strokeStyle=_36c;ctx.stroke();ctx.fillStyle=_36b;ctx.beginPath();ctx.moveTo(0,-_36d+this.NIB_ARROW_INSETS.top);ctx.lineTo(-_36d+this.NIB_ARROW_INSETS.left,_36d-this.NIB_ARROW_INSETS.bottom);ctx.lineTo(_36d-this.NIB_ARROW_INSETS.right,_36d-this.NIB_ARROW_INSETS.bottom);ctx.closePath();ctx.fill();},getRowString:function(row){return this.model.getRowMetadata(row).lineText;},getRowScreenLength:function(row){return this.getRowString(row).length;},getMaxCols:function(_36e,_36f){var cols=0;for(var i=_36e;i<=_36f;i++){cols=Math.max(cols,this.getRowScreenLength(i));}return cols;},setSearchString:function(str){if(str&&str!=""){this.searchString=str;}else{delete this.searchString;}this.model.searchStringChanged(this.searchString);this.editor.paint(true);},dispose:function(){for(var i=0;i<this.globalHandles.length;i++){dojo.disconnect(this.globalHandles[i]);}}});dojo.declare("bespin.editor.API",null,{constructor:function(_370,opts){this.opts=opts||{};this.debugMode=false;this.container=dojo.byId(_370);this.model=new bespin.editor.DocumentModel(this);this.container.innerHTML="<canvas id=\"canvas\" moz-opaque=\"true\" tabindex=\"-1\"></canvas>";this.canvas=this.container.firstChild;while(this.canvas&&this.canvas.nodeType!=1){this.canvas=this.canvas.nextSibling;}this.cursorManager=new bespin.editor.CursorManager(this);this.ui=new bespin.editor.UI(this);this.theme=bespin.themes["default"];this.editorKeyListener=new bespin.editor.DefaultEditorKeyListener(this);this.historyManager=new bespin.editor.HistoryManager(this);this.customEvents=new bespin.editor.Events(this);this.ui.installKeyListener(this.editorKeyListener);this.model.insertCharacters({row:0,col:0}," ");dojo.connect(this.canvas,"blur",dojo.hitch(this,function(e){this.setFocus(false);}));dojo.connect(this.canvas,"focus",dojo.hitch(this,function(e){this.setFocus(true);}));bespin.editor.clipboard.setup(this);this.paint();if(!this.opts.dontfocus){this.setFocus(true);}},getSelection:function(_371){_371=(_371!=undefined)?_371:this.selection;if(!_371){return undefined;}var _372=_371.startPos;var _373=_371.endPos;if((_373.row<_372.row)||((_373.row==_372.row)&&(_373.col<_372.col))){var foo=_372;_372=_373;_373=foo;}return {startPos:bespin.editor.utils.copyPos(_372),endPos:bespin.editor.utils.copyPos(_373),startModelPos:this.getModelPos(_372),endModelPos:this.getModelPos(_373)};},getCursorPos:function(_374){return this.cursorManager.getCursorPosition(_374);},getModelPos:function(pos){return this.cursorManager.getModelPosition(pos);},moveCursor:function(pos){this.cursorManager.moveCursor(pos);},resetView:function(data){this.cursorManager.moveCursor(data.cursor);this.setSelection(data.selection);this.ui.yoffset=data.offset.y;this.ui.xoffset=data.offset.x;},basicView:function(){this.cursorManager.moveCursor({row:0,col:0});this.setSelection(undefined);this.ui.yoffset=0;this.ui.xoffset=0;},getCurrentView:function(){return {cursor:this.getCursorPos(),offset:{x:this.ui.xoffset,y:this.ui.yoffset},selection:this.selection};},getState:function(){return {cursor:this.getCursorPos(),selection:this.getSelection()};},setState:function(data){this.cursorManager.moveCursor(data.cursor);this.setSelection(data.selection);this.ui.ensureCursorVisible();this.paint(false);},getTabSize:function(){var _375=bespin.get("settings");var size=bespin.defaultTabSize;if(_375){var _376=parseInt(_375.get("tabsize"));if(_376>0){size=_376;}}return size;},getSelectionAsText:function(){var _377="";var _378=this.getSelection();if(_378){_377=this.model.getChunk(_378);}return _377;},setSelection:function(_379){this.selection=_379;},paint:function(_37a){var ctx=bespin.util.canvas.fix(this.canvas.getContext("2d"));this.ui.paint(ctx,_37a);},changeKeyListener:function(_37b){this.ui.installKeyListener(_37b);this.editorKeyListener=_37b;},setFocus:function(_37c){this.focus=_37c;if(_37c){this.canvas.focus();}},setReadOnly:function(_37d){this.readonly=_37d;},dispose:function(){bespin.editor.clipboard.uninstall();this.ui.dispose();},bindKey:function(_37e,_37f,_380){console.warn("Use of editor.bindKey(",_37e,_37f,_380,") seems doomed to fail");var _381=bespin.util.keys.fillArguments(_37f);var key=_381.key;var _382=_381.modifiers;if(!key){return;}var _383=bespin.util.keys.toKeyCode(key);var _384="Execute command: '"+_37e+"'";var _37e=this.ui.actions[_37e]||function(){bespin.get("commandLine").executeCommand(command,true);};if(_383&&_37e){if(_380){this.editorKeyListener.bindKeyStringSelectable(_382,_383,_37e,_384);}else{this.editorKeyListener.bindKeyString(_382,_383,_37e,_384);}}},bindCommand:function(_385,_386){var _387=bespin.util.keys.fillArguments(_386);var _388=bespin.util.keys.toKeyCode(_387.key);var _389=function(){bespin.getComponent("commandLine",function(cli){cli.executeCommand(_385,true);});};var _38a="Execute command: '"+_385+"'";this.editorKeyListener.bindKeyString(_387.modifiers,_388,_389,_38a);},moveAndCenter:function(row){if(!row){return;}var _38b=row-1;this.cursorManager.moveCursor({row:_38b,col:0});if((_38b<this.ui.firstVisibleRow)||(_38b>=this.ui.firstVisibleRow+this.ui.visibleRows)){this.ui.actions.moveCursorRowToCenter();}},newFile:function(_38c,path,_38d){_38c=_38c||bespin.get("editSession").project;path=path||"new.txt";var self=this;var _38e=function(){if(bespin.get("settings").isSettingOff("collaborate")){self.model.insertDocument(_38d||"");self.cursorManager.moveCursor({row:0,col:0});self.setFocus(true);}bespin.publish("editor:openfile:opensuccess",{file:{name:path,content:_38d||"",timestamp:new Date().getTime()}});bespin.publish("editor:dirty");};bespin.get("files").newFile(_38c,path,_38e);},saveFile:function(_38f,_390,_391,_392){_38f=_38f||bespin.get("editSession").project;_390=_390||bespin.get("editSession").path;dojo.cookie("viewData_"+_38f+"_"+_390.split("/").join("_"),dojo.toJson(bespin.get("editor").getCurrentView()),{expires:7});var file={name:_390,content:this.model.getDocument(),timestamp:new Date().getTime()};var _393=function(){document.title=_390+" - editing with Bespin";var _394=bespin.get("commandLine");if(_394){_394.showHint("Saved file: "+file.name);}bespin.publish("editor:clean");if(dojo.isFunction(_391)){_391();}};var _395=function(xhr){var _396=bespin.get("commandLine");if(_396){_396.showHint("Save failed: "+xhr.responseText);}if(dojo.isFunction(_392)){_392();}};bespin.publish("editor:savefile:before",{filename:_390});bespin.get("files").saveFile(_38f,file,_393,_395);},openFile:function(_397,_398,_399){var _39a=bespin.get("editSession");var _39b=bespin.get("commandLine");var self=this;var _397=_397||_39a.project;var _398=_398||_39a.path;var _399=_399||{};var _39c=_399.fromFileHistory||false;if(_39a.checkSameFile(_397,_398)&&!_399.reload){if(_399.line){_39b.executeCommand("goto "+_399.line,true);}return;}if(this.dirty){var _39d=function(xhr){_39b.showHint("Trying to save current file. Failed: "+xhr.responseText);};var _39e=function(){self.openFile(_397,_398,_399);};this.saveFile(_397,_398,_39e,_39d);return;}if(_399.force){bespin.get("files").whenFileDoesNotExist(_397,_398,{execute:function(){self.newFile(_397,_398,_399.content||"");},elseFailed:function(){_399.force=false;self.openFile(_397,_398,_399);}});return;}var _39d=function(){bespin.publish("editor:openfile:openfail",{project:_397,filename:_398});};var _39e=function(file){if(!file){_39d();return;}if(file.content!==undefined){self.model.insertDocument(file.content);self.cursorManager.moveCursor({row:0,col:0});self.setFocus(true);}_39a.setProjectPath(_397,_398);if(_399.line){_39b.executeCommand("goto "+_399.line,true);}self._addHistoryItem(_397,_398,_39c);bespin.publish("editor:openfile:opensuccess",{project:_397,file:file});};bespin.publish("editor:openfile:openbefore",{project:_397,filename:_398});bespin.get("files").collaborateOnFile(_397,_398,_39e,_39d);},_addHistoryItem:function(_39f,_3a0,_3a1){var _3a2=bespin.get("settings");var _3a3=_3a2.getObject("_lastused");if(!_3a3){_3a3=[];}var _3a4={project:_39f,filename:_3a0};if(!_3a1){bespin.get("editSession").addFileToHistory(_3a4);}var _3a5=[];dojo.forEach(_3a3,function(item){if(item.project!=_3a4.project||item.filename!=_3a4.filename){_3a5.unshift(item);}});_3a5.unshift(_3a4);_3a3=_3a5;if(_3a3.length>10){_3a3=_3a3.slice(0,10);}_3a2.setObject("_lastused",_3a3);}});bespin.subscribe("extension:loaded:bespin.debugger",function(ext){var _3a6=bespin.get("settings");if(_3a6&&_3a6.get("debugmode")){ext.load();}});}if(!dojo._hasResource["bespin.editor.events"]){dojo._hasResource["bespin.editor.events"]=true;dojo.provide("bespin.editor.events");dojo.declare("bespin.editor.Events",null,{constructor:function(_3a7){bespin.subscribe("editor:openfile:opensuccess",function(_3a8){var _3a9=_3a8.project||bespin.get("editSession").project;var _3aa=_3a8.file.name;try{var data=dojo.cookie("viewData_"+_3a9+"_"+_3aa.split("/").join("_"));if(data){bespin.get("editor").resetView(dojo.fromJson(data));}else{bespin.get("editor").basicView();}}catch(e){console.log("Error setting in the view: ",e);}document.title=_3aa+" - editing with Bespin";bespin.publish("url:change",{project:_3a9,path:_3aa});});bespin.subscribe("url:change",function(_3ab){var _3ac=dojo.queryToObject(location.hash.substring(1));_3ac.project=_3ab.project;_3ac.path=_3ab.path;var _3ad=[];for(var name in _3ac){var _3ae=_3ac[name];_3ad.push(name+"="+_3ae);}window.location.hash=_3ad.join("&");});bespin.subscribe("url:changed",function(_3af){_3a7.openFile(null,_3af.now.get("path"));});bespin.subscribe("cmdline:focus",function(_3b0){_3a7.setFocus(false);});bespin.subscribe("cmdline:blur",function(_3b1){_3a7.setFocus(true);});bespin.subscribe("editor:document:changed",function(_3b2){bespin.publish("editor:dirty");});bespin.subscribe("editor:dirty",function(_3b3){_3a7.dirty=true;});bespin.subscribe("editor:clean",function(_3b4){_3a7.dirty=false;});}});}if(!dojo._hasResource["bespin.editor.model"]){dojo._hasResource["bespin.editor.model"]=true;dojo.provide("bespin.editor.model");dojo.declare("bespin.editor.DocumentModel",null,{constructor:function(_3b5){this.editor=_3b5;this.clear();},addHistoryItem:function(func,data){this.history.length=this.historyIndex+1;this.history.push({func:func,data:data});this.historyIndex++;},performHistoryItem:function(item){var func=item.func;var data=item.data;switch(func){case "deleteCharacters":this.deleteCharacters(data.pos,data.characters.length,true);break;case "insertCharacters":this.insertCharacters(data.pos,data.characters,true);break;case "deleteChunk":this.deleteChunk(data.selection,data.chunk,true);break;case "insertChunk":this.insertChunk(data.selection.startModelPos,data.chunk,true);break;case "joinRow":this.joinRow(data.selection.startModelPos.row,true);break;case "replaceRow":console.debug(["Call replaceRow",item]);this.replaceRow(data.row,item.undo?data.oldline:data.newline,true);break;}},unperformHistoryItem:function(item){var func=item.func;var data=item.data;switch(func){case "deleteCharacters":func="insertCharacters";break;case "insertCharacters":func="deleteCharacters";break;case "deleteChunk":func="insertChunk";break;case "insertChunk":func="deleteChunk";break;case "joinRow":func="insertChunk";break;}this.performHistoryItem({func:func,data:data,undo:true});},applyState:function(_3b6){if(_3b6>=this.history.length||_3b6<-1){return;}else{if(_3b6==this.historyIndex){return;}}if(_3b6>this.historyIndex){for(var i=this.historyIndex+1;i<=_3b6;i++){var _3b7=this.history[i];this.performHistoryItem(_3b7);}}else{for(var i=this.historyIndex;i>_3b6;i--){var _3b7=this.history[i];this.unperformHistoryItem(_3b7);}}this.historyIndex=_3b6;},getState:function(){return this.historyIndex;},isEmpty:function(){if(this.rows.length>1){return false;}if(this.rows.length==1&&this.rows[0].length>0){return false;}return true;},getDirtyRows:function(){var dr=(this.dirtyRows)?this.dirtyRows:[];this.dirtyRows=null;return dr;},setRowDirty:function(row){if(!this.dirtyRows){this.dirtyRows=new Array(this.rows.length);}this.dirtyRows[row]=true;},isRowDirty:function(row){if(!this.dirtyRows){return true;}return this.dirtyRows[row];},setRowArray:function(_3b8,row){if(!dojo.isArray(row)){row=row.split("");}this.rows[_3b8]=row;},getRowArray:function(_3b9){while(this.rows.length<=_3b9){this.rows.push([]);}return this.rows[_3b9];},hasRow:function(_3ba){return (this.rows[_3ba]);},insertCharacters:function(_3bb,_3bc,_3bd){var row=this.getRowArray(_3bb.row);while(row.length<_3bb.col){row.push(" ");}var _3be=(_3bb.col>0)?row.splice(0,_3bb.col):[];_3be=_3be.concat(_3bc.split(""));this.rows[_3bb.row]=_3be.concat(row);this.setRowDirty(_3bb.row);this.editor.ui.syntaxModel.invalidateCache(_3bb.row);if(!_3bd){this.addHistoryItem("insertCharacters",{pos:bespin.editor.utils.copyPos(_3bb),characters:_3bc});}},getDocument:function(){var file=[];for(var x=0;x<this.getRowCount();x++){file[x]=this.getRowArray(x).join("");}return file.join("\n");},insertDocument:function(_3bf){this.clear();var rows=_3bf.split("\n");for(var x=0;x<rows.length;x++){this.insertCharacters({row:x,col:0},rows[x],true);}},changeEachRow:function(_3c0){for(var x=0;x<this.getRowCount();x++){var row=this.getRowArray(x);row=_3c0(row);this.setRowArray(x,row);}},replace:function(_3c1,_3c2){var _3c3=new RegExp(_3c1,"g");for(var x=0;x<this.getRowCount();x++){var line=this.getRowArray(x).join("");var _3c4=line.replace(_3c3,_3c2);if(_3c4!=line){this.replaceRow(x,_3c4);}}},replaceRow:function(row,_3c5,_3c6){var _3c7=this.getRowArray(row).join("");this.rows[row]=_3c5.split("");if(!_3c6){this.addHistoryItem("replaceRow",{row:row,oldline:_3c7,newline:_3c5});}},deleteCharacters:function(_3c8,_3c9,_3ca){var row=this.getRowArray(_3c8.row);var diff=(_3c8.col+_3c9-1)-row.length;if(diff>0){_3c9-=diff;}if(_3c9>0){this.setRowDirty(_3c8.row);this.editor.ui.syntaxModel.invalidateCache(_3c8.row);var _3cb=row.splice(_3c8.col,_3c9).join("");if(!_3ca){this.addHistoryItem("deleteCharacters",{pos:bespin.editor.utils.copyPos(_3c8),characters:_3cb});}return _3cb;}return "";},clear:function(){this.rows=[];this.cacheRowMetadata=[];this.history=[];this.historyIndex=-1;},deleteRows:function(row,_3cc){var diff=(row+_3cc-1)-this.rows.length;if(diff>0){_3cc-=diff;}if(_3cc>0){this.rows.splice(row,_3cc);this.cacheRowMetadata.splice(row,_3cc);}},splitRow:function(_3cd){this.editor.ui.syntaxModel.invalidateCache(_3cd.row);this.setRowDirty(_3cd.row);var row=this.getRowArray(_3cd.row);var _3ce=[];if(_3cd.col<row.length){_3ce=_3ce.concat(row.splice(_3cd.col));}if(_3cd.row==(this.rows.length-1)){this.rows.push(_3ce);}else{var _3cf=this.rows.splice(0,_3cd.row+1);_3cf.push(_3ce);_3cf=_3cf.concat(this.rows);this.rows=_3cf;var _3d0=this.cacheRowMetadata.splice(0,_3cd.row+1);_3d0.push(undefined);this.cacheRowMetadata=_3d0.concat(this.cacheRowMetadata);}},joinRow:function(_3d1,_3d2){this.editor.ui.syntaxModel.invalidateCache(_3d1);this.setRowDirty(_3d1);if(_3d1>=this.rows.length-1){return;}var row=this.getRowArray(_3d1);var _3d3=this.rows[_3d1+1];var _3d4=row.length;this.rows[_3d1]=row.concat(_3d3);this.rows.splice(_3d1+1,1);this.cacheRowMetadata.splice(_3d1+1,1);if(!_3d2){var pos={row:_3d1,col:_3d4};this.addHistoryItem("joinRow",{selection:{startModelPos:pos,endModelPos:pos},chunk:"\n"});}},getRowCount:function(){return this.rows.length;},getChunk:function(_3d5){var _3d6=_3d5.startModelPos;var _3d7=_3d5.endModelPos;var _3d8,_3d9;var _3da="";_3d8=_3d6.col;var row=this.getRowArray(_3d6.row);_3d9=(_3d7.row==_3d6.row)?_3d7.col:row.length;if(_3d9>row.length){_3d9=row.length;}_3da+=row.join("").substring(_3d8,_3d9);for(var i=_3d6.row+1;i<_3d7.row;i++){_3da+="\n";_3da+=this.getRowArray(i).join("");}if(_3d6.row!=_3d7.row){_3d8=0;_3d9=_3d7.col;row=this.getRowArray(_3d7.row);if(_3d9>row.length){_3d9=row.length;}_3da+="\n"+row.join("").substring(_3d8,_3d9);}return _3da;},deleteChunk:function(_3db,_3dc){var _3dd=this.getChunk(_3db);var _3de=_3db.startModelPos;var _3df=_3db.endModelPos;this.editor.ui.syntaxModel.invalidateCache(_3de.row);var _3e0,_3e1;_3e0=_3de.col;var row=this.getRowArray(_3de.row);_3e1=(_3df.row==_3de.row)?_3df.col:row.length;if(_3e1>row.length){_3e1=row.length;}this.deleteCharacters({row:_3de.row,col:_3e0},_3e1-_3e0,true);if(_3de.row!=_3df.row){_3e0=0;_3e1=_3df.col;row=this.getRowArray(_3df.row);if(_3e1>row.length){_3e1=row.length;}this.deleteCharacters({row:_3df.row,col:_3e0},_3e1-_3e0,true);}if((_3df.row-_3de.row)>1){this.deleteRows(_3de.row+1,_3df.row-_3de.row-1);}if(_3df.row!=_3de.row){this.joinRow(_3de.row,true);}if(!_3dc){this.addHistoryItem("deleteChunk",{selection:{startModelPos:bespin.editor.utils.copyPos(_3db.startModelPos),endModelPos:bespin.editor.utils.copyPos(_3db.endModelPos)},chunk:_3dd});}return _3dd;},insertChunk:function(_3e2,_3e3,_3e4){this.editor.ui.syntaxModel.invalidateCache(_3e2.row);var _3e5=_3e3.split("\n");var _3e6=bespin.editor.utils.copyPos(_3e2);for(var i=0;i<_3e5.length;i++){this.insertCharacters(_3e6,_3e5[i],true);_3e6.col=_3e6.col+_3e5[i].length;if(i<_3e5.length-1){this.splitRow(_3e6);_3e6.col=0;_3e6.row=_3e6.row+1;}}if(!_3e4){this.addHistoryItem("insertChunk",{selection:{startModelPos:bespin.editor.utils.copyPos(_3e2),endModelPos:bespin.editor.utils.copyPos(_3e6)},chunk:_3e3});}return _3e6;},getStringIndicesInRow:function(row,str){str=str.toLowerCase();var row=this.getRowArray(row).join("").toLowerCase();if(row.indexOf(str)==-1){return false;}var _3e7=new Array();var _3e8=0;var _3e9=row.indexOf(str);do{_3e7.push(_3e9);_3e9=row.indexOf(str,_3e9+1);}while(_3e9!=-1);return _3e7;},getCountOfString:function(str){var _3ea=0;var line;var _3eb;for(var x=0;x<this.getRowCount();x++){_3eb=this.getStringIndicesInRow(x,str);if(_3eb){_3ea+=_3eb.length;}}return _3ea;},searchStringChanged:function(str){for(var row=0;row<this.cacheRowMetadata.length;row++){if(this.cacheRowMetadata[row]){if(str){this.cacheRowMetadata[row].searchIndices=this.getStringIndicesInRow(row,str);}else{this.cacheRowMetadata[row].searchIndices=false;}}}},findPrev:function(row,col,str){var _3ec;var _3ed=str.length;for(var x=row;x>-1;x--){_3ec=this.getStringIndicesInRow(x,str);if(!_3ec){continue;}for(var y=_3ec.length-1;y>-1;y--){if(_3ec[y]<(col-_3ed)||row!=x){return {startPos:{col:_3ec[y],row:x},endPos:{col:_3ec[y]+_3ed,row:x}};}}}return false;},findNext:function(row,col,str){var _3ee;for(var x=row;x<this.getRowCount();x++){_3ee=this.getStringIndicesInRow(x,str);if(!_3ee){continue;}for(var y=0;y<_3ee.length;y++){if(_3ee[y]>col||row!=x){return {startPos:{col:_3ee[y],row:x},endPos:{col:_3ee[y]+str.length,row:x}};}}}return false;},findBefore:function(row,col,_3ef){var line=this.getRowArray(row);if(!dojo.isFunction(_3ef)){_3ef=function(_3f0){if(_3f0.charAt(0)==" "){return true;}var _3f1=_3f0.charCodeAt(0);return (_3f1<48)||(_3f1>122);};}if(col>=line.length){col=Math.max(line.length-1,0);}while(col>0){var _3f2=line[col];if(!_3f2){continue;}if(_3ef(_3f2)){col++;break;}col--;}return {row:row,col:col};},findAfter:function(row,col,_3f3){var line=this.getRowArray(row);if(!dojo.isFunction(_3f3)){_3f3=function(_3f4){if(_3f4.charAt(0)==" "){return true;}var _3f5=_3f4.charCodeAt(0);return (_3f5<48)||(_3f5>122);};}while(col<line.length){col++;var _3f6=line[col];if(!_3f6){continue;}if(_3f3(_3f6)){break;}}return {row:row,col:col};},getRowMetadata:function(row){if(!this.isRowDirty(row)&&this.cacheRowMetadata[row]){return this.cacheRowMetadata[row];}var meta={tabExpansions:[]};var _3f7=this.editor.model.getRowArray(row);var _3f8=_3f7.join("");var _3f9=this.editor.getTabSize();meta.lineTextWithoutTabExpansion=_3f8;meta.lineLengthWithoutTabExpansion=_3f7.length;for(var ti=0;ti<_3f8.length;ti++){if(_3f8.charCodeAt(ti)==9){var _3fa=_3f9-(ti%_3f9);var _3fb="";for(var si=1;si<_3fa;si++){_3fb+=" ";}var left=(ti==0)?"":_3f8.substring(0,ti);var _3fc=(ti<_3f8.length-1)?_3f8.substring(ti+1):"";_3f8=left+" "+_3fb+_3fc;meta.tabExpansions.push({start:left.length,end:left.length+_3fb.length+1});ti+=_3fa-1;}}meta.lineText=_3f8;if(this.editor.ui.searchString){meta.searchIndices=this.getStringIndicesInRow(row,this.editor.ui.searchString);}else{meta.searchIndices=false;}this.cacheRowMetadata[row]=meta;return meta;}});}if(!dojo._hasResource["bespin.editor.toolbar"]){dojo._hasResource["bespin.editor.toolbar"]=true;dojo.provide("bespin.editor.toolbar");dojo.declare("bespin.editor.Toolbar",null,{DEFAULT_TOOLBAR:["collaboration","filepopup","commandline","target_browsers","save","close","preview","fontsize"],showCollab:false,showFiles:false,showTarget:false,showCollabHotCounter:0,constructor:function(_3fd,opts){this.editor=_3fd||bespin.get("editor");if(opts.setupDefault){this.setupDefault();}bespin.publish("toolbar:init",{toolbar:this});},setup:function(type,el,_3fe){if(dojo.isFunction(_3fe)){this.addComponent(type,_3fe);}if(dojo.isFunction(this.components[type])){this.components[type](this,el);}},setupDefault:function(){dojo.forEach(this.DEFAULT_TOOLBAR,dojo.hitch(this,function(item){var _3ff=dojo.byId("toolbar_"+item);if(_3ff){this.setup(item,_3ff);}}));},addComponent:function(type,_400){this.components[type]=_400;},components:{collaboration:function(_401,el){var _402=dojo.byId(el)||dojo.byId("toolbar_collaboration");dojo.connect(_402,"click",function(){_401.showCollab=!_401.showCollab;bespin.page.editor.recalcLayout();});},filepopup:function(_403,el){var _404=dojo.byId(el)||dojo.byId("toolbar_popup");dojo.connect(_404,"click",function(){_403.editor.ui.actions.focusFileBrowser();});dojo.connect(_404,"mouseover",function(){_404.style.cursor="pointer";_404.src="images/icn_filepopup_on.png";});dojo.connect(_404,"mouseout",function(){_404.style.cursor="default";_404.src="images/icn_filepopup.png";});},commandline:function(_405,el){var _406=dojo.byId(el)||dojo.byId("toolbar_commandline");dojo.connect(_406,"click",function(){_405.editor.ui.actions.focusCommandline();});dojo.connect(_406,"mouseover",function(){_406.style.cursor="pointer";_406.src="images/icn_command_on.png";});dojo.connect(_406,"mouseout",function(){_406.style.cursor="default";_406.src="images/icn_command.png";});},target_browsers:function(_407,el){var _408=dojo.byId(el)||dojo.byId("toolbar_target_browsers");dojo.connect(_408,"click",function(){_407._showTarget=!_407._showTarget;_408.src="images/"+((_407._showTarget)?"icn_target_on.png":"icn_target_off.png");bespin.page.editor.recalcLayout();});dojo.connect(_408,"mouseover",function(){_408.style.cursor="pointer";_408.src="images/icn_target_on.png";});dojo.connect(_408,"mouseout",function(){_408.style.cursor="default";_408.src="images/icn_target_off.png";});},save:function(_409,el){var save=dojo.byId(el)||dojo.byId("toolbar_save");dojo.connect(save,"mouseover",function(){save.src="images/icn_save_on.png";});dojo.connect(save,"mouseout",function(){save.src="images/icn_save.png";});dojo.connect(save,"click",function(){bespin.get("editor").saveFile();});},close:function(_40a,el){var _40b=dojo.byId(el)||dojo.byId("toolbar_close");dojo.connect(_40b,"mouseover",function(){_40b.src="images/icn_close_on.png";});dojo.connect(_40b,"mouseout",function(){_40b.src="images/icn_close.png";});dojo.connect(_40b,"click",function(){bespin.get("commandLine").executeCommand("closefile",true);});},undo:function(_40c,el){var undo=dojo.byId(el)||dojo.byId("toolbar_undo");dojo.connect(undo,"mouseover",function(){undo.src="images/icn_undo_on.png";});dojo.connect(undo,"mouseout",function(){undo.src="images/icn_undo.png";});dojo.connect(undo,"click",function(){_40c.editor.ui.actions.undo();});},redo:function(_40d,el){var redo=dojo.byId(el)||dojo.byId("toolbar_undo");dojo.connect(redo,"mouseover",function(){redo.src="images/icn_redo_on.png";});dojo.connect(redo,"mouseout",function(){redo.src="images/icn_redo.png";});dojo.connect(redo,"click",function(){_40d.editor.ui.actions.redo();});},preview:function(_40e,el){var _40f=dojo.byId(el)||dojo.byId("toolbar_preview");dojo.connect(_40f,"mouseover",function(){_40f.src="images/icn_preview_on.png";});dojo.connect(_40f,"mouseout",function(){_40f.src="images/icn_preview.png";});dojo.connect(_40f,"click",function(){bespin.preview.show();});},fontsize:function(_410,el){var _411=dojo.byId(el)||dojo.byId("toolbar_fontsize");dojo.connect(_411,"mouseover",function(){_411.src="images/icn_fontsize_on.png";});dojo.connect(_411,"mouseout",function(){_411.src="images/icn_fontsize.png";});(function(){var _412=2;var _413={1:8,2:10,3:14};dojo.connect(_411,"click",function(){_412=(_412>2)?1:_412+1;bespin.publish("settings:set:fontsize",[{value:_413[_412]}]);});})();}}});}if(!dojo._hasResource["bespin.editor.history"]){dojo._hasResource["bespin.editor.history"]=true;dojo.provide("bespin.editor.history");dojo.declare("bespin.editor.HistoryManager",null,{constructor:function(_414){this.history=[];this.historyPosition=-1;this.editor=_414;this.disableAdding=false;},getRange:function(_415,end){},replaceRange:function(_416,end,_417){this.history.splice(_416,end-_416+1,_417);},truncate:function(_418){this.history.length=_418+1;this.historyPosition=Math.min(this.historyPosition,this.history.length-1);},getCurrent:function(){return this.historyPosition;},undo:function(){if(this.historyPosition<0){return;}var _419=this.history[this.historyPosition];this.disableAdding=true;try{_419.undo();}catch(e){console.error("There was an error in an undo action: ");console.error(e);}this.disableAdding=false;this.historyPosition--;},redo:function(){if(this.historyPosition>=this.history.length-1){return;}var next=this.history[this.historyPosition+1];this.disableAdding=true;try{next.redo();}catch(e){console.error("There was an error in an undo action: ");console.error(e);}this.disableAdding=false;this.historyPosition++;},add:function(item){if(this.disableAdding){return;}this.history.length=this.historyPosition+1;this.history.push(item);this.historyPosition++;},canUndo:function(){return this.historyPosition>-1;},canRedo:function(){return this.historyPosition<this.history.length-1;}});dojo.declare("bespin.editor.HistoryItem",null,{constructor:function(){},undo:function(){},redo:function(){}});}if(!dojo._hasResource["bespin.editor.quickopen"]){dojo._hasResource["bespin.editor.quickopen"]=true;dojo.provide("bespin.editor.quickopen");dojo.declare("bespin.editor.quickopen.API",null,{constructor:function(){this.requestFinished=true;this.preformNewRequest=false;this.projects;this.currentProject;this.currentProjectInclude;var _41a=this.scene=new th.WindowScene({canvasOrId:document.getElementById("quickopen"),createFocusManager:true,isVisible:false,isDraggable:true,title:"Find Files"});var bus=_41a.bus;var _41b=this.focusManager=_41a.focusManager;var _41c=this.input=_41a.byId("input");_41c.selectAll();var _41d=this.inputProject=_41a.byId("project");var list=this.list=_41a.byId("list");list.items=["Loading..."];list.remove(list.renderer);list.renderer=new th.HtmlLabel();list.add(list.renderer);list.renderer.addCss("padding","2px 5px");this.label=_41a.byId("label");_41b.subscribe(_41d);_41b.subscribe(_41c);_41a.render();_41a.center();_41c.bindKey("",_41c.ARROW_UP,list.moveSelectionUp,list);_41c.bindKey("",_41c.ARROW_DOWN,list.moveSelectionDown,list);_41c.bindKey("",_41c.ESCAPE,function(){bespin.publish("ui:escape");},this);_41c.bindKey("",_41c.ENTER,this.openFile,this);_41d.bindKey("",_41d.ENTER,function(){_41c.focusManager.focus(_41c);});_41d.bindKey("",_41c.ESCAPE,function(){bespin.publish("ui:escape");},this);bus.bind("dblclick",list,this.openFile,this);bus.bind("itemselected",list,function(e){this.label.text=e.item.filename;this.label.repaint();},this);bus.bind("text:changed",_41c,function(){if(!this.currentProject){return;}if(this.input.text==""){this.showFiles([]);}else{if(this.requestFinished){this.requestFinished=false;bespin.get("server").searchFiles(this.currentProject,this.input.text,this.currentProjectInclude,this.displayResult);}else{this.preformNewRequest=true;}}},this);bus.bind("text:changed:newChar",_41d,function(){if(!this.inputProject.text==""){var _41e=this.inputProject.text.toLowerCase();for(var i=0;i<this.projects.length;i++){if(this.projects[i].toLowerCase().indexOf(_41e)==0){this.inputProject.setText(this.inputProject.text+this.projects[i].substring(_41e.length),true);this.inputProject.setSelection(_41e.length,this.inputProject.text.length);}}}},this);bus.bind("focus:lost",_41d,function(){var _41f=this.inputProject.text.toLowerCase();for(var i=0;i<this.projects.length;i++){if(this.projects[i].toLowerCase()==_41f){this.setProject(this.projects[i]);if(this.input.text=="no such project"){this.input.setText("",true);}this.showFiles([]);return;}}this.input.setText("no such project",true);this.list.items=[];this.label.text="";this.scene.render();},this);bus.bind("focus:received",_41d,function(){this.selectAll();},_41d);bus.bind("focus:received",_41c,function(){this.selectAll();},_41c);bespin.subscribe("ui:escape",dojo.hitch(this,function(){if(this.scene.isVisible){this.toggle();bespin.get("editor").setFocus(true);}}));},toggle:function(){if(!this.scene.isVisible){dojo.style("quickopenContainer","display","block");}this.scene.toggle();if(!this.scene.isVisible){this.focusManager.removeFocus();}else{this.focusManager.focus(this.input);this.setProject(bespin.get("editSession").project);this.input.setText("");this.loadProjects();}},openFile:function(){var item=this.list.selected;if(!item){return;}var _420=bespin.get("editor");_420.saveFile();_420.openFile(this.currentProject,item.filename);this.toggle();_420.setFocus(true);},highlightText:function(text,_421){if(_421==""){return text;}var _422=0,_423=-1;var _424=text.toLowerCase();_421=_421.toLowerCase();var _425="";for(var i=0;i<_421.length;i++){_422=_423;_423=_424.indexOf(_421[i],_423);if(_423==-1){break;}_425+=text.substring(_422+1,_423)+"<#000000>"+text[_423]+"</#000000>";}_425+=text.substring(_423+1);return _425.replace(/<\/#000000><#000000>/g,"");},showFiles:function(_426,_427){_427=_427||false;var _428=new Array();var _429=new Array();var _42a=bespin.get("quickopen");var _42b=bespin.get("settings");var _42c;var name;var path;var _42d;var file;if(_426===undefined){_42a.list.items=[];_42a.scene.render();return;}for(var x=0;x<_426.length;x++){file=_426[x];_42d=file.lastIndexOf("/");path=(_42d==-1)?"":file.substring(0,_42d);name=(_42d==-1)?file:file.substring(_42d+1);if(_42b&&_42b.isSettingOff("dotmode")&&name[0]=="."){continue;}_42c=false;for(var y=_428.length-1;y!=-1;y--){if(_428[y].name==name){if(!_428[y].lastFolder){_42c=_428[y].filename.split("/");_428[y].lastFolder=(_42c.length>1?_42c[_42c.length-2]:"");}_42c=file.split("/");_42c=(_42c.length>1?_42c[_42c.length-2]:"");break;}}_428.push({filename:file,lastFolder:_42c,name:name});}_428=_428.slice(0,13);if(_427){_428.sort(function(a,b){try{var x=a.text.toLowerCase();var y=b.text.toLowerCase();return ((x<y)?-1:((x>y)?1:0));}catch(e){return 0;}});}for(var i=0;i<_428.length;i++){_428[i].text=_42a.highlightText(_428[i].name,_42a.input.text)+(_428[i].lastFolder==false?"":" - "+_428[i].lastFolder);}_42a.list.items=_428;if(_428.length!=0){_42a.list.selected=_428[0];_42a.label.text=_428[0].filename;}_42a.scene.render();},displayResult:function(_42e){var _42f=bespin.get("quickopen");_42f.showFiles(_42e);_42f.requestFinished=true;if(_42f.preformNewRequest){_42f.requestFinished=false;_42f.preformNewRequest=false;_42f.requestText=_42f.input.text;bespin.get("server").searchFiles(_42f.currentProject,_42f.input.text,_42f.currentProjectInclude,_42f.displayResult);}},loadProjects:function(){bespin.get("server").list(null,null,dojo.hitch(this,function(_430){this.projects=[];for(var i=0;i<_430.length;i++){this.projects.push(_430[i].name.substring(0,_430[i].name.length-1));}this.projects.sort(function(a,b){var x=a.toLowerCase();var y=b.toLowerCase();return ((x<y)?-1:((x>y)?1:0));});}));},setProject:function(name){this.inputProject.setText(name,true);this.currentProject=name;this.currentProjectInclude=[];var _431=bespin.get("settings");if(_431){var _432=_431.getObject("quickopenInclude");if(_432){if(_432[name]){this.currentProjectInclude=_432[name];}}}}});bespin.command.store.addCommand({name:"quickopen",takes:["task","project","path"],preview:"list, add or remove a folder from the list quickopen uses to search in for files",usage:"[add|remove] [project] [path to be added or removed]",execute:function(_433,args){var _434=bespin.get("settings");if(!args.task){_433.addOutput(this.preview);_433.addUsageOutput(this);_433.error=false;var _435=_434.getObject("quickopenInclude");if(_435===undefined){return;}output="<br/>";for(projects in _435){if(_435[projects].length==0){continue;}output+="<u><b>Project: "+projects+"</b></u>";output+="<ul>";for(var i=0;i<_435[projects].length;i++){output+="<li>"+_435[projects][i]+"</li>";}output+="</ul><br/>";}_433.addOutput(output);return;}if(!args.path||!args.project){_433.addUsageOutput(this);return;}if(args.task=="add"){var _435=_434.getObject("quickopenInclude");if(_435===undefined){_435={};}if(_435[args.project]===undefined){_435[args.project]=[];}_435[args.project].push(args.path);_434.setObject("quickopenInclude",_435);}else{if(args.task=="remove"){var _435=_434.getObject("quickopenInclude");if(_435===undefined){return;}if(_435[args.project]===undefined){return;}if(_435[args.project].indexOf(args.path)==-1){return;}_435[args.project].splice(_435[args.project].indexOf(args.path),1);_434.setObject("quickopenInclude",_435);}}}});}if(!dojo._hasResource["bespin.editor.formatter"]){dojo._hasResource["bespin.editor.formatter"]=true;dojo.provide("bespin.editor.formatter");bespin.subscribe("component:register:actions",function(e){var _436=bespin.get("actions");_436["formatCode"]=dojo.hitch(_436,function(args){var sel=this.editor.getSelection();var _437;var _438=null;var _439=this.editor.cursorManager.getCursorPosition();var code=this.editor.model.getDocument();if(sel){sel.startPos.col=0;if(sel.endPos.col>0){sel.endPos.row+=1;sel.endPos.col=0;}this.editor.setSelection(sel);_438={start:sel.startPos.row,end:sel.endPos.row};}var _43a=bespin.get("formatter")||(function(){return bespin.register("formatter",new bespin.editor.formatter.API());})();_43a.setLanguage(this.editor.language);var _43b=(function(_43c){var _43d="";for(x=0;x<_43c;x++){_43d+=" ";}return _43d;})(this.editor.getTabSize());_437=_43a.indent(code,_43b,_438);if(!sel){this.selectAll({});}this.deleteSelectionAndInsertChunk({chunk:_437});if(!sel){this.editor.setSelection(undefined);this.editor.cursorManager.moveCursor(_439);this.repaint();}});});bespin.command.store.addCommand({name:"format",withKey:"CMD SHIFT F",preview:"format source code or selection",description:"Use this to indent the selected fragment of your code.  The entire source is indented if nothing is selected.",execute:function(self){bespin.get("editor").ui.actions.formatCode();}});dojo.declare("bespin.editor.formatter.API",null,{setLanguage:function(_43e){if(dojo.isString(_43e)){_43e=_43e.toLowerCase();}switch(_43e){case "css":case "javascript":case "js":case "java":case "ecmascript":this.implementation=new bespin.editor.formatter.C();break;case "html":case "xhtml":case "shtml":case "xml":case "fbml":this.implementation=new bespin.editor.formatter.ML();break;default:console.log("Error!!! unknown language type: "+_43e);this.implementation=new bespin.editor.formatter.Unknown();break;}},constructor:function(){},indent:function(_43f,pad,_440){return this.implementation.indent(_43f,pad,_440);}});dojo.declare("bespin.editor.formatter.Base",null,{calculateOffset:function(_441,_442){if(!_442){_442=_441.length-1;}var _443={row:0,offset:""};var _444=/(^\s*)(\S+)\s*/;for(var i=_442-1;i>0;i--){var m=_444.exec(_441[i]);if(m){_443.offset=m[1];_443.row=i;break;}}return _443;},indent:function(_445,pad,_446){var _447=_445.split("\n");var _448=0;var _449="";if(!_446){_446={start:0,end:_447.length-1};}else{_448=_446.start;var r=this.calculateOffset(_447,_446.start);_449=r.offset;_446.start=r.row;}var _44a={level:0,nextLevel:0,comment:false};var _44b=_449;for(var i=_446.start;i<_446.end;i++){_447[i]=_447[i].replace(/^\s+/,"").replace(/\s+$/,"");if(this.processLine(_447[i],_44a)!=0){var pads=[_449];for(var j=0;j<_44a.level;j++){pads.push(pad);}_44b=pads.join("");}_447[i]=_44b+_447[i];}if(_446.end<(_447.length-1)){_447.splice(_446.end,_447.length-1);}if(_448>0){_447.splice(0,_448);}return _447.join("\n")+"\n";}});dojo.declare("bespin.editor.formatter.C",bespin.editor.formatter.Base,{constructor:function(){this.scopeChanges={"{":1,"(":1,"[":1,"]":-1,"}":-1,")":-1};this.COND_START="$";this.ML_COMMENT_START="%";this.ML_COMMENT_END="@";this.COMMENT="#";this.CASE_START="<";this.CASE_END=">";},calculateOffset:function(_44c,_44d){var l=_44c.slice(0,_44d);var _44e=false;var i=0;while(i<_44d){var pos;if(_44e){pos=l[i].indexOf("*/");if(pos>=0){l[i]=l[i].substr(pos1+2);_44e=false;i--;}}else{pos=l[i].indexOf("/*");if(pos>=0){var s=l[i].substr(0,pos);var pos1=l[i].indexOf("*/",pos+2);if(pos1>=0){s+=l[i].substr(pos1+2);_44e=false;l[i]=s;i--;}else{_44e=true;l[i]=s;}}}i++;}var _44f=[l,_44d];_44f.callee=arguments.callee;return this.inherited(_44f);},processLine:function(line,_450){var _451=0;var _452=_450.level;var _453=0;line=this.normalize(line,0,_450.comment);_450.condLevel=_450.condLevel||0;_450.condState=_450.condState||0;for(var i=0;i<line.length;i++){switch(line[i]){case "{":_451+=1;if(_450.condState==3){_450.condState=0;}if(_450.inCase){_450.caseLevel++;}break;case this.CASE_START:if(!_450.inCase){_451+=1;}else{_453-=1;}_450.inCase=true;_450.caseLevel=0;break;case "}":_451-=1;if(_450.inCase){if(_450.caseLevel>0){_450.caseLevel-=1;}else{_451-=1;_450.inCase=false;}}_453=(_453<_451)?_453:_451;break;case this.CASE_END:_451-=1;_453=(_453<_451)?_453:_451;_450.inCase=false;break;case "[":_451+=1;break;case "]":_451-=1;_453=(_453<_451)?_453:_451;break;case "(":switch(_450.condState){case 1:_450.condState=2;break;case 2:_450.parentInCondition++;break;default:break;}_451+=1;break;case ")":_451-=1;if(_450.condState==2){if(_450.parenInCondition>0){_450.parentInCondition--;}else{_450.condState=3;}}_453=(_453<_451)?_453:_451;break;case this.ML_COMMENT_START:_450.comment=true;break;case this.ML_COMMENT_END:_450.comment=false;break;case this.COND_START:_450.condState=1;_450.parenInCondition=0;break;case ";":if(_450.condState==3){_450.condState=0;}break;default:break;}}_450.level=_450.nextLevel+_453;var _454=0;if(_450.condState==3){_450.condLevel++;_450.condState=4;_454=1;}else{if(_450.condState==4){_454=-_450.condLevel;_450.condLevel=0;_450.condState=0;}}_450.nextLevel+=_451+_454;if(_450.nextLevel<0){_450.nextLevel=0;}return (_452!=_450.level)||_453;},normalize:function(s,_455,_456){if(!s){return {escaped:s,comment:_456};}s=s.replace(/\\"/g,"").replace(/\\'/g,"").replace(/[@#$%<>]/g,"").replace(/\bif\b/g,this.COND_START).replace(/\belse\b/g,this.COND_START).replace(/\bfor\b/g,this.COND_START).replace(/\bwhile\b/g,this.COND_START).replace(/\bcase\b/g,this.CASE_START).replace(/\bdefault\b/g,this.CASE_START).replace(/\bbreak\b/g,this.CASE_END).replace(/\/\*/g,this.ML_COMMENT_START).replace(/\*\//g,this.ML_COMMENT_END).replace(/\/\//g,this.COMMENT).replace(/[\w\s]/g,"");var out=[];var _457=null;var _458=false,_459=false;for(var i=_455;i<s.length;i++){var c=s[i];if(_459){continue;}else{if(_456){if(s[i]==this.ML_COMMENT_END){_456=false;}else{continue;}}else{if(_458){if(s[i]==_457){_458=false;_457=null;}else{continue;}}else{if(s[i]==this.COMMENT){_459=true;}else{if(s[i]=="'"||s[i]=="\""){_458=true;_457=s[i];}else{if(s[i]==this.ML_COMMENT_START){_456=true;}}}}}}out.push(c);}s=out.join("");return s;}});dojo.declare("bespin.editor.formatter.ML",bespin.editor.formatter.Base,{constructor:function(){this.emptyElements=["area","base","basefont","br","col","frame","hr","img","input","isindex","link","meta","param"];},indent:function(_45a,pad,_45b){_45a=_45a.replace(/<BR>/,"<BR/>").replace(/<br>/,"<br/>");var _45c=[_45a,pad,_45b];_45c.callee=arguments.callee;return this.inherited(_45c);},processLine:function(line,_45d){var s=line;var _45e=0;var _45f=0;var _460=0;var _461=_45d.level;_45d.lonelyCloser=false;var _462=_45d.scriptlet;var _463=false;var _464=_45d.inTag;var _465=_45d.inEmptyTag;var _466=false;var _467=_45d.comment;var _468;for(var i=0;i<line.length;i++){if(_463){if(s[i]==_468&&(i==_460||s[i-1]!="\\")){_463=false;}}else{if(_462){if(i>_460&&s[i]==">"&&s[i-1]=="%"){_462=false;_45e-=1;_45f=(_45f<_45e)?_45f:_45e;}}else{if(_467){if(i>_460+1&&s[i]==">"&&s[i-1]=="-"&&s[i-2]=="-"){_467=false;_45e-=1;_45f=(_45f<_45e)?_45f:_45e;}}else{if(_464){if(s[i]==">"){if(!_465&&i>_460&&s[i-1]=="/"){_45e-=1;}_464=false;}}else{if(_466){if(s[i]==">"){_466=false;if(!_465){_45e-=1;_45f=(_45f<_45e)?_45f:_45e;}}}else{if(i<line.length-3&&s[i]=="<"&&s[i+1]=="!"&&s[i+2]=="-"&&s[i+3]=="-"){_467=true;_45e+=1;}else{if(s[i]=="'"||s[i]=="\""){_468=s[i];_463=true;}else{if(s[i]=="<"){if(i<line.length-1&&s[i+1]=="/"){_465=this.isEmptyTag(line,i+2);_466=true;}else{if(i<line.length-1&&s[i+1]=="%"){_462=true;_45e+=1;}else{_465=this.isEmptyTag(line,i+1);if(!_465){_45e+=1;}_464=true;}}}}}}}}}}}_45d.level=_45d.nextLevel+_45f;_45d.nextLevel+=_45e;_45d.inTag=_464;_45d.inEmptyTag=_465;_45d.comment=_467;_45d.scriptlet=_462;return (_461!=_45d.level)||_45f;},isEmptyTag:function(line,_469){var _46a="";for(var j=_469;j<line.length;j++){if(/[\s>]/.test(line[j])){break;}else{_46a+=line[j];}}_46a=_46a.toLowerCase();for(var i=0;i<this.emptyElements.length;i++){if(_46a==this.emptyElements[i]){return true;}}return false;}});dojo.declare("bespin.editor.formatter.Unknown",null,{constructor:function(){},indent:function(_46b,pad,_46c){return _46b;}});}if(!dojo._hasResource["bespin.editor.codecompletion"]){dojo._hasResource["bespin.editor.codecompletion"]=true;dojo.provide("bespin.editor.codecompletion");dojo.declare("bespin.editor.codecompletion.Suggester",null,{constructor:function(){},complete:function(_46d,row){var self=this;var _46e=_46d.col-1;var _46f="";var find=function(){if(_46f.length>=1){self.findCompletion(_46f);}};for(var i=_46e;i>=0;--i){var ch=row[i];if(this.charMarksStartOfIdentifier(ch)){find();return;}else{_46f=ch+_46f;}}find();},findInArray:function(_470,_471,_472){for(var i=0,len=_472.length;i<len;++i){var name=_472[i].name;if(name){if(name.indexOf(_471)===0&&_471!==name&&name!=="constructor"){_470.push(name);}}}},findCompletion:function(_473){var self=this;var _474=[];if(self.currentMetaInfo){if(self.currentMetaInfo.outline){this.findInArray(_474,_473,self.currentMetaInfo.outline);}if(self.currentMetaInfo.idents){var _475=[];for(var i in self.currentMetaInfo.idents){_475.push({name:i});}this.findInArray(_474,_473,_475);}}if(_474.length>0){bespin.publish("codecomplete:showsuggestion",{candidates:_474});}},charMarksStartOfIdentifier:function(ch){return ch===" "||ch==="\t"||ch=="\""||ch=="'";},initialize:function(){var self=this;bespin.subscribe("parser:metainfo",function(evt){self.currentMetaInfo=evt.info;});bespin.subscribe("codecomplete:suggest",function(evt){self.complete(evt.cursorPos,evt.row);});}});(function(){var _476=new bespin.worker.WorkerFacade(new bespin.editor.codecompletion.Suggester());if(!_476.__hasWorkers__){_476.initialize();}var _477;bespin.subscribe("codecomplete:showsuggestion",function(e){bespin.get("commandLine").showHint("Code Completions<br><br>"+e.candidates.join("<br>"));});bespin.subscribe("settings:set:codecomplete",function(data){if(bespin.get("settings").isOn(data.value)){_477=bespin.subscribe("editor:document:changed",function(){var _478=bespin.get("editor");var pos=_478.getCursorPos();var row=_478.model.getRowArray(pos.row);bespin.publish("codecomplete:suggest",{cursorPos:pos,row:row});},400);}else{bespin.unsubscribe(_477);}});})();}if(!dojo._hasResource["bespin.themes.default"]){dojo._hasResource["bespin.themes.default"]=true;dojo.provide("bespin.themes.default");bespin.themes.coffee={backgroundStyle:"#2A211C",gutterStyle:"#4c4a41",lineNumberColor:"#e5c138",lineNumberFont:"10pt Monaco, Lucida Console, monospace",lineMarkerErrorColor:"#CC4444",lineMarkerWarningColor:"#B8860B",lineMarkerMessageColor:"green",zebraStripeColor:"#2A211C",highlightCurrentLineColor:"#3a312b",editorTextFont:"10pt Monaco, Lucida Console, monospace",editorTextColor:"rgb(230, 230, 230)",editorSelectedTextColor:"rgb(240, 240, 240)",editorSelectedTextBackground:"#526DA5",cursorStyle:"#879aff",cursorType:"ibeam",unfocusedCursorStrokeStyle:"#FF0033",unfocusedCursorFillStyle:"#73171E",partialNibStyle:"rgba(100, 100, 100, 0.3)",partialNibArrowStyle:"rgba(255, 255, 255, 0.3)",partialNibStrokeStyle:"rgba(150, 150, 150, 0.3)",fullNibStyle:"rgb(100, 100, 100)",fullNibArrowStyle:"rgb(255, 255, 255)",fullNibStrokeStyle:"rgb(150, 150, 150)",scrollTrackFillStyle:"rgba(50, 50, 50, 0.8)",scrollTrackStrokeStyle:"rgb(150, 150, 150)",scrollBarFillStyle:"rgba(0, 0, 0, %a)",scrollBarFillGradientTopStart:"rgba(90, 90, 90, %a)",scrollBarFillGradientTopStop:"rgba(40, 40, 40, %a)",scrollBarFillGradientBottomStart:"rgba(22, 22, 22, %a)",scrollBarFillGradientBottomStop:"rgba(44, 44, 44, %a)",tabSpace:"#392A25",searchHighlight:"#B55C00",searchHighlightSelected:"#FF9A00",plain:"#bdae9d",keyword:"#42a8ed",string:"#039a0a",comment:"#666666","c-comment":"#666666",punctuation:"#888888",attribute:"#BF9464",test:"rgb(255,0,0)",cdata:"#bdae9d","attribute-value":"#039a0a",tag:"#46a8ed",color:"#c4646b","tag-name":"#46a8ed",value:"#039a0a",important:"#990000",sizes:"#990000",cssclass:"#BF9464",cssid:"#46a8ed",atom:"#aa4444",variable:"#00cccc",variabledef:"#4422cc",localvariable:"#cc2277",property:"#66bb33",operator:"#88bbff",error:"#FF0000",processing:"#999999",entity:"#AA2222",text:"#00BB00","compile-time-constant":"#776088","predefined-constant":"#33CC33","reserved-language-construct":"#00FF00","predefined-function":"#22FF22","predefined-class":"#22FF22",literal:"#DD4411",identifier:"#22FF22",func:"#2200FF",type:"#8822FF",decorator:"#2222FF"};bespin.themes.coffeezebra={};dojo.mixin(bespin.themes.coffeezebra,bespin.themes.coffee);bespin.themes.coffeezebra.zebraStripeColor="#FFFFFF";bespin.themes["default"]=bespin.themes.coffee;}if(!dojo._hasResource["bespin.syntax.base"]){dojo._hasResource["bespin.syntax.base"]=true;dojo.provide("bespin.syntax.base");dojo.declare("bespin.syntax.Model",null,{language:"",lineCache:[],invalidateCache:function(_479){delete this.lineCache[_479];},invalidateEntireCache:function(){this.lineCache=[];},addToCache:function(_47a,line){this.lineCache[_47a]=line;},getFromCache:function(_47b){return this.lineCache[_47b];},mergeSyntaxResults:function(_47c){var base=0;for(var i=0;i<_47c.length;i++){var _47d=_47d[i];}},getSyntaxStylesPerLine:function(_47e,_47f,_480){return {regions:{plain:[{start:0,stop:_47e.length}]}};},getSyntaxStyles:function(rows,_481,_482,_483){var _484={};for(var i=_481;i<=_482;i++){_484[i]=this.getSyntaxStylesPerLine(rows[i],i,_483);}return _484;}});bespin.syntax.Resolver=(function(){var _485,_486;return {setEngine:function(name){var _487=bespin.syntax[name];if(name==_485){return this;}if(_487){_485=name;if(_486){delete _486;}if(_487.worker){_486=new bespin.worker.WorkerFacade(bespin.syntax[name].Model());_486.workerEnabled=true;}else{_486=new bespin.syntax[name].Model();_486.workerEnabled=false;}}else{console.log("no such engine: ",name);}return this;},getModel:function(){return _486;}};})();}if(!dojo._hasResource["bespin.syntax.simple._base"]){dojo._hasResource["bespin.syntax.simple._base"]=true;dojo.provide("bespin.syntax.simple._base");dojo.declare("bespin.syntax.simple.Model",bespin.syntax.Model,{lineMetaInfo:[],setLineMetaInfo:function(_488,meta){this.lineMetaInfo[_488]=meta;},getLineMetaInfo:function(_489){return this.lineMetaInfo[_489];},getSyntaxStylesPerLine:function(_48a,_48b,_48c){if(!this.language||(this.language!=_48c)){this.engine=bespin.syntax.simple.Resolver.resolve(_48c);this.language=_48c;}var _48d={text:_48a,regions:[]};var meta;if(typeof this.engine["innertypes"]=="function"){var _48e=this.engine.innertypes(_48a);for(var i=0;i<_48e.length;i++){var type=_48e[i];meta={inMultiLineComment:this.inMultiLineComment(),offset:type.start};var _48f=[];var _490=bespin.syntax.simple.Resolver.highlight(type.type,_48a.substring(type.start,type.stop),meta);if(_490.meta&&(i==_48e.length-1)){this.setLineMetaInfo(_48b,_490.meta);}_48f.push(_490);}_48d.regions.push(this.mergeSyntaxResults(_48f));}else{meta=(_48b>0)?this.getLineMetaInfo(_48b-1):{};var _491=this.engine.highlight(_48a,meta);this.setLineMetaInfo(_48b,_491.meta);_48d.regions.push(_491.regions);}return _48d;}});bespin.syntax.simple.Resolver=new function(){var _492={};var _493={};var _494={highlight:function(line,meta){return {regions:{plain:[{start:0,stop:line.length}]}};}};return {highlight:function(type,line,meta,_495){this.resolve(type).highlight(line,meta,_495);},register:function(type,_496,_497){if(_497){_492[type]=_497;}for(var i=0;i<_496.length;i++){_493[_496[i]]=type;}},resolve:function(_498){if(!_498||_498=="off"||!_493[_498]){return _494;}var type=_493[_498];if(!_492[type]||(typeof _492[type]==="string"&&_492[type]!="LOADING")){_492[type]="LOADING";var dr=dojo.require;dr.call(dojo,"bespin.syntax.simple."+type.toLowerCase());if(bespin.syntax.simple[type]){_492[type]=new bespin.syntax.simple[type]();}}return _492[type]||_494;}};}();bespin.syntax.simple.Resolver.register("JavaScript",["js","javascript","ecmascript","jsm","java"]);bespin.syntax.simple.Resolver.register("Arduino",["pde"]);bespin.syntax.simple.Resolver.register("C",["c","h"]);bespin.syntax.simple.Resolver.register("CSharp",["cs"]);bespin.syntax.simple.Resolver.register("CSS",["css"]);bespin.syntax.simple.Resolver.register("HTML",["html","htm","xml","xhtml","shtml"]);bespin.syntax.simple.Resolver.register("PHP",["php","php3","php4","php5"]);bespin.syntax.simple.Resolver.register("Python",["py","python"]);bespin.syntax.simple.Resolver.register("Ruby",["rb","ruby"]);}if(!dojo._hasResource["bespin.parser.parser"]){dojo._hasResource["bespin.parser.parser"]=true;dojo.provide("bespin.parser.parser");dojo.declare("bespin.parser.CodeInfo",null,{constructor:function(_499){var self=this;this._started=false;this._running=false;this.currentMetaInfo;this.messages=[];this.foldPoints=[];bespin.subscribe("parser:showoutline",function(){var html=self.currentMetaInfo?self.currentMetaInfo.html:"Outline not yet available";bespin.get("commandLine").addOutput(html);});bespin.subscribe("parser:gotofunction",function(_49a){var _49b=_49a.functionName;if(!_49b){bespin.get("commandLine").addErrorOutput("Please pass me a valid function name.");return;}var _49c=dojo.filter(self.foldPoints,function(func){return func["(name)"]==_49b;});if(_49c.length===0){bespin.get("commandLine").addErrorOutput("Unable to find the function "+_49b+" in this file.");}else{bespin.get("editor").moveAndCenter(_49c[0].row);}});bespin.subscribe("parser:engine:parseDone",function(_49d){var data=_49d.info;self.foldPoints=data.foldPoints;var _49e=bespin.get("settings")&&bespin.get("settings").get("syntaxmarkers");self.messages=dojo.filter(data.messages,function(_49f){if(_49e==="all"){return true;}return ((_49f.type+"s").toLowerCase()===_49e);});if(data.metaInfo){self.currentMetaInfo=data.metaInfo;bespin.publish("parser:metainfo",{info:data.metaInfo});}self._running=false;});bespin.subscribe("parser:stop",function(){self.messages=[];self.foldPoints=[];});},start:function(){var self=this;var _4a0=bespin.get("editor");if(!self._started){self._started=true;self.run_timeout;var _4a1=400;var _4a2=function(){if(self.run_timeout){clearTimeout(self.run_timeout);}self.run_timeout=setTimeout(function(){self.fetch();},_4a1);};var _4a3=bespin.subscribe("editor:document:changed",_4a2);bespin.subscribe("settings:set:syntaxmarkers",_4a2);bespin.subscribe("settings:set:jslint",_4a2);bespin.subscribe("parser:stop",function(){bespin.unsubscribe(_4a3);self._started=false;});_4a2();}},fetch:function(){var self=this;if(bespin.parser.AsyncEngineResolver.__hasWorkers__){var _4a4=bespin.get("editor");var type=_4a4.language;var _4a5=bespin.get("settings")&&bespin.get("settings").getObject("jslint");if(type){var _4a6=_4a4.model.getDocument();self._running=true;bespin.publish("parser:engine:parse",{type:type,source:_4a6,parseOptions:_4a5});}}},getLineMarkers:function(){var _4a7={};dojo.forEach(this.messages,function(_4a8){if(!_4a7[_4a8.line]){_4a7[_4a8.line]={type:_4a8.type,msg:""};}_4a7[_4a8.line].msg+="<p>Syntax "+_4a8.type+(isFinite(_4a8.line)?" at line "+_4a8.line+" character "+(_4a8.character+1):" ")+": "+_4a8.reason+"<p>"+(_4a8.evidence&&(_4a8.evidence.length>80?_4a8.evidence.slice(0,77)+"...":_4a8.evidence).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));if(_4a8.type==="Error"||(_4a8.type==="Warning"&&_4a7[_4a8.line].type==="Message")){_4a7[_4a8.line].type=_4a8.type;}});return _4a7;},getFunctions:function(){return this.foldPoints||[];}});dojo.declare("bespin.parser.JavaScript",null,{constructor:function(){},name:"Narcissus",walk:function(tree,_4a9){var _4aa=[];var _4ab=[];var top=function(){if(this.length==0){return null;}return this[this.length-1];};_4aa.top=top;_4ab.top=top;this._walk(_4a9,tree,_4aa,_4ab);},_visitNode:function(_4ac,node,_4ad,_4ae){_4ac.call(this,node,_4ad,_4ae);if(node.length){this._walk(_4ac,node,_4ad,_4ae);}if(node.expression){this._walk(_4ac,node.expression,_4ad,_4ae);}if(node.body){this._walk(_4ac,node.body,_4ad,_4ae);}if(node.value){this._walk(_4ac,node.value,_4ad,_4ae);}},_walk:function(_4af,tree,_4b0,_4b1){if(typeof tree=="string"){return;}if(tree.length){_4b0.push(tree);for(var i=0;i<tree.length;++i){var node=tree[i];_4b1.push(i);this._visitNode(_4af,node,_4b0,_4b1);_4b1.pop();}_4b0.pop();}else{this._visitNode(_4af,tree,_4b0,_4b1);}},getMetaInfo:function(tree){var _4b2=[];var _4b3={};var info=[];var _4b4=this.getCodePatterns();for(var type in _4b4){if(_4b4.hasOwnProperty(type)){try{var ns=_4b4[type].declaration.split(".");var _4b5=ns.pop();_4b4[type]._indicator=_4b5;_4b4[type]._ns=ns;}catch(e){console.log("Weird FF3b3 error "+e);}}}var _4b6=74;var _4b7=56;var _4b8=56;this.walk(tree,function(node,_4b9,_4ba){var _4bb=_4b9.length;var tree=_4b9.top();var _4bc=_4ba.top();var row=node.lineno-1;var _4bd=[];if(node.type==_4b8&&_4bc>0){_4bd.push(node.value);for(var i=_4bc-1;i>=0;--i){var n=tree[i];if(n&&n.type==_4b8){_4bd.unshift(n.value);}}}_4b3[_4bd.join(".")]=true;if(node.type==_4b6){var name=node.name;if(name==null&&tree&&_4bc>0){var pred=tree[_4bc-1];if(pred.type==_4b7){name=pred.value;}}var fn={type:"function",name:name,row:row,depth:_4bb};_4b2.push(fn);info.push(fn);}else{var _4be=_4b9[_4b9.length-1];var _4bf=_4ba[_4ba.length-1];var _4c0=function(type,ns,_4c1){if(_4bf>=0){if(node.value==_4c1){for(var i=0;i<ns.length;++i){var ele=ns[i];if(_4be[_4bf-1]&&_4be[_4bf-1].value==ns){_4be=_4b9[_4b9.length-(1+i+1)];_4bf=_4ba[_4ba.length-(1+i+1)];}else{return;}}if(_4be[_4bf+1]&&_4be[_4bf+1][0]){var name=_4be[_4bf+1][0].value;info.push({type:type,name:name,row:row,depth:_4bb});return true;}}}};for(var type in _4b4){var _4c2=_4b4[type];if(_4c0(type,_4c2._ns,_4c2._indicator)){break;}}}});var html="<u>Outline</u><br/><br/>";html+="<div id=\"outlineInfo\">";for(var i=0;i<info.length;i++){var type=info[i].type;var kind=type;var name=info[i].name;var _4c3=_4b4[type];if(_4c3){if("declaration" in _4c3){kind=_4c3.declaration;}if("description" in _4c3){kind=_4c3.description;}}if(typeof name=="undefined"){continue;}var _4c4="";for(var j=0;j<info[i].depth;j++){_4c4+="&nbsp;";}html+=_4c4+kind+": <a href=\"javascript:bespin.get('editor').cursorManager.moveCursor({ row: "+info[i].row+", col: 0 });bespin.get('editor').ui.actions.moveCursorRowToCenter();\">"+name+"</a><br/>";}html+="</div>";return {functions:_4b2,idents:_4b3,outline:info,html:html};},codePatterns:{dojoClass:{declaration:"dojo.declare",description:"Class"},bespinEventPublish:{declaration:"bespin.publish",description:"Publish"},bespinEventSubscription:{declaration:"bespin.subscribe",description:"Subscribe to"},jooseClass:{declaration:"Class"},jooseModule:{declaration:"Module"},jooseType:{declaration:"Type"},jooseRole:{declaration:"Role"}},getCodePatterns:function(){return this.codePatterns;},initialize:function(){var self=this;bespin.subscribe("parser:js:codePatterns",function(_4c5){for(pattern in _4c5){self.codePatterns[pattern]=_4c5[pattern];}bespin.publish("parser:engine:updatedCodePatterns");});},parse:function(_4c6){var tree;var _4c7=[];try{tree=parse(_4c6);}catch(e){}return {messages:_4c7,metaInfo:tree?this.getMetaInfo(tree):undefined};}});dojo.declare("bespin.parser.JSLint",null,{constructor:function(_4c8){},name:"JSLint",parse:function(_4c9,type,_4ca){if(type==="css"){_4c9="@charset \"UTF-8\";\n"+_4c9;}var _4cb=JSLINT(_4c9,_4ca);var _4cc=[];var _4cd=JSLINT.getFunctions();var _4ce=JSLINT.errors.length>0&&JSLINT.errors[JSLINT.errors.length-1]===null;for(var i=0;i<JSLINT.errors.length;i++){if(JSLINT.errors[i]){_4cc.push({reason:JSLINT.errors[i].reason,line:JSLINT.errors[i].line+(type==="css"?0:1),type:(i===JSLINT.errors.length-2&&_4ce)?"Error":"Warning",character:JSLINT.errors[i].character,evidence:JSLINT.errors[i].evidence});}}for(var i=0;i<_4cd.length;i++){_4cc.push({line:_4cd[i].line,type:"Message",character:0,reason:"<br>Function name: "+_4cd[i].name+"<br>Unused: "+_4cd[i].unused.join(", ")+"<br>Closure: "+_4cd[i].closure.join(", ")+"<br>Exception: "+_4cd[i].exception.join(", ")+"<br>Vars: "+_4cd[i].vars.join(", ")+"<br>Label: "+_4cd[i].label.join(", ")+"<br>Outer: "+_4cd[i].outer.join(", ")+"<br>Global: "+_4cd[i].global.join(", "),evidence:""});}return {result:_4cb,messages:_4cc,foldPoints:(type==="css"?[]:_4cd)};}});bespin.parser.EngineResolver=function(){return {engines:{},parse:function(_4cf,type,_4d0){var _4d1={};var _4d2;var _4d3=this.resolve(type);for(var i=0;i<_4d3.length;i++){_4d2=_4d3[i].parse(_4cf,type,_4d0);_4d2.messages=_4d2.messages.concat(_4d1.messages||[]);for(var _4d4 in _4d2){if(_4d2.hasOwnProperty(_4d4)){if(_4d2[_4d4]){_4d1[_4d4]=_4d2[_4d4];_4d1.isSet=true;}}}}return _4d1.isSet?_4d1:{noEngine:true};},register:function(_4d5,_4d6){for(var i=0;i<_4d6.length;i++){if(this.engines[_4d6[i]]==null){this.engines[_4d6[i]]=[];}this.engines[_4d6[i]].push(_4d5);}},resolve:function(type){return this.engines[type]||[];},initialize:function(){var _4d7=this;bespin.subscribe("parser:engine:parse",function(_4d8){var ret=_4d7.parse(_4d8.source,_4d8.type,_4d8.parseOptions);bespin.publish("parser:engine:parseDone",{type:_4d8.type,info:ret});});for(var type in this.engines){var list=this.engines[type];for(var i=0;i<list.length;i++){var eng=list[i];if(!eng._init){if(eng.initialize){eng.initialize();}eng._init=true;}}}bespin.publish("parser:engine:initialized",{});}};}();bespin.parser.EngineResolver.register(new bespin.parser.JSLint(),["js","css"]);bespin.parser.EngineResolver.register(new bespin.parser.JavaScript(),["js"]);bespin.parser.AsyncEngineResolver=new bespin.worker.WorkerFacade(bespin.parser.EngineResolver,1,["/js/jsparse/jsdefs.js","/js/jsparse/jsparse.js","/js/jsparse/fulljslint.js"]);bespin.subscribe("parser:start",function(){bespin.get("parser").start();});bespin.register("parser",new bespin.parser.CodeInfo());bespin.fireAfter(["settings:language","settings:set:syntaxcheck","parser:engine:initialized"],function(){var _4d9=bespin.get("settings");if(_4d9&&_4d9.isOn(_4d9.get("syntaxcheck"))){var _4da=bespin.get("editor");if(_4da.language){bespin.publish("parser:start");}else{bespin.subscribe("settings:language",function(){bespin.publish("parser:start");});}}});bespin.subscribe("settings:language",function(){var _4db=bespin.get("settings");if(_4db&&_4db.isOn(_4db.get("syntaxcheck"))){bespin.publish("parser:start");}});}if(!dojo._hasResource["bespin.cmd.cmd"]){dojo._hasResource["bespin.cmd.cmd"]=true;dojo.provide("bespin.cmd.cmd");bespin.cmd.cmd.commands=new bespin.command.Store(bespin.command.store,{name:"cmd",preview:"Various commands to manage commands"});bespin.cmd.cmd.commands.addCommand({name:"help",takes:["search"],preview:"show subcommands for project command",description:"The <strong>help</strong> gives you access to the various subcommands in the cmd command space.<br/><br/>You can narrow the search of a command by adding an optional search params.<br/><br/>Finally, pass in the full name of a command and you can get the full description, which you just did to see this!",completeText:"optionally, narrow down the search",execute:function(_4dc,_4dd){var _4de=this.parent.getHelp(_4dd);_4dc.addOutput(_4de);}});bespin.cmd.cmd.commands.addCommand({name:"load",takes:["commandname"],preview:"load up a new command",completeText:"command name to load (required)",usage:"[commandname]: Command name required.",execute:function(_4df,_4e0){if(!_4e0){_4df.addUsageOutput(this);return;}if(!_4e0){_4df.addErrorOutput("Please pass me a command name to load.");return;}var path="commands/"+_4e0+".js";var _4e1=bespin.userSettingsProject;var _4e2=function(file){try{var _4e3=eval(file.content);bespin.command.store.addCommand(_4e3);}catch(e){_4df.addErrorOutput("Something is wrong about the command:<br><br>"+e);}};bespin.get("files").loadContents(_4e1,path,_4e2,true);}});bespin.cmd.cmd.commands.addCommand({name:"edit",takes:["commandname"],aliases:["add"],preview:"edit the given command (force if doesn't exist",completeText:"command name to edit (required)",usage:"[commandname]: Command name required.",execute:function(_4e4,_4e5){if(!_4e5){_4e4.addUsageOutput(this);return;}if(!bespin.userSettingsProject){_4e4.addErrorOutput("You don't seem to have a user project. Sorry.");return;}if(!_4e5){_4e4.addErrorOutput("Please pass me a command name to edit.");return;}var _4e6=bespin.userSettingsProject;var _4e7="commands/"+_4e5+".js";var _4e8=""+"{\n"+"    name: '"+_4e5+"',\n"+"    takes: [YOUR_ARGUMENTS_HERE],\n"+"    preview: 'execute any editor action',\n"+"    execute: function(self, args) {\n"+"\n"+"    }\n"+"}";bespin.get("editor").openFile(_4e6,_4e7,{content:_4e8,force:true});}});bespin.cmd.cmd.commands.addCommand({name:"list",preview:"list my custom commands",execute:function(_4e9){if(!bespin.userSettingsProject){_4e9.addOutput("You don't seem to have a user project. Sorry.");return;}bespin.get("server").list(bespin.userSettingsProject,"commands/",function(_4ea){var _4eb;if(!_4ea||_4ea.length<1){_4eb="You haven't installed any custom commands.<br>Want to <a href='https://wiki.mozilla.org/Labs/Bespin/Roadmap/Commands'>learn how?</a>";}else{_4eb="<u>Your Custom Commands</u><br/><br/>";var _4ec=dojo.filter(_4ea,function(file){return bespin.util.endsWith(file.name,"\\.js");});_4eb+=dojo.map(_4ec,function(_4ed){return _4ed.name.replace(/\.js$/,"");}).join("<br>");}_4e9.addOutput(_4eb);});}});bespin.cmd.cmd.commands.addCommand({name:"rm",aliases:["del","delete"],takes:["commandname"],preview:"delete a custom command",completeText:"command name to delete (required)",usage:"[commandname]: Command name required.",execute:function(_4ee,_4ef){if(!_4ef){_4ee.addUsageOutput(this);return;}var _4f0=bespin.get("editSession");var _4f1=bespin.get("files");if(!bespin.userSettingsProject){_4ee.addErrorOutput("You don't seem to have a user project. Sorry.");return;}if(!_4ef){_4ee.addErrorOutput("Please pass me a command name to delete.");return;}var _4f2="commands/"+_4ef+".js";var _4f3=_4ee.link(function(){if(_4f0.checkSameFile(bespin.userSettingsProject,_4f2)){bespin.get("editor").model.clear();}_4ee.addOutput("Removed command: "+_4ef);});var _4f4=_4ee.link(function(xhr){_4ee.addOutput("Wasn't able to remove the command <b>"+_4ef+"</b><br/><em>Error</em> (probably doesn't exist): "+xhr.responseText);});_4f1.removeFile(bespin.userSettingsProject,_4f2,_4f3,_4f4);}});}if(!dojo._hasResource["bespin.cmd.config"]){dojo._hasResource["bespin.cmd.config"]=true;dojo.provide("bespin.cmd.config");bespin.command.store.addCommand({name:"editconfig",aliases:["config"],preview:"load up the config file",execute:function(_4f5){if(!bespin.userSettingsProject){_4f5.addErrorOutput("You don't seem to have a user project. Sorry.");return;}bespin.get("editor").openFile(bespin.userSettingsProject,"config");}});bespin.command.store.addCommand({name:"runconfig",preview:"run your config file",execute:function(_4f6){bespin.get("files").evalFile(bespin.userSettingsProject,"config");}});bespin.command.store.addCommand({name:"bindkey",takes:["modifiers","key","action"],preview:"Bind a key to an action, or show bindings",completeText:"With no arguments show bindings, else give modifier(s), key, and action name to set",execute:function(_4f7,args){var _4f8=bespin.get("editor");if(args.key&&args.action){if(args.modifiers=="none"){args.modifiers="";}_4f8.bindKey(args.action,args.modifiers+" "+args.key,args.selectable);}else{var _4f9=_4f8.editorKeyListener.keyMapDescriptions;var _4fa="<table>";for(var keys in _4f9){var _4fb=keys.split(",");var _4fc=parseInt(_4fb[0]);var _4fd=[];if(_4fb[1]==="true"){_4fd.push("CMD");}if(_4fb[2]==="true"){_4fd.push("CTRL");}if(_4fb[3]==="true"){_4fd.push("ALT");}if(_4fb[4]==="true"){_4fd.push("SHIFT");}var _4fe=_4fd.length>0?_4fd.join(", ")+" ":"";var _4ff=_4fe+bespin.util.keys.KeyCodeToName[_4fc]||_4fc;_4fa+="<tr><td style='text-align:right;'>"+_4ff+"</td><td>&#x2192;</td><td>"+_4f9[keys]+"</td></tr>";}_4fa+="</table>";_4f7.addOutput(_4fa);}}});bespin.command.store.addCommand({name:"alias",takes:["alias","command"],preview:"define and show aliases for commands",completeText:"optionally, add your alias name, and then the command name",execute:function(_500,args){var _501=_500.commandLine.store.aliases;if(!args.alias){var _502="<table>";for(var x in _501){_502+="<tr><td style='text-align:right;'>"+x+"</td><td>&#x2192;</td><td>"+_501[x]+"</td></tr>";}_502+="</table>";_500.addOutput(_502);}else{if(args.command===undefined){var _503=_501[args.alias];if(_503){_500.addOutput(args.alias+" &#x2192; "+_501[args.alias]);}else{_500.addErrorOutput("No alias set for '"+args.alias+"'");}}else{var key=args.alias;var _504=args.command;var _505=_504.split(" ")[0];if(_500.commandLine.store.commands[key]){_500.addErrorOutput("Sorry, there is already a command with the name: "+key);}else{if(_500.commandLine.store.commands[_505]){_501[key]=_504;_500.addOutput("Saving alias: "+key+" &#x2192; "+_504);}else{if(_501[_505]){_501[key]=_504;_500.addOutput("Saving alias: "+key+" &#x2192; "+_501[_504]+" ("+_504+" was an alias itself)");}else{_500.addErrorOutput("Sorry, no command or alias with that name.");}}}}}}});bespin.command.store.addCommand({name:"history",preview:"Show history of the commands",execute:function(_506){var _507=_506.commandLine.history.getInstructions();var _508=[];_508.push("<table>");var _509=1;dojo.forEach(_507,function(_50a){_508.push("<tr>");_508.push("<th>"+_509+"</th>");_508.push("<td>"+_50a.typed+"</td>");_508.push("</tr>");_509++;});_508.push("</table>");_506.addOutput(_508.join(""));}});bespin.command.store.addCommand({name:"set",takes:["key","value"],preview:"define and show settings",execute:function(_50b,_50c){var _50d;if(!_50c.key){var _50e=bespin.get("settings").list();_50d="";dojo.forEach(_50e.sort(function(a,b){if(a.key<b.key){return -1;}else{if(a.key==b.key){return 0;}else{return 1;}}}),function(_50f){if(_50f.key[0]!="_"){_50d+="<a class='setting' href='https://wiki.mozilla.org/Labs/Bespin/Settings#"+_50f.key+"' title='View external documentation on setting: "+_50f.key+"' target='_blank'>"+_50f.key+"</a> = "+_50f.value+"<br/>";}});}else{var key=_50c.key;if(_50c.value===undefined){var _510=bespin.get("settings").get(key);if(_510){_50d="<strong>"+key+"</strong> = "+_510;}else{_50d="You do not have a setting for '"+key+"'";}}else{_50d="Saving setting: <strong>"+key+"</strong> = "+_50c.value;bespin.get("settings").set(key,_50c.value);}}_50b.addOutput(_50d);},findCompletions:function(_511,_512){var _513=bespin.get("settings");var key=_511.action[0];var val=_513.get(key);if(_511.action.length==1){if(val){_511.hint="Current value of "+key+" is '"+val+"'. Enter a new value, or press enter to display in the console.";_512(_511);return;}var list=_513.list().map(function(_514){return _514.key;});var _515=this.parent.filterOptionsByPrefix(list,key);if(_515.length==1){_511.autofill="set "+_515[0];val=_513.get(_515[0]);_511.hint="Current value of "+_515[0]+" is '"+val+"'. Enter a new value, or press enter to display in the console.";}else{if(_515.length==0){_511.error="No matching settings";}else{_515.sort(function(a,b){return a.localeCompare(b);});_511.options=_515;}}_512(_511);return;}if(val){_511.hint="Current value of "+key+" is '"+val+"'. Enter a new value, or press enter to display in the console.";_512(_511);return;}_511.error="No setting for '"+key+"'";_512(_511);return;}});bespin.command.store.addCommand({name:"unset",takes:["key"],preview:"unset a setting entirely",completeText:"add a key for the setting to delete entirely",execute:function(_516,key){var _517=bespin.get("settings");if(!_517.get(key)){_516.addErrorOutput("No setting for "+key+".");}else{_517.unset(key);_516.addOutput("Unset the setting for "+key+".");}},findCompletions:function(_518,_519){var _51a=bespin.get("settings");var key=_518.action[0];var val=_51a.get(key);if(_518.action.length>1){_518.error="Can only unset one setting at a time";_519(_518);return;}if(val){_518.hint="Current value of "+key+" is '"+val+"'. Press enter to remove the setting.";_519(_518);return;}var list=_51a.list().map(function(_51b){return _51b.key;});var _51c=this.parent.filterOptionsByPrefix(list,key);if(_51c.length==1){_518.autofill="set "+_51c[0];val=_51a.get(_51c[0]);_518.hint="Current value of "+_51c[0]+" is '"+val+"'. Press enter to remove the setting.";}else{if(_51c.length==0){_518.error="No matching settings";}else{_51c.sort(function(a,b){return a.localeCompare(b);});_518.options=_51c;}}_519(_518);return;}});}if(!dojo._hasResource["bespin.cmd.editor"]){dojo._hasResource["bespin.cmd.editor"]=true;dojo.provide("bespin.cmd.editor");bespin.command.store.addCommand({name:"search",takes:["searchString"],preview:"searches the current file for the given searchString",completeText:"type in a string to search",execute:function(_51d,str){bespin.get("actions").startSearch(str,"commandLine");bespin.getComponent("popup",function(_51e){_51e.hide();});}});(function(){var _51f="move it! make the editor head to a line number or a function name.";var _520="move it! make the editor head to a line number.";var _521="add the line number to move to, or the name of a function in the file";var _522="add the line number to move to in the file";var _523={name:"goto",takes:["value"],preview:_51f,completeText:_521,execute:function(_524,_525){var _526=bespin.get("settings");if(_525){var _527=parseInt(_525,10);if(isNaN(_527)){if(_526.isOn(_526.get("syntaxcheck"))){bespin.publish("parser:gotofunction",{functionName:_525});}else{_524.addErrorOutput("Please enter a valid line number.");}}else{bespin.get("editor").moveAndCenter(_527);bespin.publish("ui:escape",{});}}}};bespin.command.store.addCommand(_523);bespin.subscribe("settings:set:syntaxcheck",function(){var _528=bespin.get("settings");if(_528.isOn(_528.get("syntaxcheck"))){_523.preview=_51f;_523.completeText=_521;}else{_523.preview=_520;_523.completeText=_522;}});})();bespin.command.store.addCommand({name:"replace",takes:["search","replace"],preview:"s/foo/bar/g",completeText:"add the search regex, and then the replacement text",execute:function(_529,args){bespin.get("editor").ui.actions.replace(args);}});bespin.command.store.addCommand({name:"sort",takes:["direction"],preview:"sort the current buffer",completeText:"optionally, sort descending",execute:function(_52a,_52b){var _52c=bespin.get("editor").model.getDocument().split(/\n/);_52c.sort();if(_52b&&/^desc/.test(_52b.toLowerCase())){_52c.reverse();}bespin.get("editor").model.insertDocument(_52c.join("\n"));}});bespin.command.store.addCommand({name:"trim",takes:["side"],preview:"trim trailing or leading whitespace",completeText:"optionally, give a side of left, right, or both (defaults to right)",execute:function(_52d,side){if(!side){side="right";}var _52e={replace:""};if(bespin.util.include(["left","both"],side)){_52e.search="^\\s+";bespin.get("editor").ui.actions.replace(_52e);}if(bespin.util.include(["right","both"],side)){_52e.search="\\s+$";bespin.get("editor").ui.actions.replace(_52e);}}});bespin.command.store.addCommand({name:"uc",preview:"Change all selected text to uppercase",withKey:"CMD SHIFT U",execute:function(_52f){var args={stringCase:"u"};bespin.get("editor").ui.actions.selectionChangeCase(args);}});bespin.command.store.addCommand({name:"lc",preview:"Change all selected text to lowercase",withKey:"CMD SHIFT L",execute:function(_530){var args={stringCase:"l"};bespin.get("editor").ui.actions.selectionChangeCase(args);}});bespin.command.store.addCommand({name:"outline",preview:"show outline of source code",withKey:"ALT SHIFT O",execute:function(_531){bespin.publish("parser:showoutline");}});}if(!dojo._hasResource["bespin.cmd.file"]){dojo._hasResource["bespin.cmd.file"]=true;dojo.provide("bespin.cmd.file");bespin.command.store.addCommand({name:"files",aliases:["ls","list"],takes:["path"],preview:"show files",completeText:"list files relative to current file, or start with /projectname",execute:function(_532,_533){var list=bespin.cmd.file._parseArguments(_533,{filter:true});bespin.get("server").list(list.project,list.path,function(_534){var _535="";for(var x=0;x<_534.length;x++){_535+=_534[x].name+"<br/>";}_532.addOutput(_535);});},findCompletions:function(_536,_537){bespin.cmd.file._findCompletionsHelper(_536,_537,{matchFiles:false,matchDirectories:true});}});bespin.command.store.addCommand({name:"mkdir",takes:["path"],preview:"create a new directory, use a leading / to create a directory in a different project",usage:"[path]",execute:function(_538,_539){if(!_539){_538.addUsageOutput(this);return;}var _53a=bespin.get("editSession");var info=bespin.cmd.file._parseArguments(_539);var path=info.path;var _53b=info.project||_53a.project;var _53c=_538.link(function(){if(path==""){_53a.setProject(_53b);}_538.addOutput("Successfully created directory '/"+_53b+"/"+path+"'");_538.unlink();});var _53d=_538.link(function(xhr){_538.addErrorOutput("Unable to create directory '/"+_53b+"/"+path+"': "+xhr.responseText);_538.unlink();});bespin.get("files").makeDirectory(_53b,path,_53c,_53d);}});bespin.command.store.addCommand({name:"save",takes:["filename"],preview:"save the current contents",completeText:"add the filename to save as, or use the current file",withKey:"CMD S",execute:function(_53e,_53f){bespin.get("editor").saveFile(null,_53f);}});bespin.command.store.addCommand({name:"open",aliases:["load"],takes:["path","line"],preview:"load up the contents of the file",completeText:"add the filename to open",execute:function(_540,opts){bespin.publish("editor:openfile",opts);var info=bespin.cmd.file._parseArguments(opts.path);bespin.get("editor").openFile(info.project,info.path,{line:opts.line});bespin.publish("ui:escape",{});},findCompletions:function(_541,_542){bespin.cmd.file._findCompletionsHelper(_541,_542,{matchFiles:true,matchDirectories:true});}});bespin.command.store.addCommand({name:"status",preview:"get info on the current project and file",execute:function(_543){_543.addOutput(bespin.get("editSession").getStatus());}});bespin.command.store.addCommand({name:"newfile",takes:["filename"],preview:"create a new buffer for file",completeText:"optionally, you can specify a full path including project by starting the filename with \"/\"",withKey:"CTRL SHIFT N",execute:function(_544,_545){var info=bespin.cmd.file._parseArguments(_545);bespin.get("editor").newFile(info.project,info.path);bespin.publish("ui:escape",{});}});bespin.command.store.addCommand({name:"rm",aliases:["remove","del"],takes:["filename"],preview:"remove the file",completeText:"add the filename to remove, give a full path starting with "/" to delete from a different project. To delete a directory end the path in a "/"",execute:function(_546,_547){var info=bespin.cmd.file._parseArguments(_547);var path=info.path;var _548=info.project;var _549=_546.link(function(){if(bespin.get("editSession").checkSameFile(_548,path)){bespin.get("editor").model.clear();}_546.addOutput("Removed file: "+_547,true);_546.unlink();});var _54a=_546.link(function(xhr){_546.addErrorOutput("Wasn't able to remove the file <b>"+_547+"</b><br/><em>Error</em> (probably doesn't exist): "+xhr.responseText);_546.unlink();});bespin.get("files").removeFile(_548,path,_549,_54a);},findCompletions:function(_54b,_54c){bespin.cmd.file._findCompletionsHelper(_54b,_54c,{matchFiles:true,matchDirectories:true});}});bespin.command.store.addCommand({name:"clear",aliases:["cls"],preview:"clear the file",execute:function(_54d){bespin.get("editor").model.clear();}});bespin.command.store.addCommand({name:"quota",preview:"show your quota info",megabytes:function(_54e){return (_54e/1024/1024).toFixed(2);},execute:function(_54f){var es=bespin.get("editSession");var _550="You have "+this.megabytes(es.quota-es.amountUsed)+" MB free space to put some great code!<br>"+"Used "+this.megabytes(es.amountUsed)+" MB "+"out of your "+this.megabytes(es.quota)+" MB quota.";_54f.addOutput(_550);}});bespin.command.store.addCommand({name:"rescan",takes:["project"],preview:"update the project catalog of files used by quick open",execute:function(_551,_552){if(!_552){bespin.withComponent("editSession",function(_553){_552=_553.project;});}bespin.get("server").rescan(_552,_551,{onSuccess:_551.link(function(_554){_551.addOutput(_554);_551.unlink();}),onFailure:_551.link(function(xhr){_551.addErrorOutput(xhr.response);_551.unlink();})});}});bespin.cmd.file._parseArguments=function(_555,opts){opts=opts||{};var _556=bespin.get("editSession");var _557=_556.project;var path=_556.path||"";var _558=path.split(/\//);_558.pop();path=_558.join("/");var _559="";var _55a="";if(_555){if(_555.charAt(0)==="/"){var _558=_555.substr(1).split(/\//);_559=_558.pop();_557=_558.shift()||"";if(_558.length){path=_558.join("/")+"/";}else{path="";}_55a="/"+_557+"/"+path;_55a=_55a.replace(/\/+/g,"/");}else{var _558=_555.split(/\//);_559=_558.pop();var _55b=_558.join("/");path=path+"/"+_55b;_55a="";}}if(!opts.filter){path=path+_559;_559=undefined;}return {project:_557,path:path,filter:_559,projectPath:_55a};};bespin.cmd.file._findCompletionsHelper=function(_55c,_55d,_55e){var _55f=_55c.action.join(" ");var list=bespin.cmd.file._parseArguments(_55f,{filter:true});var self=this;bespin.get("server").list(list.project,list.path,function(_560){var _561=_560.filter(function(file){var _562=(file.size!==undefined);if((_55e.matchDirectories&&_562)&&(_55e.matchFiles&&!_562)){return false;}return file.name.substr(0,list.filter.length)===list.filter;});if(_561.length==1){_55c.autofill=_55c.prefix+list.projectPath+_561[0].name;_55c.hint="Press return to "+_55c.autofill;}else{if(_561.length==0){_55c.error="No matches";}else{_55c.options=_561.map(function(_563){return _563.name;});}}_55d(_55c);});};}if(!dojo._hasResource["bespin.cmd.other"]){dojo._hasResource["bespin.cmd.other"]=true;dojo.provide("bespin.cmd.other");bespin.command.store.addCommand({name:"eval",takes:["js-code"],preview:"evals given js code and show the result",completeText:"evals given js code and show the result",execute:function(_564,_565){try{var _566=eval(_565);}catch(e){var _566="<b>Error: "+e.message+"</b>";}var msg="";var type="";if(dojo.isFunction(_566)){msg=(_566+"").replace(/\n/g,"<br>").replace(/ /g,"&#160");type="function";}else{if(dojo.isObject(_566)){if(dojo.isArray(_566)){type="array";}else{type="object";}var _567=[];var _568;for(x in _566){if(dojo.isFunction(_566[x])){_568="[function]";}else{if(dojo.isObject(_566[x])){_568="[object]";}else{_568=_566[x];}}_567.push({name:x,value:_568});}_567.sort(function(a,b){return (a.name.toLowerCase()<b.name.toLowerCase())?-1:1;});for(var x=0;x<_567.length;x++){msg+="<b>"+_567[x].name+"</b>: "+_567[x].value+"<br>";}}else{msg=_566;type=typeof _566;}}_564.addOutput("Result for eval <b>\""+_565+"\"</b> (type: "+type+"): <br><br>"+msg);}});bespin.command.store.addCommand({name:"version",takes:["command"],preview:"show the version for Bespin or a command",completeText:"optionally, a command name",execute:function(_569,_56a){var _56b="Your Bespin is at version "+bespin.versionNumber+", Code name: \""+bespin.versionCodename+"\"";var _56c;if(_56a){var _56d=_569.commandLine.store.commands[_56a];if(!_56d){_56c="It appears that there is no command named '"+_56a+"', but "+_56b;}else{_56c=(_56d.version)?"The command named '"+_56a+"' is at version "+_56d.version:"The command named '"+_56a+"' is a core command in Bespin version "+bespin.versionNumber;}}else{_56c=_56b;}_569.addOutput(_56c);}});bespin.command.store.addCommand({name:"bespin",preview:"has",hidden:true,messages:["really wants you to trick it out in some way.","is your Web editor.","would love to be like Emacs on the Web.","is written on the Web platform, so you can tweak it."],execute:function(_56e){var _56f=Math.floor(Math.random()*this.messages.length);_56e.addOutput("Bespin "+this.messages[_56f]);}});}if(!dojo._hasResource["dojo.io.iframe"]){dojo._hasResource["dojo.io.iframe"]=true;dojo.provide("dojo.io.iframe");dojo.io.iframe={create:function(_570,_571,uri){if(window[_570]){return window[_570];}if(window.frames[_570]){return window.frames[_570];}var _572=null;var turi=uri;if(!turi){if(dojo.config["useXDomain"]&&!dojo.config["dojoBlankHtmlUrl"]){console.warn("dojo.io.iframe.create: When using cross-domain Dojo builds,"+" please save dojo/resources/blank.html to your domain and set djConfig.dojoBlankHtmlUrl"+" to the path on your domain to blank.html");}turi=(dojo.config["dojoBlankHtmlUrl"]||dojo.moduleUrl("dojo","resources/blank.html"));}var _573=dojo.isIE?"<iframe name=\""+_570+"\" src=\""+turi+"\" onload=\""+_571+"\">":"iframe";_572=dojo.doc.createElement(_573);with(_572){name=_570;setAttribute("name",_570);id=_570;}dojo.body().appendChild(_572);window[_570]=_572;with(_572.style){if(!(dojo.isSafari<3)){position="absolute";}left=top="1px";height=width="1px";visibility="hidden";}if(!dojo.isIE){this.setSrc(_572,turi,true);_572.onload=new Function(_571);}return _572;},setSrc:function(_574,src,_575){try{if(!_575){if(dojo.isWebKit){_574.location=src;}else{frames[_574.name].location=src;}}else{var idoc;if(dojo.isIE||dojo.isWebKit>521){idoc=_574.contentWindow.document;}else{if(dojo.isSafari){idoc=_574.document;}else{idoc=_574.contentWindow;}}if(!idoc){_574.location=src;return;}else{idoc.location.replace(src);}}}catch(e){console.log("dojo.io.iframe.setSrc: ",e);}},doc:function(_576){var doc=_576.contentDocument||(((_576.name)&&(_576.document)&&(document.getElementsByTagName("iframe")[_576.name].contentWindow)&&(document.getElementsByTagName("iframe")[_576.name].contentWindow.document)))||((_576.name)&&(document.frames[_576.name])&&(document.frames[_576.name].document))||null;return doc;},send:function(args){if(!this["_frame"]){this._frame=this.create(this._iframeName,dojo._scopeName+".io.iframe._iframeOnload();");}var dfd=dojo._ioSetArgs(args,function(dfd){dfd.canceled=true;dfd.ioArgs._callNext();},function(dfd){var _577=null;try{var _578=dfd.ioArgs;var dii=dojo.io.iframe;var ifd=dii.doc(dii._frame);var _579=_578.handleAs;_577=ifd;if(_579!="html"){if(_579=="xml"){if(dojo.isIE){dojo.query("a",dii._frame.contentWindow.document.documentElement).orphan();var _57a=(dii._frame.contentWindow.document).documentElement.innerText;_57a=_57a.replace(/>\s+</g,"><");_57a=dojo.trim(_57a);var _57b={responseText:_57a};_577=dojo._contentHandlers["xml"](_57b);}}else{_577=ifd.getElementsByTagName("textarea")[0].value;if(_579=="json"){_577=dojo.fromJson(_577);}else{if(_579=="javascript"){_577=dojo.eval(_577);}}}}}catch(e){_577=e;}finally{_578._callNext();}return _577;},function(_57c,dfd){dfd.ioArgs._hasError=true;dfd.ioArgs._callNext();return _57c;});dfd.ioArgs._callNext=function(){if(!this["_calledNext"]){this._calledNext=true;dojo.io.iframe._currentDfd=null;dojo.io.iframe._fireNextRequest();}};this._dfdQueue.push(dfd);this._fireNextRequest();dojo._ioWatch(dfd,function(dfd){return !dfd.ioArgs["_hasError"];},function(dfd){return (!!dfd.ioArgs["_finished"]);},function(dfd){if(dfd.ioArgs._finished){dfd.callback(dfd);}else{dfd.errback(new Error("Invalid dojo.io.iframe request state"));}});return dfd;},_currentDfd:null,_dfdQueue:[],_iframeName:dojo._scopeName+"IoIframe",_fireNextRequest:function(){try{if((this._currentDfd)||(this._dfdQueue.length==0)){return;}var dfd=this._currentDfd=this._dfdQueue.shift();var _57d=dfd.ioArgs;var args=_57d.args;_57d._contentToClean=[];var fn=dojo.byId(args["form"]);var _57e=args["content"]||{};if(fn){if(_57e){var _57f=function(name,_580){var tn;if(dojo.isIE){tn=dojo.doc.createElement("<input type='hidden' name='"+name+"'>");}else{tn=dojo.doc.createElement("input");tn.type="hidden";tn.name=name;}tn.value=_580;fn.appendChild(tn);_57d._contentToClean.push(name);};for(var x in _57e){var val=_57e[x];if(dojo.isArray(val)&&val.length>1){var i;for(i=0;i<val.length;i++){_57f(x,val[i]);}}else{if(!fn[x]){_57f(x,val);}else{fn[x].value=val;}}}}var _581=fn.getAttributeNode("action");var _582=fn.getAttributeNode("method");var _583=fn.getAttributeNode("target");if(args["url"]){_57d._originalAction=_581?_581.value:null;if(_581){_581.value=args.url;}else{fn.setAttribute("action",args.url);}}if(!_582||!_582.value){if(_582){_582.value=(args["method"])?args["method"]:"post";}else{fn.setAttribute("method",(args["method"])?args["method"]:"post");}}_57d._originalTarget=_583?_583.value:null;if(_583){_583.value=this._iframeName;}else{fn.setAttribute("target",this._iframeName);}fn.target=this._iframeName;dojo._ioNotifyStart(dfd);fn.submit();}else{var _584=args.url+(args.url.indexOf("?")>-1?"&":"?")+_57d.query;dojo._ioNotifyStart(dfd);this.setSrc(this._frame,_584,true);}}catch(e){dfd.errback(e);}},_iframeOnload:function(){var dfd=this._currentDfd;if(!dfd){this._fireNextRequest();return;}var _585=dfd.ioArgs;var args=_585.args;var _586=dojo.byId(args.form);if(_586){var _587=_585._contentToClean;for(var i=0;i<_587.length;i++){var key=_587[i];for(var j=0;j<_586.childNodes.length;j++){var _588=_586.childNodes[j];if(_588.name==key){dojo.destroy(_588);break;}}}if(_585["_originalAction"]){_586.setAttribute("action",_585._originalAction);}if(_585["_originalTarget"]){_586.setAttribute("target",_585._originalTarget);_586.target=_585._originalTarget;}}_585._finished=true;}};}if(!dojo._hasResource["bespin.cmd.project"]){dojo._hasResource["bespin.cmd.project"]=true;dojo.provide("bespin.cmd.project");bespin.cmd.project.commands=new bespin.command.Store(bespin.command.store,{name:"project",preview:"Various commands to manage projects"});bespin.cmd.project.commands.addCommand({name:"help",takes:["search"],preview:"show subcommands for project command",description:"The <strong>help</strong> gives you access to the various subcommands in the project command space.<br/><br/>You can narrow the search of a command by adding an optional search params.<br/><br/>Finally, pass in the full name of a command and you can get the full description, which you just did to see this!",completeText:"optionally, narrow down the search",execute:function(_589,_58a){var _58b=this.parent.getHelp(_58a);_589.addOutput(_58b);}});bespin.cmd.project.commands.addCommand({name:"show",preview:"show the current project",execute:function(_58c,_58d){_58c.addOutput(bespin.get("editSession").getStatus());}});bespin.cmd.project.commands.addCommand({name:"list",preview:"show projects",execute:function(_58e,_58f){bespin.get("files").projects(function(_590){var _591="";for(var x=0;x<_590.length;x++){_591+=_590[x].name+"<br/>";}_58e.addOutput(_591);});}});bespin.cmd.project.commands.addCommand({name:"create",takes:["projectname"],preview:"create a new project",usage:"[newprojectname]",execute:function(_592,_593){if(!_593){_592.addUsageOutput(this);return;}var _594=_592.link(function(){bespin.get("editSession").setProject(_593);_592.addOutput("Successfully created project '"+_593+"'.");bespin.publish("project:created",{project:_593});});var _595=_592.link(function(xhr){_592.addErrorOutput("Unable to create project '"+_593+": "+xhr.responseText);});bespin.get("files").makeDirectory(_593,"",_594,_595);}});bespin.cmd.project.commands.addCommand({name:"delete",takes:["projectname"],preview:"delete a project",usage:"[projectname]",execute:function(_596,_597){if(!_597){_596.addUsageOutput(this);return;}if(!_597||_597==bespin.userSettingsProject){_596.addErrorOutput("Sorry, you can't delete the settings project.");return;}var _598=_596.link(function(){_596.addOutput("Deleted project "+_597);_596.unlink();bespin.publish("project:deleted",{project:_597});});var _599=_596.link(function(xhr){_596.addErrorOutput("Failed to delete project "+_597+": "+xhr.responseText);_596.unlink();});bespin.get("files").removeDirectory(_597,"",_598,_599);}});bespin.cmd.project.commands.addCommand({name:"rename",takes:["currentProject","newProject"],preview:"rename a project",usage:"[currentProject], [newProject]",execute:function(_59a,args){if(!args.currentProject||!args.newProject){_59a.addUsageOutput(this);return;}var _59b=args.currentProject;var _59c=args.newProject;if((!_59b||!_59c)||(_59b==_59c)){return;}bespin.get("server").renameProject(_59b,_59c,{onSuccess:_59a.link(function(){bespin.get("editSession").setProject(_59c);_59a.unlink();bespin.publish("project:renamed",{oldName:_59b,newName:_59c});}),onFailure:_59a.link(function(xhr){_59a.addErrorOutput("Unable to rename project from "+_59b+" to "+_59c+"<br><br><em>Are you sure that the "+_59b+" project exists?</em>");_59a.unlink();})});}});bespin.cmd.project.commands.addCommand({name:"export",takes:["project","archivetype"],preview:"export the given project with an archivetype of zip or tgz<br><code>project export myproject</code>",completeText:"project name, archivetype (zip | tgz, defaults to zip)",execute:function(_59d,args){var _59e=args.project||bespin.get("editSession").project;var type=args.archivetype;if(!bespin.util.include(["zip","tgz","tar.gz"],type)){type="zip";}bespin.get("files").projects(function(_59f){var _5a0=_59e+"/";if(bespin.util.indexOfProperty(_59f,"name",_5a0)!=null){bespin.get("server").exportProject(_59e,type);}else{_59d.addErrorOutput("Unabled to export project "+_59e+" because it doesn't seem to exist.");_59d.unlink();}});}});bespin.cmd.project.commands.addCommand({name:"import",takes:["url","project"],preview:"If a URL is given, import that URL (e.g. <code>project import http://foo.com/bar.zip MyProject</code>).<br><br>If only a project is given, then a file upload dialog will ask to upload a local file (e.g. <code>project import MyProject</code>).",completeText:"import from a URL: <code>project import http://foo.com/yourarchive.zip [projectname]</code><br><br>upload from your machine: <code>project import YourProjectName</code><br><br><em>If only a URL is given, the projectname will be implied<br><br>If only a project name is given, a file upload window will be shown to upload.</em>",usage:"import from a URL: <code>project import http://foo.com/yourarchive.zip [projectname]</code><br><br>upload from your machine: <code>project import YourProjectName</code><br><br><em>If only a URL is given, the projectname will be implied<br><br>If only a project name is given, a file upload window will be shown to upload.</em>",calculateProjectName:function(url){var _5a1=url.split("/");var _5a2=_5a1[_5a1.length-1].split(".");_5a2.pop();return _5a2.join("_");},isURL:function(url){return (url&&(/^http(:|s:)/.test(url)));},upload:function(_5a3){var el=dojo.byId("centerpopup");el.innerHTML="<div id='upload-container'><form method='POST' name='upload' id='upload' enctype='multipart/form-data'><div id='upload-header'>Import project via upload <img id='upload-close' src='images/icn_close_x.png' align='right'></div><div id='upload-content'><div id='upload-status'></div><p>Browse to find the project archive that you wish to archive<br>and then click on the <code>Upload</code> button.</p><center><input type='file' id='filedata' name='filedata' accept='application/zip,application/x-gzip'> <input type='submit' value='Upload'></center></div></form></div>";dojo.connect(dojo.byId("upload"),"submit",function(){dojo.byId("upload-status").innerHTML="Importing file into new project "+_5a3;dojo.io.iframe.send({url:"/project/import/"+_5a3,form:dojo.byId("upload"),method:"POST",handleAs:"text",preventCache:true,contentType:"multipart/form-data",load:function(data,_5a4){dojo.byId("upload-status").innerHTML="Thanks for uploading the file!";},error:function(_5a5,_5a6){setTimeout(function(){bespin.get("files").projects(function(_5a7){if(dojo.some(_5a7,function(_5a8){return _5a3+"/"==_5a8.name;})){bespin.publish("project:created",{project:_5a3});dojo.byId("upload-status").innerHTML="Archive imported and project "+_5a3+" has been created!";}else{dojo.byId("upload-status").innerHTML="Error uploading the file. Sorry, try again!";}});},100);}});});bespin.util.webpieces.showCenterPopup(el,true);var _5a9,_5aa;var _5ab=function(){el.removeChild(el.firstChild);bespin.util.webpieces.hideCenterPopup(el);dojo.disconnect(_5a9);dojo.disconnect(_5aa);};_5a9=dojo.connect(dojo.byId("upload-close"),"onclick",_5ab);_5aa=dojo.connect(dojo.byId("overlay"),"onclick",_5ab);},execute:function(_5ac,args){var _5ad,url;if(!args.url){_5ac.addUsageOutput(this);return;}else{if(!args.project&&this.isURL(args.url)){args.project=this.calculateProjectName(args.url);}else{if(this.isURL(args.project)){_5ad=args.project;url=args.url;args.project=url;args.url=_5ad;}else{if(!this.isURL(args.url)){var _5ad=args.url;this.upload(_5ad);}else{_5ad=args.project;url=args.url;_5ac.addOutput("About to import "+_5ad+" from:<br><br>"+url+"<br><br><em>It can take awhile to download the project, so be patient!</em>");bespin.get("server").importProject(_5ad,url,{onSuccess:function(){_5ac.addOutput("Project "+_5ad+" imported from:<br><br>"+url);bespin.publish("project:created",{project:_5ad});},onFailure:function(xhr){_5ac.addErrorOutput("Unable to import "+_5ad+" from:<br><br>"+url+".<br><br>Maybe due to: "+xhr.responseText);}});}}}}}});}if(!dojo._hasResource["bespin.test"]){dojo._hasResource["bespin.test"]=true;dojo.provide("bespin.test");bespin.command.store.addCommand({name:"test",takes:["suite"],preview:"run a test suite or suites",completeText:"suite name, or 'all' to run all tests, or press return to list tests.",execute:function(_5ae,_5af){if(!_5af){if(bespin.util.isEmpty(bespin.test._knownTests)){_5ae.addOutput("No test suites registered. See bespin.test.addTests() to add them.");}else{var msg="Available test targets: all";for(var name in bespin.test._knownTests){msg+=", "+name;}_5ae.addOutput(msg);}}else{if(_5af=="all"){var _5b0=[];for(var name in bespin.test._knownTests){_5b0.push(name);}bespin.test.run(_5ae,_5b0);}else{if(bespin.test._knownTests[_5af]){bespin.test.run(_5ae,[_5af]);}else{_5ae.addErrorOutput("No test suite called: "+_5af);}}}}});dojo.mixin(bespin.test,{addTests:function(name,_5b1){if(name=="all"){throw new Error("Test suites can't be called 'all'");}this._knownTests[name]=_5b1;},run:function(_5b2,_5b3){console.log("bespin.test.run",_5b3);var _5b4=dojo.create("table");_5b2.setElement(_5b4);var _5b5=dojo.create("tbody",{},_5b4);var row=dojo.create("tr",{},_5b5);dojo.create("th",{innerHTML:"Test Name"},row);dojo.create("th",{innerHTML:"Results"},row);dojo.create("th",{innerHTML:"Action"},row);dojo.create("th",{innerHTML:"Notes"},row);var self=this;_5b3.forEach(function(_5b6){row=dojo.create("tr",{},_5b5);dojo.create("th",{innerHTML:_5b6},row);dojo.create("td",{},row);var _5b7=dojo.create("td",{},row);var _5b8=dojo.create("td",{},row);var _5b9=self._knownTests[_5b6];var _5ba=true;if(_5b9.setup){try{_5b9.setup();}catch(e){console.error(_5b6+".setup(): ",e);var _5bb=_5b6+".setup() failed: "+e.toString();_5b8.innerHTML=_5bb;_5ba=false;}}if(_5ba){for(var _5bc in _5b9){var test=_5b9[_5bc];if(_5bc.match(/test/)&&typeof test=="function"){row=dojo.create("tr",{},_5b5);dojo.create("td",{innerHTML:self._addSpaces(_5bc),style:"padding-left:30px;"},row);var _5bd=dojo.create("td",{},row);var _5be=dojo.create("td",{style:"padding:0 3px;"},row);var _5bf=dojo.create("td",{},row);var _5c0=new bespin.test.Assert(_5b6,_5b9,_5bc,test,_5be,_5bf);dojo.create("button",{innerHTML:"Run",onclick:(function(_5c1){return function(){_5c1._reset();_5c1._runTest();};})(_5c0)},_5bd);_5c0._runTest();}}if(_5b9.tearDown){try{_5b9.tearDown();}catch(e){console.error(_5b6+".tearDown(): ",e);var _5bb="tearDown() failed: "+e.toString();_5b8.innerHTML=_5bb;}}}});},_addSpaces:function(_5c2){_5c2=_5c2.replace(/^test/g,"");_5c2=_5c2.replace(/([a-z0-9])([A-Z])/g,"$1 $2");_5c2=_5c2.replace(/([a-zA-Z])([0-9])/g,"$1 $2");return _5c2;},_knownTests:{}});bespin.test.Status={none:{ord:0,attr:{style:{color:"#000",backgroundColor:"#eee"},innerHTML:"-"}},exec:{ord:1,attr:{style:{color:"#fff",backgroundColor:"#888"},innerHTML:"Exec"}},async:{ord:2,attr:{style:{color:"#000",backgroundColor:"#ffa"},innerHTML:"Wait"}},pass:{ord:3,attr:{style:{color:"#000",backgroundColor:"#8f8"},innerHTML:"Pass"}},fail:{ord:4,attr:{style:{color:"#fff",backgroundColor:"#f00"},innerHTML:"Fail"}}};dojo.declare("bespin.test.Assert",null,{constructor:function(_5c3,_5c4,_5c5,test,_5c6,_5c7){this._suiteName=_5c3;this._suite=_5c4;this._test=test;this._testName=_5c5;this._resultsTd=_5c6;this._notesTd=_5c7;this._outstanding=0;this._start=new Date().getTime();this.failFast=false;this.status=bespin.test.Status.none;},isTrue:function(_5c8,_5c9){if(!_5c8){this._fail("isTrue",arguments);}},isFalse:function(_5ca,_5cb){if(_5ca){this._fail("isFalse",arguments);}},isNull:function(_5cc,_5cd){if(_5cc!==null){this._fail("isNull",arguments);}},isNotNull:function(_5ce,_5cf){if(_5ce===null){this._fail("isNotNull",arguments);}},isUndefined:function(_5d0,_5d1){if(_5d0!==undefined){this._fail("isUndefined",arguments);}},isNotUndefined:function(_5d2,_5d3){if(_5d2===undefined){this._fail("isNotUndefined",arguments);}},isNaN:function(_5d4,_5d5){if(!isNaN(_5d4)){this._fail("isNaN",arguments);}},isNotNaN:function(_5d6,_5d7){if(isNaN(_5d6)){this._fail("isNotNaN",arguments);}},isEqual:function(_5d8,_5d9,_5da){if(!this._isEqual(_5d8,_5d9)){this._fail("isEqual",arguments);}},isNotEqual:function(_5db,_5dc,_5dd){if(this._isEqual(_5db,_5dc)){this._fail("isNotEqual",arguments);}},fail:function(_5de){this._fail("fail",arguments);},message:function(_5df){this._addMessage("<strong>"+_5df+"</strong>");},command:function(type,_5e0){var _5e1=bespin.get("commandLine");var _5e2=_5e1.executeCommand(type,true);var self=this;var _5e3=function(_5e4){if(dojo.isArray(_5e0)){_5e0.forEach(function(_5e5){if(_5e4.indexOf(_5e5)==-1){self._fail("command",[type,_5e5],_5e4);}});}else{if(_5e4!=_5e0){self._fail("command",[type,_5e0],_5e4);}}};if(_5e2.element){_5e3(_5e2.element.textContent);}else{if(_5e2.outstanding!=0){_5e2.onOutput(function(){if(_5e2.complete){_5e3(_5e2.output);}});}else{_5e3(_5e2.output);}}},link:function(func,_5e6){this._updateStatus(bespin.test.Status.async);this._outstanding++;var self=this;return function(){try{if(typeof func=="function"){return func.apply(_5e6,arguments);}}catch(e){if(e.toString()!="failFast"){console.error(this._suiteName+"."+this._testName+":link(): ",e);self._addFunctionMessage("link",[e.toString()]);self._updateStatus(bespin.test.Status.fail);}}finally{self._outstanding--;if(self._outstanding==0){self._updateStatus(bespin.test.Status.pass);}}};},createOnError:function(func,_5e7){var self=this;return function(){self._updateStatus(bespin.test.Status.fail);if(typeof func=="function"){self._addMessage("onError handler called");try{return func.apply(_5e7,arguments);}catch(e){if(e.toString()!="failFast"){console.error(this._suiteName+"."+this._testName+":createOnError(): ",e);self._addFunctionMessage("createOnError",[e.toString()]);}}}else{if(typeof func=="string"){self._addFunctionMessage("createOnError",[func]);}else{self._addFunctionMessage("createOnError");}}};},_reset:function(){this.status=bespin.test.Status.none;this._outstanding=0;this._start=new Date().getTime();this._notesTd.innerHTML="";dojo.attr(this._resultsTd,this.status.attr);},_runTest:function(){if(this._suite.setupTest){try{this._suite.setupTest.call(this._suite);}catch(e){console.error("setupTest failure when running: "+this._suiteName+"."+this._testName+"(): ",e);this._addFunctionMessage(this._testName,[e.toString()]);this._updateStatus(bespin.test.Status.fail);return;}}console.log("Running test",this._testName);this._updateStatus(bespin.test.Status.exec);try{this._test.call(this._suite,this);if(this._outstanding==0){this._updateStatus(bespin.test.Status.pass);}}catch(e){if(e!="failFast"){console.error(this._suiteName+"."+this._testName+"(): ",e);this._addFunctionMessage(this._testName,[e.toString()]);this._updateStatus(bespin.test.Status.fail);}}if(this._suite.tearDownTest){try{this._suite.tearDownTest.call(this._suite);}catch(e){console.error("tearDownTest failure when running: "+this._suiteName+"."+this._testName+"(): ",e);this._addFunctionMessage(this._testName,[e.toString()]);this._updateStatus(bespin.test.Status.fail);}}},_fail:function(type,args,_5e8){this._addFunctionMessage(type,args,_5e8);this._updateStatus(bespin.test.Status.fail);if(this.failFast){throw "failFast";}},_addFunctionMessage:function(type,args,_5e9){var _5ea=type+this._argsToString(args);if(_5e9){_5ea+=" = "+dojo.toJson(_5e9);}this._addMessage(_5ea);},_addMessage:function(_5eb){this._notesTd.innerHTML+=_5eb+"<br/>";},_updateStatus:function(_5ec){if(this.status.ord<_5ec.ord){this.status=_5ec;}dojo.attr(this._resultsTd,this.status.attr);var _5ed=(new Date().getTime()-this._start)/1000;this._resultsTd.innerHTML+=" (in "+_5ed+" ms)";},_argsToString:function(args){var _5ee="(";if(args!=null){for(var i=0;i<args.length;i++){if(i!=0){_5ee+=", ";}_5ee+=dojo.toJson(args[i]);}}_5ee+=")";return _5ee;},_isEqual:function(_5ef,_5f0,_5f1){if(!_5f1){_5f1=0;}if(_5f1>10){return true;}if(_5ef==null){if(_5f0!=null){console.log("expected: null, actual non-null: "+dojo.toJson(_5f0));return false;}return true;}if(typeof (_5ef)=="number"&&isNaN(_5ef)){if(!(typeof (_5f0)=="number"&&isNaN(_5f0))){console.log("expected: NaN, actual non-NaN: "+dojo.toJson(_5f0));return false;}return true;}if(_5f0==null){if(_5ef!=null){console.log("actual: null, expected non-null: "+dojo.toJson(_5ef));return false;}return true;}if(typeof _5ef=="object"){if(!(typeof _5f0=="object")){console.log("expected object, actual not an object");return false;}var _5f2=0;for(var prop in _5f0){if(typeof _5f0[prop]!="function"||typeof _5ef[prop]!="function"){var nest=this._isEqual(_5f0[prop],_5ef[prop],_5f1+1);if(typeof nest!="boolean"||!nest){console.log("element '"+prop+"' does not match: "+nest);return false;}}_5f2++;}var _5f3=0;for(prop in _5ef){_5f3++;}if(_5f2!=_5f3){console.log("expected object size = "+_5f3+", actual object size = "+_5f2);return false;}return true;}if(_5f0!=_5ef){console.log("expected = "+_5ef+" (type="+typeof _5ef+"), actual = "+_5f0+" (type="+typeof _5f0+")");return false;}if(_5ef instanceof Array){if(!(_5f0 instanceof Array)){console.log("expected array, actual not an array");return false;}if(_5f0.length!=_5ef.length){console.log("expected array length = "+_5ef.length+", actual array length = "+_5f0.length);return false;}for(var i=0;i<_5f0.length;i++){var _5f4=this._isEqual(_5f0[i],_5ef[i],_5f1+1);if(typeof _5f4!="boolean"||!_5f4){console.log("element "+i+" does not match: "+_5f4);return false;}}return true;}return true;}});}if(!dojo._hasResource["bespin.testTest"]){dojo._hasResource["bespin.testTest"]=true;dojo.provide("bespin.testTest");bespin.test.addTests("test",{setup:function(){this.setupRun=true;},testSetup:function(test){test.isTrue(this.setupRun);},testSimple:function(test){test.isTrue(true);test.isFalse(false);test.isNull(null);test.isUndefined(undefined);test.isNaN(NaN);test.isEqual(42,42);test.isNotNull(undefined);test.isNotNull(0);test.isNotNull("null");test.isNotNull(false);test.isNotUndefined(null);test.isNotUndefined(0);test.isNotUndefined("undefined");test.isNotUndefined(false);test.isNotNaN(null);test.isNotNaN(0);test.isNotNaN("NaN");test.isNotNaN(false);test.isNotEqual(42,43);test.isNotEqual(0,"0");},testAsync:function(test){setTimeout(test.link(function(){test.isTrue(true);test.isEqual(["a"],["a"]);}),10);},testFailures:function(test){test.message("It is important that this test fails in exactly 11 places");setTimeout(test.link(function(){test.isNull(100,"#7");test.isNotNull(null,"#8");}),10);setTimeout(test.link(function(){test.isNull(100,"#9");}),20);setTimeout(test.createOnError(function(){test.fail("#10");}),30);setTimeout(test.createOnError(function(){test.fail("#11");}),40);test.isTrue(false,"#1");test.isFalse(true,"#2");test.isEqual(42,43,"#3");test.isEqual("a","aa","#4");test.isEqual(["a"],["aa"],"#5");test.fail("Die Die Die","#6");},testFailFast:function(test){test.failFast=true;test.fail("This should fail only once");test.fail("If this happens we are broken");},testSlowDeath:function(test){test.message("This only works if we get a 'Delayed failure' message");setTimeout(test.createOnError(function(){test.message("Delayed failure");}),1000);},testSlowPass:function(test){setTimeout(test.link(function(){test.message("Delayed success");}),1000);},testCommand:function(test){test.command("testoutput wibble","wibble");}});bespin.command.store.addCommand({name:"testoutput",takes:["message ..."],preview:"A test echo command",execute:function(_5f5,args){_5f5.addOutput(args);}});}if(!dojo._hasResource["bespin.plugins"]){dojo._hasResource["bespin.plugins"]=true;dojo.provide("bespin.plugins");dojo.declare("bespin.plugins.Extension",null,{constructor:function(_5f6,_5f7,_5f8,meta){this._pluginName=_5f7;this._pluginCollection=_5f6;this._resolver=_5f8;dojo.mixin(this,meta);},load:function(_5f9){var self=this;var _5fa=this.pointer.split(":");var _5fb=this._resolver(_5fa[0]);var _5fc=bespin.plugins.loader.modules[_5fb];if(!_5fc){bespin.plugins.loader.loadScript(_5fb,{callback:function(_5fd){if(!_5fd._used_by_plugins){_5fd._used_by_plugins={};}_5fd._used_by_plugins[self._pluginName]=self._pluginCollection;_5fd._resolver=self._resolver;if(_5fd.activate){_5fd.activate();}if(_5f9){if(_5fa[1]){_5f9(_5fd[_5fa[1]]);}else{_5f9(_5fd);}}},resolver:this._resolver});return;}if(_5f9){if(_5fa[1]){_5f9(_5fc[_5fa[1]]);}else{_5f9(_5fc);}}},getIfLoaded:function(){var _5fe=this.pointer.split(":");var _5ff=this._resolver(_5fe[0]);var _600=bespin.plugins.loader.modules[_5ff];if(_5fe[1]){return _600[_5fe[1]];}else{return _600;}}});dojo.mixin(bespin.plugins,{metadata:{},builtins:{},extensionPoints:{},unregisterExtensionPoints:function(_601,_602){if(!_602){_602=bespin.plugins.metadata;}var _603=bespin.plugins.extensionPoints;var info=_602[_601];if(!info){return;}var _604=info.provides;if(!_604){return;}for(var i=0;i<_604.length;i++){var ep=_604[i];var name=ep[0];var meta=ep[1];var _605=_603[name];if(!_605){continue;}for(var j=0;j<_605.length;j++){var ext=_605[j];if(ext._pluginName==_601){_605.splice(j,1);bespin.publish("extension:removed:"+name,ext);j--;}}}},sameFileResolver:function(name){return this.location;},multiFileResolver:function(name){if(name.charAt(0)!="/"){if(this.location.charAt(this.location.length-1)=="/"){name=this.location+name+".js";}else{name=this.location+"/"+name+".js";}}return name;},registerExtensionPoints:function(_606,_607,_608){var _609=bespin.plugins.extensionPoints;var _60a=bespin.plugins.Extension;if(!_607){_607=bespin.plugins.metadata;}var info=_607[_606];var _60b=info.provides;if(!_60b){return;}if(!_608){_608=bespin.plugins.multiFileResolver;}_608=dojo.hitch(info,_608);for(var i=0;i<_60b.length;i++){var ep=_60b[i];var name=ep[0];var meta=ep[1];var _60c=_609[name];if(!_60c){_60c=_609[name]=[];}var ext=new _60a(_607,_606,_608,meta);_60c.push(ext);bespin.publish("extension:loaded:"+name,ext);}},get:function(_60d){return bespin.plugins.extensionPoints[_60d]||[];},loadOne:function(_60e,_60f){var _610=bespin.plugins.extensionPoints[_60e];if(!_610||!_610[0]){return false;}_610[0].load(_60f);return true;},getLoadedOne:function(_611){var _612=bespin.plugins.extensionPoints[_611];if(!_612||!_612[0]){return undefined;}return _612[0].getIfLoaded();},remove:function(_613,_614){if(!_614){_614=bespin.plugins.metadata;}var info=_614[_613];if(info){var _615=bespin.plugins.loader.modules[info.location];}else{var _615=undefined;}bespin.plugins.unregisterExtensionPoints(_613);if(_615&&_615.deactivate){_615.deactivate();}delete _614[_613];if(_614==bespin.plugins.metadata){bespin.get("files").saveFile("BespinSettings",{name:"plugins.json",content:dojo.toJson(bespin.plugins.metadata)});}},_removeLink:function(node){bespin.get("commandLine").executeCommand("plugin remove \""+node.getAttribute("name")+"\"");},installSingleFilePlugin:function(url){var _616=bespin.plugins.loader.modules[url];bespin.plugins.loader.loadScript(url,{callback:function(_617){if(!_617.info){instruction.addError("Plugin module does not have info!");}var name=_617.info.name;if(!name){name=filename;}bespin.plugins.unregisterExtensionPoints(name);if(_616&&_616.deactivate){_616.deactivate();}_617.info.location=url;bespin.plugins.metadata[name]=_617.info;bespin.plugins.registerExtensionPoints(name,bespin.plugins.metadata,bespin.plugins.sameFileResolver);if(_617.activate){_617.activate();}bespin.get("files").saveFile("BespinSettings",{name:"plugins.json",content:dojo.toJson(bespin.plugins.metadata)});},force:true});},reloadByName:function(_618){var info=bespin.plugins.metadata[_618];if(!info||!info.location){return;}bespin.plugins.installSingleFilePlugin(info.location);},_reloadLink:function(node){bespin.get("commandLine").executeCommand("plugin reload \""+node.getAttribute("name")+"\"");},_computeModulesToReload:function(_619,mod,_61a,_61b){_61a[_619]=true;var _61c=mod._used_by_plugins;for(var _61d in _61c){_61b[_61d]=_61c[_61d];}for(var _61e in mod._depended_on_by){var _61f=bespin.plugins.loader.modules[_61e];this._computeModulesToReload(_61e,_61f,_61a,_61b);}}});bespin.plugins.commands=new bespin.command.Store(bespin.command.store,{name:"plugin",preview:"manage Bespin plugins",subcommanddefault:"help"});bespin.plugins.commands.addCommand({name:"install",takes:["name"],execute:function(_620,name){var _621=bespin.get("editSession");var _622=_621.path;var _623=_621.project;var url="/getscript/file/at/"+_623+"/"+_622;bespin.plugins.installSingleFilePlugin(url);_620.addOutput("Plugin installed.");}});bespin.plugins.commands.addCommand({name:"list",execute:function(_624){var _625="<h2>Installed plugins:</h2>";_625+="<table>";for(var name in bespin.plugins.metadata){_625+="<tr><td>"+name+"</td><td><a onclick=\"bespin.plugins._removeLink(this)\" name=\""+name+"\">Remove</a></td><td><a onclick=\"bespin.plugins._reloadLink(this)\" name=\""+name+"\">Reload</a></td></tr>";}_625+="</table>";_624.addOutput(_625);}});bespin.plugins.commands.addCommand({name:"remove",takes:["name"],execute:function(_626,name){name=name.substring(1,name.length-1);bespin.plugins.remove(name);_626.addOutput("Plugin removed");}});bespin.plugins.commands.addCommand({name:"reload",takes:["name"],execute:function(_627,name){name=name.substring(1,name.length-1);bespin.plugins.reloadByName(name);_627.addOutput("Plugin reloaded");}});bespin.subscribe("bespin:editor:initialized",function(){bespin.get("files").loadContents("BespinSettings","plugins.json",function(info){var data=dojo.fromJson(info.content);bespin.plugins.metadata=data;for(var name in data){bespin.plugins.registerExtensionPoints(name);}});bespin.get("server").request("GET","/js/bespin/builtins.json",null,{evalJSON:true,onSuccess:function(data){bespin.plugins.builtins=data;for(var name in data){bespin.plugins.registerExtensionPoints(name,bespin.plugins.builtins,bespin.plugins.multiFileResolver);}bespin.getComponent("commandLine",function(){});bespin.getComponent("popup",function(){});}});});bespin.subscribe("file:saved",function(e){var _628=bespin.get("settings");var _629="/getscript/file/at/"+e.project+"/"+e.path;if(_628){var _62a=_628.get("editbespin");if(_62a==e.project){_629="/getscript/"+e.path.substring(9);}}var mod=bespin.plugins.loader.modules[_629];if(!mod){return;}var _62b={};var _62c={};bespin.plugins._computeModulesToReload(_629,mod,_62b,_62c);for(var _62d in _62c){bespin.plugins.unregisterExtensionPoints(_62d,_62c[_62d]);}for(var _62e in _62b){delete bespin.plugins.loader.modules[_62e];}for(var _62d in _62c){bespin.plugins.registerExtensionPoints(_62d,_62c[_62d]);}});}if(!dojo._hasResource["bespin.plugins.loader"]){dojo._hasResource["bespin.plugins.loader"]=true;dojo.provide("bespin.plugins.loader");dojo.mixin(bespin.plugins.loader,{modules:{},loadQueue:{},moduleLoaded:function(_62f,_630){console.log(_62f+" module has arrived");var _631=bespin.util.isEmpty;var _632=_630.toString();var _633=bespin.plugins.loader.modules;var _634=bespin.plugins.loader.loadQueue;var _635=_634[_62f];var _636=_635.resolver;var _637=_635.force;_635.moduleFactory=_630;var _638=/require\s*\(('|")([\w\W]*?)('|")\)/mg;var deps=_635.deps={};var _639=_635.dependsOn={};var _63a;while((_63a=_638.exec(_632))!=null){var _63b=_63a[2];var _63c=_636?_636(_63b):_63b;_639[_63c]=true;if(_633[_63c]!==undefined&&!_637){continue;}deps[_63c]=true;if(!_634[_63c]){bespin.plugins.loader.loadScript(_63b,{resolver:_636,force:_637});}}console.log("Module: ",_62f," depends on ",deps);if(_631(deps)){bespin.plugins.loader._loaded(_62f,_634,_635);}},_loaded:function(_63d){var _63e=bespin.util.isEmpty;var _63f=bespin.plugins.loader.modules;var _640=bespin.plugins.loader.loadQueue;var _641=_640[_63d];var _642=_641.resolver;delete _640[_63d];var _643=_641.moduleFactory(function(_644){if(_642){_644=_642(_644);}return bespin.plugins.loader.modules[_644];},{});_643._name=_63d;_643._depends_on=_641.dependsOn;_643._depended_on_by={};for(var _645 in _643._depends_on){_63f[_645]._depended_on_by[_63d]=true;}_63f[_63d]=_643;if(_641.callback){_641.callback(_643);}for(var _646 in _640){console.log("Checking ",_646," in loadQueue");var qi=_640[_646];console.log("qi deps: ",qi.deps);if(qi.deps&&qi.deps[_63d]){delete qi.deps[_63d];if(_63e(qi.deps)){bespin.plugins.loader._loaded(_646);}}}},loadScript:function(_647,opts){opts=opts||{};var _648=bespin.plugins.loader.loadQueue;if(opts.resolver){_647=opts.resolver(_647);}if(_648[_647]&&!opts.force&&!opts.reload){return;}console.log("Queued "+_647+" for load");setTimeout(function(){if(_648[_647]){console.error("Unable to load before timeout: "+_647);}},2000);_648[_647]={factory:null,name:_647,callback:opts.callback,resolver:opts.resolver,force:opts.force};bespin.plugins.loader._addScriptTag(_647);},_addScriptTag:function(_649){var s=document.createElement("script");var _64a=new Date().getTime();s.setAttribute("src",_649+"?"+_64a);document.getElementsByTagName("head")[0].appendChild(s);}});}if(!dojo._hasResource["bespin.plugins.loaderTest"]){dojo._hasResource["bespin.plugins.loaderTest"]=true;dojo.provide("bespin.plugins.loaderTest");bespin.test.addTests("loader",{setup:function(){this.oldAddScriptTag=bespin.plugins.loader._addScriptTag;bespin.plugins.loader._addScriptTag=this._addScriptTag;},tearDown:function(){console.log("teardown was called");bespin.plugins.loader._addScriptTag=this._addScriptTag;},setupTest:function(){this.scriptsLoaded=[];this.reset();},_addScriptTag:function(){console.log("Script tag WOULD HAVE been added if this were not a test");},reset:function(){console.log("reset called");bespin.plugins.loader.modules=[];bespin.plugins.loader.loadQueue=[];},resolver:function(name){if(name.charAt(0)!="/"){name="/js/"+name;}if(!bespin.util.endsWith(name,"\\.js")){name=name+".js";}name="/getscript"+name;return name;},testQueueUpAModule:function(test){bespin.plugins.loader.loadScript("bespin/nonModule",{resolver:this.resolver});var lq=bespin.plugins.loader.loadQueue;test.isNotUndefined(lq["/getscript/js/bespin/nonModule.js"],"Expected to find module in load queue");},testModuleWithNoDeps:function(test){var lq=bespin.plugins.loader.loadQueue;loadCheck={didLoad:false};var _64b="/getscript/js/bespin/nonModule.js";lq[_64b]={resolver:this.resolver};bespin.plugins.loader.moduleLoaded(_64b,function(_64c,_64d){loadCheck.didLoad=true;_64d.secretValue=27;return _64d;});test.isTrue(loadCheck.didLoad);test.isUndefined(lq[_64b],"Module should be gone from the queue");test.isNotUndefined(bespin.plugins.loader.modules[_64b],"Was module object saved?");var _64e=bespin.plugins.loader.modules[_64b];test.isEqual(27,_64e.secretValue);},testModuleWithSingleDep:function(test){var lq=bespin.plugins.loader.loadQueue;loadCheck={didLoad:false,otherDidLoad:false};var _64f="/getscript/js/bespin/nonModule.js";var _650="/getscript/js/bespin/depModule.js";bespin.plugins.loader.loadScript("bespin/nonModule",{resolver:this.resolver});bespin.plugins.loader.moduleLoaded(_64f,function(_651,_652){var _653=_651("bespin/depModule");loadCheck.didLoad=true;_652.secretValue=_653.secretValue;return _652;});test.isFalse(loadCheck.didLoad);test.isNotUndefined(lq[_64f],"main module should be in the queue");test.isNotUndefined(lq[_650],"dependent module should be in queue");test.isNotUndefined(lq[_650].resolver);bespin.plugins.loader.moduleLoaded(_650,function(_654,_655){loadCheck.otherDidLoad=true;_655.secretValue=192;return _655;});test.isTrue(loadCheck.didLoad,"Main module should load");test.isTrue(loadCheck.otherDidLoad,"Module it depended on should load");console.dir(bespin.plugins.loader.modules);var mod=bespin.plugins.loader.modules[_64f];test.isNotUndefined(mod,"The main module should be requireable");test.isEqual(192,mod.secretValue,"secret value should have been set");test.isEqual(_64f,mod._name);var _656={};_656[_650]=true;test.isEqual(mod._depends_on,_656);var _657=bespin.plugins.loader.modules[_650];test.isEqual(_650,_657._name);var _658={};_658[_64f]=true;test.isEqual(_657._depended_on_by,_658);},testModuleLoadOrderShouldNotMatter:function(test){var _659=bespin.plugins.loader;var lq=_659.loadQueue;var _65a={};_659.loadScript("A",{resolver:this.resolver});_659.moduleLoaded("/getscript/js/A.js",function(_65b,_65c){_65a.A=true;var B=_65b("B");var C=_65b("C");return _65c;});test.isUndefined(_65a.A,"A should not have been loaded yet");test.isNotUndefined(lq["/getscript/js/B.js"],"B should be queued up");test.isNotUndefined(lq["/getscript/js/C.js"],"C should be queued up");_659.moduleLoaded("/getscript/js/B.js",function(_65d,_65e){_65a.B=true;var D=_65d("D");return _65e;});test.isUndefined(_65a.A,"A should not have been loaded");test.isUndefined(_65a.B,"B should not have been loaded");_659.moduleLoaded("/getscript/js/D.js",function(_65f,_660){_65a.D=true;return _660;});test.isTrue(_65a.D,"D should *now* have been loaded");test.isTrue(_65a.B,"B should *now* have been loaded");test.isUndefined(_65a.A,"A should not have been loaded");_659.moduleLoaded("/getscript/js/C.js",function(_661,_662){_65a.C=true;var D=_661("D");return _662;});test.isTrue(_65a.C,"C should *now* have been loaded");test.isTrue(_65a.A,"A should *now* have been loaded");},testDependenciesAreForceReloadedToo:function(test){var _663=bespin.plugins.loader;var lq=_663.loadQueue;var _664={};_663.loadScript("A",{resolver:this.resolver});var _665=function(_666,_667){_664.A=true;var B=_666("B");return _667;};_663.moduleLoaded("/getscript/js/A.js",_665);test.isUndefined(_664.A,"A should not have been loaded yet");test.isNotUndefined(lq["/getscript/js/B.js"],"B should be queued up");var _668=function(_669,_66a){_664.B=true;return _66a;};_663.moduleLoaded("/getscript/js/B.js",_668);test.isNotUndefined(_664.A,"A should be loaded");test.isNotUndefined(_664.B,"B should be loaded");delete _664.A;delete _664.B;_663.loadScript("A",{resolver:this.resolver,force:true});_663.moduleLoaded("/getscript/js/A.js",_665);test.isUndefined(_664.A,"A should not have been reloaded yet");test.isNotUndefined(lq["/getscript/js/B.js"],"B should be queued up");}});}if(!dojo._hasResource["bespin.preview"]){dojo._hasResource["bespin.preview"]=true;dojo.provide("bespin.preview");bespin.command.store.addCommand({name:"preview",takes:["filename"],preview:"view the file in a new browser window",completeText:"add the filename to view or use the current file",execute:function(_66b,_66c){bespin.preview.show(_66c);}});bespin.preview.show=function(_66d,_66e,type){var _66f=bespin.get("editSession");var _670=bespin.get("settings");var _66d=_66d||_66f.path;var _66e=_66e||_66f.project;var type=type||_670.get("preview");var url=bespin.util.path.combine("preview/at",_66e,_66d);if(!_670||!_66d){return;}bespin.get("editor").saveFile(null,_66d);if(type=="inline"){var _671=dojo.byId("preview");var _672=dojo.byId("subheader");var _673=dojo.byId("editor");if(dojo.style(_671,"display")=="none"){dojo.style(_673,"display","none");dojo.style(_672,"display","none");dojo.style(_671,"display","block");var _674=dojo.create("iframe",{frameBorder:0,src:url,style:"border:0; width:100%; height:100%; background-color: white; display:block"},_671);var esc=dojo.connect(document,"onkeypress",function(e){var key=e.keyCode||e.charCode;if(key==bespin.util.keys.Key.ESCAPE){_671.removeChild(_674);dojo.style(_671,"display","none");dojo.style(_672,"display","block");dojo.style(_673,"display","block");dojo.disconnect(esc);}});}return;}if(type=="iphone"){var _675=dojo.byId("centerpopup");if(dojo.byId("iphoneIframe")==null){var _676=dojo.create("iframe",{id:"iphoneIframe",frameBorder:0,src:url,style:"border:0; width:320px; height:460px; background-color: white; display:block"},_675);bespin.util.webpieces.showCenterPopup(_675);var esc=dojo.connect(document,"onkeypress",function(e){var key=e.keyCode||e.charCode;if(key==bespin.util.keys.Key.ESCAPE){_675.removeChild(_676);bespin.util.webpieces.hideCenterPopup(_675);dojo.disconnect(esc);}});}return;}window.open(url);};}if(!dojo._hasResource["bespin.wizard"]){dojo._hasResource["bespin.wizard"]=true;dojo.provide("bespin.wizard");dojo.mixin(bespin.wizard,{_wizards:{newuser:{url:"/overlays/newuser.html"},overview:{url:"/overlays/overview.html"}},show:function(_677,type,_678){var _679=this._wizards[type];if(!_679&&_677){_677.addErrorOutput("Unknown wizard: "+type);return;}var warn=function(xhr){if(_677){_677.addErrorOutput("Failed to display wizard: "+xhr.responseText);}};var _67a=_678?warn:null;var _67b=function(data){bespin.wizard._onSuccess(data,_679);};bespin.get("server").fetchResource(_679.url,_67b,_67a);},onClose:function(){bespin.util.webpieces.hideCenterPopup(this.element);},onJump:function(url,_67c){window.open(url);if(_67c){this.onClose();}},onWizard:function(type){this.show(type);this.onClose();},_onSuccess:function(data,_67d){this.element=dojo.byId("centerpopup");this.element.innerHTML=data;dojo.query("#centerpopup script").forEach(function(node){dojo.eval(node.innerHTML);});bespin.util.webpieces.showCenterPopup(this.element,true);if(typeof _67d.onLoad=="function"){_67d.onLoad();}}});bespin.command.store.addCommand({name:"wizard",takes:["type"],hidden:true,preview:"display a named wizard to step through some process",completeText:"The name of the wizard to run. Leave blank to list known wizards",usage:"[type] ...<br><br><em>[type] The name of the user to run (or blank to list wizards)</em>",execute:function(_67e,type){if(!type){var list="";for(var name in bespin.wizard._wizards){if(bespin.wizard._wizards.hasOwnProperty(name)){list+=", "+name;}}_67e.addOutput("Known wizards: "+list.substring(2));return;}bespin.wizard.show(_67e,type,true);}});bespin.command.store.addCommand({name:"welcome",preview:"display welcome + help",execute:function(){bespin.get("commandLine").executeCommand("wizard newuser");}});}if(!dojo._hasResource["bespin.wizardTest"]){dojo._hasResource["bespin.wizardTest"]=true;dojo.provide("bespin.wizardTest");bespin.test.addTests("wizard",{testWizard:function(test){test.command("wizard","Known wizards: newuser, overview");}});}if(!dojo._hasResource["bespin.social"]){dojo._hasResource["bespin.social"]=true;dojo.provide("bespin.social");bespin.social.displayArray=function(_67f,_680,_681,_682){if(!_682||_682.length===0){_67f.addOutput(_680);return;}var _683=_681;_683+="<ul><li>"+_682.join("</li><li>")+"</li></ul>";_67f.addOutput(_683);};bespin.social.toArgArray=function(args){if(args==null){return [];}else{var _684=args.split(" ");if(_684.length==1&&_684[0]==""){return [];}else{return _684;}}};bespin.command.store.addCommand({name:"follow",takes:["username ..."],preview:"add to the list of users we are following, or (with no args) list the current set",completeText:"username(s) of person(s) to follow",usage:"[username] ...<br><br><em>(username optional. Will list current followed users if not provided)</em>",execute:function(_685,args){var _686=bespin.social.toArgArray(args);if(_686.length===0){bespin.get("server").follow([],{evalJSON:true,onSuccess:function(_687){if(!_687||_687.length===0){_685.addOutput("You are not following anyone");return;}var _688=bespin.social.displayFollowers(_687);_685.setElement(_688);},onFailure:function(xhr){_685.addErrorOutput("Failed to retrieve followers: "+xhr.responseText);}});}else{bespin.get("server").follow(_686,{evalJSON:true,onSuccess:function(_689){if(!_689||_689.length===0){_685.addOutput("You are not following anyone");return;}bespin.publish("project:created");var _68a=bespin.social.displayFollowers(_689);_685.setElement(_68a);},onFailure:function(xhr){_685.addErrorOutput("Failed to add follower: "+xhr.responseText);}});}}});dojo.extend(bespin.client.Server,{follow:function(_68b,opts){this.request("POST","/network/follow/",dojo.toJson(_68b),opts);},followers:function(opts){this.request("GET","/network/followers/",null,opts);}});bespin.social.displayFollowers=function(_68c){var _68d=dojo.create("div",{});dojo.create("div",{innerHTML:"You are following these users:"},_68d);var _68e=dojo.create("table",{},_68d);_68c.forEach(function(_68f){var row=dojo.create("tr",{},_68e);var cell=dojo.create("td",{},row);dojo.create("img",{src:"/images/collab_icn_user.png",width:16,height:16},cell);dojo.create("td",{innerHTML:_68f},row);cell=dojo.create("td",{},row);dojo.create("a",{innerHTML:"<small>(unfollow)</small>",onclick:function(){bespin.get("commandLine").executeCommand("unfollow "+_68f);}},cell);});return _68d;};bespin.command.store.addCommand({name:"unfollow",takes:["username ..."],preview:"remove from the list of users we are following",completeText:"username(s) of person(s) to stop following",usage:"[username] ...<br><br><em>The username(s) to stop following</em>",execute:function(_690,args){var _691=bespin.social.toArgArray(args);if(_691.length===0){_690.addErrorOutput("Please specify the users to cease following");}else{bespin.get("server").unfollow(_691,{evalJSON:true,onSuccess:function(_692){if(!_692||_692.length===0){_690.addOutput("You are not following anyone");return;}bespin.publish("project:created");var _693=bespin.social.displayFollowers(_692);_690.setElement(_693);},onFailure:function(xhr){_690.addErrorOutput("Failed to remove follower: "+xhr.responseText);}});}}});dojo.extend(bespin.client.Server,{unfollow:function(_694,opts){this.request("POST","/network/unfollow/",dojo.toJson(_694),opts);}});if(!bespin.social.group){bespin.social.group={};}bespin.social.group.commands=new bespin.command.Store(bespin.command.store,{name:"group",preview:"Collect the people you follow into groups, and display the existing groups",completeText:"subcommands: add, remove, list, help",subcommanddefault:"help"});bespin.social.group.commands.addCommand({name:"help",takes:["search"],preview:"show subcommands for group command",description:"The <u>help</u> gives you access to the various subcommands in the group command space.<br/><br/>You can narrow the search of a command by adding an optional search params.<br/><br/>Finally, pass in the full name of a command and you can get the full description, which you just did to see this!",completeText:"optionally, narrow down the search",execute:function(_695,_696){var _697=this.parent.getHelp(_696);_695.addOutput(_697);}});bespin.social.group.commands.addCommand({name:"list",preview:"List the current group and group members",takes:["group"],completeText:"An optional group name or leave blank to list groups",description:"List the current group and group members.",execute:function(_698,_699){if(!_699){bespin.get("server").groupListAll({evalJSON:true,onSuccess:function(_69a){if(!_69a||_69a.length===0){_698.addOutput("You have no groups");return;}var _69b=dojo.create("div",{});dojo.create("div",{innerHTML:"You have the following groups:"},_69b);var _69c=dojo.create("table",{},_69b);_69a.forEach(function(_69d){var row=dojo.create("tr",{},_69c);var cell=dojo.create("td",{},row);dojo.create("img",{src:"/images/collab_icn_group.png",width:16,height:16},cell);dojo.create("td",{innerHTML:_69d},row);cell=dojo.create("td",{},row);dojo.create("a",{innerHTML:"<small>(remove)</small>",onclick:function(){_698.commandLine.executeCommand("group remove "+_69d);}},cell);dojo.create("span",{innerHTML:" "},cell);dojo.create("a",{innerHTML:"<small>(list)</small>",onclick:function(){_698.commandLine.executeCommand("group list "+_69d);}},cell);});_698.setElement(_69b);},onFailure:function(xhr){_698.addErrorOutput("Failed to retrieve groups: "+xhr.responseText);}});}else{bespin.get("server").groupList(_699,{evalJSON:true,onSuccess:function(_69e){if(!_69e||_69e.length===0){_698.addOutput(_699+" has no members.");return;}var _69f=dojo.create("div",{});dojo.create("div",{innerHTML:"Members of "+_699+":"},_69f);var _6a0=dojo.create("table",{},_69f);_69e.forEach(function(_6a1){var row=dojo.create("tr",{},_6a0);var cell=dojo.create("td",{},row);dojo.create("img",{src:"/images/collab_icn_user.png",width:16,height:16},cell);dojo.create("td",{innerHTML:_6a1},row);cell=dojo.create("td",{},row);dojo.create("a",{innerHTML:"<small>(ungroup)</small>",onclick:function(){_698.commandLine.executeCommand("group remove "+_699+" "+_6a1);}},cell);});_698.setElement(_69f);},onFailure:function(xhr){_698.addErrorOutput("Failed to retrieve group members: "+xhr.responseText);}});}}});bespin.social.group.commands.addCommand({name:"add",preview:"Add members to a new or existing group",takes:["group","member ..."],completeText:"A group name followed by a list of members to add",description:"Add members to a new or existing group",execute:function(_6a2,args){var _6a3=args.pieces.shift();var _6a4=args.pieces;bespin.get("server").groupAdd(_6a3,_6a4,{onSuccess:function(data){_6a2.addOutput("Added to group '"+_6a3+"': "+_6a4.join(", "));},onFailure:function(xhr){_6a2.addErrorOutput("Failed to add to group members. Maybe due to: "+xhr.responseText);}});}});bespin.social.group.commands.addCommand({name:"remove",preview:"Remove members from an existing group (and remove group if empty)",takes:["group","member ..."],completeText:"A group name followed by a list of members to remove",description:"Remove members from an existing group (and remove group if empty)",execute:function(_6a5,args){var _6a6=args.pieces.shift();var _6a7=args.pieces;if(_6a7.length===1&&_6a7[0]==="all"){bespin.get("server").groupRemoveAll(_6a6,{onSuccess:function(data){_6a5.addOutput("Removed group "+_6a6);},onFailure:function(xhr){_6a5.addErrorOutput("Failed to retrieve group members. Maybe due to: "+xhr.responseText);}});}else{bespin.get("server").groupRemove(_6a6,_6a7,{onSuccess:function(data){_6a5.addOutput("Removed from group '"+_6a6+"': "+_6a7.join(", "));},onFailure:function(xhr){_6a5.addErrorOutput("Failed to remove to group members. Maybe due to: "+xhr.responseText);}});}}});dojo.extend(bespin.client.Server,{groupListAll:function(opts){this.request("GET","/group/list/all/",null,opts);},groupList:function(_6a8,opts){this.request("GET","/group/list/"+_6a8+"/",null,opts);},groupRemove:function(_6a9,_6aa,opts){this.request("POST","/group/remove/"+_6a9+"/",dojo.toJson(_6aa),opts);},groupRemoveAll:function(_6ab,opts){this.request("POST","/group/remove/all/"+_6ab+"/",null,opts);},groupAdd:function(_6ac,_6ad,opts){this.request("POST","/group/add/"+_6ac+"/",dojo.toJson(_6ad),opts);}});bespin.social.share={commands:new bespin.command.Store(bespin.command.store,{name:"share",preview:"Manage the projects that you share to other users",completeText:"subcommands: add, remove, list, help",subcommanddefault:"help"})};bespin.social.share.commands.addCommand({name:"help",takes:["search"],preview:"show subcommands for share command",description:"The <u>help</u> gives you access to the various subcommands in the share command space.<br/><br/>You can narrow the search of a command by adding an optional search params.<br/><br/>Finally, pass in the full name of a command and you can get the full description, which you just did to see this!",completeText:"optionally, narrow down the search",execute:function(_6ae,_6af){var _6b0=this.parent.getHelp(_6af);_6ae.addOutput(_6b0);}});bespin.social.share.commands.addCommand({name:"list",preview:"List the current shared projects",description:"List the current shared projects.",takes:["project"],completeText:"An optional project name or leave blank to list shared projects",execute:function(_6b1,args){var self=this;bespin.get("server").shareListAll({evalJSON:true,onSuccess:function(_6b2){if(args.project&&args.project!=""){_6b2=_6b2.filter(function(_6b3){return _6b3.project==project;});}_6b1.setElement(self.createShareDisplayElement(_6b2));},onFailure:function(xhr){_6b1.addErrorOutput("Failed to list project shares: "+xhr.responseText);}});},createShareDisplayElement:function(_6b4){if(_6b4.length===0){return dojo.create("div",{innerHTML:"You are not sharing any projects"});}var _6b5=dojo.create("div",{});dojo.create("div",{innerHTML:"You have the following shared projects:"},_6b5);var _6b6=dojo.create("table",{},_6b5);var _6b7="";_6b4.forEach(function(_6b8){var row=dojo.create("tr",{},_6b6);if(_6b8.project!==_6b7){var cell=dojo.create("th",{},row);dojo.create("img",{src:"/images/collab_icn_project.png",width:16,height:16},cell);dojo.create("th",{innerHTML:_6b8.project},row);}else{dojo.create("th",{},row);dojo.create("th",{},row);}var _6b9;if(_6b8.type=="everyone"){_6b9="with everyone";}else{if(_6b8.type=="group"){_6b9="with the group "+_6b8.recipient;}else{_6b9="with "+_6b8.recipient;}}cell=dojo.create("td",{innerHTML:_6b9},row);var edit=_6b8.edit?"Editable":"Read-only";cell=dojo.create("td",{innerHTML:edit},row);cell=dojo.create("td",{},row);dojo.create("a",{innerHTML:"<small>(unshare)</small>",onclick:function(){bespin.get("commandLine").executeCommand("share remove "+_6b8.project);}},cell);});return _6b5;}});bespin.social.share.commands.addCommand({name:"remove",preview:"Remove a share from the current shared projects",description:"Remove a share from the current shared projects.",takes:["project","member"],completeText:"A project name and a optional user or group (or leave blank for all users and groups)",execute:function(_6ba,args){if(!args.project||args.project==""){_6ba.addErrorOutput("Missing project.<br/>Syntax: share remove project [{user}|{group}|everyone]");}if(!args.member||args.member==""){bespin.get("server").shareRemoveAll(args.project,{onSuccess:function(data){_6ba.addOutput("All sharing removed from "+args.project);},onFailure:function(xhr){_6ba.addErrorOutput("Failed to remove sharing permissions. Maybe due to: "+xhr.responseText);}});}else{bespin.get("server").shareRemove(args.project,args.member,{onSuccess:function(data){_6ba.addOutput("Removed sharing permission from "+args.member+" to "+args.project);},onFailure:function(xhr){_6ba.addErrorOutput("Failed to remove sharing permission. Maybe due to: "+xhr.responseText);}});}}});bespin.social.share.commands.addCommand({name:"add",preview:"Add a share to the current shared projects",description:"Add a share to the current shared projects.",takes:["project","member","permission"],completeText:"A project name or leave blank to list shared projects",execute:function(_6bb,args){if(!args.project||args.project==""){_6bb.addErrorOutput("Missing project.<br/>Syntax: share add project {user}|{group}|everyone [edit]");}if(!args.member||args.member==""){_6bb.addErrorOutput("Missing user/group.<br/>Syntax: share add project {user}|{group}|everyone [edit]");}bespin.get("server").shareAdd(args.project,args.member,args.permission||"",{onSuccess:function(data){_6bb.addOutput("Adding sharing permission for "+args.member+" to "+args.project);},onFailure:function(xhr){_6bb.addErrorOutput("Failed to add sharing permission. Maybe due to: "+xhr.responseText);}});}});dojo.extend(bespin.client.Server,{shareListAll:function(opts){this.request("GET","/share/list/all/",null,opts);},shareListProject:function(_6bc,opts){this.request("GET","/share/list/"+_6bc+"/",null,opts);},shareListProjectMember:function(_6bd,_6be,opts){this.request("GET","/share/list/"+_6bd+"/"+_6be+"/",null,opts);},shareRemoveAll:function(_6bf,opts){this.request("POST","/share/remove/"+_6bf+"/all/",null,opts);},shareRemove:function(_6c0,_6c1,opts){this.request("POST","/share/remove/"+_6c0+"/"+_6c1+"/",null,opts);},shareAdd:function(_6c2,_6c3,_6c4,opts){this.request("POST","/share/add/"+_6c2+"/"+_6c3+"/",dojo.toJson(_6c4),opts);}});}if(!dojo._hasResource["bespin.socialTest"]){dojo._hasResource["bespin.socialTest"]=true;dojo.provide("bespin.socialTest");bespin.test.addTests("social",{setup:function(){this.server=bespin.get("server");this.originalServerFollowers=this.server.followers;this.originalServerUnfollow=this.server.unfollow;this.originalServerGroupListAll=this.server.groupListAll;},testFollow:function(test){this.server.followers=function(opts){opts.onSuccess("[ ]");};test.command("follow","You are not following anyone");this.server.followers=function(opts){opts.onSuccess("[ 'joe', 'fred' ]");};test.command("follow",["You are following these users","joe","fred","unfollow"]);this.server.followers=function(opts){opts.onFailure({responseText:"ERR"});};test.command("follow","Failed to retrieve followers: ERR");},testGroupHelp:function(test){test.command("group help",["Available Commands","add","help","list","remove"]);},testGroupList:function(test){this.server.groupListAll=function(opts){opts.onSuccess(["homies"]);};test.command("group list",["You have the following groups","homies","remove"]);this.server.groupListAll=function(opts){opts.onFailure({responseText:"ERR"});};test.command("follow","Failed to retrieve groups: ERR");},testUnfollow:function(test){this.server.unfollow=function(_6c5,opts){opts.onSuccess("[ ]");};test.command("unfollow fred","You are not following anyone");},tearDown:function(){this.server.followers=this.originalServerFollowers;this.server.unfollow=this.originalServerUnfollow;this.server.groupListAll=this.originalServerGroupListAll;}});}if(!dojo._hasResource["bespin.mobwrite.core"]){dojo._hasResource["bespin.mobwrite.core"]=true;dojo.provide("bespin.mobwrite.core");var mobwrite={};mobwrite.syncGateway="/mobwrite/";mobwrite.get_maxchars=1000;mobwrite.debug=false;if(!("console" in window)||!("info" in window.console)||!("warn" in window.console)||!("error" in window.console)){mobwrite.debug=false;}mobwrite.sniffUserAgent=function(){if(window.opera){mobwrite.UA_opera=true;}else{var UA=navigator.userAgent.toLowerCase();mobwrite.UA_webkit=UA.indexOf("webkit")!=-1;if(!mobwrite.UA_webkit){mobwrite.UA_gecko=UA.indexOf("gecko")!=-1;if(!mobwrite.UA_gecko){mobwrite.UA_msie=UA.indexOf("msie")!=-1;}}}};mobwrite.UA_gecko=false;mobwrite.UA_opera=false;mobwrite.UA_msie=false;mobwrite.UA_webkit=false;mobwrite.sniffUserAgent();mobwrite.syncRunPid_=null;mobwrite.syncKillPid_=null;mobwrite.timeoutInterval=30000;mobwrite.minSyncInterval=500;mobwrite.maxSyncInterval=10000;mobwrite.syncInterval=2000;mobwrite.idPrefix="";mobwrite.nullifyAll=false;mobwrite.clientChange_=false;mobwrite.serverChange_=false;mobwrite.syncAjaxObj_=null;mobwrite.uniqueId=function(){var soup="abcdefghijklmnopqrstuvwxyz";var id=soup.charAt(Math.random()*soup.length);soup+="0123456789-_.";for(var x=1;x<12;x++){id+=soup.charAt(Math.random()*soup.length);}if(id.indexOf("--")!=-1){id=mobwrite.uniqueId();}return id;};mobwrite.syncUsername=mobwrite.uniqueId();mobwrite.shared={};mobwrite.shareHandlers=[];mobwrite.shareObj=function(id){if(id){this.file=id;this.dmp=new diff_match_patch();this.dmp.Diff_Timeout=0.5;this.editStack=[];if(mobwrite.debug){window.console.info("Creating shareObj: \""+id+"\"");}}};mobwrite.shareObj.prototype.shadowText="";mobwrite.shareObj.prototype.clientVersion=0;mobwrite.shareObj.prototype.serverVersion=0;mobwrite.shareObj.prototype.deltaOk=false;mobwrite.shareObj.prototype.mergeChanges=true;mobwrite.shareObj.prototype.getClientText=function(){window.alert("Defined by subclass");return "";};mobwrite.shareObj.prototype.setClientText=function(text){window.alert("Defined by subclass");};mobwrite.shareObj.prototype.patchClientText=function(_6c6){var _6c7=this.getClientText();var _6c8=this.dmp.patch_apply(_6c6,_6c7);if(_6c7!=_6c8[0]){this.setClientText(_6c8[0]);}};mobwrite.shareObj.prototype.onSentDiff=function(_6c9){};mobwrite.shareObj.prototype.fireChange=function(_6ca){if("createEvent" in document){var e=document.createEvent("HTMLEvents");e.initEvent("change",false,false);_6ca.dispatchEvent(e);}else{if("fireEvent" in _6ca){_6ca.fireEvent("onchange");}}};mobwrite.shareObj.prototype.nullify=function(){mobwrite.unshare(this.file);return "N:"+encodeURI(mobwrite.idPrefix+this.file)+"\n";};mobwrite.shareObj.prototype.syncText=function(){var _6cb=this.getClientText(!this.deltaOk);if(this.deltaOk){var _6cc=this.dmp.diff_main(this.shadowText,_6cb,true);if(_6cc.length>2){this.dmp.diff_cleanupSemantic(_6cc);this.dmp.diff_cleanupEfficiency(_6cc);}var _6cd=_6cc.length!=1||_6cc[0][0]!=DIFF_EQUAL;if(_6cd){mobwrite.clientChange_=true;this.shadowText=_6cb;}if(_6cd||!this.editStack.length){var _6ce=(this.mergeChanges?"d:":"D:")+this.clientVersion+":"+this.dmp.diff_toDelta(_6cc);this.editStack.push([this.clientVersion,_6ce]);this.clientVersion++;this.onSentDiff(_6cc);}}else{if(this.shadowText!=_6cb){this.shadowText=_6cb;}this.clientVersion++;var _6ce="r:"+this.clientVersion+":"+encodeURI(_6cb).replace(/%20/g," ");this.editStack.push([this.clientVersion,_6ce]);}var data="F:"+this.serverVersion+":"+encodeURI(mobwrite.idPrefix+this.file)+"\n";for(var x=0;x<this.editStack.length;x++){data+=this.editStack[x][1]+"\n";}return data.replace(/\x00/g,"%00");};mobwrite.syncRun1_=function(_6cf){mobwrite.clientChange_=false;var data=[];data[0]="u:"+mobwrite.syncUsername+"\n";var _6d0=true;for(var x in mobwrite.shared){if(mobwrite.shared.hasOwnProperty(x)){if(mobwrite.nullifyAll){data.push(mobwrite.shared[x].nullify());}else{data.push(mobwrite.shared[x].syncText());}if(mobwrite.shared[x].getMetaData){data.push("m:"+mobwrite.shared[x].getMetaData()+"\n");}_6d0=false;}}if(_6cf===true){data.push("x:all\n");}if(_6d0){if(mobwrite.debug){window.console.info("MobWrite task stopped.");}return;}if(data.length==1){if(mobwrite.debug){window.console.info("All objects silent; null sync.");}mobwrite.syncRun2_("\n\n");return;}var _6d1=(mobwrite.syncGateway.indexOf("://")!=-1);if(mobwrite.debug){window.console.info("TO server:\n"+data.join(""));}data.push("\n");data=data.join("");mobwrite.syncKillPid_=window.setTimeout(mobwrite.syncKill_,mobwrite.timeoutInterval);if(_6d1){var _6d2=mobwrite.splitBlocks_(data);var head=document.getElementsByTagName("head")[0];for(var x=0;x<_6d2.length;x++){var _6d3=document.getElementById("mobwrite_sync"+x);if(_6d3){_6d3.parentNode.removeChild(_6d3);if(!mobwrite.UA_msie){for(var prop in _6d3){delete _6d3[prop];}_6d3=null;}}if(!_6d3){_6d3=document.createElement("script");_6d3.type="text/javascript";_6d3.charset="utf-8";_6d3.id="mobwrite_sync"+x;}_6d3.src=_6d2[x];head.appendChild(_6d3);}}else{data="q="+encodeURIComponent(data);mobwrite.syncAjaxObj_=mobwrite.syncLoadAjax_(mobwrite.syncGateway,data,mobwrite.syncCheckAjax_);}};mobwrite.splitBlocks_=function(data,_6d4){var _6d5=encodeURIComponent(data);var _6d6=mobwrite.syncGateway+"?p=";var _6d7=mobwrite.get_maxchars-_6d6.length;var _6d8=_6d5.replace(/%20/g,"+");if(_6d8.length<=_6d7){return [_6d6+_6d8];}var _6d9=1;if(typeof _6d4!="undefined"){_6d9=String(_6d4).length;}var _6da=[];var _6db=encodeURIComponent(_6d5);var id=mobwrite.uniqueId();var _6dc=(_6d6+"b%3A"+id+"+++"+"%0A%0A").length+2*_6d9;var _6dd=mobwrite.get_maxchars-_6dc;if(_6dd<3){if(mobwrite.debug){window.console.error("mobwrite.get_maxchars too small to send data.");}_6dd=3;}var _6de=Math.ceil(_6db.length/_6dd);if(typeof _6d4!="undefined"){_6de=Math.max(_6de,_6d4);}var _6df="b%3A"+id+"+"+encodeURIComponent(_6de)+"+";var _6e0=0;for(var x=1;x<=_6de;x++){var _6e1=_6e0+_6dd;if(_6db.charAt(_6e1-1)=="%"){_6e1-=1;}else{if(_6db.charAt(_6e1-2)=="%"){_6e1-=2;}}var _6e2=_6db.substring(_6e0,_6e1);_6da.push(_6d6+_6df+x+"+"+_6e2+"%0A%0A");_6e0=_6e1;}if(_6e0<_6db.length){if(mobwrite.debug){window.console.debug("Recursing splitBlocks_ at n="+(_6de+1));}return this.splitBlocks_(data,_6de+1);}return _6da;};mobwrite.callback=function(text){if(text){mobwrite.syncRun2_(text+"\n");}else{window.clearTimeout(mobwrite.syncKillPid_);mobwrite.syncKillPid_=window.setTimeout(mobwrite.syncKill_,mobwrite.timeoutInterval);}};mobwrite.syncRun2_=function(text){mobwrite.serverChange_=false;if(mobwrite.debug){window.console.info("FROM server:\n"+text);}text=text.replace(/%00/g,"\x00");if(text.length<2||text.substring(text.length-2)!="\n\n"){text="";if(mobwrite.error){window.console.info("Truncated data.  Abort.");}}var _6e3=text.split("\n");var file=null;var _6e4=null;var _6e5=[];for(var i=0;i<_6e3.length;i++){var line=_6e3[i];if(!line){break;}if(line.charAt(1)!=":"){if(mobwrite.debug){window.console.error("Unparsable line: "+line);}continue;}var name=line.charAt(0);var _6e6=line.substring(2);var _6e7;if("FfDdRr".indexOf(name)!=-1){var div=_6e6.indexOf(":");if(div<1){if(mobwrite.debug){window.console.error("No version number: "+line);}continue;}_6e7=parseInt(_6e6.substring(0,div),10);if(isNaN(_6e7)){if(mobwrite.debug){window.console.error("NaN version number: "+line);}continue;}_6e6=_6e6.substring(div+1);}if(name=="E"){var _6e8=_6e6.indexOf(":");if(_6e8){var _6e9=_6e6.substring(0,_6e8);var _6ea=_6e6.substring(_6e8+1);console.error("Collab fail for ",_6e9,_6ea);var _6eb=function(_6ec,_6ed){if(mobwrite.shared.hasOwnProperty(_6ec)){_6e5.push(_6ec);if(mobwrite.shared[_6ec].raiseError){mobwrite.shared[_6ec].raiseError(_6ed,false);}}};if(_6e9=="all"){for(_6e9 in mobwrite.shared){_6eb(_6e9,_6ea);}}else{_6eb(_6e9,_6ea);}}}if(name=="O"){console.error("Read only for ",_6e6);_6e5.push(_6e6);}if(name=="F"||name=="f"){if(_6e6.substring(0,mobwrite.idPrefix.length)==mobwrite.idPrefix){_6e6=_6e6.substring(mobwrite.idPrefix.length);}else{file=null;if(mobwrite.debug){window.console.error("File does not have \""+mobwrite.idPrefix+"\" prefix: "+_6e6);}continue;}if(mobwrite.shared.hasOwnProperty(_6e6)){file=mobwrite.shared[_6e6];file.deltaOk=true;_6e4=_6e7;for(var x=0;x<file.editStack.length;x++){if(file.editStack[x][0]<=_6e4){file.editStack.splice(x,1);x--;}}}else{file=null;if(mobwrite.debug){window.console.error("Unknown file: "+_6e6);}}}else{if(name=="R"||name=="r"){if(file){file.shadowText=decodeURI(_6e6);file.clientVersion=_6e4;file.serverVersion=_6e7;file.editStack=[];if(name=="R"){file.setClientText(file.shadowText);}mobwrite.serverChange_=true;}}else{if(name=="D"||name=="d"){if(file){if(_6e4!=file.clientVersion){file.deltaOk=false;if(mobwrite.debug){window.console.error("Client version number mismatch.\n"+"Expected: "+file.clientVersion+" Got: "+_6e4);}}else{if(_6e7>file.serverVersion){file.deltaOk=false;if(mobwrite.debug){window.console.error("Server version in future.\n"+"Expected: "+file.serverVersion+" Got: "+_6e7);}}else{if(_6e7<file.serverVersion){if(mobwrite.debug){window.console.warn("Server version in past.\n"+"Expected: "+file.serverVersion+" Got: "+_6e7);}}else{var _6ee;try{_6ee=file.dmp.diff_fromDelta(file.shadowText,_6e6);file.serverVersion++;}catch(ex){_6ee=null;file.deltaOk=false;mobwrite.syncInterval=0;if(mobwrite.debug){window.console.error("Delta mismatch.\n"+encodeURI(file.shadowText));}}if(_6ee&&(_6ee.length!=1||_6ee[0][0]!=DIFF_EQUAL)){if(name=="D"){file.shadowText=file.dmp.diff_text2(_6ee);file.setClientText(file.shadowText);}else{var _6ef=file.dmp.patch_make(file.shadowText,_6ee);var _6f0=file.dmp.patch_apply(_6ef,file.shadowText);file.shadowText=_6f0[0];file.patchClientText(_6ef);}mobwrite.serverChange_=true;}else{if(file.syncWithoutChange){file.syncWithoutChange();}}}}}}}else{if(name=="C"||name=="c"){if(file){if(file.reportCollaborators){file.reportCollaborators(_6e6.split(","));}}}}}}}for(var x in mobwrite.shared){if(mobwrite.shared.hasOwnProperty(x)){var _6f1=mobwrite.shared[x];var _6f2=_6e5.indexOf(x)!=-1;if(_6f2&&!_6f1.markedReadOnly){if(_6f1.setReadOnly){_6f1.setReadOnly(true);_6f1.markedReadOnly=true;}}if(!_6f2&&_6f1.markedReadOnly){if(_6f1.setReadOnly){_6f1.setReadOnly(false);_6f1.markedReadOnly=false;}}}}mobwrite.computeSyncInterval_();window.clearTimeout(mobwrite.syncRunPid_);mobwrite.syncRunPid_=window.setTimeout(mobwrite.syncRun1_,mobwrite.syncInterval);if(mobwrite.debug){window.console.log("Next mobwrite sync in ",mobwrite.syncInterval);}window.clearTimeout(mobwrite.syncKillPid_);mobwrite.syncKillPid_=null;};mobwrite.syncNow=function(){window.clearTimeout(mobwrite.syncRunPid_);mobwrite.syncRunPid_=window.setTimeout(mobwrite.syncRun1_,10);if(mobwrite.debug){window.console.log("Forced early mobwrite sync in ",10);}};mobwrite.computeSyncInterval_=function(){var _6f3=mobwrite.maxSyncInterval-mobwrite.minSyncInterval;if(mobwrite.clientChange_){mobwrite.syncInterval=mobwrite.minSyncInterval;}if(mobwrite.serverChange_){mobwrite.syncInterval=mobwrite.minSyncInterval;}if(!mobwrite.clientChange_&&!mobwrite.serverChange_){mobwrite.syncInterval+=_6f3*0.05;}mobwrite.syncInterval=Math.max(mobwrite.minSyncInterval,mobwrite.syncInterval);mobwrite.syncInterval=Math.min(mobwrite.maxSyncInterval,mobwrite.syncInterval);};mobwrite.syncKill_=function(){mobwrite.syncKillPid_=null;if(mobwrite.syncAjaxObj_){mobwrite.syncAjaxObj_.abort();mobwrite.syncAjaxObj_=null;}if(mobwrite.debug){window.console.warn("Connection timeout.");}window.clearTimeout(mobwrite.syncRunPid_);mobwrite.syncRunPid_=window.setTimeout(mobwrite.syncRun1_,1);};mobwrite.syncLoadAjax_=function(url,post,_6f4){var req=null;if(window.XMLHttpRequest){try{req=new XMLHttpRequest();}catch(e1){req=null;}}else{if(window.ActiveXObject){try{req=new ActiveXObject("Msxml2.XMLHTTP");}catch(e2){try{req=new ActiveXObject("Microsoft.XMLHTTP");}catch(e3){req=null;}}}}if(req){req.onreadystatechange=_6f4;req.open("POST",url,true);req.setRequestHeader("Content-Type","application/x-www-form-urlencoded");bespin.get("server").protectXhrAgainstCsrf(req);req.send(post);}return req;};mobwrite.syncCheckAjax_=function(){if(typeof mobwrite=="undefined"||!mobwrite.syncAjaxObj_){return;}if(mobwrite.syncAjaxObj_.readyState==4){var text=mobwrite.syncAjaxObj_.responseText;if(mobwrite.syncAjaxObj_.status==200){try{mobwrite.syncAjaxObj_=null;mobwrite.syncRun2_(text);}catch(ex){console.group("Error calling mobwrite.syncRun2_(..."+text.length+" chars')");console.log(mobwrite);console.error(ex);console.trace();console.groupEnd();window.clearTimeout(mobwrite.syncRunPid_);window.clearTimeout(mobwrite.syncKillPid_);for(var x in mobwrite.shared){if(mobwrite.shared.hasOwnProperty(x)){if(mobwrite.shared[x].raiseError){mobwrite.shared[x].raiseError(text,false);}}}}}else{for(var x in mobwrite.shared){if(mobwrite.shared.hasOwnProperty(x)){if(mobwrite.shared[x].raiseError){mobwrite.shared[x].raiseError(text,true);}}}if(mobwrite.debug){window.console.warn("Connection error code: "+mobwrite.syncAjaxObj_.status+": "+text);}mobwrite.syncAjaxObj_=null;}}};mobwrite.unload_=function(){if(!mobwrite.syncKillPid_){mobwrite.debug=false;mobwrite.syncRun1_(true);}};if(window.addEventListener){window.addEventListener("unload",mobwrite.unload_,false);}else{if(window.attachEvent){window.attachEvent("onunload",mobwrite.unload_);}}mobwrite.share=function(_6f5){for(var i=0;i<arguments.length;i++){var el=arguments[i];var _6f6=null;for(var x=0;x<mobwrite.shareHandlers.length&&!_6f6;x++){_6f6=mobwrite.shareHandlers[x].call(mobwrite,el);}if(_6f6&&_6f6.file){if(_6f6.file in mobwrite.shared){if(mobwrite.debug){window.console.warn("Ignoring duplicate share on \""+el+"\".");}continue;}mobwrite.shared[_6f6.file]=_6f6;if(mobwrite.syncRunPid_===null){mobwrite.syncRunPid_=window.setTimeout(mobwrite.syncRun1_,10);if(mobwrite.debug){window.console.info("MobWrite task started.");}}else{window.clearTimeout(mobwrite.syncRunPid_);}mobwrite.syncRunPid_=window.setTimeout(mobwrite.syncRun1_,10);}else{if(mobwrite.debug){window.console.warn("Share: Unknown widget type: "+el+".");}}}};mobwrite.unshare=function(_6f7){for(var i=0;i<arguments.length;i++){var el=arguments[i];if(typeof el=="object"&&"id" in el){el=el.id;}if(typeof el=="string"&&mobwrite.shared.hasOwnProperty(el)){var _6f8=mobwrite.shared[el];mobwrite.syncUnload_(_6f8);delete mobwrite.shared[el];if(mobwrite.debug){window.console.info("Unshared: "+el);}}else{var _6f9=null;for(var x=0;x<mobwrite.shareHandlers.length&&!_6f9;x++){_6f9=mobwrite.shareHandlers[x].call(mobwrite,el);}if(_6f9&&_6f9.file){if(mobwrite.shared.hasOwnProperty(_6f9.file)){mobwrite.syncUnload_(_6f9);delete mobwrite.shared[_6f9.file];if(mobwrite.debug){window.console.info("Unshared: "+el);}}else{if(mobwrite.debug){window.console.warn("Ignoring "+el+". Not currently shared.");}}}else{if(mobwrite.debug){window.console.warn("Unshare: Unknown widget type: "+el+".");}}}}};mobwrite.syncUnload_=function(_6fa){var data="u:"+mobwrite.syncUsername+"\n"+"x:"+_6fa.file+"\n\n";if(mobwrite.debug){window.console.info("TO server (unshare):\n"+data);}data="q="+encodeURIComponent(data);mobwrite.syncLoadAjax_(mobwrite.syncGateway,data,null);};}if(!dojo._hasResource["bespin.mobwrite.diff"]){dojo._hasResource["bespin.mobwrite.diff"]=true;dojo.provide("bespin.mobwrite.diff");function diff_match_patch(){this.Diff_Timeout=1;this.Diff_EditCost=4;this.Diff_DualThreshold=32;this.Match_Threshold=0.5;this.Match_Distance=1000;this.Patch_Margin=4;function _6fb(){var _6fc=0;var oldi=1;var newi=2;while(oldi!=newi){_6fc++;oldi=newi;newi=newi<<1;}return _6fc;};this.Match_MaxBits=_6fb();};var DIFF_DELETE=-1;var DIFF_INSERT=1;var DIFF_EQUAL=0;diff_match_patch.prototype.diff_main=function(_6fd,_6fe,_6ff){if(_6fd==_6fe){return [[DIFF_EQUAL,_6fd]];}if(typeof _6ff=="undefined"){_6ff=true;}var _700=_6ff;var _701=this.diff_commonPrefix(_6fd,_6fe);var _702=_6fd.substring(0,_701);_6fd=_6fd.substring(_701);_6fe=_6fe.substring(_701);_701=this.diff_commonSuffix(_6fd,_6fe);var _703=_6fd.substring(_6fd.length-_701);_6fd=_6fd.substring(0,_6fd.length-_701);_6fe=_6fe.substring(0,_6fe.length-_701);var _704=this.diff_compute(_6fd,_6fe,_700);if(_702){_704.unshift([DIFF_EQUAL,_702]);}if(_703){_704.push([DIFF_EQUAL,_703]);}this.diff_cleanupMerge(_704);return _704;};diff_match_patch.prototype.diff_compute=function(_705,_706,_707){var _708;if(!_705){return [[DIFF_INSERT,_706]];}if(!_706){return [[DIFF_DELETE,_705]];}var _709=_705.length>_706.length?_705:_706;var _70a=_705.length>_706.length?_706:_705;var i=_709.indexOf(_70a);if(i!=-1){_708=[[DIFF_INSERT,_709.substring(0,i)],[DIFF_EQUAL,_70a],[DIFF_INSERT,_709.substring(i+_70a.length)]];if(_705.length>_706.length){_708[0][0]=_708[2][0]=DIFF_DELETE;}return _708;}_709=_70a=null;var hm=this.diff_halfMatch(_705,_706);if(hm){var _70b=hm[0];var _70c=hm[1];var _70d=hm[2];var _70e=hm[3];var _70f=hm[4];var _710=this.diff_main(_70b,_70d,_707);var _711=this.diff_main(_70c,_70e,_707);return _710.concat([[DIFF_EQUAL,_70f]],_711);}if(_707&&(_705.length<100||_706.length<100)){_707=false;}var _712;if(_707){var a=this.diff_linesToChars(_705,_706);_705=a[0];_706=a[1];_712=a[2];}_708=this.diff_map(_705,_706);if(!_708){_708=[[DIFF_DELETE,_705],[DIFF_INSERT,_706]];}if(_707){this.diff_charsToLines(_708,_712);this.diff_cleanupSemantic(_708);_708.push([DIFF_EQUAL,""]);var _713=0;var _714=0;var _715=0;var _716="";var _717="";while(_713<_708.length){switch(_708[_713][0]){case DIFF_INSERT:_715++;_717+=_708[_713][1];break;case DIFF_DELETE:_714++;_716+=_708[_713][1];break;case DIFF_EQUAL:if(_714>=1&&_715>=1){var a=this.diff_main(_716,_717,false);_708.splice(_713-_714-_715,_714+_715);_713=_713-_714-_715;for(var j=a.length-1;j>=0;j--){_708.splice(_713,0,a[j]);}_713=_713+a.length;}_715=0;_714=0;_716="";_717="";break;}_713++;}_708.pop();}return _708;};diff_match_patch.prototype.diff_linesToChars=function(_718,_719){var _71a=[];var _71b={};_71a[0]="";function _71c(text){var _71d="";var _71e=0;var _71f=-1;var _720=_71a.length;while(_71f<text.length-1){_71f=text.indexOf("\n",_71e);if(_71f==-1){_71f=text.length-1;}var line=text.substring(_71e,_71f+1);_71e=_71f+1;if(_71b.hasOwnProperty?_71b.hasOwnProperty(line):(_71b[line]!==undefined)){_71d+=String.fromCharCode(_71b[line]);}else{_71d+=String.fromCharCode(_720);_71b[line]=_720;_71a[_720++]=line;}}return _71d;};var _721=_71c(_718);var _722=_71c(_719);return [_721,_722,_71a];};diff_match_patch.prototype.diff_charsToLines=function(_723,_724){for(var x=0;x<_723.length;x++){var _725=_723[x][1];var text=[];for(var y=0;y<_725.length;y++){text[y]=_724[_725.charCodeAt(y)];}_723[x][1]=text.join("");}};diff_match_patch.prototype.diff_map=function(_726,_727){var _728=(new Date()).getTime()+this.Diff_Timeout*1000;var _729=_726.length+_727.length-1;var _72a=this.Diff_DualThreshold*2<_729;var _72b=[];var _72c=[];var v1={};var v2={};v1[1]=0;v2[1]=0;var x,y;var _72d;var _72e={};var done=false;var _72f=!!(_72e.hasOwnProperty);var _730=(_726.length+_727.length)%2;for(var d=0;d<_729;d++){if(this.Diff_Timeout>0&&(new Date()).getTime()>_728){return null;}_72b[d]={};for(var k=-d;k<=d;k+=2){if(k==-d||k!=d&&v1[k-1]<v1[k+1]){x=v1[k+1];}else{x=v1[k-1]+1;}y=x-k;if(_72a){_72d=x+","+y;if(_730&&(_72f?_72e.hasOwnProperty(_72d):(_72e[_72d]!==undefined))){done=true;}if(!_730){_72e[_72d]=d;}}while(!done&&x<_726.length&&y<_727.length&&_726.charAt(x)==_727.charAt(y)){x++;y++;if(_72a){_72d=x+","+y;if(_730&&(_72f?_72e.hasOwnProperty(_72d):(_72e[_72d]!==undefined))){done=true;}if(!_730){_72e[_72d]=d;}}}v1[k]=x;_72b[d][x+","+y]=true;if(x==_726.length&&y==_727.length){return this.diff_path1(_72b,_726,_727);}else{if(done){_72c=_72c.slice(0,_72e[_72d]+1);var a=this.diff_path1(_72b,_726.substring(0,x),_727.substring(0,y));return a.concat(this.diff_path2(_72c,_726.substring(x),_727.substring(y)));}}}if(_72a){_72c[d]={};for(var k=-d;k<=d;k+=2){if(k==-d||k!=d&&v2[k-1]<v2[k+1]){x=v2[k+1];}else{x=v2[k-1]+1;}y=x-k;_72d=(_726.length-x)+","+(_727.length-y);if(!_730&&(_72f?_72e.hasOwnProperty(_72d):(_72e[_72d]!==undefined))){done=true;}if(_730){_72e[_72d]=d;}while(!done&&x<_726.length&&y<_727.length&&_726.charAt(_726.length-x-1)==_727.charAt(_727.length-y-1)){x++;y++;_72d=(_726.length-x)+","+(_727.length-y);if(!_730&&(_72f?_72e.hasOwnProperty(_72d):(_72e[_72d]!==undefined))){done=true;}if(_730){_72e[_72d]=d;}}v2[k]=x;_72c[d][x+","+y]=true;if(done){_72b=_72b.slice(0,_72e[_72d]+1);var a=this.diff_path1(_72b,_726.substring(0,_726.length-x),_727.substring(0,_727.length-y));return a.concat(this.diff_path2(_72c,_726.substring(_726.length-x),_727.substring(_727.length-y)));}}}}return null;};diff_match_patch.prototype.diff_path1=function(_731,_732,_733){var path=[];var x=_732.length;var y=_733.length;var _734=null;for(var d=_731.length-2;d>=0;d--){while(1){if(_731[d].hasOwnProperty?_731[d].hasOwnProperty((x-1)+","+y):(_731[d][(x-1)+","+y]!==undefined)){x--;if(_734===DIFF_DELETE){path[0][1]=_732.charAt(x)+path[0][1];}else{path.unshift([DIFF_DELETE,_732.charAt(x)]);}_734=DIFF_DELETE;break;}else{if(_731[d].hasOwnProperty?_731[d].hasOwnProperty(x+","+(y-1)):(_731[d][x+","+(y-1)]!==undefined)){y--;if(_734===DIFF_INSERT){path[0][1]=_733.charAt(y)+path[0][1];}else{path.unshift([DIFF_INSERT,_733.charAt(y)]);}_734=DIFF_INSERT;break;}else{x--;y--;if(_734===DIFF_EQUAL){path[0][1]=_732.charAt(x)+path[0][1];}else{path.unshift([DIFF_EQUAL,_732.charAt(x)]);}_734=DIFF_EQUAL;}}}}return path;};diff_match_patch.prototype.diff_path2=function(_735,_736,_737){var path=[];var _738=0;var x=_736.length;var y=_737.length;var _739=null;for(var d=_735.length-2;d>=0;d--){while(1){if(_735[d].hasOwnProperty?_735[d].hasOwnProperty((x-1)+","+y):(_735[d][(x-1)+","+y]!==undefined)){x--;if(_739===DIFF_DELETE){path[_738-1][1]+=_736.charAt(_736.length-x-1);}else{path[_738++]=[DIFF_DELETE,_736.charAt(_736.length-x-1)];}_739=DIFF_DELETE;break;}else{if(_735[d].hasOwnProperty?_735[d].hasOwnProperty(x+","+(y-1)):(_735[d][x+","+(y-1)]!==undefined)){y--;if(_739===DIFF_INSERT){path[_738-1][1]+=_737.charAt(_737.length-y-1);}else{path[_738++]=[DIFF_INSERT,_737.charAt(_737.length-y-1)];}_739=DIFF_INSERT;break;}else{x--;y--;if(_739===DIFF_EQUAL){path[_738-1][1]+=_736.charAt(_736.length-x-1);}else{path[_738++]=[DIFF_EQUAL,_736.charAt(_736.length-x-1)];}_739=DIFF_EQUAL;}}}}return path;};diff_match_patch.prototype.diff_commonPrefix=function(_73a,_73b){if(!_73a||!_73b||_73a.charCodeAt(0)!==_73b.charCodeAt(0)){return 0;}var _73c=0;var _73d=Math.min(_73a.length,_73b.length);var _73e=_73d;var _73f=0;while(_73c<_73e){if(_73a.substring(_73f,_73e)==_73b.substring(_73f,_73e)){_73c=_73e;_73f=_73c;}else{_73d=_73e;}_73e=Math.floor((_73d-_73c)/2+_73c);}return _73e;};diff_match_patch.prototype.diff_commonSuffix=function(_740,_741){if(!_740||!_741||_740.charCodeAt(_740.length-1)!==_741.charCodeAt(_741.length-1)){return 0;}var _742=0;var _743=Math.min(_740.length,_741.length);var _744=_743;var _745=0;while(_742<_744){if(_740.substring(_740.length-_744,_740.length-_745)==_741.substring(_741.length-_744,_741.length-_745)){_742=_744;_745=_742;}else{_743=_744;}_744=Math.floor((_743-_742)/2+_742);}return _744;};diff_match_patch.prototype.diff_halfMatch=function(_746,_747){var _748=_746.length>_747.length?_746:_747;var _749=_746.length>_747.length?_747:_746;if(_748.length<10||_749.length<1){return null;}var dmp=this;function _74a(_74b,_74c,i){var seed=_74b.substring(i,i+Math.floor(_74b.length/4));var j=-1;var _74d="";var _74e,_74f,_750,_751;while((j=_74c.indexOf(seed,j+1))!=-1){var _752=dmp.diff_commonPrefix(_74b.substring(i),_74c.substring(j));var _753=dmp.diff_commonSuffix(_74b.substring(0,i),_74c.substring(0,j));if(_74d.length<_753+_752){_74d=_74c.substring(j-_753,j)+_74c.substring(j,j+_752);_74e=_74b.substring(0,i-_753);_74f=_74b.substring(i+_752);_750=_74c.substring(0,j-_753);_751=_74c.substring(j+_752);}}if(_74d.length>=_74b.length/2){return [_74e,_74f,_750,_751,_74d];}else{return null;}};var hm1=_74a(_748,_749,Math.ceil(_748.length/4));var hm2=_74a(_748,_749,Math.ceil(_748.length/2));var hm;if(!hm1&&!hm2){return null;}else{if(!hm2){hm=hm1;}else{if(!hm1){hm=hm2;}else{hm=hm1[4].length>hm2[4].length?hm1:hm2;}}}var _754,_755,_756,_757;if(_746.length>_747.length){_754=hm[0];_755=hm[1];_756=hm[2];_757=hm[3];}else{_756=hm[0];_757=hm[1];_754=hm[2];_755=hm[3];}var _758=hm[4];return [_754,_755,_756,_757,_758];};diff_match_patch.prototype.diff_cleanupSemantic=function(_759){var _75a=false;var _75b=[];var _75c=0;var _75d=null;var _75e=0;var _75f=0;var _760=0;while(_75e<_759.length){if(_759[_75e][0]==DIFF_EQUAL){_75b[_75c++]=_75e;_75f=_760;_760=0;_75d=_759[_75e][1];}else{_760+=_759[_75e][1].length;if(_75d!==null&&(_75d.length<=_75f)&&(_75d.length<=_760)){_759.splice(_75b[_75c-1],0,[DIFF_DELETE,_75d]);_759[_75b[_75c-1]+1][0]=DIFF_INSERT;_75c--;_75c--;_75e=_75c>0?_75b[_75c-1]:-1;_75f=0;_760=0;_75d=null;_75a=true;}}_75e++;}if(_75a){this.diff_cleanupMerge(_759);}this.diff_cleanupSemanticLossless(_759);};diff_match_patch.prototype.diff_cleanupSemanticLossless=function(_761){var _762=/[^a-zA-Z0-9]/;var _763=/\s/;var _764=/[\r\n]/;var _765=/\n\r?\n$/;var _766=/^\r?\n\r?\n/;function _767(one,two){if(!one||!two){return 5;}var _768=0;if(one.charAt(one.length-1).match(_762)||two.charAt(0).match(_762)){_768++;if(one.charAt(one.length-1).match(_763)||two.charAt(0).match(_763)){_768++;if(one.charAt(one.length-1).match(_764)||two.charAt(0).match(_764)){_768++;if(one.match(_765)||two.match(_766)){_768++;}}}}return _768;};var _769=1;while(_769<_761.length-1){if(_761[_769-1][0]==DIFF_EQUAL&&_761[_769+1][0]==DIFF_EQUAL){var _76a=_761[_769-1][1];var edit=_761[_769][1];var _76b=_761[_769+1][1];var _76c=this.diff_commonSuffix(_76a,edit);if(_76c){var _76d=edit.substring(edit.length-_76c);_76a=_76a.substring(0,_76a.length-_76c);edit=_76d+edit.substring(0,edit.length-_76c);_76b=_76d+_76b;}var _76e=_76a;var _76f=edit;var _770=_76b;var _771=_767(_76a,edit)+_767(edit,_76b);while(edit.charAt(0)===_76b.charAt(0)){_76a+=edit.charAt(0);edit=edit.substring(1)+_76b.charAt(0);_76b=_76b.substring(1);var _772=_767(_76a,edit)+_767(edit,_76b);if(_772>=_771){_771=_772;_76e=_76a;_76f=edit;_770=_76b;}}if(_761[_769-1][1]!=_76e){if(_76e){_761[_769-1][1]=_76e;}else{_761.splice(_769-1,1);_769--;}_761[_769][1]=_76f;if(_770){_761[_769+1][1]=_770;}else{_761.splice(_769+1,1);_769--;}}}_769++;}};diff_match_patch.prototype.diff_cleanupEfficiency=function(_773){var _774=false;var _775=[];var _776=0;var _777="";var _778=0;var _779=false;var _77a=false;var _77b=false;var _77c=false;while(_778<_773.length){if(_773[_778][0]==DIFF_EQUAL){if(_773[_778][1].length<this.Diff_EditCost&&(_77b||_77c)){_775[_776++]=_778;_779=_77b;_77a=_77c;_777=_773[_778][1];}else{_776=0;_777="";}_77b=_77c=false;}else{if(_773[_778][0]==DIFF_DELETE){_77c=true;}else{_77b=true;}if(_777&&((_779&&_77a&&_77b&&_77c)||((_777.length<this.Diff_EditCost/2)&&(_779+_77a+_77b+_77c)==3))){_773.splice(_775[_776-1],0,[DIFF_DELETE,_777]);_773[_775[_776-1]+1][0]=DIFF_INSERT;_776--;_777="";if(_779&&_77a){_77b=_77c=true;_776=0;}else{_776--;_778=_776>0?_775[_776-1]:-1;_77b=_77c=false;}_774=true;}}_778++;}if(_774){this.diff_cleanupMerge(_773);}};diff_match_patch.prototype.diff_cleanupMerge=function(_77d){_77d.push([DIFF_EQUAL,""]);var _77e=0;var _77f=0;var _780=0;var _781="";var _782="";var _783;while(_77e<_77d.length){switch(_77d[_77e][0]){case DIFF_INSERT:_780++;_782+=_77d[_77e][1];_77e++;break;case DIFF_DELETE:_77f++;_781+=_77d[_77e][1];_77e++;break;case DIFF_EQUAL:if(_77f!==0||_780!==0){if(_77f!==0&&_780!==0){_783=this.diff_commonPrefix(_782,_781);if(_783!==0){if((_77e-_77f-_780)>0&&_77d[_77e-_77f-_780-1][0]==DIFF_EQUAL){_77d[_77e-_77f-_780-1][1]+=_782.substring(0,_783);}else{_77d.splice(0,0,[DIFF_EQUAL,_782.substring(0,_783)]);_77e++;}_782=_782.substring(_783);_781=_781.substring(_783);}_783=this.diff_commonSuffix(_782,_781);if(_783!==0){_77d[_77e][1]=_782.substring(_782.length-_783)+_77d[_77e][1];_782=_782.substring(0,_782.length-_783);_781=_781.substring(0,_781.length-_783);}}if(_77f===0){_77d.splice(_77e-_77f-_780,_77f+_780,[DIFF_INSERT,_782]);}else{if(_780===0){_77d.splice(_77e-_77f-_780,_77f+_780,[DIFF_DELETE,_781]);}else{_77d.splice(_77e-_77f-_780,_77f+_780,[DIFF_DELETE,_781],[DIFF_INSERT,_782]);}}_77e=_77e-_77f-_780+(_77f?1:0)+(_780?1:0)+1;}else{if(_77e!==0&&_77d[_77e-1][0]==DIFF_EQUAL){_77d[_77e-1][1]+=_77d[_77e][1];_77d.splice(_77e,1);}else{_77e++;}}_780=0;_77f=0;_781="";_782="";break;}}if(_77d[_77d.length-1][1]===""){_77d.pop();}var _784=false;_77e=1;while(_77e<_77d.length-1){if(_77d[_77e-1][0]==DIFF_EQUAL&&_77d[_77e+1][0]==DIFF_EQUAL){if(_77d[_77e][1].substring(_77d[_77e][1].length-_77d[_77e-1][1].length)==_77d[_77e-1][1]){_77d[_77e][1]=_77d[_77e-1][1]+_77d[_77e][1].substring(0,_77d[_77e][1].length-_77d[_77e-1][1].length);_77d[_77e+1][1]=_77d[_77e-1][1]+_77d[_77e+1][1];_77d.splice(_77e-1,1);_784=true;}else{if(_77d[_77e][1].substring(0,_77d[_77e+1][1].length)==_77d[_77e+1][1]){_77d[_77e-1][1]+=_77d[_77e+1][1];_77d[_77e][1]=_77d[_77e][1].substring(_77d[_77e+1][1].length)+_77d[_77e+1][1];_77d.splice(_77e+1,1);_784=true;}}}_77e++;}if(_784){this.diff_cleanupMerge(_77d);}};diff_match_patch.prototype.diff_xIndex=function(_785,loc){var _786=0;var _787=0;var _788=0;var _789=0;var x;for(x=0;x<_785.length;x++){if(_785[x][0]!==DIFF_INSERT){_786+=_785[x][1].length;}if(_785[x][0]!==DIFF_DELETE){_787+=_785[x][1].length;}if(_786>loc){break;}_788=_786;_789=_787;}if(_785.length!=x&&_785[x][0]===DIFF_DELETE){return _789;}return _789+(loc-_788);};diff_match_patch.prototype.diff_prettyHtml=function(_78a){var html=[];var i=0;for(var x=0;x<_78a.length;x++){var op=_78a[x][0];var data=_78a[x][1];var text=data.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"&para;<BR>");switch(op){case DIFF_INSERT:html[x]="<INS STYLE=\"background:#E6FFE6;\" TITLE=\"i="+i+"\">"+text+"</INS>";break;case DIFF_DELETE:html[x]="<DEL STYLE=\"background:#FFE6E6;\" TITLE=\"i="+i+"\">"+text+"</DEL>";break;case DIFF_EQUAL:html[x]="<SPAN TITLE=\"i="+i+"\">"+text+"</SPAN>";break;}if(op!==DIFF_DELETE){i+=data.length;}}return html.join("");};diff_match_patch.prototype.diff_text1=function(_78b){var text=[];for(var x=0;x<_78b.length;x++){if(_78b[x][0]!==DIFF_INSERT){text[x]=_78b[x][1];}}return text.join("");};diff_match_patch.prototype.diff_text2=function(_78c){var text=[];for(var x=0;x<_78c.length;x++){if(_78c[x][0]!==DIFF_DELETE){text[x]=_78c[x][1];}}return text.join("");};diff_match_patch.prototype.diff_levenshtein=function(_78d){var _78e=0;var _78f=0;var _790=0;for(var x=0;x<_78d.length;x++){var op=_78d[x][0];var data=_78d[x][1];switch(op){case DIFF_INSERT:_78f+=data.length;break;case DIFF_DELETE:_790+=data.length;break;case DIFF_EQUAL:_78e+=Math.max(_78f,_790);_78f=0;_790=0;break;}}_78e+=Math.max(_78f,_790);return _78e;};diff_match_patch.prototype.diff_toDelta=function(_791){var text=[];for(var x=0;x<_791.length;x++){switch(_791[x][0]){case DIFF_INSERT:text[x]="+"+encodeURI(_791[x][1]);break;case DIFF_DELETE:text[x]="-"+_791[x][1].length;break;case DIFF_EQUAL:text[x]="="+_791[x][1].length;break;}}return text.join("\t").replace(/\x00/g,"%00").replace(/%20/g," ");};diff_match_patch.prototype.diff_fromDelta=function(_792,_793){var _794=[];var _795=0;var _796=0;_793=_793.replace(/%00/g,"\x00");var _797=_793.split(/\t/g);for(var x=0;x<_797.length;x++){var _798=_797[x].substring(1);switch(_797[x].charAt(0)){case "+":try{_794[_795++]=[DIFF_INSERT,decodeURI(_798)];}catch(ex){throw new Error("Illegal escape in diff_fromDelta: "+_798);}break;case "-":case "=":var n=parseInt(_798,10);if(isNaN(n)||n<0){throw new Error("Invalid number in diff_fromDelta: "+_798);}var text=_792.substring(_796,_796+=n);if(_797[x].charAt(0)=="="){_794[_795++]=[DIFF_EQUAL,text];}else{_794[_795++]=[DIFF_DELETE,text];}break;default:if(_797[x]){throw new Error("Invalid diff operation in diff_fromDelta: "+_797[x]);}}}if(_796!=_792.length){throw new Error("Delta length ("+_796+") does not equal source text length ("+_792.length+").");}return _794;};diff_match_patch.prototype.match_main=function(text,_799,loc){loc=Math.max(0,Math.min(loc,text.length));if(text==_799){return 0;}else{if(!text.length){return -1;}else{if(text.substring(loc,loc+_799.length)==_799){return loc;}else{return this.match_bitap(text,_799,loc);}}}};diff_match_patch.prototype.match_bitap=function(text,_79a,loc){if(_79a.length>this.Match_MaxBits){throw new Error("Pattern too long for this browser.");}var s=this.match_alphabet(_79a);var dmp=this;function _79b(e,x){var _79c=e/_79a.length;var _79d=Math.abs(loc-x);if(!dmp.Match_Distance){return _79d?1:_79c;}return _79c+_79d/dmp.Match_Distance;};var _79e=this.Match_Threshold;var _79f=text.indexOf(_79a,loc);if(_79f!=-1){_79e=Math.min(_79b(0,_79f),_79e);}_79f=text.lastIndexOf(_79a,loc+_79a.length);if(_79f!=-1){_79e=Math.min(_79b(0,_79f),_79e);}var _7a0=1<<(_79a.length-1);_79f=-1;var _7a1,_7a2;var _7a3=_79a.length+text.length;var _7a4;for(var d=0;d<_79a.length;d++){_7a1=0;_7a2=_7a3;while(_7a1<_7a2){if(_79b(d,loc+_7a2)<=_79e){_7a1=_7a2;}else{_7a3=_7a2;}_7a2=Math.floor((_7a3-_7a1)/2+_7a1);}_7a3=_7a2;var _7a5=Math.max(1,loc-_7a2+1);var _7a6=Math.min(loc+_7a2,text.length)+_79a.length;var rd=Array(_7a6+2);rd[_7a6+1]=(1<<d)-1;for(var j=_7a6;j>=_7a5;j--){var _7a7=s[text.charAt(j-1)];if(d===0){rd[j]=((rd[j+1]<<1)|1)&_7a7;}else{rd[j]=((rd[j+1]<<1)|1)&_7a7|(((_7a4[j+1]|_7a4[j])<<1)|1)|_7a4[j+1];}if(rd[j]&_7a0){var _7a8=_79b(d,j-1);if(_7a8<=_79e){_79e=_7a8;_79f=j-1;if(_79f>loc){_7a5=Math.max(1,2*loc-_79f);}else{break;}}}}if(_79b(d+1,loc)>_79e){break;}_7a4=rd;}return _79f;};diff_match_patch.prototype.match_alphabet=function(_7a9){var s={};for(var i=0;i<_7a9.length;i++){s[_7a9.charAt(i)]=0;}for(var i=0;i<_7a9.length;i++){s[_7a9.charAt(i)]|=1<<(_7a9.length-i-1);}return s;};diff_match_patch.prototype.patch_addContext=function(_7aa,text){var _7ab=text.substring(_7aa.start2,_7aa.start2+_7aa.length1);var _7ac=0;while(text.indexOf(_7ab)!=text.lastIndexOf(_7ab)&&_7ab.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin){_7ac+=this.Patch_Margin;_7ab=text.substring(_7aa.start2-_7ac,_7aa.start2+_7aa.length1+_7ac);}_7ac+=this.Patch_Margin;var _7ad=text.substring(_7aa.start2-_7ac,_7aa.start2);if(_7ad!==""){_7aa.diffs.unshift([DIFF_EQUAL,_7ad]);}var _7ae=text.substring(_7aa.start2+_7aa.length1,_7aa.start2+_7aa.length1+_7ac);if(_7ae!==""){_7aa.diffs.push([DIFF_EQUAL,_7ae]);}_7aa.start1-=_7ad.length;_7aa.start2-=_7ad.length;_7aa.length1+=_7ad.length+_7ae.length;_7aa.length2+=_7ad.length+_7ae.length;};diff_match_patch.prototype.patch_make=function(a,_7af,_7b0){var _7b1,_7b2;if(typeof a=="string"&&typeof _7af=="string"&&typeof _7b0=="undefined"){_7b1=a;_7b2=this.diff_main(_7b1,_7af,true);if(_7b2.length>2){this.diff_cleanupSemantic(_7b2);this.diff_cleanupEfficiency(_7b2);}}else{if(typeof a=="object"&&typeof _7af=="undefined"&&typeof _7b0=="undefined"){_7b2=a;_7b1=this.diff_text1(_7b2);}else{if(typeof a=="string"&&typeof _7af=="object"&&typeof _7b0=="undefined"){_7b1=a;_7b2=_7af;}else{if(typeof a=="string"&&typeof _7af=="string"&&typeof _7b0=="object"){_7b1=a;_7b2=_7b0;}else{throw new Error("Unknown call format to patch_make.");}}}}if(_7b2.length===0){return [];}var _7b3=[];var _7b4=new patch_obj();var _7b5=0;var _7b6=0;var _7b7=0;var _7b8=_7b1;var _7b9=_7b1;for(var x=0;x<_7b2.length;x++){var _7ba=_7b2[x][0];var _7bb=_7b2[x][1];if(!_7b5&&_7ba!==DIFF_EQUAL){_7b4.start1=_7b6;_7b4.start2=_7b7;}switch(_7ba){case DIFF_INSERT:_7b4.diffs[_7b5++]=_7b2[x];_7b4.length2+=_7bb.length;_7b9=_7b9.substring(0,_7b7)+_7bb+_7b9.substring(_7b7);break;case DIFF_DELETE:_7b4.length1+=_7bb.length;_7b4.diffs[_7b5++]=_7b2[x];_7b9=_7b9.substring(0,_7b7)+_7b9.substring(_7b7+_7bb.length);break;case DIFF_EQUAL:if(_7bb.length<=2*this.Patch_Margin&&_7b5&&_7b2.length!=x+1){_7b4.diffs[_7b5++]=_7b2[x];_7b4.length1+=_7bb.length;_7b4.length2+=_7bb.length;}else{if(_7bb.length>=2*this.Patch_Margin){if(_7b5){this.patch_addContext(_7b4,_7b8);_7b3.push(_7b4);_7b4=new patch_obj();_7b5=0;_7b8=_7b9;_7b6=_7b7;}}}break;}if(_7ba!==DIFF_INSERT){_7b6+=_7bb.length;}if(_7ba!==DIFF_DELETE){_7b7+=_7bb.length;}}if(_7b5){this.patch_addContext(_7b4,_7b8);_7b3.push(_7b4);}return _7b3;};diff_match_patch.prototype.patch_deepCopy=function(_7bc){var _7bd=[];for(var x=0;x<_7bc.length;x++){var _7be=_7bc[x];var _7bf=new patch_obj();_7bf.diffs=[];for(var y=0;y<_7be.diffs.length;y++){_7bf.diffs[y]=_7be.diffs[y].slice();}_7bf.start1=_7be.start1;_7bf.start2=_7be.start2;_7bf.length1=_7be.length1;_7bf.length2=_7be.length2;_7bd[x]=_7bf;}return _7bd;};diff_match_patch.prototype.patch_apply=function(_7c0,text){if(_7c0.length==0){return [text,[]];}_7c0=this.patch_deepCopy(_7c0);var _7c1=this.patch_addPadding(_7c0);text=_7c1+text+_7c1;this.patch_splitMax(_7c0);var _7c2=0;var _7c3=[];for(var x=0;x<_7c0.length;x++){var _7c4=_7c0[x].start2+_7c2;var _7c5=this.diff_text1(_7c0[x].diffs);var _7c6=this.match_main(text,_7c5,_7c4);if(_7c6==-1){_7c3[x]=false;}else{_7c3[x]=true;_7c2=_7c6-_7c4;var _7c7=text.substring(_7c6,_7c6+_7c5.length);if(_7c5==_7c7){text=text.substring(0,_7c6)+this.diff_text2(_7c0[x].diffs)+text.substring(_7c6+_7c5.length);}else{var _7c8=this.diff_main(_7c5,_7c7,false);this.diff_cleanupSemanticLossless(_7c8);var _7c9=0;var _7ca;for(var y=0;y<_7c0[x].diffs.length;y++){var mod=_7c0[x].diffs[y];if(mod[0]!==DIFF_EQUAL){_7ca=this.diff_xIndex(_7c8,_7c9);}if(mod[0]===DIFF_INSERT){text=text.substring(0,_7c6+_7ca)+mod[1]+text.substring(_7c6+_7ca);}else{if(mod[0]===DIFF_DELETE){text=text.substring(0,_7c6+_7ca)+text.substring(_7c6+this.diff_xIndex(_7c8,_7c9+mod[1].length));}}if(mod[0]!==DIFF_DELETE){_7c9+=mod[1].length;}}}}}text=text.substring(_7c1.length,text.length-_7c1.length);return [text,_7c3];};diff_match_patch.prototype.patch_addPadding=function(_7cb){var _7cc="";for(var x=0;x<this.Patch_Margin;x++){_7cc+=String.fromCharCode(x);}for(var x=0;x<_7cb.length;x++){_7cb[x].start1+=_7cc.length;_7cb[x].start2+=_7cc.length;}var _7cd=_7cb[0];var _7ce=_7cd.diffs;if(_7ce.length==0||_7ce[0][0]!=DIFF_EQUAL){_7ce.unshift([DIFF_EQUAL,_7cc]);_7cd.start1-=_7cc.length;_7cd.start2-=_7cc.length;_7cd.length1+=_7cc.length;_7cd.length2+=_7cc.length;}else{if(_7cc.length>_7ce[0][1].length){var _7cf=_7cc.length-_7ce[0][1].length;_7ce[0][1]=_7cc.substring(_7ce[0][1].length)+_7ce[0][1];_7cd.start1-=_7cf;_7cd.start2-=_7cf;_7cd.length1+=_7cf;_7cd.length2+=_7cf;}}_7cd=_7cb[_7cb.length-1];_7ce=_7cd.diffs;if(_7ce.length==0||_7ce[_7ce.length-1][0]!=DIFF_EQUAL){_7ce.push([DIFF_EQUAL,_7cc]);_7cd.length1+=_7cc.length;_7cd.length2+=_7cc.length;}else{if(_7cc.length>_7ce[_7ce.length-1][1].length){var _7cf=_7cc.length-_7ce[_7ce.length-1][1].length;_7ce[_7ce.length-1][1]+=_7cc.substring(0,_7cf);_7cd.length1+=_7cf;_7cd.length2+=_7cf;}}return _7cc;};diff_match_patch.prototype.patch_splitMax=function(_7d0){for(var x=0;x<_7d0.length;x++){if(_7d0[x].length1>this.Match_MaxBits){var _7d1=_7d0[x];_7d0.splice(x--,1);var _7d2=this.Match_MaxBits;var _7d3=_7d1.start1;var _7d4=_7d1.start2;var _7d5="";while(_7d1.diffs.length!==0){var _7d6=new patch_obj();var _7d7=true;_7d6.start1=_7d3-_7d5.length;_7d6.start2=_7d4-_7d5.length;if(_7d5!==""){_7d6.length1=_7d6.length2=_7d5.length;_7d6.diffs.push([DIFF_EQUAL,_7d5]);}while(_7d1.diffs.length!==0&&_7d6.length1<_7d2-this.Patch_Margin){var _7d8=_7d1.diffs[0][0];var _7d9=_7d1.diffs[0][1];if(_7d8===DIFF_INSERT){_7d6.length2+=_7d9.length;_7d4+=_7d9.length;_7d6.diffs.push(_7d1.diffs.shift());_7d7=false;}else{_7d9=_7d9.substring(0,_7d2-_7d6.length1-this.Patch_Margin);_7d6.length1+=_7d9.length;_7d3+=_7d9.length;if(_7d8===DIFF_EQUAL){_7d6.length2+=_7d9.length;_7d4+=_7d9.length;}else{_7d7=false;}_7d6.diffs.push([_7d8,_7d9]);if(_7d9==_7d1.diffs[0][1]){_7d1.diffs.shift();}else{_7d1.diffs[0][1]=_7d1.diffs[0][1].substring(_7d9.length);}}}_7d5=this.diff_text2(_7d6.diffs);_7d5=_7d5.substring(_7d5.length-this.Patch_Margin);var _7da=this.diff_text1(_7d1.diffs).substring(0,this.Patch_Margin);if(_7da!==""){_7d6.length1+=_7da.length;_7d6.length2+=_7da.length;if(_7d6.diffs.length!==0&&_7d6.diffs[_7d6.diffs.length-1][0]===DIFF_EQUAL){_7d6.diffs[_7d6.diffs.length-1][1]+=_7da;}else{_7d6.diffs.push([DIFF_EQUAL,_7da]);}}if(!_7d7){_7d0.splice(++x,0,_7d6);}}}}};diff_match_patch.prototype.patch_toText=function(_7db){var text=[];for(var x=0;x<_7db.length;x++){text[x]=_7db[x];}return text.join("");};diff_match_patch.prototype.patch_fromText=function(_7dc){var _7dd=[];if(!_7dc){return _7dd;}_7dc=_7dc.replace(/%00/g,"\x00");var text=_7dc.split("\n");var _7de=0;while(_7de<text.length){var m=text[_7de].match(/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/);if(!m){throw new Error("Invalid patch string: "+text[_7de]);}var _7df=new patch_obj();_7dd.push(_7df);_7df.start1=parseInt(m[1],10);if(m[2]===""){_7df.start1--;_7df.length1=1;}else{if(m[2]=="0"){_7df.length1=0;}else{_7df.start1--;_7df.length1=parseInt(m[2],10);}}_7df.start2=parseInt(m[3],10);if(m[4]===""){_7df.start2--;_7df.length2=1;}else{if(m[4]=="0"){_7df.length2=0;}else{_7df.start2--;_7df.length2=parseInt(m[4],10);}}_7de++;while(_7de<text.length){var sign=text[_7de].charAt(0);try{var line=decodeURI(text[_7de].substring(1));}catch(ex){throw new Error("Illegal escape in patch_fromText: "+line);}if(sign=="-"){_7df.diffs.push([DIFF_DELETE,line]);}else{if(sign=="+"){_7df.diffs.push([DIFF_INSERT,line]);}else{if(sign==" "){_7df.diffs.push([DIFF_EQUAL,line]);}else{if(sign=="@"){break;}else{if(sign===""){}else{throw new Error("Invalid patch mode \""+sign+"\" in: "+line);}}}}}_7de++;}}return _7dd;};function patch_obj(){this.diffs=[];this.start1=null;this.start2=null;this.length1=0;this.length2=0;};patch_obj.prototype.toString=function(){var _7e0,_7e1;if(this.length1===0){_7e0=this.start1+",0";}else{if(this.length1==1){_7e0=this.start1+1;}else{_7e0=(this.start1+1)+","+this.length1;}}if(this.length2===0){_7e1=this.start2+",0";}else{if(this.length2==1){_7e1=this.start2+1;}else{_7e1=(this.start2+1)+","+this.length2;}}var text=["@@ -"+_7e0+" +"+_7e1+" @@\n"];var op;for(var x=0;x<this.diffs.length;x++){switch(this.diffs[x][0]){case DIFF_INSERT:op="+";break;case DIFF_DELETE:op="-";break;case DIFF_EQUAL:op=" ";break;}text[x+1]=op+encodeURI(this.diffs[x][1])+"\n";}return text.join("").replace(/\x00/g,"%00").replace(/%20/g," ");};}if(!dojo._hasResource["bespin.mobwrite.integrate"]){dojo._hasResource["bespin.mobwrite.integrate"]=true;dojo.provide("bespin.mobwrite.integrate");mobwrite.shareBespinObj=function(_7e2){this.shareNode=_7e2;this.shareNode.setShareObj(this);mobwrite.shareObj.apply(this,[_7e2.id]);};mobwrite.shareBespinObj.prototype=new mobwrite.shareObj("");mobwrite.shareBespinObj.prototype.getClientText=function(_7e3){return this.shareNode.getClientText(_7e3);};mobwrite.shareBespinObj.prototype.setClientText=function(text){this.shareNode.setClientText(text);};mobwrite.shareBespinObj.prototype.patchClientText=function(_7e4){this.shareNode.patchClientText(_7e4);};mobwrite.shareBespinObj.prototype.syncWithoutChange=function(){this.shareNode.syncWithoutChange();};mobwrite.shareBespinObj.prototype.reportCollaborators=function(_7e5){this.shareNode.reportCollaborators(_7e5);};mobwrite.shareBespinObj.prototype.raiseError=function(text,_7e6){this.shareNode.raiseError(text,_7e6);};mobwrite.shareBespinObj.prototype.setReadOnly=function(_7e7){this.shareNode.setReadOnly(_7e7);};mobwrite.shareBespinObj.prototype.getMetaData=function(){return this.shareNode.getMetaData();};mobwrite.shareBespinObj.shareHandler=function(node){if(node.isShareNode===true){node.shareHandler=new mobwrite.shareBespinObj(node);return node.shareHandler;}else{return null;}};mobwrite.shareHandlers.push(mobwrite.shareBespinObj.shareHandler);}if(!dojo._hasResource["bespin.client.pubsub"]){dojo._hasResource["bespin.client.pubsub"]=true;dojo.provide("bespin.client.pubsub");dojo.declare("bespin.client.pubsub.Proxy",null,{constructor:function(){this.server=bespin.get("server");},listen:function(){var self=this;var _7e8=function(pub){bespin.publish(pub.topic,pub.event);self.listen();};var url="/event/listen/?queue="+self.queue;this.server.request("GET",url,null,{log:"Message arrived",onSuccess:_7e8,evalJSON:true});},forward:function(_7e9,_7ea){var self=this;var url="/event/forward/?queue="+self.queue+"&topic="+encodeURIComponent(_7e9)+"&event="+encodeURIComponent(dojo.toJson(_7ea));this.server.request("GET",url,null,{log:"Event "+_7e9+" forwarded."});},bind:function(){var self=this;var url="/event/bind/";this.server.request("GET",url,null,{evalJSON:true,onSuccess:function(info){self.queue=info.queue;var _7eb=info.topics;dojo.forEach(_7eb,function(_7ec){bespin.subscribe(_7ec,function(_7ed){self.forward(_7ec,_7ed);});});self.listen();}});}});bespin.subscribe("bind",function(){var _7ee=new bespin.client.pubsub.Proxy();_7ee.bind();});}if(!dojo._hasResource["bespin.editor.dependencies"]){dojo._hasResource["bespin.editor.dependencies"]=true;dojo.provide("bespin.editor.dependencies");}if(!dojo._hasResource["bespin.editor.component"]){dojo._hasResource["bespin.editor.component"]=true;dojo.provide("bespin.editor.component");dojo.declare("bespin.editor.Component",null,{constructor:function(_7ef,opts){opts.actsAsComponent=true;var _7f0;if(opts.loadfromdiv){if(dojo.byId("BESPIN_EDITOR_CODE")){var code=dojo.byId("BESPIN_EDITOR_CODE");_7f0=code.value;}else{_7f0=dojo.byId(_7ef).innerHTML;}}else{if(opts.content){_7f0=opts.content;}}this.editor=bespin.register("editor",opts.editor||new bespin.editor.API(_7ef,opts));this.editSession=bespin.register("editSession",opts.editSession||new bespin.client.session.EditSession(this.editor));this.server=bespin.register("server",opts.server||new bespin.client.Server());this.files=bespin.register("files",opts.files||new bespin.client.FileSystem());if(opts.commandline){dojo["require"]("bespin.cmd.commandline");var _7f1;if(typeof opts.commandline=="boolean"){_7f1=dojo.create("div",{id:"commandlinewrapper",hidden:true},dojo.body());_7f1.innerHTML="<table style=\"display: none;\" cellpadding=\"0\"><tr><td id=\"prompt\"><img id=\"promptimg\" src=\"https://bespin.mozilla.com/images/icn_command.png\" alt=\">\" ></td><td id=\"commandline\"><input id=\"command\" spellcheck=\"false\"></td></tr></table>";}else{_7f1=dojo.byId(opts.commandline);}this.commandLine=bespin.register("commandLine",new bespin.cmd.commandline.Interface(_7f1,bespin.command.Store));}bespin.register("settings",opts.settings||new bespin.client.settings.Core(bespin.client.settings.InMemory));if(opts.jetpack){var _7f2=dojo.create("div",{id:"jetpacktoolbar"},dojo.byId(_7ef));_7f2.innerHTML="<div class=\"button\"><button id=\"install\" onclick=\"_editorComponent.executeCommand('jetpack install yourfirstjetpack')\">&uarr; Install This JetPack Feature</button></div>            <div>Hey, <a href=\"https://jetpack.mozillalabs.com/\">install JetPack first</a>.</div>            <style type=\"text/css\">                #jetpacktoolbar {                    position: relative;                    top: -15px;                    left: 0;                    height: 40px;                    background-image: url(https://bespin.mozilla.com/images/footer_bg.png);                    background-repeat: repeat-x;                    color: white;                    font-family: Helvetica, Arial, sans-serif;                    font-size: 11px;                }                #jetpacktoolbar div {                    padding: 17px 12px;                    float: left;                }                #jetpacktoolbar div.button {                    float: right;                    padding: 13px 0;                }                #jetpacktoolbar button {                    margin:0 7px 0 0;                }                #jetpacktoolbar a {                    color: #eee;                }            </style>";}dojo.connect(window,"resize",opts.resize||dojo.hitch(this,function(){this.editor.paint();}));if(_7f0){this.setContent(_7f0);}if(opts.language){bespin.publish("settings:language",{language:opts.language});}if(!opts.dontstealfocus){this.editor.canvas.focus();}if(opts.set){for(var key in opts.set){if(opts.set.hasOwnProperty(key)){this.set(key,opts.set[key]);}}}},getContent:function(){return this.editor.model.getDocument();},setContent:function(_7f3){return this.editor.model.insertDocument(_7f3);},setFocus:function(bool){return this.editor.setFocus(bool);},setLineNumber:function(_7f4){bespin.get("editor").moveAndCenter(_7f4);},set:function(key,_7f5){bespin.publish("settings:set",{key:key,value:_7f5});},onchange:function(_7f6){bespin.subscribe("editor:document:changed",_7f6);},bindKey:function(opts){bespin.get("editor").bindKey(opts.action,opts.modifiers+" "+opts.key);},executeCommand:function(_7f7){try{this.commandLine.executeCommand(_7f7);}catch(e){}},dispose:function(){this.editor.dispose();}});}if(!dojo._hasResource["bespin.syntax.simple.javascript"]){dojo._hasResource["bespin.syntax.simple.javascript"]=true;dojo.provide("bespin.syntax.simple.javascript");bespin.syntax.JavaScriptConstants={C_STYLE_COMMENT:"c-comment",LINE_COMMENT:"comment",STRING:"string",KEYWORD:"keyword",PUNCTUATION:"punctuation",OTHER:"plain"};dojo.declare("bespin.syntax.simple.JavaScript",null,{keywords:" abstract boolean break byte case catch char class const continue debugger "+"default delete do double else enum export extends false final finally float "+"for function goto if implements import in instanceof int interface let long native "+"new null package private protected public return short static super switch "+"synchronized this throw throws transient true try typeof var void volatile while with ",punctuation:"{ } > < / + - % * . , ; ( ) ? : = \" '".split(" "),highlight:function(line,meta){if(!meta){meta={};}var K=bespin.syntax.JavaScriptConstants;var _7f8={};var _7f9=(meta.inMultilineComment)?K.C_STYLE_COMMENT:undefined;var _7fa={};var _7fb="";var _7fc="";var _7fd=meta.inMultilineComment;for(var i=0;i<line.length;i++){var c=line.charAt(i);if(_7f9==K.C_STYLE_COMMENT){if(c=="/"&&/\*$/.test(_7fb)){_7fa.stop=i+1;this.addRegion(_7f8,_7f9,_7fa);_7fa={};_7f9=undefined;_7fd=false;_7fb="";}else{if(_7fb==""){_7fa={start:i};}_7fb+=c;}continue;}if(this.isWhiteSpaceOrPunctuation(c)){if(_7f9==K.STRING){if(!(c==_7fc&&!/\\$/.test(_7fb))){if(_7fb==""){_7fa={start:i};}_7fb+=c;continue;}}if(_7fb!=""){_7fa.stop=i;if(_7f9!=K.STRING){if(this.keywords.indexOf(" "+_7fb+" ")>-1){_7f9=K.KEYWORD;}else{_7f9=K.OTHER;}}this.addRegion(_7f8,_7f9,_7fa);_7fa={};_7fc="";_7fb="";}if(this.isPunctuation(c)){if(c=="*"&&i>0&&(line.charAt(i-1)=="/")){_7f8[K.PUNCTUATION].pop();_7fd=true;_7f9=K.C_STYLE_COMMENT;_7fa={start:i-1};_7fb="/*";continue;}if(c=="/"&&i>0&&(line.charAt(i-1)=="/")){_7fa={start:i-1,stop:line.length};_7f9=K.LINE_COMMENT;this.addRegion(_7f8,_7f9,_7fa);_7fb="";_7f9=undefined;_7fa={};break;}this.addRegion(_7f8,K.PUNCTUATION,{start:i,stop:i+1});}if((c=="'"||c=="\"")&&(_7f9!=K.STRING)){_7f9=K.STRING;_7fc=c;}else{_7f9=undefined;}continue;}if(_7fb==""){_7fa={start:i};}_7fb+=c;}if(_7fb!=""){if(!_7f9){_7f9=K.OTHER;}_7fa.stop=line.length;this.addRegion(_7f8,_7f9,_7fa);}var _7fe={inMultilineComment:_7fd};if(meta.inJavaScript){_7fe.inJavaScript=meta.inJavaScript;}return {regions:_7f8,meta:_7fe};},addRegion:function(_7ff,type,data){if(!_7ff[type]){_7ff[type]=[];}_7ff[type].push(data);},isWhiteSpaceOrPunctuation:function(ch){return this.isPunctuation(ch)||this.isWhiteSpace(ch);},isPunctuation:function(ch){return this.punctuation.indexOf(ch)!=-1;},isWhiteSpace:function(ch){return ch==" ";}});}if(!dojo._hasResource["bespin.syntax.simple.html"]){dojo._hasResource["bespin.syntax.simple.html"]=true;dojo.provide("bespin.syntax.simple.html");bespin.syntax.HTMLConstants={HTML_STYLE_COMMENT:"comment",STRING:"string",KEYWORD:"keyword",PUNCTUATION:"punctuation",OTHER:"plain",ATTR_NAME:"attname"};dojo.declare("bespin.syntax.simple.HTML",null,{punctuation:"< > = \" '",highlight:function(line,meta){if(!meta){meta={};}var K=bespin.syntax.HTMLConstants;var _800={};var _801=(meta.inMultilineComment)?K.HTML_STYLE_COMMENT:undefined;var _802={};var _803="";var _804="";var _805=meta.inMultilineComment;if(meta.inJavaScript){if(line.indexOf("</script>")>0){meta.inJavaScript=false;}else{return bespin.syntax.simple.Resolver.resolve("js").highlight(line,meta);}}else{meta.inJavaScript=false;}if(line.indexOf("<script")>0){meta.inJavaScript=true;}for(var i=0;i<line.length;i++){var c=line.charAt(i);if(_801==K.HTML_STYLE_COMMENT){if(c==">"&&bespin.util.endsWith(_803,"--")&&!(/<!--/.test(_803)&&!meta.inMultiLineComment&&_802.start==i-4)&&!(/<!---/.test(_803)&&!meta.inMultiLineComment&&_802.start==i-5)){_802.stop=i+1;this.addRegion(_800,_801,_802);_802={};_801=undefined;_805=false;_803="";}else{if(_803==""){_802={start:i};}_803+=c;}continue;}if(this.isWhiteSpaceOrPunctuation(c)){if(_801==K.STRING){if(!(c==_804&&!/\\$/.test(_803))){if(_803==""){_802={start:i};}_803+=c;continue;}}if(_803!=""){_802.stop=i;if(_801!=K.STRING){if(line.charAt(_802.start-1)=="<"){_801=K.KEYWORD;}else{if(line.charAt(_802.stop)=="="){_801=K.ATTR_NAME;}else{_801=K.OTHER;}}}this.addRegion(_800,_801,_802);_802={};_804="";_803="";}if(this.isPunctuation(c)){if(c=="<"&&(line.length>i+3)&&(line.substring(i,i+4)=="<!--")){_805=true;_801=K.HTML_STYLE_COMMENT;_802={start:i};_803="<!--";i+=3;continue;}this.addRegion(_800,K.PUNCTUATION,{start:i,stop:i+1});}if((c=="'"||c=="\"")&&(_801!=K.STRING)){_801=K.STRING;_804=c;}else{_801=undefined;}continue;}if(_803==""){_802={start:i};}_803+=c;}if(_803!=""){if(!_801){_801=K.OTHER;}_802.stop=line.length;this.addRegion(_800,_801,_802);}return {regions:_800,meta:{inMultilineComment:_805,inJavaScript:meta.inJavaScript}};},addRegion:function(_806,type,data){if(!_806[type]){_806[type]=[];}_806[type].push(data);},isWhiteSpaceOrPunctuation:function(ch){return this.isPunctuation(ch)||this.isWhiteSpace(ch);},isPunctuation:function(ch){return this.punctuation.indexOf(ch)!=-1;},isWhiteSpace:function(ch){return ch==" ";}});}
